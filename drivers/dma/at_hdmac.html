<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › at_hdmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>at_hdmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the Atmel AHB DMA Controller (aka HDMA or DMAC on AT91 systems)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Atmel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This supports the Atmel AHB DMA Controller,</span>
<span class="cm"> *</span>
<span class="cm"> * The driver has currently been tested with the Atmel AT91SAM9RL</span>
<span class="cm"> * and AT91SAM9G45 series.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &quot;at_hdmac_regs.h&quot;</span>
<span class="cp">#include &quot;dmaengine.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Glossary</span>
<span class="cm"> * --------</span>
<span class="cm"> *</span>
<span class="cm"> * at_hdmac		: Name of the ATmel AHB DMA Controller</span>
<span class="cm"> * at_dma_ / atdma	: ATmel DMA controller entity related</span>
<span class="cm"> * atc_	/ atchan	: ATmel DMA Channel entity related</span>
<span class="cm"> */</span>

<span class="cp">#define	ATC_DEFAULT_CFG		(ATC_FIFOCFG_HALFFIFO)</span>
<span class="cp">#define	ATC_DEFAULT_CTRLB	(ATC_SIF(AT_DMA_MEM_IF) \</span>
<span class="cp">				|ATC_DIF(AT_DMA_MEM_IF))</span>

<span class="cm">/*</span>
<span class="cm"> * Initial number of descriptors to allocate for each channel. This could</span>
<span class="cm"> * be increased during dma usage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">init_nr_desc_per_channel</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">init_nr_desc_per_channel</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">init_nr_desc_per_channel</span><span class="p">,</span>
		 <span class="s">&quot;initial descriptors per channel (default: 64)&quot;</span><span class="p">);</span>


<span class="cm">/* prototypes */</span>
<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="n">atc_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>


<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="nf">atc_first_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">at_desc</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="nf">atc_first_queued</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">at_desc</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_alloc_descriptor - allocate and return an initialized descriptor</span>
<span class="cm"> * @chan: the channel to allocate descriptors for</span>
<span class="cm"> * @gfp_flags: GFP allocation flags</span>
<span class="cm"> *</span>
<span class="cm"> * Note: The ack-bit is positioned in the descriptor flag at creation time</span>
<span class="cm"> *       to make initial allocation more convenient. This bit will be cleared</span>
<span class="cm"> *       and control will be given to client at usage time (during</span>
<span class="cm"> *       preparation functions).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="nf">atc_alloc_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					    <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_desc</span>	<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_dma</span>	<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">to_at_dma</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">phys</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_desc</span><span class="p">));</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
		<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="cm">/* txd.flags will be overwritten in prep functions */</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_CTRL_ACK</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">atc_tx_submit</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span> <span class="o">=</span> <span class="n">phys</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_desc_get - get an unused descriptor from free_list</span>
<span class="cm"> * @atchan: channel we want a new descriptor for</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="nf">atc_desc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tmp_list</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async_tx_test_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
				<span class="s">&quot;desc %p not ACKed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
		<span class="s">&quot;scanned %u descriptors on freelist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* no more descriptor available in initial pool: create one more */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">atc_alloc_descriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
					<span class="s">&quot;not enough descriptors available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_desc_put - move a descriptor, including any children, to the free list</span>
<span class="cm"> * @atchan: channel we work on</span>
<span class="cm"> * @desc: descriptor, at the head of a chain, to move to free list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_desc_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
					<span class="s">&quot;moving child desc %p to freelist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">child</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
			 <span class="s">&quot;moving desc %p to freelist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_desc_chain - build chain adding a descripor</span>
<span class="cm"> * @first: address of first descripor of the chain</span>
<span class="cm"> * @prev: address of previous descripor of the chain</span>
<span class="cm"> * @desc: descriptor to queue</span>
<span class="cm"> *</span>
<span class="cm"> * Called from prep_* functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_desc_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_desc</span> <span class="o">**</span><span class="n">first</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">**</span><span class="n">prev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">first</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* inform the HW lli about chaining */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">prev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">dscr</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">;</span>
		<span class="cm">/* insert the link descriptor to the LD ring */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">first</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_dostart - starts the DMA engine for real</span>
<span class="cm"> * @atchan: the channel we want to start</span>
<span class="cm"> * @first: first descriptor in the list we want to begin with</span>
<span class="cm"> *</span>
<span class="cm"> * Called with atchan-&gt;lock held and bh disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_dostart</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">first</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma</span>	<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">to_at_dma</span><span class="p">(</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/* ASSERT:  channel is idle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atc_chan_is_enabled</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
			<span class="s">&quot;BUG: Attempted to start non-idle channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
			<span class="s">&quot;  channel: s0x%x d0x%x ctrl0x%x:0x%x l0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel_readl</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">SADDR</span><span class="p">),</span>
			<span class="n">channel_readl</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">DADDR</span><span class="p">),</span>
			<span class="n">channel_readl</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CTRLA</span><span class="p">),</span>
			<span class="n">channel_readl</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CTRLB</span><span class="p">),</span>
			<span class="n">channel_readl</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">DSCR</span><span class="p">));</span>

		<span class="cm">/* The tasklet will hopefully advance the queue... */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdbg_dump_regs</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>

	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">SADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">DADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CTRLA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CTRLB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">DSCR</span><span class="p">,</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">CHER</span><span class="p">,</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>

	<span class="n">vdbg_dump_regs</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_chain_complete - finish work for one transaction chain</span>
<span class="cm"> * @atchan: channel we work on</span>
<span class="cm"> * @desc: descriptor at the head of the chain we want do complete</span>
<span class="cm"> *</span>
<span class="cm"> * Called with atchan-&gt;lock held and bh disabled */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atc_chain_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
		<span class="s">&quot;descriptor %u complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>

	<span class="cm">/* mark the descriptor as complete for non cyclic cases only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc_chan_is_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span>
		<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>

	<span class="cm">/* move children to free_list */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
	<span class="cm">/* move myself to free_list */</span>
	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>

	<span class="cm">/* unmap dma addresses (not on slave channels) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">.</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_DEST_UNMAP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_DEST_UNMAP_SINGLE</span><span class="p">)</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_SRC_UNMAP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SRC_UNMAP_SINGLE</span><span class="p">)</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">saddr</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* for cyclic transfers,</span>
<span class="cm">	 * no need to replay callback function while stopping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc_chan_is_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_async_tx_callback</span>	<span class="n">callback</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">;</span>
		<span class="kt">void</span>			<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback_param</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The API requires that no submissions are done from a</span>
<span class="cm">		 * callback, so we don&#39;t need to drop the lock here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">callback</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_run_dependencies</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_complete_all - finish work for all transactions</span>
<span class="cm"> * @atchan: channel to complete transactions for</span>
<span class="cm"> *</span>
<span class="cm"> * Eventually submit queued descriptors if any</span>
<span class="cm"> *</span>
<span class="cm"> * Assume channel is idle while calling this function</span>
<span class="cm"> * Called with atchan-&gt;lock held and bh disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_complete_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span> <span class="s">&quot;complete all</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atc_chan_is_enabled</span><span class="p">(</span><span class="n">atchan</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Submit queued descriptors ASAP, i.e. before we go through</span>
<span class="cm">	 * the completed ones.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">atc_dostart</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">atc_first_queued</span><span class="p">(</span><span class="n">atchan</span><span class="p">));</span>
	<span class="cm">/* empty active_list now it is completed */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="cm">/* empty queue list by moving descriptors (if any) to active_list */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
		<span class="n">atc_chain_complete</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_cleanup_descriptors - cleanup up finished descriptors in active_list</span>
<span class="cm"> * @atchan: channel to be cleaned up</span>
<span class="cm"> *</span>
<span class="cm"> * Called with atchan-&gt;lock held and bh disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_cleanup_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_desc</span>	<span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span>	<span class="o">*</span><span class="n">child</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span> <span class="s">&quot;cleanup descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrla</span> <span class="o">&amp;</span> <span class="n">ATC_DONE</span><span class="p">))</span>
			<span class="cm">/* This one is currently in progress */</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrla</span> <span class="o">&amp;</span> <span class="n">ATC_DONE</span><span class="p">))</span>
				<span class="cm">/* Currently in progress */</span>
				<span class="k">return</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * No descriptors so far seem to be in progress, i.e.</span>
<span class="cm">		 * this chain must be done.</span>
<span class="cm">		 */</span>
		<span class="n">atc_chain_complete</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_advance_work - at the end of a transaction, move forward</span>
<span class="cm"> * @atchan: channel where the transaction ended</span>
<span class="cm"> *</span>
<span class="cm"> * Called with atchan-&gt;lock held and bh disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_advance_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span> <span class="s">&quot;advance_work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">list_is_singular</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atc_complete_all</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">atc_chain_complete</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">atc_first_active</span><span class="p">(</span><span class="n">atchan</span><span class="p">));</span>
		<span class="cm">/* advance work */</span>
		<span class="n">atc_dostart</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">atc_first_active</span><span class="p">(</span><span class="n">atchan</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * atc_handle_error - handle errors reported by DMA controller</span>
<span class="cm"> * @atchan: channel where error occurs</span>
<span class="cm"> *</span>
<span class="cm"> * Called with atchan-&gt;lock held and bh disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">bad_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The descriptor currently at the head of the active list is</span>
<span class="cm">	 * broked. Since we don&#39;t have any way to report errors, we&#39;ll</span>
<span class="cm">	 * just have to scream loudly and try to carry on.</span>
<span class="cm">	 */</span>
	<span class="n">bad_desc</span> <span class="o">=</span> <span class="n">atc_first_active</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bad_desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">);</span>

	<span class="cm">/* As we are stopped, take advantage to push queued descriptors</span>
<span class="cm">	 * in active_list */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

	<span class="cm">/* Try to restart the controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span>
		<span class="n">atc_dostart</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">atc_first_active</span><span class="p">(</span><span class="n">atchan</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * KERN_CRITICAL may seem harsh, but since this only happens</span>
<span class="cm">	 * when someone submits a bad physical address in a</span>
<span class="cm">	 * descriptor, we should consider ourselves lucky that the</span>
<span class="cm">	 * controller flagged an error instead of scribbling over</span>
<span class="cm">	 * random memory locations.</span>
<span class="cm">	 */</span>
	<span class="n">dev_crit</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
			<span class="s">&quot;Bad descriptor submitted for DMA!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_crit</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
			<span class="s">&quot;  cookie: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bad_desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">);</span>
	<span class="n">atc_dump_lli</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
		<span class="n">atc_dump_lli</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">);</span>

	<span class="cm">/* Pretend the descriptor completed successfully */</span>
	<span class="n">atc_chain_complete</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">bad_desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_handle_cyclic - at the end of a period, run callback function</span>
<span class="cm"> * @atchan: channel used for cyclic operations</span>
<span class="cm"> *</span>
<span class="cm"> * Called with atchan-&gt;lock held and bh disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_handle_cyclic</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_desc</span>			<span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="n">atc_first_active</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
	<span class="n">dma_async_tx_callback</span>		<span class="n">callback</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback_param</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">),</span>
			<span class="s">&quot;new cyclic period llp 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel_readl</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">DSCR</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">callback</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*--  IRQ &amp; Tasklet  ---------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">ATC_IS_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">atc_handle_error</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atc_chan_is_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span>
		<span class="n">atc_handle_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atc_advance_work</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">at_dma_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma</span>		<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">at_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">status</span><span class="p">,</span> <span class="n">pending</span><span class="p">,</span> <span class="n">imr</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">imr</span> <span class="o">=</span> <span class="n">dma_readl</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EBCIMR</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dma_readl</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EBCISR</span><span class="p">);</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">imr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;interrupt: status = 0x%08x, 0x%08x, 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">status</span><span class="p">,</span> <span class="n">imr</span><span class="p">,</span> <span class="n">pending</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">chancnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atchan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AT_DMA_BTC</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">AT_DMA_ERR</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">AT_DMA_ERR</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Disable channel on AHB error */</span>
					<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">CHDR</span><span class="p">,</span>
						<span class="n">AT_DMA_RES</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
					<span class="cm">/* Give information to tasklet */</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">ATC_IS_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*--  DMA Engine API  --------------------------------------------------*/</span>

<span class="cm">/**</span>
<span class="cm"> * atc_tx_submit - set the prepared descriptor(s) to be executed by the engine</span>
<span class="cm"> * @desc: descriptor at the head of the transaction chain</span>
<span class="cm"> *</span>
<span class="cm"> * Queue chain if DMA engine is working already</span>
<span class="cm"> *</span>
<span class="cm"> * Cookie increment and adding to active_list or queue must be atomic</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">atc_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">txd_to_at_desc</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dma_cookie_t</span>		<span class="n">cookie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;tx_submit: started %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">);</span>
		<span class="n">atc_dostart</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;tx_submit: queued %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_prep_dma_memcpy - prepare a memcpy operation</span>
<span class="cm"> * @chan: the channel to prepare operation on</span>
<span class="cm"> * @dest: operation virtual destination address</span>
<span class="cm"> * @src: operation virtual source address</span>
<span class="cm"> * @len: operation length</span>
<span class="cm"> * @flags: tx descriptor status flags</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">atc_prep_dma_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">xfer_count</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">src_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">dst_width</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ctrla</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ctrlb</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_memcpy: d0x%x s0x%x l0x%zx f0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_memcpy: length is zero!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrlb</span> <span class="o">=</span>   <span class="n">ATC_DEFAULT_CTRLB</span> <span class="o">|</span> <span class="n">ATC_IEN</span>
		<span class="o">|</span> <span class="n">ATC_SRC_ADDR_MODE_INCR</span>
		<span class="o">|</span> <span class="n">ATC_DST_ADDR_MODE_INCR</span>
		<span class="o">|</span> <span class="n">ATC_FC_MEM2MEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can be a lot more clever here, but this should take care</span>
<span class="cm">	 * of the most common optimization.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">src</span> <span class="o">|</span> <span class="n">dest</span>  <span class="o">|</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctrla</span> <span class="o">=</span> <span class="n">ATC_SRC_WIDTH_WORD</span> <span class="o">|</span> <span class="n">ATC_DST_WIDTH_WORD</span><span class="p">;</span>
		<span class="n">src_width</span> <span class="o">=</span> <span class="n">dst_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">src</span> <span class="o">|</span> <span class="n">dest</span> <span class="o">|</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctrla</span> <span class="o">=</span> <span class="n">ATC_SRC_WIDTH_HALFWORD</span> <span class="o">|</span> <span class="n">ATC_DST_WIDTH_HALFWORD</span><span class="p">;</span>
		<span class="n">src_width</span> <span class="o">=</span> <span class="n">dst_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctrla</span> <span class="o">=</span> <span class="n">ATC_SRC_WIDTH_BYTE</span> <span class="o">|</span> <span class="n">ATC_DST_WIDTH_BYTE</span><span class="p">;</span>
		<span class="n">src_width</span> <span class="o">=</span> <span class="n">dst_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">xfer_count</span> <span class="o">&lt;&lt;</span> <span class="n">src_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfer_count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">src_width</span><span class="p">,</span>
				<span class="n">ATC_BTSIZE_MAX</span><span class="p">);</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">atc_desc_get</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_desc_get</span><span class="p">;</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrla</span> <span class="o">=</span> <span class="n">ctrla</span> <span class="o">|</span> <span class="n">xfer_count</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrlb</span> <span class="o">=</span> <span class="n">ctrlb</span><span class="p">;</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">atc_desc_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* First descriptor of the chain embedds additional information */</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* set end-of-link to the last link descriptor of list*/</span>
	<span class="n">set_desc_eol</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span> <span class="cm">/* client is in control of this ack */</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>

<span class="nl">err_desc_get:</span>
	<span class="n">atc_desc_put</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * atc_prep_slave_sg - prepare descriptors for a DMA_SLAVE transaction</span>
<span class="cm"> * @chan: DMA channel</span>
<span class="cm"> * @sgl: scatterlist to transfer to/from</span>
<span class="cm"> * @sg_len: number of entries in @scatterlist</span>
<span class="cm"> * @direction: DMA direction</span>
<span class="cm"> * @flags: tx descriptor status flags</span>
<span class="cm"> * @context: transaction context (ignored)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">atc_prep_slave_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma_slave</span>	<span class="o">*</span><span class="n">atslave</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span>	<span class="o">*</span><span class="n">sconfig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">dma_sconfig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ctrla</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ctrlb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">reg_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">mem_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">total_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_slave_sg (%d): %s f0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sg_len</span><span class="p">,</span>
			<span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span> <span class="o">?</span> <span class="s">&quot;TO DEVICE&quot;</span> <span class="o">:</span> <span class="s">&quot;FROM DEVICE&quot;</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">atslave</span> <span class="o">||</span> <span class="o">!</span><span class="n">sg_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_memcpy: length is zero!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrla</span> <span class="o">=</span>   <span class="n">ATC_SCSIZE</span><span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">src_maxburst</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">ATC_DCSIZE</span><span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">dst_maxburst</span><span class="p">);</span>
	<span class="n">ctrlb</span> <span class="o">=</span> <span class="n">ATC_IEN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_MEM_TO_DEV</span>:
		<span class="n">reg_width</span> <span class="o">=</span> <span class="n">convert_buswidth</span><span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">);</span>
		<span class="n">ctrla</span> <span class="o">|=</span>  <span class="n">ATC_DST_WIDTH</span><span class="p">(</span><span class="n">reg_width</span><span class="p">);</span>
		<span class="n">ctrlb</span> <span class="o">|=</span>  <span class="n">ATC_DST_ADDR_MODE_FIXED</span>
			<span class="o">|</span> <span class="n">ATC_SRC_ADDR_MODE_INCR</span>
			<span class="o">|</span> <span class="n">ATC_FC_MEM2PER</span>
			<span class="o">|</span> <span class="n">ATC_SIF</span><span class="p">(</span><span class="n">AT_DMA_MEM_IF</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATC_DIF</span><span class="p">(</span><span class="n">AT_DMA_PER_IF</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">at_desc</span>	<span class="o">*</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">u32</span>		<span class="n">len</span><span class="p">;</span>
			<span class="n">u32</span>		<span class="n">mem</span><span class="p">;</span>

			<span class="n">desc</span> <span class="o">=</span> <span class="n">atc_desc_get</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_desc_get</span><span class="p">;</span>

			<span class="n">mem</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">mem_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mem</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
				<span class="n">mem_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrla</span> <span class="o">=</span> <span class="n">ctrla</span>
					<span class="o">|</span> <span class="n">ATC_SRC_WIDTH</span><span class="p">(</span><span class="n">mem_width</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">mem_width</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrlb</span> <span class="o">=</span> <span class="n">ctrlb</span><span class="p">;</span>

			<span class="n">atc_desc_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
			<span class="n">total_len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_DEV_TO_MEM</span>:
		<span class="n">reg_width</span> <span class="o">=</span> <span class="n">convert_buswidth</span><span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">);</span>
		<span class="n">ctrla</span> <span class="o">|=</span>  <span class="n">ATC_SRC_WIDTH</span><span class="p">(</span><span class="n">reg_width</span><span class="p">);</span>
		<span class="n">ctrlb</span> <span class="o">|=</span>  <span class="n">ATC_DST_ADDR_MODE_INCR</span>
			<span class="o">|</span> <span class="n">ATC_SRC_ADDR_MODE_FIXED</span>
			<span class="o">|</span> <span class="n">ATC_FC_PER2MEM</span>
			<span class="o">|</span> <span class="n">ATC_SIF</span><span class="p">(</span><span class="n">AT_DMA_PER_IF</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATC_DIF</span><span class="p">(</span><span class="n">AT_DMA_MEM_IF</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">at_desc</span>	<span class="o">*</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">u32</span>		<span class="n">len</span><span class="p">;</span>
			<span class="n">u32</span>		<span class="n">mem</span><span class="p">;</span>

			<span class="n">desc</span> <span class="o">=</span> <span class="n">atc_desc_get</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_desc_get</span><span class="p">;</span>

			<span class="n">mem</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">mem_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mem</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
				<span class="n">mem_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrla</span> <span class="o">=</span> <span class="n">ctrla</span>
					<span class="o">|</span> <span class="n">ATC_DST_WIDTH</span><span class="p">(</span><span class="n">mem_width</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">reg_width</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrlb</span> <span class="o">=</span> <span class="n">ctrlb</span><span class="p">;</span>

			<span class="n">atc_desc_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
			<span class="n">total_len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set end-of-link to the last link descriptor of list*/</span>
	<span class="n">set_desc_eol</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>

	<span class="cm">/* First descriptor of the chain embedds additional information */</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">total_len</span><span class="p">;</span>

	<span class="cm">/* first link descriptor of list is responsible of flags */</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span> <span class="cm">/* client is in control of this ack */</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>

<span class="nl">err_desc_get:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;not enough descriptors available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">atc_desc_put</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_dma_cyclic_check_values</span>
<span class="cm"> * Check for too big/unaligned periods and unaligned DMA buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atc_dma_cyclic_check_values</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_width</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">buf_addr</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">period_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">period_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ATC_BTSIZE_MAX</span> <span class="o">&lt;&lt;</span> <span class="n">reg_width</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">period_len</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reg_width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">buf_addr</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reg_width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">direction</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMA_DEV_TO_MEM</span> <span class="o">|</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">))))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_dma_cyclic_fill_desc - Fill one period decriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atc_dma_cyclic_fill_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period_index</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">buf_addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_width</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">period_len</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span>	<span class="o">*</span><span class="n">sconfig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">dma_sconfig</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ctrla</span><span class="p">;</span>

	<span class="cm">/* prepare common CRTLA value */</span>
	<span class="n">ctrla</span> <span class="o">=</span>   <span class="n">ATC_SCSIZE</span><span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">src_maxburst</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">ATC_DCSIZE</span><span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">dst_maxburst</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">ATC_DST_WIDTH</span><span class="p">(</span><span class="n">reg_width</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">ATC_SRC_WIDTH</span><span class="p">(</span><span class="n">reg_width</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">period_len</span> <span class="o">&gt;&gt;</span> <span class="n">reg_width</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_MEM_TO_DEV</span>:
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">buf_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">period_len</span> <span class="o">*</span> <span class="n">period_index</span><span class="p">);</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrla</span> <span class="o">=</span> <span class="n">ctrla</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrlb</span> <span class="o">=</span> <span class="n">ATC_DST_ADDR_MODE_FIXED</span>
				<span class="o">|</span> <span class="n">ATC_SRC_ADDR_MODE_INCR</span>
				<span class="o">|</span> <span class="n">ATC_FC_MEM2PER</span>
				<span class="o">|</span> <span class="n">ATC_SIF</span><span class="p">(</span><span class="n">AT_DMA_MEM_IF</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">ATC_DIF</span><span class="p">(</span><span class="n">AT_DMA_PER_IF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DMA_DEV_TO_MEM</span>:
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">buf_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">period_len</span> <span class="o">*</span> <span class="n">period_index</span><span class="p">);</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrla</span> <span class="o">=</span> <span class="n">ctrla</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">ctrlb</span> <span class="o">=</span> <span class="n">ATC_DST_ADDR_MODE_INCR</span>
				<span class="o">|</span> <span class="n">ATC_SRC_ADDR_MODE_FIXED</span>
				<span class="o">|</span> <span class="n">ATC_FC_PER2MEM</span>
				<span class="o">|</span> <span class="n">ATC_SIF</span><span class="p">(</span><span class="n">AT_DMA_PER_IF</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">ATC_DIF</span><span class="p">(</span><span class="n">AT_DMA_MEM_IF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_prep_dma_cyclic - prepare the cyclic DMA transfer</span>
<span class="cm"> * @chan: the DMA channel to prepare</span>
<span class="cm"> * @buf_addr: physical DMA address where the buffer starts</span>
<span class="cm"> * @buf_len: total number of bytes for the entire buffer</span>
<span class="cm"> * @period_len: number of bytes for each period</span>
<span class="cm"> * @direction: transfer direction, to or from device</span>
<span class="cm"> * @context: transfer context (ignored)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">atc_prep_dma_cyclic</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">buf_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">period_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma_slave</span>	<span class="o">*</span><span class="n">atslave</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span>	<span class="o">*</span><span class="n">sconfig</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">dma_sconfig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">was_cyclic</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">reg_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">periods</span> <span class="o">=</span> <span class="n">buf_len</span> <span class="o">/</span> <span class="n">period_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_cyclic: %s buf@0x%08x - %d (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span> <span class="o">?</span> <span class="s">&quot;TO DEVICE&quot;</span> <span class="o">:</span> <span class="s">&quot;FROM DEVICE&quot;</span><span class="p">,</span>
			<span class="n">buf_addr</span><span class="p">,</span>
			<span class="n">periods</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">period_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">atslave</span> <span class="o">||</span> <span class="o">!</span><span class="n">buf_len</span> <span class="o">||</span> <span class="o">!</span><span class="n">period_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_cyclic: length is zero!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">was_cyclic</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">ATC_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">was_cyclic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_cyclic: channel in use!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span>
		<span class="n">reg_width</span> <span class="o">=</span> <span class="n">convert_buswidth</span><span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg_width</span> <span class="o">=</span> <span class="n">convert_buswidth</span><span class="p">(</span><span class="n">sconfig</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">);</span>

	<span class="cm">/* Check for too big/unaligned periods and unaligned DMA buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atc_dma_cyclic_check_values</span><span class="p">(</span><span class="n">reg_width</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span>
					<span class="n">period_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="cm">/* build cyclic linked list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">periods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at_desc</span>	<span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">atc_desc_get</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_desc_get</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atc_dma_cyclic_fill_desc</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span>
					     <span class="n">reg_width</span><span class="p">,</span> <span class="n">period_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_desc_get</span><span class="p">;</span>

		<span class="n">atc_desc_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* lets make a cyclic list */</span>
	<span class="n">prev</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">dscr</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">;</span>

	<span class="cm">/* First descriptor of the chain embedds additional information */</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>

<span class="nl">err_desc_get:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;not enough descriptors available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">atc_desc_put</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATC_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_runtime_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="n">sconfig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* Check if it is chan is configured for slave transfers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">dma_sconfig</span><span class="p">,</span> <span class="n">sconfig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sconfig</span><span class="p">));</span>

	<span class="n">convert_burst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">dma_sconfig</span><span class="p">.</span><span class="n">src_maxburst</span><span class="p">);</span>
	<span class="n">convert_burst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">dma_sconfig</span><span class="p">.</span><span class="n">dst_maxburst</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_cmd</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma</span>		<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">to_at_dma</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">chan_id</span> <span class="o">=</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">.</span><span class="n">chan_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;atc_control (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DMA_PAUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">CHER</span><span class="p">,</span> <span class="n">AT_DMA_SUSP</span><span class="p">(</span><span class="n">chan_id</span><span class="p">));</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ATC_IS_PAUSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DMA_RESUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc_chan_is_paused</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">CHDR</span><span class="p">,</span> <span class="n">AT_DMA_RES</span><span class="p">(</span><span class="n">chan_id</span><span class="p">));</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATC_IS_PAUSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DMA_TERMINATE_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at_desc</span>	<span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is only called when something went wrong elsewhere, so</span>
<span class="cm">		 * we don&#39;t really care about the data. Just disable the</span>
<span class="cm">		 * channel. We still have to poll the channel enable bit due</span>
<span class="cm">		 * to AHB/HSB limitations.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* disabling channel: must also remove suspend state */</span>
		<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">CHDR</span><span class="p">,</span> <span class="n">AT_DMA_RES</span><span class="p">(</span><span class="n">chan_id</span><span class="p">)</span> <span class="o">|</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>

		<span class="cm">/* confirm that this channel is disabled */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">dma_readl</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">CHSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">cpu_relax</span><span class="p">();</span>

		<span class="cm">/* active_list entries will end up before queued entries */</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>

		<span class="cm">/* Flush all pending and queued descriptors */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
			<span class="n">atc_chain_complete</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATC_IS_PAUSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="cm">/* if channel dedicated to cyclic operations, free it */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATC_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DMA_SLAVE_CONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">set_runtime_config</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_tx_status - poll for transaction completion</span>
<span class="cm"> * @chan: DMA channel</span>
<span class="cm"> * @cookie: transaction identifier to check status of</span>
<span class="cm"> * @txstate: if not %NULL updated with transaction state</span>
<span class="cm"> *</span>
<span class="cm"> * If @txstate is passed in, upon return it reflect the driver</span>
<span class="cm"> * internal state and can be used with dma_async_is_complete() to check</span>
<span class="cm"> * the status of multiple cookies without re-checking hardware state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span>
<span class="nf">atc_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
		<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dma_cookie_t</span>		<span class="n">last_used</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span>		<span class="n">last_complete</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_status</span>		<span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">DMA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atc_cleanup_descriptors</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">last_complete</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">completed_cookie</span><span class="p">;</span>
	<span class="n">last_used</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">DMA_SUCCESS</span><span class="p">)</span>
		<span class="n">dma_set_residue</span><span class="p">(</span><span class="n">txstate</span><span class="p">,</span> <span class="n">atc_first_active</span><span class="p">(</span><span class="n">atchan</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atc_chan_is_paused</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DMA_PAUSED</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;tx_status %d: cookie = %d (d%d, u%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ret</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">last_complete</span> <span class="o">?</span> <span class="n">last_complete</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">last_used</span> <span class="o">?</span> <span class="n">last_used</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_issue_pending - try to finish work</span>
<span class="cm"> * @chan: target DMA channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;issue_pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Not needed for cyclic transfers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atc_chan_is_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc_chan_is_enabled</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atc_advance_work</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_alloc_chan_resources - allocate resources for DMA channel</span>
<span class="cm"> * @chan: allocate descriptor resources for this channel</span>
<span class="cm"> * @client: current client requesting the channel be ready for requests</span>
<span class="cm"> *</span>
<span class="cm"> * return - the number of allocated descriptors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma</span>		<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">to_at_dma</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_dma_slave</span>	<span class="o">*</span><span class="n">atslave</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cfg</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tmp_list</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;alloc_chan_resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* ASSERT:  channel is idle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atc_chan_is_enabled</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;DMA channel not idle ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">ATC_DEFAULT_CFG</span><span class="p">;</span>

	<span class="n">atslave</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atslave</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We need controller-specific data to set up slave</span>
<span class="cm">		 * transfers.</span>
<span class="cm">		 */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">atslave</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">||</span> <span class="n">atslave</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">!=</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* if cfg configuration specified take it instad of default */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atslave</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">=</span> <span class="n">atslave</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* have we already been set up?</span>
<span class="cm">	 * reconfigure channel but no need to reallocate descriptors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">;</span>

	<span class="cm">/* Allocate initial pool of descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">init_nr_desc_per_channel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">atc_alloc_descriptor</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Only %d initial descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">descs_allocated</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
	<span class="n">dma_cookie_init</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* channel parameters */</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CFG</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
		<span class="s">&quot;alloc_chan_resources: allocated %d descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * atc_free_chan_resources - free all channel resources</span>
<span class="cm"> * @chan: DMA channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma</span>		<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">to_at_dma</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_desc</span>		<span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;free_chan_resources: (descs allocated=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">);</span>

	<span class="cm">/* ASSERT:  channel is idle */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atc_chan_is_enabled</span><span class="p">(</span><span class="n">atchan</span><span class="p">));</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;  freeing descriptor %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">);</span>
		<span class="cm">/* free link descriptor */</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">descs_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;free_chan_resources: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*--  Module Management  -----------------------------------------------*/</span>

<span class="cm">/* cap_mask is a multi-u32 bitfield, fill it with proper C code. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at_dma_platform_data</span> <span class="n">at91sam9rl_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nr_channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at_dma_platform_data</span> <span class="n">at91sam9g45_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nr_channels</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_OF)</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">atmel_dma_dt_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;atmel,at91sam9rl-dma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9rl_config</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;atmel,at91sam9g45-dma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9g45_config</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* sentinel */</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">atmel_dma_dt_ids</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">atdma_devtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;at91sam9rl_dma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">at91sam9rl_config</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;at91sam9g45_dma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">at91sam9g45_config</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* sentinel */</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">at_dma_platform_data</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">at_dma_get_driver_data</span><span class="p">(</span>
						<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
		<span class="n">match</span> <span class="o">=</span> <span class="n">of_match_node</span><span class="p">(</span><span class="n">atmel_dma_dt_ids</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_platform_data</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">platform_get_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * at_dma_off - disable DMA controller</span>
<span class="cm"> * @atdma: the Atmel HDAMC device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">at_dma_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma</span> <span class="o">*</span><span class="n">atdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* disable all interrupts */</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EBCIDR</span><span class="p">,</span> <span class="o">-</span><span class="mi">1L</span><span class="p">);</span>

	<span class="cm">/* confirm that all channels are disabled */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dma_readl</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">CHSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">all_chan_mask</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">at_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_dma</span>		<span class="o">*</span><span class="n">atdma</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_dma_platform_data</span> <span class="o">*</span><span class="n">plat_dat</span><span class="p">;</span>

	<span class="cm">/* setup platform data for each SoC */</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">at91sam9rl_config</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">at91sam9g45_config</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">at91sam9g45_config</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>

	<span class="cm">/* get DMA parameters from controller type */</span>
	<span class="n">plat_dat</span> <span class="o">=</span> <span class="n">at_dma_get_driver_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plat_dat</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">plat_dat</span><span class="o">-&gt;</span><span class="n">nr_channels</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span><span class="p">);</span>
	<span class="n">atdma</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atdma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* discover transaction capabilities */</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">cap_mask</span> <span class="o">=</span> <span class="n">plat_dat</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">;</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">all_chan_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">plat_dat</span><span class="o">-&gt;</span><span class="n">nr_channels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_clk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="cm">/* force dma off, just in case */</span>
	<span class="n">at_dma_off</span><span class="p">(</span><span class="n">atdma</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">at_dma_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;at_hdmac&quot;</span><span class="p">,</span> <span class="n">atdma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">atdma</span><span class="p">);</span>

	<span class="cm">/* create a pool of consistent memory blocks for hardware descriptors */</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="s">&quot;at_hdmac_desc_pool&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_desc</span><span class="p">),</span>
			<span class="mi">4</span> <span class="cm">/* word alignment */</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No memory for descriptors dma pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_pool_create</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear any pending interrupt */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dma_readl</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EBCISR</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="cm">/* initialize channels related values */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plat_dat</span><span class="o">-&gt;</span><span class="n">nr_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">;</span>
		<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>

		<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">ch_regs</span> <span class="o">=</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">ch_regs</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>

		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">atc_tasklet</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">atchan</span><span class="p">);</span>
		<span class="n">atc_enable_chan_irq</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set base routines */</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">atc_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">atc_free_chan_resources</span><span class="p">;</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">atc_tx_status</span><span class="p">;</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">atc_issue_pending</span><span class="p">;</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* set prep routines based on capability */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span>
		<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">atc_prep_dma_memcpy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">device_prep_slave_sg</span> <span class="o">=</span> <span class="n">atc_prep_slave_sg</span><span class="p">;</span>
		<span class="cm">/* controller can do slave DMA: can trigger cyclic transfers */</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_CYCLIC</span><span class="p">,</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">device_prep_dma_cyclic</span> <span class="o">=</span> <span class="n">atc_prep_dma_cyclic</span><span class="p">;</span>
		<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">atc_control</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EN</span><span class="p">,</span> <span class="n">AT_DMA_ENABLE</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Atmel AHB DMA Controller ( %s%s), %d channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;cpy &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span>  <span class="o">?</span> <span class="s">&quot;slave &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="n">plat_dat</span><span class="o">-&gt;</span><span class="n">nr_channels</span><span class="p">);</span>

	<span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pool_create:</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">atdma</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">err_clk:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_release_r:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="nl">err_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">atdma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">at_dma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma</span>		<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>		<span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="o">*</span><span class="n">io</span><span class="p">;</span>

	<span class="n">at_dma_off</span><span class="p">(</span><span class="n">atdma</span><span class="p">);</span>
	<span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">);</span>

	<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">atdma</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">_chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span>
			<span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at_dma_chan</span>	<span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="cm">/* Disable interrupts */</span>
		<span class="n">atc_disable_chan_irq</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span><span class="p">);</span>
		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device_node</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">io</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">atdma</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at_dma_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma</span>	<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">at_dma_off</span><span class="p">(</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at_dma_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma</span> <span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">_chan</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">_chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span>
			<span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="cm">/* wait for transaction completion (except in cyclic case) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atc_chan_is_enabled</span><span class="p">(</span><span class="n">atchan</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">atc_chan_is_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_suspend_cyclic</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>	<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">;</span>

	<span class="cm">/* Channel should be paused by user</span>
<span class="cm">	 * do it anyway even if it is not done already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc_chan_is_paused</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
		<span class="s">&quot;cyclic channel not paused, should be done by channel user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atc_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">DMA_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* now preserve additional data for cyclic operations */</span>
	<span class="cm">/* next descriptor address in the cyclic list */</span>
	<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">save_dscr</span> <span class="o">=</span> <span class="n">channel_readl</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">DSCR</span><span class="p">);</span>

	<span class="n">vdbg_dump_regs</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at_dma_suspend_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma</span> <span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">_chan</span><span class="p">;</span>

	<span class="cm">/* preserve data */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">_chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span>
			<span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atc_chan_is_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span>
			<span class="n">atc_suspend_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
		<span class="n">atchan</span><span class="o">-&gt;</span><span class="n">save_cfg</span> <span class="o">=</span> <span class="n">channel_readl</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CFG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atdma</span><span class="o">-&gt;</span><span class="n">save_imr</span> <span class="o">=</span> <span class="n">dma_readl</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EBCIMR</span><span class="p">);</span>

	<span class="cm">/* disable DMA controller */</span>
	<span class="n">at_dma_off</span><span class="p">(</span><span class="n">atdma</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_resume_cyclic</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_dma</span>	<span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">to_at_dma</span><span class="p">(</span><span class="n">atchan</span><span class="o">-&gt;</span><span class="n">chan_common</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/* restore channel status for cyclic descriptors list:</span>
<span class="cm">	 * next descriptor in the cyclic list at the time of suspend */</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">SADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">DADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CTRLA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CTRLB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">DSCR</span><span class="p">,</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">save_dscr</span><span class="p">);</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">CHER</span><span class="p">,</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* channel pause status should be removed by channel user</span>
<span class="cm">	 * We cannot take the initiative to do it here */</span>

	<span class="n">vdbg_dump_regs</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at_dma_resume_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at_dma</span> <span class="o">*</span><span class="n">atdma</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">_chan</span><span class="p">;</span>

	<span class="cm">/* bring back DMA controller */</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EN</span><span class="p">,</span> <span class="n">AT_DMA_ENABLE</span><span class="p">);</span>

	<span class="cm">/* clear any pending interrupt */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dma_readl</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EBCISR</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="cm">/* restore saved data */</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">atdma</span><span class="p">,</span> <span class="n">EBCIER</span><span class="p">,</span> <span class="n">atdma</span><span class="o">-&gt;</span><span class="n">save_imr</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">_chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atdma</span><span class="o">-&gt;</span><span class="n">dma_common</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span>
			<span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at_dma_chan</span> <span class="o">*</span><span class="n">atchan</span> <span class="o">=</span> <span class="n">to_at_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">channel_writel</span><span class="p">(</span><span class="n">atchan</span><span class="p">,</span> <span class="n">CFG</span><span class="p">,</span> <span class="n">atchan</span><span class="o">-&gt;</span><span class="n">save_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atc_chan_is_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">))</span>
			<span class="n">atc_resume_cyclic</span><span class="p">(</span><span class="n">atchan</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">at_dma_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">at_dma_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend_noirq</span> <span class="o">=</span> <span class="n">at_dma_suspend_noirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume_noirq</span> <span class="o">=</span> <span class="n">at_dma_resume_noirq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">at_dma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">at_dma_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">at_dma_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">atdma_devtypes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;at_hdmac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at_dma_dev_pm_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span>	<span class="o">=</span> <span class="n">of_match_ptr</span><span class="p">(</span><span class="n">atmel_dma_dt_ids</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">at_dma_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at_dma_driver</span><span class="p">,</span> <span class="n">at_dma_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">at_dma_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">at_dma_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at_dma_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">at_dma_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Atmel AHB DMA Controller driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Nicolas Ferre &lt;nicolas.ferre@atmel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:at_hdmac&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
