<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › ep93xx_dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ep93xx_dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the Cirrus Logic EP93xx DMA Controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Mika Westerberg</span>
<span class="cm"> *</span>
<span class="cm"> * DMA M2P implementation is based on the original</span>
<span class="cm"> * arch/arm/mach-ep93xx/dma-m2p.c which has following copyrights:</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) 2006 Lennert Buytenhek &lt;buytenh@wantstofly.org&gt;</span>
<span class="cm"> *   Copyright (C) 2006 Applied Data Systems</span>
<span class="cm"> *   Copyright (C) 2009 Ryan Mallon &lt;rmallon@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is based on dw_dmac and amba-pl08x drivers.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;mach/dma.h&gt;</span>

<span class="cp">#include &quot;dmaengine.h&quot;</span>

<span class="cm">/* M2P registers */</span>
<span class="cp">#define M2P_CONTROL			0x0000</span>
<span class="cp">#define M2P_CONTROL_STALLINT		BIT(0)</span>
<span class="cp">#define M2P_CONTROL_NFBINT		BIT(1)</span>
<span class="cp">#define M2P_CONTROL_CH_ERROR_INT	BIT(3)</span>
<span class="cp">#define M2P_CONTROL_ENABLE		BIT(4)</span>
<span class="cp">#define M2P_CONTROL_ICE			BIT(6)</span>

<span class="cp">#define M2P_INTERRUPT			0x0004</span>
<span class="cp">#define M2P_INTERRUPT_STALL		BIT(0)</span>
<span class="cp">#define M2P_INTERRUPT_NFB		BIT(1)</span>
<span class="cp">#define M2P_INTERRUPT_ERROR		BIT(3)</span>

<span class="cp">#define M2P_PPALLOC			0x0008</span>
<span class="cp">#define M2P_STATUS			0x000c</span>

<span class="cp">#define M2P_MAXCNT0			0x0020</span>
<span class="cp">#define M2P_BASE0			0x0024</span>
<span class="cp">#define M2P_MAXCNT1			0x0030</span>
<span class="cp">#define M2P_BASE1			0x0034</span>

<span class="cp">#define M2P_STATE_IDLE			0</span>
<span class="cp">#define M2P_STATE_STALL			1</span>
<span class="cp">#define M2P_STATE_ON			2</span>
<span class="cp">#define M2P_STATE_NEXT			3</span>

<span class="cm">/* M2M registers */</span>
<span class="cp">#define M2M_CONTROL			0x0000</span>
<span class="cp">#define M2M_CONTROL_DONEINT		BIT(2)</span>
<span class="cp">#define M2M_CONTROL_ENABLE		BIT(3)</span>
<span class="cp">#define M2M_CONTROL_START		BIT(4)</span>
<span class="cp">#define M2M_CONTROL_DAH			BIT(11)</span>
<span class="cp">#define M2M_CONTROL_SAH			BIT(12)</span>
<span class="cp">#define M2M_CONTROL_PW_SHIFT		9</span>
<span class="cp">#define M2M_CONTROL_PW_8		(0 &lt;&lt; M2M_CONTROL_PW_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_PW_16		(1 &lt;&lt; M2M_CONTROL_PW_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_PW_32		(2 &lt;&lt; M2M_CONTROL_PW_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_PW_MASK		(3 &lt;&lt; M2M_CONTROL_PW_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_TM_SHIFT		13</span>
<span class="cp">#define M2M_CONTROL_TM_TX		(1 &lt;&lt; M2M_CONTROL_TM_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_TM_RX		(2 &lt;&lt; M2M_CONTROL_TM_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_NFBINT		BIT(21)</span>
<span class="cp">#define M2M_CONTROL_RSS_SHIFT		22</span>
<span class="cp">#define M2M_CONTROL_RSS_SSPRX		(1 &lt;&lt; M2M_CONTROL_RSS_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_RSS_SSPTX		(2 &lt;&lt; M2M_CONTROL_RSS_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_RSS_IDE		(3 &lt;&lt; M2M_CONTROL_RSS_SHIFT)</span>
<span class="cp">#define M2M_CONTROL_NO_HDSK		BIT(24)</span>
<span class="cp">#define M2M_CONTROL_PWSC_SHIFT		25</span>

<span class="cp">#define M2M_INTERRUPT			0x0004</span>
<span class="cp">#define M2M_INTERRUPT_MASK		6</span>

<span class="cp">#define M2M_STATUS			0x000c</span>
<span class="cp">#define M2M_STATUS_CTL_SHIFT		1</span>
<span class="cp">#define M2M_STATUS_CTL_IDLE		(0 &lt;&lt; M2M_STATUS_CTL_SHIFT)</span>
<span class="cp">#define M2M_STATUS_CTL_STALL		(1 &lt;&lt; M2M_STATUS_CTL_SHIFT)</span>
<span class="cp">#define M2M_STATUS_CTL_MEMRD		(2 &lt;&lt; M2M_STATUS_CTL_SHIFT)</span>
<span class="cp">#define M2M_STATUS_CTL_MEMWR		(3 &lt;&lt; M2M_STATUS_CTL_SHIFT)</span>
<span class="cp">#define M2M_STATUS_CTL_BWCWAIT		(4 &lt;&lt; M2M_STATUS_CTL_SHIFT)</span>
<span class="cp">#define M2M_STATUS_CTL_MASK		(7 &lt;&lt; M2M_STATUS_CTL_SHIFT)</span>
<span class="cp">#define M2M_STATUS_BUF_SHIFT		4</span>
<span class="cp">#define M2M_STATUS_BUF_NO		(0 &lt;&lt; M2M_STATUS_BUF_SHIFT)</span>
<span class="cp">#define M2M_STATUS_BUF_ON		(1 &lt;&lt; M2M_STATUS_BUF_SHIFT)</span>
<span class="cp">#define M2M_STATUS_BUF_NEXT		(2 &lt;&lt; M2M_STATUS_BUF_SHIFT)</span>
<span class="cp">#define M2M_STATUS_BUF_MASK		(3 &lt;&lt; M2M_STATUS_BUF_SHIFT)</span>
<span class="cp">#define M2M_STATUS_DONE			BIT(6)</span>

<span class="cp">#define M2M_BCR0			0x0010</span>
<span class="cp">#define M2M_BCR1			0x0014</span>
<span class="cp">#define M2M_SAR_BASE0			0x0018</span>
<span class="cp">#define M2M_SAR_BASE1			0x001c</span>
<span class="cp">#define M2M_DAR_BASE0			0x002c</span>
<span class="cp">#define M2M_DAR_BASE1			0x0030</span>

<span class="cp">#define DMA_MAX_CHAN_BYTES		0xffff</span>
<span class="cp">#define DMA_MAX_CHAN_DESCRIPTORS	32</span>

<span class="k">struct</span> <span class="n">ep93xx_dma_engine</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct ep93xx_dma_desc - EP93xx specific transaction descriptor</span>
<span class="cm"> * @src_addr: source address of the transaction</span>
<span class="cm"> * @dst_addr: destination address of the transaction</span>
<span class="cm"> * @size: size of the transaction (in bytes)</span>
<span class="cm"> * @complete: this descriptor is completed</span>
<span class="cm"> * @txd: dmaengine API descriptor</span>
<span class="cm"> * @tx_list: list of linked descriptors</span>
<span class="cm"> * @node: link used for putting this into a channel queue</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="p">{</span>
	<span class="n">u32</span>				<span class="n">src_addr</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">size_t</span>				<span class="n">size</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="n">txd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">tx_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">node</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct ep93xx_dma_chan - an EP93xx DMA M2P/M2M channel</span>
<span class="cm"> * @chan: dmaengine API channel</span>
<span class="cm"> * @edma: pointer to to the engine device</span>
<span class="cm"> * @regs: memory mapped registers</span>
<span class="cm"> * @irq: interrupt number of the channel</span>
<span class="cm"> * @clk: clock used by this channel</span>
<span class="cm"> * @tasklet: channel specific tasklet used for callbacks</span>
<span class="cm"> * @lock: lock protecting the fields following</span>
<span class="cm"> * @flags: flags for the channel</span>
<span class="cm"> * @buffer: which buffer to use next (0/1)</span>
<span class="cm"> * @active: flattened chain of descriptors currently being processed</span>
<span class="cm"> * @queue: pending descriptors which are handled next</span>
<span class="cm"> * @free_list: list of free descriptors which can be used</span>
<span class="cm"> * @runtime_addr: physical address currently used as dest/src (M2M only). This</span>
<span class="cm"> *                is set via %DMA_SLAVE_CONFIG before slave operation is</span>
<span class="cm"> *                prepared</span>
<span class="cm"> * @runtime_ctrl: M2M runtime values for the control register.</span>
<span class="cm"> *</span>
<span class="cm"> * As EP93xx DMA controller doesn&#39;t support real chained DMA descriptors we</span>
<span class="cm"> * will have slightly different scheme here: @active points to a head of</span>
<span class="cm"> * flattened DMA descriptor chain.</span>
<span class="cm"> *</span>
<span class="cm"> * @queue holds pending transactions. These are linked through the first</span>
<span class="cm"> * descriptor in the chain. When a descriptor is moved to the @active queue,</span>
<span class="cm"> * the first and chained descriptors are flattened into a single list.</span>
<span class="cm"> *</span>
<span class="cm"> * @chan.private holds pointer to &amp;struct ep93xx_dma_data which contains</span>
<span class="cm"> * necessary channel configuration information. For memcpy channels this must</span>
<span class="cm"> * be %NULL.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="n">chan</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ep93xx_dma_engine</span>	<span class="o">*</span><span class="n">edma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>			<span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>		<span class="n">tasklet</span><span class="p">;</span>
	<span class="cm">/* protects the fields following */</span>
	<span class="n">spinlock_t</span>			<span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>
<span class="cm">/* Channel is configured for cyclic transfers */</span>
<span class="cp">#define EP93XX_DMA_IS_CYCLIC		0</span>

	<span class="kt">int</span>				<span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">free_list</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">runtime_addr</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">runtime_ctrl</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct ep93xx_dma_engine - the EP93xx DMA engine instance</span>
<span class="cm"> * @dma_dev: holds the dmaengine device</span>
<span class="cm"> * @m2m: is this an M2M or M2P device</span>
<span class="cm"> * @hw_setup: method which sets the channel up for operation</span>
<span class="cm"> * @hw_shutdown: shuts the channel down and flushes whatever is left</span>
<span class="cm"> * @hw_submit: pushes active descriptor(s) to the hardware</span>
<span class="cm"> * @hw_interrupt: handle the interrupt</span>
<span class="cm"> * @num_channels: number of channels for this instance</span>
<span class="cm"> * @channels: array of channels</span>
<span class="cm"> *</span>
<span class="cm"> * There is one instance of this struct for the M2P channels and one for the</span>
<span class="cm"> * M2M channels. hw_xxx() methods are used to perform operations which are</span>
<span class="cm"> * different on M2M and M2P channels. These methods are called with channel</span>
<span class="cm"> * lock held and interrupts disabled so they cannot sleep.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ep93xx_dma_engine</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span>	<span class="n">dma_dev</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">m2m</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">hw_setup</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">hw_shutdown</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">hw_submit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">hw_interrupt</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#define INTERRUPT_UNKNOWN	0</span>
<span class="cp">#define INTERRUPT_DONE		1</span>
<span class="cp">#define INTERRUPT_NEXT_BUFFER	2</span>

	<span class="kt">size_t</span>			<span class="n">num_channels</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span>	<span class="n">channels</span><span class="p">[];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">chan2dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="nf">to_ep93xx_dma_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ep93xx_dma_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_set_active - set new active descriptor chain</span>
<span class="cm"> * @edmac: channel</span>
<span class="cm"> * @desc: head of the new active descriptor chain</span>
<span class="cm"> *</span>
<span class="cm"> * Sets @desc to be the head of the new active descriptor chain. This is the</span>
<span class="cm"> * chain which is processed next. The active list must be empty before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> *</span>
<span class="cm"> * Called with @edmac-&gt;lock held and interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xx_dma_set_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">));</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="cm">/* Flatten the @desc-&gt;tx_list chain into @edmac-&gt;active list */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We copy the callback parameters from the first descriptor</span>
<span class="cm">		 * to all the chained descriptors. This way we can call the</span>
<span class="cm">		 * callback without having to find out the first descriptor in</span>
<span class="cm">		 * the chain. Useful for cyclic transfers.</span>
<span class="cm">		 */</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback_param</span><span class="p">;</span>

		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Called with @edmac-&gt;lock held and interrupts disabled */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span>
<span class="nf">ep93xx_dma_get_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ep93xx_dma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_advance_active - advances to the next active descriptor</span>
<span class="cm"> * @edmac: channel</span>
<span class="cm"> *</span>
<span class="cm"> * Function advances active descriptor to the next in the @edmac-&gt;active and</span>
<span class="cm"> * returns %true if we still have descriptors in the chain to process.</span>
<span class="cm"> * Otherwise returns %false.</span>
<span class="cm"> *</span>
<span class="cm"> * When the channel is in cyclic mode always returns %true.</span>
<span class="cm"> *</span>
<span class="cm"> * Called with @edmac-&gt;lock held and interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ep93xx_dma_advance_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">list_rotate_left</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EP93XX_DMA_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_get_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If txd.cookie is set it means that we are back in the first</span>
<span class="cm">	 * descriptor in the chain and hence done with it.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * M2P DMA implementation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m2p_set_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">,</span> <span class="n">u32</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_CONTROL</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * EP93xx User&#39;s Guide states that we must perform a dummy read after</span>
<span class="cm">	 * write to the control register.</span>
<span class="cm">	 */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m2p_hw_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_PPALLOC</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">M2P_CONTROL_CH_ERROR_INT</span> <span class="o">|</span> <span class="n">M2P_CONTROL_ICE</span>
		<span class="o">|</span> <span class="n">M2P_CONTROL_ENABLE</span><span class="p">;</span>
	<span class="n">m2p_set_control</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">m2p_channel_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_STATUS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m2p_hw_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_CONTROL</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">M2P_CONTROL_STALLINT</span> <span class="o">|</span> <span class="n">M2P_CONTROL_NFBINT</span><span class="p">);</span>
	<span class="n">m2p_set_control</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">m2p_channel_state</span><span class="p">(</span><span class="n">edmac</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">M2P_STATE_ON</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">m2p_set_control</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">m2p_channel_state</span><span class="p">(</span><span class="n">edmac</span><span class="p">)</span> <span class="o">==</span> <span class="n">M2P_STATE_STALL</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m2p_fill_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bus_addr</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_get_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;M2P: empty descriptor list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep93xx_dma_chan_direction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">)</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span>
		<span class="n">bus_addr</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bus_addr</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_MAXCNT0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_BASE0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_MAXCNT1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_BASE1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m2p_hw_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_CONTROL</span><span class="p">);</span>

	<span class="n">m2p_fill_desc</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">M2P_CONTROL_STALLINT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep93xx_dma_advance_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">m2p_fill_desc</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">M2P_CONTROL_NFBINT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m2p_set_control</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m2p_hw_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">irq_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_INTERRUPT</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">M2P_INTERRUPT_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_get_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>

		<span class="cm">/* Clear the error interrupt */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_INTERRUPT</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * It seems that there is no easy way of reporting errors back</span>
<span class="cm">		 * to client so we just report the error here and continue as</span>
<span class="cm">		 * usual.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Revisit this when there is a mechanism to report back the</span>
<span class="cm">		 * errors.</span>
<span class="cm">		 */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span>
			<span class="s">&quot;DMA transfer failed! Details:</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">cookie	: %d</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">src_addr	: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">dst_addr	: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">size		: %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M2P_INTERRUPT_STALL</span> <span class="o">|</span> <span class="n">M2P_INTERRUPT_NFB</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">M2P_INTERRUPT_STALL</span>:
		<span class="cm">/* Disable interrupts */</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2P_CONTROL</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">M2P_CONTROL_STALLINT</span> <span class="o">|</span> <span class="n">M2P_CONTROL_NFBINT</span><span class="p">);</span>
		<span class="n">m2p_set_control</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">INTERRUPT_DONE</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">M2P_INTERRUPT_NFB</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ep93xx_dma_advance_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">))</span>
			<span class="n">m2p_fill_desc</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">INTERRUPT_NEXT_BUFFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">INTERRUPT_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * M2M DMA implementation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m2m_hw_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ep93xx_dma_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is memcpy channel, nothing to configure */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EP93XX_DMA_SSP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This was found via experimenting - anything less than 5</span>
<span class="cm">		 * causes the channel to perform only a partial transfer which</span>
<span class="cm">		 * leads to problems since we don&#39;t get DONE interrupt then.</span>
<span class="cm">		 */</span>
		<span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="n">M2M_CONTROL_PWSC_SHIFT</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_NO_HDSK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_DAH</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_TM_TX</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_RSS_SSPTX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_SAH</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_TM_RX</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_RSS_SSPRX</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EP93XX_DMA_IDE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This IDE part is totally untested. Values below are taken</span>
<span class="cm">		 * from the EP93xx Users&#39;s Guide and might not be correct.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Worst case from the UG */</span>
			<span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">M2M_CONTROL_PWSC_SHIFT</span><span class="p">);</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_DAH</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_TM_TX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">M2M_CONTROL_PWSC_SHIFT</span><span class="p">);</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_SAH</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_TM_RX</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_NO_HDSK</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_RSS_IDE</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_PW_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m2m_hw_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Just disable the channel */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m2m_fill_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_get_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;M2M: empty descriptor list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_SAR_BASE0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_DAR_BASE0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_BCR0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_SAR_BASE1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_DAR_BASE1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_BCR1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m2m_hw_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we allow clients to configure PW (peripheral width) we always</span>
<span class="cm">	 * clear PW bits here and then set them according what is given in</span>
<span class="cm">	 * the runtime configuration.</span>
<span class="cm">	 */</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M2M_CONTROL_PW_MASK</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_ctrl</span><span class="p">;</span>

	<span class="n">m2m_fill_desc</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_DONEINT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep93xx_dma_advance_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">m2m_fill_desc</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_NFBINT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we can finally enable the channel. For M2M channel this must be</span>
<span class="cm">	 * done _after_ the BCRx registers are programmed.</span>
<span class="cm">	 */</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For memcpy channels the software trigger must be asserted</span>
<span class="cm">		 * in order to start the memcpy operation.</span>
<span class="cm">		 */</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_START</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * According to EP93xx User&#39;s Guide, we should receive DONE interrupt when all</span>
<span class="cm"> * M2M DMA controller transactions complete normally. This is not always the</span>
<span class="cm"> * case - sometimes EP93xx M2M DMA asserts DONE interrupt when the DMA channel</span>
<span class="cm"> * is still running (channel Buffer FSM in DMA_BUF_ON state, and channel</span>
<span class="cm"> * Control FSM in DMA_MEM_RD state, observed at least in IDE-DMA operation).</span>
<span class="cm"> * In effect, disabling the channel when only DONE bit is set could stop</span>
<span class="cm"> * currently running DMA transfer. To avoid this, we use Buffer FSM and</span>
<span class="cm"> * Control FSM to check current state of DMA channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m2m_hw_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_STATUS</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ctl_fsm</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">M2M_STATUS_CTL_MASK</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_fsm</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">M2M_STATUS_BUF_MASK</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">done</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">M2M_STATUS_DONE</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">last_done</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* Accept only DONE and NFB interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_INTERRUPT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">M2M_INTERRUPT_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">INTERRUPT_UNKNOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear the DONE bit */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_INTERRUPT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether we are done with descriptors or not. This, together</span>
<span class="cm">	 * with DMA channel state, determines action to take in interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_get_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="n">last_done</span> <span class="o">=</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use M2M DMA Buffer FSM and Control FSM to check current state of</span>
<span class="cm">	 * DMA channel. Using DONE and NFB bits from channel status register</span>
<span class="cm">	 * or bits from channel interrupt register is not reliable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_done</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">buf_fsm</span> <span class="o">==</span> <span class="n">M2M_STATUS_BUF_NO</span> <span class="o">||</span>
	     <span class="n">buf_fsm</span> <span class="o">==</span> <span class="n">M2M_STATUS_BUF_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Two buffers are ready for update when Buffer FSM is in</span>
<span class="cm">		 * DMA_NO_BUF state. Only one buffer can be prepared without</span>
<span class="cm">		 * disabling the channel or polling the DONE bit.</span>
<span class="cm">		 * To simplify things, always prepare only one buffer.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep93xx_dma_advance_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">m2m_fill_desc</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Software trigger for memcpy channel */</span>
				<span class="n">control</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>
				<span class="n">control</span> <span class="o">|=</span> <span class="n">M2M_CONTROL_START</span><span class="p">;</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">INTERRUPT_NEXT_BUFFER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">last_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable the channel only when Buffer FSM is in DMA_NO_BUF state</span>
<span class="cm">	 * and Control FSM is in DMA_STALL state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_done</span> <span class="o">&amp;&amp;</span>
	    <span class="n">buf_fsm</span> <span class="o">==</span> <span class="n">M2M_STATUS_BUF_NO</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ctl_fsm</span> <span class="o">==</span> <span class="n">M2M_STATUS_CTL_STALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable interrupts and the channel */</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">M2M_CONTROL_DONEINT</span> <span class="o">|</span> <span class="n">M2M_CONTROL_NFBINT</span>
			    <span class="o">|</span> <span class="n">M2M_CONTROL_ENABLE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">M2M_CONTROL</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">INTERRUPT_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Nothing to do this time.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">INTERRUPT_NEXT_BUFFER</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DMA engine API implementation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span>
<span class="nf">ep93xx_dma_desc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async_tx_test_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

			<span class="cm">/* Re-initialize the descriptor */</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xx_dma_desc_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_advance_work - start processing the next pending transaction</span>
<span class="cm"> * @edmac: channel</span>
<span class="cm"> *</span>
<span class="cm"> * If we have pending transactions queued and we are currently idling, this</span>
<span class="cm"> * function takes the next queued transaction from the @edmac-&gt;queue and</span>
<span class="cm"> * pushes it to the hardware for execution.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xx_dma_advance_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Take the next descriptor from the pending queue */</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ep93xx_dma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">ep93xx_dma_set_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

	<span class="cm">/* Push it to the hardware */</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_submit</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xx_dma_unmap_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_SRC_UNMAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SRC_UNMAP_SINGLE</span><span class="p">)</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_DEST_UNMAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_DEST_UNMAP_SINGLE</span><span class="p">)</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				       <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xx_dma_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="n">dma_async_tx_callback</span> <span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">callback_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If dma_terminate_all() was called before we get to run, the active</span>
<span class="cm">	 * list has become empty. If that happens we aren&#39;t supposed to do</span>
<span class="cm">	 * anything more than call ep93xx_dma_advance_work().</span>
<span class="cm">	 */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_get_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* mark descriptor complete for non cyclic case only */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EP93XX_DMA_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>
			<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback</span><span class="p">;</span>
		<span class="n">callback_param</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback_param</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Pick up the next descriptor from the queue */</span>
	<span class="n">ep93xx_dma_advance_work</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>

	<span class="cm">/* Now we can release all the chained descriptors */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For the memcpy channels the API requires us to unmap the</span>
<span class="cm">		 * buffers unless requested otherwise.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span><span class="p">)</span>
			<span class="n">ep93xx_dma_unmap_buffers</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

		<span class="n">ep93xx_dma_desc_put</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">callback</span><span class="p">(</span><span class="n">callback_param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ep93xx_dma_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_get_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span>
			 <span class="s">&quot;got interrupt while active list is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_interrupt</span><span class="p">(</span><span class="n">edmac</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INTERRUPT_DONE</span>:
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">INTERRUPT_NEXT_BUFFER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EP93XX_DMA_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;unknown interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_tx_submit - set the prepared descriptor(s) to be executed</span>
<span class="cm"> * @tx: descriptor to be executed</span>
<span class="cm"> *</span>
<span class="cm"> * Function will execute given descriptor on the hardware or if the hardware</span>
<span class="cm"> * is busy, queue the descriptor to be executed later on. Returns cookie which</span>
<span class="cm"> * can be used to poll the status of the descriptor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">ep93xx_dma_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ep93xx_dma_desc</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If nothing is currently prosessed, we push this descriptor</span>
<span class="cm">	 * directly to the hardware. Otherwise we put the descriptor</span>
<span class="cm">	 * to the pending queue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ep93xx_dma_set_active</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_submit</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_alloc_chan_resources - allocate resources for the channel</span>
<span class="cm"> * @chan: channel to allocate resources</span>
<span class="cm"> *</span>
<span class="cm"> * Function allocates necessary resources for the given DMA channel and</span>
<span class="cm"> * returns number of allocated descriptors for the channel. Negative errno</span>
<span class="cm"> * is returned in case of failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xx_dma_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">dma_chan_name</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Sanity check the channel parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">m2m</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&lt;</span> <span class="n">EP93XX_DMA_I2S1</span> <span class="o">||</span>
		    <span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&gt;</span> <span class="n">EP93XX_DMA_IRDA</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">ep93xx_dma_chan_direction</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">EP93XX_DMA_SSP</span>:
			<span class="k">case</span> <span class="n">EP93XX_DMA_IDE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_MEM_TO_DEV</span> <span class="o">&amp;&amp;</span>
				    <span class="n">data</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ep93xx_dma_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">edmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_clk_disable</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_setup</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_irq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DMA_MAX_CHAN_DESCRIPTORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;not enough descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>

		<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_CTRL_ACK</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">ep93xx_dma_tx_submit</span><span class="p">;</span>

		<span class="n">ep93xx_dma_desc_put</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

<span class="nl">fail_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">edmac</span><span class="p">);</span>
<span class="nl">fail_clk_disable:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_free_chan_resources - release resources for the channel</span>
<span class="cm"> * @chan: channel</span>
<span class="cm"> *</span>
<span class="cm"> * Function releases all the resources allocated for the given channel.</span>
<span class="cm"> * The channel must be idle when this is called.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xx_dma_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_shutdown</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">edmac</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_prep_dma_memcpy - prepare a memcpy DMA operation</span>
<span class="cm"> * @chan: channel</span>
<span class="cm"> * @dest: destination bus address</span>
<span class="cm"> * @src: source bus address</span>
<span class="cm"> * @len: size of the transaction</span>
<span class="cm"> * @flags: flags for the descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a valid DMA descriptor or %NULL in case of failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ep93xx_dma_prep_dma_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dest</span><span class="p">,</span>
			   <span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_desc_get</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;couln&#39;t get descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bytes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">DMA_MAX_CHAN_BYTES</span><span class="p">);</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">ep93xx_dma_desc_put</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_prep_slave_sg - prepare a slave DMA operation</span>
<span class="cm"> * @chan: channel</span>
<span class="cm"> * @sgl: list of buffers to transfer</span>
<span class="cm"> * @sg_len: number of entries in @sgl</span>
<span class="cm"> * @dir: direction of tha DMA transfer</span>
<span class="cm"> * @flags: flags for the descriptor</span>
<span class="cm"> * @context: operation context (ignored)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a valid DMA descriptor or %NULL in case of failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ep93xx_dma_prep_slave_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">dir</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">m2m</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">!=</span> <span class="n">ep93xx_dma_chan_direction</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span>
			 <span class="s">&quot;channel was configured with different direction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EP93XX_DMA_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span>
			 <span class="s">&quot;channel is already used for cyclic transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sg_len</span> <span class="o">&gt;</span> <span class="n">DMA_MAX_CHAN_BYTES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;too big transfer size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">sg_len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_desc_get</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;couln&#39;t get descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_addr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_addr</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">ep93xx_dma_desc_put</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_prep_dma_cyclic - prepare a cyclic DMA operation</span>
<span class="cm"> * @chan: channel</span>
<span class="cm"> * @dma_addr: DMA mapped address of the buffer</span>
<span class="cm"> * @buf_len: length of the buffer (in bytes)</span>
<span class="cm"> * @period_len: lenght of a single period</span>
<span class="cm"> * @dir: direction of the operation</span>
<span class="cm"> * @context: operation context (ignored)</span>
<span class="cm"> *</span>
<span class="cm"> * Prepares a descriptor for cyclic DMA operation. This means that once the</span>
<span class="cm"> * descriptor is submitted, we will be submitting in a @period_len sized</span>
<span class="cm"> * buffers and calling callback once the period has been elapsed. Transfer</span>
<span class="cm"> * terminates only when client calls dmaengine_terminate_all() for this</span>
<span class="cm"> * channel.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a valid DMA descriptor or %NULL in case of failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ep93xx_dma_prep_dma_cyclic</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">period_len</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">m2m</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">!=</span> <span class="n">ep93xx_dma_chan_direction</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span>
			 <span class="s">&quot;channel was configured with different direction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">EP93XX_DMA_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span>
			 <span class="s">&quot;channel is already used for cyclic transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period_len</span> <span class="o">&gt;</span> <span class="n">DMA_MAX_CHAN_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;too big period length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">period_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Split the buffer into period size chunks */</span>
	<span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">period_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">ep93xx_dma_desc_get</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">edmac</span><span class="p">),</span> <span class="s">&quot;couln&#39;t get descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_addr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_addr</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">period_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">ep93xx_dma_desc_put</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_terminate_all - terminate all transactions</span>
<span class="cm"> * @edmac: channel</span>
<span class="cm"> *</span>
<span class="cm"> * Stops all DMA transactions. All descriptors are put back to the</span>
<span class="cm"> * @edmac-&gt;free_list and callbacks are _not_ called.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xx_dma_terminate_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* First we disable and flush the DMA channel */</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_shutdown</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">EP93XX_DMA_IS_CYCLIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We then re-enable the channel. This way we can continue submitting</span>
<span class="cm">	 * the descriptors by just calling -&gt;hw_submit() again.</span>
<span class="cm">	 */</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_setup</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">ep93xx_dma_desc_put</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xx_dma_slave_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">dma_slave_buswidth</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">m2m</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_DEV_TO_MEM</span>:
		<span class="n">width</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DMA_MEM_TO_DEV</span>:
		<span class="n">width</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_1_BYTE</span>:
		<span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_2_BYTES</span>:
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">M2M_CONTROL_PW_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span>:
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">M2M_CONTROL_PW_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">runtime_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_control - manipulate all pending operations on a channel</span>
<span class="cm"> * @chan: channel</span>
<span class="cm"> * @cmd: control command to perform</span>
<span class="cm"> * @arg: optional argument</span>
<span class="cm"> *</span>
<span class="cm"> * Controls the channel. Function returns %0 in case of success or negative</span>
<span class="cm"> * error in case of failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep93xx_dma_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_TERMINATE_ALL</span>:
		<span class="k">return</span> <span class="n">ep93xx_dma_terminate_all</span><span class="p">(</span><span class="n">edmac</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">DMA_SLAVE_CONFIG</span>:
		<span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ep93xx_dma_slave_config</span><span class="p">(</span><span class="n">edmac</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_tx_status - check if a transaction is completed</span>
<span class="cm"> * @chan: channel</span>
<span class="cm"> * @cookie: transaction specific cookie</span>
<span class="cm"> * @state: state of the transaction is stored here if given</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to query state of a given transaction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span> <span class="nf">ep93xx_dma_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					    <span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_status</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep93xx_dma_issue_pending - push pending transactions to the hardware</span>
<span class="cm"> * @chan: channel</span>
<span class="cm"> *</span>
<span class="cm"> * When this function is called, all pending transactions are pushed to the</span>
<span class="cm"> * hardware and executed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep93xx_dma_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ep93xx_dma_advance_work</span><span class="p">(</span><span class="n">to_ep93xx_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ep93xx_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ep93xx_dma_engine</span> <span class="o">*</span><span class="n">edma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma_dev</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">edma_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">edma_size</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ep93xx_dma_chan</span><span class="p">);</span>
	<span class="n">edma</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">edma</span><span class="p">)</span> <span class="o">+</span> <span class="n">edma_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">;</span>
	<span class="n">edma</span><span class="o">-&gt;</span><span class="n">m2m</span> <span class="o">=</span> <span class="n">platform_get_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">edma</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">ep93xx_dma_chan_data</span> <span class="o">*</span><span class="n">cdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">dma_dev</span><span class="p">;</span>
		<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">edma</span> <span class="o">=</span> <span class="n">edma</span><span class="p">;</span>

		<span class="n">edmac</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get clock for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">ep93xx_dma_tasklet</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">edmac</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_CYCLIC</span><span class="p">,</span> <span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>

	<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">ep93xx_dma_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">ep93xx_dma_free_chan_resources</span><span class="p">;</span>
	<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_prep_slave_sg</span> <span class="o">=</span> <span class="n">ep93xx_dma_prep_slave_sg</span><span class="p">;</span>
	<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_prep_dma_cyclic</span> <span class="o">=</span> <span class="n">ep93xx_dma_prep_dma_cyclic</span><span class="p">;</span>
	<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">ep93xx_dma_control</span><span class="p">;</span>
	<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">ep93xx_dma_issue_pending</span><span class="p">;</span>
	<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">ep93xx_dma_tx_status</span><span class="p">;</span>

	<span class="n">dma_set_max_seg_size</span><span class="p">(</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_MAX_CHAN_BYTES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">m2m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">ep93xx_dma_prep_dma_memcpy</span><span class="p">;</span>

		<span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_setup</span> <span class="o">=</span> <span class="n">m2m_hw_setup</span><span class="p">;</span>
		<span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_shutdown</span> <span class="o">=</span> <span class="n">m2m_hw_shutdown</span><span class="p">;</span>
		<span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_submit</span> <span class="o">=</span> <span class="n">m2m_hw_submit</span><span class="p">;</span>
		<span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_interrupt</span> <span class="o">=</span> <span class="n">m2m_hw_interrupt</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_PRIVATE</span><span class="p">,</span> <span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>

		<span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_setup</span> <span class="o">=</span> <span class="n">m2p_hw_setup</span><span class="p">;</span>
		<span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_shutdown</span> <span class="o">=</span> <span class="n">m2p_hw_shutdown</span><span class="p">;</span>
		<span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_submit</span> <span class="o">=</span> <span class="n">m2p_hw_submit</span><span class="p">;</span>
		<span class="n">edma</span><span class="o">-&gt;</span><span class="n">hw_interrupt</span> <span class="o">=</span> <span class="n">m2p_hw_interrupt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="n">dma_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">edma</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ep93xx_dma_chan</span> <span class="o">*</span><span class="n">edmac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span>
				<span class="n">clk_put</span><span class="p">(</span><span class="n">edmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edma</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EP93xx M2%s DMA ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">edma</span><span class="o">-&gt;</span><span class="n">m2m</span> <span class="o">?</span> <span class="s">&quot;M&quot;</span> <span class="o">:</span> <span class="s">&quot;P&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">ep93xx_dma_driver_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ep93xx-dma-m2p&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ep93xx-dma-m2m&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ep93xx_dma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ep93xx-dma&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ep93xx_dma_driver_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ep93xx_dma_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep93xx_dma_driver</span><span class="p">,</span> <span class="n">ep93xx_dma_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">ep93xx_dma_module_init</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mika Westerberg &lt;mika.westerberg@iki.fi&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;EP93xx DMA driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
