<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › mpc512x_dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mpc512x_dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Freescale Semicondutor, Inc. 2007, 2008.</span>
<span class="cm"> * Copyright (C) Semihalf 2009</span>
<span class="cm"> * Copyright (C) Ilya Yanok, Emcraft Systems 2010</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Piotr Ziecik &lt;kosmo@semihalf.com&gt;. Hardware description</span>
<span class="cm"> * (defines, structures and comments) was taken from MPC5121 DMA driver</span>
<span class="cm"> * written by Hongjun Chen &lt;hong-jun.chen@freescale.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Approved as OSADL project by a majority of OSADL members and funded</span>
<span class="cm"> * by OSADL membership fees in 2009;  for details see www.osadl.org.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm"> * Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called COPYING.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This is initial version of MPC5121 DMA driver. Only memory to memory</span>
<span class="cm"> * transfers are supported (tested using dmatest module).</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>

<span class="cp">#include &lt;linux/random.h&gt;</span>

<span class="cp">#include &quot;dmaengine.h&quot;</span>

<span class="cm">/* Number of DMA Transfer descriptors allocated per channel */</span>
<span class="cp">#define MPC_DMA_DESCRIPTORS	64</span>

<span class="cm">/* Macro definitions */</span>
<span class="cp">#define MPC_DMA_CHANNELS	64</span>
<span class="cp">#define MPC_DMA_TCD_OFFSET	0x1000</span>

<span class="cm">/* Arbitration mode of group and channel */</span>
<span class="cp">#define MPC_DMA_DMACR_EDCG	(1 &lt;&lt; 31)</span>
<span class="cp">#define MPC_DMA_DMACR_ERGA	(1 &lt;&lt; 3)</span>
<span class="cp">#define MPC_DMA_DMACR_ERCA	(1 &lt;&lt; 2)</span>

<span class="cm">/* Error codes */</span>
<span class="cp">#define MPC_DMA_DMAES_VLD	(1 &lt;&lt; 31)</span>
<span class="cp">#define MPC_DMA_DMAES_GPE	(1 &lt;&lt; 15)</span>
<span class="cp">#define MPC_DMA_DMAES_CPE	(1 &lt;&lt; 14)</span>
<span class="cp">#define MPC_DMA_DMAES_ERRCHN(err) \</span>
<span class="cp">				(((err) &gt;&gt; 8) &amp; 0x3f)</span>
<span class="cp">#define MPC_DMA_DMAES_SAE	(1 &lt;&lt; 7)</span>
<span class="cp">#define MPC_DMA_DMAES_SOE	(1 &lt;&lt; 6)</span>
<span class="cp">#define MPC_DMA_DMAES_DAE	(1 &lt;&lt; 5)</span>
<span class="cp">#define MPC_DMA_DMAES_DOE	(1 &lt;&lt; 4)</span>
<span class="cp">#define MPC_DMA_DMAES_NCE	(1 &lt;&lt; 3)</span>
<span class="cp">#define MPC_DMA_DMAES_SGE	(1 &lt;&lt; 2)</span>
<span class="cp">#define MPC_DMA_DMAES_SBE	(1 &lt;&lt; 1)</span>
<span class="cp">#define MPC_DMA_DMAES_DBE	(1 &lt;&lt; 0)</span>

<span class="cp">#define MPC_DMA_DMAGPOR_SNOOP_ENABLE	(1 &lt;&lt; 6)</span>

<span class="cp">#define MPC_DMA_TSIZE_1		0x00</span>
<span class="cp">#define MPC_DMA_TSIZE_2		0x01</span>
<span class="cp">#define MPC_DMA_TSIZE_4		0x02</span>
<span class="cp">#define MPC_DMA_TSIZE_16	0x04</span>
<span class="cp">#define MPC_DMA_TSIZE_32	0x05</span>

<span class="cm">/* MPC5121 DMA engine registers */</span>
<span class="k">struct</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">mpc_dma_regs</span> <span class="p">{</span>
	<span class="cm">/* 0x00 */</span>
	<span class="n">u32</span> <span class="n">dmacr</span><span class="p">;</span>		<span class="cm">/* DMA control register */</span>
	<span class="n">u32</span> <span class="n">dmaes</span><span class="p">;</span>		<span class="cm">/* DMA error status */</span>
	<span class="cm">/* 0x08 */</span>
	<span class="n">u32</span> <span class="n">dmaerqh</span><span class="p">;</span>		<span class="cm">/* DMA enable request high(channels 63~32) */</span>
	<span class="n">u32</span> <span class="n">dmaerql</span><span class="p">;</span>		<span class="cm">/* DMA enable request low(channels 31~0) */</span>
	<span class="n">u32</span> <span class="n">dmaeeih</span><span class="p">;</span>		<span class="cm">/* DMA enable error interrupt high(ch63~32) */</span>
	<span class="n">u32</span> <span class="n">dmaeeil</span><span class="p">;</span>		<span class="cm">/* DMA enable error interrupt low(ch31~0) */</span>
	<span class="cm">/* 0x18 */</span>
	<span class="n">u8</span> <span class="n">dmaserq</span><span class="p">;</span>		<span class="cm">/* DMA set enable request */</span>
	<span class="n">u8</span> <span class="n">dmacerq</span><span class="p">;</span>		<span class="cm">/* DMA clear enable request */</span>
	<span class="n">u8</span> <span class="n">dmaseei</span><span class="p">;</span>		<span class="cm">/* DMA set enable error interrupt */</span>
	<span class="n">u8</span> <span class="n">dmaceei</span><span class="p">;</span>		<span class="cm">/* DMA clear enable error interrupt */</span>
	<span class="cm">/* 0x1c */</span>
	<span class="n">u8</span> <span class="n">dmacint</span><span class="p">;</span>		<span class="cm">/* DMA clear interrupt request */</span>
	<span class="n">u8</span> <span class="n">dmacerr</span><span class="p">;</span>		<span class="cm">/* DMA clear error */</span>
	<span class="n">u8</span> <span class="n">dmassrt</span><span class="p">;</span>		<span class="cm">/* DMA set start bit */</span>
	<span class="n">u8</span> <span class="n">dmacdne</span><span class="p">;</span>		<span class="cm">/* DMA clear DONE status bit */</span>
	<span class="cm">/* 0x20 */</span>
	<span class="n">u32</span> <span class="n">dmainth</span><span class="p">;</span>		<span class="cm">/* DMA interrupt request high(ch63~32) */</span>
	<span class="n">u32</span> <span class="n">dmaintl</span><span class="p">;</span>		<span class="cm">/* DMA interrupt request low(ch31~0) */</span>
	<span class="n">u32</span> <span class="n">dmaerrh</span><span class="p">;</span>		<span class="cm">/* DMA error high(ch63~32) */</span>
	<span class="n">u32</span> <span class="n">dmaerrl</span><span class="p">;</span>		<span class="cm">/* DMA error low(ch31~0) */</span>
	<span class="cm">/* 0x30 */</span>
	<span class="n">u32</span> <span class="n">dmahrsh</span><span class="p">;</span>		<span class="cm">/* DMA hw request status high(ch63~32) */</span>
	<span class="n">u32</span> <span class="n">dmahrsl</span><span class="p">;</span>		<span class="cm">/* DMA hardware request status low(ch31~0) */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">dmaihsa</span><span class="p">;</span>	<span class="cm">/* DMA interrupt high select AXE(ch63~32) */</span>
		<span class="n">u32</span> <span class="n">dmagpor</span><span class="p">;</span>	<span class="cm">/* (General purpose register on MPC8308) */</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">dmailsa</span><span class="p">;</span>		<span class="cm">/* DMA interrupt low select AXE(ch31~0) */</span>
	<span class="cm">/* 0x40 ~ 0xff */</span>
	<span class="n">u32</span> <span class="n">reserve0</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>	<span class="cm">/* Reserved */</span>
	<span class="cm">/* 0x100 */</span>
	<span class="n">u8</span> <span class="n">dchpri</span><span class="p">[</span><span class="n">MPC_DMA_CHANNELS</span><span class="p">];</span>
	<span class="cm">/* DMA channels(0~63) priority */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">mpc_dma_tcd</span> <span class="p">{</span>
	<span class="cm">/* 0x00 */</span>
	<span class="n">u32</span> <span class="n">saddr</span><span class="p">;</span>		<span class="cm">/* Source address */</span>

	<span class="n">u32</span> <span class="n">smod</span><span class="o">:</span><span class="mi">5</span><span class="p">;</span>		<span class="cm">/* Source address modulo */</span>
	<span class="n">u32</span> <span class="n">ssize</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>		<span class="cm">/* Source data transfer size */</span>
	<span class="n">u32</span> <span class="n">dmod</span><span class="o">:</span><span class="mi">5</span><span class="p">;</span>		<span class="cm">/* Destination address modulo */</span>
	<span class="n">u32</span> <span class="n">dsize</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>		<span class="cm">/* Destination data transfer size */</span>
	<span class="n">u32</span> <span class="n">soff</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>		<span class="cm">/* Signed source address offset */</span>

	<span class="cm">/* 0x08 */</span>
	<span class="n">u32</span> <span class="n">nbytes</span><span class="p">;</span>		<span class="cm">/* Inner &quot;minor&quot; byte count */</span>
	<span class="n">u32</span> <span class="n">slast</span><span class="p">;</span>		<span class="cm">/* Last source address adjustment */</span>
	<span class="n">u32</span> <span class="n">daddr</span><span class="p">;</span>		<span class="cm">/* Destination address */</span>

	<span class="cm">/* 0x14 */</span>
	<span class="n">u32</span> <span class="n">citer_elink</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Enable channel-to-channel linking on</span>
<span class="cm">				 * minor loop complete</span>
<span class="cm">				 */</span>
	<span class="n">u32</span> <span class="n">citer_linkch</span><span class="o">:</span><span class="mi">6</span><span class="p">;</span>	<span class="cm">/* Link channel for minor loop complete */</span>
	<span class="n">u32</span> <span class="n">citer</span><span class="o">:</span><span class="mi">9</span><span class="p">;</span>		<span class="cm">/* Current &quot;major&quot; iteration count */</span>
	<span class="n">u32</span> <span class="n">doff</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>		<span class="cm">/* Signed destination address offset */</span>

	<span class="cm">/* 0x18 */</span>
	<span class="n">u32</span> <span class="n">dlast_sga</span><span class="p">;</span>		<span class="cm">/* Last Destination address adjustment/scatter</span>
<span class="cm">				 * gather address</span>
<span class="cm">				 */</span>

	<span class="cm">/* 0x1c */</span>
	<span class="n">u32</span> <span class="n">biter_elink</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Enable channel-to-channel linking on major</span>
<span class="cm">				 * loop complete</span>
<span class="cm">				 */</span>
	<span class="n">u32</span> <span class="n">biter_linkch</span><span class="o">:</span><span class="mi">6</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">biter</span><span class="o">:</span><span class="mi">9</span><span class="p">;</span>		<span class="cm">/* Beginning &quot;major&quot; iteration count */</span>
	<span class="n">u32</span> <span class="n">bwc</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>		<span class="cm">/* Bandwidth control */</span>
	<span class="n">u32</span> <span class="n">major_linkch</span><span class="o">:</span><span class="mi">6</span><span class="p">;</span>	<span class="cm">/* Link channel number */</span>
	<span class="n">u32</span> <span class="n">done</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Channel done */</span>
	<span class="n">u32</span> <span class="n">active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Channel active */</span>
	<span class="n">u32</span> <span class="n">major_elink</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Enable channel-to-channel linking on major</span>
<span class="cm">				 * loop complete</span>
<span class="cm">				 */</span>
	<span class="n">u32</span> <span class="n">e_sg</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Enable scatter/gather processing */</span>
	<span class="n">u32</span> <span class="n">d_req</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Disable request */</span>
	<span class="n">u32</span> <span class="n">int_half</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Enable an interrupt when major counter is</span>
<span class="cm">				 * half complete</span>
<span class="cm">				 */</span>
	<span class="n">u32</span> <span class="n">int_maj</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Enable an interrupt when major iteration</span>
<span class="cm">				 * count completes</span>
<span class="cm">				 */</span>
	<span class="n">u32</span> <span class="n">start</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Channel start */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_tcd</span>		<span class="o">*</span><span class="n">tcd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">tcd_paddr</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">node</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">free</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">prepared</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">queued</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">completed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_tcd</span>		<span class="o">*</span><span class="n">tcd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">tcd_paddr</span><span class="p">;</span>

	<span class="cm">/* Lock for this structure */</span>
	<span class="n">spinlock_t</span>			<span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span>		<span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>		<span class="n">tasklet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span>		<span class="n">channels</span><span class="p">[</span><span class="n">MPC_DMA_CHANNELS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mpc_dma_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_tcd</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">tcd</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">irq2</span><span class="p">;</span>
	<span class="n">uint</span>				<span class="n">error_status</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">is_mpc8308</span><span class="p">;</span>

	<span class="cm">/* Lock for error_status field in this structure */</span>
	<span class="n">spinlock_t</span>			<span class="n">error_status_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DRV_NAME	&quot;mpc512x_dma&quot;</span>

<span class="cm">/* Convert struct dma_chan to struct mpc_dma_chan */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="nf">dma_chan_to_mpc_dma_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc_dma_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Convert struct dma_chan to struct mpc_dma */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="nf">dma_chan_to_mpc_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma_chan</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mchan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc_dma</span><span class="p">,</span> <span class="n">channels</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">chan_id</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Execute all queued DMA descriptors.</span>
<span class="cm"> *</span>
<span class="cm"> * Following requirements must be met while calling mpc_dma_execute():</span>
<span class="cm"> * 	a) mchan-&gt;lock is acquired,</span>
<span class="cm"> * 	b) mchan-&gt;active list is empty,</span>
<span class="cm"> * 	c) mchan-&gt;queued list contains at least one entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_dma_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">mchan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">chan_id</span><span class="p">;</span>

	<span class="cm">/* Move all queued descriptors to active list */</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="cm">/* Chain descriptors into one transaction */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">mdesc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">mdesc</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="o">-&gt;</span><span class="n">dlast_sga</span> <span class="o">=</span> <span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">tcd_paddr</span><span class="p">;</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="o">-&gt;</span><span class="n">e_sg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">prev</span> <span class="o">=</span> <span class="n">mdesc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prev</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="o">-&gt;</span><span class="n">int_maj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Send first descriptor in chain into hardware */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="p">[</span><span class="n">cid</span><span class="p">],</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_tcd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="n">prev</span><span class="p">)</span>
		<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">e_sg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmassrt</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Handle interrupt on one half of DMA controller (32 channels) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_dma_irq_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span><span class="p">,</span> <span class="n">u32</span> <span class="n">is</span><span class="p">,</span> <span class="n">u32</span> <span class="n">es</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">is</span> <span class="o">|</span> <span class="n">es</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">);</span>
		<span class="n">mchan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span> <span class="o">+</span> <span class="n">off</span><span class="p">];</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmacint</span><span class="p">,</span> <span class="n">ch</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmacerr</span><span class="p">,</span> <span class="n">ch</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>

		<span class="cm">/* Check error status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">))</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
				<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="cm">/* Execute queued descriptors */</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">))</span>
			<span class="n">mpc_dma_execute</span><span class="p">(</span><span class="n">mchan</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mpc_dma_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">es</span><span class="p">;</span>

	<span class="cm">/* Save error status register */</span>
	<span class="n">es</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaes</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_VLD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status</span> <span class="o">=</span> <span class="n">es</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status_lock</span><span class="p">);</span>

	<span class="cm">/* Handle interrupt on each channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chancnt</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpc_dma_irq_process</span><span class="p">(</span><span class="n">mdma</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmainth</span><span class="p">),</span>
					<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaerrh</span><span class="p">),</span> <span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mpc_dma_irq_process</span><span class="p">(</span><span class="n">mdma</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaintl</span><span class="p">),</span>
					<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaerrl</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Schedule tasklet */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* process completed descriptors */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_dma_process_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cookie_t</span> <span class="n">last_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chancnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mchan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Get all completed descriptors */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">))</span>
			<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Execute callbacks and run dependencies */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span><span class="p">);</span>

			<span class="n">last_cookie</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
			<span class="n">dma_run_dependencies</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Free descriptors */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
		<span class="n">mchan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">completed_cookie</span> <span class="o">=</span> <span class="n">last_cookie</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* DMA Tasklet */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_dma_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">es</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">es</span> <span class="o">=</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status</span><span class="p">;</span>
	<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Print nice error report */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Hardware reported following error(s) on channel %u:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						      <span class="n">MPC_DMA_DMAES_ERRCHN</span><span class="p">(</span><span class="n">es</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_GPE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Group Priority Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_CPE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Channel Priority Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_SAE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Source Address Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_SOE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Source Offset&quot;</span>
						<span class="s">&quot; Configuration Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_DAE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Destination Address&quot;</span>
								<span class="s">&quot; Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_DOE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Destination Offset&quot;</span>
						<span class="s">&quot; Configuration Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_NCE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- NBytes/Citter&quot;</span>
						<span class="s">&quot; Configuration Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_SGE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Scatter/Gather&quot;</span>
						<span class="s">&quot; Configuration Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_SBE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Source Bus Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;</span> <span class="n">MPC_DMA_DMAES_DBE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;- Destination Bus Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpc_dma_process_completed</span><span class="p">(</span><span class="n">mdma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Submit descriptor to hardware */</span>
<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">mpc_dma_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma_chan</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">mdesc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">txd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc_dma_desc</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Move descriptor to queue */</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">);</span>

	<span class="cm">/* If channel is idle, execute all queued descriptors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
		<span class="n">mpc_dma_execute</span><span class="p">(</span><span class="n">mchan</span><span class="p">);</span>

	<span class="cm">/* Update cookie */</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Alloc channel resources */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc_dma_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_tcd</span> <span class="o">*</span><span class="n">tcd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tcd_paddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">descs</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Alloc DMA memory for Transfer Control Descriptors */</span>
	<span class="n">tcd</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">MPC_DMA_DESCRIPTORS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_tcd</span><span class="p">),</span>
							<span class="o">&amp;</span><span class="n">tcd_paddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Alloc descriptors for this channel */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MPC_DMA_DESCRIPTORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdesc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdesc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory allocation error. &quot;</span>
					<span class="s">&quot;Allocated only %u descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_CTRL_ACK</span><span class="p">;</span>
		<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">mpc_dma_tx_submit</span><span class="p">;</span>

		<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">tcd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tcd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">tcd_paddr</span> <span class="o">=</span> <span class="n">tcd_paddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_tcd</span><span class="p">));</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">descs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Return error only if no descriptors were allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">MPC_DMA_DESCRIPTORS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_tcd</span><span class="p">),</span>
								<span class="n">tcd</span><span class="p">,</span> <span class="n">tcd_paddr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mchan</span><span class="o">-&gt;</span><span class="n">tcd</span> <span class="o">=</span> <span class="n">tcd</span><span class="p">;</span>
	<span class="n">mchan</span><span class="o">-&gt;</span><span class="n">tcd_paddr</span> <span class="o">=</span> <span class="n">tcd_paddr</span><span class="p">;</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Enable Error Interrupt */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaseei</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Free channel resources */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_dma_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_tcd</span> <span class="o">*</span><span class="n">tcd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tcd_paddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">descs</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Channel must be idle */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">prepared</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">));</span>

	<span class="cm">/* Move data */</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">descs</span><span class="p">);</span>
	<span class="n">tcd</span> <span class="o">=</span> <span class="n">mchan</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="p">;</span>
	<span class="n">tcd_paddr</span> <span class="o">=</span> <span class="n">mchan</span><span class="o">-&gt;</span><span class="n">tcd_paddr</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Free DMA memory used by descriptors */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">MPC_DMA_DESCRIPTORS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_tcd</span><span class="p">),</span>
								<span class="n">tcd</span><span class="p">,</span> <span class="n">tcd_paddr</span><span class="p">);</span>

	<span class="cm">/* Free descriptors */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mdesc</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">descs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mdesc</span><span class="p">);</span>

	<span class="cm">/* Disable Error Interrupt */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaceei</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send all pending descriptor to hardware */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc_dma_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We are posting descriptors to the hardware as soon as</span>
<span class="cm">	 * they are ready, so this function does nothing.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/* Check request completion status */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span>
<span class="nf">mpc_dma_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_status</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Prepare descriptor for memory to memory copy */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">mpc_dma_prep_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span> <span class="o">=</span> <span class="n">dma_chan_to_mpc_dma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc_dma_desc</span> <span class="o">*</span><span class="n">mdesc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_tcd</span> <span class="o">*</span><span class="n">tcd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>

	<span class="cm">/* Get free descriptor */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mdesc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc_dma_desc</span><span class="p">,</span>
									<span class="n">node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdesc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* try to free completed descriptors */</span>
		<span class="n">mpc_dma_process_completed</span><span class="p">(</span><span class="n">mdma</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tcd</span> <span class="o">=</span> <span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">tcd</span><span class="p">;</span>

	<span class="cm">/* Prepare Transfer Control Descriptor for this transaction */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tcd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_tcd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">src</span> <span class="o">|</span> <span class="n">dst</span> <span class="o">|</span> <span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_32</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_32</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">soff</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">is_mpc8308</span> <span class="o">&amp;&amp;</span> <span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">src</span> <span class="o">|</span> <span class="n">dst</span> <span class="o">|</span> <span class="n">len</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* MPC8308 doesn&#39;t support 16 byte transfers */</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_16</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_16</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">soff</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">src</span> <span class="o">|</span> <span class="n">dst</span> <span class="o">|</span> <span class="n">len</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_4</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_4</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">soff</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">src</span> <span class="o">|</span> <span class="n">dst</span> <span class="o">|</span> <span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_2</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_2</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">soff</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_1</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">MPC_DMA_TSIZE_1</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">soff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">biter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tcd</span><span class="o">-&gt;</span><span class="n">citer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Place descriptor in prepared list */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">prepared</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mpc_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma_chan</span> <span class="o">*</span><span class="n">mchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">regs_start</span><span class="p">,</span> <span class="n">regs_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mdma</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory exhausted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error mapping IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;fsl,mpc8308-dma&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">is_mpc8308</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq2</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq2</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error mapping IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error parsing memory region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regs_start</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">regs_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">regs_start</span><span class="p">,</span> <span class="n">regs_size</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error requesting memory region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">regs_start</span><span class="p">,</span> <span class="n">regs_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error mapping memory region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdma</span><span class="o">-&gt;</span><span class="n">tcd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpc_dma_tcd</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
							<span class="o">+</span> <span class="n">MPC_DMA_TCD_OFFSET</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpc_dma_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span>
									<span class="n">mdma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error requesting IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">is_mpc8308</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpc_dma_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">mdma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error requesting IRQ2!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">error_status_lock</span><span class="p">);</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">is_mpc8308</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span> <span class="o">=</span> <span class="n">MPC_DMA_CHANNELS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* MPC8308 DMA has only 16 channels */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">mpc_dma_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">mpc_dma_free_chan_resources</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">mpc_dma_issue_pending</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">mpc_dma_tx_status</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">mpc_dma_prep_memcpy</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mchan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">mchan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
		<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">prepared</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">);</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">mpc_dma_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mdma</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure DMA Engine:</span>
<span class="cm">	 * - Dynamic clock,</span>
<span class="cm">	 * - Round-robin group arbitration,</span>
<span class="cm">	 * - Round-robin channel arbitration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">is_mpc8308</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmacr</span><span class="p">,</span> <span class="n">MPC_DMA_DMACR_EDCG</span> <span class="o">|</span>
					<span class="n">MPC_DMA_DMACR_ERGA</span> <span class="o">|</span> <span class="n">MPC_DMA_DMACR_ERCA</span><span class="p">);</span>

		<span class="cm">/* Disable hardware DMA requests */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaerqh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaerql</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Disable error interrupts */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaeeih</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaeeil</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Clear interrupts status */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmainth</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaintl</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaerrh</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaerrl</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

		<span class="cm">/* Route interrupts to IPIC */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaihsa</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmailsa</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MPC8308 has 16 channels and lacks some registers */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmacr</span><span class="p">,</span> <span class="n">MPC_DMA_DMACR_ERCA</span><span class="p">);</span>

		<span class="cm">/* enable snooping */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmagpor</span><span class="p">,</span> <span class="n">MPC_DMA_DMAGPOR_SNOOP_ENABLE</span><span class="p">);</span>
		<span class="cm">/* Disable error interrupts */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaeeil</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Clear interrupts status */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaintl</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmaerrl</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register DMA engine */</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mdma</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devm_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mdma</span><span class="p">);</span>
		<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">mpc_dma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_dma</span> <span class="o">*</span><span class="n">mdma</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">devm_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mdma</span><span class="p">);</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">mdma</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc_dma_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5121-dma&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mpc_dma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mpc_dma_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mpc_dma_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span>	<span class="o">=</span> <span class="n">mpc_dma_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">mpc_dma_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Piotr Ziecik &lt;kosmo@semihalf.com&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
