<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › pl330.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pl330.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2012 Samsung Electronics Co., Ltd.</span>
<span class="cm"> *		http://www.samsung.com</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Samsung Electronics Co. Ltd.</span>
<span class="cm"> *	Jaswinder Singh &lt;jassi.brar@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/amba/bus.h&gt;</span>
<span class="cp">#include &lt;linux/amba/pl330.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>

<span class="cp">#include &quot;dmaengine.h&quot;</span>
<span class="cp">#define PL330_MAX_CHAN		8</span>
<span class="cp">#define PL330_MAX_IRQS		32</span>
<span class="cp">#define PL330_MAX_PERI		32</span>

<span class="k">enum</span> <span class="n">pl330_srccachectrl</span> <span class="p">{</span>
	<span class="n">SCCTRL0</span><span class="p">,</span>	<span class="cm">/* Noncacheable and nonbufferable */</span>
	<span class="n">SCCTRL1</span><span class="p">,</span>	<span class="cm">/* Bufferable only */</span>
	<span class="n">SCCTRL2</span><span class="p">,</span>	<span class="cm">/* Cacheable, but do not allocate */</span>
	<span class="n">SCCTRL3</span><span class="p">,</span>	<span class="cm">/* Cacheable and bufferable, but do not allocate */</span>
	<span class="n">SINVALID1</span><span class="p">,</span>
	<span class="n">SINVALID2</span><span class="p">,</span>
	<span class="n">SCCTRL6</span><span class="p">,</span>	<span class="cm">/* Cacheable write-through, allocate on reads only */</span>
	<span class="n">SCCTRL7</span><span class="p">,</span>	<span class="cm">/* Cacheable write-back, allocate on reads only */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pl330_dstcachectrl</span> <span class="p">{</span>
	<span class="n">DCCTRL0</span><span class="p">,</span>	<span class="cm">/* Noncacheable and nonbufferable */</span>
	<span class="n">DCCTRL1</span><span class="p">,</span>	<span class="cm">/* Bufferable only */</span>
	<span class="n">DCCTRL2</span><span class="p">,</span>	<span class="cm">/* Cacheable, but do not allocate */</span>
	<span class="n">DCCTRL3</span><span class="p">,</span>	<span class="cm">/* Cacheable and bufferable, but do not allocate */</span>
	<span class="n">DINVALID1</span><span class="p">,</span>	<span class="cm">/* AWCACHE = 0x1000 */</span>
	<span class="n">DINVALID2</span><span class="p">,</span>
	<span class="n">DCCTRL6</span><span class="p">,</span>	<span class="cm">/* Cacheable write-through, allocate on writes only */</span>
	<span class="n">DCCTRL7</span><span class="p">,</span>	<span class="cm">/* Cacheable write-back, allocate on writes only */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pl330_byteswap</span> <span class="p">{</span>
	<span class="n">SWAP_NO</span><span class="p">,</span>
	<span class="n">SWAP_2</span><span class="p">,</span>
	<span class="n">SWAP_4</span><span class="p">,</span>
	<span class="n">SWAP_8</span><span class="p">,</span>
	<span class="n">SWAP_16</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pl330_reqtype</span> <span class="p">{</span>
	<span class="n">MEMTOMEM</span><span class="p">,</span>
	<span class="n">MEMTODEV</span><span class="p">,</span>
	<span class="n">DEVTOMEM</span><span class="p">,</span>
	<span class="n">DEVTODEV</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Register and Bit field Definitions */</span>
<span class="cp">#define DS			0x0</span>
<span class="cp">#define DS_ST_STOP		0x0</span>
<span class="cp">#define DS_ST_EXEC		0x1</span>
<span class="cp">#define DS_ST_CMISS		0x2</span>
<span class="cp">#define DS_ST_UPDTPC		0x3</span>
<span class="cp">#define DS_ST_WFE		0x4</span>
<span class="cp">#define DS_ST_ATBRR		0x5</span>
<span class="cp">#define DS_ST_QBUSY		0x6</span>
<span class="cp">#define DS_ST_WFP		0x7</span>
<span class="cp">#define DS_ST_KILL		0x8</span>
<span class="cp">#define DS_ST_CMPLT		0x9</span>
<span class="cp">#define DS_ST_FLTCMP		0xe</span>
<span class="cp">#define DS_ST_FAULT		0xf</span>

<span class="cp">#define DPC			0x4</span>
<span class="cp">#define INTEN			0x20</span>
<span class="cp">#define ES			0x24</span>
<span class="cp">#define INTSTATUS		0x28</span>
<span class="cp">#define INTCLR			0x2c</span>
<span class="cp">#define FSM			0x30</span>
<span class="cp">#define FSC			0x34</span>
<span class="cp">#define FTM			0x38</span>

<span class="cp">#define _FTC			0x40</span>
<span class="cp">#define FTC(n)			(_FTC + (n)*0x4)</span>

<span class="cp">#define _CS			0x100</span>
<span class="cp">#define CS(n)			(_CS + (n)*0x8)</span>
<span class="cp">#define CS_CNS			(1 &lt;&lt; 21)</span>

<span class="cp">#define _CPC			0x104</span>
<span class="cp">#define CPC(n)			(_CPC + (n)*0x8)</span>

<span class="cp">#define _SA			0x400</span>
<span class="cp">#define SA(n)			(_SA + (n)*0x20)</span>

<span class="cp">#define _DA			0x404</span>
<span class="cp">#define DA(n)			(_DA + (n)*0x20)</span>

<span class="cp">#define _CC			0x408</span>
<span class="cp">#define CC(n)			(_CC + (n)*0x20)</span>

<span class="cp">#define CC_SRCINC		(1 &lt;&lt; 0)</span>
<span class="cp">#define CC_DSTINC		(1 &lt;&lt; 14)</span>
<span class="cp">#define CC_SRCPRI		(1 &lt;&lt; 8)</span>
<span class="cp">#define CC_DSTPRI		(1 &lt;&lt; 22)</span>
<span class="cp">#define CC_SRCNS		(1 &lt;&lt; 9)</span>
<span class="cp">#define CC_DSTNS		(1 &lt;&lt; 23)</span>
<span class="cp">#define CC_SRCIA		(1 &lt;&lt; 10)</span>
<span class="cp">#define CC_DSTIA		(1 &lt;&lt; 24)</span>
<span class="cp">#define CC_SRCBRSTLEN_SHFT	4</span>
<span class="cp">#define CC_DSTBRSTLEN_SHFT	18</span>
<span class="cp">#define CC_SRCBRSTSIZE_SHFT	1</span>
<span class="cp">#define CC_DSTBRSTSIZE_SHFT	15</span>
<span class="cp">#define CC_SRCCCTRL_SHFT	11</span>
<span class="cp">#define CC_SRCCCTRL_MASK	0x7</span>
<span class="cp">#define CC_DSTCCTRL_SHFT	25</span>
<span class="cp">#define CC_DRCCCTRL_MASK	0x7</span>
<span class="cp">#define CC_SWAP_SHFT		28</span>

<span class="cp">#define _LC0			0x40c</span>
<span class="cp">#define LC0(n)			(_LC0 + (n)*0x20)</span>

<span class="cp">#define _LC1			0x410</span>
<span class="cp">#define LC1(n)			(_LC1 + (n)*0x20)</span>

<span class="cp">#define DBGSTATUS		0xd00</span>
<span class="cp">#define DBG_BUSY		(1 &lt;&lt; 0)</span>

<span class="cp">#define DBGCMD			0xd04</span>
<span class="cp">#define DBGINST0		0xd08</span>
<span class="cp">#define DBGINST1		0xd0c</span>

<span class="cp">#define CR0			0xe00</span>
<span class="cp">#define CR1			0xe04</span>
<span class="cp">#define CR2			0xe08</span>
<span class="cp">#define CR3			0xe0c</span>
<span class="cp">#define CR4			0xe10</span>
<span class="cp">#define CRD			0xe14</span>

<span class="cp">#define PERIPH_ID		0xfe0</span>
<span class="cp">#define PERIPH_REV_SHIFT	20</span>
<span class="cp">#define PERIPH_REV_MASK		0xf</span>
<span class="cp">#define PERIPH_REV_R0P0		0</span>
<span class="cp">#define PERIPH_REV_R1P0		1</span>
<span class="cp">#define PERIPH_REV_R1P1		2</span>
<span class="cp">#define PCELL_ID		0xff0</span>

<span class="cp">#define CR0_PERIPH_REQ_SET	(1 &lt;&lt; 0)</span>
<span class="cp">#define CR0_BOOT_EN_SET		(1 &lt;&lt; 1)</span>
<span class="cp">#define CR0_BOOT_MAN_NS		(1 &lt;&lt; 2)</span>
<span class="cp">#define CR0_NUM_CHANS_SHIFT	4</span>
<span class="cp">#define CR0_NUM_CHANS_MASK	0x7</span>
<span class="cp">#define CR0_NUM_PERIPH_SHIFT	12</span>
<span class="cp">#define CR0_NUM_PERIPH_MASK	0x1f</span>
<span class="cp">#define CR0_NUM_EVENTS_SHIFT	17</span>
<span class="cp">#define CR0_NUM_EVENTS_MASK	0x1f</span>

<span class="cp">#define CR1_ICACHE_LEN_SHIFT	0</span>
<span class="cp">#define CR1_ICACHE_LEN_MASK	0x7</span>
<span class="cp">#define CR1_NUM_ICACHELINES_SHIFT	4</span>
<span class="cp">#define CR1_NUM_ICACHELINES_MASK	0xf</span>

<span class="cp">#define CRD_DATA_WIDTH_SHIFT	0</span>
<span class="cp">#define CRD_DATA_WIDTH_MASK	0x7</span>
<span class="cp">#define CRD_WR_CAP_SHIFT	4</span>
<span class="cp">#define CRD_WR_CAP_MASK		0x7</span>
<span class="cp">#define CRD_WR_Q_DEP_SHIFT	8</span>
<span class="cp">#define CRD_WR_Q_DEP_MASK	0xf</span>
<span class="cp">#define CRD_RD_CAP_SHIFT	12</span>
<span class="cp">#define CRD_RD_CAP_MASK		0x7</span>
<span class="cp">#define CRD_RD_Q_DEP_SHIFT	16</span>
<span class="cp">#define CRD_RD_Q_DEP_MASK	0xf</span>
<span class="cp">#define CRD_DATA_BUFF_SHIFT	20</span>
<span class="cp">#define CRD_DATA_BUFF_MASK	0x3ff</span>

<span class="cp">#define PART			0x330</span>
<span class="cp">#define DESIGNER		0x41</span>
<span class="cp">#define REVISION		0x0</span>
<span class="cp">#define INTEG_CFG		0x0</span>
<span class="cp">#define PERIPH_ID_VAL		((PART &lt;&lt; 0) | (DESIGNER &lt;&lt; 12))</span>

<span class="cp">#define PCELL_ID_VAL		0xb105f00d</span>

<span class="cp">#define PL330_STATE_STOPPED		(1 &lt;&lt; 0)</span>
<span class="cp">#define PL330_STATE_EXECUTING		(1 &lt;&lt; 1)</span>
<span class="cp">#define PL330_STATE_WFE			(1 &lt;&lt; 2)</span>
<span class="cp">#define PL330_STATE_FAULTING		(1 &lt;&lt; 3)</span>
<span class="cp">#define PL330_STATE_COMPLETING		(1 &lt;&lt; 4)</span>
<span class="cp">#define PL330_STATE_WFP			(1 &lt;&lt; 5)</span>
<span class="cp">#define PL330_STATE_KILLING		(1 &lt;&lt; 6)</span>
<span class="cp">#define PL330_STATE_FAULT_COMPLETING	(1 &lt;&lt; 7)</span>
<span class="cp">#define PL330_STATE_CACHEMISS		(1 &lt;&lt; 8)</span>
<span class="cp">#define PL330_STATE_UPDTPC		(1 &lt;&lt; 9)</span>
<span class="cp">#define PL330_STATE_ATBARRIER		(1 &lt;&lt; 10)</span>
<span class="cp">#define PL330_STATE_QUEUEBUSY		(1 &lt;&lt; 11)</span>
<span class="cp">#define PL330_STATE_INVALID		(1 &lt;&lt; 15)</span>

<span class="cp">#define PL330_STABLE_STATES (PL330_STATE_STOPPED | PL330_STATE_EXECUTING \</span>
<span class="cp">				| PL330_STATE_WFE | PL330_STATE_FAULTING)</span>

<span class="cp">#define CMD_DMAADDH		0x54</span>
<span class="cp">#define CMD_DMAEND		0x00</span>
<span class="cp">#define CMD_DMAFLUSHP		0x35</span>
<span class="cp">#define CMD_DMAGO		0xa0</span>
<span class="cp">#define CMD_DMALD		0x04</span>
<span class="cp">#define CMD_DMALDP		0x25</span>
<span class="cp">#define CMD_DMALP		0x20</span>
<span class="cp">#define CMD_DMALPEND		0x28</span>
<span class="cp">#define CMD_DMAKILL		0x01</span>
<span class="cp">#define CMD_DMAMOV		0xbc</span>
<span class="cp">#define CMD_DMANOP		0x18</span>
<span class="cp">#define CMD_DMARMB		0x12</span>
<span class="cp">#define CMD_DMASEV		0x34</span>
<span class="cp">#define CMD_DMAST		0x08</span>
<span class="cp">#define CMD_DMASTP		0x29</span>
<span class="cp">#define CMD_DMASTZ		0x0c</span>
<span class="cp">#define CMD_DMAWFE		0x36</span>
<span class="cp">#define CMD_DMAWFP		0x30</span>
<span class="cp">#define CMD_DMAWMB		0x13</span>

<span class="cp">#define SZ_DMAADDH		3</span>
<span class="cp">#define SZ_DMAEND		1</span>
<span class="cp">#define SZ_DMAFLUSHP		2</span>
<span class="cp">#define SZ_DMALD		1</span>
<span class="cp">#define SZ_DMALDP		2</span>
<span class="cp">#define SZ_DMALP		2</span>
<span class="cp">#define SZ_DMALPEND		2</span>
<span class="cp">#define SZ_DMAKILL		1</span>
<span class="cp">#define SZ_DMAMOV		6</span>
<span class="cp">#define SZ_DMANOP		1</span>
<span class="cp">#define SZ_DMARMB		1</span>
<span class="cp">#define SZ_DMASEV		2</span>
<span class="cp">#define SZ_DMAST		1</span>
<span class="cp">#define SZ_DMASTP		2</span>
<span class="cp">#define SZ_DMASTZ		1</span>
<span class="cp">#define SZ_DMAWFE		2</span>
<span class="cp">#define SZ_DMAWFP		2</span>
<span class="cp">#define SZ_DMAWMB		1</span>
<span class="cp">#define SZ_DMAGO		6</span>

<span class="cp">#define BRST_LEN(ccr)		((((ccr) &gt;&gt; CC_SRCBRSTLEN_SHFT) &amp; 0xf) + 1)</span>
<span class="cp">#define BRST_SIZE(ccr)		(1 &lt;&lt; (((ccr) &gt;&gt; CC_SRCBRSTSIZE_SHFT) &amp; 0x7))</span>

<span class="cp">#define BYTE_TO_BURST(b, ccr)	((b) / BRST_SIZE(ccr) / BRST_LEN(ccr))</span>
<span class="cp">#define BURST_TO_BYTE(c, ccr)	((c) * BRST_SIZE(ccr) * BRST_LEN(ccr))</span>

<span class="cm">/*</span>
<span class="cm"> * With 256 bytes, we can do more than 2.5MB and 5MB xfers per req</span>
<span class="cm"> * at 1byte/burst for P&lt;-&gt;M and M&lt;-&gt;M respectively.</span>
<span class="cm"> * For typical scenario, at 1word/burst, 10MB and 20MB xfers per req</span>
<span class="cm"> * should be enough for P&lt;-&gt;M and M&lt;-&gt;M respectively.</span>
<span class="cm"> */</span>
<span class="cp">#define MCODE_BUFF_PER_REQ	256</span>

<span class="cm">/* If the _pl330_req is available to the client */</span>
<span class="cp">#define IS_FREE(req)	(*((u8 *)((req)-&gt;mc_cpu)) == CMD_DMAEND)</span>

<span class="cm">/* Use this _only_ to wait on transient states */</span>
<span class="cp">#define UNTIL(t, s)	while (!(_state(t) &amp; (s))) cpu_relax();</span>

<span class="cp">#ifdef PL330_DEBUG_MCGEN</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">cmd_line</span><span class="p">;</span>
<span class="cp">#define PL330_DBGCMD_DUMP(off, x...)	do { \</span>
<span class="cp">						printk(&quot;%x:&quot;, cmd_line); \</span>
<span class="cp">						printk(x); \</span>
<span class="cp">						cmd_line += off; \</span>
<span class="cp">					} while (0)</span>
<span class="cp">#define PL330_DBGMC_START(addr)		(cmd_line = addr)</span>
<span class="cp">#else</span>
<span class="cp">#define PL330_DBGCMD_DUMP(off, x...)	do {} while (0)</span>
<span class="cp">#define PL330_DBGMC_START(addr)		do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* The number of default descriptors */</span>

<span class="cp">#define NR_DEFAULT_DESC	16</span>

<span class="cm">/* Populated by the PL330 core driver for DMA API driver&#39;s info */</span>
<span class="k">struct</span> <span class="n">pl330_config</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">periph_id</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pcell_id</span><span class="p">;</span>
<span class="cp">#define DMAC_MODE_NS	(1 &lt;&lt; 0)</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">data_bus_width</span><span class="o">:</span><span class="mi">10</span><span class="p">;</span> <span class="cm">/* In number of bits */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">data_buf_dep</span><span class="o">:</span><span class="mi">10</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">num_chan</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">num_peri</span><span class="o">:</span><span class="mi">6</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">peri_ns</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">num_events</span><span class="o">:</span><span class="mi">6</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">irq_ns</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Handle to the DMAC provided to the PL330 core */</span>
<span class="k">struct</span> <span class="n">pl330_info</span> <span class="p">{</span>
	<span class="cm">/* Owning device */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* Size of MicroCode buffers for each channel. */</span>
	<span class="kt">unsigned</span> <span class="n">mcbufsz</span><span class="p">;</span>
	<span class="cm">/* ioremap&#39;ed address of PL330 registers. */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="cm">/* Client can freely use it. */</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">client_data</span><span class="p">;</span>
	<span class="cm">/* PL330 core data, Client must not touch it. */</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">pl330_data</span><span class="p">;</span>
	<span class="cm">/* Populated by the PL330 core driver during pl330_add */</span>
	<span class="k">struct</span> <span class="n">pl330_config</span>	<span class="n">pcfg</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the DMAC has some reset mechanism, then the</span>
<span class="cm">	 * client may want to provide pointer to the method.</span>
<span class="cm">	 */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dmac_reset</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Request Configuration.</span>
<span class="cm"> * The PL330 core does not modify this and uses the last</span>
<span class="cm"> * working configuration if the request doesn&#39;t provide any.</span>
<span class="cm"> *</span>
<span class="cm"> * The Client may want to provide this info only for the</span>
<span class="cm"> * first request and a request with new settings.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pl330_reqcfg</span> <span class="p">{</span>
	<span class="cm">/* Address Incrementing */</span>
	<span class="kt">unsigned</span> <span class="n">dst_inc</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">src_inc</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For now, the SRC &amp; DST protection levels</span>
<span class="cm">	 * and burst size/length are assumed same.</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">nonsecure</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">privileged</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">insnaccess</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">brst_len</span><span class="o">:</span><span class="mi">5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">brst_size</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span> <span class="cm">/* in power of 2 */</span>

	<span class="k">enum</span> <span class="n">pl330_dstcachectrl</span> <span class="n">dcctl</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pl330_srccachectrl</span> <span class="n">scctl</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pl330_byteswap</span> <span class="n">swap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_config</span> <span class="o">*</span><span class="n">pcfg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * One cycle of DMAC operation.</span>
<span class="cm"> * There may be more than one xfer in a request.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">src_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="cm">/* Size to xfer */</span>
	<span class="n">u32</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Pointer to next xfer in the list.</span>
<span class="cm">	 * The last xfer in the req must point to NULL.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The xfer callbacks are made with one of these arguments. */</span>
<span class="k">enum</span> <span class="n">pl330_op_err</span> <span class="p">{</span>
	<span class="cm">/* The all xfers in the request were success. */</span>
	<span class="n">PL330_ERR_NONE</span><span class="p">,</span>
	<span class="cm">/* If req aborted due to global error. */</span>
	<span class="n">PL330_ERR_ABORT</span><span class="p">,</span>
	<span class="cm">/* If req failed due to problem with Channel. */</span>
	<span class="n">PL330_ERR_FAIL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* A request defining Scatter-Gather List ending with NULL xfer. */</span>
<span class="k">struct</span> <span class="n">pl330_req</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">pl330_reqtype</span> <span class="n">rqtype</span><span class="p">;</span>
	<span class="cm">/* Index of peripheral for the xfer. */</span>
	<span class="kt">unsigned</span> <span class="n">peri</span><span class="o">:</span><span class="mi">5</span><span class="p">;</span>
	<span class="cm">/* Unique token for this xfer, set by the client. */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="cm">/* Callback to be called after xfer. */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">xfer_cb</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pl330_op_err</span> <span class="n">err</span><span class="p">);</span>
	<span class="cm">/* If NULL, req will be done at last set parameters. */</span>
	<span class="k">struct</span> <span class="n">pl330_reqcfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>
	<span class="cm">/* Pointer to first xfer in the request. */</span>
	<span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="cm">/* Hook to attach to DMAC&#39;s list of reqs with due callback */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">rqd</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * To know the status of the channel and DMAC, the client</span>
<span class="cm"> * provides a pointer to this structure. The PL330 core</span>
<span class="cm"> * fills it with current information.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pl330_chanstatus</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the DMAC engine halted due to some error,</span>
<span class="cm">	 * the client should remove-add DMAC.</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">dmac_halted</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If channel is halted due to some error,</span>
<span class="cm">	 * the client should ABORT/FLUSH and START the channel.</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">faulting</span><span class="p">;</span>
	<span class="cm">/* Location of last load */</span>
	<span class="n">u32</span> <span class="n">src_addr</span><span class="p">;</span>
	<span class="cm">/* Location of last store */</span>
	<span class="n">u32</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Pointer to the currently active req, NULL if channel is</span>
<span class="cm">	 * inactive, even though the requests may be present.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">pl330_req</span> <span class="o">*</span><span class="n">top_req</span><span class="p">;</span>
	<span class="cm">/* Pointer to req waiting second in the queue if any. */</span>
	<span class="k">struct</span> <span class="n">pl330_req</span> <span class="o">*</span><span class="n">wait_req</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pl330_chan_op</span> <span class="p">{</span>
	<span class="cm">/* Start the channel */</span>
	<span class="n">PL330_OP_START</span><span class="p">,</span>
	<span class="cm">/* Abort the active xfer */</span>
	<span class="n">PL330_OP_ABORT</span><span class="p">,</span>
	<span class="cm">/* Stop xfer and flush queue */</span>
	<span class="n">PL330_OP_FLUSH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ccr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_req</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dmamov_dst</span> <span class="p">{</span>
	<span class="n">SAR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CCR</span><span class="p">,</span>
	<span class="n">DAR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pl330_dst</span> <span class="p">{</span>
	<span class="n">SRC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DST</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pl330_cond</span> <span class="p">{</span>
	<span class="n">SINGLE</span><span class="p">,</span>
	<span class="n">BURST</span><span class="p">,</span>
	<span class="n">ALWAYS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">_pl330_req</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">mc_bus</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mc_cpu</span><span class="p">;</span>
	<span class="cm">/* Number of bytes taken to setup MC for the req */</span>
	<span class="n">u32</span> <span class="n">mc_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_req</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ToBeDone for tasklet */</span>
<span class="k">struct</span> <span class="n">_pl330_tbd</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">reset_dmac</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reset_mngr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reset_chan</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* A DMAC Thread */</span>
<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ev</span><span class="p">;</span>
	<span class="cm">/* If the channel is not yet acquired by any client */</span>
	<span class="n">bool</span> <span class="n">free</span><span class="p">;</span>
	<span class="cm">/* Parent DMAC */</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">dmac</span><span class="p">;</span>
	<span class="cm">/* Only two at a time */</span>
	<span class="k">struct</span> <span class="n">_pl330_req</span> <span class="n">req</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="cm">/* Index of the last enqueued request */</span>
	<span class="kt">unsigned</span> <span class="n">lstenq</span><span class="p">;</span>
	<span class="cm">/* Index of the last submitted request or -1 if the DMA is stopped */</span>
	<span class="kt">int</span> <span class="n">req_running</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pl330_dmac_state</span> <span class="p">{</span>
	<span class="n">UNINIT</span><span class="p">,</span>
	<span class="n">INIT</span><span class="p">,</span>
	<span class="n">DYING</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* A DMAC */</span>
<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="cm">/* Holds list of reqs with due callbacks */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">req_done</span><span class="p">;</span>
	<span class="cm">/* Pointer to platform specific stuff */</span>
	<span class="k">struct</span> <span class="n">pl330_info</span>	<span class="o">*</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="cm">/* Maximum possible events/irqs */</span>
	<span class="kt">int</span>			<span class="n">events</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="cm">/* BUS address of MicroCode buffer */</span>
	<span class="n">u32</span>			<span class="n">mcode_bus</span><span class="p">;</span>
	<span class="cm">/* CPU address of MicroCode buffer */</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">mcode_cpu</span><span class="p">;</span>
	<span class="cm">/* List of all Channel threads */</span>
	<span class="k">struct</span> <span class="n">pl330_thread</span>	<span class="o">*</span><span class="n">channels</span><span class="p">;</span>
	<span class="cm">/* Pointer to the MANAGER thread */</span>
	<span class="k">struct</span> <span class="n">pl330_thread</span>	<span class="o">*</span><span class="n">manager</span><span class="p">;</span>
	<span class="cm">/* To handle bad news in interrupt */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>	<span class="n">tasks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_pl330_tbd</span>	<span class="n">dmac_tbd</span><span class="p">;</span>
	<span class="cm">/* State of DMAC operation */</span>
	<span class="k">enum</span> <span class="n">pl330_dmac_state</span>	<span class="n">state</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">desc_status</span> <span class="p">{</span>
	<span class="cm">/* In the DMAC pool */</span>
	<span class="n">FREE</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocted to some channel during prep_xxx</span>
<span class="cm">	 * Also may be sitting on the work_list.</span>
<span class="cm">	 */</span>
	<span class="n">PREP</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * Sitting on the work_list and already submitted</span>
<span class="cm">	 * to the PL330 core. Not more than two descriptors</span>
<span class="cm">	 * of a channel can be BUSY at any time.</span>
<span class="cm">	 */</span>
	<span class="n">BUSY</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * Sitting on the channel work_list but xfer done</span>
<span class="cm">	 * by PL330 core</span>
<span class="cm">	 */</span>
	<span class="n">DONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="p">{</span>
	<span class="cm">/* Schedule desc completion */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">task</span><span class="p">;</span>

	<span class="cm">/* DMA-Engine Channel */</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="n">chan</span><span class="p">;</span>

	<span class="cm">/* List of to be xfered descriptors */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">work_list</span><span class="p">;</span>

	<span class="cm">/* Pointer to the DMAC that manages this channel,</span>
<span class="cm">	 * NULL if the channel is available to be acquired.</span>
<span class="cm">	 * As the parent, this DMAC also provides descriptors</span>
<span class="cm">	 * to the channel.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">dmac</span><span class="p">;</span>

	<span class="cm">/* To protect channel manipulation */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="cm">/* Token of a hardware channel thread of PL330 DMAC</span>
<span class="cm">	 * NULL if the channel is available to be acquired.</span>
<span class="cm">	 */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pl330_chid</span><span class="p">;</span>

	<span class="cm">/* For D-to-M and M-to-D channels */</span>
	<span class="kt">int</span> <span class="n">burst_sz</span><span class="p">;</span> <span class="cm">/* the peripheral fifo width */</span>
	<span class="kt">int</span> <span class="n">burst_len</span><span class="p">;</span> <span class="cm">/* the number of burst */</span>
	<span class="n">dma_addr_t</span> <span class="n">fifo_addr</span><span class="p">;</span>

	<span class="cm">/* for cyclic capability */</span>
	<span class="n">bool</span> <span class="n">cyclic</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="n">pif</span><span class="p">;</span>

	<span class="cm">/* DMA-Engine Device */</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="n">ddma</span><span class="p">;</span>

	<span class="cm">/* Pool of descriptors available for the DMAC&#39;s channels */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">desc_pool</span><span class="p">;</span>
	<span class="cm">/* To protect desc_pool manipulation */</span>
	<span class="n">spinlock_t</span> <span class="n">pool_lock</span><span class="p">;</span>

	<span class="cm">/* Peripheral channels connected to this DMAC */</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">peripherals</span><span class="p">;</span> <span class="cm">/* keep at end */</span>

	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="p">{</span>
	<span class="cm">/* To attach to a queue as child */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>

	<span class="cm">/* Descriptor for the DMA Engine API */</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="n">txd</span><span class="p">;</span>

	<span class="cm">/* Xfer for PL330 core */</span>
	<span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="n">px</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pl330_reqcfg</span> <span class="n">rqcfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_req</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">desc_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* The channel which currently holds this desc */</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pchan</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_req</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pl330_op_err</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">xfer_cb</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">xfer_cb</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">_queue_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">IS_FREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">IS_FREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">_queue_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">IS_FREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span> <span class="n">IS_FREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_manager</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>

	<span class="cm">/* MANAGER is indexed at the end */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* If manager of the thread is in Non-Secure mode */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">_manager_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">DMAC_MODE_NS</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">get_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">get_revision</span><span class="p">(</span><span class="n">u32</span> <span class="n">periph_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">periph_id</span> <span class="o">&gt;&gt;</span> <span class="n">PERIPH_REV_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PERIPH_REV_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_ADDH</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">enum</span> <span class="n">pl330_dst</span> <span class="n">da</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAADDH</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAADDH</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">da</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMAADDH</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMAADDH %s %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">da</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;DA&quot;</span> <span class="o">:</span> <span class="s">&quot;SA&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMAADDH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_END</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAEND</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAEND</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMAEND</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMAEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMAEND</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_FLUSHP</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span> <span class="n">u8</span> <span class="n">peri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAFLUSHP</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAFLUSHP</span><span class="p">;</span>

	<span class="n">peri</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">peri</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peri</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMAFLUSHP</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMAFLUSHP %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peri</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMAFLUSHP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_LD</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>	<span class="k">enum</span> <span class="n">pl330_cond</span> <span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMALD</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMALD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMALD</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMALD%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span> <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">SZ_DMALD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_LDP</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">enum</span> <span class="n">pl330_cond</span> <span class="n">cond</span><span class="p">,</span> <span class="n">u8</span> <span class="n">peri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMALDP</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMALDP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">peri</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">peri</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peri</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMALDP</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMALDP%c %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="n">peri</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMALDP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_LP</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="kt">unsigned</span> <span class="n">loop</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMALP</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMALP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">cnt</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* DMAC increments by 1 internally */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMALP</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMALP_%c %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loop</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMALP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">_arg_LPEND</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">pl330_cond</span> <span class="n">cond</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">forever</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">loop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bjump</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_LPEND</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">_arg_LPEND</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">pl330_cond</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">forever</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">forever</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bjump</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">bjump</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMALPEND</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMALPEND</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">forever</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bjump</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMALPEND</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMALP%s%c_%c bjmpto_%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">forever</span> <span class="o">?</span> <span class="s">&quot;FE&quot;</span> <span class="o">:</span> <span class="s">&quot;END&quot;</span><span class="p">,</span>
			<span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span> <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">),</span>
			<span class="n">loop</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
			<span class="n">bjump</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMALPEND</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_KILL</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAKILL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAKILL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SZ_DMAKILL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_MOV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">enum</span> <span class="n">dmamov_dst</span> <span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAMOV</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAMOV</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMAMOV</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMAMOV %s 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dst</span> <span class="o">==</span> <span class="n">SAR</span> <span class="o">?</span> <span class="s">&quot;SAR&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">DAR</span> <span class="o">?</span> <span class="s">&quot;DAR&quot;</span> <span class="o">:</span> <span class="s">&quot;CCR&quot;</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMAMOV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_NOP</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMANOP</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMANOP</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMANOP</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMANOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMANOP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_RMB</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMARMB</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMARMB</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMARMB</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMARMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMARMB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_SEV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span> <span class="n">u8</span> <span class="n">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMASEV</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMASEV</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">ev</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMASEV</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMASEV %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ev</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMASEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_ST</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span> <span class="k">enum</span> <span class="n">pl330_cond</span> <span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAST</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMAST</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMAST%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span> <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">SZ_DMAST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_STP</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">enum</span> <span class="n">pl330_cond</span> <span class="n">cond</span><span class="p">,</span> <span class="n">u8</span> <span class="n">peri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMASTP</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMASTP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">peri</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">peri</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peri</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMASTP</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMASTP%c %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="n">peri</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMASTP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_STZ</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMASTZ</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMASTZ</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMASTZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMASTZ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMASTZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_WFE</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span> <span class="n">u8</span> <span class="n">ev</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">invalidate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAWFE</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAWFE</span><span class="p">;</span>

	<span class="n">ev</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">ev</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invalidate</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMAWFE</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMAWFE %u%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ev</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">invalidate</span> <span class="o">?</span> <span class="s">&quot;, I&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMAWFE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_WFP</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">enum</span> <span class="n">pl330_cond</span> <span class="n">cond</span><span class="p">,</span> <span class="n">u8</span> <span class="n">peri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAWFP</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAWFP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">peri</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">peri</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peri</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMAWFP</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMAWFP%c %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cond</span> <span class="o">==</span> <span class="n">SINGLE</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BURST</span> <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">peri</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMAWFP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_WMB</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAWMB</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAWMB</span><span class="p">;</span>

	<span class="n">PL330_DBGCMD_DUMP</span><span class="p">(</span><span class="n">SZ_DMAWMB</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DMAWMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SZ_DMAWMB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">_arg_GO</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_emit_GO</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">_arg_GO</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dry_run</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SZ_DMAGO</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_DMAGO</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SZ_DMAGO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define msecs_to_loops(t) (loops_per_jiffy / 1000 * HZ * t)</span>

<span class="cm">/* Returns Time-Out */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">_until_dmac_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loops</span> <span class="o">=</span> <span class="n">msecs_to_loops</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Until Manager is Idle */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DBGSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DBG_BUSY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">loops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loops</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_execute_DBGINSN</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">insn</span><span class="p">[],</span> <span class="n">bool</span> <span class="n">as_manager</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">insn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">insn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">as_manager</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* Channel Number */</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">DBGINST0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">insn</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">DBGINST1</span><span class="p">);</span>

	<span class="cm">/* If timed out due to halted state-machine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_until_dmac_idle</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMAC halted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get going */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">DBGCMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mark a _pl330_req as free.</span>
<span class="cm"> * We do it by writing DMAEND as the first instruction</span>
<span class="cm"> * because no valid request is going to have DMAEND as</span>
<span class="cm"> * its first instruction to execute.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mark_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_pl330_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">_emit_END</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">mc_cpu</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mc_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req_running</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_manager</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CS</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DS_ST_STOP</span>:
		<span class="k">return</span> <span class="n">PL330_STATE_STOPPED</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_EXEC</span>:
		<span class="k">return</span> <span class="n">PL330_STATE_EXECUTING</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_CMISS</span>:
		<span class="k">return</span> <span class="n">PL330_STATE_CACHEMISS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_UPDTPC</span>:
		<span class="k">return</span> <span class="n">PL330_STATE_UPDTPC</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_WFE</span>:
		<span class="k">return</span> <span class="n">PL330_STATE_WFE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_FAULT</span>:
		<span class="k">return</span> <span class="n">PL330_STATE_FAULTING</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_ATBRR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_manager</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PL330_STATE_INVALID</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">PL330_STATE_ATBARRIER</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_QBUSY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_manager</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PL330_STATE_INVALID</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">PL330_STATE_QUEUEBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_WFP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_manager</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PL330_STATE_INVALID</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">PL330_STATE_WFP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_KILL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_manager</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PL330_STATE_INVALID</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">PL330_STATE_KILLING</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_CMPLT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_manager</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PL330_STATE_INVALID</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">PL330_STATE_COMPLETING</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DS_ST_FLTCMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_manager</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PL330_STATE_INVALID</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">PL330_STATE_FAULT_COMPLETING</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">PL330_STATE_INVALID</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">insn</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_state</span><span class="p">(</span><span class="n">thrd</span><span class="p">)</span> <span class="o">==</span> <span class="n">PL330_STATE_FAULT_COMPLETING</span><span class="p">)</span>
		<span class="n">UNTIL</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">PL330_STATE_FAULTING</span> <span class="o">|</span> <span class="n">PL330_STATE_KILLING</span><span class="p">);</span>

	<span class="cm">/* Return if nothing needs to be done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_state</span><span class="p">(</span><span class="n">thrd</span><span class="p">)</span> <span class="o">==</span> <span class="n">PL330_STATE_COMPLETING</span>
		  <span class="o">||</span> <span class="n">_state</span><span class="p">(</span><span class="n">thrd</span><span class="p">)</span> <span class="o">==</span> <span class="n">PL330_STATE_KILLING</span>
		  <span class="o">||</span> <span class="n">_state</span><span class="p">(</span><span class="n">thrd</span><span class="p">)</span> <span class="o">==</span> <span class="n">PL330_STATE_STOPPED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">_emit_KILL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>

	<span class="cm">/* Stop generating interrupts for SEV */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">INTEN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">),</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">INTEN</span><span class="p">);</span>

	<span class="n">_execute_DBGINSN</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">is_manager</span><span class="p">(</span><span class="n">thrd</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Start doing req &#39;idx&#39; of thread &#39;thrd&#39; */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_pl330_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_req</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_arg_GO</span> <span class="n">go</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">insn</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* Return if already ACTIVE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_state</span><span class="p">(</span><span class="n">thrd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PL330_STATE_STOPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">lstenq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">lstenq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
			<span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Return if no request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">)</span>
		<span class="n">ns</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">nonsecure</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CS</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CS_CNS</span><span class="p">)</span>
		<span class="n">ns</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* See &#39;Abort Sources&#39; point-4 at Page 2-25 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_manager_ns</span><span class="p">(</span><span class="n">thrd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ns</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Recipe for ABORT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">go</span><span class="p">.</span><span class="n">chan</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">go</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">mc_bus</span><span class="p">;</span>
	<span class="n">go</span><span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">_emit_GO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">go</span><span class="p">);</span>

	<span class="cm">/* Set to generate interrupts for SEV */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">INTEN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">),</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">INTEN</span><span class="p">);</span>

	<span class="cm">/* Only manager can execute GO */</span>
	<span class="n">_execute_DBGINSN</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req_running</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">_state</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PL330_STATE_FAULT_COMPLETING</span>:
		<span class="n">UNTIL</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">PL330_STATE_FAULTING</span> <span class="o">|</span> <span class="n">PL330_STATE_KILLING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_state</span><span class="p">(</span><span class="n">thrd</span><span class="p">)</span> <span class="o">==</span> <span class="n">PL330_STATE_KILLING</span><span class="p">)</span>
			<span class="n">UNTIL</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">PL330_STATE_STOPPED</span><span class="p">)</span>

	<span class="k">case</span> <span class="n">PL330_STATE_FAULTING</span>:
		<span class="n">_stop</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">PL330_STATE_KILLING</span>:
	<span class="k">case</span> <span class="n">PL330_STATE_COMPLETING</span>:
		<span class="n">UNTIL</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">PL330_STATE_STOPPED</span><span class="p">)</span>

	<span class="k">case</span> <span class="n">PL330_STATE_STOPPED</span>:
		<span class="k">return</span> <span class="n">_trigger</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">PL330_STATE_WFP</span>:
	<span class="k">case</span> <span class="n">PL330_STATE_QUEUEBUSY</span>:
	<span class="k">case</span> <span class="n">PL330_STATE_ATBARRIER</span>:
	<span class="k">case</span> <span class="n">PL330_STATE_UPDTPC</span>:
	<span class="k">case</span> <span class="n">PL330_STATE_CACHEMISS</span>:
	<span class="k">case</span> <span class="n">PL330_STATE_EXECUTING</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PL330_STATE_WFE</span>: <span class="cm">/* For RESUME, nothing yet */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_ldst_memtomem</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="o">*</span><span class="n">pxs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cyc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_config</span> <span class="o">*</span><span class="n">pcfg</span> <span class="o">=</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">;</span>

	<span class="cm">/* check lock-up free version */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_revision</span><span class="p">(</span><span class="n">pcfg</span><span class="o">-&gt;</span><span class="n">periph_id</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PERIPH_REV_R1P0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cyc</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_LD</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">ALWAYS</span><span class="p">);</span>
			<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_ST</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">ALWAYS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cyc</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_LD</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">ALWAYS</span><span class="p">);</span>
			<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_RMB</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">]);</span>
			<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_ST</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">ALWAYS</span><span class="p">);</span>
			<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_WMB</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_ldst_devtomem</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="o">*</span><span class="n">pxs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cyc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cyc</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_WFP</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">peri</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_LDP</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">peri</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_ST</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">ALWAYS</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_FLUSHP</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">peri</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_ldst_memtodev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="o">*</span><span class="n">pxs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cyc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cyc</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_WFP</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">peri</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_LD</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">ALWAYS</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_STP</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">SINGLE</span><span class="p">,</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">peri</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_FLUSHP</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">peri</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_bursts</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="o">*</span><span class="n">pxs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cyc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rqtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEMTODEV</span>:
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_ldst_memtodev</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">pxs</span><span class="p">,</span> <span class="n">cyc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVTOMEM</span>:
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_ldst_devtomem</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">pxs</span><span class="p">,</span> <span class="n">cyc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEMTOMEM</span>:
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_ldst_memtomem</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">pxs</span><span class="p">,</span> <span class="n">cyc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="mh">0x40000000</span><span class="p">;</span> <span class="cm">/* Scare off the Client */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns bytes consumed and updates bursts */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_loop</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bursts</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="o">*</span><span class="n">pxs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cyc</span><span class="p">,</span> <span class="n">cycmax</span><span class="p">,</span> <span class="n">szlp</span><span class="p">,</span> <span class="n">szlpend</span><span class="p">,</span> <span class="n">szbrst</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lcnt0</span><span class="p">,</span> <span class="n">lcnt1</span><span class="p">,</span> <span class="n">ljmp0</span><span class="p">,</span> <span class="n">ljmp1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_arg_LPEND</span> <span class="n">lpend</span><span class="p">;</span>

	<span class="cm">/* Max iterations possible in DMALP is 256 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bursts</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="o">*</span><span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcnt1</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">lcnt0</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">cyc</span> <span class="o">=</span> <span class="o">*</span><span class="n">bursts</span> <span class="o">/</span> <span class="n">lcnt1</span> <span class="o">/</span> <span class="n">lcnt0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bursts</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcnt1</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">lcnt0</span> <span class="o">=</span> <span class="o">*</span><span class="n">bursts</span> <span class="o">/</span> <span class="n">lcnt1</span><span class="p">;</span>
		<span class="n">cyc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lcnt1</span> <span class="o">=</span> <span class="o">*</span><span class="n">bursts</span><span class="p">;</span>
		<span class="n">lcnt0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cyc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">szlp</span> <span class="o">=</span> <span class="n">_emit_LP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">szbrst</span> <span class="o">=</span> <span class="n">_bursts</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pxs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">lpend</span><span class="p">.</span><span class="n">cond</span> <span class="o">=</span> <span class="n">ALWAYS</span><span class="p">;</span>
	<span class="n">lpend</span><span class="p">.</span><span class="n">forever</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">lpend</span><span class="p">.</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lpend</span><span class="p">.</span><span class="n">bjump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">szlpend</span> <span class="o">=</span> <span class="n">_emit_LPEND</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpend</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcnt0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">szlp</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">szlpend</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Max bursts that we can unroll due to limit on the</span>
<span class="cm">	 * size of backward jump that can be encoded in DMALPEND</span>
<span class="cm">	 * which is 8-bits and hence 255</span>
<span class="cm">	 */</span>
	<span class="n">cycmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="p">(</span><span class="n">szlp</span> <span class="o">+</span> <span class="n">szlpend</span><span class="p">))</span> <span class="o">/</span> <span class="n">szbrst</span><span class="p">;</span>

	<span class="n">cyc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cycmax</span> <span class="o">&lt;</span> <span class="n">cyc</span><span class="p">)</span> <span class="o">?</span> <span class="n">cycmax</span> <span class="o">:</span> <span class="n">cyc</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcnt0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_LP</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lcnt0</span><span class="p">);</span>
		<span class="n">ljmp0</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_LP</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lcnt1</span><span class="p">);</span>
	<span class="n">ljmp1</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">+=</span> <span class="n">_bursts</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">pxs</span><span class="p">,</span> <span class="n">cyc</span><span class="p">);</span>

	<span class="n">lpend</span><span class="p">.</span><span class="n">cond</span> <span class="o">=</span> <span class="n">ALWAYS</span><span class="p">;</span>
	<span class="n">lpend</span><span class="p">.</span><span class="n">forever</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">lpend</span><span class="p">.</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lpend</span><span class="p">.</span><span class="n">bjump</span> <span class="o">=</span> <span class="n">off</span> <span class="o">-</span> <span class="n">ljmp1</span><span class="p">;</span>
	<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_LPEND</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">lpend</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcnt0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpend</span><span class="p">.</span><span class="n">cond</span> <span class="o">=</span> <span class="n">ALWAYS</span><span class="p">;</span>
		<span class="n">lpend</span><span class="p">.</span><span class="n">forever</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">lpend</span><span class="p">.</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lpend</span><span class="p">.</span><span class="n">bjump</span> <span class="o">=</span> <span class="n">off</span> <span class="o">-</span> <span class="n">ljmp0</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_LPEND</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">lpend</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">bursts</span> <span class="o">=</span> <span class="n">lcnt1</span> <span class="o">*</span> <span class="n">cyc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcnt0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bursts</span> <span class="o">*=</span> <span class="n">lcnt0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_setup_loops</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="o">*</span><span class="n">pxs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ccr</span> <span class="o">=</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">c</span><span class="p">,</span> <span class="n">bursts</span> <span class="o">=</span> <span class="n">BYTE_TO_BURST</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">,</span> <span class="n">ccr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bursts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">bursts</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_loop</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">pxs</span><span class="p">);</span>
		<span class="n">bursts</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_setup_xfer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf</span><span class="p">[],</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="o">*</span><span class="n">pxs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DMAMOV SAR, x-&gt;src_addr */</span>
	<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_MOV</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">SAR</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">);</span>
	<span class="cm">/* DMAMOV DAR, x-&gt;dst_addr */</span>
	<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_MOV</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">DAR</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">);</span>

	<span class="cm">/* Setup Loop(s) */</span>
	<span class="n">off</span> <span class="o">+=</span> <span class="n">_setup_loops</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">pxs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A req is a sequence of one or more xfer units.</span>
<span class="cm"> * Returns the number of bytes taken to setup the MC for the req.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_setup_req</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">dry_run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">index</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="o">*</span><span class="n">pxs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_pl330_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">mc_cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PL330_DBGMC_START</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mc_bus</span><span class="p">);</span>

	<span class="cm">/* DMAMOV CCR, ccr */</span>
	<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_MOV</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">pxs</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Error if xfer length is not aligned at burst size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">%</span> <span class="p">(</span><span class="n">BRST_SIZE</span><span class="p">(</span><span class="n">pxs</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">)</span> <span class="o">*</span> <span class="n">BRST_LEN</span><span class="p">(</span><span class="n">pxs</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">pxs</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">_setup_xfer</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">pxs</span><span class="p">);</span>

		<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="p">);</span>

	<span class="cm">/* DMASEV peripheral/event */</span>
	<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_SEV</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">);</span>
	<span class="cm">/* DMAEND */</span>
	<span class="n">off</span> <span class="o">+=</span> <span class="n">_emit_END</span><span class="p">(</span><span class="n">dry_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_prepare_ccr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pl330_reqcfg</span> <span class="o">*</span><span class="n">rqc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ccr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">src_inc</span><span class="p">)</span>
		<span class="n">ccr</span> <span class="o">|=</span> <span class="n">CC_SRCINC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">dst_inc</span><span class="p">)</span>
		<span class="n">ccr</span> <span class="o">|=</span> <span class="n">CC_DSTINC</span><span class="p">;</span>

	<span class="cm">/* We set same protection levels for Src and DST for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">privileged</span><span class="p">)</span>
		<span class="n">ccr</span> <span class="o">|=</span> <span class="n">CC_SRCPRI</span> <span class="o">|</span> <span class="n">CC_DSTPRI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">nonsecure</span><span class="p">)</span>
		<span class="n">ccr</span> <span class="o">|=</span> <span class="n">CC_SRCNS</span> <span class="o">|</span> <span class="n">CC_DSTNS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">insnaccess</span><span class="p">)</span>
		<span class="n">ccr</span> <span class="o">|=</span> <span class="n">CC_SRCIA</span> <span class="o">|</span> <span class="n">CC_DSTIA</span><span class="p">;</span>

	<span class="n">ccr</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">brst_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CC_SRCBRSTLEN_SHFT</span><span class="p">);</span>
	<span class="n">ccr</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">brst_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CC_DSTBRSTLEN_SHFT</span><span class="p">);</span>

	<span class="n">ccr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">brst_size</span> <span class="o">&lt;&lt;</span> <span class="n">CC_SRCBRSTSIZE_SHFT</span><span class="p">);</span>
	<span class="n">ccr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">brst_size</span> <span class="o">&lt;&lt;</span> <span class="n">CC_DSTBRSTSIZE_SHFT</span><span class="p">);</span>

	<span class="n">ccr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">scctl</span> <span class="o">&lt;&lt;</span> <span class="n">CC_SRCCCTRL_SHFT</span><span class="p">);</span>
	<span class="n">ccr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">dcctl</span> <span class="o">&lt;&lt;</span> <span class="n">CC_DSTCCTRL_SHFT</span><span class="p">);</span>

	<span class="n">ccr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rqc</span><span class="o">-&gt;</span><span class="n">swap</span> <span class="o">&lt;&lt;</span> <span class="n">CC_SWAP_SHFT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ccr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">_is_valid</span><span class="p">(</span><span class="n">u32</span> <span class="n">ccr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">pl330_dstcachectrl</span> <span class="n">dcctl</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pl330_srccachectrl</span> <span class="n">scctl</span><span class="p">;</span>

	<span class="n">dcctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccr</span> <span class="o">&gt;&gt;</span> <span class="n">CC_DSTCCTRL_SHFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CC_DRCCCTRL_MASK</span><span class="p">;</span>
	<span class="n">scctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccr</span> <span class="o">&gt;&gt;</span> <span class="n">CC_SRCCCTRL_SHFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CC_SRCCCTRL_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dcctl</span> <span class="o">==</span> <span class="n">DINVALID1</span> <span class="o">||</span> <span class="n">dcctl</span> <span class="o">==</span> <span class="n">DINVALID2</span>
			<span class="o">||</span> <span class="n">scctl</span> <span class="o">==</span> <span class="n">SINVALID1</span> <span class="o">||</span> <span class="n">scctl</span> <span class="o">==</span> <span class="n">SINVALID2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Submit a list of xfers after which the client wants notification.</span>
<span class="cm"> * Client is not notified after each xfer unit, just once after all</span>
<span class="cm"> * xfer units are done or some error occurs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl330_submit_req</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ch_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pl330_req</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span> <span class="o">=</span> <span class="n">ch_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_xfer_spec</span> <span class="n">xs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ccr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* No Req or Unacquired Channel or DMAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">||</span> <span class="o">!</span><span class="n">thrd</span> <span class="o">||</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pl330</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>
	<span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DYING</span>
		<span class="o">||</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_chan</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If request for non-existing peripheral */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rqtype</span> <span class="o">!=</span> <span class="n">MEMTOMEM</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">peri</span> <span class="o">&gt;=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_peri</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s:%d Invalid peripheral(%u)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">peri</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_queue_full</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">xfer_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Prefer Secure Channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_manager_ns</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">nonsecure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">nonsecure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Use last settings, if not provided */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">)</span>
		<span class="n">ccr</span> <span class="o">=</span> <span class="n">_prepare_ccr</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ccr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CC</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>

	<span class="cm">/* If this req doesn&#39;t have valid xfer settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_is_valid</span><span class="p">(</span><span class="n">ccr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Invalid CCR(%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ccr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">xfer_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">IS_FREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">xs</span><span class="p">.</span><span class="n">ccr</span> <span class="o">=</span> <span class="n">ccr</span><span class="p">;</span>
	<span class="n">xs</span><span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* First dry run to check if req is acceptable */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_setup_req</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">thrd</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">xfer_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Trying increasing mcbufsz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">xfer_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hook the request */</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">lstenq</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">mc_len</span> <span class="o">=</span> <span class="n">_setup_req</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">thrd</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xs</span><span class="p">);</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">xfer_exit:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl330_dotask</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* The DMAC itself gone nuts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_dmac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DYING</span><span class="p">;</span>
		<span class="cm">/* Reset the manager too */</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_mngr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Clear the reset flag */</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_dmac</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_mngr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_stop</span><span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
		<span class="cm">/* Reset all channels */</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_chan</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Clear the reset flag */</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_mngr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_chan</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="k">enum</span> <span class="n">pl330_op_err</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">_stop</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FSC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">PL330_ERR_FAIL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">PL330_ERR_ABORT</span><span class="p">;</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">_callback</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">lstenq</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">_callback</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">lstenq</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* Clear the reset flag */</span>
			<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_chan</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns 1 if state was updated, 0 otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl330_update</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_req</span> <span class="o">*</span><span class="n">rqdone</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span> <span class="o">||</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">pl330</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_mngr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_mngr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FSC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_chan</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Reset Channel-%d</span><span class="se">\t</span><span class="s"> CS-%x FTC-%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">i</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CS</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
						<span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FTC</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
				<span class="n">_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check which event happened i.e, thread notified */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">ES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span> <span class="o">&lt;</span> <span class="mi">32</span>
			<span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_dmac</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Unexpected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">updt_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ev</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span><span class="p">;</span> <span class="n">ev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ev</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Event occurred */</span>
			<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">inten</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">INTEN</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">active</span><span class="p">;</span>

			<span class="cm">/* Clear the event */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inten</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ev</span><span class="p">))</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ev</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">INTCLR</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">id</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">ev</span><span class="p">];</span>

			<span class="n">thrd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

			<span class="n">active</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req_running</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">active</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="cm">/* Aborted */</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Detach the req */</span>
			<span class="n">rqdone</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">active</span><span class="p">].</span><span class="n">r</span><span class="p">;</span>
			<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">active</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>

			<span class="cm">/* Get going again ASAP */</span>
			<span class="n">_start</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>

			<span class="cm">/* For now, just make a list of callbacks to be done */</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rqdone</span><span class="o">-&gt;</span><span class="n">rqd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">req_done</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Now that we are in no hurry, do the callbacks */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rqdone</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">req_done</span><span class="p">,</span> <span class="n">rqd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rqdone</span><span class="o">-&gt;</span><span class="n">rqd</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">_callback</span><span class="p">(</span><span class="n">rqdone</span><span class="p">,</span> <span class="n">PL330_ERR_NONE</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">updt_exit:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_dmac</span>
			<span class="o">||</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_mngr</span>
			<span class="o">||</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">dmac_tbd</span><span class="p">.</span><span class="n">reset_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl330_chan_ctrl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ch_id</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pl330_chan_op</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span> <span class="o">=</span> <span class="n">ch_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thrd</span> <span class="o">||</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">||</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DYING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pl330</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>
	<span class="n">active</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req_running</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PL330_OP_FLUSH</span>:
		<span class="cm">/* Make sure the channel is stopped */</span>
		<span class="n">_stop</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>

		<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PL330_OP_ABORT</span>:
		<span class="cm">/* Make sure the channel is stopped */</span>
		<span class="n">_stop</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>

		<span class="cm">/* ABORT is only for the active req */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">active</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>

		<span class="cm">/* Start the next */</span>
	<span class="k">case</span> <span class="n">PL330_OP_START</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">active</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_start</span><span class="p">(</span><span class="n">thrd</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reserve an event */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_alloc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ev</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span><span class="p">;</span> <span class="n">ev</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ev</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_chan_ns</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">irq_ns</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Upon success, returns IdentityToken for the</span>
<span class="cm"> * allocated channel, NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">pl330_request_channel</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chans</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span> <span class="o">||</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pl330</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DYING</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chans</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thrd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">_manager_ns</span><span class="p">(</span><span class="n">thrd</span><span class="p">)</span> <span class="o">||</span>
					<span class="n">_chan_ns</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">ev</span> <span class="o">=</span> <span class="n">_alloc_event</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">ev</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">lstenq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">thrd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">thrd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release an event */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_free_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>

	<span class="cm">/* If the event is valid and was held by the thread */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span>
			<span class="o">&amp;&amp;</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">==</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl330_release_channel</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ch_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span> <span class="o">=</span> <span class="n">ch_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thrd</span> <span class="o">||</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">_stop</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>

	<span class="n">_callback</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">lstenq</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">PL330_ERR_ABORT</span><span class="p">);</span>
	<span class="n">_callback</span><span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">lstenq</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">PL330_ERR_ABORT</span><span class="p">);</span>

	<span class="n">pl330</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_free_event</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">ev</span><span class="p">);</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialize the structure for PL330 configuration, that can be used</span>
<span class="cm"> * by the client driver the make best use of the DMAC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_dmac_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CRD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CRD_DATA_WIDTH_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">CRD_DATA_WIDTH_MASK</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">data_bus_width</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CRD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CRD_DATA_BUFF_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">CRD_DATA_BUFF_MASK</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">data_buf_dep</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CR0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CR0_NUM_CHANS_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">CR0_NUM_CHANS_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CR0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CR0_PERIPH_REQ_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">CR0_NUM_PERIPH_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CR0_NUM_PERIPH_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_peri</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">peri_ns</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CR4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_peri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CR0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CR0_BOOT_MAN_NS</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">DMAC_MODE_NS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMAC_MODE_NS</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CR0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CR0_NUM_EVENTS_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">CR0_NUM_EVENTS_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">irq_ns</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">CR3</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">periph_id</span> <span class="o">=</span> <span class="n">get_id</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">PERIPH_ID</span><span class="p">);</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">pcell_id</span> <span class="o">=</span> <span class="n">get_id</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">PCELL_ID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_reset_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>

	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mc_cpu</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_cpu</span>
				<span class="o">+</span> <span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">*</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span><span class="p">);</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mc_bus</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_bus</span>
				<span class="o">+</span> <span class="p">(</span><span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">*</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span><span class="p">);</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mc_cpu</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mc_cpu</span>
				<span class="o">+</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mc_bus</span> <span class="o">=</span> <span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mc_bus</span>
				<span class="o">+</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mark_free</span><span class="p">(</span><span class="n">thrd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmac_alloc_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chans</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Allocate 1 Manager and &#39;chans&#39; Channel threads */</span>
	<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">chans</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">thrd</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Init Channel threads */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thrd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span> <span class="o">=</span> <span class="n">pl330</span><span class="p">;</span>
		<span class="n">_reset_thread</span><span class="p">(</span><span class="n">thrd</span><span class="p">);</span>
		<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MANAGER is indexed at the end */</span>
	<span class="n">thrd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">chans</span><span class="p">];</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">chans</span><span class="p">;</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">dmac</span> <span class="o">=</span> <span class="n">pl330</span><span class="p">;</span>
	<span class="n">thrd</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">=</span> <span class="n">thrd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmac_alloc_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chans</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Alloc MicroCode buffer for &#39;chans&#39; Channel threads.</span>
<span class="cm">	 * A channel&#39;s buffer offset is (Channel_Id * MCODE_BUFF_PERCHAN)</span>
<span class="cm">	 */</span>
	<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_cpu</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">chans</span> <span class="o">*</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_bus</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Can&#39;t allocate memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dmac_alloc_threads</span><span class="p">(</span><span class="n">pl330</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Can&#39;t to create channels for DMAC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">chans</span> <span class="o">*</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span><span class="p">,</span>
				<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_cpu</span><span class="p">,</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_bus</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl330_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span> <span class="o">||</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* If already added */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the SoC can perform reset on the DMAC, then do it</span>
<span class="cm">	 * before reading its configuration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dmac_reset</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dmac_reset</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="cm">/* Check if we can handle this DMAC */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_id</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">PERIPH_ID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PERIPH_ID_VAL</span>
	   <span class="o">||</span> <span class="n">get_id</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">PCELL_ID</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCELL_ID_VAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PERIPH_ID 0x%x, PCELL_ID 0x%x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_id</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">PERIPH_ID</span><span class="p">),</span> <span class="n">get_id</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">PCELL_ID</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the configuration of the DMAC */</span>
	<span class="n">read_dmac_config</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Can&#39;t work without events!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pl330</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pl330</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl330</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Can&#39;t allocate memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assign the info structure and private data */</span>
	<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span> <span class="o">=</span> <span class="n">pi</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span> <span class="o">=</span> <span class="n">pl330</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">req_done</span><span class="p">);</span>

	<span class="cm">/* Use default MC buffer size if not provided */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span> <span class="o">=</span> <span class="n">MCODE_BUFF_PER_REQ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Mark all events as free */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Allocate resources needed by the DMAC */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dmac_alloc_resources</span><span class="p">(</span><span class="n">pl330</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to create channels for DMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pl330</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">,</span> <span class="n">pl330_dotask</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pl330</span><span class="p">);</span>

	<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">INIT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmac_free_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chans</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_thread</span> <span class="o">*</span><span class="n">thrd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Release Channel threads */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thrd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pl330_release_channel</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">thrd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free memory */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmac_free_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chans</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">;</span>

	<span class="n">dmac_free_threads</span><span class="p">(</span><span class="n">pl330</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chans</span> <span class="o">*</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span><span class="p">,</span>
				<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_cpu</span><span class="p">,</span> <span class="n">pl330</span><span class="o">-&gt;</span><span class="n">mcode_bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl330_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl330_dmac</span> <span class="o">*</span><span class="n">pl330</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span> <span class="o">||</span> <span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pl330</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span><span class="p">;</span>

	<span class="n">pl330</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UNINIT</span><span class="p">;</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl330</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">);</span>

	<span class="cm">/* Free DMAC resources */</span>
	<span class="n">dmac_free_resources</span><span class="p">(</span><span class="n">pl330</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pl330</span><span class="p">);</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* forward declaration */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">amba_driver</span> <span class="n">pl330_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span>
<span class="nf">to_pchan</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_pl330_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span>
<span class="nf">to_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_pl330_desc</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">free_desc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Finish off the work list */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_async_tx_callback</span> <span class="n">callback</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>

		<span class="cm">/* All desc in a list belong to same channel */</span>
		<span class="n">pch</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">pchan</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback</span><span class="p">;</span>
		<span class="n">param</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback_param</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">callback</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">pchan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pch will be unset if list was empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pdmac</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">handle_cyclic_desc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_async_tx_callback</span> <span class="n">callback</span><span class="p">;</span>

		<span class="cm">/* Change status to reload it */</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PREP</span><span class="p">;</span>
		<span class="n">pch</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">pchan</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">callback</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback_param</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* pch will be unset if list was empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fill_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* If already submitted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">BUSY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pl330_submit_req</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">pl330_chid</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* QFull or DMAC Dying */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Unacceptable request */</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DONE</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Bad Desc(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl330_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_dt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Pick up ripe tomatoes */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_dt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">cyclic</span><span class="p">)</span>
				<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/* Try to submit a req imm. next to the last completed cookie */</span>
	<span class="n">fill_queue</span><span class="p">(</span><span class="n">pch</span><span class="p">);</span>

	<span class="cm">/* Make sure the PL330 Channel thread is active */</span>
	<span class="n">pl330_chan_ctrl</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">pl330_chid</span><span class="p">,</span> <span class="n">PL330_OP_START</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">cyclic</span><span class="p">)</span>
		<span class="n">handle_cyclic_desc_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">free_desc_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_pl330_rqcb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pl330_op_err</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">pchan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* If desc aborted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DONE</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">pl330_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">peri_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">pl330_driver</span><span class="p">.</span><span class="n">drv</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_OF</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">prop_value</span><span class="p">;</span>
		<span class="n">phandle</span> <span class="n">phandle</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

		<span class="n">prop_value</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">phandle</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">prop_value</span><span class="o">++</span><span class="p">);</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_phandle</span><span class="p">(</span><span class="n">phandle</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">==</span> <span class="n">node</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span> <span class="o">==</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">prop_value</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">peri_id</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">peri_id</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pl330_filter</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl330_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">to_pchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dma_cookie_init</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">pch</span><span class="o">-&gt;</span><span class="n">cyclic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pch</span><span class="o">-&gt;</span><span class="n">pl330_chid</span> <span class="o">=</span> <span class="n">pl330_request_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">pl330_chid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">pl330_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pch</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl330_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_cmd</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">to_pchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_dt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="n">slave_config</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_TERMINATE_ALL</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* FLUSH the PL330 Channel thread */</span>
		<span class="n">pl330_chan_ctrl</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">pl330_chid</span><span class="p">,</span> <span class="n">PL330_OP_FLUSH</span><span class="p">);</span>

		<span class="cm">/* Mark all desc done */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_dt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">work_list</span> <span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DONE</span><span class="p">;</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_CONFIG</span>:
		<span class="n">slave_config</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">)</span>
				<span class="n">pch</span><span class="o">-&gt;</span><span class="n">fifo_addr</span> <span class="o">=</span> <span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">)</span>
				<span class="n">pch</span><span class="o">-&gt;</span><span class="n">burst_sz</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">dst_maxburst</span><span class="p">)</span>
				<span class="n">pch</span><span class="o">-&gt;</span><span class="n">burst_len</span> <span class="o">=</span> <span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">dst_maxburst</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">)</span>
				<span class="n">pch</span><span class="o">-&gt;</span><span class="n">fifo_addr</span> <span class="o">=</span> <span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">)</span>
				<span class="n">pch</span><span class="o">-&gt;</span><span class="n">burst_sz</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">src_maxburst</span><span class="p">)</span>
				<span class="n">pch</span><span class="o">-&gt;</span><span class="n">burst_len</span> <span class="o">=</span> <span class="n">slave_config</span><span class="o">-&gt;</span><span class="n">src_maxburst</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not supported command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl330_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">to_pchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>

	<span class="n">pl330_release_channel</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">pl330_chid</span><span class="p">);</span>
	<span class="n">pch</span><span class="o">-&gt;</span><span class="n">pl330_chid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">cyclic</span><span class="p">)</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span>
<span class="nf">pl330_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl330_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pl330_tasklet</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">to_pchan</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We returned the last one of the circular list of descriptor(s)</span>
<span class="cm"> * from prep_xxx, so the argument to submit corresponds to the last</span>
<span class="cm"> * descriptor of the list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">pl330_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="n">to_desc</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">to_pchan</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Assign cookies to all nodes */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_pl330_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="n">dma_cookie_assign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>

		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_init_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">pchan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">px</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">swap</span> <span class="o">=</span> <span class="n">SWAP_NO</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">privileged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">insnaccess</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">scctl</span> <span class="o">=</span> <span class="n">SCCTRL0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">dcctl</span> <span class="o">=</span> <span class="n">DCCTRL0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">xfer_cb</span> <span class="o">=</span> <span class="n">dma_pl330_rqcb</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">pl330_tx_submit</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Returns the number of descriptors added to the DMAC pool */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdmac</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="n">flg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_init_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span>
<span class="nf">pluck_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdmac</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dma_pl330_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PREP</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="nf">pl330_get_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">peri_id</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* Pluck one desc from the pool of DMAC */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">pluck_desc</span><span class="p">(</span><span class="n">pdmac</span><span class="p">);</span>

	<span class="cm">/* If the DMAC pool is empty, alloc new */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_desc</span><span class="p">(</span><span class="n">pdmac</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Try again */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">pluck_desc</span><span class="p">(</span><span class="n">pdmac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s:%d ALERT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the descriptor */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">pchan</span> <span class="o">=</span> <span class="n">pch</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">async_tx_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">peri</span> <span class="o">=</span> <span class="n">peri_id</span> <span class="o">?</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">chan_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">pcfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">.</span><span class="n">pcfg</span><span class="p">;</span>

	<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fill_px</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl330_xfer</span> <span class="o">*</span><span class="n">px</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">px</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">px</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">px</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">px</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span>
<span class="nf">__pl330_prep_dma_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dst</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">pl330_get_desc</span><span class="p">(</span><span class="n">pch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Unable to fetch desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ideally we should lookout for reqs bigger than</span>
<span class="cm">	 * those that can be programmed with 256 bytes of</span>
<span class="cm">	 * MC buffer, but considering a req size is seldom</span>
<span class="cm">	 * going to be word-unaligned and more than 200MB,</span>
<span class="cm">	 * we take it easy.</span>
<span class="cm">	 * Also, should the limit is reached we&#39;d rather</span>
<span class="cm">	 * have the platform increase MC buffer size than</span>
<span class="cm">	 * complicating this API driver.</span>
<span class="cm">	 */</span>
	<span class="n">fill_px</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">px</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Call after fixing burst size */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_burst_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">pchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">burst_len</span><span class="p">;</span>

	<span class="n">burst_len</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">data_bus_width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">burst_len</span> <span class="o">*=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">data_buf_dep</span><span class="p">;</span>
	<span class="n">burst_len</span> <span class="o">&gt;&gt;=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_size</span><span class="p">;</span>

	<span class="cm">/* src/dst_burst_len can&#39;t be more than 16 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">burst_len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">burst_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">burst_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="p">(</span><span class="n">burst_len</span> <span class="o">&lt;&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_size</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">burst_len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">burst_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">pl330_prep_dma_cyclic</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">period_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">to_pchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">pl330_get_desc</span><span class="p">(</span><span class="n">pch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Unable to fetch desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_MEM_TO_DEV</span>:
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">src_inc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">dst_inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rqtype</span> <span class="o">=</span> <span class="n">MEMTODEV</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">fifo_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_DEV_TO_MEM</span>:
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">src_inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">dst_inc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rqtype</span> <span class="o">=</span> <span class="n">DEVTOMEM</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">fifo_addr</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Invalid dma direction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_size</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">burst_sz</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pch</span><span class="o">-&gt;</span><span class="n">cyclic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">fill_px</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">px</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">period_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">pl330_prep_dma_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dst</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">to_pchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">burst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pch</span> <span class="o">||</span> <span class="o">!</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">__pl330_prep_dma_memcpy</span><span class="p">(</span><span class="n">pch</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">src_inc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">dst_inc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rqtype</span> <span class="o">=</span> <span class="n">MEMTOMEM</span><span class="p">;</span>

	<span class="cm">/* Select max possible burst size */</span>
	<span class="n">burst</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">data_bus_width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">burst</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">burst</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">burst</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">burst</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_size</span><span class="p">))</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_size</span><span class="o">++</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_len</span> <span class="o">=</span> <span class="n">get_burst_len</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">pl330_prep_slave_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_desc</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">to_pchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pch</span> <span class="o">||</span> <span class="o">!</span><span class="n">sgl</span> <span class="o">||</span> <span class="o">!</span><span class="n">sg_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">fifo_addr</span><span class="p">;</span>

	<span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">pl330_get_desc</span><span class="p">(</span><span class="n">pch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="p">;</span>

			<span class="n">dev_err</span><span class="p">(</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s:%d Unable to fetch desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">dma_pl330_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">);</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">src_inc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">dst_inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rqtype</span> <span class="o">=</span> <span class="n">MEMTODEV</span><span class="p">;</span>
			<span class="n">fill_px</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">px</span><span class="p">,</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">src_inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">dst_inc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">rqtype</span> <span class="o">=</span> <span class="n">DEVTOMEM</span><span class="p">;</span>
			<span class="n">fill_px</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">px</span><span class="p">,</span>
				<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_size</span> <span class="o">=</span> <span class="n">pch</span><span class="o">-&gt;</span><span class="n">burst_sz</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">rqcfg</span><span class="p">.</span><span class="n">brst_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Return the last desc in the chain */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flg</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pl330_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl330_update</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">pl330_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">amba_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">amba_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_platdata</span> <span class="o">*</span><span class="n">pdat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_chan</span><span class="p">;</span>

	<span class="n">pdat</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* Allocate a new DMAC and its Channels */</span>
	<span class="n">pdmac</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdmac</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdmac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pl330_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mcbufsz</span> <span class="o">=</span> <span class="n">pdat</span> <span class="o">?</span> <span class="n">pdat</span><span class="o">-&gt;</span><span class="n">mcbuf_sz</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;dma-pl330&quot;</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get operation clock.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">amba_set_drvdata</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">pdmac</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_PM_RUNTIME</span>
	<span class="cm">/* enable dma clk */</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">pl330_irq_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">pi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_err3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pl330_add</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_err4</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">desc_pool</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>

	<span class="cm">/* Create a descriptor pool of default size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_desc</span><span class="p">(</span><span class="n">pdmac</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">NR_DEFAULT_DESC</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">ddma</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="cm">/* Initialize channel parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdat</span><span class="p">)</span>
		<span class="n">num_chan</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pdat</span><span class="o">-&gt;</span><span class="n">nr_valid_peri</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">num_chan</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_peri</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">);</span>

	<span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">num_chan</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pch</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">peripherals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span>
			<span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">pdat</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">pdat</span><span class="o">-&gt;</span><span class="n">peri_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pch</span><span class="o">-&gt;</span><span class="n">pl330_chid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
		<span class="n">pch</span><span class="o">-&gt;</span><span class="n">dmac</span> <span class="o">=</span> <span class="n">pdmac</span><span class="p">;</span>

		<span class="cm">/* Add the channel to the DMAC list */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap_mask</span> <span class="o">=</span> <span class="n">pdat</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_peri</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>
			<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_CYCLIC</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">pl330_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">pl330_free_chan_resources</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">pl330_prep_dma_memcpy</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">device_prep_dma_cyclic</span> <span class="o">=</span> <span class="n">pl330_prep_dma_cyclic</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">pl330_tx_status</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">device_prep_slave_sg</span> <span class="o">=</span> <span class="n">pl330_prep_slave_sg</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">pl330_control</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">pl330_issue_pending</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register DMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_err5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Loaded driver for PL330 DMAC-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">periphid</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;</span><span class="se">\t</span><span class="s">DBUFF-%ux%ubytes Num_Chans-%u Num_Peri-%u Num_Events-%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">data_buf_dep</span><span class="p">,</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">data_bus_width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_chan</span><span class="p">,</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_peri</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">.</span><span class="n">num_events</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">probe_err5:</span>
	<span class="n">pl330_del</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
<span class="nl">probe_err4:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
<span class="nl">probe_err3:</span>
<span class="cp">#ifndef CONFIG_PM_RUNTIME</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">probe_err2:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">probe_err1:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pdmac</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">pl330_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">amba_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span> <span class="o">=</span> <span class="n">amba_get_drvdata</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_pl330_chan</span> <span class="o">*</span><span class="n">pch</span><span class="p">,</span> <span class="o">*</span><span class="n">_p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl330_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdmac</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">amba_set_drvdata</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Idle the DMAC */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pch</span><span class="p">,</span> <span class="n">_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">ddma</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span>
			<span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Remove the channel */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">);</span>

		<span class="cm">/* Flush the channel */</span>
		<span class="n">pl330_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">DMA_TERMINATE_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pl330_free_chan_resources</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">pif</span><span class="p">;</span>

	<span class="n">pl330_del</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>

<span class="cp">#ifndef CONFIG_PM_RUNTIME</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pdmac</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amba_id</span> <span class="n">pl330_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mh">0x00041330</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x000fffff</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">amba</span><span class="p">,</span> <span class="n">pl330_ids</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl330_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdmac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get dmac</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl330_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_pl330_dmac</span> <span class="o">*</span><span class="n">pdmac</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdmac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get dmac</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">pdmac</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define pl330_runtime_suspend	NULL</span>
<span class="cp">#define pl330_runtime_resume	NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM_RUNTIME */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">pl330_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">pl330_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">pl330_runtime_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amba_driver</span> <span class="n">pl330_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">drv</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dma-pl330&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl330_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">pl330_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pl330_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">pl330_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_amba_driver</span><span class="p">(</span><span class="n">pl330_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaswinder Singh &lt;jassi.brar@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;API Driver for PL330 DMAC&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
