<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › virtio › virtio_mmio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>virtio_mmio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Virtio memory mapped device driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2011, ARM Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This module allows virtio devices to be used over a virtual, memory mapped</span>
<span class="cm"> * platform device.</span>
<span class="cm"> *</span>
<span class="cm"> * The guest device(s) may be instantiated in one of three equivalent ways:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Static platform device in board&#39;s code, eg.:</span>
<span class="cm"> *</span>
<span class="cm"> *	static struct platform_device v2m_virtio_device = {</span>
<span class="cm"> *		.name = &quot;virtio-mmio&quot;,</span>
<span class="cm"> *		.id = -1,</span>
<span class="cm"> *		.num_resources = 2,</span>
<span class="cm"> *		.resource = (struct resource []) {</span>
<span class="cm"> *			{</span>
<span class="cm"> *				.start = 0x1001e000,</span>
<span class="cm"> *				.end = 0x1001e0ff,</span>
<span class="cm"> *				.flags = IORESOURCE_MEM,</span>
<span class="cm"> *			}, {</span>
<span class="cm"> *				.start = 42 + 32,</span>
<span class="cm"> *				.end = 42 + 32,</span>
<span class="cm"> *				.flags = IORESOURCE_IRQ,</span>
<span class="cm"> *			},</span>
<span class="cm"> *		}</span>
<span class="cm"> *	};</span>
<span class="cm"> *</span>
<span class="cm"> * 2. Device Tree node, eg.:</span>
<span class="cm"> *</span>
<span class="cm"> *		virtio_block@1e000 {</span>
<span class="cm"> *			compatible = &quot;virtio,mmio&quot;;</span>
<span class="cm"> *			reg = &lt;0x1e000 0x100&gt;;</span>
<span class="cm"> *			interrupts = &lt;42&gt;;</span>
<span class="cm"> *		}</span>
<span class="cm"> *</span>
<span class="cm"> * 3. Kernel module (or command line) parameter. Can be used more than once -</span>
<span class="cm"> *    one device will be created for each one. Syntax:</span>
<span class="cm"> *</span>
<span class="cm"> *		[virtio_mmio.]device=&lt;size&gt;@&lt;baseaddr&gt;:&lt;irq&gt;[:&lt;id&gt;]</span>
<span class="cm"> *    where:</span>
<span class="cm"> *		&lt;size&gt;     := size (can use standard suffixes like K, M or G)</span>
<span class="cm"> *		&lt;baseaddr&gt; := physical base address</span>
<span class="cm"> *		&lt;irq&gt;      := interrupt number (as passed to request_irq())</span>
<span class="cm"> *		&lt;id&gt;       := (optional) platform device id</span>
<span class="cm"> *    eg.:</span>
<span class="cm"> *		virtio_mmio.device=0x100@0x100b0000:48 \</span>
<span class="cm"> *				virtio_mmio.device=1K@0x1001e000:74</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Registers layout (all 32-bit wide):</span>
<span class="cm"> *</span>
<span class="cm"> * offset d. name             description</span>
<span class="cm"> * ------ -- ---------------- -----------------</span>
<span class="cm"> *</span>
<span class="cm"> * 0x000  R  MagicValue       Magic value &quot;virt&quot;</span>
<span class="cm"> * 0x004  R  Version          Device version (current max. 1)</span>
<span class="cm"> * 0x008  R  DeviceID         Virtio device ID</span>
<span class="cm"> * 0x00c  R  VendorID         Virtio vendor ID</span>
<span class="cm"> *</span>
<span class="cm"> * 0x010  R  HostFeatures     Features supported by the host</span>
<span class="cm"> * 0x014  W  HostFeaturesSel  Set of host features to access via HostFeatures</span>
<span class="cm"> *</span>
<span class="cm"> * 0x020  W  GuestFeatures    Features activated by the guest</span>
<span class="cm"> * 0x024  W  GuestFeaturesSel Set of activated features to set via GuestFeatures</span>
<span class="cm"> * 0x028  W  GuestPageSize    Size of guest&#39;s memory page in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * 0x030  W  QueueSel         Queue selector</span>
<span class="cm"> * 0x034  R  QueueNumMax      Maximum size of the currently selected queue</span>
<span class="cm"> * 0x038  W  QueueNum         Queue size for the currently selected queue</span>
<span class="cm"> * 0x03c  W  QueueAlign       Used Ring alignment for the current queue</span>
<span class="cm"> * 0x040  RW QueuePFN         PFN for the currently selected queue</span>
<span class="cm"> *</span>
<span class="cm"> * 0x050  W  QueueNotify      Queue notifier</span>
<span class="cm"> * 0x060  R  InterruptStatus  Interrupt status register</span>
<span class="cm"> * 0x060  W  InterruptACK     Interrupt acknowledge register</span>
<span class="cm"> * 0x070  RW Status           Device status register</span>
<span class="cm"> *</span>
<span class="cm"> * 0x100+ RW                  Device-specific configuration space</span>
<span class="cm"> *</span>
<span class="cm"> * Based on Virtio PCI driver by Anthony Liguori, copyright IBM Corp. 2007</span>
<span class="cm"> *</span>
<span class="cm"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span>
<span class="cm"> * See the COPYING file in the top-level directory.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;virtio-mmio: &quot; fmt</span>

<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/virtio.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_config.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_mmio.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_ring.h&gt;</span>



<span class="cm">/* The alignment to use between consumer and producer parts of vring.</span>
<span class="cm"> * Currently hardcoded to the page size. */</span>
<span class="cp">#define VIRTIO_MMIO_VRING_ALIGN		PAGE_SIZE</span>



<span class="cp">#define to_virtio_mmio_device(_plat_dev) \</span>
<span class="cp">	container_of(_plat_dev, struct virtio_mmio_device, vdev)</span>

<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_device</span> <span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">version</span><span class="p">;</span>

	<span class="cm">/* a list of queues so we can dispatch IRQs */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">virtqueues</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">virtio_mmio_vq_info</span> <span class="p">{</span>
	<span class="cm">/* the actual virtqueue */</span>
	<span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">;</span>

	<span class="cm">/* the number of entries in the queue */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

	<span class="cm">/* the index of the queue */</span>
	<span class="kt">int</span> <span class="n">queue_index</span><span class="p">;</span>

	<span class="cm">/* the virtual address of the ring queue */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>

	<span class="cm">/* the list node for the virtqueues list */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
<span class="p">};</span>



<span class="cm">/* Configuration interface */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">vm_get_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="cm">/* TODO: Features &gt; 32 bits */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_HOST_FEATURES_SEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_HOST_FEATURES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_finalize_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Give virtio_ring a chance to accept features. */</span>
	<span class="n">vring_transport_features</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_GUEST_FEATURES_SEL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_GUEST_FEATURES</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span>
		   <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_CONFIG</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_CONFIG</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">vm_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_set_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="cm">/* We should never be setting status to 0. */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_STATUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="cm">/* 0 status means a reset. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_STATUS</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/* Transport interface */</span>

<span class="cm">/* the notify function used when creating a virt queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_vq_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* We write the queue&#39;s selector into the notification register to</span>
<span class="cm">	 * signal the other end */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_NOTIFY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Notify all virtqueues on an interrupt. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vm_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_vq_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_driver</span> <span class="o">*</span><span class="n">vdrv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">virtio_driver</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/* Read and acknowledge interrupts */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_INTERRUPT_STATUS</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_INTERRUPT_ACK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VIRTIO_MMIO_INT_CONFIG</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">vdrv</span> <span class="o">&amp;&amp;</span> <span class="n">vdrv</span><span class="o">-&gt;</span><span class="n">config_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdrv</span><span class="o">-&gt;</span><span class="n">config_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VIRTIO_MMIO_INT_VRING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">virtqueues</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">vring_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_del_vq</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_vq_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">vring_del_virtqueue</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>

	<span class="cm">/* Select and deactivate the queue */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_SEL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_PFN</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">vring_size</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">VIRTIO_MMIO_VRING_ALIGN</span><span class="p">));</span>
	<span class="n">free_pages_exact</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_del_vqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vqs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">vm_del_vq</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">vm_dev</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="nf">vm_setup_vq</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">index</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">),</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_vq_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Select the queue we&#39;re interested in */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_SEL</span><span class="p">);</span>

	<span class="cm">/* Queue shouldn&#39;t already be set up. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_PFN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_available</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate and fill out our active queue description */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_kmalloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Allocate pages for the queue - start with a queue as big as</span>
<span class="cm">	 * possible (limited by maximum size allowed by device), drop down</span>
<span class="cm">	 * to a minimal size, just big enough to fit descriptor table</span>
<span class="cm">	 * and two rings (which makes it &quot;alignment_size * 2&quot;)</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_NUM_MAX</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">vring_size</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span>
				<span class="n">VIRTIO_MMIO_VRING_ALIGN</span><span class="p">));</span>
		<span class="cm">/* Already smallest possible allocation? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">VIRTIO_MMIO_VRING_ALIGN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_alloc_pages</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">alloc_pages_exact</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Activate the queue */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_NUM</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">VIRTIO_MMIO_VRING_ALIGN</span><span class="p">,</span>
			<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_ALIGN</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
			<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_PFN</span><span class="p">);</span>

	<span class="cm">/* Create the vring */</span>
	<span class="n">vq</span> <span class="o">=</span> <span class="n">vring_new_virtqueue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">VIRTIO_MMIO_VRING_ALIGN</span><span class="p">,</span> <span class="n">vdev</span><span class="p">,</span>
				 <span class="nb">true</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">vm_notify</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_new_virtqueue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">vq</span> <span class="o">=</span> <span class="n">vq</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">virtqueues</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vq</span><span class="p">;</span>

<span class="nl">error_new_virtqueue:</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_QUEUE_PFN</span><span class="p">);</span>
	<span class="n">free_pages_exact</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="nl">error_alloc_pages:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="nl">error_kmalloc:</span>
<span class="nl">error_available:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vm_find_vqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nvqs</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vqs</span><span class="p">[],</span>
		       <span class="n">vq_callback_t</span> <span class="o">*</span><span class="n">callbacks</span><span class="p">[],</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">vm_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">vm_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvqs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vm_setup_vq</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vqs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">vm_del_vqs</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vqs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">vm_bus_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">to_virtio_mmio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">virtio_config_ops</span> <span class="n">virtio_mmio_config_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get</span>		<span class="o">=</span> <span class="n">vm_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>		<span class="o">=</span> <span class="n">vm_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span>	<span class="o">=</span> <span class="n">vm_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_status</span>	<span class="o">=</span> <span class="n">vm_set_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>		<span class="o">=</span> <span class="n">vm_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">find_vqs</span>	<span class="o">=</span> <span class="n">vm_find_vqs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_vqs</span>	<span class="o">=</span> <span class="n">vm_del_vqs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_features</span>	<span class="o">=</span> <span class="n">vm_get_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finalize_features</span> <span class="o">=</span> <span class="n">vm_finalize_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_name</span>	<span class="o">=</span> <span class="n">vm_bus_name</span><span class="p">,</span>
<span class="p">};</span>



<span class="cm">/* Platform device */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">virtio_mmio_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">magic</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">mem</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">vm_dev</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vm_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vm_dev</span><span class="p">)</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">virtio_mmio_config_ops</span><span class="p">;</span>
	<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">virtqueues</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Check magic value */</span>
	<span class="n">magic</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_MAGIC_VALUE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">magic</span><span class="p">,</span> <span class="s">&quot;virt&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wrong magic value 0x%08lx!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">magic</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check device version */</span>
	<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Version %ld not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_DEVICE_ID</span><span class="p">);</span>
	<span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_VENDOR_ID</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">VIRTIO_MMIO_GUEST_PAGE_SIZE</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vm_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">register_virtio_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">virtio_mmio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_mmio_device</span> <span class="o">*</span><span class="n">vm_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">unregister_virtio_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* Devices list parameter */</span>

<span class="cp">#if defined(CONFIG_VIRTIO_MMIO_CMDLINE_DEVICES)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="n">vm_cmdline_parent</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_name</span> <span class="o">=</span> <span class="s">&quot;virtio-mmio-cmdline&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vm_cmdline_parent_registered</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vm_cmdline_id</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vm_cmdline_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">resources</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">processed</span><span class="p">,</span> <span class="n">consumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="n">resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">;</span>

	<span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">memparse</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">processed</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;@%lli:%u%n:%d%n&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">consumed</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">vm_cmdline_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">consumed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">processed</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">processed</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">str</span><span class="p">[</span><span class="n">consumed</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">+=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vm_cmdline_parent_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_cmdline_parent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register parent device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vm_cmdline_parent_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Registering device virtio-mmio.%d at 0x%llx-0x%llx, IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vm_cmdline_id</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">);</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_resndata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_cmdline_parent</span><span class="p">,</span>
			<span class="s">&quot;virtio-mmio&quot;</span><span class="p">,</span> <span class="n">vm_cmdline_id</span><span class="o">++</span><span class="p">,</span>
			<span class="n">resources</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">resources</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vm_cmdline_get_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;0x%llx@0x%llx:%llu:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1ULL</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vm_cmdline_get</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">device_for_each_child</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_cmdline_parent</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
			<span class="n">vm_cmdline_get_device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kernel_param_ops</span> <span class="n">vm_cmdline_param_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">vm_cmdline_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">vm_cmdline_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">device_param_cb</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vm_cmdline_param_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vm_unregister_cmdline_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_unregister_cmdline_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vm_cmdline_parent_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_for_each_child</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_cmdline_parent</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">vm_unregister_cmdline_device</span><span class="p">);</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_cmdline_parent</span><span class="p">);</span>
		<span class="n">vm_cmdline_parent_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vm_unregister_cmdline_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* Platform driver */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">virtio_mmio_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;virtio,mmio&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">virtio_mmio_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">virtio_mmio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">virtio_mmio_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">virtio_mmio_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;virtio-mmio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span>	<span class="o">=</span> <span class="n">virtio_mmio_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">virtio_mmio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_mmio_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">virtio_mmio_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_mmio_driver</span><span class="p">);</span>
	<span class="n">vm_unregister_cmdline_devices</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">virtio_mmio_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">virtio_mmio_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pawel Moll &lt;pawel.moll@arm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Platform bus driver for memory mapped virtio devices&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
