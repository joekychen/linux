<!DOCTYPE html>
<html><head><title>joekychen/linux » include › scsi › fc_encode.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>fc_encode.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright(c) 2008 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Maintained at www.Open-FCoE.org</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _FC_ENCODE_H_</span>
<span class="cp">#define _FC_ENCODE_H_</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * F_CTL values for simple requests and responses.</span>
<span class="cm"> */</span>
<span class="cp">#define FC_FCTL_REQ	(FC_FC_FIRST_SEQ | FC_FC_END_SEQ | FC_FC_SEQ_INIT)</span>
<span class="cp">#define FC_FCTL_RESP	(FC_FC_EX_CTX | FC_FC_LAST_SEQ | \</span>
<span class="cp">			FC_FC_END_SEQ | FC_FC_SEQ_INIT)</span>

<span class="k">struct</span> <span class="n">fc_ns_rft</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_ns_fid</span> <span class="n">fid</span><span class="p">;</span>	<span class="cm">/* port ID object */</span>
	<span class="k">struct</span> <span class="n">fc_ns_fts</span> <span class="n">fts</span><span class="p">;</span>	<span class="cm">/* FC4-types object */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fc_ct_req</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_ct_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_ns_gid_ft</span> <span class="n">gid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_ns_rn_id</span>  <span class="n">rn</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_ns_rft</span> <span class="n">rft</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_ns_rff_id</span> <span class="n">rff</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_ns_fid</span> <span class="n">fid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_ns_rsnn</span> <span class="n">snn</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_ns_rspn</span> <span class="n">spn</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_fdmi_rhba</span> <span class="n">rhba</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_fdmi_rpa</span>  <span class="n">rpa</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_fdmi_dprt</span> <span class="n">dprt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_fdmi_dhba</span> <span class="n">dhba</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">payload</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__fc_fill_fc_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">fc_rctl</span> <span class="n">r_ctl</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">did</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sid</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_fh_type</span> <span class="n">type</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">f_ctl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">parm_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">r_ctl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">=</span> <span class="n">r_ctl</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">,</span> <span class="n">did</span><span class="p">);</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_s_id</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_f_ctl</span><span class="p">,</span> <span class="n">f_ctl</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_cs_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_df_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_parm_offset</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">parm_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fill FC header fields in specified fc_frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_fill_fc_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_rctl</span> <span class="n">r_ctl</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">did</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sid</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_fh_type</span> <span class="n">type</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">f_ctl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">parm_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">__fc_fill_fc_hdr</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">r_ctl</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">f_ctl</span><span class="p">,</span> <span class="n">parm_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_adisc_fill() - Fill in adisc request frame</span>
<span class="cm"> * @lport: local port.</span>
<span class="cm"> * @fp: fc frame where payload will be placed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_adisc_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_adisc</span> <span class="o">*</span><span class="n">adisc</span><span class="p">;</span>

	<span class="n">adisc</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adisc</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">adisc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adisc</span><span class="p">));</span>
	<span class="n">adisc</span><span class="o">-&gt;</span><span class="n">adisc_cmd</span> <span class="o">=</span> <span class="n">ELS_ADISC</span><span class="p">;</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adisc</span><span class="o">-&gt;</span><span class="n">adisc_wwpn</span><span class="p">);</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adisc</span><span class="o">-&gt;</span><span class="n">adisc_wwnn</span><span class="p">);</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">adisc</span><span class="o">-&gt;</span><span class="n">adisc_port_id</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_ct_hdr_fill- fills ct header and reset ct payload</span>
<span class="cm"> * returns pointer to ct request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">fc_ct_req</span> <span class="o">*</span><span class="nf">fc_ct_hdr_fill</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">req_size</span><span class="p">,</span>
					       <span class="k">enum</span> <span class="n">fc_ct_fs_type</span> <span class="n">fs_type</span><span class="p">,</span>
					       <span class="n">u8</span> <span class="n">subtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_ct_req</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ct_plen</span><span class="p">;</span>

	<span class="n">ct_plen</span>  <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ct_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">req_size</span><span class="p">;</span>
	<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ct_plen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ct_plen</span><span class="p">);</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ct_rev</span> <span class="o">=</span> <span class="n">FC_CT_REV</span><span class="p">;</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ct_fs_type</span> <span class="o">=</span> <span class="n">fs_type</span><span class="p">;</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ct_fs_subtype</span> <span class="o">=</span> <span class="n">subtype</span><span class="p">;</span>
	<span class="n">ct</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ct_cmd</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">op</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ct</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_ct_ns_fill() - Fill in a name service request frame</span>
<span class="cm"> * @lport: local port.</span>
<span class="cm"> * @fc_id: FC_ID of non-destination rport for GPN_ID and similar inquiries.</span>
<span class="cm"> * @fp: frame to contain payload.</span>
<span class="cm"> * @op: CT opcode.</span>
<span class="cm"> * @r_ctl: pointer to FC header R_CTL.</span>
<span class="cm"> * @fh_type: pointer to FC-4 type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fc_ct_ns_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">fc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_rctl</span> <span class="o">*</span><span class="n">r_ctl</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">fc_fh_type</span> <span class="o">*</span><span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_ct_req</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_NS_GPN_FT</span>:
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_gid_ft</span><span class="p">),</span>
				    <span class="n">FC_FST_DIR</span><span class="p">,</span> <span class="n">FC_NS_SUBTYPE</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">gid</span><span class="p">.</span><span class="n">fn_fc4_type</span> <span class="o">=</span> <span class="n">FC_TYPE_FCP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_NS_GPN_ID</span>:
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_fid</span><span class="p">),</span>
				    <span class="n">FC_FST_DIR</span><span class="p">,</span> <span class="n">FC_NS_SUBTYPE</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">gid</span><span class="p">.</span><span class="n">fn_fc4_type</span> <span class="o">=</span> <span class="n">FC_TYPE_FCP</span><span class="p">;</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">fid</span><span class="p">.</span><span class="n">fp_fid</span><span class="p">,</span> <span class="n">fc_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_NS_RFT_ID</span>:
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rft</span><span class="p">),</span>
				    <span class="n">FC_FST_DIR</span><span class="p">,</span> <span class="n">FC_NS_SUBTYPE</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rft</span><span class="p">.</span><span class="n">fid</span><span class="p">.</span><span class="n">fp_fid</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rft</span><span class="p">.</span><span class="n">fts</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcts</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_NS_RFF_ID</span>:
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rff_id</span><span class="p">),</span>
				    <span class="n">FC_FST_DIR</span><span class="p">,</span> <span class="n">FC_NS_SUBTYPE</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rff</span><span class="p">.</span><span class="n">fr_fid</span><span class="p">.</span><span class="n">fp_fid</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rff</span><span class="p">.</span><span class="n">fr_type</span> <span class="o">=</span> <span class="n">FC_TYPE_FCP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">service_params</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_INIT_FCN</span><span class="p">)</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rff</span><span class="p">.</span><span class="n">fr_feat</span> <span class="o">=</span> <span class="n">FCP_FEAT_INIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">service_params</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_TARG_FCN</span><span class="p">)</span>
			<span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rff</span><span class="p">.</span><span class="n">fr_feat</span> <span class="o">|=</span> <span class="n">FCP_FEAT_TARG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_NS_RNN_ID</span>:
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rn_id</span><span class="p">),</span>
				    <span class="n">FC_FST_DIR</span><span class="p">,</span> <span class="n">FC_NS_SUBTYPE</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rn</span><span class="p">.</span><span class="n">fr_fid</span><span class="p">.</span><span class="n">fp_fid</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rn</span><span class="p">.</span><span class="n">fr_wwn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_NS_RSPN_ID</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rspn</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
				    <span class="n">FC_FST_DIR</span><span class="p">,</span> <span class="n">FC_NS_SUBTYPE</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">spn</span><span class="p">.</span><span class="n">fr_fid</span><span class="p">.</span><span class="n">fp_fid</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">spn</span><span class="p">.</span><span class="n">fr_name</span><span class="p">,</span>
			<span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">spn</span><span class="p">.</span><span class="n">fr_name_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_NS_RSNN_NN</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rsnn</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
				    <span class="n">FC_FST_DIR</span><span class="p">,</span> <span class="n">FC_NS_SUBTYPE</span><span class="p">);</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">snn</span><span class="p">.</span><span class="n">fr_wwn</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">snn</span><span class="p">.</span><span class="n">fr_name</span><span class="p">,</span>
			<span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">snn</span><span class="p">.</span><span class="n">fr_name_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">r_ctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_UNSOL_CTL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fh_type</span> <span class="o">=</span> <span class="n">FC_TYPE_CT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_ct_ms_fill() - Fill in a mgmt service request frame</span>
<span class="cm"> * @lport: local port.</span>
<span class="cm"> * @fc_id: FC_ID of non-destination rport for GPN_ID and similar inquiries.</span>
<span class="cm"> * @fp: frame to contain payload.</span>
<span class="cm"> * @op: CT opcode.</span>
<span class="cm"> * @r_ctl: pointer to FC header R_CTL.</span>
<span class="cm"> * @fh_type: pointer to FC-4 type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fc_ct_ms_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">fc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_rctl</span> <span class="o">*</span><span class="n">r_ctl</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">fc_fh_type</span> <span class="o">*</span><span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_ct_req</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fs_fdmi_attrs</span> <span class="o">*</span><span class="n">hba_attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numattrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_FDMI_RHBA</span>:
		<span class="n">numattrs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_rhba</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">numattrs</span> <span class="o">*</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_NODENAME_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MANUFACTURER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_SERIALNUMBER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MODEL_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MODELDESCR_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_HARDWAREVERSION_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_DRIVERVERSION_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_OPTIONROMVERSION_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_FIRMWAREVERSION_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_OSNAMEVERSION_LEN</span><span class="p">;</span>
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">FC_FST_MGMT</span><span class="p">,</span>
				    <span class="n">FC_FDMI_SUBTYPE</span><span class="p">);</span>

		<span class="cm">/* HBA Identifier */</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hbaid</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="cm">/* Number of Ports - always 1 */</span>
		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">numport</span><span class="p">);</span>
		<span class="cm">/* Port Name */</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">portname</span><span class="p">);</span>

		<span class="cm">/* HBA Attributes */</span>
		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">numattrs</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_attrs</span><span class="p">.</span><span class="n">numattrs</span><span class="p">);</span>
		<span class="n">hba_attrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rhba</span><span class="p">.</span><span class="n">hba_attrs</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">hba_attrs</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>
		<span class="cm">/* NodeName*/</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_NODENAME_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_NODENAME</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/* Manufacturer */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_NODENAME_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MANUFACTURER_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_MANUFACTURER</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">fc_host_manufacturer</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
			<span class="n">FC_FDMI_HBA_ATTR_MANUFACTURER_LEN</span><span class="p">);</span>

		<span class="cm">/* SerialNumber */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_MANUFACTURER_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_SERIALNUMBER_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_SERIALNUMBER</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">fc_host_serial_number</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
			<span class="n">FC_FDMI_HBA_ATTR_SERIALNUMBER_LEN</span><span class="p">);</span>

		<span class="cm">/* Model */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_SERIALNUMBER_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MODEL_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_MODEL</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">fc_host_model</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
			<span class="n">FC_FDMI_HBA_ATTR_MODEL_LEN</span><span class="p">);</span>

		<span class="cm">/* Model Description */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_MODEL_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MODELDESCR_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_MODELDESCRIPTION</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">fc_host_model_description</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
			<span class="n">FC_FDMI_HBA_ATTR_MODELDESCR_LEN</span><span class="p">);</span>

		<span class="cm">/* Hardware Version */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_MODELDESCR_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_HARDWAREVERSION_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_HARDWAREVERSION</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">fc_host_hardware_version</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
			<span class="n">FC_FDMI_HBA_ATTR_HARDWAREVERSION_LEN</span><span class="p">);</span>

		<span class="cm">/* Driver Version */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_HARDWAREVERSION_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_DRIVERVERSION_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_DRIVERVERSION</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">fc_host_driver_version</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
			<span class="n">FC_FDMI_HBA_ATTR_DRIVERVERSION_LEN</span><span class="p">);</span>

		<span class="cm">/* OptionROM Version */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_DRIVERVERSION_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_OPTIONROMVERSION_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_OPTIONROMVERSION</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">fc_host_optionrom_version</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
			<span class="n">FC_FDMI_HBA_ATTR_OPTIONROMVERSION_LEN</span><span class="p">);</span>

		<span class="cm">/* Firmware Version */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_OPTIONROMVERSION_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_FIRMWAREVERSION_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_FIRMWAREVERSION</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">fc_host_firmware_version</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
			<span class="n">FC_FDMI_HBA_ATTR_FIRMWAREVERSION_LEN</span><span class="p">);</span>

		<span class="cm">/* OS Name and Version */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_HBA_ATTR_FIRMWAREVERSION_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_OSNAMEVERSION_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_HBA_ATTR_OSNAMEVERSION</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">FC_FDMI_HBA_ATTR_OSNAMEVERSION_LEN</span><span class="p">,</span>
			<span class="s">&quot;%s v%s&quot;</span><span class="p">,</span>
			<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sysname</span><span class="p">,</span>
			<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_FDMI_RPA</span>:
		<span class="n">numattrs</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_rpa</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">numattrs</span> <span class="o">*</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_FC4TYPES_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_SUPPORTEDSPEED_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_CURRENTPORTSPEED_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_MAXFRAMESIZE_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_OSDEVICENAME_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_HOSTNAME_LEN</span><span class="p">;</span>
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">FC_FST_MGMT</span><span class="p">,</span>
				    <span class="n">FC_FDMI_SUBTYPE</span><span class="p">);</span>

		<span class="cm">/* Port Name */</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">portname</span><span class="p">);</span>

		<span class="cm">/* Port Attributes */</span>
		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">numattrs</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">hba_attrs</span><span class="p">.</span><span class="n">numattrs</span><span class="p">);</span>

		<span class="n">hba_attrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">rpa</span><span class="p">.</span><span class="n">hba_attrs</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">hba_attrs</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>

		<span class="cm">/* FC4 types */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_FC4TYPES_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_PORT_ATTR_FC4TYPES</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
		       <span class="n">FC_FDMI_PORT_ATTR_FC4TYPES_LEN</span><span class="p">);</span>

		<span class="cm">/* Supported Speed */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_PORT_ATTR_FC4TYPES_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_SUPPORTEDSPEED_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_PORT_ATTR_SUPPORTEDSPEED</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

		<span class="cm">/* Current Port Speed */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_PORT_ATTR_SUPPORTEDSPEED_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_CURRENTPORTSPEED_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_PORT_ATTR_CURRENTPORTSPEED</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_speed</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

		<span class="cm">/* Max Frame Size */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_PORT_ATTR_CURRENTPORTSPEED_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_MAXFRAMESIZE_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_PORT_ATTR_MAXFRAMESIZE</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">fc_host_maxframe_size</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

		<span class="cm">/* OS Device Name */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_PORT_ATTR_MAXFRAMESIZE_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_OSDEVICENAME_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_PORT_ATTR_OSDEVICENAME</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="cm">/* Use the sysfs device name */</span>
		<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">),</span>
			<span class="n">strnlen</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">),</span>
				<span class="n">FC_FDMI_PORT_ATTR_HOSTNAME_LEN</span><span class="p">));</span>

		<span class="cm">/* Host Name */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span>
					<span class="n">FC_FDMI_PORT_ATTR_OSDEVICENAME_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_HOSTNAME_LEN</span><span class="p">;</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">FC_FDMI_PORT_ATTR_HOSTNAME</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">fc_host_system_hostname</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)))</span>
			<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
				<span class="n">fc_host_system_hostname</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
				<span class="n">strnlen</span><span class="p">(</span><span class="n">fc_host_system_hostname</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
					<span class="n">FC_FDMI_PORT_ATTR_HOSTNAME_LEN</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
				<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span>
				<span class="n">FC_FDMI_PORT_ATTR_HOSTNAME_LEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_FDMI_DPRT</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_dprt</span><span class="p">);</span>
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">FC_FST_MGMT</span><span class="p">,</span>
				    <span class="n">FC_FDMI_SUBTYPE</span><span class="p">);</span>
		<span class="cm">/* Port Name */</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">dprt</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">portname</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_FDMI_DHBA</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_dhba</span><span class="p">);</span>
		<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_ct_hdr_fill</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">FC_FST_MGMT</span><span class="p">,</span>
				    <span class="n">FC_FDMI_SUBTYPE</span><span class="p">);</span>
		<span class="cm">/* HBA Identifier */</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">dhba</span><span class="p">.</span><span class="n">hbaid</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">r_ctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_UNSOL_CTL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fh_type</span> <span class="o">=</span> <span class="n">FC_TYPE_CT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_ct_fill() - Fill in a common transport service request frame</span>
<span class="cm"> * @lport: local port.</span>
<span class="cm"> * @fc_id: FC_ID of non-destination rport for GPN_ID and similar inquiries.</span>
<span class="cm"> * @fp: frame to contain payload.</span>
<span class="cm"> * @op: CT opcode.</span>
<span class="cm"> * @r_ctl: pointer to FC header R_CTL.</span>
<span class="cm"> * @fh_type: pointer to FC-4 type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fc_ct_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">fc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_rctl</span> <span class="o">*</span><span class="n">r_ctl</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">fc_fh_type</span> <span class="o">*</span><span class="n">fh_type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fc_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_FID_MGMT_SERV</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fc_ct_ms_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fc_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">r_ctl</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">);</span>
		<span class="o">*</span><span class="n">did</span> <span class="o">=</span> <span class="n">FC_FID_MGMT_SERV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_FID_DIR_SERV</span>:
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fc_ct_ns_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fc_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">r_ctl</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">);</span>
		<span class="o">*</span><span class="n">did</span> <span class="o">=</span> <span class="n">FC_FID_DIR_SERV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * fc_plogi_fill - Fill in plogi request frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_plogi_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">plogi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_csp</span> <span class="o">*</span><span class="n">csp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_cssp</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">plogi</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">plogi</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">plogi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">plogi</span><span class="p">));</span>
	<span class="n">plogi</span><span class="o">-&gt;</span><span class="n">fl_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">);</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">);</span>

	<span class="n">csp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">;</span>
	<span class="n">csp</span><span class="o">-&gt;</span><span class="n">sp_hi_ver</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">csp</span><span class="o">-&gt;</span><span class="n">sp_lo_ver</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">csp</span><span class="o">-&gt;</span><span class="n">sp_bb_cred</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>	<span class="cm">/* this gets set by gateway */</span>
	<span class="n">csp</span><span class="o">-&gt;</span><span class="n">sp_bb_data</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plogi</span><span class="o">-&gt;</span><span class="n">fl_cssp</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* class 3 parameters */</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_class</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FC_CPC_VALID</span> <span class="o">|</span> <span class="n">FC_CPC_SEQ</span><span class="p">);</span>
	<span class="n">csp</span><span class="o">-&gt;</span><span class="n">sp_features</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FC_SP_FT_CIRO</span><span class="p">);</span>
	<span class="n">csp</span><span class="o">-&gt;</span><span class="n">sp_tot_seq</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>	<span class="cm">/* seq. we accept */</span>
	<span class="n">csp</span><span class="o">-&gt;</span><span class="n">sp_rel_off</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">csp</span><span class="o">-&gt;</span><span class="n">sp_e_d_tov</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">);</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_rdfs</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_con_seq</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_open_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_flogi_fill - Fill in a flogi request frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_flogi_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_csp</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_cssp</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">flogi</span><span class="p">;</span>

	<span class="n">flogi</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flogi</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">flogi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flogi</span><span class="p">));</span>
	<span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ELS_FLOGI</span><span class="p">;</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">);</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_hi_ver</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_lo_ver</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_bb_cred</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>	<span class="cm">/* this gets set by gateway */</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_bb_data</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_cssp</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* class 3 parameters */</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_class</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FC_CPC_VALID</span> <span class="o">|</span> <span class="n">FC_CPC_SEQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">does_npiv</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_features</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FC_SP_FT_NPIV</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_fdisc_fill - Fill in a fdisc request frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_fdisc_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_csp</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_cssp</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">fdisc</span><span class="p">;</span>

	<span class="n">fdisc</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fdisc</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fdisc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fdisc</span><span class="p">));</span>
	<span class="n">fdisc</span><span class="o">-&gt;</span><span class="n">fl_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ELS_FDISC</span><span class="p">;</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdisc</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">);</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdisc</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fdisc</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_hi_ver</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_lo_ver</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_bb_cred</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>	<span class="cm">/* this gets set by gateway */</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_bb_data</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fdisc</span><span class="o">-&gt;</span><span class="n">fl_cssp</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* class 3 parameters */</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_class</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FC_CPC_VALID</span> <span class="o">|</span> <span class="n">FC_CPC_SEQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_logo_fill - Fill in a logo request frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_logo_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">;</span>

	<span class="n">logo</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">logo</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">logo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">logo</span><span class="p">));</span>
	<span class="n">logo</span><span class="o">-&gt;</span><span class="n">fl_cmd</span> <span class="o">=</span> <span class="n">ELS_LOGO</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">logo</span><span class="o">-&gt;</span><span class="n">fl_n_port_id</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">logo</span><span class="o">-&gt;</span><span class="n">fl_n_port_wwn</span> <span class="o">=</span> <span class="n">htonll</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rtv_fill - Fill in RTV (read timeout value) request frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_rtv_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_rtv</span> <span class="o">*</span><span class="n">rtv</span><span class="p">;</span>

	<span class="n">rtv</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rtv</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rtv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rtv</span><span class="p">));</span>
	<span class="n">rtv</span><span class="o">-&gt;</span><span class="n">rtv_cmd</span> <span class="o">=</span> <span class="n">ELS_RTV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rec_fill - Fill in rec request frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_rec_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_rec</span> <span class="o">*</span><span class="n">rec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_exch</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">fc_seq_exch</span><span class="p">(</span><span class="n">fr_seq</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="n">rec</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rec</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rec</span><span class="p">));</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">rec_cmd</span> <span class="o">=</span> <span class="n">ELS_REC</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">rec_s_id</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">rec_ox_id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">oxid</span><span class="p">);</span>
	<span class="n">rec</span><span class="o">-&gt;</span><span class="n">rec_rx_id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_prli_fill - Fill in prli request frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_prli_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_els_prli</span> <span class="n">prli</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="n">spp</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_cmd</span> <span class="o">=</span> <span class="n">ELS_PRLI</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_spp_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_spp</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">.</span><span class="n">spp_type</span> <span class="o">=</span> <span class="n">FC_TYPE_FCP</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">.</span><span class="n">spp_flags</span> <span class="o">=</span> <span class="n">FC_SPP_EST_IMG_PAIR</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">.</span><span class="n">spp_params</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">service_params</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_scr_fill - Fill in a scr request frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fc_scr_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_scr</span> <span class="o">*</span><span class="n">scr</span><span class="p">;</span>

	<span class="n">scr</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scr</span><span class="p">));</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">scr_cmd</span> <span class="o">=</span> <span class="n">ELS_SCR</span><span class="p">;</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">scr_reg_func</span> <span class="o">=</span> <span class="n">ELS_SCRF_FULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_els_fill - Fill in an ELS  request frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fc_els_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">did</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">fc_rctl</span> <span class="o">*</span><span class="n">r_ctl</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_fh_type</span> <span class="o">*</span><span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ELS_ADISC</span>:
		<span class="n">fc_adisc_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ELS_PLOGI</span>:
		<span class="n">fc_plogi_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_PLOGI</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ELS_FLOGI</span>:
		<span class="n">fc_flogi_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ELS_FDISC</span>:
		<span class="n">fc_fdisc_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ELS_LOGO</span>:
		<span class="n">fc_logo_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ELS_RTV</span>:
		<span class="n">fc_rtv_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ELS_REC</span>:
		<span class="n">fc_rec_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ELS_PRLI</span>:
		<span class="n">fc_prli_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ELS_SCR</span>:
		<span class="n">fc_scr_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">r_ctl</span> <span class="o">=</span> <span class="n">FC_RCTL_ELS_REQ</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fh_type</span> <span class="o">=</span> <span class="n">FC_TYPE_ELS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* _FC_ENCODE_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
