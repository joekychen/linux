<!DOCTYPE html>
<html><head><title>joekychen/linux » include › scsi › osd_protocol.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>osd_protocol.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * osd_protocol.h - OSD T10 standard C definitions.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Panasas Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Boaz Harrosh &lt;bharrosh@panasas.com&gt;</span>
<span class="cm"> *   Benny Halevy &lt;bhalevy@panasas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains types and constants that are defined by the protocol</span>
<span class="cm"> * Note: All names and symbols are taken from the OSD standard&#39;s text.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __OSD_PROTOCOL_H__</span>
<span class="cp">#define __OSD_PROTOCOL_H__</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSDv1_ADDITIONAL_CDB_LENGTH</span> <span class="o">=</span> <span class="mi">192</span><span class="p">,</span>
	<span class="n">OSDv1_TOTAL_CDB_LEN</span> <span class="o">=</span> <span class="n">OSDv1_ADDITIONAL_CDB_LENGTH</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">OSDv1_CAP_LEN</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>

	<span class="cm">/* Latest supported version */</span>
	<span class="n">OSDv2_ADDITIONAL_CDB_LENGTH</span> <span class="o">=</span> <span class="mi">228</span><span class="p">,</span>
	<span class="n">OSD_ADDITIONAL_CDB_LENGTH</span> <span class="o">=</span>
		<span class="n">OSDv2_ADDITIONAL_CDB_LENGTH</span><span class="p">,</span>
	<span class="n">OSD_TOTAL_CDB_LEN</span> <span class="o">=</span> <span class="n">OSD_ADDITIONAL_CDB_LENGTH</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">OSD_CAP_LEN</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span>

	<span class="n">OSD_SYSTEMID_LEN</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="n">OSDv1_CRYPTO_KEYID_SIZE</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="n">OSDv2_CRYPTO_KEYID_SIZE</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="n">OSD_CRYPTO_KEYID_SIZE</span> <span class="o">=</span> <span class="n">OSDv2_CRYPTO_KEYID_SIZE</span><span class="p">,</span>
	<span class="n">OSD_CRYPTO_SEED_SIZE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">OSD_CRYPTO_NONCE_SIZE</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="n">OSD_MAX_SENSE_LEN</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span> <span class="cm">/* from SPC-3 */</span>

	<span class="n">OSD_PARTITION_FIRST_ID</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
	<span class="n">OSD_OBJECT_FIRST_ID</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* (osd-r10 5.2.4)</span>
<span class="cm"> * osd2r03: 5.2.3 Caching control bits</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">osd_options_byte</span> <span class="p">{</span>
	<span class="n">OSD_CDB_FUA</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="cm">/* Force Unit Access */</span>
	<span class="n">OSD_CDB_DPO</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/* Disable Page Out */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * osd2r03: 5.2.5 Isolation.</span>
<span class="cm"> * First 3 bits, V2-only.</span>
<span class="cm"> * Also for attr 110h &quot;default isolation method&quot; at Root Information page</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">osd_options_byte_isolation</span> <span class="p">{</span>
	<span class="n">OSD_ISOLATION_DEFAULT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OSD_ISOLATION_NONE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OSD_ISOLATION_STRICT</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">OSD_ISOLATION_RANGE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">OSD_ISOLATION_FUNCTIONAL</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">OSD_ISOLATION_VENDOR</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* (osd-r10: 6.7)</span>
<span class="cm"> * osd2r03: 6.8 FLUSH, FLUSH COLLECTION, FLUSH OSD, FLUSH PARTITION</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">osd_options_flush_scope_values</span> <span class="p">{</span>
	<span class="n">OSD_CDB_FLUSH_ALL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OSD_CDB_FLUSH_ATTR_ONLY</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="n">OSD_CDB_FLUSH_ALL_RECURSIVE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/* V2-only */</span>
	<span class="n">OSD_CDB_FLUSH_ALL_RANGE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* osd2r03: 5.2.10 Timestamps control */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSD_CDB_NORMAL_TIMESTAMPS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OSD_CDB_BYPASS_TIMESTAMPS</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* (osd-r10: 5.2.2.1)</span>
<span class="cm"> * osd2r03: 5.2.4.1 Get and set attributes CDB format selection</span>
<span class="cm"> *	2 bits at second nibble of command_specific_options byte</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">osd_attributes_mode</span> <span class="p">{</span>
	<span class="cm">/* V2-only */</span>
	<span class="n">OSD_CDB_SET_ONE_ATTR</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>

	<span class="n">OSD_CDB_GET_ATTR_PAGE_SET_ONE</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">OSD_CDB_GET_SET_ATTR_LISTS</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>

	<span class="n">OSD_CDB_GET_SET_ATTR_MASK</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* (osd-r10: 4.12.5)</span>
<span class="cm"> * osd2r03: 4.14.5 Data-In and Data-Out buffer offsets</span>
<span class="cm"> *	byte offset = mantissa * (2^(exponent+8))</span>
<span class="cm"> *	struct {</span>
<span class="cm"> *		unsigned mantissa: 28;</span>
<span class="cm"> *		int exponent: 04;</span>
<span class="cm"> *	}</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="n">__be32</span> <span class="n">__bitwise</span> <span class="n">osd_cdb_offset</span><span class="p">;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSD_OFFSET_UNUSED</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
	<span class="n">OSD_OFFSET_MAX_BITS</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span>

	<span class="n">OSDv1_OFFSET_MIN_SHIFT</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">OSD_OFFSET_MIN_SHIFT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">OSD_OFFSET_MAX_SHIFT</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Return the smallest allowed encoded offset that contains @offset.</span>
<span class="cm"> *</span>
<span class="cm"> * The actual encoded offset returned is @offset + *padding.</span>
<span class="cm"> * (up to max_shift, non-inclusive)</span>
<span class="cm"> */</span>
<span class="n">osd_cdb_offset</span> <span class="n">__osd_encode_offset</span><span class="p">(</span><span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">padding</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">min_shift</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_shift</span><span class="p">);</span>

<span class="cm">/* Minimum alignment is 256 bytes</span>
<span class="cm"> * Note: Seems from std v1 that exponent can be from 0+8 to 0xE+8 (inclusive)</span>
<span class="cm"> * which is 8 to 23 but IBM code restricts it to 16, so be it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">osd_cdb_offset</span> <span class="nf">osd_encode_offset_v1</span><span class="p">(</span><span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">padding</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__osd_encode_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span>
				<span class="n">OSDv1_OFFSET_MIN_SHIFT</span><span class="p">,</span> <span class="n">OSD_OFFSET_MAX_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Minimum 8 bytes alignment</span>
<span class="cm"> * Same as v1 but since exponent can be signed than a less than</span>
<span class="cm"> * 256 alignment can be reached with small offsets (&lt;2GB)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">osd_cdb_offset</span> <span class="nf">osd_encode_offset_v2</span><span class="p">(</span><span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">padding</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__osd_encode_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span>
				   <span class="n">OSD_OFFSET_MIN_SHIFT</span><span class="p">,</span> <span class="n">OSD_OFFSET_MAX_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* osd2r03: 5.2.1 Overview */</span>
<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_varlen_cdb_hdr</span> <span class="n">varlen_cdb</span><span class="p">;</span>
<span class="cm">/*10*/</span>	<span class="n">u8</span>		<span class="n">options</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">command_specific_options</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">timestamp_control</span><span class="p">;</span>
<span class="cm">/*13*/</span>	<span class="n">u8</span>		<span class="n">reserved1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="cm">/*16*/</span>	<span class="n">__be64</span>		<span class="n">partition</span><span class="p">;</span>
<span class="cm">/*24*/</span>	<span class="n">__be64</span>		<span class="n">object</span><span class="p">;</span>
<span class="cm">/*32*/</span>	<span class="k">union</span> <span class="p">{</span> <span class="cm">/* V1 vs V2 alignment differences */</span>
		<span class="k">struct</span> <span class="n">__osdv1_cdb_addr_len</span> <span class="p">{</span>
<span class="cm">/*32*/</span>			<span class="n">__be32</span> 		<span class="n">list_identifier</span><span class="p">;</span><span class="cm">/* Rarely used */</span>
<span class="cm">/*36*/</span>			<span class="n">__be64</span>		<span class="n">length</span><span class="p">;</span>
<span class="cm">/*44*/</span>			<span class="n">__be64</span>		<span class="n">start_address</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__packed</span> <span class="n">v1</span><span class="p">;</span>

		<span class="k">struct</span> <span class="n">__osdv2_cdb_addr_len</span> <span class="p">{</span>
			<span class="cm">/* called allocation_length in some commands */</span>
<span class="cm">/*32*/</span>			<span class="n">__be64</span>	<span class="n">length</span><span class="p">;</span>
<span class="cm">/*40*/</span>			<span class="n">__be64</span>	<span class="n">start_address</span><span class="p">;</span>
			<span class="k">union</span> <span class="p">{</span>
<span class="cm">/*48*/</span>				<span class="n">__be32</span> <span class="n">list_identifier</span><span class="p">;</span><span class="cm">/* Rarely used */</span>
				<span class="cm">/* OSD2r05 5.2.5 CDB continuation length */</span>
<span class="cm">/*48*/</span>				<span class="n">__be32</span> <span class="n">cdb_continuation_length</span><span class="p">;</span>
			<span class="p">};</span>
		<span class="p">}</span> <span class="n">__packed</span> <span class="n">v2</span><span class="p">;</span>
	<span class="p">};</span>
<span class="cm">/*52*/</span>	<span class="k">union</span> <span class="p">{</span> <span class="cm">/* selected attributes mode Page/List/Single */</span>
		<span class="k">struct</span> <span class="n">osd_attributes_page_mode</span> <span class="p">{</span>
<span class="cm">/*52*/</span>			<span class="n">__be32</span>		<span class="n">get_attr_page</span><span class="p">;</span>
<span class="cm">/*56*/</span>			<span class="n">__be32</span>		<span class="n">get_attr_alloc_length</span><span class="p">;</span>
<span class="cm">/*60*/</span>			<span class="n">osd_cdb_offset</span>	<span class="n">get_attr_offset</span><span class="p">;</span>

<span class="cm">/*64*/</span>			<span class="n">__be32</span>		<span class="n">set_attr_page</span><span class="p">;</span>
<span class="cm">/*68*/</span>			<span class="n">__be32</span>		<span class="n">set_attr_id</span><span class="p">;</span>
<span class="cm">/*72*/</span>			<span class="n">__be32</span>		<span class="n">set_attr_length</span><span class="p">;</span>
<span class="cm">/*76*/</span>			<span class="n">osd_cdb_offset</span>	<span class="n">set_attr_offset</span><span class="p">;</span>
<span class="cm">/*80*/</span>		<span class="p">}</span> <span class="n">__packed</span> <span class="n">attrs_page</span><span class="p">;</span>

		<span class="k">struct</span> <span class="n">osd_attributes_list_mode</span> <span class="p">{</span>
<span class="cm">/*52*/</span>			<span class="n">__be32</span>		<span class="n">get_attr_desc_bytes</span><span class="p">;</span>
<span class="cm">/*56*/</span>			<span class="n">osd_cdb_offset</span>	<span class="n">get_attr_desc_offset</span><span class="p">;</span>

<span class="cm">/*60*/</span>			<span class="n">__be32</span>		<span class="n">get_attr_alloc_length</span><span class="p">;</span>
<span class="cm">/*64*/</span>			<span class="n">osd_cdb_offset</span>	<span class="n">get_attr_offset</span><span class="p">;</span>

<span class="cm">/*68*/</span>			<span class="n">__be32</span>		<span class="n">set_attr_bytes</span><span class="p">;</span>
<span class="cm">/*72*/</span>			<span class="n">osd_cdb_offset</span>	<span class="n">set_attr_offset</span><span class="p">;</span>
			<span class="n">__be32</span> <span class="n">not_used</span><span class="p">;</span>
<span class="cm">/*80*/</span>		<span class="p">}</span> <span class="n">__packed</span> <span class="n">attrs_list</span><span class="p">;</span>

		<span class="cm">/* osd2r03:5.2.4.2 Set one attribute value using CDB fields */</span>
		<span class="k">struct</span> <span class="n">osd_attributes_cdb_mode</span> <span class="p">{</span>
<span class="cm">/*52*/</span>			<span class="n">__be32</span>		<span class="n">set_attr_page</span><span class="p">;</span>
<span class="cm">/*56*/</span>			<span class="n">__be32</span>		<span class="n">set_attr_id</span><span class="p">;</span>
<span class="cm">/*60*/</span>			<span class="n">__be16</span>		<span class="n">set_attr_len</span><span class="p">;</span>
<span class="cm">/*62*/</span>			<span class="n">u8</span>		<span class="n">set_attr_val</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
<span class="cm">/*80*/</span>		<span class="p">}</span> <span class="n">__packed</span> <span class="n">attrs_cdb</span><span class="p">;</span>
<span class="cm">/*52*/</span>		<span class="n">u8</span> <span class="n">get_set_attributes_parameters</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cm">/*80*/</span>

<span class="cm">/*160 v1*/</span>
<span class="k">struct</span> <span class="n">osdv1_security_parameters</span> <span class="p">{</span>
<span class="cm">/*160*/</span><span class="n">u8</span>	<span class="n">integrity_check_value</span><span class="p">[</span><span class="n">OSDv1_CRYPTO_KEYID_SIZE</span><span class="p">];</span>
<span class="cm">/*180*/</span><span class="n">u8</span>	<span class="n">request_nonce</span><span class="p">[</span><span class="n">OSD_CRYPTO_NONCE_SIZE</span><span class="p">];</span>
<span class="cm">/*192*/</span><span class="n">osd_cdb_offset</span>	<span class="n">data_in_integrity_check_offset</span><span class="p">;</span>
<span class="cm">/*196*/</span><span class="n">osd_cdb_offset</span>	<span class="n">data_out_integrity_check_offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cm">/*200 v1*/</span>

<span class="cm">/*184 v2*/</span>
<span class="k">struct</span> <span class="n">osdv2_security_parameters</span> <span class="p">{</span>
<span class="cm">/*184*/</span><span class="n">u8</span>	<span class="n">integrity_check_value</span><span class="p">[</span><span class="n">OSDv2_CRYPTO_KEYID_SIZE</span><span class="p">];</span>
<span class="cm">/*216*/</span><span class="n">u8</span>	<span class="n">request_nonce</span><span class="p">[</span><span class="n">OSD_CRYPTO_NONCE_SIZE</span><span class="p">];</span>
<span class="cm">/*228*/</span><span class="n">osd_cdb_offset</span>	<span class="n">data_in_integrity_check_offset</span><span class="p">;</span>
<span class="cm">/*232*/</span><span class="n">osd_cdb_offset</span>	<span class="n">data_out_integrity_check_offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cm">/*236 v2*/</span>

<span class="k">struct</span> <span class="n">osd_security_parameters</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv1_security_parameters</span> <span class="n">v1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">osdv2_security_parameters</span> <span class="n">v2</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">osdv1_cdb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">caps</span><span class="p">[</span><span class="n">OSDv1_CAP_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osdv1_security_parameters</span> <span class="n">sec_params</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">osdv2_cdb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">caps</span><span class="p">[</span><span class="n">OSD_CAP_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">osdv2_security_parameters</span> <span class="n">sec_params</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">osd_cdb</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv1_cdb</span> <span class="n">v1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">osdv2_cdb</span> <span class="n">v2</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">buff</span><span class="p">[</span><span class="n">OSD_TOTAL_CDB_LEN</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="nf">osd_cdb_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_cdb</span> <span class="o">*</span><span class="n">ocdb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="p">)</span><span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">buff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* define both version actions</span>
<span class="cm"> * Ex name = FORMAT_OSD we have OSD_ACT_FORMAT_OSD &amp;&amp; OSDv1_ACT_FORMAT_OSD</span>
<span class="cm"> */</span>
<span class="cp">#define OSD_ACT___(Name, Num) \</span>
<span class="cp">	OSD_ACT_##Name = __constant_cpu_to_be16(0x8880 + Num), \</span>
<span class="cp">	OSDv1_ACT_##Name = __constant_cpu_to_be16(0x8800 + Num),</span>

<span class="cm">/* V2 only actions */</span>
<span class="cp">#define OSD_ACT_V2(Name, Num) \</span>
<span class="cp">	OSD_ACT_##Name = __constant_cpu_to_be16(0x8880 + Num),</span>

<span class="cp">#define OSD_ACT_V1_V2(Name, Num1, Num2) \</span>
<span class="cp">	OSD_ACT_##Name = __constant_cpu_to_be16(Num2), \</span>
<span class="cp">	OSDv1_ACT_##Name = __constant_cpu_to_be16(Num1),</span>

<span class="k">enum</span> <span class="n">osd_service_actions</span> <span class="p">{</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">OBJECT_STRUCTURE_CHECK</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">FORMAT_OSD</span><span class="p">,</span>			<span class="mh">0x01</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">CREATE</span><span class="p">,</span>			<span class="mh">0x02</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">LIST</span><span class="p">,</span>			<span class="mh">0x03</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">PUNCH</span><span class="p">,</span>			<span class="mh">0x04</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span>			<span class="mh">0x05</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span>			<span class="mh">0x06</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">APPEND</span><span class="p">,</span>			<span class="mh">0x07</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">FLUSH</span><span class="p">,</span>			<span class="mh">0x08</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">CLEAR</span><span class="p">,</span>			<span class="mh">0x09</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">REMOVE</span><span class="p">,</span>			<span class="mh">0x0A</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">CREATE_PARTITION</span><span class="p">,</span>		<span class="mh">0x0B</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">REMOVE_PARTITION</span><span class="p">,</span>		<span class="mh">0x0C</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">GET_ATTRIBUTES</span><span class="p">,</span>		<span class="mh">0x0E</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">SET_ATTRIBUTES</span><span class="p">,</span>		<span class="mh">0x0F</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">CREATE_AND_WRITE</span><span class="p">,</span>		<span class="mh">0x12</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">CREATE_COLLECTION</span><span class="p">,</span>		<span class="mh">0x15</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">REMOVE_COLLECTION</span><span class="p">,</span>		<span class="mh">0x16</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">LIST_COLLECTION</span><span class="p">,</span>		<span class="mh">0x17</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">SET_KEY</span><span class="p">,</span>			<span class="mh">0x18</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">SET_MASTER_KEY</span><span class="p">,</span>		<span class="mh">0x19</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">FLUSH_COLLECTION</span><span class="p">,</span>		<span class="mh">0x1A</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">FLUSH_PARTITION</span><span class="p">,</span>		<span class="mh">0x1B</span><span class="p">)</span>
	<span class="n">OSD_ACT___</span><span class="p">(</span><span class="n">FLUSH_OSD</span><span class="p">,</span>			<span class="mh">0x1C</span><span class="p">)</span>

	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">QUERY</span><span class="p">,</span>			<span class="mh">0x20</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">REMOVE_MEMBER_OBJECTS</span><span class="p">,</span>	<span class="mh">0x21</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">GET_MEMBER_ATTRIBUTES</span><span class="p">,</span>	<span class="mh">0x22</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">SET_MEMBER_ATTRIBUTES</span><span class="p">,</span>	<span class="mh">0x23</span><span class="p">)</span>

	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">CREATE_CLONE</span><span class="p">,</span>		<span class="mh">0x28</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">CREATE_SNAPSHOT</span><span class="p">,</span>		<span class="mh">0x29</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">DETACH_CLONE</span><span class="p">,</span>		<span class="mh">0x2A</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">REFRESH_SNAPSHOT_CLONE</span><span class="p">,</span>	<span class="mh">0x2B</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">RESTORE_PARTITION_FROM_SNAPSHOT</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">)</span>

	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">READ_MAP</span><span class="p">,</span>			<span class="mh">0x31</span><span class="p">)</span>
	<span class="n">OSD_ACT_V2</span><span class="p">(</span><span class="n">READ_MAPS_COMPARE</span><span class="p">,</span>		<span class="mh">0x32</span><span class="p">)</span>

	<span class="n">OSD_ACT_V1_V2</span><span class="p">(</span><span class="n">PERFORM_SCSI_COMMAND</span><span class="p">,</span>	<span class="mh">0x8F7E</span><span class="p">,</span> <span class="mh">0x8F7C</span><span class="p">)</span>
	<span class="n">OSD_ACT_V1_V2</span><span class="p">(</span><span class="n">SCSI_TASK_MANAGEMENT</span><span class="p">,</span>	<span class="mh">0x8F7F</span><span class="p">,</span> <span class="mh">0x8F7D</span><span class="p">)</span>
	<span class="cm">/* 0x8F80 to 0x8FFF are Vendor specific */</span>
<span class="p">};</span>

<span class="cm">/* osd2r03: 7.1.3.2 List entry format for retrieving attributes */</span>
<span class="k">struct</span> <span class="n">osd_attributes_list_attrid</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">attr_page</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">attr_id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE: v1: is not aligned.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">osdv1_attributes_list_element</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">attr_page</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">attr_id</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">attr_bytes</span><span class="p">;</span> <span class="cm">/* valid bytes at attr_val without padding */</span>
	<span class="n">u8</span> <span class="n">attr_val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * osd2r03: 7.1.3.3 List entry format for retrieved attributes and</span>
<span class="cm"> *                  for setting attributes</span>
<span class="cm"> * NOTE: v2 is 8-bytes aligned</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">osdv2_attributes_list_element</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">attr_page</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">attr_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__be16</span> <span class="n">attr_bytes</span><span class="p">;</span> <span class="cm">/* valid bytes at attr_val without padding */</span>
	<span class="n">u8</span> <span class="n">attr_val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSDv1_ATTRIBUTES_ELEM_ALIGN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OSD_ATTRIBUTES_ELEM_ALIGN</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSD_ATTR_LIST_ALL_PAGES</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
	<span class="n">OSD_ATTR_LIST_ALL_IN_PAGE</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">osdv1_attr_list_elem_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osdv1_attributes_list_element</span><span class="p">),</span>
		     <span class="n">OSDv1_ATTRIBUTES_ELEM_ALIGN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">osdv2_attr_list_elem_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osdv2_attributes_list_element</span><span class="p">),</span>
		     <span class="n">OSD_ATTRIBUTES_ELEM_ALIGN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * osd2r03: 7.1.3 OSD attributes lists (Table 184) — List type values</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">osd_attr_list_types</span> <span class="p">{</span>
	<span class="n">OSD_ATTR_LIST_GET</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span> 	<span class="cm">/* descriptors only */</span>
	<span class="n">OSD_ATTR_LIST_SET_RETRIEVE</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">,</span> <span class="cm">/*descriptors/values variable-length*/</span>
	<span class="n">OSD_V2_ATTR_LIST_MULTIPLE</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">,</span>  <span class="cm">/* ver2, Multiple Objects lists*/</span>
	<span class="n">OSD_V1_ATTR_LIST_CREATE_MULTIPLE</span> <span class="o">=</span> <span class="mh">0xF</span><span class="p">,</span><span class="cm">/*ver1, used by create_multple*/</span>
<span class="p">};</span>

<span class="cm">/* osd2r03: 7.1.3.4 Multi-object retrieved attributes format */</span>
<span class="k">struct</span> <span class="n">osd_attributes_list_multi_header</span> <span class="p">{</span>
	<span class="n">__be64</span> <span class="n">object_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">object_type</span><span class="p">;</span> <span class="cm">/* object_type enum below */</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">__be16</span> <span class="n">list_bytes</span><span class="p">;</span>
	<span class="cm">/* followed by struct osd_attributes_list_element&#39;s */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">osdv1_attributes_list_header</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>	<span class="cm">/* low 4-bit only */</span>
	<span class="n">u8</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">list_bytes</span><span class="p">;</span> <span class="cm">/* Initiator shall set to Zero. Only set by target */</span>
	<span class="cm">/*</span>
<span class="cm">	 * type=9 followed by struct osd_attributes_list_element&#39;s</span>
<span class="cm">	 * type=E followed by struct osd_attributes_list_multi_header&#39;s</span>
<span class="cm">	 */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">osdv1_list_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">osdv1_attributes_list_header</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">osdv2_attributes_list_header</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>	<span class="cm">/* lower 4-bits only */</span>
	<span class="n">u8</span> <span class="n">pad</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="cm">/*4*/</span>	<span class="n">__be32</span> <span class="n">list_bytes</span><span class="p">;</span> <span class="cm">/* Initiator shall set to zero. Only set by target */</span>
	<span class="cm">/*</span>
<span class="cm">	 * type=9 followed by struct osd_attributes_list_element&#39;s</span>
<span class="cm">	 * type=E followed by struct osd_attributes_list_multi_header&#39;s</span>
<span class="cm">	 */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">osdv2_list_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">osdv2_attributes_list_header</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* (osd-r10 6.13)</span>
<span class="cm"> * osd2r03: 6.15 LIST (Table 79) LIST command parameter data.</span>
<span class="cm"> *	for root_lstchg below</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSD_OBJ_ID_LIST_PAR</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span> <span class="cm">/* V1-only. Not used in V2 */</span>
	<span class="n">OSD_OBJ_ID_LIST_LSTCHG</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * osd2r03: 6.15.2 LIST command parameter data</span>
<span class="cm"> * (Also for LIST COLLECTION)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">osd_obj_id_list</span> <span class="p">{</span>
	<span class="n">__be64</span> <span class="n">list_bytes</span><span class="p">;</span> <span class="cm">/* bytes in list excluding list_bytes (-8) */</span>
	<span class="n">__be64</span> <span class="n">continuation_id</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">list_identifier</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">root_lstchg</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">object_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">osd_is_obj_list_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_obj_id_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
	<span class="n">bool</span> <span class="o">*</span><span class="n">is_changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">is_changed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">root_lstchg</span> <span class="o">&amp;</span> <span class="n">OSD_OBJ_ID_LIST_LSTCHG</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">continuation_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * osd2r03: 4.12.4.5 The ALLDATA security method</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">osd_data_out_integrity_info</span> <span class="p">{</span>
	<span class="n">__be64</span> <span class="n">data_bytes</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">set_attributes_bytes</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">get_attributes_bytes</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">integrity_check_value</span><span class="p">[</span><span class="n">OSD_CRYPTO_KEYID_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Same osd_data_out_integrity_info is used for OSD2/OSD1. The only difference</span>
<span class="cm"> * Is the sizeof the structure since in OSD1 the last array is smaller. Use</span>
<span class="cm"> * below for version independent handling of this structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">osd_data_out_integrity_info_sizeof</span><span class="p">(</span><span class="n">bool</span> <span class="n">is_ver1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_data_out_integrity_info</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">is_ver1</span> <span class="o">*</span> <span class="p">(</span><span class="n">OSDv2_CRYPTO_KEYID_SIZE</span> <span class="o">-</span> <span class="n">OSDv1_CRYPTO_KEYID_SIZE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">osd_data_in_integrity_info</span> <span class="p">{</span>
	<span class="n">__be64</span> <span class="n">data_bytes</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">retrieved_attributes_bytes</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">integrity_check_value</span><span class="p">[</span><span class="n">OSD_CRYPTO_KEYID_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Same osd_data_in_integrity_info is used for OSD2/OSD1. The only difference</span>
<span class="cm"> * Is the sizeof the structure since in OSD1 the last array is smaller. Use</span>
<span class="cm"> * below for version independent handling of this structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">osd_data_in_integrity_info_sizeof</span><span class="p">(</span><span class="n">bool</span> <span class="n">is_ver1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_data_in_integrity_info</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">is_ver1</span> <span class="o">*</span> <span class="p">(</span><span class="n">OSDv2_CRYPTO_KEYID_SIZE</span> <span class="o">-</span> <span class="n">OSDv1_CRYPTO_KEYID_SIZE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">osd_timestamp</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">time</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="cm">/* number of milliseconds since 1/1/1970 UT (big endian) */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cm">/* FIXME: define helper functions to convert to/from osd time format */</span>

<span class="cm">/*</span>
<span class="cm"> * Capability &amp; Security definitions</span>
<span class="cm"> * osd2r03: 4.11.2.2 Capability format</span>
<span class="cm"> * osd2r03: 5.2.8 Security parameters</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">osd_key_identifier</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span> <span class="cm">/* if you know why 7 please email bharrosh@panasas.com */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* for osd_capability.format */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSD_SEC_CAP_FORMAT_NO_CAPS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OSD_SEC_CAP_FORMAT_VER1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OSD_SEC_CAP_FORMAT_VER2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* security_method */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSD_SEC_NOSEC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OSD_SEC_CAPKEY</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OSD_SEC_CMDRSP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">OSD_SEC_ALLDATA</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">object_type</span> <span class="p">{</span>
	<span class="n">OSD_SEC_OBJ_ROOT</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">OSD_SEC_OBJ_PARTITION</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">OSD_SEC_OBJ_COLLECTION</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">OSD_SEC_OBJ_USER</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">osd_capability_bit_masks</span> <span class="p">{</span>
	<span class="n">OSD_SEC_CAP_APPEND</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_OBJ_MGMT</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_REMOVE</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_CREATE</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_SET_ATTR</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_GET_ATTR</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_WRITE</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_READ</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>

	<span class="n">OSD_SEC_CAP_NONE1</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_NONE2</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
	<span class="n">OSD_SEC_GBL_REM</span> 	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="cm">/*v2 only*/</span>
	<span class="n">OSD_SEC_CAP_QUERY</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="cm">/*v2 only*/</span>
	<span class="n">OSD_SEC_CAP_M_OBJECT</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="cm">/*v2 only*/</span>
	<span class="n">OSD_SEC_CAP_POL_SEC</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_GLOBAL</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span>
	<span class="n">OSD_SEC_CAP_DEV_MGMT</span>	<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* for object_descriptor_type (hi nibble used) */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OSD_SEC_OBJ_DESC_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>     <span class="cm">/* Not allowed */</span>
	<span class="n">OSD_SEC_OBJ_DESC_OBJ</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="cm">/* v1: also collection */</span>
	<span class="n">OSD_SEC_OBJ_DESC_PAR</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="cm">/* also root */</span>
	<span class="n">OSD_SEC_OBJ_DESC_COL</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="cm">/* v2 only */</span>
<span class="p">};</span>

<span class="cm">/* (osd-r10:4.9.2.2)</span>
<span class="cm"> * osd2r03:4.11.2.2 Capability format</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">osd_capability_head</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">format</span><span class="p">;</span> <span class="cm">/* low nibble */</span>
	<span class="n">u8</span> <span class="n">integrity_algorithm__key_version</span><span class="p">;</span> <span class="cm">/* MAKE_BYTE(integ_alg, key_ver) */</span>
	<span class="n">u8</span> <span class="n">security_method</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved1</span><span class="p">;</span>
<span class="cm">/*04*/</span>	<span class="k">struct</span> <span class="n">osd_timestamp</span> <span class="n">expiration_time</span><span class="p">;</span>
<span class="cm">/*10*/</span>	<span class="n">u8</span> <span class="n">audit</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<span class="cm">/*30*/</span>	<span class="n">u8</span> <span class="n">discriminator</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<span class="cm">/*42*/</span>	<span class="k">struct</span> <span class="n">osd_timestamp</span> <span class="n">object_created_time</span><span class="p">;</span>
<span class="cm">/*48*/</span>	<span class="n">u8</span> <span class="n">object_type</span><span class="p">;</span>
<span class="cm">/*49*/</span>	<span class="n">u8</span> <span class="n">permissions_bit_mask</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="cm">/*54*/</span>	<span class="n">u8</span> <span class="n">reserved2</span><span class="p">;</span>
<span class="cm">/*55*/</span>	<span class="n">u8</span> <span class="n">object_descriptor_type</span><span class="p">;</span> <span class="cm">/* high nibble */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*56 v1*/</span>
<span class="k">struct</span> <span class="n">osdv1_cap_object_descriptor</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
<span class="cm">/*56*/</span>			<span class="n">__be32</span> <span class="n">policy_access_tag</span><span class="p">;</span>
<span class="cm">/*60*/</span>			<span class="n">__be64</span> <span class="n">allowed_partition_id</span><span class="p">;</span>
<span class="cm">/*68*/</span>			<span class="n">__be64</span> <span class="n">allowed_object_id</span><span class="p">;</span>
<span class="cm">/*76*/</span>			<span class="n">__be32</span> <span class="n">reserved</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__packed</span> <span class="n">obj_desc</span><span class="p">;</span>

<span class="cm">/*56*/</span>		<span class="n">u8</span> <span class="n">object_descriptor</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cm">/*80 v1*/</span>

<span class="cm">/*56 v2*/</span>
<span class="k">struct</span> <span class="n">osd_cap_object_descriptor</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
<span class="cm">/*56*/</span>			<span class="n">__be32</span> <span class="n">allowed_attributes_access</span><span class="p">;</span>
<span class="cm">/*60*/</span>			<span class="n">__be32</span> <span class="n">policy_access_tag</span><span class="p">;</span>
<span class="cm">/*64*/</span>			<span class="n">__be16</span> <span class="n">boot_epoch</span><span class="p">;</span>
<span class="cm">/*66*/</span>			<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="cm">/*72*/</span>			<span class="n">__be64</span> <span class="n">allowed_partition_id</span><span class="p">;</span>
<span class="cm">/*80*/</span>			<span class="n">__be64</span> <span class="n">allowed_object_id</span><span class="p">;</span>
<span class="cm">/*88*/</span>			<span class="n">__be64</span> <span class="n">allowed_range_length</span><span class="p">;</span>
<span class="cm">/*96*/</span>			<span class="n">__be64</span> <span class="n">allowed_range_start</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__packed</span> <span class="n">obj_desc</span><span class="p">;</span>

<span class="cm">/*56*/</span>		<span class="n">u8</span> <span class="n">object_descriptor</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cm">/*104 v2*/</span>

<span class="k">struct</span> <span class="n">osdv1_capability</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_capability_head</span> <span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osdv1_cap_object_descriptor</span> <span class="n">od</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">osd_capability</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_capability_head</span> <span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_cap_object_descriptor</span> <span class="n">od</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * osd_sec_set_caps - set cap-bits into the capabilities header</span>
<span class="cm"> *</span>
<span class="cm"> * @cap:	The osd_capability_head to set cap bits to.</span>
<span class="cm"> * @bit_mask: 	Use an ORed list of enum osd_capability_bit_masks values</span>
<span class="cm"> *</span>
<span class="cm"> * permissions_bit_mask is unaligned use below to set into caps</span>
<span class="cm"> * in a version independent way</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">osd_sec_set_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_capability_head</span> <span class="o">*</span><span class="n">cap</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">bit_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *Note: The bits above are defined LE order this is because this way</span>
<span class="cm">	 *      they can grow in the future to more then 16, and still retain</span>
<span class="cm">	 *      there constant values.</span>
<span class="cm">	 */</span>
	<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">bit_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">permissions_bit_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* osd2r05a sec 5.3: CDB continuation segment formats */</span>
<span class="k">enum</span> <span class="n">osd_continuation_segment_format</span> <span class="p">{</span>
	<span class="n">CDB_CONTINUATION_FORMAT_V2</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">osd_continuation_segment_header</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">format</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reserved1</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">service_action</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">reserved2</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">integrity_check</span><span class="p">[</span><span class="n">OSDv2_CRYPTO_KEYID_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* osd2r05a sec 5.4.1: CDB continuation descriptors */</span>
<span class="k">enum</span> <span class="n">osd_continuation_descriptor_type</span> <span class="p">{</span>
	<span class="n">NO_MORE_DESCRIPTORS</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="n">SCATTER_GATHER_LIST</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
	<span class="n">QUERY_LIST</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
	<span class="n">USER_OBJECT</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">,</span>
	<span class="n">COPY_USER_OBJECT_SOURCE</span> <span class="o">=</span> <span class="mh">0x0101</span><span class="p">,</span>
	<span class="n">EXTENSION_CAPABILITIES</span> <span class="o">=</span> <span class="mh">0xFFEE</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">osd_continuation_descriptor_header</span> <span class="p">{</span>
	<span class="n">__be16</span>	<span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reserved</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">pad_length</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">length</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>


<span class="cm">/* osd2r05a sec 5.4.2: Scatter/gather list */</span>
<span class="k">struct</span> <span class="n">osd_sg_list_entry</span> <span class="p">{</span>
	<span class="n">__be64</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">__be64</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">osd_sg_continuation_descriptor</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_continuation_descriptor_header</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_sg_list_entry</span> <span class="n">entries</span><span class="p">[];</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* ndef __OSD_PROTOCOL_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
