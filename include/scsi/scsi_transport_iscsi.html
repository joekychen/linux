<!DOCTYPE html>
<html><head><title>joekychen/linux » include › scsi › scsi_transport_iscsi.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>scsi_transport_iscsi.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * iSCSI transport class definitions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) IBM Corporation, 2004</span>
<span class="cm"> * Copyright (C) Mike Christie, 2004 - 2006</span>
<span class="cm"> * Copyright (C) Dmitry Yusupov, 2004 - 2005</span>
<span class="cm"> * Copyright (C) Alex Aizman, 2004 - 2005</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef SCSI_TRANSPORT_ISCSI_H</span>
<span class="cp">#define SCSI_TRANSPORT_ISCSI_H</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;scsi/iscsi_if.h&gt;</span>

<span class="k">struct</span> <span class="n">scsi_transport_template</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_transport</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_endpoint</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Scsi_Host</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_cls_conn</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_conn</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_task</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">sockaddr</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_iface</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">bsg_job</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct iscsi_transport - iSCSI Transport template</span>
<span class="cm"> *</span>
<span class="cm"> * @name:		transport name</span>
<span class="cm"> * @caps:		iSCSI Data-Path capabilities</span>
<span class="cm"> * @create_session:	create new iSCSI session object</span>
<span class="cm"> * @destroy_session:	destroy existing iSCSI session object</span>
<span class="cm"> * @create_conn:	create new iSCSI connection</span>
<span class="cm"> * @bind_conn:		associate this connection with existing iSCSI session</span>
<span class="cm"> *			and specified transport descriptor</span>
<span class="cm"> * @destroy_conn:	destroy inactive iSCSI connection</span>
<span class="cm"> * @set_param:		set iSCSI parameter. Return 0 on success, -ENODATA</span>
<span class="cm"> *			when param is not supported, and a -Exx value on other</span>
<span class="cm"> *			error.</span>
<span class="cm"> * @get_param		get iSCSI parameter. Must return number of bytes</span>
<span class="cm"> *			copied to buffer on success, -ENODATA when param</span>
<span class="cm"> *			is not supported, and a -Exx value on other error</span>
<span class="cm"> * @start_conn:		set connection to be operational</span>
<span class="cm"> * @stop_conn:		suspend/recover/terminate connection</span>
<span class="cm"> * @send_pdu:		send iSCSI PDU, Login, Logout, NOP-Out, Reject, Text.</span>
<span class="cm"> * @session_recovery_timedout: notify LLD a block during recovery timed out</span>
<span class="cm"> * @init_task:		Initialize a iscsi_task and any internal structs.</span>
<span class="cm"> *			When offloading the data path, this is called from</span>
<span class="cm"> *			queuecommand with the session lock, or from the</span>
<span class="cm"> *			iscsi_conn_send_pdu context with the session lock.</span>
<span class="cm"> *			When not offloading the data path, this is called</span>
<span class="cm"> *			from the scsi work queue without the session lock.</span>
<span class="cm"> * @xmit_task		Requests LLD to transfer cmd task. Returns 0 or the</span>
<span class="cm"> *			the number of bytes transferred on success, and -Exyz</span>
<span class="cm"> *			value on error. When offloading the data path, this</span>
<span class="cm"> *			is called from queuecommand with the session lock, or</span>
<span class="cm"> *			from the iscsi_conn_send_pdu context with the session</span>
<span class="cm"> *			lock. When not offloading the data path, this is called</span>
<span class="cm"> *			from the scsi work queue without the session lock.</span>
<span class="cm"> * @cleanup_task:	requests LLD to fail task. Called with session lock</span>
<span class="cm"> *			and after the connection has been suspended and</span>
<span class="cm"> *			terminated during recovery. If called</span>
<span class="cm"> *			from abort task then connection is not suspended</span>
<span class="cm"> *			or terminated but sk_callback_lock is held</span>
<span class="cm"> *</span>
<span class="cm"> * Template API provided by iSCSI Transport</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">create_session</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
					<span class="kt">uint16_t</span> <span class="n">cmds_max</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">qdepth</span><span class="p">,</span>
					<span class="kt">uint32_t</span> <span class="n">sn</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">destroy_session</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">create_conn</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="n">cid</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind_conn</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
			  <span class="kt">uint64_t</span> <span class="n">transport_eph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_leading</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">start_conn</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">stop_conn</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">destroy_conn</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_param</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_ep_param</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_conn_param</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_session_param</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_host_param</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_host_param</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">send_pdu</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">get_stats</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iscsi_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">);</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init_task</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit_task</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cleanup_task</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">alloc_pdu</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">opcode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xmit_pdu</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init_pdu</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">parse_pdu_itt</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">itt_t</span> <span class="n">itt</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">age</span><span class="p">);</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">session_recovery_timedout</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">ep_connect</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">non_blocking</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ep_poll</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ep_disconnect</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">tgt_dscvr</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iscsi_tgt_dscvr</span> <span class="n">type</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">enable</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_path</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_path</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_iface_param</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="n">len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_iface_param</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iscsi_param_type</span> <span class="n">param_type</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">umode_t</span> <span class="p">(</span><span class="o">*</span><span class="n">attr_is_visible</span><span class="p">)(</span><span class="kt">int</span> <span class="n">param_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bsg_request</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">send_ping</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">iface_num</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">iface_type</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">payload_size</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_chap</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">chap_tbl_idx</span><span class="p">,</span>
			 <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">num_entries</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">delete_chap</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">chap_tbl_idx</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * transport registration upcalls</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">iscsi_register_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">tt</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_unregister_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">tt</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * control plane upcalls</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_conn_error_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">iscsi_err</span> <span class="n">error</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_conn_login_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">iscsi_conn_state</span> <span class="n">state</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_recv_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_offload_mesg</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">type</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">data_size</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_post_host_event</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">host_no</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">iscsi_host_event_code</span> <span class="n">code</span><span class="p">,</span>
				  <span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">,</span>
				  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_ping_comp_event</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">host_no</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">,</span>
				  <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">,</span>
				  <span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">conn_list</span><span class="p">;</span>	<span class="cm">/* item in connlist */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>			<span class="cm">/* LLD private data */</span>
	<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cid</span><span class="p">;</span>			<span class="cm">/* connection id */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">ep_mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">device</span> <span class="n">dev</span><span class="p">;</span>		<span class="cm">/* sysfs transport/container device */</span>
<span class="p">};</span>

<span class="cp">#define iscsi_dev_to_conn(_dev) \</span>
<span class="cp">	container_of(_dev, struct iscsi_cls_conn, dev)</span>

<span class="cp">#define transport_class_to_conn(_cdev) \</span>
<span class="cp">	iscsi_dev_to_conn(_cdev-&gt;parent)</span>

<span class="cp">#define iscsi_conn_to_session(_conn) \</span>
<span class="cp">	iscsi_dev_to_session(_conn-&gt;dev.parent)</span>

<span class="cm">/* iscsi class session state */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ISCSI_SESSION_LOGGED_IN</span><span class="p">,</span>
	<span class="n">ISCSI_SESSION_FAILED</span><span class="p">,</span>
	<span class="n">ISCSI_SESSION_FREE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define ISCSI_MAX_TARGET -1</span>

<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">sess_list</span><span class="p">;</span>		<span class="cm">/* item in session_list */</span>
	<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">block_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">unblock_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">scan_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">unbind_work</span><span class="p">;</span>

	<span class="cm">/* recovery fields */</span>
	<span class="kt">int</span> <span class="n">recovery_tmo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">recovery_work</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target_id</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ida_used</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * pid of userspace process that created session or -1 if</span>
<span class="cm">	 * created by the kernel.</span>
<span class="cm">	 */</span>
	<span class="n">pid_t</span> <span class="n">creator</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sid</span><span class="p">;</span>				<span class="cm">/* session id */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>				<span class="cm">/* LLD private data */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="n">dev</span><span class="p">;</span>	<span class="cm">/* sysfs transport/container device */</span>
<span class="p">};</span>

<span class="cp">#define iscsi_dev_to_session(_dev) \</span>
<span class="cp">	container_of(_dev, struct iscsi_cls_session, dev)</span>

<span class="cp">#define transport_class_to_session(_cdev) \</span>
<span class="cp">	iscsi_dev_to_session(_cdev-&gt;parent)</span>

<span class="cp">#define iscsi_session_to_shost(_session) \</span>
<span class="cp">	dev_to_shost(_session-&gt;dev.parent)</span>

<span class="cp">#define starget_to_session(_stgt) \</span>
<span class="cp">	iscsi_dev_to_session(_stgt-&gt;dev.parent)</span>

<span class="k">struct</span> <span class="n">iscsi_cls_host</span> <span class="p">{</span>
	<span class="n">atomic_t</span> <span class="n">nr_scans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">bsg_q</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">port_speed</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">port_state</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define iscsi_job_to_shost(_job) \</span>
<span class="cp">        dev_to_shost(_job-&gt;dev)</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>			<span class="cm">/* LLD private data */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">iface_type</span><span class="p">;</span>	<span class="cm">/* IPv4 or IPv6 */</span>
	<span class="kt">uint32_t</span> <span class="n">iface_num</span><span class="p">;</span>	<span class="cm">/* iface number, 0 - n */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>		<span class="cm">/* LLD private data */</span>
<span class="p">};</span>

<span class="cp">#define iscsi_dev_to_iface(_dev) \</span>
<span class="cp">	container_of(_dev, struct iscsi_iface, dev)</span>

<span class="cp">#define iscsi_iface_to_shost(_iface) \</span>
<span class="cp">	dev_to_shost(_iface-&gt;dev.parent)</span>

<span class="cm">/*</span>
<span class="cm"> * session and connection functions that can be used by HW iSCSI LLDs</span>
<span class="cm"> */</span>
<span class="cp">#define iscsi_cls_session_printk(prefix, _cls_session, fmt, a...) \</span>
<span class="cp">	dev_printk(prefix, &amp;(_cls_session)-&gt;dev, fmt, ##a)</span>

<span class="cp">#define iscsi_cls_conn_printk(prefix, _cls_conn, fmt, a...) \</span>
<span class="cp">	dev_printk(prefix, &amp;(_cls_conn)-&gt;dev, fmt, ##a)</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_session_chkready</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_is_session_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">iscsi_alloc_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">transport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dd_size</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_add_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target_id</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_session_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">iscsi_uevent_e</span> <span class="n">event</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">iscsi_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">dd_size</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target_id</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_remove_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_free_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_destroy_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">iscsi_create_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">dd_size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">cid</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_destroy_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_unblock_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_block_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_scan_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">iscsi_create_endpoint</span><span class="p">(</span><span class="kt">int</span> <span class="n">dd_size</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_destroy_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">iscsi_lookup_endpoint</span><span class="p">(</span><span class="n">u64</span> <span class="n">handle</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_block_scsi_eh</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iscsi_create_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
					      <span class="kt">uint32_t</span> <span class="n">iface_type</span><span class="p">,</span>
					      <span class="kt">uint32_t</span> <span class="n">iface_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dd_size</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_destroy_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iscsi_lookup_iface</span><span class="p">(</span><span class="kt">int</span> <span class="n">handle</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iscsi_get_port_speed_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iscsi_get_port_state_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_is_session_dev</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
