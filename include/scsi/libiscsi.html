<!DOCTYPE html>
<html><head><title>joekychen/linux » include › scsi › libiscsi.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>libiscsi.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * iSCSI lib definitions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (C) 2004 - 2006 Mike Christie</span>
<span class="cm"> * Copyright (C) 2004 - 2005 Dmitry Yusupov</span>
<span class="cm"> * Copyright (C) 2004 - 2005 Alex Aizman</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef LIBISCSI_H</span>
<span class="cp">#define LIBISCSI_H</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;scsi/iscsi_proto.h&gt;</span>
<span class="cp">#include &lt;scsi/iscsi_if.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_iscsi.h&gt;</span>

<span class="k">struct</span> <span class="n">scsi_transport_template</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">scsi_host_template</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">scsi_device</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Scsi_Host</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">scsi_target</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">socket</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_transport</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_cls_session</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_cls_conn</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_session</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">iscsi_nopin</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">device</span><span class="p">;</span>

<span class="cp">#define ISCSI_DEF_XMIT_CMDS_MAX	128	</span><span class="cm">/* must be power of 2 */</span><span class="cp"></span>
<span class="cp">#define ISCSI_MGMT_CMDS_MAX	15</span>

<span class="cp">#define ISCSI_DEF_CMD_PER_LUN	32</span>

<span class="cm">/* Task Mgmt states */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TMF_INITIAL</span><span class="p">,</span>
	<span class="n">TMF_QUEUED</span><span class="p">,</span>
	<span class="n">TMF_SUCCESS</span><span class="p">,</span>
	<span class="n">TMF_FAILED</span><span class="p">,</span>
	<span class="n">TMF_TIMEDOUT</span><span class="p">,</span>
	<span class="n">TMF_NOT_FOUND</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Connection suspend &quot;bit&quot; */</span>
<span class="cp">#define ISCSI_SUSPEND_BIT		1</span>

<span class="cp">#define ISCSI_ITT_MASK			0x1fff</span>
<span class="cp">#define ISCSI_TOTAL_CMDS_MAX		4096</span>
<span class="cm">/* this must be a power of two greater than ISCSI_MGMT_CMDS_MAX */</span>
<span class="cp">#define ISCSI_TOTAL_CMDS_MIN		16</span>
<span class="cp">#define ISCSI_AGE_SHIFT			28</span>
<span class="cp">#define ISCSI_AGE_MASK			0xf</span>

<span class="cp">#define ISCSI_ADDRESS_BUF_LEN		64</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* this is the maximum possible storage for AHSs */</span>
	<span class="n">ISCSI_MAX_AHS_SIZE</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_ecdb_ahdr</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_rlength_ahdr</span><span class="p">),</span>
	<span class="n">ISCSI_DIGEST_SIZE</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ISCSI_TASK_FREE</span><span class="p">,</span>
	<span class="n">ISCSI_TASK_COMPLETED</span><span class="p">,</span>
	<span class="n">ISCSI_TASK_PENDING</span><span class="p">,</span>
	<span class="n">ISCSI_TASK_RUNNING</span><span class="p">,</span>
	<span class="n">ISCSI_TASK_ABRT_TMF</span><span class="p">,</span>		<span class="cm">/* aborted due to TMF */</span>
	<span class="n">ISCSI_TASK_ABRT_SESS_RECOV</span><span class="p">,</span>	<span class="cm">/* aborted due to session recovery */</span>
	<span class="n">ISCSI_TASK_REQUEUE_SCSIQ</span><span class="p">,</span>	<span class="cm">/* qcmd requeueing to scsi-ml */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_r2t_info</span> <span class="p">{</span>
	<span class="n">__be32</span>			<span class="n">ttt</span><span class="p">;</span>		<span class="cm">/* copied from R2T */</span>
	<span class="n">__be32</span>			<span class="n">exp_statsn</span><span class="p">;</span>	<span class="cm">/* copied from R2T */</span>
	<span class="kt">uint32_t</span>		<span class="n">data_length</span><span class="p">;</span>	<span class="cm">/* copied from R2T */</span>
	<span class="kt">uint32_t</span>		<span class="n">data_offset</span><span class="p">;</span>	<span class="cm">/* copied from R2T */</span>
	<span class="kt">int</span>			<span class="n">data_count</span><span class="p">;</span>	<span class="cm">/* DATA-Out payload progress */</span>
	<span class="kt">int</span>			<span class="n">datasn</span><span class="p">;</span>
	<span class="cm">/* LLDs should set/update these values */</span>
	<span class="kt">int</span>			<span class="n">sent</span><span class="p">;</span>		<span class="cm">/* R2T sequence progress */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Because LLDs allocate their hdr differently, this is a pointer</span>
<span class="cm">	 * and length to that storage. It must be setup at session</span>
<span class="cm">	 * creation time.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">iscsi_hdr</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">hdr_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">hdr_len</span><span class="p">;</span>	<span class="cm">/* accumulated size of hdr used */</span>
	<span class="cm">/* copied values in case we need to send tmfs */</span>
	<span class="n">itt_t</span>			<span class="n">hdr_itt</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">cmdsn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_lun</span>		<span class="n">lun</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">itt</span><span class="p">;</span>		<span class="cm">/* this ITT */</span>

	<span class="kt">unsigned</span>		<span class="n">imm_count</span><span class="p">;</span>	<span class="cm">/* imm-data (bytes)   */</span>
	<span class="cm">/* offset in unsolicited stream (bytes); */</span>
	<span class="k">struct</span> <span class="n">iscsi_r2t_info</span>	<span class="n">unsol_r2t</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">data</span><span class="p">;</span>		<span class="cm">/* mgmt payload */</span>
	<span class="kt">unsigned</span>		<span class="n">data_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">sc</span><span class="p">;</span>		<span class="cm">/* associated SCSI cmd*/</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span>	<span class="o">*</span><span class="n">conn</span><span class="p">;</span>		<span class="cm">/* used connection    */</span>

	<span class="cm">/* data processing tracking */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">last_xfer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">last_timeout</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">have_checked_conn</span><span class="p">;</span>
	<span class="cm">/* state set/tested under session-&gt;lock */</span>
	<span class="kt">int</span>			<span class="n">state</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">refcount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">running</span><span class="p">;</span>	<span class="cm">/* running cmd list */</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>	<span class="cm">/* driver/transport data */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">iscsi_task_has_unsol_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">unsol_r2t</span><span class="p">.</span><span class="n">data_length</span> <span class="o">&gt;</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">unsol_r2t</span><span class="p">.</span><span class="n">sent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">iscsi_next_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Connection&#39;s states */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ISCSI_CONN_INITIAL_STAGE</span><span class="p">,</span>
	<span class="n">ISCSI_CONN_STARTED</span><span class="p">,</span>
	<span class="n">ISCSI_CONN_STOPPED</span><span class="p">,</span>
	<span class="n">ISCSI_CONN_CLEANUP_WAIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span>	<span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>	<span class="cm">/* ptr to class connection */</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>	<span class="cm">/* iscsi_transport data */</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span>	<span class="o">*</span><span class="n">session</span><span class="p">;</span>	<span class="cm">/* parent session */</span>
	<span class="cm">/*</span>
<span class="cm">	 * conn_stop() flag: stop to recover, stop to terminate</span>
<span class="cm">	 */</span>
        <span class="kt">int</span>			<span class="n">stop_stage</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">transport_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">last_recv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">last_ping</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ping_timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">recv_timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> 	<span class="o">*</span><span class="n">ping_task</span><span class="p">;</span>

	<span class="cm">/* iSCSI connection-wide sequencing */</span>
	<span class="kt">uint32_t</span>		<span class="n">exp_statsn</span><span class="p">;</span>

	<span class="cm">/* control data */</span>
	<span class="kt">int</span>			<span class="n">id</span><span class="p">;</span>		<span class="cm">/* CID */</span>
	<span class="kt">int</span>			<span class="n">c_stage</span><span class="p">;</span>	<span class="cm">/* connection state */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Preallocated buffer for pdus that have data but do not</span>
<span class="cm">	 * originate from scsi-ml. We never have two pdus using the</span>
<span class="cm">	 * buffer at the same time. It is only allocated to</span>
<span class="cm">	 * the default max recv size because the pdus we support</span>
<span class="cm">	 * should always fit in this buffer</span>
<span class="cm">	 */</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> 	<span class="o">*</span><span class="n">login_task</span><span class="p">;</span>	<span class="cm">/* mtask used for login/text */</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span>	<span class="o">*</span><span class="n">task</span><span class="p">;</span>		<span class="cm">/* xmit task in progress */</span>

	<span class="cm">/* xmit */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">mgmtqueue</span><span class="p">;</span>	<span class="cm">/* mgmt (control) xmit queue */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">cmdqueue</span><span class="p">;</span>	<span class="cm">/* data-path cmd queue */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">requeue</span><span class="p">;</span>	<span class="cm">/* tasks needing another run */</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">xmitwork</span><span class="p">;</span>	<span class="cm">/* per-conn. xmit workqueue */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">suspend_tx</span><span class="p">;</span>	<span class="cm">/* suspend Tx */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">suspend_rx</span><span class="p">;</span>	<span class="cm">/* suspend Rx */</span>

	<span class="cm">/* abort */</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">ehwait</span><span class="p">;</span>		<span class="cm">/* used in eh_abort() */</span>
	<span class="k">struct</span> <span class="n">iscsi_tm</span>		<span class="n">tmhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">tmf_timer</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tmf_state</span><span class="p">;</span>	<span class="cm">/* see TMF_INITIAL, etc.*/</span>

	<span class="cm">/* negotiated params */</span>
	<span class="kt">unsigned</span>		<span class="n">max_recv_dlength</span><span class="p">;</span> <span class="cm">/* initiator_max_recv_dsl*/</span>
	<span class="kt">unsigned</span>		<span class="n">max_xmit_dlength</span><span class="p">;</span> <span class="cm">/* target_max_recv_dsl */</span>
	<span class="kt">int</span>			<span class="n">hdrdgst_en</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">datadgst_en</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ifmarker_en</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ofmarker_en</span><span class="p">;</span>
	<span class="cm">/* values userspace uses to id a conn */</span>
	<span class="kt">int</span>			<span class="n">persistent_port</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">persistent_address</span><span class="p">;</span>

	<span class="cm">/* MIB-statistics */</span>
	<span class="kt">uint64_t</span>		<span class="n">txdata_octets</span><span class="p">;</span>
	<span class="kt">uint64_t</span>		<span class="n">rxdata_octets</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">scsicmd_pdus_cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">dataout_pdus_cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">scsirsp_pdus_cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">datain_pdus_cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">r2t_pdus_cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">tmfcmd_pdus_cnt</span><span class="p">;</span>
	<span class="kt">int32_t</span>			<span class="n">tmfrsp_pdus_cnt</span><span class="p">;</span>

	<span class="cm">/* custom statistics */</span>
	<span class="kt">uint32_t</span>		<span class="n">eh_abort_cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">fmr_unalign_cnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_pool</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kfifo</span>		<span class="n">queue</span><span class="p">;</span>		<span class="cm">/* FIFO Queue */</span>
	<span class="kt">void</span>			<span class="o">**</span><span class="n">pool</span><span class="p">;</span>		<span class="cm">/* Pool of elements */</span>
	<span class="kt">int</span>			<span class="n">max</span><span class="p">;</span>		<span class="cm">/* Max number of elements */</span>
<span class="p">};</span>

<span class="cm">/* Session&#39;s states */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ISCSI_STATE_FREE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ISCSI_STATE_LOGGED_IN</span><span class="p">,</span>
	<span class="n">ISCSI_STATE_FAILED</span><span class="p">,</span>
	<span class="n">ISCSI_STATE_TERMINATE</span><span class="p">,</span>
	<span class="n">ISCSI_STATE_IN_RECOVERY</span><span class="p">,</span>
	<span class="n">ISCSI_STATE_RECOVERY_FAILED</span><span class="p">,</span>
	<span class="n">ISCSI_STATE_LOGGING_OUT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Syncs up the scsi eh thread with the iscsi eh thread when sending</span>
<span class="cm">	 * task management functions. This must be taken before the session</span>
<span class="cm">	 * and recv lock.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">eh_mutex</span><span class="p">;</span>

	<span class="cm">/* iSCSI session-wide sequencing */</span>
	<span class="kt">uint32_t</span>		<span class="n">cmdsn</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">exp_cmdsn</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		<span class="n">max_cmdsn</span><span class="p">;</span>

	<span class="cm">/* This tracks the reqs queued into the initiator */</span>
	<span class="kt">uint32_t</span>		<span class="n">queued_cmdsn</span><span class="p">;</span>

	<span class="cm">/* configuration */</span>
	<span class="kt">int</span>			<span class="n">abort_timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">lu_reset_timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tgt_reset_timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">initial_r2t_en</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">max_r2t</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">imm_data_en</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">first_burst</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">max_burst</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">time2wait</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">time2retain</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">pdu_inorder_en</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">dataseq_inorder_en</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">erl</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">fast_abort</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tpgt</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">username</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">username_in</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">password</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">password_in</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">targetname</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">targetalias</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">ifacename</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">initiatorname</span><span class="p">;</span>
	<span class="cm">/* control data */</span>
	<span class="k">struct</span> <span class="n">iscsi_transport</span>	<span class="o">*</span><span class="n">tt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span>	<span class="o">*</span><span class="n">leadconn</span><span class="p">;</span>	<span class="cm">/* leading connection */</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>		<span class="cm">/* protects session state, *</span>
<span class="cm">						 * sequence numbers,       *</span>
<span class="cm">						 * session resources:      *</span>
<span class="cm">						 * - cmdpool,		   *</span>
<span class="cm">						 * - mgmtpool,		   *</span>
<span class="cm">						 * - r2tpool		   */</span>
	<span class="kt">int</span>			<span class="n">state</span><span class="p">;</span>		<span class="cm">/* session state           */</span>
	<span class="kt">int</span>			<span class="n">age</span><span class="p">;</span>		<span class="cm">/* counts session re-opens */</span>

	<span class="kt">int</span>			<span class="n">scsi_cmds_max</span><span class="p">;</span> 	<span class="cm">/* max scsi commands */</span>
	<span class="kt">int</span>			<span class="n">cmds_max</span><span class="p">;</span>	<span class="cm">/* size of cmds array */</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span>	<span class="o">**</span><span class="n">cmds</span><span class="p">;</span>		<span class="cm">/* Original Cmds arr */</span>
	<span class="k">struct</span> <span class="n">iscsi_pool</span>	<span class="n">cmdpool</span><span class="p">;</span>	<span class="cm">/* PDU&#39;s pool */</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>	<span class="cm">/* LLD private data */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ISCSI_HOST_SETUP</span><span class="p">,</span>
	<span class="n">ISCSI_HOST_REMOVED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iscsi_host</span> <span class="p">{</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">initiatorname</span><span class="p">;</span>
	<span class="cm">/* hw address or netdev iscsi connection is bound to */</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">hwaddress</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span>	<span class="n">session_removal_wq</span><span class="p">;</span>
	<span class="cm">/* protects sessions and state */</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">num_sessions</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">state</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">workqueue_struct</span>	<span class="o">*</span><span class="n">workq</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">workq_name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * scsi host template</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">reason</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_eh_recover_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_eh_session_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_eh_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * iSCSI host helpers.</span>
<span class="cm"> */</span>
<span class="cp">#define iscsi_host_priv(_shost) \</span>
<span class="cp">	(shost_priv(_shost) + sizeof(struct iscsi_host))</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_host_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">buflen</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_host_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_host_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">iscsi_host_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">dd_data_size</span><span class="p">,</span>
					  <span class="n">bool</span> <span class="n">xmit_can_sleep</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_host_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_host_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_target_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * session management</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span>
<span class="n">iscsi_session_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
		    <span class="kt">uint16_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_session_recovery_timedout</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_session_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="cp">#define iscsi_session_printk(prefix, _sess, fmt, a...)	\</span>
<span class="cp">	iscsi_cls_session_printk(prefix, _sess-&gt;cls_session, fmt, ##a)</span>

<span class="cm">/*</span>
<span class="cm"> * connection management</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">iscsi_conn_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="p">,</span>
					       <span class="kt">int</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_conn_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_conn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_conn_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_conn_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="p">,</span>
			   <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iscsi_err</span> <span class="n">err</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_session_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">iscsi_err</span> <span class="n">err</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_conn_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_conn_get_addr_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_suspend_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_suspend_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_conn_queue_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>

<span class="cp">#define iscsi_conn_printk(prefix, _c, fmt, a...) \</span>
<span class="cp">	iscsi_cls_conn_printk(prefix, ((struct iscsi_conn *)_c)-&gt;cls_conn, \</span>
<span class="cp">			      fmt, ##a)</span>

<span class="cm">/*</span>
<span class="cm"> * pdu and task processing</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_update_cmdsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_nopin</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_prep_data_out_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iscsi_r2t_info</span> <span class="o">*</span><span class="n">r2t</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iscsi_data</span> <span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_conn_send_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_complete_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_verify_itt</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="p">,</span> <span class="n">itt_t</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">iscsi_itt_to_ctask</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="p">,</span> <span class="n">itt_t</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="p">,</span> <span class="n">itt_t</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_requeue_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_put_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__iscsi_put_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__iscsi_get_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_complete_scsi_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
				     <span class="kt">uint32_t</span> <span class="n">exp_cmdsn</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">max_cmdsn</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * generic helpers</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">iscsi_pool_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_pool</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">iscsi_pool_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_pool</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">***</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * inline functions to deal with padding.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">iscsi_padded</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">ISCSI_PAD_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ISCSI_PAD_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">iscsi_padding</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">len</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ISCSI_PAD_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ISCSI_PAD_LEN</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
