<!DOCTYPE html>
<html><head><title>joekychen/linux » include › scsi › scsi_tcq.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>scsi_tcq.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _SCSI_SCSI_TCQ_H</span>
<span class="cp">#define _SCSI_SCSI_TCQ_H</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#define MSG_SIMPLE_TAG	0x20</span>
<span class="cp">#define MSG_HEAD_TAG	0x21</span>
<span class="cp">#define MSG_ORDERED_TAG	0x22</span>
<span class="cp">#define MSG_ACA_TAG	0x24	</span><span class="cm">/* unsupported */</span><span class="cp"></span>

<span class="cp">#define SCSI_NO_TAG	(-1)    </span><span class="cm">/* identify no tag in use */</span><span class="cp"></span>


<span class="cp">#ifdef CONFIG_BLOCK</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_get_tag_type - get the type of tag the device supports</span>
<span class="cm"> * @sdev:	the scsi device</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	If the drive only supports simple tags, returns MSG_SIMPLE_TAG</span>
<span class="cm"> *	if it supports all tag types, returns MSG_ORDERED_TAG.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">scsi_get_tag_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">ordered_tags</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scsi_set_tag_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSG_ORDERED_TAG</span>:
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">ordered_tags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">MSG_SIMPLE_TAG</span>:
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">simple_tags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">ordered_tags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">simple_tags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * scsi_activate_tcq - turn on tag command queueing</span>
<span class="cm"> * @SDpnt:	device to turn on TCQ for</span>
<span class="cm"> * @depth:	queue depth</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	Eventually, I hope depth would be the maximum depth</span>
<span class="cm"> *	the device could cope with and the real queue depth</span>
<span class="cm"> *	would be adjustable from 0 to depth.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scsi_activate_tcq</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_queue_tagged</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">))</span>
		<span class="n">blk_queue_init_tags</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span>
				    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bqt</span><span class="p">);</span>

	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span> <span class="n">depth</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_deactivate_tcq - turn off tag command queueing</span>
<span class="cm"> * @SDpnt:	device to turn off TCQ for</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scsi_deactivate_tcq</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_queue_tagged</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">))</span>
		<span class="n">blk_queue_free_tags</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">);</span>
	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_populate_tag_msg - place a tag message in a buffer</span>
<span class="cm"> * @SCpnt:	pointer to the Scsi_Cmnd for the tag</span>
<span class="cm"> * @msg:	pointer to the area to place the tag</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	designed to create the correct type of tag message for the </span>
<span class="cm"> *	particular request.  Returns the size of the tag message.</span>
<span class="cm"> *	May return 0 if TCQ is disabled for this device.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">scsi_populate_tag_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_tagged</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">msg</span><span class="o">++</span> <span class="o">=</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">;</span>
        	<span class="o">*</span><span class="n">msg</span><span class="o">++</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
        	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_find_tag - find a tagged command by device</span>
<span class="cm"> * @SDpnt:	pointer to the ScSI device</span>
<span class="cm"> * @tag:	the tag number</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	Only works with tags allocated by the generic blk layer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="nf">scsi_find_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>

        <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">SCSI_NO_TAG</span><span class="p">)</span> <span class="p">{</span>
        	<span class="n">req</span> <span class="o">=</span> <span class="n">blk_queue_find_tag</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	        <span class="k">return</span> <span class="n">req</span> <span class="o">?</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">special</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* single command, look in space */</span>
	<span class="k">return</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">current_cmnd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_init_shared_tag_map - create a shared tag map</span>
<span class="cm"> * @shost:	the host to share the tag map among all devices</span>
<span class="cm"> * @depth:	the total depth of the map</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">scsi_init_shared_tag_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the shared tag map isn&#39;t already initialized, do it now.</span>
<span class="cm">	 * This saves callers from having to check -&gt;bqt when setting up</span>
<span class="cm">	 * devices on the shared host (for libata)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">bqt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">bqt</span> <span class="o">=</span> <span class="n">blk_init_tags</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">bqt</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_host_find_tag - find the tagged command by host</span>
<span class="cm"> * @shost:	pointer to scsi_host</span>
<span class="cm"> * @tag:	tag of the scsi_cmnd</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	Only works with tags allocated by the generic blk layer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="nf">scsi_host_find_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">SCSI_NO_TAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">blk_map_queue_find_tag</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">bqt</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">req</span> <span class="o">?</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">special</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_BLOCK */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* _SCSI_SCSI_TCQ_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
