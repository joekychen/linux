<!DOCTYPE html>
<html><head><title>joekychen/linux » include › rdma › ib_mad.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ib_mad.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004 Mellanox Technologies Ltd.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2004 Infinicon Corporation.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2004 Intel Corporation.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2004 Topspin Corporation.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2004-2006 Voltaire Corporation.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#if !defined(IB_MAD_H)</span>
<span class="cp">#define IB_MAD_H</span>

<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="cp">#include &lt;rdma/ib_verbs.h&gt;</span>

<span class="cm">/* Management base version */</span>
<span class="cp">#define IB_MGMT_BASE_VERSION			1</span>

<span class="cm">/* Management classes */</span>
<span class="cp">#define IB_MGMT_CLASS_SUBN_LID_ROUTED		0x01</span>
<span class="cp">#define IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE	0x81</span>
<span class="cp">#define IB_MGMT_CLASS_SUBN_ADM			0x03</span>
<span class="cp">#define IB_MGMT_CLASS_PERF_MGMT			0x04</span>
<span class="cp">#define IB_MGMT_CLASS_BM			0x05</span>
<span class="cp">#define IB_MGMT_CLASS_DEVICE_MGMT		0x06</span>
<span class="cp">#define IB_MGMT_CLASS_CM			0x07</span>
<span class="cp">#define IB_MGMT_CLASS_SNMP			0x08</span>
<span class="cp">#define IB_MGMT_CLASS_DEVICE_ADM		0x10</span>
<span class="cp">#define IB_MGMT_CLASS_BOOT_MGMT			0x11</span>
<span class="cp">#define IB_MGMT_CLASS_BIS			0x12</span>
<span class="cp">#define IB_MGMT_CLASS_CONG_MGMT			0x21</span>
<span class="cp">#define IB_MGMT_CLASS_VENDOR_RANGE2_START	0x30</span>
<span class="cp">#define IB_MGMT_CLASS_VENDOR_RANGE2_END		0x4F</span>

<span class="cp">#define	IB_OPENIB_OUI				(0x001405)</span>

<span class="cm">/* Management methods */</span>
<span class="cp">#define IB_MGMT_METHOD_GET			0x01</span>
<span class="cp">#define IB_MGMT_METHOD_SET			0x02</span>
<span class="cp">#define IB_MGMT_METHOD_GET_RESP			0x81</span>
<span class="cp">#define IB_MGMT_METHOD_SEND			0x03</span>
<span class="cp">#define IB_MGMT_METHOD_TRAP			0x05</span>
<span class="cp">#define IB_MGMT_METHOD_REPORT			0x06</span>
<span class="cp">#define IB_MGMT_METHOD_REPORT_RESP		0x86</span>
<span class="cp">#define IB_MGMT_METHOD_TRAP_REPRESS		0x07</span>

<span class="cp">#define IB_MGMT_METHOD_RESP			0x80</span>
<span class="cp">#define IB_BM_ATTR_MOD_RESP			cpu_to_be32(1)</span>

<span class="cp">#define IB_MGMT_MAX_METHODS			128</span>

<span class="cm">/* MAD Status field bit masks */</span>
<span class="cp">#define IB_MGMT_MAD_STATUS_SUCCESS			0x0000</span>
<span class="cp">#define IB_MGMT_MAD_STATUS_BUSY				0x0001</span>
<span class="cp">#define IB_MGMT_MAD_STATUS_REDIRECT_REQD		0x0002</span>
<span class="cp">#define IB_MGMT_MAD_STATUS_BAD_VERSION			0x0004</span>
<span class="cp">#define IB_MGMT_MAD_STATUS_UNSUPPORTED_METHOD		0x0008</span>
<span class="cp">#define IB_MGMT_MAD_STATUS_UNSUPPORTED_METHOD_ATTRIB	0x000c</span>
<span class="cp">#define IB_MGMT_MAD_STATUS_INVALID_ATTRIB_VALUE		0x001c</span>

<span class="cm">/* RMPP information */</span>
<span class="cp">#define IB_MGMT_RMPP_VERSION			1</span>

<span class="cp">#define IB_MGMT_RMPP_TYPE_DATA			1</span>
<span class="cp">#define IB_MGMT_RMPP_TYPE_ACK			2</span>
<span class="cp">#define IB_MGMT_RMPP_TYPE_STOP			3</span>
<span class="cp">#define IB_MGMT_RMPP_TYPE_ABORT			4</span>

<span class="cp">#define IB_MGMT_RMPP_FLAG_ACTIVE		1</span>
<span class="cp">#define IB_MGMT_RMPP_FLAG_FIRST			(1&lt;&lt;1)</span>
<span class="cp">#define IB_MGMT_RMPP_FLAG_LAST			(1&lt;&lt;2)</span>

<span class="cp">#define IB_MGMT_RMPP_NO_RESPTIME		0x1F</span>

<span class="cp">#define	IB_MGMT_RMPP_STATUS_SUCCESS		0</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_RESX		1</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_ABORT_MIN		118</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_T2L			118</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_BAD_LEN		119</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_BAD_SEG		120</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_BADT		121</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_W2S			122</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_S2B			123</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_BAD_STATUS		124</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_UNV			125</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_TMR			126</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_UNSPEC		127</span>
<span class="cp">#define	IB_MGMT_RMPP_STATUS_ABORT_MAX		127</span>

<span class="cp">#define IB_QP0		0</span>
<span class="cp">#define IB_QP1		cpu_to_be32(1)</span>
<span class="cp">#define IB_QP1_QKEY	0x80010000</span>
<span class="cp">#define IB_QP_SET_QKEY	0x80000000</span>

<span class="cp">#define IB_DEFAULT_PKEY_PARTIAL 0x7FFF</span>
<span class="cp">#define IB_DEFAULT_PKEY_FULL	0xFFFF</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">IB_MGMT_MAD_HDR</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="n">IB_MGMT_MAD_DATA</span> <span class="o">=</span> <span class="mi">232</span><span class="p">,</span>
	<span class="n">IB_MGMT_RMPP_HDR</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
	<span class="n">IB_MGMT_RMPP_DATA</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span>
	<span class="n">IB_MGMT_VENDOR_HDR</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
	<span class="n">IB_MGMT_VENDOR_DATA</span> <span class="o">=</span> <span class="mi">216</span><span class="p">,</span>
	<span class="n">IB_MGMT_SA_HDR</span> <span class="o">=</span> <span class="mi">56</span><span class="p">,</span>
	<span class="n">IB_MGMT_SA_DATA</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
	<span class="n">IB_MGMT_DEVICE_HDR</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="n">IB_MGMT_DEVICE_DATA</span> <span class="o">=</span> <span class="mi">192</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_mad_hdr</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">base_version</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">mgmt_class</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">class_version</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">method</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">status</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">class_specific</span><span class="p">;</span>
	<span class="n">__be64</span>	<span class="n">tid</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">attr_id</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">resv</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">attr_mod</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_rmpp_hdr</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">rmpp_version</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rmpp_type</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rmpp_rtime_flags</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rmpp_status</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">seg_num</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">paylen_newwin</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">u64</span> <span class="n">__bitwise</span> <span class="n">ib_sa_comp_mask</span><span class="p">;</span>

<span class="cp">#define IB_SA_COMP_MASK(n) ((__force ib_sa_comp_mask) cpu_to_be64(1ull &lt;&lt; (n)))</span>

<span class="cm">/*</span>
<span class="cm"> * ib_sa_hdr and ib_sa_mad structures must be packed because they have</span>
<span class="cm"> * 64-bit fields that are only 32-bit aligned. 64-bit architectures will</span>
<span class="cm"> * lay them out wrong otherwise.  (And unfortunately they are sent on</span>
<span class="cm"> * the wire so we can&#39;t change the layout)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_sa_hdr</span> <span class="p">{</span>
	<span class="n">__be64</span>			<span class="n">sm_key</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">attr_offset</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">reserved</span><span class="p">;</span>
	<span class="n">ib_sa_comp_mask</span>		<span class="n">comp_mask</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ib_mad</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mad_hdr</span>	<span class="n">mad_hdr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">data</span><span class="p">[</span><span class="n">IB_MGMT_MAD_DATA</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_rmpp_mad</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mad_hdr</span>	<span class="n">mad_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_rmpp_hdr</span>	<span class="n">rmpp_hdr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">data</span><span class="p">[</span><span class="n">IB_MGMT_RMPP_DATA</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_sa_mad</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mad_hdr</span>	<span class="n">mad_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_rmpp_hdr</span>	<span class="n">rmpp_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_sa_hdr</span>	<span class="n">sa_hdr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">data</span><span class="p">[</span><span class="n">IB_MGMT_SA_DATA</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ib_vendor_mad</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mad_hdr</span>	<span class="n">mad_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_rmpp_hdr</span>	<span class="n">rmpp_hdr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">reserved</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">oui</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">data</span><span class="p">[</span><span class="n">IB_MGMT_VENDOR_DATA</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ib_class_port_info</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">base_version</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">class_version</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">capability_mask</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">resp_time_value</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">redirect_gid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__be32</span>			<span class="n">redirect_tcslfl</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">redirect_lid</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">redirect_pkey</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">redirect_qp</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">redirect_qkey</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">trap_gid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__be32</span>			<span class="n">trap_tcslfl</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">trap_lid</span><span class="p">;</span>
	<span class="n">__be16</span>			<span class="n">trap_pkey</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">trap_hlqp</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">trap_qkey</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_send_buf - MAD data buffer and work request for sends.</span>
<span class="cm"> * @next: A pointer used to chain together MADs for posting.</span>
<span class="cm"> * @mad: References an allocated MAD data buffer for MADs that do not have</span>
<span class="cm"> *   RMPP active.  For MADs using RMPP, references the common and management</span>
<span class="cm"> *   class specific headers.</span>
<span class="cm"> * @mad_agent: MAD agent that allocated the buffer.</span>
<span class="cm"> * @ah: The address handle to use when sending the MAD.</span>
<span class="cm"> * @context: User-controlled context fields.</span>
<span class="cm"> * @hdr_len: Indicates the size of the data header of the MAD.  This length</span>
<span class="cm"> *   includes the common MAD, RMPP, and class specific headers.</span>
<span class="cm"> * @data_len: Indicates the total size of user-transferred data.</span>
<span class="cm"> * @seg_count: The number of RMPP segments allocated for this send.</span>
<span class="cm"> * @seg_size: Size of each RMPP segment.</span>
<span class="cm"> * @timeout_ms: Time to wait for a response.</span>
<span class="cm"> * @retries: Number of times to retry a request for a response.  For MADs</span>
<span class="cm"> *   using RMPP, this applies per window.  On completion, returns the number</span>
<span class="cm"> *   of retries needed to complete the transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * Users are responsible for initializing the MAD buffer itself, with the</span>
<span class="cm"> * exception of any RMPP header.  Additional segment buffer space allocated</span>
<span class="cm"> * beyond data_len is padding.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mad_send_buf</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">mad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mad_agent</span>	<span class="o">*</span><span class="n">mad_agent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_ah</span>		<span class="o">*</span><span class="n">ah</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">context</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">hdr_len</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">data_len</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">seg_count</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">seg_size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">timeout_ms</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retries</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ib_response_mad - Returns if the specified MAD has been generated in</span>
<span class="cm"> *   response to a sent request or trap.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ib_response_mad</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad</span> <span class="o">*</span><span class="n">mad</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_get_rmpp_resptime - Returns the RMPP response time.</span>
<span class="cm"> * @rmpp_hdr: An RMPP header.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">ib_get_rmpp_resptime</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_rmpp_hdr</span> <span class="o">*</span><span class="n">rmpp_hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rmpp_hdr</span><span class="o">-&gt;</span><span class="n">rmpp_rtime_flags</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ib_get_rmpp_flags - Returns the RMPP flags.</span>
<span class="cm"> * @rmpp_hdr: An RMPP header.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">ib_get_rmpp_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_rmpp_hdr</span> <span class="o">*</span><span class="n">rmpp_hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rmpp_hdr</span><span class="o">-&gt;</span><span class="n">rmpp_rtime_flags</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ib_set_rmpp_resptime - Sets the response time in an RMPP header.</span>
<span class="cm"> * @rmpp_hdr: An RMPP header.</span>
<span class="cm"> * @rtime: The response time to set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ib_set_rmpp_resptime</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_rmpp_hdr</span> <span class="o">*</span><span class="n">rmpp_hdr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rmpp_hdr</span><span class="o">-&gt;</span><span class="n">rmpp_rtime_flags</span> <span class="o">=</span> <span class="n">ib_get_rmpp_flags</span><span class="p">(</span><span class="n">rmpp_hdr</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rtime</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ib_set_rmpp_flags - Sets the flags in an RMPP header.</span>
<span class="cm"> * @rmpp_hdr: An RMPP header.</span>
<span class="cm"> * @flags: The flags to set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ib_set_rmpp_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_rmpp_hdr</span> <span class="o">*</span><span class="n">rmpp_hdr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rmpp_hdr</span><span class="o">-&gt;</span><span class="n">rmpp_rtime_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmpp_hdr</span><span class="o">-&gt;</span><span class="n">rmpp_rtime_flags</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ib_mad_agent</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ib_mad_send_wc</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ib_mad_recv_wc</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_send_handler - callback handler for a sent MAD.</span>
<span class="cm"> * @mad_agent: MAD agent that sent the MAD.</span>
<span class="cm"> * @mad_send_wc: Send work completion information on the sent MAD.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ib_mad_send_handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">mad_agent</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ib_mad_send_wc</span> <span class="o">*</span><span class="n">mad_send_wc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_snoop_handler - Callback handler for snooping sent MADs.</span>
<span class="cm"> * @mad_agent: MAD agent that snooped the MAD.</span>
<span class="cm"> * @send_wr: Work request information on the sent MAD.</span>
<span class="cm"> * @mad_send_wc: Work completion information on the sent MAD.  Valid</span>
<span class="cm"> *   only for snooping that occurs on a send completion.</span>
<span class="cm"> *</span>
<span class="cm"> * Clients snooping MADs should not modify data referenced by the @send_wr</span>
<span class="cm"> * or @mad_send_wc.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ib_mad_snoop_handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">mad_agent</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">*</span><span class="n">send_buf</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ib_mad_send_wc</span> <span class="o">*</span><span class="n">mad_send_wc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_recv_handler - callback handler for a received MAD.</span>
<span class="cm"> * @mad_agent: MAD agent requesting the received MAD.</span>
<span class="cm"> * @mad_recv_wc: Received work completion information on the received MAD.</span>
<span class="cm"> *</span>
<span class="cm"> * MADs received in response to a send request operation will be handed to</span>
<span class="cm"> * the user before the send operation completes.  All data buffers given</span>
<span class="cm"> * to registered agents through this routine are owned by the receiving</span>
<span class="cm"> * client, except for snooping agents.  Clients snooping MADs should not</span>
<span class="cm"> * modify the data referenced by @mad_recv_wc.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ib_mad_recv_handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">mad_agent</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ib_mad_recv_wc</span> <span class="o">*</span><span class="n">mad_recv_wc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_agent - Used to track MAD registration with the access layer.</span>
<span class="cm"> * @device: Reference to device registration is on.</span>
<span class="cm"> * @qp: Reference to QP used for sending and receiving MADs.</span>
<span class="cm"> * @mr: Memory region for system memory usable for DMA.</span>
<span class="cm"> * @recv_handler: Callback handler for a received MAD.</span>
<span class="cm"> * @send_handler: Callback handler for a sent MAD.</span>
<span class="cm"> * @snoop_handler: Callback handler for snooped sent MADs.</span>
<span class="cm"> * @context: User-specified context associated with this registration.</span>
<span class="cm"> * @hi_tid: Access layer assigned transaction ID for this client.</span>
<span class="cm"> *   Unsolicited MADs sent by this client will have the upper 32-bits</span>
<span class="cm"> *   of their TID set to this value.</span>
<span class="cm"> * @port_num: Port number on which QP is registered</span>
<span class="cm"> * @rmpp_version: If set, indicates the RMPP version used by this agent.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_device</span>	<span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_qp</span>		<span class="o">*</span><span class="n">qp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mr</span>		<span class="o">*</span><span class="n">mr</span><span class="p">;</span>
	<span class="n">ib_mad_recv_handler</span>	<span class="n">recv_handler</span><span class="p">;</span>
	<span class="n">ib_mad_send_handler</span>	<span class="n">send_handler</span><span class="p">;</span>
	<span class="n">ib_mad_snoop_handler</span>	<span class="n">snoop_handler</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">hi_tid</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">port_num</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">rmpp_version</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_send_wc - MAD send completion information.</span>
<span class="cm"> * @send_buf: Send MAD data buffer associated with the send MAD request.</span>
<span class="cm"> * @status: Completion status.</span>
<span class="cm"> * @vendor_err: Optional vendor error information returned with a failed</span>
<span class="cm"> *   request.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_send_wc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_mad_send_buf</span>	<span class="o">*</span><span class="n">send_buf</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ib_wc_status</span>	<span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">vendor_err</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_recv_buf - received MAD buffer information.</span>
<span class="cm"> * @list: Reference to next data buffer for a received RMPP MAD.</span>
<span class="cm"> * @grh: References a data buffer containing the global route header.</span>
<span class="cm"> *   The data refereced by this buffer is only valid if the GRH is</span>
<span class="cm"> *   valid.</span>
<span class="cm"> * @mad: References the start of the received MAD.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_recv_buf</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_grh</span>		<span class="o">*</span><span class="n">grh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mad</span>		<span class="o">*</span><span class="n">mad</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_recv_wc - received MAD information.</span>
<span class="cm"> * @wc: Completion information for the received data.</span>
<span class="cm"> * @recv_buf: Specifies the location of the received data buffer(s).</span>
<span class="cm"> * @rmpp_list: Specifies a list of RMPP reassembled received MAD buffers.</span>
<span class="cm"> * @mad_len: The length of the received MAD, without duplicated headers.</span>
<span class="cm"> *</span>
<span class="cm"> * For received response, the wr_id contains a pointer to the ib_mad_send_buf</span>
<span class="cm"> *   for the corresponding send request.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_recv_wc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ib_wc</span>		<span class="o">*</span><span class="n">wc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ib_mad_recv_buf</span>	<span class="n">recv_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rmpp_list</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">mad_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ib_mad_reg_req - MAD registration request</span>
<span class="cm"> * @mgmt_class: Indicates which management class of MADs should be receive</span>
<span class="cm"> *   by the caller.  This field is only required if the user wishes to</span>
<span class="cm"> *   receive unsolicited MADs, otherwise it should be 0.</span>
<span class="cm"> * @mgmt_class_version: Indicates which version of MADs for the given</span>
<span class="cm"> *   management class to receive.</span>
<span class="cm"> * @oui: Indicates IEEE OUI when mgmt_class is a vendor class</span>
<span class="cm"> *   in the range from 0x30 to 0x4f. Otherwise not used.</span>
<span class="cm"> * @method_mask: The caller will receive unsolicited MADs for any method</span>
<span class="cm"> *   where @method_mask = 1.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_reg_req</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">mgmt_class</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">mgmt_class_version</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">oui</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">method_mask</span><span class="p">,</span> <span class="n">IB_MGMT_MAX_METHODS</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ib_register_mad_agent - Register to send/receive MADs.</span>
<span class="cm"> * @device: The device to register with.</span>
<span class="cm"> * @port_num: The port on the specified device to use.</span>
<span class="cm"> * @qp_type: Specifies which QP to access.  Must be either</span>
<span class="cm"> *   IB_QPT_SMI or IB_QPT_GSI.</span>
<span class="cm"> * @mad_reg_req: Specifies which unsolicited MADs should be received</span>
<span class="cm"> *   by the caller.  This parameter may be NULL if the caller only</span>
<span class="cm"> *   wishes to receive solicited responses.</span>
<span class="cm"> * @rmpp_version: If set, indicates that the client will send</span>
<span class="cm"> *   and receive MADs that contain the RMPP header for the given version.</span>
<span class="cm"> *   If set to 0, indicates that RMPP is not used by this client.</span>
<span class="cm"> * @send_handler: The completion callback routine invoked after a send</span>
<span class="cm"> *   request has completed.</span>
<span class="cm"> * @recv_handler: The completion callback routine invoked for a received</span>
<span class="cm"> *   MAD.</span>
<span class="cm"> * @context: User specified context associated with the registration.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">ib_register_mad_agent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">port_num</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">ib_qp_type</span> <span class="n">qp_type</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ib_mad_reg_req</span> <span class="o">*</span><span class="n">mad_reg_req</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">rmpp_version</span><span class="p">,</span>
					   <span class="n">ib_mad_send_handler</span> <span class="n">send_handler</span><span class="p">,</span>
					   <span class="n">ib_mad_recv_handler</span> <span class="n">recv_handler</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">ib_mad_snoop_flags</span> <span class="p">{</span>
	<span class="cm">/*IB_MAD_SNOOP_POSTED_SENDS	   = 1,*/</span>
	<span class="cm">/*IB_MAD_SNOOP_RMPP_SENDS	   = (1&lt;&lt;1),*/</span>
	<span class="n">IB_MAD_SNOOP_SEND_COMPLETIONS</span>	   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span>
	<span class="cm">/*IB_MAD_SNOOP_RMPP_SEND_COMPLETIONS = (1&lt;&lt;3),*/</span>
	<span class="n">IB_MAD_SNOOP_RECVS</span>		   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span>
	<span class="cm">/*IB_MAD_SNOOP_RMPP_RECVS	   = (1&lt;&lt;5),*/</span>
	<span class="cm">/*IB_MAD_SNOOP_REDIRECTED_QPS	   = (1&lt;&lt;6)*/</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ib_register_mad_snoop - Register to snoop sent and received MADs.</span>
<span class="cm"> * @device: The device to register with.</span>
<span class="cm"> * @port_num: The port on the specified device to use.</span>
<span class="cm"> * @qp_type: Specifies which QP traffic to snoop.  Must be either</span>
<span class="cm"> *   IB_QPT_SMI or IB_QPT_GSI.</span>
<span class="cm"> * @mad_snoop_flags: Specifies information where snooping occurs.</span>
<span class="cm"> * @send_handler: The callback routine invoked for a snooped send.</span>
<span class="cm"> * @recv_handler: The callback routine invoked for a snooped receive.</span>
<span class="cm"> * @context: User specified context associated with the registration.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">ib_register_mad_snoop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">port_num</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">ib_qp_type</span> <span class="n">qp_type</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">mad_snoop_flags</span><span class="p">,</span>
					   <span class="n">ib_mad_snoop_handler</span> <span class="n">snoop_handler</span><span class="p">,</span>
					   <span class="n">ib_mad_recv_handler</span> <span class="n">recv_handler</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_unregister_mad_agent - Unregisters a client from using MAD services.</span>
<span class="cm"> * @mad_agent: Corresponding MAD registration request to deregister.</span>
<span class="cm"> *</span>
<span class="cm"> * After invoking this routine, MAD services are no longer usable by the</span>
<span class="cm"> * client on the associated QP.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ib_unregister_mad_agent</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">mad_agent</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_post_send_mad - Posts MAD(s) to the send queue of the QP associated</span>
<span class="cm"> *   with the registered client.</span>
<span class="cm"> * @send_buf: Specifies the information needed to send the MAD(s).</span>
<span class="cm"> * @bad_send_buf: Specifies the MAD on which an error was encountered.  This</span>
<span class="cm"> *   parameter is optional if only a single MAD is posted.</span>
<span class="cm"> *</span>
<span class="cm"> * Sent MADs are not guaranteed to complete in the order that they were posted.</span>
<span class="cm"> *</span>
<span class="cm"> * If the MAD requires RMPP, the data buffer should contain a single copy</span>
<span class="cm"> * of the common MAD, RMPP, and class specific headers, followed by the class</span>
<span class="cm"> * defined data.  If the class defined data would not divide evenly into</span>
<span class="cm"> * RMPP segments, then space must be allocated at the end of the referenced</span>
<span class="cm"> * buffer for any required padding.  To indicate the amount of class defined</span>
<span class="cm"> * data being transferred, the paylen_newwin field in the RMPP header should</span>
<span class="cm"> * be set to the size of the class specific header plus the amount of class</span>
<span class="cm"> * defined data being transferred.  The paylen_newwin field should be</span>
<span class="cm"> * specified in network-byte order.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ib_post_send_mad</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">*</span><span class="n">send_buf</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">**</span><span class="n">bad_send_buf</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * ib_free_recv_mad - Returns data buffers used to receive a MAD.</span>
<span class="cm"> * @mad_recv_wc: Work completion information for a received MAD.</span>
<span class="cm"> *</span>
<span class="cm"> * Clients receiving MADs through their ib_mad_recv_handler must call this</span>
<span class="cm"> * routine to return the work completion buffers to the access layer.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">ib_free_recv_mad</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_recv_wc</span> <span class="o">*</span><span class="n">mad_recv_wc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_cancel_mad - Cancels an outstanding send MAD operation.</span>
<span class="cm"> * @mad_agent: Specifies the registration associated with sent MAD.</span>
<span class="cm"> * @send_buf: Indicates the MAD to cancel.</span>
<span class="cm"> *</span>
<span class="cm"> * MADs will be returned to the user through the corresponding</span>
<span class="cm"> * ib_mad_send_handler.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">ib_cancel_mad</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">mad_agent</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">*</span><span class="n">send_buf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_modify_mad - Modifies an outstanding send MAD operation.</span>
<span class="cm"> * @mad_agent: Specifies the registration associated with sent MAD.</span>
<span class="cm"> * @send_buf: Indicates the MAD to modify.</span>
<span class="cm"> * @timeout_ms: New timeout value for sent MAD.</span>
<span class="cm"> *</span>
<span class="cm"> * This call will reset the timeout value for a sent MAD to the specified</span>
<span class="cm"> * value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ib_modify_mad</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">mad_agent</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">*</span><span class="n">send_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout_ms</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_redirect_mad_qp - Registers a QP for MAD services.</span>
<span class="cm"> * @qp: Reference to a QP that requires MAD services.</span>
<span class="cm"> * @rmpp_version: If set, indicates that the client will send</span>
<span class="cm"> *   and receive MADs that contain the RMPP header for the given version.</span>
<span class="cm"> *   If set to 0, indicates that RMPP is not used by this client.</span>
<span class="cm"> * @send_handler: The completion callback routine invoked after a send</span>
<span class="cm"> *   request has completed.</span>
<span class="cm"> * @recv_handler: The completion callback routine invoked for a received</span>
<span class="cm"> *   MAD.</span>
<span class="cm"> * @context: User specified context associated with the registration.</span>
<span class="cm"> *</span>
<span class="cm"> * Use of this call allows clients to use MAD services, such as RMPP,</span>
<span class="cm"> * on user-owned QPs.  After calling this routine, users may send</span>
<span class="cm"> * MADs on the specified QP by calling ib_mad_post_send.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">ib_redirect_mad_qp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_qp</span> <span class="o">*</span><span class="n">qp</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">rmpp_version</span><span class="p">,</span>
					<span class="n">ib_mad_send_handler</span> <span class="n">send_handler</span><span class="p">,</span>
					<span class="n">ib_mad_recv_handler</span> <span class="n">recv_handler</span><span class="p">,</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_process_mad_wc - Processes a work completion associated with a</span>
<span class="cm"> *   MAD sent or received on a redirected QP.</span>
<span class="cm"> * @mad_agent: Specifies the registered MAD service using the redirected QP.</span>
<span class="cm"> * @wc: References a work completion associated with a sent or received</span>
<span class="cm"> *   MAD segment.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is used to complete or continue processing on a MAD request.</span>
<span class="cm"> * If the work completion is associated with a send operation, calling</span>
<span class="cm"> * this routine is required to continue an RMPP transfer or to wait for a</span>
<span class="cm"> * corresponding response, if it is a request.  If the work completion is</span>
<span class="cm"> * associated with a receive operation, calling this routine is required to</span>
<span class="cm"> * process an inbound or outbound RMPP transfer, or to match a response MAD</span>
<span class="cm"> * with its corresponding request.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ib_process_mad_wc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">mad_agent</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ib_wc</span> <span class="o">*</span><span class="n">wc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_create_send_mad - Allocate and initialize a data buffer and work request</span>
<span class="cm"> *   for sending a MAD.</span>
<span class="cm"> * @mad_agent: Specifies the registered MAD service to associate with the MAD.</span>
<span class="cm"> * @remote_qpn: Specifies the QPN of the receiving node.</span>
<span class="cm"> * @pkey_index: Specifies which PKey the MAD will be sent using.  This field</span>
<span class="cm"> *   is valid only if the remote_qpn is QP 1.</span>
<span class="cm"> * @rmpp_active: Indicates if the send will enable RMPP.</span>
<span class="cm"> * @hdr_len: Indicates the size of the data header of the MAD.  This length</span>
<span class="cm"> *   should include the common MAD header, RMPP header, plus any class</span>
<span class="cm"> *   specific header.</span>
<span class="cm"> * @data_len: Indicates the size of any user-transferred data.  The call will</span>
<span class="cm"> *   automatically adjust the allocated buffer size to account for any</span>
<span class="cm"> *   additional padding that may be necessary.</span>
<span class="cm"> * @gfp_mask: GFP mask used for the memory allocation.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine allocates a MAD for sending.  The returned MAD send buffer</span>
<span class="cm"> * will reference a data buffer usable for sending a MAD, along</span>
<span class="cm"> * with an initialized work request structure.  Users may modify the returned</span>
<span class="cm"> * MAD data buffer before posting the send.</span>
<span class="cm"> *</span>
<span class="cm"> * The returned MAD header, class specific headers, and any padding will be</span>
<span class="cm"> * cleared.  Users are responsible for initializing the common MAD header,</span>
<span class="cm"> * any class specific header, and MAD data area.</span>
<span class="cm"> * If @rmpp_active is set, the RMPP header will be initialized for sending.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">*</span><span class="n">ib_create_send_mad</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_agent</span> <span class="o">*</span><span class="n">mad_agent</span><span class="p">,</span>
					   <span class="n">u32</span> <span class="n">remote_qpn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pkey_index</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">rmpp_active</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span>
					   <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_is_mad_class_rmpp - returns whether given management class</span>
<span class="cm"> * supports RMPP.</span>
<span class="cm"> * @mgmt_class: management class</span>
<span class="cm"> *</span>
<span class="cm"> * This routine returns whether the management class supports RMPP.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ib_is_mad_class_rmpp</span><span class="p">(</span><span class="n">u8</span> <span class="n">mgmt_class</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_get_mad_data_offset - returns the data offset for a given</span>
<span class="cm"> * management class.</span>
<span class="cm"> * @mgmt_class: management class</span>
<span class="cm"> *</span>
<span class="cm"> * This routine returns the data offset in the MAD for the management</span>
<span class="cm"> * class requested.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ib_get_mad_data_offset</span><span class="p">(</span><span class="n">u8</span> <span class="n">mgmt_class</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_get_rmpp_segment - returns the data buffer for a given RMPP segment.</span>
<span class="cm"> * @send_buf: Previously allocated send data buffer.</span>
<span class="cm"> * @seg_num: number of segment to return</span>
<span class="cm"> *</span>
<span class="cm"> * This routine returns a pointer to the data buffer of an RMPP MAD.</span>
<span class="cm"> * Users must provide synchronization to @send_buf around this call.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">ib_get_rmpp_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">*</span><span class="n">send_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg_num</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ib_free_send_mad - Returns data buffers used to send a MAD.</span>
<span class="cm"> * @send_buf: Previously allocated send data buffer.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">ib_free_send_mad</span><span class="p">(</span><span class="k">struct</span> <span class="n">ib_mad_send_buf</span> <span class="o">*</span><span class="n">send_buf</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* IB_MAD_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
