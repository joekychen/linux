<!DOCTYPE html>
<html><head><title>joekychen/linux » include › net › dn_dev.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dn_dev.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _NET_DN_DEV_H</span>
<span class="cp">#define _NET_DN_DEV_H</span>


<span class="k">struct</span> <span class="n">dn_dev</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dn_ifaddr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_ifaddr</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">ifa_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_dev</span>    <span class="o">*</span><span class="n">ifa_dev</span><span class="p">;</span>
	<span class="n">__le16</span>            <span class="n">ifa_local</span><span class="p">;</span>
	<span class="n">__le16</span>            <span class="n">ifa_address</span><span class="p">;</span>
	<span class="n">__u8</span>              <span class="n">ifa_flags</span><span class="p">;</span>
	<span class="n">__u8</span>              <span class="n">ifa_scope</span><span class="p">;</span>
	<span class="kt">char</span>              <span class="n">ifa_label</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rcu_head</span>   <span class="n">rcu</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DN_DEV_S_RU  0 </span><span class="cm">/* Run - working normally   */</span><span class="cp"></span>
<span class="cp">#define DN_DEV_S_CR  1 </span><span class="cm">/* Circuit Rejected         */</span><span class="cp"></span>
<span class="cp">#define DN_DEV_S_DS  2 </span><span class="cm">/* Data Link Start          */</span><span class="cp"></span>
<span class="cp">#define DN_DEV_S_RI  3 </span><span class="cm">/* Routing Layer Initialize */</span><span class="cp"></span>
<span class="cp">#define DN_DEV_S_RV  4 </span><span class="cm">/* Routing Layer Verify     */</span><span class="cp"></span>
<span class="cp">#define DN_DEV_S_RC  5 </span><span class="cm">/* Routing Layer Complete   */</span><span class="cp"></span>
<span class="cp">#define DN_DEV_S_OF  6 </span><span class="cm">/* Off                      */</span><span class="cp"></span>
<span class="cp">#define DN_DEV_S_HA  7 </span><span class="cm">/* Halt                     */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * The dn_dev_parms structure contains the set of parameters</span>
<span class="cm"> * for each device (hence inclusion in the dn_dev structure)</span>
<span class="cm"> * and an array is used to store the default types of supported</span>
<span class="cm"> * device (in dn_dev.c).</span>
<span class="cm"> *</span>
<span class="cm"> * The type field matches the ARPHRD_ constants and is used in</span>
<span class="cm"> * searching the list for supported devices when new devices</span>
<span class="cm"> * come up.</span>
<span class="cm"> *</span>
<span class="cm"> * The mode field is used to find out if a device is broadcast,</span>
<span class="cm"> * multipoint, or pointopoint. Please note that DECnet thinks</span>
<span class="cm"> * different ways about devices to the rest of the kernel</span>
<span class="cm"> * so the normal IFF_xxx flags are invalid here. For devices</span>
<span class="cm"> * which can be any combination of the previously mentioned</span>
<span class="cm"> * attributes, you can set this on a per device basis by</span>
<span class="cm"> * installing an up() routine.</span>
<span class="cm"> *</span>
<span class="cm"> * The device state field, defines the initial state in which the</span>
<span class="cm"> * device will come up. In the dn_dev structure, it is the actual</span>
<span class="cm"> * state.</span>
<span class="cm"> *</span>
<span class="cm"> * Things have changed here. I&#39;ve killed timer1 since it&#39;s a user space</span>
<span class="cm"> * issue for a user space routing deamon to sort out. The kernel does</span>
<span class="cm"> * not need to be bothered with it.</span>
<span class="cm"> *</span>
<span class="cm"> * Timers:</span>
<span class="cm"> * t2 - Rate limit timer, min time between routing and hello messages</span>
<span class="cm"> * t3 - Hello timer, send hello messages when it expires</span>
<span class="cm"> *</span>
<span class="cm"> * Callbacks:</span>
<span class="cm"> * up() - Called to initialize device, return value can veto use of</span>
<span class="cm"> *        device with DECnet.</span>
<span class="cm"> * down() - Called to turn device off when it goes down</span>
<span class="cm"> * timer3() - Called once for each ifaddr when timer 3 goes off</span>
<span class="cm"> * </span>
<span class="cm"> * sysctl - Hook for sysctl things</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dn_dev_parms</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>	          <span class="cm">/* ARPHRD_xxx                         */</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>	          <span class="cm">/* Broadcast, Unicast, Mulitpoint     */</span>
<span class="cp">#define DN_DEV_BCAST  1</span>
<span class="cp">#define DN_DEV_UCAST  2</span>
<span class="cp">#define DN_DEV_MPOINT 4</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>                <span class="cm">/* Initial state                      */</span>
	<span class="kt">int</span> <span class="n">forwarding</span><span class="p">;</span>	          <span class="cm">/* 0=EndNode, 1=L1Router, 2=L2Router  */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t2</span><span class="p">;</span>         <span class="cm">/* Default value of t2                */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t3</span><span class="p">;</span>         <span class="cm">/* Default value of t3                */</span>
	<span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>             <span class="cm">/* Priority to be a router            */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>               <span class="cm">/* Name for sysctl                    */</span>
	<span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">down</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">timer3</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dn_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sysctl</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">dn_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_ifaddr</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">ifa_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_dev_parms</span> <span class="n">parms</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">use_long</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">neigh_parms</span> <span class="o">*</span><span class="n">neigh_parms</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">router</span><span class="p">;</span> <span class="cm">/* Default router on circuit */</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>   <span class="cm">/* Peer on pointopoint links */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uptime</span><span class="p">;</span>     <span class="cm">/* Time device went up in jiffies */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dn_short_packet</span> <span class="p">{</span>
	<span class="n">__u8</span>    <span class="n">msgflg</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">dstnode</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">srcnode</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">forward</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dn_long_packet</span> <span class="p">{</span>
	<span class="n">__u8</span>   <span class="n">msgflg</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">d_area</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">d_subarea</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">d_id</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__u8</span>   <span class="n">s_area</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">s_subarea</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">s_id</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__u8</span>   <span class="n">nl2</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">visit_ct</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">s_class</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">pt</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*------------------------- DRP - Routing messages ---------------------*/</span>

<span class="k">struct</span> <span class="n">endnode_hello_message</span> <span class="p">{</span>
	<span class="n">__u8</span>   <span class="n">msgflg</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">tiver</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__u8</span>   <span class="n">id</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__u8</span>   <span class="n">iinfo</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">blksize</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">area</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">seed</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__u8</span>   <span class="n">neighbor</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">timer</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">mpd</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">datalen</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">rtnode_hello_message</span> <span class="p">{</span>
	<span class="n">__u8</span>   <span class="n">msgflg</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">tiver</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__u8</span>   <span class="n">id</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__u8</span>   <span class="n">iinfo</span><span class="p">;</span>
	<span class="n">__le16</span>  <span class="n">blksize</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">priority</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">area</span><span class="p">;</span>
	<span class="n">__le16</span>  <span class="n">timer</span><span class="p">;</span>
	<span class="n">__u8</span>   <span class="n">mpd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>


<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dn_dev_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_devices_off</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_devices_on</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_init_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_veri_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_hello</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dn_dev_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dn_dev_set_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dn_dev_get_default</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">dn_dev_bind_default</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="n">addr</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">register_dnaddr_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">unregister_dnaddr_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dn_dev_islocal</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dn_dev</span> <span class="o">*</span><span class="n">dn_db</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dn_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">dn_db</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dn_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dn_db</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dn_dev_islocal: Called for non DECnet device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dn_db</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">);</span>
	     <span class="n">ifa</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">ifa</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_next</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">^</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* _NET_DN_DEV_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
