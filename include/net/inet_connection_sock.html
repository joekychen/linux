<!DOCTYPE html>
<html><head><title>joekychen/linux » include › net › inet_connection_sock.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>inet_connection_sock.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * NET		Generic infrastructure for INET connection oriented protocols.</span>
<span class="cm"> *</span>
<span class="cm"> *		Definitions for inet_connection_sock </span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Many people, see the TCP sources</span>
<span class="cm"> *</span>
<span class="cm"> * 		From code originally in TCP</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _INET_CONNECTION_SOCK_H</span>
<span class="cp">#define _INET_CONNECTION_SOCK_H</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>

<span class="cp">#include &lt;net/inet_sock.h&gt;</span>
<span class="cp">#include &lt;net/request_sock.h&gt;</span>

<span class="cp">#define INET_CSK_DEBUG 1</span>

<span class="cm">/* Cancel timers, when they are not required. */</span>
<span class="cp">#undef INET_CSK_CLEAR_TIMERS</span>

<span class="k">struct</span> <span class="n">inet_bind_bucket</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">tcp_congestion_ops</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Pointers to address related TCP functions</span>
<span class="cm"> * (i.e. things that depend on the address family)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">inet_connection_sock_af_ops</span> <span class="p">{</span>
	<span class="kt">int</span>	    <span class="p">(</span><span class="o">*</span><span class="n">queue_xmit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">flowi</span> <span class="o">*</span><span class="n">fl</span><span class="p">);</span>
	<span class="kt">void</span>	    <span class="p">(</span><span class="o">*</span><span class="n">send_check</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span>	    <span class="p">(</span><span class="o">*</span><span class="n">rebuild_header</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
	<span class="kt">int</span>	    <span class="p">(</span><span class="o">*</span><span class="n">conn_request</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">syn_recv_sock</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inet_peer</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_peer</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">release_it</span><span class="p">);</span>
	<span class="n">u16</span>	    <span class="n">net_header_len</span><span class="p">;</span>
	<span class="n">u16</span>	    <span class="n">net_frag_header_len</span><span class="p">;</span>
	<span class="n">u16</span>	    <span class="n">sockaddr_len</span><span class="p">;</span>
	<span class="kt">int</span>	    <span class="p">(</span><span class="o">*</span><span class="n">setsockopt</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> 
				  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="kt">int</span>	    <span class="p">(</span><span class="o">*</span><span class="n">getsockopt</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> 
				  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="kt">int</span>	    <span class="p">(</span><span class="o">*</span><span class="n">compat_setsockopt</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
				<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">);</span>
	<span class="kt">int</span>	    <span class="p">(</span><span class="o">*</span><span class="n">compat_getsockopt</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
				<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="kt">void</span>	    <span class="p">(</span><span class="o">*</span><span class="n">addr2sockaddr</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>	    <span class="p">(</span><span class="o">*</span><span class="n">bind_conflict</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">inet_bind_bucket</span> <span class="o">*</span><span class="n">tb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">relax</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/** inet_connection_sock - INET connection oriented sock</span>
<span class="cm"> *</span>
<span class="cm"> * @icsk_accept_queue:	   FIFO of established children </span>
<span class="cm"> * @icsk_bind_hash:	   Bind node</span>
<span class="cm"> * @icsk_timeout:	   Timeout</span>
<span class="cm"> * @icsk_retransmit_timer: Resend (no ack)</span>
<span class="cm"> * @icsk_rto:		   Retransmit timeout</span>
<span class="cm"> * @icsk_pmtu_cookie	   Last pmtu seen by socket</span>
<span class="cm"> * @icsk_ca_ops		   Pluggable congestion control hook</span>
<span class="cm"> * @icsk_af_ops		   Operations which are AF_INET{4,6} specific</span>
<span class="cm"> * @icsk_ca_state:	   Congestion control state</span>
<span class="cm"> * @icsk_retransmits:	   Number of unrecovered [RTO] timeouts</span>
<span class="cm"> * @icsk_pending:	   Scheduled timer event</span>
<span class="cm"> * @icsk_backoff:	   Backoff</span>
<span class="cm"> * @icsk_syn_retries:      Number of allowed SYN (or equivalent) retries</span>
<span class="cm"> * @icsk_probes_out:	   unanswered 0 window probes</span>
<span class="cm"> * @icsk_ext_hdr_len:	   Network protocol overhead (IP/IPv6 options)</span>
<span class="cm"> * @icsk_ack:		   Delayed ACK control data</span>
<span class="cm"> * @icsk_mtup;		   MTU probing control data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="p">{</span>
	<span class="cm">/* inet_sock has to be the first member! */</span>
	<span class="k">struct</span> <span class="n">inet_sock</span>	  <span class="n">icsk_inet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sock_queue</span> <span class="n">icsk_accept_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inet_bind_bucket</span>	  <span class="o">*</span><span class="n">icsk_bind_hash</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		  <span class="n">icsk_timeout</span><span class="p">;</span>
 	<span class="k">struct</span> <span class="n">timer_list</span>	  <span class="n">icsk_retransmit_timer</span><span class="p">;</span>
 	<span class="k">struct</span> <span class="n">timer_list</span>	  <span class="n">icsk_delack_timer</span><span class="p">;</span>
	<span class="n">__u32</span>			  <span class="n">icsk_rto</span><span class="p">;</span>
	<span class="n">__u32</span>			  <span class="n">icsk_pmtu_cookie</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_congestion_ops</span> <span class="o">*</span><span class="n">icsk_ca_ops</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inet_connection_sock_af_ops</span> <span class="o">*</span><span class="n">icsk_af_ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		  <span class="p">(</span><span class="o">*</span><span class="n">icsk_sync_mss</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pmtu</span><span class="p">);</span>
	<span class="n">__u8</span>			  <span class="n">icsk_ca_state</span><span class="p">;</span>
	<span class="n">__u8</span>			  <span class="n">icsk_retransmits</span><span class="p">;</span>
	<span class="n">__u8</span>			  <span class="n">icsk_pending</span><span class="p">;</span>
	<span class="n">__u8</span>			  <span class="n">icsk_backoff</span><span class="p">;</span>
	<span class="n">__u8</span>			  <span class="n">icsk_syn_retries</span><span class="p">;</span>
	<span class="n">__u8</span>			  <span class="n">icsk_probes_out</span><span class="p">;</span>
	<span class="n">__u16</span>			  <span class="n">icsk_ext_hdr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__u8</span>		  <span class="n">pending</span><span class="p">;</span>	 <span class="cm">/* ACK is pending			   */</span>
		<span class="n">__u8</span>		  <span class="n">quick</span><span class="p">;</span>	 <span class="cm">/* Scheduled number of quick acks	   */</span>
		<span class="n">__u8</span>		  <span class="n">pingpong</span><span class="p">;</span>	 <span class="cm">/* The session is interactive		   */</span>
		<span class="n">__u8</span>		  <span class="n">blocked</span><span class="p">;</span>	 <span class="cm">/* Delayed ACK was blocked by socket lock */</span>
		<span class="n">__u32</span>		  <span class="n">ato</span><span class="p">;</span>		 <span class="cm">/* Predicted tick of soft clock	   */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>	  <span class="n">timeout</span><span class="p">;</span>	 <span class="cm">/* Currently scheduled timeout		   */</span>
		<span class="n">__u32</span>		  <span class="n">lrcvtime</span><span class="p">;</span>	 <span class="cm">/* timestamp of last received data packet */</span>
		<span class="n">__u16</span>		  <span class="n">last_seg_size</span><span class="p">;</span> <span class="cm">/* Size of last incoming segment	   */</span>
		<span class="n">__u16</span>		  <span class="n">rcv_mss</span><span class="p">;</span>	 <span class="cm">/* MSS used for delayed ACK decisions	   */</span> 
	<span class="p">}</span> <span class="n">icsk_ack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span>		  <span class="n">enabled</span><span class="p">;</span>

		<span class="cm">/* Range of MTUs to search */</span>
		<span class="kt">int</span>		  <span class="n">search_high</span><span class="p">;</span>
		<span class="kt">int</span>		  <span class="n">search_low</span><span class="p">;</span>

		<span class="cm">/* Information on the current probe. */</span>
		<span class="kt">int</span>		  <span class="n">probe_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">icsk_mtup</span><span class="p">;</span>
	<span class="n">u32</span>			  <span class="n">icsk_ca_priv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span>			  <span class="n">icsk_user_timeout</span><span class="p">;</span>
<span class="cp">#define ICSK_CA_PRIV_SIZE	(16 * sizeof(u32))</span>
<span class="p">};</span>

<span class="cp">#define ICSK_TIME_RETRANS	1	</span><span class="cm">/* Retransmit timer */</span><span class="cp"></span>
<span class="cp">#define ICSK_TIME_DACK		2	</span><span class="cm">/* Delayed ack timer */</span><span class="cp"></span>
<span class="cp">#define ICSK_TIME_PROBE0	3	</span><span class="cm">/* Zero window probe timer */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="nf">inet_csk</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">inet_csk_ca</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ca_priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">inet_csk_clone_lock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					<span class="k">const</span> <span class="n">gfp_t</span> <span class="n">priority</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">inet_csk_ack_state_t</span> <span class="p">{</span>
	<span class="n">ICSK_ACK_SCHED</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ICSK_ACK_TIMER</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ICSK_ACK_PUSHED</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ICSK_ACK_PUSHED2</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_init_xmit_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">retransmit_handler</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
				      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">delack_handler</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
				      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">keepalive_handler</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_clear_xmit_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_schedule_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">pending</span> <span class="o">|=</span> <span class="n">ICSK_ACK_SCHED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">inet_csk_ack_scheduled</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ICSK_ACK_SCHED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_delack_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_delete_keepalive_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_reset_keepalive_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">);</span>

<span class="cp">#ifdef INET_CSK_DEBUG</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">inet_csk_timer_bug_msg</span><span class="p">[];</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_clear_xmit_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="n">ICSK_TIME_RETRANS</span> <span class="o">||</span> <span class="n">what</span> <span class="o">==</span> <span class="n">ICSK_TIME_PROBE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef INET_CSK_CLEAR_TIMERS</span>
		<span class="n">sk_stop_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_retransmit_timer</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="n">ICSK_TIME_DACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">blocked</span> <span class="o">=</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef INET_CSK_CLEAR_TIMERS</span>
		<span class="n">sk_stop_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_delack_timer</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#ifdef INET_CSK_DEBUG</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">inet_csk_timer_bug_msg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Reset the retransmission timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_reset_xmit_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">what</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">when</span><span class="p">,</span>
					     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_when</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">when</span> <span class="o">&gt;</span> <span class="n">max_when</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef INET_CSK_DEBUG</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;reset_xmit_timer: sk=%p %d when=0x%lx, caller=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">sk</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">current_text_addr</span><span class="p">());</span>
<span class="cp">#endif</span>
		<span class="n">when</span> <span class="o">=</span> <span class="n">max_when</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="n">ICSK_TIME_RETRANS</span> <span class="o">||</span> <span class="n">what</span> <span class="o">==</span> <span class="n">ICSK_TIME_PROBE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_pending</span> <span class="o">=</span> <span class="n">what</span><span class="p">;</span>
		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">when</span><span class="p">;</span>
		<span class="n">sk_reset_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_retransmit_timer</span><span class="p">,</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_timeout</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="n">ICSK_TIME_DACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">pending</span> <span class="o">|=</span> <span class="n">ICSK_ACK_TIMER</span><span class="p">;</span>
		<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">when</span><span class="p">;</span>
		<span class="n">sk_reset_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_delack_timer</span><span class="p">,</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_ack</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef INET_CSK_DEBUG</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">inet_csk_timer_bug_msg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">inet_csk_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">inet_csk_search_req</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">***</span><span class="n">prevp</span><span class="p">,</span>
						<span class="k">const</span> <span class="n">__be16</span> <span class="n">rport</span><span class="p">,</span>
						<span class="k">const</span> <span class="n">__be32</span> <span class="n">raddr</span><span class="p">,</span>
						<span class="k">const</span> <span class="n">__be32</span> <span class="n">laddr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">inet_csk_bind_conflict</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">inet_bind_bucket</span> <span class="o">*</span><span class="n">tb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">relax</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">inet_csk_get_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">snum</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">dst_entry</span><span class="o">*</span> <span class="n">inet_csk_route_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">fl4</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">dst_entry</span><span class="o">*</span> <span class="n">inet_csk_route_child_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">newsk</span><span class="p">,</span>
						   <span class="k">const</span> <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_reqsk_queue_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reqsk_queue_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_reqsk_queue_hash_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_reqsk_queue_removed</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqsk_queue_removed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">inet_csk_delete_keepalive_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_reqsk_queue_added</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqsk_queue_added</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">inet_csk_reset_keepalive_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">inet_csk_reqsk_queue_len</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reqsk_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">inet_csk_reqsk_queue_young</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reqsk_queue_len_young</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">inet_csk_reqsk_queue_is_full</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reqsk_queue_is_full</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_reqsk_queue_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">**</span><span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reqsk_queue_unlink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inet_csk_reqsk_queue_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">request_sock</span> <span class="o">**</span><span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inet_csk_reqsk_queue_unlink</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
	<span class="n">inet_csk_reqsk_queue_removed</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">reqsk_free</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_reqsk_queue_prune</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_rto</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_destroy_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * LISTEN is a special case for poll..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">inet_csk_listen_poll</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">reqsk_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_accept_queue</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span>  <span class="n">inet_csk_listen_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">nr_table_entries</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_listen_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">inet_csk_addr2sockaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">inet_csk_compat_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optlen</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">inet_csk_compat_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* _INET_CONNECTION_SOCK_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
