<!DOCTYPE html>
<html><head><title>joekychen/linux » include › net › dst.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dst.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * net/dst.h	Protocol independent destination cache definitions.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Alexey Kuznetsov, &lt;kuznet@ms2.inr.ac.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _NET_DST_H</span>
<span class="cp">#define _NET_DST_H</span>

<span class="cp">#include &lt;net/dst_ops.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;net/neighbour.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>

<span class="cp">#define DST_GC_MIN	(HZ/10)</span>
<span class="cp">#define DST_GC_INC	(HZ/2)</span>
<span class="cp">#define DST_GC_MAX	(120*HZ)</span>

<span class="cm">/* Each dst_entry has reference count and sits in some parent list(s).</span>
<span class="cm"> * When it is removed from parent list, it is &quot;freed&quot; (dst_free).</span>
<span class="cm"> * After this it enters dead state (dst-&gt;obsolete &gt; 0) and if its refcnt</span>
<span class="cm"> * is zero, it can be destroyed immediately, otherwise it is added</span>
<span class="cm"> * to gc list and garbage collector periodically checks the refcnt.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">sk_buff</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dst_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rcu_head</span>		<span class="n">rcu_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span>	<span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>       <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">dst_ops</span>	        <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">_metrics</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>           <span class="n">expires</span><span class="p">;</span>
		<span class="cm">/* point to where the dst_entry copied from */</span>
		<span class="k">struct</span> <span class="n">dst_entry</span>        <span class="o">*</span><span class="n">from</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">dst_entry</span>	<span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="n">__rcu</span>	<span class="o">*</span><span class="n">_neighbour</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_XFRM</span>
	<span class="k">struct</span> <span class="n">xfrm_state</span>	<span class="o">*</span><span class="n">xfrm</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">__pad1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">input</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">output</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span><span class="p">);</span>

	<span class="kt">int</span>			<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define DST_HOST		0x0001</span>
<span class="cp">#define DST_NOXFRM		0x0002</span>
<span class="cp">#define DST_NOPOLICY		0x0004</span>
<span class="cp">#define DST_NOHASH		0x0008</span>
<span class="cp">#define DST_NOCACHE		0x0010</span>
<span class="cp">#define DST_NOCOUNT		0x0020</span>
<span class="cp">#define DST_NOPEER		0x0040</span>
<span class="cp">#define DST_FAKE_RTABLE		0x0080</span>
<span class="cp">#define DST_XFRM_TUNNEL		0x0100</span>

	<span class="kt">short</span>			<span class="n">error</span><span class="p">;</span>
	<span class="kt">short</span>			<span class="n">obsolete</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">header_len</span><span class="p">;</span>	<span class="cm">/* more space at head required */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">trailer_len</span><span class="p">;</span>	<span class="cm">/* space to reserve at tail */</span>
<span class="cp">#ifdef CONFIG_IP_ROUTE_CLASSID</span>
	<span class="n">__u32</span>			<span class="n">tclassid</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">__u32</span>			<span class="n">__pad2</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Align __refcnt to a 64 bytes alignment</span>
<span class="cm">	 * (L1_CACHE_SIZE would be too much)</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="kt">long</span>			<span class="n">__pad_to_align_refcnt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * __refcnt wants to be on a different cache line from</span>
<span class="cm">	 * input/output/ops or performance tanks badly</span>
<span class="cm">	 */</span>
	<span class="n">atomic_t</span>		<span class="n">__refcnt</span><span class="p">;</span>	<span class="cm">/* client references	*/</span>
	<span class="kt">int</span>			<span class="n">__use</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">lastuse</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dst_entry</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rtable</span> <span class="n">__rcu</span>	<span class="o">*</span><span class="n">rt_next</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rt6_info</span>		<span class="o">*</span><span class="n">rt6_next</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dn_route</span> <span class="n">__rcu</span>	<span class="o">*</span><span class="n">dn_next</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="nf">dst_get_neighbour_noref</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">_neighbour</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="nf">dst_get_neighbour_noref_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rcu_dereference_raw</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">_neighbour</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_set_neighbour</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">neigh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">_neighbour</span><span class="p">,</span> <span class="n">neigh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dst_cow_metrics_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">dst_default_metrics</span><span class="p">[</span><span class="n">RTAX_MAX</span><span class="p">];</span>

<span class="cp">#define DST_METRICS_READ_ONLY	0x1UL</span>
<span class="cp">#define __DST_METRICS_PTR(Y)	\</span>
<span class="cp">	((u32 *)((Y) &amp; ~DST_METRICS_READ_ONLY))</span>
<span class="cp">#define DST_METRICS_PTR(X)	__DST_METRICS_PTR((X)-&gt;_metrics)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">dst_metrics_read_only</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">_metrics</span> <span class="o">&amp;</span> <span class="n">DST_METRICS_READ_ONLY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">__dst_destroy_metrics_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_destroy_metrics_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">_metrics</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DST_METRICS_READ_ONLY</span><span class="p">))</span>
		<span class="n">__dst_destroy_metrics_generic</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">dst_metrics_write_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">_metrics</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">DST_METRICS_READ_ONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cow_metrics</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__DST_METRICS_PTR</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This may only be invoked before the entry has reached global</span>
<span class="cm"> * visibility.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_init_metrics</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src_metrics</span><span class="p">,</span>
				    <span class="n">bool</span> <span class="n">read_only</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">_metrics</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">src_metrics</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">read_only</span> <span class="o">?</span> <span class="n">DST_METRICS_READ_ONLY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_copy_metrics</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dst_metrics</span> <span class="o">=</span> <span class="n">dst_metrics_write_ptr</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_metrics</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">src_metrics</span> <span class="o">=</span> <span class="n">DST_METRICS_PTR</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst_metrics</span><span class="p">,</span> <span class="n">src_metrics</span><span class="p">,</span> <span class="n">RTAX_MAX</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">dst_metrics_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">DST_METRICS_PTR</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">dst_metric_raw</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">metric</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">DST_METRICS_PTR</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="n">metric</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">dst_metric</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">metric</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">metric</span> <span class="o">==</span> <span class="n">RTAX_HOPLIMIT</span> <span class="o">||</span>
		     <span class="n">metric</span> <span class="o">==</span> <span class="n">RTAX_ADVMSS</span> <span class="o">||</span>
		     <span class="n">metric</span> <span class="o">==</span> <span class="n">RTAX_MTU</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dst_metric_raw</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">metric</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">dst_metric_advmss</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">advmss</span> <span class="o">=</span> <span class="n">dst_metric_raw</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_ADVMSS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">advmss</span><span class="p">)</span>
		<span class="n">advmss</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">default_advmss</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">advmss</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_metric_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">metric</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dst_metrics_write_ptr</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">p</span><span class="p">[</span><span class="n">metric</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">dst_feature</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">feature</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dst_metric</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_FEATURES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">feature</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">dst_mtu</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* RTT metrics are stored in milliseconds for user ABI, but used as jiffies */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dst_metric_rtt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">metric</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">dst_metric</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">metric</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_dst_metric_rtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">metric</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst_metric_set</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">rtt</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">dst_allfrag</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">dst_feature</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span>  <span class="n">RTAX_FEATURE_ALLFRAG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">dst_metric_locked</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">metric</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dst_metric</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">RTAX_LOCK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">metric</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span> <span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If your kernel compilation stops here, please check</span>
<span class="cm">	 * __pad_to_align_refcnt declaration in struct dst_entry</span>
<span class="cm">	 */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span><span class="p">,</span> <span class="n">__refcnt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">__refcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst_hold</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">__use</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">lastuse</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_use_noref</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">__use</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">lastuse</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span> <span class="nf">dst_clone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span> <span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">__refcnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">dst_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">refdst_drop</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">refdst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">refdst</span> <span class="o">&amp;</span> <span class="n">SKB_DST_NOREF</span><span class="p">))</span>
		<span class="n">dst_release</span><span class="p">((</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="p">)(</span><span class="n">refdst</span> <span class="o">&amp;</span> <span class="n">SKB_DST_PTRMASK</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * skb_dst_drop - drops skb dst</span>
<span class="cm"> * @skb: buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Drops dst reference count if a reference was taken.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">skb_dst_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">_skb_refdst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">refdst_drop</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">_skb_refdst</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">_skb_refdst</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">skb_dst_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">oskb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nskb</span><span class="o">-&gt;</span><span class="n">_skb_refdst</span> <span class="o">=</span> <span class="n">oskb</span><span class="o">-&gt;</span><span class="n">_skb_refdst</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nskb</span><span class="o">-&gt;</span><span class="n">_skb_refdst</span> <span class="o">&amp;</span> <span class="n">SKB_DST_NOREF</span><span class="p">))</span>
		<span class="n">dst_clone</span><span class="p">(</span><span class="n">skb_dst</span><span class="p">(</span><span class="n">nskb</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * skb_dst_force - makes sure skb dst is refcounted</span>
<span class="cm"> * @skb: buffer</span>
<span class="cm"> *</span>
<span class="cm"> * If dst is not yet refcounted, let&#39;s do it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">skb_dst_force</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_dst_is_noref</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rcu_read_lock_held</span><span class="p">());</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">_skb_refdst</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKB_DST_NOREF</span><span class="p">;</span>
		<span class="n">dst_clone</span><span class="p">(</span><span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	__skb_tunnel_rx - prepare skb for rx reinsert</span>
<span class="cm"> *	@skb: buffer</span>
<span class="cm"> *	@dev: tunnel device</span>
<span class="cm"> *</span>
<span class="cm"> *	After decapsulation, packet is going to re-enter (netif_rx()) our stack,</span>
<span class="cm"> *	so make some cleanups. (no accounting done)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__skb_tunnel_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear rxhash so that we can recalulate the hash for the</span>
<span class="cm">	 * encapsulated packet, unless we have already determine the hash</span>
<span class="cm">	 * over the L4 4-tuple.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">l4_rxhash</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">skb_dst_drop</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">nf_reset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	skb_tunnel_rx - prepare skb for rx reinsert</span>
<span class="cm"> *	@skb: buffer</span>
<span class="cm"> *	@dev: tunnel device</span>
<span class="cm"> *</span>
<span class="cm"> *	After decapsulation, packet is going to re-enter (netif_rx()) our stack,</span>
<span class="cm"> *	so make some cleanups, and perform accounting.</span>
<span class="cm"> *	Note: this accounting is not SMP safe.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">skb_tunnel_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO : stats should be SMP safe */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">__skb_tunnel_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Children define the path of the packet through the</span>
<span class="cm"> * Linux networking.  Thus, destinations are stackable.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="nf">skb_dst_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">dst_clone</span><span class="p">(</span><span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">);</span>

	<span class="n">skb_dst_drop</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">child</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dst_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dst_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_ops</span> <span class="o">*</span> <span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">initial_ref</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial_obsolete</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__dst_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span> <span class="n">dst</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span> <span class="n">dst</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span> <span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">obsolete</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">__refcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">dst_destroy</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__dst_free</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_rcu_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span><span class="p">,</span> <span class="n">rcu_head</span><span class="p">);</span>
	<span class="n">dst_free</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">dst_get_neighbour_noref</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">neigh_confirm</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="nf">dst_neigh_lookup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">neigh_lookup</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">daddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_link_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">link_failure</span><span class="p">)</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">link_failure</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dst_set_expires</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">expires</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">expires</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">time_before</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">))</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">expires</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Output packet to network from transport.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dst_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Input packet from network to transport.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dst_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="nf">dst_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">obsolete</span><span class="p">)</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span>		<span class="n">dst_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Flags for xfrm_lookup flags argument. */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">XFRM_LOOKUP_ICMP</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">flowi</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_XFRM</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="nf">xfrm_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst_orig</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">flowi</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dst_orig</span><span class="p">;</span>
<span class="p">}</span> 
<span class="cp">#else</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">xfrm_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst_orig</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">flowi</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* _NET_DST_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
