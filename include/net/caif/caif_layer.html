<!DOCTYPE html>
<html><head><title>joekychen/linux » include › net › caif › caif_layer.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>caif_layer.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson AB 2010</span>
<span class="cm"> * Author:	Sjur Brendeland / sjur.brandeland@stericsson.com</span>
<span class="cm"> * License terms: GNU General Public License (GPL) version 2</span>
<span class="cm"> */</span>

<span class="cp">#ifndef CAIF_LAYER_H_</span>
<span class="cp">#define CAIF_LAYER_H_</span>

<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="k">struct</span> <span class="n">cflayer</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">cfpkt</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">cfpktq</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">caif_payload_info</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">caif_packet_funcs</span><span class="p">;</span>

<span class="cp">#define CAIF_LAYER_NAME_SZ 16</span>

<span class="cm">/**</span>
<span class="cm"> * caif_assert() - Assert function for CAIF.</span>
<span class="cm"> * @assert: expression to evaluate.</span>
<span class="cm"> *</span>
<span class="cm"> * This function will print a error message and a do WARN_ON if the</span>
<span class="cm"> * assertion failes. Normally this will do a stack up at the current location.</span>
<span class="cm"> */</span>
<span class="cp">#define caif_assert(assert)					\</span>
<span class="cp">do {								\</span>
<span class="cp">	if (!(assert)) {					\</span>
<span class="cp">		pr_err(&quot;caif:Assert detected:&#39;%s&#39;\n&quot;, #assert); \</span>
<span class="cp">		WARN_ON(!(assert));				\</span>
<span class="cp">	}							\</span>
<span class="cp">} while (0)</span>

<span class="cm">/**</span>
<span class="cm"> * enum caif_ctrlcmd - CAIF Stack Control Signaling sent in layer.ctrlcmd().</span>
<span class="cm"> *</span>
<span class="cm"> * @CAIF_CTRLCMD_FLOW_OFF_IND:		Flow Control is OFF, transmit function</span>
<span class="cm"> *					should stop sending data</span>
<span class="cm"> *</span>
<span class="cm"> * @CAIF_CTRLCMD_FLOW_ON_IND:		Flow Control is ON, transmit function</span>
<span class="cm"> *					can start sending data</span>
<span class="cm"> *</span>
<span class="cm"> * @CAIF_CTRLCMD_REMOTE_SHUTDOWN_IND:	Remote end modem has decided to close</span>
<span class="cm"> *					down channel</span>
<span class="cm"> *</span>
<span class="cm"> * @CAIF_CTRLCMD_INIT_RSP:		Called initially when the layer below</span>
<span class="cm"> *					has finished initialization</span>
<span class="cm"> *</span>
<span class="cm"> * @CAIF_CTRLCMD_DEINIT_RSP:		Called when de-initialization is</span>
<span class="cm"> *					complete</span>
<span class="cm"> *</span>
<span class="cm"> * @CAIF_CTRLCMD_INIT_FAIL_RSP:		Called if initialization fails</span>
<span class="cm"> *</span>
<span class="cm"> * @_CAIF_CTRLCMD_PHYIF_FLOW_OFF_IND:	CAIF Link layer temporarily cannot</span>
<span class="cm"> *					send more packets.</span>
<span class="cm"> * @_CAIF_CTRLCMD_PHYIF_FLOW_ON_IND:	Called if CAIF Link layer is able</span>
<span class="cm"> *					to send packets again.</span>
<span class="cm"> * @_CAIF_CTRLCMD_PHYIF_DOWN_IND:	Called if CAIF Link layer is going</span>
<span class="cm"> *					down.</span>
<span class="cm"> *</span>
<span class="cm"> * These commands are sent upwards in the CAIF stack to the CAIF Client.</span>
<span class="cm"> * They are used for signaling originating from the modem or CAIF Link Layer.</span>
<span class="cm"> * These are either responses (*_RSP) or events (*_IND).</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">caif_ctrlcmd</span> <span class="p">{</span>
	<span class="n">CAIF_CTRLCMD_FLOW_OFF_IND</span><span class="p">,</span>
	<span class="n">CAIF_CTRLCMD_FLOW_ON_IND</span><span class="p">,</span>
	<span class="n">CAIF_CTRLCMD_REMOTE_SHUTDOWN_IND</span><span class="p">,</span>
	<span class="n">CAIF_CTRLCMD_INIT_RSP</span><span class="p">,</span>
	<span class="n">CAIF_CTRLCMD_DEINIT_RSP</span><span class="p">,</span>
	<span class="n">CAIF_CTRLCMD_INIT_FAIL_RSP</span><span class="p">,</span>
	<span class="n">_CAIF_CTRLCMD_PHYIF_FLOW_OFF_IND</span><span class="p">,</span>
	<span class="n">_CAIF_CTRLCMD_PHYIF_FLOW_ON_IND</span><span class="p">,</span>
	<span class="n">_CAIF_CTRLCMD_PHYIF_DOWN_IND</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum caif_modemcmd -	 Modem Control Signaling, sent from CAIF Client</span>
<span class="cm"> *			 to the CAIF Link Layer or modem.</span>
<span class="cm"> *</span>
<span class="cm"> * @CAIF_MODEMCMD_FLOW_ON_REQ:		Flow Control is ON, transmit function</span>
<span class="cm"> *					can start sending data.</span>
<span class="cm"> *</span>
<span class="cm"> * @CAIF_MODEMCMD_FLOW_OFF_REQ:		Flow Control is OFF, transmit function</span>
<span class="cm"> *					should stop sending data.</span>
<span class="cm"> *</span>
<span class="cm"> * @_CAIF_MODEMCMD_PHYIF_USEFULL:	Notify physical layer that it is in use</span>
<span class="cm"> *</span>
<span class="cm"> * @_CAIF_MODEMCMD_PHYIF_USELESS:	Notify physical layer that it is</span>
<span class="cm"> *					no longer in use.</span>
<span class="cm"> *</span>
<span class="cm"> * These are requests sent &#39;downwards&#39; in the stack.</span>
<span class="cm"> * Flow ON, OFF can be indicated to the modem.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">caif_modemcmd</span> <span class="p">{</span>
	<span class="n">CAIF_MODEMCMD_FLOW_ON_REQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CAIF_MODEMCMD_FLOW_OFF_REQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">_CAIF_MODEMCMD_PHYIF_USEFULL</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">_CAIF_MODEMCMD_PHYIF_USELESS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum caif_direction - CAIF Packet Direction.</span>
<span class="cm"> * Indicate if a packet is to be sent out or to be received in.</span>
<span class="cm"> * @CAIF_DIR_IN:		Incoming packet received.</span>
<span class="cm"> * @CAIF_DIR_OUT:		Outgoing packet to be transmitted.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">caif_direction</span> <span class="p">{</span>
	<span class="n">CAIF_DIR_IN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CAIF_DIR_OUT</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct cflayer - CAIF Stack layer.</span>
<span class="cm"> * Defines the framework for the CAIF Core Stack.</span>
<span class="cm"> * @up:		Pointer up to the layer above.</span>
<span class="cm"> * @dn:		Pointer down to the layer below.</span>
<span class="cm"> * @node:	List node used when layer participate in a list.</span>
<span class="cm"> * @receive:	Packet receive function.</span>
<span class="cm"> * @transmit:	Packet transmit funciton.</span>
<span class="cm"> * @ctrlcmd:	Used for control signalling upwards in the stack.</span>
<span class="cm"> * @modemcmd:	Used for control signaling downwards in the stack.</span>
<span class="cm"> * @id:		The identity of this layer</span>
<span class="cm"> * @name:	Name of the layer.</span>
<span class="cm"> *</span>
<span class="cm"> *  This structure defines the layered structure in CAIF.</span>
<span class="cm"> *</span>
<span class="cm"> *  It defines CAIF layering structure, used by all CAIF Layers and the</span>
<span class="cm"> *  layers interfacing CAIF.</span>
<span class="cm"> *</span>
<span class="cm"> *  In order to integrate with CAIF an adaptation layer on top of the CAIF stack</span>
<span class="cm"> *  and PHY layer below the CAIF stack</span>
<span class="cm"> *  must be implemented. These layer must follow the design principles below.</span>
<span class="cm"> *</span>
<span class="cm"> *  Principles for layering of protocol layers:</span>
<span class="cm"> *    - All layers must use this structure. If embedding it, then place this</span>
<span class="cm"> *	structure first in the layer specific structure.</span>
<span class="cm"> *</span>
<span class="cm"> *    - Each layer should not depend on any others layer&#39;s private data.</span>
<span class="cm"> *</span>
<span class="cm"> *    - In order to send data upwards do</span>
<span class="cm"> *	layer-&gt;up-&gt;receive(layer-&gt;up, packet);</span>
<span class="cm"> *</span>
<span class="cm"> *    - In order to send data downwards do</span>
<span class="cm"> *	layer-&gt;dn-&gt;transmit(layer-&gt;dn, info, packet);</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cflayer</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cflayer</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cflayer</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  receive() - Receive Function (non-blocking).</span>
<span class="cm">	 *  Contract: Each layer must implement a receive function passing the</span>
<span class="cm">	 *  CAIF packets upwards in the stack.</span>
<span class="cm">	 *	Packet handling rules:</span>
<span class="cm">	 *	      - The CAIF packet (cfpkt) ownership is passed to the</span>
<span class="cm">	 *		called receive function. This means that the the</span>
<span class="cm">	 *		packet cannot be accessed after passing it to the</span>
<span class="cm">	 *		above layer using up-&gt;receive().</span>
<span class="cm">	 *</span>
<span class="cm">	 *	      - If parsing of the packet fails, the packet must be</span>
<span class="cm">	 *		destroyed and negative error code returned</span>
<span class="cm">	 *		from the function.</span>
<span class="cm">	 *		EXCEPTION: If the framing layer (cffrml) returns</span>
<span class="cm">	 *			-EILSEQ, the packet is not freed.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	      - If parsing succeeds (and above layers return OK) then</span>
<span class="cm">	 *		      the function must return a value &gt;= 0.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  Returns result &lt; 0 indicates an error, 0 or positive value</span>
<span class="cm">	 *	     indicates success.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  @layr: Pointer to the current layer the receive function is</span>
<span class="cm">	 *		implemented for (this pointer).</span>
<span class="cm">	 *  @cfpkt: Pointer to CaifPacket to be handled.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">receive</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cflayer</span> <span class="o">*</span><span class="n">layr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfpkt</span> <span class="o">*</span><span class="n">cfpkt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  transmit() - Transmit Function (non-blocking).</span>
<span class="cm">	 *  Contract: Each layer must implement a transmit function passing the</span>
<span class="cm">	 *	CAIF packet downwards in the stack.</span>
<span class="cm">	 *	Packet handling rules:</span>
<span class="cm">	 *	      - The CAIF packet (cfpkt) ownership is passed to the</span>
<span class="cm">	 *		transmit function. This means that the the packet</span>
<span class="cm">	 *		cannot be accessed after passing it to the below</span>
<span class="cm">	 *		layer using dn-&gt;transmit().</span>
<span class="cm">	 *</span>
<span class="cm">	 *	      - Upon error the packet ownership is still passed on,</span>
<span class="cm">	 *		so the packet shall be freed where error is detected.</span>
<span class="cm">	 *		Callers of the transmit function shall not free packets,</span>
<span class="cm">	 *		but errors shall be returned.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	      - Return value less than zero means error, zero or</span>
<span class="cm">	 *		greater than zero means OK.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  Returns result &lt; 0 indicates an error, 0 or positive value</span>
<span class="cm">	 *		indicates success.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  @layr:	Pointer to the current layer the receive function</span>
<span class="cm">	 *		isimplemented for (this pointer).</span>
<span class="cm">	 *  @cfpkt:	 Pointer to CaifPacket to be handled.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">transmit</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cflayer</span> <span class="o">*</span><span class="n">layr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfpkt</span> <span class="o">*</span><span class="n">cfpkt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  cttrlcmd() - Control Function upwards in CAIF Stack  (non-blocking).</span>
<span class="cm">	 *  Used for signaling responses (CAIF_CTRLCMD_*_RSP)</span>
<span class="cm">	 *  and asynchronous events from the modem  (CAIF_CTRLCMD_*_IND)</span>
<span class="cm">	 *</span>
<span class="cm">	 *  @layr:	Pointer to the current layer the receive function</span>
<span class="cm">	 *		is implemented for (this pointer).</span>
<span class="cm">	 *  @ctrl:	Control Command.</span>
<span class="cm">	 */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrlcmd</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cflayer</span> <span class="o">*</span><span class="n">layr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">caif_ctrlcmd</span> <span class="n">ctrl</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">phyid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  modemctrl() - Control Function used for controlling the modem.</span>
<span class="cm">	 *  Used to signal down-wards in the CAIF stack.</span>
<span class="cm">	 *  Returns 0 on success, &lt; 0 upon failure.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  @layr:	Pointer to the current layer the receive function</span>
<span class="cm">	 *		is implemented for (this pointer).</span>
<span class="cm">	 *  @ctrl:  Control Command.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">modemcmd</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cflayer</span> <span class="o">*</span><span class="n">layr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">caif_modemcmd</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">CAIF_LAYER_NAME_SZ</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * layer_set_up() - Set the up pointer for a specified layer.</span>
<span class="cm"> *  @layr: Layer where up pointer shall be set.</span>
<span class="cm"> *  @above: Layer above.</span>
<span class="cm"> */</span>
<span class="cp">#define layer_set_up(layr, above) ((layr)-&gt;up = (struct cflayer *)(above))</span>

<span class="cm">/**</span>
<span class="cm"> *  layer_set_dn() - Set the down pointer for a specified layer.</span>
<span class="cm"> *  @layr:  Layer where down pointer shall be set.</span>
<span class="cm"> *  @below: Layer below.</span>
<span class="cm"> */</span>
<span class="cp">#define layer_set_dn(layr, below) ((layr)-&gt;dn = (struct cflayer *)(below))</span>

<span class="cm">/**</span>
<span class="cm"> * struct dev_info - Physical Device info information about physical layer.</span>
<span class="cm"> * @dev:	Pointer to native physical device.</span>
<span class="cm"> * @id:		Physical ID of the physical connection used by the</span>
<span class="cm"> *		logical CAIF connection. Used by service layers to</span>
<span class="cm"> *		identify their physical id to Caif MUX (CFMUXL)so</span>
<span class="cm"> *		that the MUX can add the correct physical ID to the</span>
<span class="cm"> *		packet.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dev_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct caif_payload_info - Payload information embedded in packet (sk_buff).</span>
<span class="cm"> *</span>
<span class="cm"> * @dev_info:	Information about the receiving device.</span>
<span class="cm"> *</span>
<span class="cm"> * @hdr_len:	Header length, used to align pay load on 32bit boundary.</span>
<span class="cm"> *</span>
<span class="cm"> * @channel_id: Channel ID of the logical CAIF connection.</span>
<span class="cm"> *		Used by mux to insert channel id into the caif packet.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">caif_payload_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_info</span> <span class="o">*</span><span class="n">dev_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">channel_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif	</span><span class="cm">/* CAIF_LAYER_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
