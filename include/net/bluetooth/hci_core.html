<!DOCTYPE html>
<html><head><title>joekychen/linux » include › net › bluetooth › hci_core.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hci_core.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   BlueZ - Bluetooth protocol stack for Linux</span>
<span class="cm">   Copyright (c) 2000-2001, 2010, Code Aurora Forum. All rights reserved.</span>

<span class="cm">   Written 2000,2001 by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License version 2 as</span>
<span class="cm">   published by the Free Software Foundation;</span>

<span class="cm">   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm">   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.</span>
<span class="cm">   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY</span>
<span class="cm">   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES</span>
<span class="cm">   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm">   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm">   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="cm">   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS,</span>
<span class="cm">   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS</span>
<span class="cm">   SOFTWARE IS DISCLAIMED.</span>
<span class="cm">*/</span>

<span class="cp">#ifndef __HCI_CORE_H</span>
<span class="cp">#define __HCI_CORE_H</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/hci.h&gt;</span>

<span class="cm">/* HCI priority */</span>
<span class="cp">#define HCI_PRIO_MAX	7</span>

<span class="cm">/* HCI Core structures */</span>
<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="p">{</span>
	<span class="n">bdaddr_t</span>	<span class="n">bdaddr</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">pscan_rep_mode</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">pscan_period_mode</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">pscan_mode</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">dev_class</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__le16</span>		<span class="n">clock_offset</span><span class="p">;</span>
	<span class="n">__s8</span>		<span class="n">rssi</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">ssp_mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">all</span><span class="p">;</span>		<span class="cm">/* inq_cache.all */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>		<span class="cm">/* unknown or resolve */</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">NAME_NOT_KNOWN</span><span class="p">,</span>
		<span class="n">NAME_NEEDED</span><span class="p">,</span>
		<span class="n">NAME_PENDING</span><span class="p">,</span>
		<span class="n">NAME_KNOWN</span><span class="p">,</span>
	<span class="p">}</span> <span class="n">name_state</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">timestamp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inquiry_data</span>	<span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">discovery_state</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">DISCOVERY_STOPPED</span><span class="p">,</span>
		<span class="n">DISCOVERY_STARTING</span><span class="p">,</span>
		<span class="n">DISCOVERY_FINDING</span><span class="p">,</span>
		<span class="n">DISCOVERY_RESOLVING</span><span class="p">,</span>
		<span class="n">DISCOVERY_STOPPING</span><span class="p">,</span>
	<span class="p">}</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">all</span><span class="p">;</span>		<span class="cm">/* All devices found during inquiry */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">unknown</span><span class="p">;</span>	<span class="cm">/* Name state not known */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">resolve</span><span class="p">;</span>	<span class="cm">/* Name needs to be resolved */</span>
	<span class="n">__u32</span>			<span class="n">timestamp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">acl_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">sco_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>     <span class="n">le_num</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bdaddr_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">bdaddr_t</span> <span class="n">bdaddr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bt_uuid</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">uuid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">svc_hint</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">bdaddr_t</span> <span class="n">bdaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bdaddr_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">authenticated</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enc_size</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">ediv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rand</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">link_key</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">bdaddr_t</span> <span class="n">bdaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">pin_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">oob_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">bdaddr_t</span> <span class="n">bdaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hash</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">randomizer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">adv_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">bdaddr_t</span> <span class="n">bdaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bdaddr_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">le_scan_params</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">interval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">window</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define HCI_MAX_SHORT_NAME_LENGTH	10</span>

<span class="cp">#define NUM_REASSEMBLY 4</span>
<span class="k">struct</span> <span class="n">hci_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>	<span class="n">lock</span><span class="p">;</span>

	<span class="kt">char</span>		<span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">id</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">bus</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">dev_type</span><span class="p">;</span>
	<span class="n">bdaddr_t</span>	<span class="n">bdaddr</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">dev_name</span><span class="p">[</span><span class="n">HCI_MAX_NAME_LENGTH</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">short_name</span><span class="p">[</span><span class="n">HCI_MAX_SHORT_NAME_LENGTH</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">eir</span><span class="p">[</span><span class="n">HCI_MAX_EIR_LENGTH</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">dev_class</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">major_class</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">minor_class</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">features</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">host_features</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">commands</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">hci_ver</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">hci_rev</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">lmp_ver</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">manufacturer</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">lmp_subver</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">voice_setting</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">io_capability</span><span class="p">;</span>
	<span class="n">__s8</span>		<span class="n">inq_tx_power</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">devid_source</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">devid_vendor</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">devid_product</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">devid_version</span><span class="p">;</span>

	<span class="n">__u16</span>		<span class="n">pkt_type</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">esco_type</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">link_policy</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">link_mode</span><span class="p">;</span>

	<span class="n">__u32</span>		<span class="n">idle_timeout</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">sniff_min_interval</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">sniff_max_interval</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">amp_status</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">amp_total_bw</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">amp_max_bw</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">amp_min_latency</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">amp_max_pdu</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">amp_type</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">amp_pal_cap</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">amp_assoc_size</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">amp_max_flush_to</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">amp_be_flush_to</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">flow_ctl_mode</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">auto_accept_delay</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">quirks</span><span class="p">;</span>

	<span class="n">atomic_t</span>	<span class="n">cmd_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">acl_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">sco_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">le_cnt</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">acl_mtu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">sco_mtu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">le_mtu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">acl_pkts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">sco_pkts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">le_pkts</span><span class="p">;</span>

	<span class="n">__u16</span>		<span class="n">block_len</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">block_mtu</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">num_blocks</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">block_cnt</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">acl_last_tx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">sco_last_tx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">le_last_tx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">workqueue_struct</span>	<span class="o">*</span><span class="n">workqueue</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">power_on</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">power_off</span><span class="p">;</span>

	<span class="n">__u16</span>			<span class="n">discov_timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">discov_off</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">service_cache</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">cmd_timer</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">rx_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">cmd_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">tx_work</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff_head</span>	<span class="n">rx_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span>	<span class="n">raw_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span>	<span class="n">cmd_q</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">sent_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">reassembly</span><span class="p">[</span><span class="n">NUM_REASSEMBLY</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">req_lock</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">req_wait_q</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">req_status</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">req_result</span><span class="p">;</span>

	<span class="n">__u16</span>			<span class="n">init_last_cmd</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">mgmt_pending</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">discovery_state</span>	<span class="n">discovery</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span>	<span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">blacklist</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">uuids</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">link_keys</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">long_term_keys</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">remote_oob_data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hci_dev_stats</span>	<span class="n">stat</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff_head</span>	<span class="n">driver_init</span><span class="p">;</span>

	<span class="kt">void</span>			<span class="o">*</span><span class="n">core_data</span><span class="p">;</span>

	<span class="n">atomic_t</span>		<span class="n">promisc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">debugfs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">device</span>		<span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rfkill</span>		<span class="o">*</span><span class="n">rfkill</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">dev_flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">le_scan_disable</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">le_scan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">le_scan_params</span>	<span class="n">le_scan_params</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">flush</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">send</span><span class="p">)(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">notify</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">evt</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hci_conn</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

	<span class="n">atomic_t</span>	<span class="n">refcnt</span><span class="p">;</span>

	<span class="n">bdaddr_t</span>	<span class="n">dst</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">dst_type</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">handle</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">state</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">mode</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">type</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">out</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">attempt</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">dev_class</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">features</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__u16</span>		<span class="n">interval</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">pkt_type</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">link_policy</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">link_mode</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">key_type</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">auth_type</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">sec_level</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">pending_sec_level</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">pin_length</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">enc_key_size</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">io_capability</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">disc_timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">remote_cap</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">remote_auth</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">flush_key</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">sent</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">data_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">chan_list</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">disc_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">idle_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">auto_accept_timer</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">device</span>	<span class="n">dev</span><span class="p">;</span>
	<span class="n">atomic_t</span>	<span class="n">devref</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hci_dev</span>	<span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">l2cap_data</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">sco_data</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">smp_conn</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hci_conn</span>	<span class="o">*</span><span class="n">link</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">connect_cfm_cb</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">security_cfm_cb</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">disconn_cfm_cb</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hci_chan</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">data_q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">sent</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">hci_dev_list</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">hci_cb_list</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">rwlock_t</span> <span class="n">hci_dev_list_lock</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">rwlock_t</span> <span class="n">hci_cb_list_lock</span><span class="p">;</span>

<span class="cm">/* ----- HCI interface to upper protocols ----- */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">l2cap_connect_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">l2cap_connect_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">l2cap_disconn_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">l2cap_disconn_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">l2cap_security_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">encrypt</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">l2cap_recv_acldata</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">sco_connect_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sco_connect_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sco_disconn_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">reason</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sco_recv_scodata</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hcon</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="cm">/* ----- Inquiry cache ----- */</span>
<span class="cp">#define INQUIRY_CACHE_AGE_MAX   (HZ*30)   </span><span class="cm">/* 30 seconds */</span><span class="cp"></span>
<span class="cp">#define INQUIRY_ENTRY_AGE_MAX   (HZ*60)   </span><span class="cm">/* 60 seconds */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">discovery_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">DISCOVERY_STOPPED</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">all</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">unknown</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">resolve</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="n">hci_discovery_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">hci_discovery_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">inquiry_cache_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">.</span><span class="n">all</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">inquiry_cache_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discovery_state</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">discovery</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">inquiry_entry_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">hci_inquiry_cache_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
					       <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">hci_inquiry_cache_lookup_unknown</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						       <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">hci_inquiry_cache_lookup_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
						       <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
						       <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_inquiry_cache_update_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">inquiry_entry</span> <span class="o">*</span><span class="n">ie</span><span class="p">);</span>
<span class="n">bool</span> <span class="n">hci_inquiry_cache_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inquiry_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">name_known</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">ssp</span><span class="p">);</span>

<span class="cm">/* ----- HCI Connections ----- */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">HCI_CONN_AUTH_PEND</span><span class="p">,</span>
	<span class="n">HCI_CONN_REAUTH_PEND</span><span class="p">,</span>
	<span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span>
	<span class="n">HCI_CONN_RSWITCH_PEND</span><span class="p">,</span>
	<span class="n">HCI_CONN_MODE_CHANGE_PEND</span><span class="p">,</span>
	<span class="n">HCI_CONN_SCO_SETUP_PEND</span><span class="p">,</span>
	<span class="n">HCI_CONN_LE_SMP_PEND</span><span class="p">,</span>
	<span class="n">HCI_CONN_MGMT_CONNECTED</span><span class="p">,</span>
	<span class="n">HCI_CONN_SSP_ENABLED</span><span class="p">,</span>
	<span class="n">HCI_CONN_POWER_SAVE</span><span class="p">,</span>
	<span class="n">HCI_CONN_REMOTE_OOB</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">hci_conn_ssp_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_SSP_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_conn_hash_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">acl_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">sco_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">le_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_conn_hash_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACL_LINK</span>:
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">acl_num</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LE_LINK</span>:
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">le_num</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCO_LINK</span>:
	<span class="k">case</span> <span class="n">ESCO_LINK</span>:
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">sco_num</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_conn_hash_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>

	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACL_LINK</span>:
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">acl_num</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LE_LINK</span>:
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">le_num</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCO_LINK</span>:
	<span class="k">case</span> <span class="n">ESCO_LINK</span>:
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">sco_num</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hci_conn_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACL_LINK</span>:
		<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">acl_num</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LE_LINK</span>:
		<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">le_num</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCO_LINK</span>:
	<span class="k">case</span> <span class="n">ESCO_LINK</span>:
		<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sco_num</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="nf">hci_conn_hash_lookup_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
								<span class="n">__u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span>  <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="nf">hci_conn_hash_lookup_ba</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="n">__u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">ba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span>  <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bacmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ba</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="nf">hci_conn_hash_lookup_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="n">__u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn_hash</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">conn_hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_conn</span>  <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">hci_acl_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_acl_disconn</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">reason</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_add_sco</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">handle</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_setup_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">handle</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_sco_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hci_conn_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_conn_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_conn_hash_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_conn_check_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">hci_chan_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_chan_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_chan_list_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">hci_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			     <span class="n">__u8</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">auth_type</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_conn_check_link_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_conn_check_secure</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">sec_level</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_conn_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">sec_level</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">auth_type</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_conn_change_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_conn_switch_role</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">role</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">hci_conn_enter_active_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">force_active</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">hci_conn_hold_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_conn_put_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_conn_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_conn_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACL_LINK</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LE_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BT_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">timeo</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_timeout</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">)</span>
					<span class="n">timeo</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">timeo</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">timeo</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_work</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">disc_work</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ----- HCI Devices ----- */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_dev_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="nf">hci_dev_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define hci_dev_lock(d)		mutex_lock(&amp;d-&gt;lock)</span>
<span class="cp">#define hci_dev_unlock(d)	mutex_unlock(&amp;d-&gt;lock)</span>

<span class="cp">#define to_hci_dev(d) container_of(d, struct hci_dev, dev)</span>
<span class="cp">#define to_hci_conn(c) container_of(c, struct hci_conn, dev)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">hci_get_drvdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_set_drvdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hci_dev_get</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hci_get_route</span><span class="p">(</span><span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hci_alloc_dev</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_free_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_register_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_unregister_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_suspend_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_resume_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_dev_open</span><span class="p">(</span><span class="n">__u16</span> <span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_dev_close</span><span class="p">(</span><span class="n">__u16</span> <span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_dev_reset</span><span class="p">(</span><span class="n">__u16</span> <span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_dev_reset_stat</span><span class="p">(</span><span class="n">__u16</span> <span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_dev_cmd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_get_dev_list</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_get_dev_info</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_get_conn_list</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_get_conn_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_get_auth_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_inquiry</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">bdaddr_list</span> <span class="o">*</span><span class="n">hci_blacklist_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_blacklist_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_blacklist_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_blacklist_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">hci_uuids_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">hci_link_keys_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="n">hci_find_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_add_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_key</span><span class="p">,</span>
		     <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pin_len</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">hci_find_ltk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">ediv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rand</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
<span class="kt">int</span> <span class="n">hci_add_ltk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">u8</span> <span class="n">authenticated</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tk</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">u8</span> <span class="n">enc_size</span><span class="p">,</span>
		<span class="n">__le16</span> <span class="n">ediv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rand</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
<span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">hci_find_ltk_by_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">addr_type</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_remove_ltk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_smp_ltks_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_remove_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">hci_remote_oob_data_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">oob_data</span> <span class="o">*</span><span class="n">hci_find_remote_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
							<span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_add_remote_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hash</span><span class="p">,</span>
								<span class="n">u8</span> <span class="o">*</span><span class="n">randomizer</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_remove_remote_oob_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">hci_event_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">hci_recv_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_recv_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_recv_stream_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">hci_init_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_add_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_del_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_conn_init_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_conn_add_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_conn_del_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>

<span class="cp">#define SET_HCIDEV_DEV(hdev, pdev) ((hdev)-&gt;dev.parent = (pdev))</span>

<span class="cm">/* ----- LMP capabilities ----- */</span>
<span class="cp">#define lmp_rswitch_capable(dev)   ((dev)-&gt;features[0] &amp; LMP_RSWITCH)</span>
<span class="cp">#define lmp_encrypt_capable(dev)   ((dev)-&gt;features[0] &amp; LMP_ENCRYPT)</span>
<span class="cp">#define lmp_sniff_capable(dev)     ((dev)-&gt;features[0] &amp; LMP_SNIFF)</span>
<span class="cp">#define lmp_sniffsubr_capable(dev) ((dev)-&gt;features[5] &amp; LMP_SNIFF_SUBR)</span>
<span class="cp">#define lmp_esco_capable(dev)      ((dev)-&gt;features[3] &amp; LMP_ESCO)</span>
<span class="cp">#define lmp_ssp_capable(dev)       ((dev)-&gt;features[6] &amp; LMP_SIMPLE_PAIR)</span>
<span class="cp">#define lmp_no_flush_capable(dev)  ((dev)-&gt;features[6] &amp; LMP_NO_FLUSH)</span>
<span class="cp">#define lmp_le_capable(dev)        ((dev)-&gt;features[4] &amp; LMP_LE)</span>
<span class="cp">#define lmp_bredr_capable(dev)     (!((dev)-&gt;features[4] &amp; LMP_NO_BREDR))</span>

<span class="cm">/* ----- Extended LMP capabilities ----- */</span>
<span class="cp">#define lmp_host_le_capable(dev)   ((dev)-&gt;host_features[0] &amp; LMP_HOST_LE)</span>

<span class="cm">/* ----- HCI protocols ----- */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hci_proto_connect_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
								<span class="n">__u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACL_LINK</span>:
		<span class="k">return</span> <span class="n">l2cap_connect_ind</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCO_LINK</span>:
	<span class="k">case</span> <span class="n">ESCO_LINK</span>:
		<span class="k">return</span> <span class="n">sco_connect_ind</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;unknown link type %d&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_proto_connect_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACL_LINK</span>:
	<span class="k">case</span> <span class="n">LE_LINK</span>:
		<span class="n">l2cap_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCO_LINK</span>:
	<span class="k">case</span> <span class="n">ESCO_LINK</span>:
		<span class="n">sco_connect_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;unknown link type %d&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connect_cfm_cb</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">connect_cfm_cb</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hci_proto_disconn_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACL_LINK</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">LE_LINK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HCI_ERROR_REMOTE_USER_TERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">l2cap_disconn_ind</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_proto_disconn_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACL_LINK</span>:
	<span class="k">case</span> <span class="n">LE_LINK</span>:
		<span class="n">l2cap_disconn_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCO_LINK</span>:
	<span class="k">case</span> <span class="n">ESCO_LINK</span>:
		<span class="n">sco_disconn_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BT_ERR</span><span class="p">(</span><span class="s">&quot;unknown link type %d&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">disconn_cfm_cb</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">disconn_cfm_cb</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_proto_auth_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">encrypt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACL_LINK</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">LE_LINK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">encrypt</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_ENCRYPT</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">l2cap_security_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_cfm_cb</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_cfm_cb</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_proto_encrypt_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">,</span>
								<span class="n">__u8</span> <span class="n">encrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACL_LINK</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">LE_LINK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">l2cap_security_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_cfm_cb</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">security_cfm_cb</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----- HCI callbacks ----- */</span>
<span class="k">struct</span> <span class="n">hci_cb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">security_cfm</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">,</span>
								<span class="n">__u8</span> <span class="n">encrypt</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">key_change_cfm</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">role_switch_cfm</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">role</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_auth_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">encrypt</span><span class="p">;</span>

	<span class="n">hci_proto_auth_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HCI_CONN_ENCRYPT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">encrypt</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">link_mode</span> <span class="o">&amp;</span> <span class="n">HCI_LM_ENCRYPT</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_cb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_cb</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">security_cfm</span><span class="p">)</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">security_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_encrypt_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">,</span>
								<span class="n">__u8</span> <span class="n">encrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">==</span> <span class="n">BT_SECURITY_SDP</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">BT_SECURITY_LOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span> <span class="o">&gt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sec_level</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">pending_sec_level</span><span class="p">;</span>

	<span class="n">hci_proto_encrypt_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_cb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_cb</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">security_cfm</span><span class="p">)</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">security_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_key_change_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_cb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_cb</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">key_change_cfm</span><span class="p">)</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">key_change_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hci_role_switch_cfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">status</span><span class="p">,</span>
								<span class="n">__u8</span> <span class="n">role</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hci_cb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hci_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hci_cb</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">role_switch_cfm</span><span class="p">)</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">role_switch_cfm</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">role</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_cb_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">eir_has_data_type</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">parsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">parsed</span> <span class="o">&lt;</span> <span class="n">data_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">field_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">field_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">parsed</span> <span class="o">+=</span> <span class="n">field_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">parsed</span> <span class="o">&gt;</span> <span class="n">data_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="n">field_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">eir_get_length</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">eir</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">eir_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">parsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">parsed</span> <span class="o">&lt;</span> <span class="n">eir_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">field_len</span> <span class="o">=</span> <span class="n">eir</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">field_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">parsed</span><span class="p">;</span>

		<span class="n">parsed</span> <span class="o">+=</span> <span class="n">field_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">eir</span> <span class="o">+=</span> <span class="n">field_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">eir_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">eir_append_data</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">eir</span><span class="p">,</span> <span class="n">u16</span> <span class="n">eir_len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">eir</span><span class="p">[</span><span class="n">eir_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">eir</span><span class="p">[</span><span class="n">eir_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eir</span><span class="p">[</span><span class="n">eir_len</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">eir_len</span> <span class="o">+=</span> <span class="n">data_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">eir_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">hci_register_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_cb</span> <span class="o">*</span><span class="n">hcb</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_unregister_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_cb</span> <span class="o">*</span><span class="n">hcb</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">hci_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">plen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_send_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">flags</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_send_sco</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">hci_sent_cmd_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">opcode</span><span class="p">);</span>

<span class="cm">/* ----- HCI Sockets ----- */</span>
<span class="kt">void</span> <span class="n">hci_send_to_sock</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_send_to_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">skip_sk</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_send_to_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">hci_sock_dev_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">);</span>

<span class="cm">/* Management interface */</span>
<span class="cp">#define DISCOV_TYPE_BREDR		(BIT(BDADDR_BREDR))</span>
<span class="cp">#define DISCOV_TYPE_LE			(BIT(BDADDR_LE_PUBLIC) | \</span>
<span class="cp">					 BIT(BDADDR_LE_RANDOM))</span>
<span class="cp">#define DISCOV_TYPE_INTERLEAVED		(BIT(BDADDR_BREDR) | \</span>
<span class="cp">					 BIT(BDADDR_LE_PUBLIC) | \</span>
<span class="cp">					 BIT(BDADDR_LE_RANDOM))</span>

<span class="kt">int</span> <span class="n">mgmt_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_index_added</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_index_removed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_powered</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">powered</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_discoverable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">discoverable</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_connectable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">connectable</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_write_scan_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">scan</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_new_link_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		      <span class="n">bool</span> <span class="n">persistent</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_device_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">name_len</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_device_disconnected</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_disconnect_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_connect_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_pin_code_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">secure</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_pin_code_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_pin_code_neg_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_user_confirm_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">value</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">confirm_hint</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_user_confirm_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_user_confirm_neg_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_user_passkey_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_user_passkey_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_user_passkey_neg_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_auth_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_auth_enable_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_ssp_enable_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_set_class_of_dev_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_set_local_name_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_read_local_oob_data_reply_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hash</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="o">*</span><span class="n">randomizer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_le_enable_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_device_found</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">,</span> <span class="n">s8</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cfm_name</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">ssp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">eir</span><span class="p">,</span> <span class="n">u16</span> <span class="n">eir_len</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_remote_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_type</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">addr_type</span><span class="p">,</span> <span class="n">s8</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">name_len</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_start_discovery_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_stop_discovery_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_discovering</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">discovering</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_interleaved_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_device_blocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">mgmt_device_unblocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">mgmt_new_ltk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smp_ltk</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="n">persistent</span><span class="p">);</span>

<span class="cm">/* HCI info for socket */</span>
<span class="cp">#define hci_pi(sk) ((struct hci_pinfo *) sk)</span>

<span class="k">struct</span> <span class="n">hci_pinfo</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bt_sock</span>    <span class="n">bt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_dev</span>    <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_filter</span> <span class="n">filter</span><span class="p">;</span>
	<span class="n">__u32</span>             <span class="n">cmsg_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>   <span class="n">channel</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* HCI security filter */</span>
<span class="cp">#define HCI_SFLT_MAX_OGF  5</span>

<span class="k">struct</span> <span class="n">hci_sec_filter</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">type_mask</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">event_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__u32</span> <span class="n">ocf_mask</span><span class="p">[</span><span class="n">HCI_SFLT_MAX_OGF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* ----- HCI requests ----- */</span>
<span class="cp">#define HCI_REQ_DONE	  0</span>
<span class="cp">#define HCI_REQ_PEND	  1</span>
<span class="cp">#define HCI_REQ_CANCELED  2</span>

<span class="cp">#define hci_req_lock(d)		mutex_lock(&amp;d-&gt;req_lock)</span>
<span class="cp">#define hci_req_unlock(d)	mutex_unlock(&amp;d-&gt;req_lock)</span>

<span class="kt">void</span> <span class="n">hci_req_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">hci_le_conn_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">min</span><span class="p">,</span> <span class="n">u16</span> <span class="n">max</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">latency</span><span class="p">,</span> <span class="n">u16</span> <span class="n">to_multiplier</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hci_le_start_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">ediv</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">rand</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
							<span class="n">__u8</span> <span class="n">ltk</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
<span class="kt">int</span> <span class="n">hci_do_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">length</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_cancel_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_le_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">interval</span><span class="p">,</span> <span class="n">u16</span> <span class="n">window</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hci_cancel_le_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">hci_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">);</span>

<span class="n">u8</span> <span class="n">bdaddr_to_le</span><span class="p">(</span><span class="n">u8</span> <span class="n">bdaddr_type</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* __HCI_CORE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
