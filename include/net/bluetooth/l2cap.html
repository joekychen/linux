<!DOCTYPE html>
<html><head><title>joekychen/linux » include › net › bluetooth › l2cap.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>l2cap.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   BlueZ - Bluetooth protocol stack for Linux</span>
<span class="cm">   Copyright (C) 2000-2001 Qualcomm Incorporated</span>
<span class="cm">   Copyright (C) 2009-2010 Gustavo F. Padovan &lt;gustavo@padovan.org&gt;</span>
<span class="cm">   Copyright (C) 2010 Google Inc.</span>

<span class="cm">   Written 2000,2001 by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License version 2 as</span>
<span class="cm">   published by the Free Software Foundation;</span>

<span class="cm">   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm">   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.</span>
<span class="cm">   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY</span>
<span class="cm">   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES</span>
<span class="cm">   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm">   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm">   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="cm">   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS,</span>
<span class="cm">   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS</span>
<span class="cm">   SOFTWARE IS DISCLAIMED.</span>
<span class="cm">*/</span>

<span class="cp">#ifndef __L2CAP_H</span>
<span class="cp">#define __L2CAP_H</span>

<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cm">/* L2CAP defaults */</span>
<span class="cp">#define L2CAP_DEFAULT_MTU		672</span>
<span class="cp">#define L2CAP_DEFAULT_MIN_MTU		48</span>
<span class="cp">#define L2CAP_DEFAULT_FLUSH_TO		0xffff</span>
<span class="cp">#define L2CAP_DEFAULT_TX_WINDOW		63</span>
<span class="cp">#define L2CAP_DEFAULT_EXT_WINDOW	0x3FFF</span>
<span class="cp">#define L2CAP_DEFAULT_MAX_TX		3</span>
<span class="cp">#define L2CAP_DEFAULT_RETRANS_TO	2000    </span><span class="cm">/* 2 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_DEFAULT_MONITOR_TO	12000   </span><span class="cm">/* 12 seconds */</span><span class="cp"></span>
<span class="cp">#define L2CAP_DEFAULT_MAX_PDU_SIZE	1009    </span><span class="cm">/* Sized for 3-DH5 packet */</span><span class="cp"></span>
<span class="cp">#define L2CAP_DEFAULT_ACK_TO		200</span>
<span class="cp">#define L2CAP_LE_DEFAULT_MTU		23</span>
<span class="cp">#define L2CAP_DEFAULT_MAX_SDU_SIZE	0xFFFF</span>
<span class="cp">#define L2CAP_DEFAULT_SDU_ITIME		0xFFFFFFFF</span>
<span class="cp">#define L2CAP_DEFAULT_ACC_LAT		0xFFFFFFFF</span>
<span class="cp">#define L2CAP_BREDR_MAX_PAYLOAD		1019    </span><span class="cm">/* 3-DH5 packet */</span><span class="cp"></span>

<span class="cp">#define L2CAP_DISC_TIMEOUT		msecs_to_jiffies(100)</span>
<span class="cp">#define L2CAP_DISC_REJ_TIMEOUT		msecs_to_jiffies(5000)</span>
<span class="cp">#define L2CAP_ENC_TIMEOUT		msecs_to_jiffies(5000)</span>
<span class="cp">#define L2CAP_CONN_TIMEOUT		msecs_to_jiffies(40000)</span>
<span class="cp">#define L2CAP_INFO_TIMEOUT		msecs_to_jiffies(4000)</span>

<span class="cm">/* L2CAP socket address */</span>
<span class="k">struct</span> <span class="n">sockaddr_l2</span> <span class="p">{</span>
	<span class="n">sa_family_t</span>	<span class="n">l2_family</span><span class="p">;</span>
	<span class="n">__le16</span>		<span class="n">l2_psm</span><span class="p">;</span>
	<span class="n">bdaddr_t</span>	<span class="n">l2_bdaddr</span><span class="p">;</span>
	<span class="n">__le16</span>		<span class="n">l2_cid</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">l2_bdaddr_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* L2CAP socket options */</span>
<span class="cp">#define L2CAP_OPTIONS	0x01</span>
<span class="k">struct</span> <span class="n">l2cap_options</span> <span class="p">{</span>
	<span class="n">__u16</span> <span class="n">omtu</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">imtu</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">flush_to</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">mode</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">fcs</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">max_tx</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">txwin_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define L2CAP_CONNINFO	0x02</span>
<span class="k">struct</span> <span class="n">l2cap_conninfo</span> <span class="p">{</span>
	<span class="n">__u16</span> <span class="n">hci_handle</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">dev_class</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define L2CAP_LM	0x03</span>
<span class="cp">#define L2CAP_LM_MASTER		0x0001</span>
<span class="cp">#define L2CAP_LM_AUTH		0x0002</span>
<span class="cp">#define L2CAP_LM_ENCRYPT	0x0004</span>
<span class="cp">#define L2CAP_LM_TRUSTED	0x0008</span>
<span class="cp">#define L2CAP_LM_RELIABLE	0x0010</span>
<span class="cp">#define L2CAP_LM_SECURE		0x0020</span>

<span class="cm">/* L2CAP command codes */</span>
<span class="cp">#define L2CAP_COMMAND_REJ	0x01</span>
<span class="cp">#define L2CAP_CONN_REQ		0x02</span>
<span class="cp">#define L2CAP_CONN_RSP		0x03</span>
<span class="cp">#define L2CAP_CONF_REQ		0x04</span>
<span class="cp">#define L2CAP_CONF_RSP		0x05</span>
<span class="cp">#define L2CAP_DISCONN_REQ	0x06</span>
<span class="cp">#define L2CAP_DISCONN_RSP	0x07</span>
<span class="cp">#define L2CAP_ECHO_REQ		0x08</span>
<span class="cp">#define L2CAP_ECHO_RSP		0x09</span>
<span class="cp">#define L2CAP_INFO_REQ		0x0a</span>
<span class="cp">#define L2CAP_INFO_RSP		0x0b</span>
<span class="cp">#define L2CAP_CREATE_CHAN_REQ	0x0c</span>
<span class="cp">#define L2CAP_CREATE_CHAN_RSP	0x0d</span>
<span class="cp">#define L2CAP_MOVE_CHAN_REQ	0x0e</span>
<span class="cp">#define L2CAP_MOVE_CHAN_RSP	0x0f</span>
<span class="cp">#define L2CAP_MOVE_CHAN_CFM	0x10</span>
<span class="cp">#define L2CAP_MOVE_CHAN_CFM_RSP	0x11</span>
<span class="cp">#define L2CAP_CONN_PARAM_UPDATE_REQ	0x12</span>
<span class="cp">#define L2CAP_CONN_PARAM_UPDATE_RSP	0x13</span>

<span class="cm">/* L2CAP extended feature mask */</span>
<span class="cp">#define L2CAP_FEAT_FLOWCTL	0x00000001</span>
<span class="cp">#define L2CAP_FEAT_RETRANS	0x00000002</span>
<span class="cp">#define L2CAP_FEAT_BIDIR_QOS	0x00000004</span>
<span class="cp">#define L2CAP_FEAT_ERTM		0x00000008</span>
<span class="cp">#define L2CAP_FEAT_STREAMING	0x00000010</span>
<span class="cp">#define L2CAP_FEAT_FCS		0x00000020</span>
<span class="cp">#define L2CAP_FEAT_EXT_FLOW	0x00000040</span>
<span class="cp">#define L2CAP_FEAT_FIXED_CHAN	0x00000080</span>
<span class="cp">#define L2CAP_FEAT_EXT_WINDOW	0x00000100</span>
<span class="cp">#define L2CAP_FEAT_UCD		0x00000200</span>

<span class="cm">/* L2CAP checksum option */</span>
<span class="cp">#define L2CAP_FCS_NONE		0x00</span>
<span class="cp">#define L2CAP_FCS_CRC16		0x01</span>

<span class="cm">/* L2CAP fixed channels */</span>
<span class="cp">#define L2CAP_FC_L2CAP		0x02</span>
<span class="cp">#define L2CAP_FC_A2MP		0x08</span>

<span class="cm">/* L2CAP Control Field bit masks */</span>
<span class="cp">#define L2CAP_CTRL_SAR			0xC000</span>
<span class="cp">#define L2CAP_CTRL_REQSEQ		0x3F00</span>
<span class="cp">#define L2CAP_CTRL_TXSEQ		0x007E</span>
<span class="cp">#define L2CAP_CTRL_SUPERVISE		0x000C</span>

<span class="cp">#define L2CAP_CTRL_RETRANS		0x0080</span>
<span class="cp">#define L2CAP_CTRL_FINAL		0x0080</span>
<span class="cp">#define L2CAP_CTRL_POLL			0x0010</span>
<span class="cp">#define L2CAP_CTRL_FRAME_TYPE		0x0001 </span><span class="cm">/* I- or S-Frame */</span><span class="cp"></span>

<span class="cp">#define L2CAP_CTRL_TXSEQ_SHIFT		1</span>
<span class="cp">#define L2CAP_CTRL_SUPER_SHIFT		2</span>
<span class="cp">#define L2CAP_CTRL_POLL_SHIFT		4</span>
<span class="cp">#define L2CAP_CTRL_FINAL_SHIFT		7</span>
<span class="cp">#define L2CAP_CTRL_REQSEQ_SHIFT		8</span>
<span class="cp">#define L2CAP_CTRL_SAR_SHIFT		14</span>

<span class="cm">/* L2CAP Extended Control Field bit mask */</span>
<span class="cp">#define L2CAP_EXT_CTRL_TXSEQ		0xFFFC0000</span>
<span class="cp">#define L2CAP_EXT_CTRL_SAR		0x00030000</span>
<span class="cp">#define L2CAP_EXT_CTRL_SUPERVISE	0x00030000</span>
<span class="cp">#define L2CAP_EXT_CTRL_REQSEQ		0x0000FFFC</span>

<span class="cp">#define L2CAP_EXT_CTRL_POLL		0x00040000</span>
<span class="cp">#define L2CAP_EXT_CTRL_FINAL		0x00000002</span>
<span class="cp">#define L2CAP_EXT_CTRL_FRAME_TYPE	0x00000001 </span><span class="cm">/* I- or S-Frame */</span><span class="cp"></span>

<span class="cp">#define L2CAP_EXT_CTRL_FINAL_SHIFT	1</span>
<span class="cp">#define L2CAP_EXT_CTRL_REQSEQ_SHIFT	2</span>
<span class="cp">#define L2CAP_EXT_CTRL_SAR_SHIFT	16</span>
<span class="cp">#define L2CAP_EXT_CTRL_SUPER_SHIFT	16</span>
<span class="cp">#define L2CAP_EXT_CTRL_POLL_SHIFT	18</span>
<span class="cp">#define L2CAP_EXT_CTRL_TXSEQ_SHIFT	18</span>

<span class="cm">/* L2CAP Supervisory Function */</span>
<span class="cp">#define L2CAP_SUPER_RR		0x00</span>
<span class="cp">#define L2CAP_SUPER_REJ		0x01</span>
<span class="cp">#define L2CAP_SUPER_RNR		0x02</span>
<span class="cp">#define L2CAP_SUPER_SREJ	0x03</span>

<span class="cm">/* L2CAP Segmentation and Reassembly */</span>
<span class="cp">#define L2CAP_SAR_UNSEGMENTED	0x00</span>
<span class="cp">#define L2CAP_SAR_START		0x01</span>
<span class="cp">#define L2CAP_SAR_END		0x02</span>
<span class="cp">#define L2CAP_SAR_CONTINUE	0x03</span>

<span class="cm">/* L2CAP Command rej. reasons */</span>
<span class="cp">#define L2CAP_REJ_NOT_UNDERSTOOD	0x0000</span>
<span class="cp">#define L2CAP_REJ_MTU_EXCEEDED		0x0001</span>
<span class="cp">#define L2CAP_REJ_INVALID_CID		0x0002</span>

<span class="cm">/* L2CAP structures */</span>
<span class="k">struct</span> <span class="n">l2cap_hdr</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">len</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">cid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cp">#define L2CAP_HDR_SIZE		4</span>
<span class="cp">#define L2CAP_ENH_HDR_SIZE	6</span>
<span class="cp">#define L2CAP_EXT_HDR_SIZE	8</span>

<span class="cp">#define L2CAP_FCS_SIZE		2</span>
<span class="cp">#define L2CAP_SDULEN_SIZE	2</span>
<span class="cp">#define L2CAP_PSMLEN_SIZE	2</span>
<span class="cp">#define L2CAP_ENH_CTRL_SIZE	2</span>
<span class="cp">#define L2CAP_EXT_CTRL_SIZE	4</span>

<span class="k">struct</span> <span class="n">l2cap_cmd_hdr</span> <span class="p">{</span>
	<span class="n">__u8</span>       <span class="n">code</span><span class="p">;</span>
	<span class="n">__u8</span>       <span class="n">ident</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cp">#define L2CAP_CMD_HDR_SIZE	4</span>

<span class="k">struct</span> <span class="n">l2cap_cmd_rej_unk</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">reason</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_cmd_rej_mtu</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">reason</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">max_mtu</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_cmd_rej_cid</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">reason</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">scid</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">dcid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_conn_req</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">psm</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">scid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_conn_rsp</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">dcid</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">scid</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">result</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">status</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* channel indentifier */</span>
<span class="cp">#define L2CAP_CID_SIGNALING	0x0001</span>
<span class="cp">#define L2CAP_CID_CONN_LESS	0x0002</span>
<span class="cp">#define L2CAP_CID_LE_DATA	0x0004</span>
<span class="cp">#define L2CAP_CID_LE_SIGNALING	0x0005</span>
<span class="cp">#define L2CAP_CID_SMP		0x0006</span>
<span class="cp">#define L2CAP_CID_DYN_START	0x0040</span>
<span class="cp">#define L2CAP_CID_DYN_END	0xffff</span>

<span class="cm">/* connect/create channel results */</span>
<span class="cp">#define L2CAP_CR_SUCCESS	0x0000</span>
<span class="cp">#define L2CAP_CR_PEND		0x0001</span>
<span class="cp">#define L2CAP_CR_BAD_PSM	0x0002</span>
<span class="cp">#define L2CAP_CR_SEC_BLOCK	0x0003</span>
<span class="cp">#define L2CAP_CR_NO_MEM		0x0004</span>
<span class="cp">#define L2CAP_CR_BAD_AMP	0x0005</span>

<span class="cm">/* connect/create channel status */</span>
<span class="cp">#define L2CAP_CS_NO_INFO	0x0000</span>
<span class="cp">#define L2CAP_CS_AUTHEN_PEND	0x0001</span>
<span class="cp">#define L2CAP_CS_AUTHOR_PEND	0x0002</span>

<span class="k">struct</span> <span class="n">l2cap_conf_req</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">dcid</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u8</span>       <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_conf_rsp</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">scid</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">flags</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">result</span><span class="p">;</span>
	<span class="n">__u8</span>       <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define L2CAP_CONF_SUCCESS	0x0000</span>
<span class="cp">#define L2CAP_CONF_UNACCEPT	0x0001</span>
<span class="cp">#define L2CAP_CONF_REJECT	0x0002</span>
<span class="cp">#define L2CAP_CONF_UNKNOWN	0x0003</span>
<span class="cp">#define L2CAP_CONF_PENDING	0x0004</span>
<span class="cp">#define L2CAP_CONF_EFS_REJECT	0x0005</span>

<span class="k">struct</span> <span class="n">l2cap_conf_opt</span> <span class="p">{</span>
	<span class="n">__u8</span>       <span class="n">type</span><span class="p">;</span>
	<span class="n">__u8</span>       <span class="n">len</span><span class="p">;</span>
	<span class="n">__u8</span>       <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cp">#define L2CAP_CONF_OPT_SIZE	2</span>

<span class="cp">#define L2CAP_CONF_HINT		0x80</span>
<span class="cp">#define L2CAP_CONF_MASK		0x7f</span>

<span class="cp">#define L2CAP_CONF_MTU		0x01</span>
<span class="cp">#define L2CAP_CONF_FLUSH_TO	0x02</span>
<span class="cp">#define L2CAP_CONF_QOS		0x03</span>
<span class="cp">#define L2CAP_CONF_RFC		0x04</span>
<span class="cp">#define L2CAP_CONF_FCS		0x05</span>
<span class="cp">#define L2CAP_CONF_EFS		0x06</span>
<span class="cp">#define L2CAP_CONF_EWS		0x07</span>

<span class="cp">#define L2CAP_CONF_MAX_SIZE	22</span>

<span class="k">struct</span> <span class="n">l2cap_conf_rfc</span> <span class="p">{</span>
	<span class="n">__u8</span>       <span class="n">mode</span><span class="p">;</span>
	<span class="n">__u8</span>       <span class="n">txwin_size</span><span class="p">;</span>
	<span class="n">__u8</span>       <span class="n">max_transmit</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">retrans_timeout</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">monitor_timeout</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">max_pdu_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define L2CAP_MODE_BASIC	0x00</span>
<span class="cp">#define L2CAP_MODE_RETRANS	0x01</span>
<span class="cp">#define L2CAP_MODE_FLOWCTL	0x02</span>
<span class="cp">#define L2CAP_MODE_ERTM		0x03</span>
<span class="cp">#define L2CAP_MODE_STREAMING	0x04</span>

<span class="k">struct</span> <span class="n">l2cap_conf_efs</span> <span class="p">{</span>
	<span class="n">__u8</span>	<span class="n">id</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">stype</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">msdu</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">sdu_itime</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">acc_lat</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">flush_to</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define L2CAP_SERV_NOTRAFIC	0x00</span>
<span class="cp">#define L2CAP_SERV_BESTEFFORT	0x01</span>
<span class="cp">#define L2CAP_SERV_GUARANTEED	0x02</span>

<span class="cp">#define L2CAP_BESTEFFORT_ID	0x01</span>

<span class="k">struct</span> <span class="n">l2cap_disconn_req</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">dcid</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">scid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_disconn_rsp</span> <span class="p">{</span>
	<span class="n">__le16</span>     <span class="n">dcid</span><span class="p">;</span>
	<span class="n">__le16</span>     <span class="n">scid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_info_req</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">type</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_info_rsp</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">type</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">result</span><span class="p">;</span>
	<span class="n">__u8</span>        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_create_chan_req</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">psm</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">scid</span><span class="p">;</span>
	<span class="n">__u8</span>        <span class="n">amp_id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_create_chan_rsp</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">dcid</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">scid</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">result</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">status</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_move_chan_req</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">icid</span><span class="p">;</span>
	<span class="n">__u8</span>        <span class="n">dest_amp_id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_move_chan_rsp</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">icid</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">result</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define L2CAP_MR_SUCCESS	0x0000</span>
<span class="cp">#define L2CAP_MR_PEND		0x0001</span>
<span class="cp">#define L2CAP_MR_BAD_ID		0x0002</span>
<span class="cp">#define L2CAP_MR_SAME_ID	0x0003</span>
<span class="cp">#define L2CAP_MR_NOT_SUPP	0x0004</span>
<span class="cp">#define L2CAP_MR_COLLISION	0x0005</span>
<span class="cp">#define L2CAP_MR_NOT_ALLOWED	0x0006</span>

<span class="k">struct</span> <span class="n">l2cap_move_chan_cfm</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">icid</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">result</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define L2CAP_MC_CONFIRMED	0x0000</span>
<span class="cp">#define L2CAP_MC_UNCONFIRMED	0x0001</span>

<span class="k">struct</span> <span class="n">l2cap_move_chan_cfm_rsp</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">icid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* info type */</span>
<span class="cp">#define L2CAP_IT_CL_MTU		0x0001</span>
<span class="cp">#define L2CAP_IT_FEAT_MASK	0x0002</span>
<span class="cp">#define L2CAP_IT_FIXED_CHAN	0x0003</span>

<span class="cm">/* info result */</span>
<span class="cp">#define L2CAP_IR_SUCCESS	0x0000</span>
<span class="cp">#define L2CAP_IR_NOTSUPP	0x0001</span>

<span class="k">struct</span> <span class="n">l2cap_conn_param_update_req</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">min</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">max</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">latency</span><span class="p">;</span>
	<span class="n">__le16</span>      <span class="n">to_multiplier</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">l2cap_conn_param_update_rsp</span> <span class="p">{</span>
	<span class="n">__le16</span>      <span class="n">result</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Connection Parameters result */</span>
<span class="cp">#define L2CAP_CONN_PARAM_ACCEPTED	0x0000</span>
<span class="cp">#define L2CAP_CONN_PARAM_REJECTED	0x0001</span>

<span class="cm">/* ----- L2CAP channels and connections ----- */</span>
<span class="k">struct</span> <span class="n">l2cap_seq_list</span> <span class="p">{</span>
	<span class="n">__u16</span>	<span class="n">head</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">tail</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">mask</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="o">*</span><span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define L2CAP_SEQ_LIST_CLEAR	0xFFFF</span>
<span class="cp">#define L2CAP_SEQ_LIST_TAIL	0x8000</span>

<span class="k">struct</span> <span class="n">srej_list</span> <span class="p">{</span>
	<span class="n">__u16</span>	<span class="n">tx_seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">l2cap_conn</span>	<span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">state</span><span class="p">;</span>

	<span class="n">atomic_t</span>	<span class="n">refcnt</span><span class="p">;</span>

	<span class="n">__le16</span>		<span class="n">psm</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">dcid</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">scid</span><span class="p">;</span>

	<span class="n">__u16</span>		<span class="n">imtu</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">omtu</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">flush_to</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">mode</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">chan_type</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">chan_policy</span><span class="p">;</span>

	<span class="n">__le16</span>		<span class="n">sport</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">sec_level</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">ident</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">conf_req</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">__u8</span>		<span class="n">conf_len</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">num_conf_req</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">num_conf_rsp</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">fcs</span><span class="p">;</span>

	<span class="n">__u16</span>		<span class="n">tx_win</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tx_win_max</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">max_tx</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">retrans_timeout</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">monitor_timeout</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">mps</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">tx_state</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">rx_state</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">conf_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">conn_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">__u16</span>		<span class="n">next_tx_seq</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">expected_ack_seq</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">expected_tx_seq</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">buffer_seq</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">buffer_seq_srej</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">srej_save_reqseq</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">last_acked_seq</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">frames_sent</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">unacked_frames</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">retry_count</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">srej_queue_next</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">num_acked</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">sdu_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">sdu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">sdu_last_frag</span><span class="p">;</span>

	<span class="n">__u16</span>		<span class="n">remote_tx_win</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">remote_max_tx</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">remote_mps</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">local_id</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">local_stype</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">local_msdu</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">local_sdu_itime</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">local_acc_lat</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">local_flush_to</span><span class="p">;</span>

	<span class="n">__u8</span>		<span class="n">remote_id</span><span class="p">;</span>
	<span class="n">__u8</span>		<span class="n">remote_stype</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">remote_msdu</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">remote_sdu_itime</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">remote_acc_lat</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">remote_flush_to</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">chan_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">retrans_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">monitor_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">ack_timer</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">tx_send_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span>	<span class="n">tx_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span>	<span class="n">srej_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_seq_list</span>	<span class="n">srej_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_seq_list</span>	<span class="n">retrans_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">srej_l</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">global_l</span><span class="p">;</span>

	<span class="kt">void</span>			<span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_ops</span>	<span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">l2cap_ops</span> <span class="p">{</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">l2cap_chan</span>	<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">new_connection</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">recv</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">state_change</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc_skb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">l2cap_conn</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hci_conn</span>		<span class="o">*</span><span class="n">hcon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hci_chan</span>		<span class="o">*</span><span class="n">hchan</span><span class="p">;</span>

	<span class="n">bdaddr_t</span>		<span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">bdaddr_t</span>		<span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">mtu</span><span class="p">;</span>

	<span class="n">__u32</span>			<span class="n">feat_mask</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">fixed_chan_mask</span><span class="p">;</span>

	<span class="n">__u8</span>			<span class="n">info_state</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">info_ident</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">info_timer</span><span class="p">;</span>

	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">rx_len</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">tx_ident</span><span class="p">;</span>

	<span class="n">__u8</span>			<span class="n">disc_reason</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">security_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_chan</span>		<span class="o">*</span><span class="n">smp_chan</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">chan_l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">chan_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define L2CAP_INFO_CL_MTU_REQ_SENT	0x01</span>
<span class="cp">#define L2CAP_INFO_FEAT_MASK_REQ_SENT	0x04</span>
<span class="cp">#define L2CAP_INFO_FEAT_MASK_REQ_DONE	0x08</span>

<span class="cp">#define L2CAP_CHAN_RAW			1</span>
<span class="cp">#define L2CAP_CHAN_CONN_LESS		2</span>
<span class="cp">#define L2CAP_CHAN_CONN_ORIENTED	3</span>

<span class="cm">/* ----- L2CAP socket info ----- */</span>
<span class="cp">#define l2cap_pi(sk) ((struct l2cap_pinfo *) sk)</span>

<span class="k">struct</span> <span class="n">l2cap_pinfo</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bt_sock</span>		<span class="n">bt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2cap_chan</span>	<span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">rx_busy_skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CONF_REQ_SENT</span><span class="p">,</span>
	<span class="n">CONF_INPUT_DONE</span><span class="p">,</span>
	<span class="n">CONF_OUTPUT_DONE</span><span class="p">,</span>
	<span class="n">CONF_MTU_DONE</span><span class="p">,</span>
	<span class="n">CONF_MODE_DONE</span><span class="p">,</span>
	<span class="n">CONF_CONNECT_PEND</span><span class="p">,</span>
	<span class="n">CONF_NO_FCS_RECV</span><span class="p">,</span>
	<span class="n">CONF_STATE2_DEVICE</span><span class="p">,</span>
	<span class="n">CONF_EWS_RECV</span><span class="p">,</span>
	<span class="n">CONF_LOC_CONF_PEND</span><span class="p">,</span>
	<span class="n">CONF_REM_CONF_PEND</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define L2CAP_CONF_MAX_CONF_REQ 2</span>
<span class="cp">#define L2CAP_CONF_MAX_CONF_RSP 2</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CONN_SREJ_SENT</span><span class="p">,</span>
	<span class="n">CONN_WAIT_F</span><span class="p">,</span>
	<span class="n">CONN_SREJ_ACT</span><span class="p">,</span>
	<span class="n">CONN_SEND_PBIT</span><span class="p">,</span>
	<span class="n">CONN_REMOTE_BUSY</span><span class="p">,</span>
	<span class="n">CONN_LOCAL_BUSY</span><span class="p">,</span>
	<span class="n">CONN_REJ_ACT</span><span class="p">,</span>
	<span class="n">CONN_SEND_FBIT</span><span class="p">,</span>
	<span class="n">CONN_RNR_SENT</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Definitions for flags in l2cap_chan */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">FLAG_ROLE_SWITCH</span><span class="p">,</span>
	<span class="n">FLAG_FORCE_ACTIVE</span><span class="p">,</span>
	<span class="n">FLAG_FORCE_RELIABLE</span><span class="p">,</span>
	<span class="n">FLAG_FLUSHABLE</span><span class="p">,</span>
	<span class="n">FLAG_EXT_CTRL</span><span class="p">,</span>
	<span class="n">FLAG_EFS_ENABLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">L2CAP_TX_STATE_XMIT</span><span class="p">,</span>
	<span class="n">L2CAP_TX_STATE_WAIT_F</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">L2CAP_RX_STATE_RECV</span><span class="p">,</span>
	<span class="n">L2CAP_RX_STATE_SREJ_SENT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">L2CAP_TXSEQ_EXPECTED</span><span class="p">,</span>
	<span class="n">L2CAP_TXSEQ_EXPECTED_SREJ</span><span class="p">,</span>
	<span class="n">L2CAP_TXSEQ_UNEXPECTED</span><span class="p">,</span>
	<span class="n">L2CAP_TXSEQ_UNEXPECTED_SREJ</span><span class="p">,</span>
	<span class="n">L2CAP_TXSEQ_DUPLICATE</span><span class="p">,</span>
	<span class="n">L2CAP_TXSEQ_DUPLICATE_SREJ</span><span class="p">,</span>
	<span class="n">L2CAP_TXSEQ_INVALID</span><span class="p">,</span>
	<span class="n">L2CAP_TXSEQ_INVALID_IGNORE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">L2CAP_EV_DATA_REQUEST</span><span class="p">,</span>
	<span class="n">L2CAP_EV_LOCAL_BUSY_DETECTED</span><span class="p">,</span>
	<span class="n">L2CAP_EV_LOCAL_BUSY_CLEAR</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RECV_REQSEQ_AND_FBIT</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RECV_FBIT</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RETRANS_TO</span><span class="p">,</span>
	<span class="n">L2CAP_EV_MONITOR_TO</span><span class="p">,</span>
	<span class="n">L2CAP_EV_EXPLICIT_POLL</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RECV_IFRAME</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RECV_RR</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RECV_REJ</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RECV_RNR</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RECV_SREJ</span><span class="p">,</span>
	<span class="n">L2CAP_EV_RECV_FRAME</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_chan_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_chan_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_chan_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_chan_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2cap_set_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BT_DBG</span><span class="p">(</span><span class="s">&quot;chan %p state %s timeout %ld&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
	       <span class="n">state_to_string</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="cm">/* If delayed work cancelled do not hold(chan)</span>
<span class="cm">	   since it is already done with previous set_timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">))</span>
		<span class="n">l2cap_chan_hold</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">l2cap_clear_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* put(chan) if delayed work cancelled otherwise it</span>
<span class="cm">	   is done in delayed work function */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cancel_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">l2cap_chan_put</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define __set_chan_timer(c, t) l2cap_set_timer(c, &amp;c-&gt;chan_timer, (t))</span>
<span class="cp">#define __clear_chan_timer(c) l2cap_clear_timer(c, &amp;c-&gt;chan_timer)</span>
<span class="cp">#define __set_retrans_timer(c) l2cap_set_timer(c, &amp;c-&gt;retrans_timer, \</span>
<span class="cp">		msecs_to_jiffies(L2CAP_DEFAULT_RETRANS_TO));</span>
<span class="cp">#define __clear_retrans_timer(c) l2cap_clear_timer(c, &amp;c-&gt;retrans_timer)</span>
<span class="cp">#define __set_monitor_timer(c) l2cap_set_timer(c, &amp;c-&gt;monitor_timer, \</span>
<span class="cp">		msecs_to_jiffies(L2CAP_DEFAULT_MONITOR_TO));</span>
<span class="cp">#define __clear_monitor_timer(c) l2cap_clear_timer(c, &amp;c-&gt;monitor_timer)</span>
<span class="cp">#define __set_ack_timer(c) l2cap_set_timer(c, &amp;chan-&gt;ack_timer, \</span>
<span class="cp">		msecs_to_jiffies(L2CAP_DEFAULT_ACK_TO));</span>
<span class="cp">#define __clear_ack_timer(c) l2cap_clear_timer(c, &amp;c-&gt;ack_timer)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__seq_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">seq1</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">seq2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq1</span> <span class="o">&gt;=</span> <span class="n">seq2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">seq1</span> <span class="o">-</span> <span class="n">seq2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win_max</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">seq2</span> <span class="o">+</span> <span class="n">seq1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u16</span> <span class="nf">__next_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tx_win_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">l2cap_tx_window_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sub</span><span class="p">;</span>

	<span class="n">sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">next_tx_seq</span> <span class="o">-</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">expected_ack_seq</span><span class="p">)</span> <span class="o">%</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sub</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sub</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_tx_win</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u16</span> <span class="nf">__get_reqseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_REQSEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
						<span class="n">L2CAP_EXT_CTRL_REQSEQ_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_REQSEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_REQSEQ_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__set_reqseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">reqseq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">reqseq</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_REQSEQ_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="n">L2CAP_EXT_CTRL_REQSEQ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">reqseq</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_REQSEQ_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_REQSEQ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u16</span> <span class="nf">__get_txseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_TXSEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
						<span class="n">L2CAP_EXT_CTRL_TXSEQ_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_TXSEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_TXSEQ_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__set_txseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">txseq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">txseq</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_TXSEQ_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="n">L2CAP_EXT_CTRL_TXSEQ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">txseq</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_TXSEQ_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_TXSEQ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">__is_sframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_FRAME_TYPE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_FRAME_TYPE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__set_sframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">L2CAP_EXT_CTRL_FRAME_TYPE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">L2CAP_CTRL_FRAME_TYPE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span> <span class="nf">__get_ctrl_sar</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_SAR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_EXT_CTRL_SAR_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_SAR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_SAR_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__set_ctrl_sar</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">sar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">sar</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_SAR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_SAR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">sar</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_SAR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_SAR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">__is_sar_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__get_ctrl_sar</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">)</span> <span class="o">==</span> <span class="n">L2CAP_SAR_START</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__get_sar_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">L2CAP_EXT_CTRL_SAR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">L2CAP_CTRL_SAR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span> <span class="nf">__get_ctrl_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_SUPERVISE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
						<span class="n">L2CAP_EXT_CTRL_SUPER_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_SUPERVISE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">L2CAP_CTRL_SUPER_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__set_ctrl_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">super</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">super</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_EXT_CTRL_SUPER_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">L2CAP_EXT_CTRL_SUPERVISE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">super</span> <span class="o">&lt;&lt;</span> <span class="n">L2CAP_CTRL_SUPER_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="n">L2CAP_CTRL_SUPERVISE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__set_ctrl_final</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">L2CAP_EXT_CTRL_FINAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">L2CAP_CTRL_FINAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">__is_ctrl_final</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_FINAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_FINAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__set_ctrl_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">L2CAP_EXT_CTRL_POLL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">L2CAP_CTRL_POLL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">__is_ctrl_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_EXT_CTRL_POLL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">L2CAP_CTRL_POLL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u32</span> <span class="nf">__get_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__put_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">control</span><span class="p">,</span>
								<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span> <span class="nf">__ctrl_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">L2CAP_EXT_HDR_SIZE</span> <span class="o">-</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">L2CAP_ENH_HDR_SIZE</span> <span class="o">-</span> <span class="n">L2CAP_HDR_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="n">bool</span> <span class="n">disable_ertm</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">l2cap_init_sockets</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">l2cap_cleanup_sockets</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__l2cap_connect_rsp_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">__l2cap_wait_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">l2cap_add_psm</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">psm</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">l2cap_add_scid</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>  <span class="n">__u16</span> <span class="n">scid</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">l2cap_chan_create</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">l2cap_chan_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">l2cap_chan_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">l2cap_chan_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">psm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cid</span><span class="p">,</span>
		       <span class="n">bdaddr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dst_type</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">l2cap_chan_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
								<span class="n">u32</span> <span class="n">priority</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">l2cap_chan_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">busy</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">l2cap_chan_check_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">l2cap_chan_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">l2cap_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* __L2CAP_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
