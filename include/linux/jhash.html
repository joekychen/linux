<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › jhash.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>jhash.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _LINUX_JHASH_H</span>
<span class="cp">#define _LINUX_JHASH_H</span>

<span class="cm">/* jhash.h: Jenkins hash support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006. Bob Jenkins (bob_jenkins@burtleburtle.net)</span>
<span class="cm"> *</span>
<span class="cm"> * http://burtleburtle.net/bob/hash/</span>
<span class="cm"> *</span>
<span class="cm"> * These are the credits from Bob&#39;s sources:</span>
<span class="cm"> *</span>
<span class="cm"> * lookup3.c, by Bob Jenkins, May 2006, Public Domain.</span>
<span class="cm"> *</span>
<span class="cm"> * These are functions for producing 32-bit hashes for hash table lookup.</span>
<span class="cm"> * hashword(), hashlittle(), hashlittle2(), hashbig(), mix(), and final()</span>
<span class="cm"> * are externally useful functions.  Routines to test the hash are included</span>
<span class="cm"> * if SELF_TEST is defined.  You can use this free for any purpose.  It&#39;s in</span>
<span class="cm"> * the public domain.  It has no warranty.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009-2010 Jozsef Kadlecsik (kadlec@blackhole.kfki.hu)</span>
<span class="cm"> *</span>
<span class="cm"> * I&#39;ve modified Bob&#39;s hash to be useful in the Linux kernel, and</span>
<span class="cm"> * any bugs present are my fault.</span>
<span class="cm"> * Jozsef</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/unaligned/packed_struct.h&gt;</span>

<span class="cm">/* Best hash sizes are of power of two */</span>
<span class="cp">#define jhash_size(n)   ((u32)1&lt;&lt;(n))</span>
<span class="cm">/* Mask the hash value, i.e (value &amp; jhash_mask(n)) instead of (value % n) */</span>
<span class="cp">#define jhash_mask(n)   (jhash_size(n)-1)</span>

<span class="cm">/* __jhash_mix -- mix 3 32-bit values reversibly. */</span>
<span class="cp">#define __jhash_mix(a, b, c)			\</span>
<span class="cp">{						\</span>
<span class="cp">	a -= c;  a ^= rol32(c, 4);  c += b;	\</span>
<span class="cp">	b -= a;  b ^= rol32(a, 6);  a += c;	\</span>
<span class="cp">	c -= b;  c ^= rol32(b, 8);  b += a;	\</span>
<span class="cp">	a -= c;  a ^= rol32(c, 16); c += b;	\</span>
<span class="cp">	b -= a;  b ^= rol32(a, 19); a += c;	\</span>
<span class="cp">	c -= b;  c ^= rol32(b, 4);  b += a;	\</span>
<span class="cp">}</span>

<span class="cm">/* __jhash_final - final mixing of 3 32-bit values (a,b,c) into c */</span>
<span class="cp">#define __jhash_final(a, b, c)			\</span>
<span class="cp">{						\</span>
<span class="cp">	c ^= b; c -= rol32(b, 14);		\</span>
<span class="cp">	a ^= c; a -= rol32(c, 11);		\</span>
<span class="cp">	b ^= a; b -= rol32(a, 25);		\</span>
<span class="cp">	c ^= b; c -= rol32(b, 16);		\</span>
<span class="cp">	a ^= c; a -= rol32(c, 4);		\</span>
<span class="cp">	b ^= a; b -= rol32(a, 14);		\</span>
<span class="cp">	c ^= b; c -= rol32(b, 24);		\</span>
<span class="cp">}</span>

<span class="cm">/* An arbitrary initial parameter */</span>
<span class="cp">#define JHASH_INITVAL		0xdeadbeef</span>

<span class="cm">/* jhash - hash an arbitrary key</span>
<span class="cm"> * @k: sequence of bytes as key</span>
<span class="cm"> * @length: the length of the key</span>
<span class="cm"> * @initval: the previous hash, or an arbitray value</span>
<span class="cm"> *</span>
<span class="cm"> * The generic version, hashes an arbitrary sequence of bytes.</span>
<span class="cm"> * No alignment or length assumptions are made about the input key.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the hash value of the key. The result depends on endianness.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">jhash</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">u32</span> <span class="n">initval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>

	<span class="cm">/* Set up the internal state */</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="n">JHASH_INITVAL</span> <span class="o">+</span> <span class="n">length</span> <span class="o">+</span> <span class="n">initval</span><span class="p">;</span>

	<span class="cm">/* All but the last block: affect some 32 bits of (a,b,c) */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">+=</span> <span class="n">__get_unaligned_cpu32</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">+=</span> <span class="n">__get_unaligned_cpu32</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">+=</span> <span class="n">__get_unaligned_cpu32</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">__jhash_mix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">k</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Last block: affect all 32 bits of (c) */</span>
	<span class="cm">/* All the case statements fall through */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">12</span>: <span class="n">c</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>: <span class="n">c</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>: <span class="n">c</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:  <span class="n">c</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">case</span> <span class="mi">8</span>:  <span class="n">b</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:  <span class="n">b</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:  <span class="n">b</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:  <span class="n">b</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">case</span> <span class="mi">4</span>:  <span class="n">a</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:  <span class="n">a</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:  <span class="n">a</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:  <span class="n">a</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		 <span class="n">__jhash_final</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* Nothing left to add */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* jhash2 - hash an array of u32&#39;s</span>
<span class="cm"> * @k: the key which must be an array of u32&#39;s</span>
<span class="cm"> * @length: the number of u32&#39;s in the key</span>
<span class="cm"> * @initval: the previous hash, or an arbitray value</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the hash value of the key.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">jhash2</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">u32</span> <span class="n">initval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="cm">/* Set up the internal state */</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="n">JHASH_INITVAL</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">initval</span><span class="p">;</span>

	<span class="cm">/* Handle most of the key */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">b</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">c</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">__jhash_mix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">k</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle the last 3 u32&#39;s: all the case statements fall through */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">c</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">b</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">a</span> <span class="o">+=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">__jhash_final</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* Nothing left to add */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* jhash_3words - hash exactly 3, 2 or 1 word(s) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">jhash_3words</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">initval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span> <span class="o">+=</span> <span class="n">JHASH_INITVAL</span><span class="p">;</span>
	<span class="n">b</span> <span class="o">+=</span> <span class="n">JHASH_INITVAL</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">+=</span> <span class="n">initval</span><span class="p">;</span>

	<span class="n">__jhash_final</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">jhash_2words</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">initval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">jhash_3words</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">initval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">jhash_1word</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">initval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">jhash_3words</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">initval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_JHASH_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
