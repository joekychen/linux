<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › rio.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rio.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * RapidIO interconnect services</span>
<span class="cm"> * (RapidIO Interconnect Specification, http://www.rapidio.org)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 MontaVista Software, Inc.</span>
<span class="cm"> * Matt Porter &lt;mporter@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef LINUX_RIO_H</span>
<span class="cp">#define LINUX_RIO_H</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/rio_regs.h&gt;</span>
<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define RIO_NO_HOPCOUNT		-1</span>
<span class="cp">#define RIO_INVALID_DESTID	0xffff</span>

<span class="cp">#define RIO_MAX_MPORTS		8</span>
<span class="cp">#define RIO_MAX_MPORT_RESOURCES	16</span>
<span class="cp">#define RIO_MAX_DEV_RESOURCES	16</span>

<span class="cp">#define RIO_GLOBAL_TABLE	0xff	</span><span class="cm">/* Indicates access of a switch&#39;s</span>
<span class="cm">					   global routing table if it</span>
<span class="cm">					   has multiple (or per port)</span>
<span class="cm">					   tables */</span><span class="cp"></span>

<span class="cp">#define RIO_INVALID_ROUTE	0xff	</span><span class="cm">/* Indicates that a route table</span>
<span class="cm">					   entry is invalid (no route</span>
<span class="cm">					   exists for the device ID) */</span><span class="cp"></span>

<span class="cp">#define RIO_MAX_ROUTE_ENTRIES(size)	(size ? (1 &lt;&lt; 16) : (1 &lt;&lt; 8))</span>
<span class="cp">#define RIO_ANY_DESTID(size)		(size ? 0xffff : 0xff)</span>

<span class="cp">#define RIO_MAX_MBOX		4</span>
<span class="cp">#define RIO_MAX_MSG_SIZE	0x1000</span>

<span class="cm">/*</span>
<span class="cm"> * Error values that may be returned by RIO functions.</span>
<span class="cm"> */</span>
<span class="cp">#define RIO_SUCCESSFUL			0x00</span>
<span class="cp">#define RIO_BAD_SIZE			0x81</span>

<span class="cm">/*</span>
<span class="cm"> * For RIO devices, the region numbers are assigned this way:</span>
<span class="cm"> *</span>
<span class="cm"> *	0	RapidIO outbound doorbells</span>
<span class="cm"> *      1-15	RapidIO memory regions</span>
<span class="cm"> *</span>
<span class="cm"> * For RIO master ports, the region number are assigned this way:</span>
<span class="cm"> *</span>
<span class="cm"> *	0	RapidIO inbound doorbells</span>
<span class="cm"> *	1	RapidIO inbound mailboxes</span>
<span class="cm"> *	1	RapidIO outbound mailboxes</span>
<span class="cm"> */</span>
<span class="cp">#define RIO_DOORBELL_RESOURCE	0</span>
<span class="cp">#define RIO_INB_MBOX_RESOURCE	1</span>
<span class="cp">#define RIO_OUTB_MBOX_RESOURCE	2</span>

<span class="cp">#define RIO_PW_MSG_SIZE		64</span>

<span class="cm">/*</span>
<span class="cm"> * A component tag value (stored in the component tag CSR) is used as device&#39;s</span>
<span class="cm"> * unique identifier assigned during enumeration. Besides being used for</span>
<span class="cm"> * identifying switches (which do not have device ID register), it also is used</span>
<span class="cm"> * by error management notification and therefore has to be assigned</span>
<span class="cm"> * to endpoints as well.</span>
<span class="cm"> */</span>
<span class="cp">#define RIO_CTAG_RESRVD	0xfffe0000 </span><span class="cm">/* Reserved */</span><span class="cp"></span>
<span class="cp">#define RIO_CTAG_UDEVID	0x0001ffff </span><span class="cm">/* Unique device identifier */</span><span class="cp"></span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">rio_bus_type</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">device</span> <span class="n">rio_bus</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">rio_devices</span><span class="p">;</span>	<span class="cm">/* list of all devices */</span>

<span class="k">struct</span> <span class="n">rio_mport</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rio_dev</span><span class="p">;</span>
<span class="k">union</span> <span class="n">rio_pw_msg</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_switch - RIO switch info</span>
<span class="cm"> * @node: Node in global list of switches</span>
<span class="cm"> * @switchid: Switch ID that is unique across a network</span>
<span class="cm"> * @route_table: Copy of switch routing table</span>
<span class="cm"> * @port_ok: Status of each port (one bit per port) - OK=1 or UNINIT=0</span>
<span class="cm"> * @add_entry: Callback for switch-specific route add function</span>
<span class="cm"> * @get_entry: Callback for switch-specific route get function</span>
<span class="cm"> * @clr_table: Callback for switch-specific clear route table function</span>
<span class="cm"> * @set_domain: Callback for switch-specific domain setting function</span>
<span class="cm"> * @get_domain: Callback for switch-specific domain get function</span>
<span class="cm"> * @em_init: Callback for switch-specific error management init function</span>
<span class="cm"> * @em_handle: Callback for switch-specific error management handler function</span>
<span class="cm"> * @sw_sysfs: Callback that initializes switch-specific sysfs attributes</span>
<span class="cm"> * @nextdev: Array of per-port pointers to the next attached device</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_switch</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">switchid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">route_table</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">add_entry</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">table</span><span class="p">,</span> <span class="n">u16</span> <span class="n">route_destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">route_port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_entry</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">table</span><span class="p">,</span> <span class="n">u16</span> <span class="n">route_destid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">route_port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">clr_table</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">table</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_domain</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">sw_domain</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_domain</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">sw_domain</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">em_init</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">em_handle</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">swport</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">sw_sysfs</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">nextdev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_dev - RIO device info</span>
<span class="cm"> * @global_list: Node in list of all RIO devices</span>
<span class="cm"> * @net_list: Node in list of RIO devices in a network</span>
<span class="cm"> * @net: Network this device is a part of</span>
<span class="cm"> * @did: Device ID</span>
<span class="cm"> * @vid: Vendor ID</span>
<span class="cm"> * @device_rev: Device revision</span>
<span class="cm"> * @asm_did: Assembly device ID</span>
<span class="cm"> * @asm_vid: Assembly vendor ID</span>
<span class="cm"> * @asm_rev: Assembly revision</span>
<span class="cm"> * @efptr: Extended feature pointer</span>
<span class="cm"> * @pef: Processing element features</span>
<span class="cm"> * @swpinfo: Switch port info</span>
<span class="cm"> * @src_ops: Source operation capabilities</span>
<span class="cm"> * @dst_ops: Destination operation capabilities</span>
<span class="cm"> * @comp_tag: RIO component tag</span>
<span class="cm"> * @phys_efptr: RIO device extended features pointer</span>
<span class="cm"> * @em_efptr: RIO Error Management features pointer</span>
<span class="cm"> * @dma_mask: Mask of bits of RIO address this device implements</span>
<span class="cm"> * @driver: Driver claiming this device</span>
<span class="cm"> * @dev: Device model device</span>
<span class="cm"> * @riores: RIO resources this device owns</span>
<span class="cm"> * @pwcback: port-write callback function for this device</span>
<span class="cm"> * @destid: Network destination ID (or associated destid for switch)</span>
<span class="cm"> * @hopcount: Hopcount to this device</span>
<span class="cm"> * @prev: Previous RIO device connected to the current one</span>
<span class="cm"> * @rswitch: struct rio_switch (if valid for this device)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">global_list</span><span class="p">;</span>	<span class="cm">/* node in list of all RIO devices */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">net_list</span><span class="p">;</span>	<span class="cm">/* node in per net list */</span>
	<span class="k">struct</span> <span class="n">rio_net</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>	<span class="cm">/* RIO net this device resides in */</span>
	<span class="n">u16</span> <span class="n">did</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_rev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">asm_did</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">asm_vid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">asm_rev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">efptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pef</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swpinfo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">src_ops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dst_ops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">comp_tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_efptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">em_efptr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dma_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>	<span class="cm">/* RIO driver claiming this device */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="n">dev</span><span class="p">;</span>	<span class="cm">/* LDM device structure */</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">riores</span><span class="p">[</span><span class="n">RIO_MAX_DEV_RESOURCES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pwcback</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">union</span> <span class="n">rio_pw_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">step</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">destid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hopcount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_switch</span> <span class="n">rswitch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* RIO switch info */</span>
<span class="p">};</span>

<span class="cp">#define rio_dev_g(n) list_entry(n, struct rio_dev, global_list)</span>
<span class="cp">#define rio_dev_f(n) list_entry(n, struct rio_dev, net_list)</span>
<span class="cp">#define	to_rio_dev(n) container_of(n, struct rio_dev, dev)</span>
<span class="cp">#define sw_to_rio_dev(n) container_of(n, struct rio_dev, rswitch[0])</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_msg - RIO message event</span>
<span class="cm"> * @res: Mailbox resource</span>
<span class="cm"> * @mcback: Message event callback</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_msg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">mcback</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span> <span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_dbell - RIO doorbell event</span>
<span class="cm"> * @node: Node in list of doorbell events</span>
<span class="cm"> * @res: Doorbell resource</span>
<span class="cm"> * @dinb: Doorbell event callback</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_dbell</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dinb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">src</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dst</span><span class="p">,</span> <span class="n">u16</span> <span class="n">info</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rio_phy_type</span> <span class="p">{</span>
	<span class="n">RIO_PHY_PARALLEL</span><span class="p">,</span>
	<span class="n">RIO_PHY_SERIAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_mport - RIO master port info</span>
<span class="cm"> * @dbells: List of doorbell events</span>
<span class="cm"> * @node: Node in global list of master ports</span>
<span class="cm"> * @nnode: Node in network list of master ports</span>
<span class="cm"> * @iores: I/O mem resource that this master port interface owns</span>
<span class="cm"> * @riores: RIO resources that this master port interfaces owns</span>
<span class="cm"> * @inb_msg: RIO inbound message event descriptors</span>
<span class="cm"> * @outb_msg: RIO outbound message event descriptors</span>
<span class="cm"> * @host_deviceid: Host device ID associated with this master port</span>
<span class="cm"> * @ops: configuration space functions</span>
<span class="cm"> * @id: Port ID, unique among all ports</span>
<span class="cm"> * @index: Port index, unique among all port interfaces of the same type</span>
<span class="cm"> * @sys_size: RapidIO common transport system size</span>
<span class="cm"> * @phy_type: RapidIO phy type</span>
<span class="cm"> * @phys_efptr: RIO port extended features pointer</span>
<span class="cm"> * @name: Port name string</span>
<span class="cm"> * @priv: Master port private data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_mport</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dbells</span><span class="p">;</span>	<span class="cm">/* list of doorbell events */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>	<span class="cm">/* node in global list of ports */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">nnode</span><span class="p">;</span>	<span class="cm">/* node in net list of ports */</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">iores</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">riores</span><span class="p">[</span><span class="n">RIO_MAX_MPORT_RESOURCES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rio_msg</span> <span class="n">inb_msg</span><span class="p">[</span><span class="n">RIO_MAX_MBOX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rio_msg</span> <span class="n">outb_msg</span><span class="p">[</span><span class="n">RIO_MAX_MBOX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">host_deviceid</span><span class="p">;</span>	<span class="cm">/* Host device ID */</span>
	<span class="k">struct</span> <span class="n">rio_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>	<span class="cm">/* low-level architecture-dependent routines */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">;</span>	<span class="cm">/* port ID, unique among all ports */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span><span class="p">;</span>	<span class="cm">/* port index, unique among all port</span>
<span class="cm">				   interfaces of the same type */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_size</span><span class="p">;</span>	<span class="cm">/* RapidIO common transport system size.</span>
<span class="cm">				 * 0 - Small size. 256 devices.</span>
<span class="cm">				 * 1 - Large size, 65536 devices.</span>
<span class="cm">				 */</span>
	<span class="k">enum</span> <span class="n">rio_phy_type</span> <span class="n">phy_type</span><span class="p">;</span>	<span class="cm">/* RapidIO phy type */</span>
	<span class="n">u32</span> <span class="n">phys_efptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>		<span class="cm">/* Master port private data */</span>
<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>
	<span class="k">struct</span> <span class="n">dma_device</span>	<span class="n">dma</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_net - RIO network info</span>
<span class="cm"> * @node: Node in global list of RIO networks</span>
<span class="cm"> * @devices: List of devices in this network</span>
<span class="cm"> * @mports: List of master ports accessing this network</span>
<span class="cm"> * @hport: Default port for accessing this network</span>
<span class="cm"> * @id: RIO network ID</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_net</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>	<span class="cm">/* node in list of networks */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">devices</span><span class="p">;</span>	<span class="cm">/* list of devices in this net */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">mports</span><span class="p">;</span>	<span class="cm">/* list of ports accessing net */</span>
	<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">hport</span><span class="p">;</span>	<span class="cm">/* primary port for accessing net */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">;</span>	<span class="cm">/* RIO network ID */</span>
<span class="p">};</span>

<span class="cm">/* Definitions used by switch sysfs initialization callback */</span>
<span class="cp">#define RIO_SW_SYSFS_CREATE	1	</span><span class="cm">/* Create switch attributes */</span><span class="cp"></span>
<span class="cp">#define RIO_SW_SYSFS_REMOVE	0	</span><span class="cm">/* Remove switch attributes */</span><span class="cp"></span>

<span class="cm">/* Low-level architecture-dependent routines */</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_ops - Low-level RIO configuration space operations</span>
<span class="cm"> * @lcread: Callback to perform local (master port) read of config space.</span>
<span class="cm"> * @lcwrite: Callback to perform local (master port) write of config space.</span>
<span class="cm"> * @cread: Callback to perform network read of config space.</span>
<span class="cm"> * @cwrite: Callback to perform network write of config space.</span>
<span class="cm"> * @dsend: Callback to send a doorbell message.</span>
<span class="cm"> * @pwenable: Callback to enable/disable port-write message handling.</span>
<span class="cm"> * @open_outb_mbox: Callback to initialize outbound mailbox.</span>
<span class="cm"> * @close_outb_mbox: Callback to shut down outbound mailbox.</span>
<span class="cm"> * @open_inb_mbox: Callback to initialize inbound mailbox.</span>
<span class="cm"> * @close_inb_mbox: Callback to	shut down inbound mailbox.</span>
<span class="cm"> * @add_outb_message: Callback to add a message to an outbound mailbox queue.</span>
<span class="cm"> * @add_inb_buffer: Callback to	add a buffer to an inbound mailbox queue.</span>
<span class="cm"> * @get_inb_message: Callback to get a message from an inbound mailbox queue.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_ops</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">lcread</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">lcwrite</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cread</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cwrite</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">dsend</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pwenable</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">open_outb_mbox</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">close_outb_mbox</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">open_inb_mbox</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">close_inb_mbox</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">add_outb_message</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">add_inb_buffer</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_inb_message</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define RIO_RESOURCE_MEM	0x00000100</span>
<span class="cp">#define RIO_RESOURCE_DOORBELL	0x00000200</span>
<span class="cp">#define RIO_RESOURCE_MAILBOX	0x00000400</span>

<span class="cp">#define RIO_RESOURCE_CACHEABLE	0x00010000</span>
<span class="cp">#define RIO_RESOURCE_PCI	0x00020000</span>

<span class="cp">#define RIO_RESOURCE_BUSY	0x80000000</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_driver - RIO driver info</span>
<span class="cm"> * @node: Node in list of drivers</span>
<span class="cm"> * @name: RIO driver name</span>
<span class="cm"> * @id_table: RIO device ids to be associated with this driver</span>
<span class="cm"> * @probe: RIO device inserted</span>
<span class="cm"> * @remove: RIO device removed</span>
<span class="cm"> * @suspend: RIO device suspended</span>
<span class="cm"> * @resume: RIO device awakened</span>
<span class="cm"> * @enable_wake: RIO device enable wake event</span>
<span class="cm"> * @driver: LDM driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Provides info on a RIO device driver for insertion/removal and</span>
<span class="cm"> * power management purposes.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_driver</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rio_device_id</span> <span class="o">*</span><span class="n">id_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rio_device_id</span> <span class="o">*</span> <span class="n">id</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">state</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">enable_wake</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="n">driver</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	to_rio_driver(drv) container_of(drv,struct rio_driver, driver)</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_device_id - RIO device identifier</span>
<span class="cm"> * @did: RIO device ID</span>
<span class="cm"> * @vid: RIO vendor ID</span>
<span class="cm"> * @asm_did: RIO assembly device ID</span>
<span class="cm"> * @asm_vid: RIO assembly vendor ID</span>
<span class="cm"> *</span>
<span class="cm"> * Identifies a RIO device based on both the device/vendor IDs and</span>
<span class="cm"> * the assembly device/vendor IDs.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_device_id</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">did</span><span class="p">,</span> <span class="n">vid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">asm_did</span><span class="p">,</span> <span class="n">asm_vid</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct rio_switch_ops - Per-switch operations</span>
<span class="cm"> * @vid: RIO vendor ID</span>
<span class="cm"> * @did: RIO device ID</span>
<span class="cm"> * @init_hook: Callback that performs switch device initialization</span>
<span class="cm"> *</span>
<span class="cm"> * Defines the operations that are necessary to initialize/control</span>
<span class="cm"> * a particular RIO switch device.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rio_switch_ops</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">,</span> <span class="n">did</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_enum</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">rio_pw_msg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">comptag</span><span class="p">;</span>	<span class="cm">/* Component Tag CSR */</span>
		<span class="n">u32</span> <span class="n">errdetect</span><span class="p">;</span>	<span class="cm">/* Port N Error Detect CSR */</span>
		<span class="n">u32</span> <span class="n">is_port</span><span class="p">;</span>	<span class="cm">/* Implementation specific + PortID */</span>
		<span class="n">u32</span> <span class="n">ltlerrdet</span><span class="p">;</span>	<span class="cm">/* LTL Error Detect CSR */</span>
		<span class="n">u32</span> <span class="n">padding</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">em</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">raw</span><span class="p">[</span><span class="n">RIO_PW_MSG_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_RAPIDIO_DMA_ENGINE</span>

<span class="cm">/**</span>
<span class="cm"> * enum rio_write_type - RIO write transaction types used in DMA transfers</span>
<span class="cm"> *</span>
<span class="cm"> * Note: RapidIO specification defines write (NWRITE) and</span>
<span class="cm"> * write-with-response (NWRITE_R) data transfer operations.</span>
<span class="cm"> * Existing DMA controllers that service RapidIO may use one of these operations</span>
<span class="cm"> * for entire data transfer or their combination with only the last data packet</span>
<span class="cm"> * requires response.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">rio_write_type</span> <span class="p">{</span>
	<span class="n">RDW_DEFAULT</span><span class="p">,</span>		<span class="cm">/* default method used by DMA driver */</span>
	<span class="n">RDW_ALL_NWRITE</span><span class="p">,</span>		<span class="cm">/* all packets use NWRITE */</span>
	<span class="n">RDW_ALL_NWRITE_R</span><span class="p">,</span>	<span class="cm">/* all packets use NWRITE_R */</span>
	<span class="n">RDW_LAST_NWRITE_R</span><span class="p">,</span>	<span class="cm">/* last packet uses NWRITE_R, others - NWRITE */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rio_dma_ext</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">destid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rio_addr</span><span class="p">;</span>	<span class="cm">/* low 64-bits of 66-bit RapidIO address */</span>
	<span class="n">u8</span>  <span class="n">rio_addr_u</span><span class="p">;</span>  <span class="cm">/* upper 2-bits of 66-bit RapidIO address */</span>
	<span class="k">enum</span> <span class="n">rio_write_type</span> <span class="n">wr_type</span><span class="p">;</span> <span class="cm">/* preferred RIO write operation type */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rio_dma_data</span> <span class="p">{</span>
	<span class="cm">/* Local data (as scatterlist) */</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">sg</span><span class="p">;</span>	<span class="cm">/* I/O scatter list */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">sg_len</span><span class="p">;</span>	<span class="cm">/* size of scatter list */</span>
	<span class="cm">/* Remote device address (flat buffer) */</span>
	<span class="n">u64</span> <span class="n">rio_addr</span><span class="p">;</span>	<span class="cm">/* low 64-bits of 66-bit RapidIO address */</span>
	<span class="n">u8</span>  <span class="n">rio_addr_u</span><span class="p">;</span>  <span class="cm">/* upper 2-bits of 66-bit RapidIO address */</span>
	<span class="k">enum</span> <span class="n">rio_write_type</span> <span class="n">wr_type</span><span class="p">;</span> <span class="cm">/* preferred RIO write operation type */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="nf">dma_to_mport</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">ddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_mport</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_RAPIDIO_DMA_ENGINE */</span><span class="cp"></span>

<span class="cm">/* Architecture and hardware-specific functions */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rio_register_mport</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rio_open_inb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rio_close_inb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rio_open_outb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rio_close_outb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cp">#endif				</span><span class="cm">/* LINUX_RIO_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
