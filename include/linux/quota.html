<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › quota.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>quota.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1982, 1986 Regents of the University of California.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This code is derived from software contributed to Berkeley by</span>
<span class="cm"> * Robert Elz at The University of Melbourne.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * 3. Neither the name of the University nor the names of its contributors</span>
<span class="cm"> *    may be used to endorse or promote products derived from this software</span>
<span class="cm"> *    without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="cm"> * SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _LINUX_QUOTA_</span>
<span class="cp">#define _LINUX_QUOTA_</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#define __DQUOT_VERSION__	&quot;dquot_6.5.2&quot;</span>

<span class="cp">#define MAXQUOTAS 2</span>
<span class="cp">#define USRQUOTA  0		</span><span class="cm">/* element used for user quotas */</span><span class="cp"></span>
<span class="cp">#define GRPQUOTA  1		</span><span class="cm">/* element used for group quotas */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Definitions for the default names of the quotas files.</span>
<span class="cm"> */</span>
<span class="cp">#define INITQFNAMES { \</span>
<span class="cp">	&quot;user&quot;,    </span><span class="cm">/* USRQUOTA */</span><span class="cp"> \</span>
<span class="cp">	&quot;group&quot;,   </span><span class="cm">/* GRPQUOTA */</span><span class="cp"> \</span>
<span class="cp">	&quot;undefined&quot;, \</span>
<span class="cp">};</span>

<span class="cm">/*</span>
<span class="cm"> * Command definitions for the &#39;quotactl&#39; system call.</span>
<span class="cm"> * The commands are broken into a main command defined below</span>
<span class="cm"> * and a subcommand that is used to convey the type of</span>
<span class="cm"> * quota that is being manipulated (see above).</span>
<span class="cm"> */</span>
<span class="cp">#define SUBCMDMASK  0x00ff</span>
<span class="cp">#define SUBCMDSHIFT 8</span>
<span class="cp">#define QCMD(cmd, type)  (((cmd) &lt;&lt; SUBCMDSHIFT) | ((type) &amp; SUBCMDMASK))</span>

<span class="cp">#define Q_SYNC     0x800001	</span><span class="cm">/* sync disk copy of a filesystems quotas */</span><span class="cp"></span>
<span class="cp">#define Q_QUOTAON  0x800002	</span><span class="cm">/* turn quotas on */</span><span class="cp"></span>
<span class="cp">#define Q_QUOTAOFF 0x800003	</span><span class="cm">/* turn quotas off */</span><span class="cp"></span>
<span class="cp">#define Q_GETFMT   0x800004	</span><span class="cm">/* get quota format used on given filesystem */</span><span class="cp"></span>
<span class="cp">#define Q_GETINFO  0x800005	</span><span class="cm">/* get information about quota files */</span><span class="cp"></span>
<span class="cp">#define Q_SETINFO  0x800006	</span><span class="cm">/* set information about quota files */</span><span class="cp"></span>
<span class="cp">#define Q_GETQUOTA 0x800007	</span><span class="cm">/* get user quota structure */</span><span class="cp"></span>
<span class="cp">#define Q_SETQUOTA 0x800008	</span><span class="cm">/* set user quota structure */</span><span class="cp"></span>

<span class="cm">/* Quota format type IDs */</span>
<span class="cp">#define	QFMT_VFS_OLD 1</span>
<span class="cp">#define	QFMT_VFS_V0 2</span>
<span class="cp">#define QFMT_OCFS2 3</span>
<span class="cp">#define	QFMT_VFS_V1 4</span>

<span class="cm">/* Size of block in which space limits are passed through the quota</span>
<span class="cm"> * interface */</span>
<span class="cp">#define QIF_DQBLKSIZE_BITS 10</span>
<span class="cp">#define QIF_DQBLKSIZE (1 &lt;&lt; QIF_DQBLKSIZE_BITS)</span>

<span class="cm">/*</span>
<span class="cm"> * Quota structure used for communication with userspace via quotactl</span>
<span class="cm"> * Following flags are used to specify which fields are valid</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">QIF_BLIMITS_B</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">QIF_SPACE_B</span><span class="p">,</span>
	<span class="n">QIF_ILIMITS_B</span><span class="p">,</span>
	<span class="n">QIF_INODES_B</span><span class="p">,</span>
	<span class="n">QIF_BTIME_B</span><span class="p">,</span>
	<span class="n">QIF_ITIME_B</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define QIF_BLIMITS	(1 &lt;&lt; QIF_BLIMITS_B)</span>
<span class="cp">#define QIF_SPACE	(1 &lt;&lt; QIF_SPACE_B)</span>
<span class="cp">#define QIF_ILIMITS	(1 &lt;&lt; QIF_ILIMITS_B)</span>
<span class="cp">#define QIF_INODES	(1 &lt;&lt; QIF_INODES_B)</span>
<span class="cp">#define QIF_BTIME	(1 &lt;&lt; QIF_BTIME_B)</span>
<span class="cp">#define QIF_ITIME	(1 &lt;&lt; QIF_ITIME_B)</span>
<span class="cp">#define QIF_LIMITS	(QIF_BLIMITS | QIF_ILIMITS)</span>
<span class="cp">#define QIF_USAGE	(QIF_SPACE | QIF_INODES)</span>
<span class="cp">#define QIF_TIMES	(QIF_BTIME | QIF_ITIME)</span>
<span class="cp">#define QIF_ALL		(QIF_LIMITS | QIF_USAGE | QIF_TIMES)</span>

<span class="k">struct</span> <span class="n">if_dqblk</span> <span class="p">{</span>
	<span class="n">__u64</span> <span class="n">dqb_bhardlimit</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dqb_bsoftlimit</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dqb_curspace</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dqb_ihardlimit</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dqb_isoftlimit</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dqb_curinodes</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dqb_btime</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dqb_itime</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">dqb_valid</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Structure used for setting quota information about file via quotactl</span>
<span class="cm"> * Following flags are used to specify which fields are valid</span>
<span class="cm"> */</span>
<span class="cp">#define IIF_BGRACE	1</span>
<span class="cp">#define IIF_IGRACE	2</span>
<span class="cp">#define IIF_FLAGS	4</span>
<span class="cp">#define IIF_ALL		(IIF_BGRACE | IIF_IGRACE | IIF_FLAGS)</span>

<span class="k">struct</span> <span class="n">if_dqinfo</span> <span class="p">{</span>
	<span class="n">__u64</span> <span class="n">dqi_bgrace</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">dqi_igrace</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">dqi_flags</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">dqi_valid</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Definitions for quota netlink interface</span>
<span class="cm"> */</span>
<span class="cp">#define QUOTA_NL_NOWARN 0</span>
<span class="cp">#define QUOTA_NL_IHARDWARN 1		</span><span class="cm">/* Inode hardlimit reached */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_ISOFTLONGWARN 2 	</span><span class="cm">/* Inode grace time expired */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_ISOFTWARN 3		</span><span class="cm">/* Inode softlimit reached */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_BHARDWARN 4		</span><span class="cm">/* Block hardlimit reached */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_BSOFTLONGWARN 5	</span><span class="cm">/* Block grace time expired */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_BSOFTWARN 6		</span><span class="cm">/* Block softlimit reached */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_IHARDBELOW 7		</span><span class="cm">/* Usage got below inode hardlimit */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_ISOFTBELOW 8		</span><span class="cm">/* Usage got below inode softlimit */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_BHARDBELOW 9		</span><span class="cm">/* Usage got below block hardlimit */</span><span class="cp"></span>
<span class="cp">#define QUOTA_NL_BSOFTBELOW 10		</span><span class="cm">/* Usage got below block softlimit */</span><span class="cp"></span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">QUOTA_NL_C_UNSPEC</span><span class="p">,</span>
	<span class="n">QUOTA_NL_C_WARNING</span><span class="p">,</span>
	<span class="n">__QUOTA_NL_C_MAX</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define QUOTA_NL_C_MAX (__QUOTA_NL_C_MAX - 1)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">QUOTA_NL_A_UNSPEC</span><span class="p">,</span>
	<span class="n">QUOTA_NL_A_QTYPE</span><span class="p">,</span>
	<span class="n">QUOTA_NL_A_EXCESS_ID</span><span class="p">,</span>
	<span class="n">QUOTA_NL_A_WARNING</span><span class="p">,</span>
	<span class="n">QUOTA_NL_A_DEV_MAJOR</span><span class="p">,</span>
	<span class="n">QUOTA_NL_A_DEV_MINOR</span><span class="p">,</span>
	<span class="n">QUOTA_NL_A_CAUSED_ID</span><span class="p">,</span>
	<span class="n">__QUOTA_NL_A_MAX</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define QUOTA_NL_A_MAX (__QUOTA_NL_A_MAX - 1)</span>


<span class="cp">#ifdef __KERNEL__</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/rwsem.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/percpu_counter.h&gt;</span>

<span class="cp">#include &lt;linux/dqblk_xfs.h&gt;</span>
<span class="cp">#include &lt;linux/dqblk_v1.h&gt;</span>
<span class="cp">#include &lt;linux/dqblk_v2.h&gt;</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="k">typedef</span> <span class="n">__kernel_uid32_t</span> <span class="n">qid_t</span><span class="p">;</span> <span class="cm">/* Type in which we store ids in memory */</span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">qsize_t</span><span class="p">;</span>	<span class="cm">/* Type in which we store sizes */</span>

<span class="k">extern</span> <span class="n">spinlock_t</span> <span class="n">dq_data_lock</span><span class="p">;</span>

<span class="cm">/* Maximal numbers of writes for quota operation (insert/delete/update)</span>
<span class="cm"> * (over VFS all formats) */</span>
<span class="cp">#define DQUOT_INIT_ALLOC max(V1_INIT_ALLOC, V2_INIT_ALLOC)</span>
<span class="cp">#define DQUOT_INIT_REWRITE max(V1_INIT_REWRITE, V2_INIT_REWRITE)</span>
<span class="cp">#define DQUOT_DEL_ALLOC max(V1_DEL_ALLOC, V2_DEL_ALLOC)</span>
<span class="cp">#define DQUOT_DEL_REWRITE max(V1_DEL_REWRITE, V2_DEL_REWRITE)</span>

<span class="cm">/*</span>
<span class="cm"> * Data for one user/group kept in memory</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mem_dqblk</span> <span class="p">{</span>
	<span class="n">qsize_t</span> <span class="n">dqb_bhardlimit</span><span class="p">;</span>	<span class="cm">/* absolute limit on disk blks alloc */</span>
	<span class="n">qsize_t</span> <span class="n">dqb_bsoftlimit</span><span class="p">;</span>	<span class="cm">/* preferred limit on disk blks */</span>
	<span class="n">qsize_t</span> <span class="n">dqb_curspace</span><span class="p">;</span>	<span class="cm">/* current used space */</span>
	<span class="n">qsize_t</span> <span class="n">dqb_rsvspace</span><span class="p">;</span>   <span class="cm">/* current reserved space for delalloc*/</span>
	<span class="n">qsize_t</span> <span class="n">dqb_ihardlimit</span><span class="p">;</span>	<span class="cm">/* absolute limit on allocated inodes */</span>
	<span class="n">qsize_t</span> <span class="n">dqb_isoftlimit</span><span class="p">;</span>	<span class="cm">/* preferred inode limit */</span>
	<span class="n">qsize_t</span> <span class="n">dqb_curinodes</span><span class="p">;</span>	<span class="cm">/* current # allocated inodes */</span>
	<span class="kt">time_t</span> <span class="n">dqb_btime</span><span class="p">;</span>	<span class="cm">/* time limit for excessive disk use */</span>
	<span class="kt">time_t</span> <span class="n">dqb_itime</span><span class="p">;</span>	<span class="cm">/* time limit for excessive inode use */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Data for one quotafile kept in memory</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">quota_format_type</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">mem_dqinfo</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">dqi_format</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dqi_fmt_id</span><span class="p">;</span>		<span class="cm">/* Id of the dqi_format - used when turning</span>
<span class="cm">				 * quotas on after remount RW */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dqi_dirty_list</span><span class="p">;</span>	<span class="cm">/* List of dirty dquots */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dqi_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dqi_bgrace</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dqi_igrace</span><span class="p">;</span>
	<span class="n">qsize_t</span> <span class="n">dqi_maxblimit</span><span class="p">;</span>
	<span class="n">qsize_t</span> <span class="n">dqi_maxilimit</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dqi_priv</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">super_block</span><span class="p">;</span>

<span class="cp">#define DQF_MASK 0xffff		</span><span class="cm">/* Mask for format specific flags */</span><span class="cp"></span>
<span class="cp">#define DQF_GETINFO_MASK 0x1ffff	</span><span class="cm">/* Mask for flags passed to userspace */</span><span class="cp"></span>
<span class="cp">#define DQF_SETINFO_MASK 0xffff		</span><span class="cm">/* Mask for flags modifiable from userspace */</span><span class="cp"></span>
<span class="cp">#define DQF_SYS_FILE_B		16</span>
<span class="cp">#define DQF_SYS_FILE (1 &lt;&lt; DQF_SYS_FILE_B)	</span><span class="cm">/* Quota file stored as system file */</span><span class="cp"></span>
<span class="cp">#define DQF_INFO_DIRTY_B	31</span>
<span class="cp">#define DQF_INFO_DIRTY (1 &lt;&lt; DQF_INFO_DIRTY_B)	</span><span class="cm">/* Is info dirty? */</span><span class="cp"></span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">mark_info_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">info_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_dqinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DQF_INFO_DIRTY_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dqi_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">DQST_LOOKUPS</span><span class="p">,</span>
	<span class="n">DQST_DROPS</span><span class="p">,</span>
	<span class="n">DQST_READS</span><span class="p">,</span>
	<span class="n">DQST_WRITES</span><span class="p">,</span>
	<span class="n">DQST_CACHE_HITS</span><span class="p">,</span>
	<span class="n">DQST_ALLOC_DQUOTS</span><span class="p">,</span>
	<span class="n">DQST_FREE_DQUOTS</span><span class="p">,</span>
	<span class="n">DQST_SYNCS</span><span class="p">,</span>
	<span class="n">_DQST_DQSTAT_LAST</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dqstats</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">[</span><span class="n">_DQST_DQSTAT_LAST</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">percpu_counter</span> <span class="n">counter</span><span class="p">[</span><span class="n">_DQST_DQSTAT_LAST</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">dqstats</span> <span class="o">*</span><span class="n">dqstats_pcpu</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">dqstats</span> <span class="n">dqstats</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dqstats_inc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">percpu_counter_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">counter</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dqstats_dec</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">percpu_counter_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqstats</span><span class="p">.</span><span class="n">counter</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#define DQ_MOD_B	0	</span><span class="cm">/* dquot modified since read */</span><span class="cp"></span>
<span class="cp">#define DQ_BLKS_B	1	</span><span class="cm">/* uid/gid has been warned about blk limit */</span><span class="cp"></span>
<span class="cp">#define DQ_INODES_B	2	</span><span class="cm">/* uid/gid has been warned about inode limit */</span><span class="cp"></span>
<span class="cp">#define DQ_FAKE_B	3	</span><span class="cm">/* no limits only usage */</span><span class="cp"></span>
<span class="cp">#define DQ_READ_B	4	</span><span class="cm">/* dquot was read into memory */</span><span class="cp"></span>
<span class="cp">#define DQ_ACTIVE_B	5	</span><span class="cm">/* dquot is active (dquot_release not called) */</span><span class="cp"></span>
<span class="cp">#define DQ_LASTSET_B	6	</span><span class="cm">/* Following 6 bits (see QIF_) are reserved\</span>
<span class="cm">				 * for the mask of entries set via SETQUOTA\</span>
<span class="cm">				 * quotactl. They are set under dq_data_lock\</span>
<span class="cm">				 * and the quota format handling dquot can\</span>
<span class="cm">				 * clear them when it sees fit. */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">dquot</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">dq_hash</span><span class="p">;</span>	<span class="cm">/* Hash list in memory */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dq_inuse</span><span class="p">;</span>	<span class="cm">/* List of all quotas */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dq_free</span><span class="p">;</span>	<span class="cm">/* Free list element */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dq_dirty</span><span class="p">;</span>	<span class="cm">/* List of dirty dquots */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">dq_lock</span><span class="p">;</span>		<span class="cm">/* dquot IO lock */</span>
	<span class="n">atomic_t</span> <span class="n">dq_count</span><span class="p">;</span>		<span class="cm">/* Use count */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">dq_wait_unused</span><span class="p">;</span>	<span class="cm">/* Wait queue for dquot to become unused */</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">dq_sb</span><span class="p">;</span>	<span class="cm">/* superblock this applies to */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dq_id</span><span class="p">;</span>		<span class="cm">/* ID this applies to (uid, gid) */</span>
	<span class="n">loff_t</span> <span class="n">dq_off</span><span class="p">;</span>			<span class="cm">/* Offset of dquot on disk */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dq_flags</span><span class="p">;</span>		<span class="cm">/* See DQ_* */</span>
	<span class="kt">short</span> <span class="n">dq_type</span><span class="p">;</span>			<span class="cm">/* Type of quota */</span>
	<span class="k">struct</span> <span class="n">mem_dqblk</span> <span class="n">dq_dqb</span><span class="p">;</span>	<span class="cm">/* Diskquota usage */</span>
<span class="p">};</span>

<span class="cm">/* Operations which must be implemented by each quota format */</span>
<span class="k">struct</span> <span class="n">quota_format_ops</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">check_quota_file</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>	<span class="cm">/* Detect whether file is in our format */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_file_info</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>	<span class="cm">/* Read main info about file - called on quotaon() */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write_file_info</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>	<span class="cm">/* Write main info about file */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">free_file_info</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>	<span class="cm">/* Called on quotaoff() */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_dqblk</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>		<span class="cm">/* Read structure for one user */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">commit_dqblk</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>	<span class="cm">/* Write structure for one user */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">release_dqblk</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>	<span class="cm">/* Called when last reference to dquot is being dropped */</span>
<span class="p">};</span>

<span class="cm">/* Operations working with dquots */</span>
<span class="k">struct</span> <span class="n">dquot_operations</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write_dquot</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>		<span class="cm">/* Ordinary dquot write */</span>
	<span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc_dquot</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>	<span class="cm">/* Allocate memory for new dquot */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">destroy_dquot</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>		<span class="cm">/* Free memory for dquot */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">acquire_dquot</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>		<span class="cm">/* Quota is going to be created on disk */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">release_dquot</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>		<span class="cm">/* Quota is going to be deleted from disk */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">mark_dirty</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>		<span class="cm">/* Dquot is marked dirty */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write_info</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>	<span class="cm">/* Write of quota &quot;superblock&quot; */</span>
	<span class="cm">/* get reserved quota for delayed alloc, value returned is managed by</span>
<span class="cm">	 * quota code only */</span>
	<span class="n">qsize_t</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_reserved_space</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">path</span><span class="p">;</span>

<span class="cm">/* Operations handling requests from userspace */</span>
<span class="k">struct</span> <span class="n">quotactl_ops</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">quota_on</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">quota_on_meta</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">quota_off</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">quota_sync</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_info</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">if_dqinfo</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_info</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">if_dqinfo</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_dqblk</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">qid_t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_dqblk</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">qid_t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fs_disk_quota</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_xstate</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fs_quota_stat</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_xstate</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">quota_format_type</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">qf_fmt_id</span><span class="p">;</span>	<span class="cm">/* Quota format id */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">quota_format_ops</span> <span class="o">*</span><span class="n">qf_ops</span><span class="p">;</span>	<span class="cm">/* Operations of format */</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">qf_owner</span><span class="p">;</span>		<span class="cm">/* Module implementing quota format */</span>
	<span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">qf_next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Quota state flags - they actually come in two flavors - for users and groups */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">_DQUOT_USAGE_ENABLED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* Track disk usage for users */</span>
	<span class="n">_DQUOT_LIMITS_ENABLED</span><span class="p">,</span>			<span class="cm">/* Enforce quota limits for users */</span>
	<span class="n">_DQUOT_SUSPENDED</span><span class="p">,</span>			<span class="cm">/* User diskquotas are off, but</span>
<span class="cm">						 * we have necessary info in</span>
<span class="cm">						 * memory to turn them on */</span>
	<span class="n">_DQUOT_STATE_FLAGS</span>
<span class="p">};</span>
<span class="cp">#define DQUOT_USAGE_ENABLED	(1 &lt;&lt; _DQUOT_USAGE_ENABLED)</span>
<span class="cp">#define DQUOT_LIMITS_ENABLED	(1 &lt;&lt; _DQUOT_LIMITS_ENABLED)</span>
<span class="cp">#define DQUOT_SUSPENDED		(1 &lt;&lt; _DQUOT_SUSPENDED)</span>
<span class="cp">#define DQUOT_STATE_FLAGS	(DQUOT_USAGE_ENABLED | DQUOT_LIMITS_ENABLED | \</span>
<span class="cp">				 DQUOT_SUSPENDED)</span>
<span class="cm">/* Other quota flags */</span>
<span class="cp">#define DQUOT_STATE_LAST	(_DQUOT_STATE_FLAGS * MAXQUOTAS)</span>
<span class="cp">#define DQUOT_QUOTA_SYS_FILE	(1 &lt;&lt; DQUOT_STATE_LAST)</span>
						<span class="cm">/* Quota file is a special</span>
<span class="cm">						 * system file and user cannot</span>
<span class="cm">						 * touch it. Filesystem is</span>
<span class="cm">						 * responsible for setting</span>
<span class="cm">						 * S_NOQUOTA, S_NOATIME flags</span>
<span class="cm">						 */</span>
<span class="cp">#define DQUOT_NEGATIVE_USAGE	(1 &lt;&lt; (DQUOT_STATE_LAST + 1))</span>
					       <span class="cm">/* Allow negative quota usage */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dquot_state_flag</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">flags</span> <span class="o">&lt;&lt;</span> <span class="n">_DQUOT_STATE_FLAGS</span> <span class="o">*</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dquot_generic_flag</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&gt;&gt;</span> <span class="n">_DQUOT_STATE_FLAGS</span> <span class="o">*</span> <span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DQUOT_STATE_FLAGS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA_NETLINK_INTERFACE</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">quota_send_warning</span><span class="p">(</span><span class="kt">short</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="n">warntype</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">quota_send_warning</span><span class="p">(</span><span class="kt">short</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="n">warntype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_QUOTA_NETLINK_INTERFACE */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">quota_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>			<span class="cm">/* Flags for diskquotas on this device */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">dqio_mutex</span><span class="p">;</span>		<span class="cm">/* lock device while I/O in progress */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">dqonoff_mutex</span><span class="p">;</span>		<span class="cm">/* Serialize quotaon &amp; quotaoff */</span>
	<span class="k">struct</span> <span class="n">rw_semaphore</span> <span class="n">dqptr_sem</span><span class="p">;</span>		<span class="cm">/* serialize ops using quota_info struct, pointers from inode to dquots */</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">files</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>		<span class="cm">/* inodes of quotafiles */</span>
	<span class="k">struct</span> <span class="n">mem_dqinfo</span> <span class="n">info</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>	<span class="cm">/* Information for each quota type */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">quota_format_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>	<span class="cm">/* Operations for each type */</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">register_quota_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">fmt</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">unregister_quota_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">quota_format_type</span> <span class="o">*</span><span class="n">fmt</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">quota_module_name</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">qm_fmt_id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">qm_mod_name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define INIT_QUOTA_MODULE_NAMES {\</span>
<span class="cp">	{QFMT_VFS_OLD, &quot;quota_v1&quot;},\</span>
<span class="cp">	{QFMT_VFS_V0, &quot;quota_v2&quot;},\</span>
<span class="cp">	{0, NULL}}</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* _QUOTA_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
