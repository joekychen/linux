<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › log2.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>log2.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Integer base 2 logarithm calculation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _LINUX_LOG2_H</span>
<span class="cp">#define _LINUX_LOG2_H</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * deal with unrepresentable constant logarithms</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">__attribute__</span><span class="p">((</span><span class="k">const</span><span class="p">,</span> <span class="n">noreturn</span><span class="p">))</span>
<span class="kt">int</span> <span class="n">____ilog2_NaN</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * non-constant log of base 2 calculators</span>
<span class="cm"> * - the arch may override these in asm/bitops.h if they can be implemented</span>
<span class="cm"> *   more efficiently than using fls() and fls64()</span>
<span class="cm"> * - the arch is not required to handle n==0 if implementing the fallback</span>
<span class="cm"> */</span>
<span class="cp">#ifndef CONFIG_ARCH_HAS_ILOG2_U32</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="k">const</span><span class="p">))</span>
<span class="kt">int</span> <span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fls</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_ARCH_HAS_ILOG2_U64</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="k">const</span><span class="p">))</span>
<span class="kt">int</span> <span class="n">__ilog2_u64</span><span class="p">(</span><span class="n">u64</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fls64</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Determine whether some value is a power of two, where zero is</span>
<span class="cm"> * *not* considered a power of two.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="k">const</span><span class="p">))</span>
<span class="n">bool</span> <span class="n">is_power_of_2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * round up to nearest power of two</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="k">const</span><span class="p">))</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__roundup_pow_of_two</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">fls_long</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * round down to nearest power of two</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="k">const</span><span class="p">))</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__rounddown_pow_of_two</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">fls_long</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ilog2 - log of base 2 of 32-bit or a 64-bit unsigned value</span>
<span class="cm"> * @n - parameter</span>
<span class="cm"> *</span>
<span class="cm"> * constant-capable log of base 2 calculation</span>
<span class="cm"> * - this can be used to initialise global variables from constant data, hence</span>
<span class="cm"> *   the massive ternary operator construction</span>
<span class="cm"> *</span>
<span class="cm"> * selects the appropriately-sized optimised version depending on sizeof(n)</span>
<span class="cm"> */</span>
<span class="cp">#define ilog2(n)				\</span>
<span class="cp">(						\</span>
<span class="cp">	__builtin_constant_p(n) ? (		\</span>
<span class="cp">		(n) &lt; 1 ? ____ilog2_NaN() :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 63) ? 63 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 62) ? 62 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 61) ? 61 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 60) ? 60 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 59) ? 59 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 58) ? 58 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 57) ? 57 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 56) ? 56 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 55) ? 55 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 54) ? 54 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 53) ? 53 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 52) ? 52 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 51) ? 51 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 50) ? 50 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 49) ? 49 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 48) ? 48 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 47) ? 47 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 46) ? 46 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 45) ? 45 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 44) ? 44 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 43) ? 43 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 42) ? 42 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 41) ? 41 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 40) ? 40 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 39) ? 39 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 38) ? 38 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 37) ? 37 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 36) ? 36 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 35) ? 35 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 34) ? 34 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 33) ? 33 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 32) ? 32 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 31) ? 31 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 30) ? 30 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 29) ? 29 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 28) ? 28 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 27) ? 27 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 26) ? 26 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 25) ? 25 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 24) ? 24 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 23) ? 23 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 22) ? 22 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 21) ? 21 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 20) ? 20 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 19) ? 19 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 18) ? 18 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 17) ? 17 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 16) ? 16 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 15) ? 15 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 14) ? 14 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 13) ? 13 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 12) ? 12 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 11) ? 11 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt; 10) ? 10 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  9) ?  9 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  8) ?  8 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  7) ?  7 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  6) ?  6 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  5) ?  5 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  4) ?  4 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  3) ?  3 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  2) ?  2 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  1) ?  1 :	\</span>
<span class="cp">		(n) &amp; (1ULL &lt;&lt;  0) ?  0 :	\</span>
<span class="cp">		____ilog2_NaN()			\</span>
<span class="cp">				   ) :		\</span>
<span class="cp">	(sizeof(n) &lt;= 4) ?			\</span>
<span class="cp">	__ilog2_u32(n) :			\</span>
<span class="cp">	__ilog2_u64(n)				\</span>
<span class="cp"> )</span>

<span class="cm">/**</span>
<span class="cm"> * roundup_pow_of_two - round the given value up to nearest power of two</span>
<span class="cm"> * @n - parameter</span>
<span class="cm"> *</span>
<span class="cm"> * round the given value up to the nearest power of two</span>
<span class="cm"> * - the result is undefined when n == 0</span>
<span class="cm"> * - this can be used to initialise global variables from constant data</span>
<span class="cm"> */</span>
<span class="cp">#define roundup_pow_of_two(n)			\</span>
<span class="cp">(						\</span>
<span class="cp">	__builtin_constant_p(n) ? (		\</span>
<span class="cp">		(n == 1) ? 1 :			\</span>
<span class="cp">		(1UL &lt;&lt; (ilog2((n) - 1) + 1))	\</span>
<span class="cp">				   ) :		\</span>
<span class="cp">	__roundup_pow_of_two(n)			\</span>
<span class="cp"> )</span>

<span class="cm">/**</span>
<span class="cm"> * rounddown_pow_of_two - round the given value down to nearest power of two</span>
<span class="cm"> * @n - parameter</span>
<span class="cm"> *</span>
<span class="cm"> * round the given value down to the nearest power of two</span>
<span class="cm"> * - the result is undefined when n == 0</span>
<span class="cm"> * - this can be used to initialise global variables from constant data</span>
<span class="cm"> */</span>
<span class="cp">#define rounddown_pow_of_two(n)			\</span>
<span class="cp">(						\</span>
<span class="cp">	__builtin_constant_p(n) ? (		\</span>
<span class="cp">		(1UL &lt;&lt; ilog2(n))) :		\</span>
<span class="cp">	__rounddown_pow_of_two(n)		\</span>
<span class="cp"> )</span>

<span class="cm">/**</span>
<span class="cm"> * order_base_2 - calculate the (rounded up) base 2 order of the argument</span>
<span class="cm"> * @n: parameter</span>
<span class="cm"> *</span>
<span class="cm"> * The first few values calculated by this routine:</span>
<span class="cm"> *  ob2(0) = 0</span>
<span class="cm"> *  ob2(1) = 0</span>
<span class="cm"> *  ob2(2) = 1</span>
<span class="cm"> *  ob2(3) = 2</span>
<span class="cm"> *  ob2(4) = 2</span>
<span class="cm"> *  ob2(5) = 3</span>
<span class="cm"> *  ... and so on.</span>
<span class="cm"> */</span>

<span class="cp">#define order_base_2(n) ilog2(roundup_pow_of_two(n))</span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_LOG2_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
