<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › ptp_classify.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ptp_classify.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PTP 1588 support</span>
<span class="cm"> *</span>
<span class="cm"> * This file implements a BPF that recognizes PTP event messages.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 OMICRON electronics GmbH</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _PTP_CLASSIFY_H_</span>
<span class="cp">#define _PTP_CLASSIFY_H_</span>

<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/filter.h&gt;</span>
<span class="cp">#ifdef __KERNEL__</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define PTP_CLASS_NONE  0x00 </span><span class="cm">/* not a PTP event message */</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_V1    0x01 </span><span class="cm">/* protocol version 1 */</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_V2    0x02 </span><span class="cm">/* protocol version 2 */</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_VMASK 0x0f </span><span class="cm">/* max protocol version is 15 */</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_IPV4  0x10 </span><span class="cm">/* event in an IPV4 UDP packet */</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_IPV6  0x20 </span><span class="cm">/* event in an IPV6 UDP packet */</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_L2    0x30 </span><span class="cm">/* event in a L2 packet */</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_VLAN  0x40 </span><span class="cm">/* event in a VLAN tagged L2 packet */</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_PMASK 0xf0 </span><span class="cm">/* mask for the packet type field */</span><span class="cp"></span>

<span class="cp">#define PTP_CLASS_V1_IPV4 (PTP_CLASS_V1 | PTP_CLASS_IPV4)</span>
<span class="cp">#define PTP_CLASS_V1_IPV6 (PTP_CLASS_V1 | PTP_CLASS_IPV6) </span><span class="cm">/*probably DNE*/</span><span class="cp"></span>
<span class="cp">#define PTP_CLASS_V2_IPV4 (PTP_CLASS_V2 | PTP_CLASS_IPV4)</span>
<span class="cp">#define PTP_CLASS_V2_IPV6 (PTP_CLASS_V2 | PTP_CLASS_IPV6)</span>
<span class="cp">#define PTP_CLASS_V2_L2   (PTP_CLASS_V2 | PTP_CLASS_L2)</span>
<span class="cp">#define PTP_CLASS_V2_VLAN (PTP_CLASS_V2 | PTP_CLASS_VLAN)</span>

<span class="cp">#define PTP_EV_PORT 319</span>
<span class="cp">#define PTP_GEN_BIT 0x08 </span><span class="cm">/* indicates general message, if set in message type */</span><span class="cp"></span>

<span class="cp">#define OFF_ETYPE	12</span>
<span class="cp">#define OFF_IHL		14</span>
<span class="cp">#define OFF_FRAG	20</span>
<span class="cp">#define OFF_PROTO4	23</span>
<span class="cp">#define OFF_NEXT	6</span>
<span class="cp">#define OFF_UDP_DST	2</span>

<span class="cp">#define OFF_PTP_SOURCE_UUID	22 </span><span class="cm">/* PTPv1 only */</span><span class="cp"></span>
<span class="cp">#define OFF_PTP_SEQUENCE_ID	30</span>
<span class="cp">#define OFF_PTP_CONTROL		32 </span><span class="cm">/* PTPv1 only */</span><span class="cp"></span>

<span class="cp">#define IPV4_HLEN(data) (((struct iphdr *)(data + OFF_IHL))-&gt;ihl &lt;&lt; 2)</span>

<span class="cp">#define IP6_HLEN	40</span>
<span class="cp">#define UDP_HLEN	8</span>

<span class="cp">#define RELOFF_DST4	(ETH_HLEN + OFF_UDP_DST)</span>
<span class="cp">#define OFF_DST6	(ETH_HLEN + IP6_HLEN + OFF_UDP_DST)</span>
<span class="cp">#define OFF_PTP6	(ETH_HLEN + IP6_HLEN + UDP_HLEN)</span>

<span class="cp">#define OP_AND	(BPF_ALU | BPF_AND  | BPF_K)</span>
<span class="cp">#define OP_JEQ	(BPF_JMP | BPF_JEQ  | BPF_K)</span>
<span class="cp">#define OP_JSET	(BPF_JMP | BPF_JSET | BPF_K)</span>
<span class="cp">#define OP_LDB	(BPF_LD  | BPF_B    | BPF_ABS)</span>
<span class="cp">#define OP_LDH	(BPF_LD  | BPF_H    | BPF_ABS)</span>
<span class="cp">#define OP_LDHI	(BPF_LD  | BPF_H    | BPF_IND)</span>
<span class="cp">#define OP_LDX	(BPF_LDX | BPF_B    | BPF_MSH)</span>
<span class="cp">#define OP_OR	(BPF_ALU | BPF_OR   | BPF_K)</span>
<span class="cp">#define OP_RETA	(BPF_RET | BPF_A)</span>
<span class="cp">#define OP_RETK	(BPF_RET | BPF_K)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ptp_filter_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock_filter</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OP_LDH</span> <span class="o">==</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sk_chk_filter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PTP_FILTER \</span>
<span class="cp">	{OP_LDH,	0,   0, OFF_ETYPE		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JEQ,	0,  12, ETH_P_IP		}, </span><span class="cm">/* f goto L20   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDB,	0,   0, OFF_PROTO4		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JEQ,	0,   9, IPPROTO_UDP		}, </span><span class="cm">/* f goto L10   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDH,	0,   0, OFF_FRAG		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JSET,	7,   0, 0x1fff			}, </span><span class="cm">/* t goto L11   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDX,	0,   0, OFF_IHL			}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDHI,	0,   0, RELOFF_DST4		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JEQ,	0,   4, PTP_EV_PORT		}, </span><span class="cm">/* f goto L12   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDHI,	0,   0, ETH_HLEN + UDP_HLEN	}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_AND,	0,   0, PTP_CLASS_VMASK		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_OR,		0,   0, PTP_CLASS_IPV4		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_RETA,	0,   0, 0			}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cm">/*L1x*/</span><span class="cp">	{OP_RETK,	0,   0, PTP_CLASS_NONE		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cm">/*L20*/</span><span class="cp">	{OP_JEQ,	0,   9, ETH_P_IPV6		}, </span><span class="cm">/* f goto L40   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDB,	0,   0, ETH_HLEN + OFF_NEXT	}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JEQ,	0,   6, IPPROTO_UDP		}, </span><span class="cm">/* f goto L30   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDH,	0,   0, OFF_DST6		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JEQ,	0,   4, PTP_EV_PORT		}, </span><span class="cm">/* f goto L31   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDH,	0,   0, OFF_PTP6		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_AND,	0,   0, PTP_CLASS_VMASK		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_OR,		0,   0, PTP_CLASS_IPV6		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_RETA,	0,   0, 0			}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cm">/*L3x*/</span><span class="cp">	{OP_RETK,	0,   0, PTP_CLASS_NONE		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cm">/*L40*/</span><span class="cp">	{OP_JEQ,	0,   9, ETH_P_8021Q		}, </span><span class="cm">/* f goto L50   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDH,	0,   0, OFF_ETYPE + 4		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JEQ,	0,  15, ETH_P_1588		}, </span><span class="cm">/* f goto L60   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDB,	0,   0, ETH_HLEN + VLAN_HLEN	}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_AND,	0,   0, PTP_GEN_BIT		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JEQ,	0,  12, 0			}, </span><span class="cm">/* f goto L6x   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDH,	0,   0, ETH_HLEN + VLAN_HLEN	}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_AND,	0,   0, PTP_CLASS_VMASK		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_OR,		0,   0, PTP_CLASS_VLAN		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_RETA,	0,   0, 0			}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cm">/*L50*/</span><span class="cp">	{OP_JEQ,	0,   7, ETH_P_1588		}, </span><span class="cm">/* f goto L61   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDB,	0,   0, ETH_HLEN		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_AND,	0,   0, PTP_GEN_BIT		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_JEQ,	0,   4, 0			}, </span><span class="cm">/* f goto L6x   */</span><span class="cp"> \</span>
<span class="cp">	{OP_LDH,	0,   0, ETH_HLEN		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_AND,	0,   0, PTP_CLASS_VMASK		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_OR,		0,   0, PTP_CLASS_L2		}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cp">	{OP_RETA,	0,   0, 0			}, </span><span class="cm">/*              */</span><span class="cp"> \</span>
<span class="cm">/*L6x*/</span><span class="cp">	{OP_RETK,	0,   0, PTP_CLASS_NONE		},</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
