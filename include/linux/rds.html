<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › rds.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rds.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008 Oracle.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * OpenIB.org BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> *     Redistribution and use in source and binary forms, with or</span>
<span class="cm"> *     without modification, are permitted provided that the following</span>
<span class="cm"> *     conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions of source code must retain the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> *      - Redistributions in binary form must reproduce the above</span>
<span class="cm"> *        copyright notice, this list of conditions and the following</span>
<span class="cm"> *        disclaimer in the documentation and/or other materials</span>
<span class="cm"> *        provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _LINUX_RDS_H</span>
<span class="cp">#define _LINUX_RDS_H</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#define RDS_IB_ABI_VERSION		0x301</span>

<span class="cm">/*</span>
<span class="cm"> * setsockopt/getsockopt for SOL_RDS</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_CANCEL_SENT_TO      	1</span>
<span class="cp">#define RDS_GET_MR			2</span>
<span class="cp">#define RDS_FREE_MR			3</span>
<span class="cm">/* deprecated: RDS_BARRIER 4 */</span>
<span class="cp">#define RDS_RECVERR			5</span>
<span class="cp">#define RDS_CONG_MONITOR		6</span>
<span class="cp">#define RDS_GET_MR_FOR_DEST		7</span>

<span class="cm">/*</span>
<span class="cm"> * Control message types for SOL_RDS.</span>
<span class="cm"> *</span>
<span class="cm"> * CMSG_RDMA_ARGS (sendmsg)</span>
<span class="cm"> *	Request a RDMA transfer to/from the specified</span>
<span class="cm"> *	memory ranges.</span>
<span class="cm"> *	The cmsg_data is a struct rds_rdma_args.</span>
<span class="cm"> * RDS_CMSG_RDMA_DEST (recvmsg, sendmsg)</span>
<span class="cm"> *	Kernel informs application about intended</span>
<span class="cm"> *	source/destination of a RDMA transfer</span>
<span class="cm"> * RDS_CMSG_RDMA_MAP (sendmsg)</span>
<span class="cm"> *	Application asks kernel to map the given</span>
<span class="cm"> *	memory range into a IB MR, and send the</span>
<span class="cm"> *	R_Key along in an RDS extension header.</span>
<span class="cm"> *	The cmsg_data is a struct rds_get_mr_args,</span>
<span class="cm"> *	the same as for the GET_MR setsockopt.</span>
<span class="cm"> * RDS_CMSG_RDMA_STATUS (recvmsg)</span>
<span class="cm"> *	Returns the status of a completed RDMA operation.</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_CMSG_RDMA_ARGS		1</span>
<span class="cp">#define RDS_CMSG_RDMA_DEST		2</span>
<span class="cp">#define RDS_CMSG_RDMA_MAP		3</span>
<span class="cp">#define RDS_CMSG_RDMA_STATUS		4</span>
<span class="cp">#define RDS_CMSG_CONG_UPDATE		5</span>
<span class="cp">#define RDS_CMSG_ATOMIC_FADD		6</span>
<span class="cp">#define RDS_CMSG_ATOMIC_CSWP		7</span>
<span class="cp">#define RDS_CMSG_MASKED_ATOMIC_FADD	8</span>
<span class="cp">#define RDS_CMSG_MASKED_ATOMIC_CSWP	9</span>

<span class="cp">#define RDS_INFO_FIRST			10000</span>
<span class="cp">#define RDS_INFO_COUNTERS		10000</span>
<span class="cp">#define RDS_INFO_CONNECTIONS		10001</span>
<span class="cm">/* 10002 aka RDS_INFO_FLOWS is deprecated */</span>
<span class="cp">#define RDS_INFO_SEND_MESSAGES		10003</span>
<span class="cp">#define RDS_INFO_RETRANS_MESSAGES       10004</span>
<span class="cp">#define RDS_INFO_RECV_MESSAGES          10005</span>
<span class="cp">#define RDS_INFO_SOCKETS                10006</span>
<span class="cp">#define RDS_INFO_TCP_SOCKETS            10007</span>
<span class="cp">#define RDS_INFO_IB_CONNECTIONS		10008</span>
<span class="cp">#define RDS_INFO_CONNECTION_STATS	10009</span>
<span class="cp">#define RDS_INFO_IWARP_CONNECTIONS	10010</span>
<span class="cp">#define RDS_INFO_LAST			10010</span>

<span class="k">struct</span> <span class="n">rds_info_counter</span> <span class="p">{</span>
	<span class="kt">uint8_t</span>	<span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">uint64_t</span>	<span class="n">value</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define RDS_INFO_CONNECTION_FLAG_SENDING	0x01</span>
<span class="cp">#define RDS_INFO_CONNECTION_FLAG_CONNECTING	0x02</span>
<span class="cp">#define RDS_INFO_CONNECTION_FLAG_CONNECTED	0x04</span>

<span class="cp">#define TRANSNAMSIZ	16</span>

<span class="k">struct</span> <span class="n">rds_info_connection</span> <span class="p">{</span>
	<span class="kt">uint64_t</span>	<span class="n">next_tx_seq</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">next_rx_seq</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">laddr</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">faddr</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="n">transport</span><span class="p">[</span><span class="n">TRANSNAMSIZ</span><span class="p">];</span>		<span class="cm">/* null term ascii */</span>
	<span class="kt">uint8_t</span>	<span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define RDS_INFO_MESSAGE_FLAG_ACK               0x01</span>
<span class="cp">#define RDS_INFO_MESSAGE_FLAG_FAST_ACK          0x02</span>

<span class="k">struct</span> <span class="n">rds_info_message</span> <span class="p">{</span>
	<span class="kt">uint64_t</span>	<span class="n">seq</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">len</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">laddr</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">faddr</span><span class="p">;</span>
	<span class="n">__be16</span>		<span class="n">lport</span><span class="p">;</span>
	<span class="n">__be16</span>		<span class="n">fport</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">rds_info_socket</span> <span class="p">{</span>
	<span class="kt">uint32_t</span>	<span class="n">sndbuf</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">bound_addr</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">connected_addr</span><span class="p">;</span>
	<span class="n">__be16</span>		<span class="n">bound_port</span><span class="p">;</span>
	<span class="n">__be16</span>		<span class="n">connected_port</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">rcvbuf</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">inum</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">rds_info_tcp_socket</span> <span class="p">{</span>
	<span class="n">__be32</span>          <span class="n">local_addr</span><span class="p">;</span>
	<span class="n">__be16</span>          <span class="n">local_port</span><span class="p">;</span>
	<span class="n">__be32</span>          <span class="n">peer_addr</span><span class="p">;</span>
	<span class="n">__be16</span>          <span class="n">peer_port</span><span class="p">;</span>
	<span class="kt">uint64_t</span>       <span class="n">hdr_rem</span><span class="p">;</span>
	<span class="kt">uint64_t</span>       <span class="n">data_rem</span><span class="p">;</span>
	<span class="kt">uint32_t</span>       <span class="n">last_sent_nxt</span><span class="p">;</span>
	<span class="kt">uint32_t</span>       <span class="n">last_expected_una</span><span class="p">;</span>
	<span class="kt">uint32_t</span>       <span class="n">last_seen_una</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define RDS_IB_GID_LEN	16</span>
<span class="k">struct</span> <span class="n">rds_info_rdma_connection</span> <span class="p">{</span>
	<span class="n">__be32</span>		<span class="n">src_addr</span><span class="p">;</span>
	<span class="n">__be32</span>		<span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">src_gid</span><span class="p">[</span><span class="n">RDS_IB_GID_LEN</span><span class="p">];</span>
	<span class="kt">uint8_t</span>		<span class="n">dst_gid</span><span class="p">[</span><span class="n">RDS_IB_GID_LEN</span><span class="p">];</span>

	<span class="kt">uint32_t</span>	<span class="n">max_send_wr</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">max_recv_wr</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">max_send_sge</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">rdma_mr_max</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">rdma_mr_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Congestion monitoring.</span>
<span class="cm"> * Congestion control in RDS happens at the host connection</span>
<span class="cm"> * level by exchanging a bitmap marking congested ports.</span>
<span class="cm"> * By default, a process sleeping in poll() is always woken</span>
<span class="cm"> * up when the congestion map is updated.</span>
<span class="cm"> * With explicit monitoring, an application can have more</span>
<span class="cm"> * fine-grained control.</span>
<span class="cm"> * The application installs a 64bit mask value in the socket,</span>
<span class="cm"> * where each bit corresponds to a group of ports.</span>
<span class="cm"> * When a congestion update arrives, RDS checks the set of</span>
<span class="cm"> * ports that are now uncongested against the list bit mask</span>
<span class="cm"> * installed in the socket, and if they overlap, we queue a</span>
<span class="cm"> * cong_notification on the socket.</span>
<span class="cm"> *</span>
<span class="cm"> * To install the congestion monitor bitmask, use RDS_CONG_MONITOR</span>
<span class="cm"> * with the 64bit mask.</span>
<span class="cm"> * Congestion updates are received via RDS_CMSG_CONG_UPDATE</span>
<span class="cm"> * control messages.</span>
<span class="cm"> *</span>
<span class="cm"> * The correspondence between bits and ports is</span>
<span class="cm"> *	1 &lt;&lt; (portnum % 64)</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_CONG_MONITOR_SIZE	64</span>
<span class="cp">#define RDS_CONG_MONITOR_BIT(port)  (((unsigned int) port) % RDS_CONG_MONITOR_SIZE)</span>
<span class="cp">#define RDS_CONG_MONITOR_MASK(port) (1ULL &lt;&lt; RDS_CONG_MONITOR_BIT(port))</span>

<span class="cm">/*</span>
<span class="cm"> * RDMA related types</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This encapsulates a remote memory location.</span>
<span class="cm"> * In the current implementation, it contains the R_Key</span>
<span class="cm"> * of the remote memory region, and the offset into it</span>
<span class="cm"> * (so that the application does not have to worry about</span>
<span class="cm"> * alignment).</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="kt">uint64_t</span>	<span class="n">rds_rdma_cookie_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">rds_iovec</span> <span class="p">{</span>
	<span class="kt">uint64_t</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">bytes</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rds_get_mr_args</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rds_iovec</span> <span class="n">vec</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">cookie_addr</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rds_get_mr_for_dest_args</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span>	<span class="n">dest_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_iovec</span> 	<span class="n">vec</span><span class="p">;</span>
	<span class="kt">uint64_t</span>		<span class="n">cookie_addr</span><span class="p">;</span>
	<span class="kt">uint64_t</span>		<span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rds_free_mr_args</span> <span class="p">{</span>
	<span class="n">rds_rdma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rds_rdma_args</span> <span class="p">{</span>
	<span class="n">rds_rdma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rds_iovec</span> <span class="n">remote_vec</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">local_vec_addr</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">nr_local</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">user_token</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rds_atomic_args</span> <span class="p">{</span>
	<span class="n">rds_rdma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">uint64_t</span> 	<span class="n">local_addr</span><span class="p">;</span>
	<span class="kt">uint64_t</span> 	<span class="n">remote_addr</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">uint64_t</span>	<span class="n">compare</span><span class="p">;</span>
			<span class="kt">uint64_t</span>	<span class="n">swap</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">cswp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">uint64_t</span>	<span class="n">add</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">fadd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">uint64_t</span>	<span class="n">compare</span><span class="p">;</span>
			<span class="kt">uint64_t</span>	<span class="n">swap</span><span class="p">;</span>
			<span class="kt">uint64_t</span>	<span class="n">compare_mask</span><span class="p">;</span>
			<span class="kt">uint64_t</span>	<span class="n">swap_mask</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">m_cswp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">uint64_t</span>	<span class="n">add</span><span class="p">;</span>
			<span class="kt">uint64_t</span>	<span class="n">nocarry_mask</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">m_fadd</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="kt">uint64_t</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint64_t</span>	<span class="n">user_token</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rds_rdma_notify</span> <span class="p">{</span>
	<span class="kt">uint64_t</span>	<span class="n">user_token</span><span class="p">;</span>
	<span class="kt">int32_t</span>		<span class="n">status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define RDS_RDMA_SUCCESS	0</span>
<span class="cp">#define RDS_RDMA_REMOTE_ERROR	1</span>
<span class="cp">#define RDS_RDMA_CANCELED	2</span>
<span class="cp">#define RDS_RDMA_DROPPED	3</span>
<span class="cp">#define RDS_RDMA_OTHER_ERROR	4</span>

<span class="cm">/*</span>
<span class="cm"> * Common set of flags for all RDMA related structs</span>
<span class="cm"> */</span>
<span class="cp">#define RDS_RDMA_READWRITE	0x0001</span>
<span class="cp">#define RDS_RDMA_FENCE		0x0002	</span><span class="cm">/* use FENCE for immediate send */</span><span class="cp"></span>
<span class="cp">#define RDS_RDMA_INVALIDATE	0x0004	</span><span class="cm">/* invalidate R_Key after freeing MR */</span><span class="cp"></span>
<span class="cp">#define RDS_RDMA_USE_ONCE	0x0008	</span><span class="cm">/* free MR after use */</span><span class="cp"></span>
<span class="cp">#define RDS_RDMA_DONTWAIT	0x0010	</span><span class="cm">/* Don&#39;t wait in SET_BARRIER */</span><span class="cp"></span>
<span class="cp">#define RDS_RDMA_NOTIFY_ME	0x0020	</span><span class="cm">/* Notify when operation completes */</span><span class="cp"></span>
<span class="cp">#define RDS_RDMA_SILENT		0x0040	</span><span class="cm">/* Do not interrupt remote */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* IB_RDS_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
