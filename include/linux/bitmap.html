<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › bitmap.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>bitmap.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __LINUX_BITMAP_H</span>
<span class="cp">#define __LINUX_BITMAP_H</span>

<span class="cp">#ifndef __ASSEMBLY__</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * bitmaps provide bit arrays that consume one or more unsigned</span>
<span class="cm"> * longs.  The bitmap interface and available operations are listed</span>
<span class="cm"> * here, in bitmap.h</span>
<span class="cm"> *</span>
<span class="cm"> * Function implementations generic to all architectures are in</span>
<span class="cm"> * lib/bitmap.c.  Functions implementations that are architecture</span>
<span class="cm"> * specific are in various include/asm-&lt;arch&gt;/bitops.h headers</span>
<span class="cm"> * and other arch/&lt;arch&gt; specific files.</span>
<span class="cm"> *</span>
<span class="cm"> * See lib/bitmap.c for more details.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The available bitmap operations and their rough meaning in the</span>
<span class="cm"> * case that the bitmap is a single unsigned long are thus:</span>
<span class="cm"> *</span>
<span class="cm"> * Note that nbits should be always a compile time evaluable constant.</span>
<span class="cm"> * Otherwise many inlines will generate horrible code.</span>
<span class="cm"> *</span>
<span class="cm"> * bitmap_zero(dst, nbits)			*dst = 0UL</span>
<span class="cm"> * bitmap_fill(dst, nbits)			*dst = ~0UL</span>
<span class="cm"> * bitmap_copy(dst, src, nbits)			*dst = *src</span>
<span class="cm"> * bitmap_and(dst, src1, src2, nbits)		*dst = *src1 &amp; *src2</span>
<span class="cm"> * bitmap_or(dst, src1, src2, nbits)		*dst = *src1 | *src2</span>
<span class="cm"> * bitmap_xor(dst, src1, src2, nbits)		*dst = *src1 ^ *src2</span>
<span class="cm"> * bitmap_andnot(dst, src1, src2, nbits)	*dst = *src1 &amp; ~(*src2)</span>
<span class="cm"> * bitmap_complement(dst, src, nbits)		*dst = ~(*src)</span>
<span class="cm"> * bitmap_equal(src1, src2, nbits)		Are *src1 and *src2 equal?</span>
<span class="cm"> * bitmap_intersects(src1, src2, nbits) 	Do *src1 and *src2 overlap?</span>
<span class="cm"> * bitmap_subset(src1, src2, nbits)		Is *src1 a subset of *src2?</span>
<span class="cm"> * bitmap_empty(src, nbits)			Are all bits zero in *src?</span>
<span class="cm"> * bitmap_full(src, nbits)			Are all bits set in *src?</span>
<span class="cm"> * bitmap_weight(src, nbits)			Hamming Weight: number set bits</span>
<span class="cm"> * bitmap_set(dst, pos, nbits)			Set specified bit area</span>
<span class="cm"> * bitmap_clear(dst, pos, nbits)		Clear specified bit area</span>
<span class="cm"> * bitmap_find_next_zero_area(buf, len, pos, n, mask)	Find bit free area</span>
<span class="cm"> * bitmap_shift_right(dst, src, n, nbits)	*dst = *src &gt;&gt; n</span>
<span class="cm"> * bitmap_shift_left(dst, src, n, nbits)	*dst = *src &lt;&lt; n</span>
<span class="cm"> * bitmap_remap(dst, src, old, new, nbits)	*dst = map(old, new)(src)</span>
<span class="cm"> * bitmap_bitremap(oldbit, old, new, nbits)	newbit = map(old, new)(oldbit)</span>
<span class="cm"> * bitmap_onto(dst, orig, relmap, nbits)	*dst = orig relative to relmap</span>
<span class="cm"> * bitmap_fold(dst, orig, sz, nbits)		dst bits = orig bits mod sz</span>
<span class="cm"> * bitmap_scnprintf(buf, len, src, nbits)	Print bitmap src to buf</span>
<span class="cm"> * bitmap_parse(buf, buflen, dst, nbits)	Parse bitmap dst from kernel buf</span>
<span class="cm"> * bitmap_parse_user(ubuf, ulen, dst, nbits)	Parse bitmap dst from user buf</span>
<span class="cm"> * bitmap_scnlistprintf(buf, len, src, nbits)	Print bitmap src as list to buf</span>
<span class="cm"> * bitmap_parselist(buf, dst, nbits)		Parse bitmap dst from kernel buf</span>
<span class="cm"> * bitmap_parselist_user(buf, dst, nbits)	Parse bitmap dst from user buf</span>
<span class="cm"> * bitmap_find_free_region(bitmap, bits, order)	Find and allocate bit region</span>
<span class="cm"> * bitmap_release_region(bitmap, pos, order)	Free specified bit region</span>
<span class="cm"> * bitmap_allocate_region(bitmap, pos, order)	Allocate specified bit region</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Also the following operations in asm/bitops.h apply to bitmaps.</span>
<span class="cm"> *</span>
<span class="cm"> * set_bit(bit, addr)			*addr |= bit</span>
<span class="cm"> * clear_bit(bit, addr)			*addr &amp;= ~bit</span>
<span class="cm"> * change_bit(bit, addr)		*addr ^= bit</span>
<span class="cm"> * test_bit(bit, addr)			Is bit set in *addr?</span>
<span class="cm"> * test_and_set_bit(bit, addr)		Set bit and return old value</span>
<span class="cm"> * test_and_clear_bit(bit, addr)	Clear bit and return old value</span>
<span class="cm"> * test_and_change_bit(bit, addr)	Change bit and return old value</span>
<span class="cm"> * find_first_zero_bit(addr, nbits)	Position first zero bit in *addr</span>
<span class="cm"> * find_first_bit(addr, nbits)		Position first set bit in *addr</span>
<span class="cm"> * find_next_zero_bit(addr, nbits, bit)	Position next zero bit in *addr &gt;= bit</span>
<span class="cm"> * find_next_bit(addr, nbits, bit)	Position next set bit in *addr &gt;= bit</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The DECLARE_BITMAP(name,bits) macro, in linux/types.h, can be used</span>
<span class="cm"> * to declare an array named &#39;name&#39; of just enough unsigned longs to</span>
<span class="cm"> * contain all bit positions from 0 to &#39;bits&#39; - 1.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * lib/bitmap.c provides these functions:</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_empty</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_full</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_equal</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap1</span><span class="p">,</span>
                	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__bitmap_complement</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__bitmap_shift_right</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
                        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__bitmap_shift_left</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
                        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_and</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__bitmap_or</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__bitmap_xor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_andnot</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_intersects</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_subset</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_weight</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">bitmap_set</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bitmap_clear</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bitmap_find_next_zero_area</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align_mask</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_scnprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bitmap_parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_user</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_parse_user</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ulen</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_scnlistprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_parselist</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">maskp</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">nmaskbits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_parselist_user</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ulen</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bitmap_remap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_bitremap</span><span class="p">(</span><span class="kt">int</span> <span class="n">oldbit</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bitmap_onto</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">orig</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">relmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bitmap_fold</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">orig</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">sz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_find_free_region</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bitmap_release_region</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_allocate_region</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bitmap_copy_le</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">bitmap_ord_to_pos</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>

<span class="cp">#define BITMAP_FIRST_WORD_MASK(start) (~0UL &lt;&lt; ((start) % BITS_PER_LONG))</span>
<span class="cp">#define BITMAP_LAST_WORD_MASK(nbits)					\</span>
<span class="cp">(									\</span>
<span class="cp">	((nbits) % BITS_PER_LONG) ?					\</span>
<span class="cp">		(1UL&lt;&lt;((nbits) % BITS_PER_LONG))-1 : ~0UL		\</span>
<span class="cp">)</span>

<span class="cp">#define small_const_nbits(nbits) \</span>
<span class="cp">	(__builtin_constant_p(nbits) &amp;&amp; (nbits) &lt;= BITS_PER_LONG)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bitmap_zero</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">nbits</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bitmap_fill</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">nlongs</span> <span class="o">=</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">nbits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">nlongs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>  <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dst</span><span class="p">[</span><span class="n">nlongs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bitmap_copy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">nbits</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_and</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">*</span><span class="n">src1</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">src2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__bitmap_and</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bitmap_or</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">*</span><span class="n">src1</span> <span class="o">|</span> <span class="o">*</span><span class="n">src2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">__bitmap_or</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bitmap_xor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">*</span><span class="n">src1</span> <span class="o">^</span> <span class="o">*</span><span class="n">src2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">__bitmap_xor</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_andnot</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">*</span><span class="n">src1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="n">src2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__bitmap_andnot</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bitmap_complement</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__bitmap_complement</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_equal</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">!</span> <span class="p">((</span><span class="o">*</span><span class="n">src1</span> <span class="o">^</span> <span class="o">*</span><span class="n">src2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">__bitmap_equal</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_intersects</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="n">src1</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">src2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">__bitmap_intersects</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_subset</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">!</span> <span class="p">((</span><span class="o">*</span><span class="n">src1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="n">src2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">__bitmap_subset</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_empty</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">!</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">&amp;</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">__bitmap_empty</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_full</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">!</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">__bitmap_full</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_weight</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">hweight_long</span><span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">&amp;</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">__bitmap_weight</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bitmap_shift_right</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">__bitmap_shift_right</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bitmap_shift_left</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_const_nbits</span><span class="p">(</span><span class="n">nbits</span><span class="p">))</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BITMAP_LAST_WORD_MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__bitmap_shift_left</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bitmap_parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">maskp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nmaskbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__bitmap_parse</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maskp</span><span class="p">,</span> <span class="n">nmaskbits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __ASSEMBLY__ */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* __LINUX_BITMAP_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
