<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › timex.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>timex.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Copyright (c) David L. Mills 1993                                         *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Permission to use, copy, modify, and distribute this software and its     *</span>
<span class="cm"> * documentation for any purpose and without fee is hereby granted, provided *</span>
<span class="cm"> * that the above copyright notice appears in all copies and that both the   *</span>
<span class="cm"> * copyright notice and this permission notice appear in supporting          *</span>
<span class="cm"> * documentation, and that the name University of Delaware not be used in    *</span>
<span class="cm"> * advertising or publicity pertaining to distribution of the software       *</span>
<span class="cm"> * without specific, written prior permission.  The University of Delaware   *</span>
<span class="cm"> * makes no representations about the suitability this software for any      *</span>
<span class="cm"> * purpose.  It is provided &quot;as is&quot; without express or implied warranty.     *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Modification history timex.h</span>
<span class="cm"> *</span>
<span class="cm"> * 29 Dec 97	Russell King</span>
<span class="cm"> *	Moved CLOCK_TICK_RATE, CLOCK_TICK_FACTOR and FINETUNE to asm/timex.h</span>
<span class="cm"> *	for ARM machines</span>
<span class="cm"> *</span>
<span class="cm"> *  9 Jan 97    Adrian Sun</span>
<span class="cm"> *      Shifted LATCH define to allow access to alpha machines.</span>
<span class="cm"> *</span>
<span class="cm"> * 26 Sep 94	David L. Mills</span>
<span class="cm"> *	Added defines for hybrid phase/frequency-lock loop.</span>
<span class="cm"> *</span>
<span class="cm"> * 19 Mar 94	David L. Mills</span>
<span class="cm"> *	Moved defines from kernel routines to header file and added new</span>
<span class="cm"> *	defines for PPS phase-lock loop.</span>
<span class="cm"> *</span>
<span class="cm"> * 20 Feb 94	David L. Mills</span>
<span class="cm"> *	Revised status codes and structures for external clock and PPS</span>
<span class="cm"> *	signal discipline.</span>
<span class="cm"> *</span>
<span class="cm"> * 28 Nov 93	David L. Mills</span>
<span class="cm"> *	Adjusted parameters to improve stability and increase poll</span>
<span class="cm"> *	interval.</span>
<span class="cm"> *</span>
<span class="cm"> * 17 Sep 93    David L. Mills</span>
<span class="cm"> *      Created file $NTP/include/sys/timex.h</span>
<span class="cm"> * 07 Oct 93    Torsten Duwe</span>
<span class="cm"> *      Derived linux/timex.h</span>
<span class="cm"> * 1995-08-13    Torsten Duwe</span>
<span class="cm"> *      kernel PLL updated to 1994-12-13 specs (rfc-1589)</span>
<span class="cm"> * 1997-08-30    Ulrich Windl</span>
<span class="cm"> *      Added new constant NTP_PHASE_LIMIT</span>
<span class="cm"> * 2004-08-12    Christoph Lameter</span>
<span class="cm"> *      Reworked time interpolation logic</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _LINUX_TIMEX_H</span>
<span class="cp">#define _LINUX_TIMEX_H</span>

<span class="cp">#include &lt;linux/time.h&gt;</span>

<span class="cp">#define NTP_API		4	</span><span class="cm">/* NTP API version */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * syscall interface - used (mainly by NTP daemon)</span>
<span class="cm"> * to discipline kernel clock oscillator</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">timex</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">modes</span><span class="p">;</span>	<span class="cm">/* mode selector */</span>
	<span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>		<span class="cm">/* time offset (usec) */</span>
	<span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>		<span class="cm">/* frequency offset (scaled ppm) */</span>
	<span class="kt">long</span> <span class="n">maxerror</span><span class="p">;</span>		<span class="cm">/* maximum error (usec) */</span>
	<span class="kt">long</span> <span class="n">esterror</span><span class="p">;</span>		<span class="cm">/* estimated error (usec) */</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>		<span class="cm">/* clock command/status */</span>
	<span class="kt">long</span> <span class="n">constant</span><span class="p">;</span>		<span class="cm">/* pll time constant */</span>
	<span class="kt">long</span> <span class="n">precision</span><span class="p">;</span>		<span class="cm">/* clock precision (usec) (read only) */</span>
	<span class="kt">long</span> <span class="n">tolerance</span><span class="p">;</span>		<span class="cm">/* clock frequency tolerance (ppm)</span>
<span class="cm">				 * (read only)</span>
<span class="cm">				 */</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">time</span><span class="p">;</span>	<span class="cm">/* (read only, except for ADJ_SETOFFSET) */</span>
	<span class="kt">long</span> <span class="n">tick</span><span class="p">;</span>		<span class="cm">/* (modified) usecs between clock ticks */</span>

	<span class="kt">long</span> <span class="n">ppsfreq</span><span class="p">;</span>           <span class="cm">/* pps frequency (scaled ppm) (ro) */</span>
	<span class="kt">long</span> <span class="n">jitter</span><span class="p">;</span>            <span class="cm">/* pps jitter (us) (ro) */</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>              <span class="cm">/* interval duration (s) (shift) (ro) */</span>
	<span class="kt">long</span> <span class="n">stabil</span><span class="p">;</span>            <span class="cm">/* pps stability (scaled ppm) (ro) */</span>
	<span class="kt">long</span> <span class="n">jitcnt</span><span class="p">;</span>            <span class="cm">/* jitter limit exceeded (ro) */</span>
	<span class="kt">long</span> <span class="n">calcnt</span><span class="p">;</span>            <span class="cm">/* calibration intervals (ro) */</span>
	<span class="kt">long</span> <span class="n">errcnt</span><span class="p">;</span>            <span class="cm">/* calibration errors (ro) */</span>
	<span class="kt">long</span> <span class="n">stbcnt</span><span class="p">;</span>            <span class="cm">/* stability limit exceeded (ro) */</span>

	<span class="kt">int</span> <span class="n">tai</span><span class="p">;</span>		<span class="cm">/* TAI offset (ro) */</span>

	<span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Mode codes (timex.mode)</span>
<span class="cm"> */</span>
<span class="cp">#define ADJ_OFFSET		0x0001	</span><span class="cm">/* time offset */</span><span class="cp"></span>
<span class="cp">#define ADJ_FREQUENCY		0x0002	</span><span class="cm">/* frequency offset */</span><span class="cp"></span>
<span class="cp">#define ADJ_MAXERROR		0x0004	</span><span class="cm">/* maximum time error */</span><span class="cp"></span>
<span class="cp">#define ADJ_ESTERROR		0x0008	</span><span class="cm">/* estimated time error */</span><span class="cp"></span>
<span class="cp">#define ADJ_STATUS		0x0010	</span><span class="cm">/* clock status */</span><span class="cp"></span>
<span class="cp">#define ADJ_TIMECONST		0x0020	</span><span class="cm">/* pll time constant */</span><span class="cp"></span>
<span class="cp">#define ADJ_TAI			0x0080	</span><span class="cm">/* set TAI offset */</span><span class="cp"></span>
<span class="cp">#define ADJ_SETOFFSET		0x0100  </span><span class="cm">/* add &#39;time&#39; to current time */</span><span class="cp"></span>
<span class="cp">#define ADJ_MICRO		0x1000	</span><span class="cm">/* select microsecond resolution */</span><span class="cp"></span>
<span class="cp">#define ADJ_NANO		0x2000	</span><span class="cm">/* select nanosecond resolution */</span><span class="cp"></span>
<span class="cp">#define ADJ_TICK		0x4000	</span><span class="cm">/* tick value */</span><span class="cp"></span>

<span class="cp">#ifdef __KERNEL__</span>
<span class="cp">#define ADJ_ADJTIME		0x8000	</span><span class="cm">/* switch between adjtime/adjtimex modes */</span><span class="cp"></span>
<span class="cp">#define ADJ_OFFSET_SINGLESHOT	0x0001	</span><span class="cm">/* old-fashioned adjtime */</span><span class="cp"></span>
<span class="cp">#define ADJ_OFFSET_READONLY	0x2000	</span><span class="cm">/* read-only adjtime */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define ADJ_OFFSET_SINGLESHOT	0x8001	</span><span class="cm">/* old-fashioned adjtime */</span><span class="cp"></span>
<span class="cp">#define ADJ_OFFSET_SS_READ	0xa001	</span><span class="cm">/* read-only adjtime */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/* NTP userland likes the MOD_ prefix better */</span>
<span class="cp">#define MOD_OFFSET	ADJ_OFFSET</span>
<span class="cp">#define MOD_FREQUENCY	ADJ_FREQUENCY</span>
<span class="cp">#define MOD_MAXERROR	ADJ_MAXERROR</span>
<span class="cp">#define MOD_ESTERROR	ADJ_ESTERROR</span>
<span class="cp">#define MOD_STATUS	ADJ_STATUS</span>
<span class="cp">#define MOD_TIMECONST	ADJ_TIMECONST</span>
<span class="cp">#define MOD_TAI	ADJ_TAI</span>
<span class="cp">#define MOD_MICRO	ADJ_MICRO</span>
<span class="cp">#define MOD_NANO	ADJ_NANO</span>


<span class="cm">/*</span>
<span class="cm"> * Status codes (timex.status)</span>
<span class="cm"> */</span>
<span class="cp">#define STA_PLL		0x0001	</span><span class="cm">/* enable PLL updates (rw) */</span><span class="cp"></span>
<span class="cp">#define STA_PPSFREQ	0x0002	</span><span class="cm">/* enable PPS freq discipline (rw) */</span><span class="cp"></span>
<span class="cp">#define STA_PPSTIME	0x0004	</span><span class="cm">/* enable PPS time discipline (rw) */</span><span class="cp"></span>
<span class="cp">#define STA_FLL		0x0008	</span><span class="cm">/* select frequency-lock mode (rw) */</span><span class="cp"></span>

<span class="cp">#define STA_INS		0x0010	</span><span class="cm">/* insert leap (rw) */</span><span class="cp"></span>
<span class="cp">#define STA_DEL		0x0020	</span><span class="cm">/* delete leap (rw) */</span><span class="cp"></span>
<span class="cp">#define STA_UNSYNC	0x0040	</span><span class="cm">/* clock unsynchronized (rw) */</span><span class="cp"></span>
<span class="cp">#define STA_FREQHOLD	0x0080	</span><span class="cm">/* hold frequency (rw) */</span><span class="cp"></span>

<span class="cp">#define STA_PPSSIGNAL	0x0100	</span><span class="cm">/* PPS signal present (ro) */</span><span class="cp"></span>
<span class="cp">#define STA_PPSJITTER	0x0200	</span><span class="cm">/* PPS signal jitter exceeded (ro) */</span><span class="cp"></span>
<span class="cp">#define STA_PPSWANDER	0x0400	</span><span class="cm">/* PPS signal wander exceeded (ro) */</span><span class="cp"></span>
<span class="cp">#define STA_PPSERROR	0x0800	</span><span class="cm">/* PPS signal calibration error (ro) */</span><span class="cp"></span>

<span class="cp">#define STA_CLOCKERR	0x1000	</span><span class="cm">/* clock hardware fault (ro) */</span><span class="cp"></span>
<span class="cp">#define STA_NANO	0x2000	</span><span class="cm">/* resolution (0 = us, 1 = ns) (ro) */</span><span class="cp"></span>
<span class="cp">#define STA_MODE	0x4000	</span><span class="cm">/* mode (0 = PLL, 1 = FLL) (ro) */</span><span class="cp"></span>
<span class="cp">#define STA_CLK		0x8000	</span><span class="cm">/* clock source (0 = A, 1 = B) (ro) */</span><span class="cp"></span>

<span class="cm">/* read-only bits */</span>
<span class="cp">#define STA_RONLY (STA_PPSSIGNAL | STA_PPSJITTER | STA_PPSWANDER | \</span>
<span class="cp">	STA_PPSERROR | STA_CLOCKERR | STA_NANO | STA_MODE | STA_CLK)</span>

<span class="cm">/*</span>
<span class="cm"> * Clock states (time_state)</span>
<span class="cm"> */</span>
<span class="cp">#define TIME_OK		0	</span><span class="cm">/* clock synchronized, no leap second */</span><span class="cp"></span>
<span class="cp">#define TIME_INS	1	</span><span class="cm">/* insert leap second */</span><span class="cp"></span>
<span class="cp">#define TIME_DEL	2	</span><span class="cm">/* delete leap second */</span><span class="cp"></span>
<span class="cp">#define TIME_OOP	3	</span><span class="cm">/* leap second in progress */</span><span class="cp"></span>
<span class="cp">#define TIME_WAIT	4	</span><span class="cm">/* leap second has occurred */</span><span class="cp"></span>
<span class="cp">#define TIME_ERROR	5	</span><span class="cm">/* clock not synchronized */</span><span class="cp"></span>
<span class="cp">#define TIME_BAD	TIME_ERROR </span><span class="cm">/* bw compat */</span><span class="cp"></span>

<span class="cp">#ifdef __KERNEL__</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/param.h&gt;</span>

<span class="cp">#include &lt;asm/timex.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * SHIFT_PLL is used as a dampening factor to define how much we</span>
<span class="cm"> * adjust the frequency correction for a given offset in PLL mode.</span>
<span class="cm"> * It also used in dampening the offset correction, to define how</span>
<span class="cm"> * much of the current value in time_offset we correct for each</span>
<span class="cm"> * second. Changing this value changes the stiffness of the ntp</span>
<span class="cm"> * adjustment code. A lower value makes it more flexible, reducing</span>
<span class="cm"> * NTP convergence time. A higher value makes it stiffer, increasing</span>
<span class="cm"> * convergence time, but making the clock more stable.</span>
<span class="cm"> *</span>
<span class="cm"> * In David Mills&#39; nanokernel reference implementation SHIFT_PLL is 4.</span>
<span class="cm"> * However this seems to increase convergence time much too long.</span>
<span class="cm"> *</span>
<span class="cm"> * https://lists.ntp.org/pipermail/hackers/2008-January/003487.html</span>
<span class="cm"> *</span>
<span class="cm"> * In the above mailing list discussion, it seems the value of 4</span>
<span class="cm"> * was appropriate for other Unix systems with HZ=100, and that</span>
<span class="cm"> * SHIFT_PLL should be decreased as HZ increases. However, Linux&#39;s</span>
<span class="cm"> * clock steering implementation is HZ independent.</span>
<span class="cm"> *</span>
<span class="cm"> * Through experimentation, a SHIFT_PLL value of 2 was found to allow</span>
<span class="cm"> * for fast convergence (very similar to the NTPv3 code used prior to</span>
<span class="cm"> * v2.6.19), with good clock stability.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * SHIFT_FLL is used as a dampening factor to define how much we</span>
<span class="cm"> * adjust the frequency correction for a given offset in FLL mode.</span>
<span class="cm"> * In David Mills&#39; nanokernel reference implementation SHIFT_FLL is 2.</span>
<span class="cm"> *</span>
<span class="cm"> * MAXTC establishes the maximum time constant of the PLL.</span>
<span class="cm"> */</span>
<span class="cp">#define SHIFT_PLL	2	</span><span class="cm">/* PLL frequency factor (shift) */</span><span class="cp"></span>
<span class="cp">#define SHIFT_FLL	2	</span><span class="cm">/* FLL frequency factor (shift) */</span><span class="cp"></span>
<span class="cp">#define MAXTC		10	</span><span class="cm">/* maximum time constant (shift) */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * SHIFT_USEC defines the scaling (shift) of the time_freq and</span>
<span class="cm"> * time_tolerance variables, which represent the current frequency</span>
<span class="cm"> * offset and maximum frequency tolerance.</span>
<span class="cm"> */</span>
<span class="cp">#define SHIFT_USEC 16		</span><span class="cm">/* frequency offset scale (shift) */</span><span class="cp"></span>
<span class="cp">#define PPM_SCALE ((s64)NSEC_PER_USEC &lt;&lt; (NTP_SCALE_SHIFT - SHIFT_USEC))</span>
<span class="cp">#define PPM_SCALE_INV_SHIFT 19</span>
<span class="cp">#define PPM_SCALE_INV ((1LL &lt;&lt; (PPM_SCALE_INV_SHIFT + NTP_SCALE_SHIFT)) / \</span>
<span class="cp">		       PPM_SCALE + 1)</span>

<span class="cp">#define MAXPHASE 500000000L	</span><span class="cm">/* max phase error (ns) */</span><span class="cp"></span>
<span class="cp">#define MAXFREQ 500000		</span><span class="cm">/* max frequency error (ns/s) */</span><span class="cp"></span>
<span class="cp">#define MAXFREQ_SCALED ((s64)MAXFREQ &lt;&lt; NTP_SCALE_SHIFT)</span>
<span class="cp">#define MINSEC 256		</span><span class="cm">/* min interval between updates (s) */</span><span class="cp"></span>
<span class="cp">#define MAXSEC 2048		</span><span class="cm">/* max interval between updates (s) */</span><span class="cp"></span>
<span class="cp">#define NTP_PHASE_LIMIT ((MAXPHASE / NSEC_PER_USEC) &lt;&lt; 5) </span><span class="cm">/* beyond max. dispersion */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * kernel variables</span>
<span class="cm"> * Note: maximum error = NTP synch distance = dispersion + delay / 2;</span>
<span class="cm"> * estimated error = NTP dispersion.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tick_usec</span><span class="p">;</span>		<span class="cm">/* USER_HZ period (usec) */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tick_nsec</span><span class="p">;</span>		<span class="cm">/* ACTHZ          period (nsec) */</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">ntp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ntp_clear</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Required to safely shift negative values */</span>
<span class="cp">#define shift_right(x, s) ({	\</span>
<span class="cp">	__typeof__(x) __x = (x);	\</span>
<span class="cp">	__typeof__(s) __s = (s);	\</span>
<span class="cp">	__x &lt; 0 ? -(-__x &gt;&gt; __s) : __x &gt;&gt; __s;	\</span>
<span class="cp">})</span>

<span class="cp">#define NTP_SCALE_SHIFT		32</span>

<span class="cp">#define NTP_INTERVAL_FREQ  (HZ)</span>
<span class="cp">#define NTP_INTERVAL_LENGTH (NSEC_PER_SEC/NTP_INTERVAL_FREQ)</span>

<span class="cm">/* Returns how long ticks are at present, in ns / 2^NTP_SCALE_SHIFT. */</span>
<span class="k">extern</span> <span class="n">u64</span> <span class="n">ntp_tick_length</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">second_overflow</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">secs</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">do_adjtimex</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">hardpps</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">read_current_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timer_val</span><span class="p">);</span>

<span class="cm">/* The clock frequency of the i8253/i8254 PIT */</span>
<span class="cp">#define PIT_TICK_RATE 1193182ul</span>

<span class="cp">#endif </span><span class="cm">/* KERNEL */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* LINUX_TIMEX_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
