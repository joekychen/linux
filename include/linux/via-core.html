<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › via-core.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>via-core.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 1998-2009 VIA Technologies, Inc. All Rights Reserved.</span>
<span class="cm"> * Copyright 2001-2008 S3 Graphics, Inc. All Rights Reserved.</span>
<span class="cm"> * Copyright 2009-2010 Jonathan Corbet &lt;corbet@lwn.net&gt;</span>
<span class="cm"> * Copyright 2010 Florian Tobias Schandinat &lt;FlorianSchandinat@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public</span>
<span class="cm"> * License as published by the Free Software Foundation;</span>
<span class="cm"> * either version 2, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTIES OR REPRESENTATIONS; without even</span>
<span class="cm"> * the implied warranty of MERCHANTABILITY or FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE.See the GNU General Public License</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc.,</span>
<span class="cm"> * 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __VIA_CORE_H__</span>
<span class="cp">#define __VIA_CORE_H__</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * A description of each known serial I2C/GPIO port.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">via_port_type</span> <span class="p">{</span>
	<span class="n">VIA_PORT_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">VIA_PORT_I2C</span><span class="p">,</span>
	<span class="n">VIA_PORT_GPIO</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">via_port_mode</span> <span class="p">{</span>
	<span class="n">VIA_MODE_OFF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">VIA_MODE_I2C</span><span class="p">,</span>		<span class="cm">/* Used as I2C port */</span>
	<span class="n">VIA_MODE_GPIO</span><span class="p">,</span>	<span class="cm">/* Two GPIO ports */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">viafb_i2c_adap</span> <span class="p">{</span>
	<span class="n">VIA_PORT_26</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">VIA_PORT_31</span><span class="p">,</span>
	<span class="n">VIA_PORT_25</span><span class="p">,</span>
	<span class="n">VIA_PORT_2C</span><span class="p">,</span>
	<span class="n">VIA_PORT_3D</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define VIAFB_NUM_PORTS 5</span>

<span class="k">struct</span> <span class="n">via_port_cfg</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">via_port_type</span>	<span class="n">type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">via_port_mode</span>	<span class="n">mode</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">io_port</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">ioport_index</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Allow subdevs to register suspend/resume hooks.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">struct</span> <span class="n">viafb_pm_hooks</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">viafb_pm_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_pm_hooks</span> <span class="o">*</span><span class="n">hooks</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">viafb_pm_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">viafb_pm_hooks</span> <span class="o">*</span><span class="n">hooks</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * This is the global viafb &quot;device&quot; containing stuff needed by</span>
<span class="cm"> * all subdevs.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">viafb_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_port_cfg</span> <span class="o">*</span><span class="n">port_cfg</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Spinlock for access to device registers.  Not yet</span>
<span class="cm">	 * globally used.</span>
<span class="cm">	 */</span>
	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The framebuffer MMIO region.  Little, if anything, touches</span>
<span class="cm">	 * this memory directly, and certainly nothing outside of the</span>
<span class="cm">	 * framebuffer device itself.  We *do* have to be able to allocate</span>
<span class="cm">	 * chunks of this memory for other devices, though.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fbmem_start</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">fbmem_len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fbmem</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_VIDEO_VIA_CAMERA) || defined(CONFIG_VIDEO_VIA_CAMERA_MODULE)</span>
	<span class="kt">long</span> <span class="n">camera_fbmem_offset</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">camera_fbmem_size</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * The MMIO region for device registers.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">engine_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">engine_len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">engine_mmio</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt management.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">viafb_irq_enable</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">viafb_irq_disable</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The global interrupt control register and its bits.</span>
<span class="cm"> */</span>
<span class="cp">#define VDE_INTERRUPT	0x200	</span><span class="cm">/* Video interrupt flags/masks */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DVISENSE  0x00000001  </span><span class="cm">/* DVI sense int status */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_VBLANK    0x00000002  </span><span class="cm">/* Vertical blank status */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_MCCFI	  0x00000004  </span><span class="cm">/* MCE compl. frame int status */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_VSYNC	  0x00000008  </span><span class="cm">/* VGA VSYNC int status */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DMA0DDONE 0x00000010  </span><span class="cm">/* DMA 0 descr done */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DMA0TDONE 0x00000020  </span><span class="cm">/* DMA 0 transfer done */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DMA1DDONE 0x00000040  </span><span class="cm">/* DMA 1 descr done */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DMA1TDONE 0x00000080  </span><span class="cm">/* DMA 1 transfer done */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_C1AV      0x00000100  </span><span class="cm">/* Cap Eng 1 act vid end */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_HQV0	  0x00000200  </span><span class="cm">/* First HQV engine */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_HQV1      0x00000400  </span><span class="cm">/* Second HQV engine */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_HQV1EN	  0x00000800  </span><span class="cm">/* Second HQV engine enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_C0AV      0x00001000  </span><span class="cm">/* Cap Eng 0 act vid end */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_C0VBI     0x00002000  </span><span class="cm">/* Cap Eng 0 VBI end */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_C1VBI     0x00004000  </span><span class="cm">/* Cap Eng 1 VBI end */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_VSYNC2    0x00008000  </span><span class="cm">/* Sec. Disp. VSYNC */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DVISNSEN  0x00010000  </span><span class="cm">/* DVI sense enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_VSYNC2EN  0x00020000  </span><span class="cm">/* Sec Disp VSYNC enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_MCCFIEN	  0x00040000  </span><span class="cm">/* MC comp frame int mask enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_VSYNCEN   0x00080000  </span><span class="cm">/* VSYNC enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DMA0DDEN  0x00100000  </span><span class="cm">/* DMA 0 descr done enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DMA0TDEN  0x00200000  </span><span class="cm">/* DMA 0 trans done enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DMA1DDEN  0x00400000  </span><span class="cm">/* DMA 1 descr done enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_DMA1TDEN  0x00800000  </span><span class="cm">/* DMA 1 trans done enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_C1AVEN    0x01000000  </span><span class="cm">/* cap 1 act vid end enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_HQV0EN	  0x02000000  </span><span class="cm">/* First hqv engine enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_C1VBIEN	  0x04000000  </span><span class="cm">/* Cap 1 VBI end enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_LVDSSI    0x08000000  </span><span class="cm">/* LVDS sense interrupt */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_C0AVEN    0x10000000  </span><span class="cm">/* Cap 0 act vid end enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_C0VBIEN   0x20000000  </span><span class="cm">/* Cap 0 VBI end enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_LVDSSIEN  0x40000000  </span><span class="cm">/* LVDS Sense enable */</span><span class="cp"></span>
<span class="cp">#define   VDE_I_ENABLE	  0x80000000  </span><span class="cm">/* Global interrupt enable */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_VIDEO_VIA_CAMERA) || defined(CONFIG_VIDEO_VIA_CAMERA_MODULE)</span>
<span class="cm">/*</span>
<span class="cm"> * DMA management.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">viafb_request_dma</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">viafb_release_dma</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cm">/* void viafb_dma_copy_out(unsigned int offset, dma_addr_t paddr, int len); */</span>
<span class="kt">int</span> <span class="n">viafb_dma_copy_out_sg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsg</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * DMA Controller registers.</span>
<span class="cm"> */</span>
<span class="cp">#define VDMA_MR0	0xe00		</span><span class="cm">/* Mod reg 0 */</span><span class="cp"></span>
<span class="cp">#define   VDMA_MR_CHAIN   0x01		</span><span class="cm">/* Chaining mode */</span><span class="cp"></span>
<span class="cp">#define   VDMA_MR_TDIE    0x02		</span><span class="cm">/* Transfer done int enable */</span><span class="cp"></span>
<span class="cp">#define VDMA_CSR0	0xe04		</span><span class="cm">/* Control/status */</span><span class="cp"></span>
<span class="cp">#define	  VDMA_C_ENABLE	  0x01		  </span><span class="cm">/* DMA Enable */</span><span class="cp"></span>
<span class="cp">#define	  VDMA_C_START	  0x02		  </span><span class="cm">/* Start a transfer */</span><span class="cp"></span>
<span class="cp">#define	  VDMA_C_ABORT	  0x04		  </span><span class="cm">/* Abort a transfer */</span><span class="cp"></span>
<span class="cp">#define	  VDMA_C_DONE	  0x08		  </span><span class="cm">/* Transfer is done */</span><span class="cp"></span>
<span class="cp">#define VDMA_MARL0	0xe20		</span><span class="cm">/* Mem addr low */</span><span class="cp"></span>
<span class="cp">#define VDMA_MARH0	0xe24		</span><span class="cm">/* Mem addr high */</span><span class="cp"></span>
<span class="cp">#define VDMA_DAR0	0xe28		</span><span class="cm">/* Device address */</span><span class="cp"></span>
<span class="cp">#define VDMA_DQWCR0	0xe2c		</span><span class="cm">/* Count (16-byte) */</span><span class="cp"></span>
<span class="cp">#define VDMA_TMR0	0xe30		</span><span class="cm">/* Tile mode reg */</span><span class="cp"></span>
<span class="cp">#define VDMA_DPRL0	0xe34		</span><span class="cm">/* Not sure */</span><span class="cp"></span>
<span class="cp">#define	  VDMA_DPR_IN	  0x08		</span><span class="cm">/* Inbound transfer to FB */</span><span class="cp"></span>
<span class="cp">#define VDMA_DPRH0	0xe38</span>
<span class="cp">#define VDMA_PMR0	(0xe00 + 0x134) </span><span class="cm">/* Pitch mode */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Useful stuff that probably belongs somewhere global.</span>
<span class="cm"> */</span>
<span class="cp">#define VGA_WIDTH	640</span>
<span class="cp">#define VGA_HEIGHT	480</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VIDEO_VIA_CAMERA */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Indexed port operations.  Note that these are all multi-op</span>
<span class="cm"> * functions; every invocation will be racy if you&#39;re not holding</span>
<span class="cm"> * reg_lock.</span>
<span class="cm"> */</span>

<span class="cp">#define VIAStatus   0x3DA  </span><span class="cm">/* Non-indexed port */</span><span class="cp"></span>
<span class="cp">#define VIACR       0x3D4</span>
<span class="cp">#define VIASR       0x3C4</span>
<span class="cp">#define VIAGR       0x3CE</span>
<span class="cp">#define VIAAR       0x3C0</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">via_read_reg</span><span class="p">(</span><span class="n">u16</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">via_write_reg</span><span class="p">(</span><span class="n">u16</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">via_write_reg_mask</span><span class="p">(</span><span class="n">u16</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">old</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">),</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define VIA_MISC_REG_READ	0x03CC</span>
<span class="cp">#define VIA_MISC_REG_WRITE	0x03C2</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">via_write_misc_reg_mask</span><span class="p">(</span><span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">VIA_MISC_REG_READ</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">),</span> <span class="n">VIA_MISC_REG_WRITE</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#endif </span><span class="cm">/* __VIA_CORE_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
