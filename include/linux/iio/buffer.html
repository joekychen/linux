<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › iio › buffer.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>buffer.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* The industrial I/O core - generic buffer interfaces.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 Jonathan Cameron</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _IIO_BUFFER_GENERIC_H_</span>
<span class="cp">#define _IIO_BUFFER_GENERIC_H_</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/iio/iio.h&gt;</span>

<span class="cp">#ifdef CONFIG_IIO_BUFFER</span>

<span class="k">struct</span> <span class="n">iio_buffer</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct iio_buffer_access_funcs - access functions for buffers.</span>
<span class="cm"> * @store_to:		actually store stuff to the buffer</span>
<span class="cm"> * @read_first_n:	try to get a specified number of bytes (must exist)</span>
<span class="cm"> * @request_update:	if a parameter change has been marked, update underlying</span>
<span class="cm"> *			storage.</span>
<span class="cm"> * @get_bytes_per_datum:get current bytes per datum</span>
<span class="cm"> * @set_bytes_per_datum:set number of bytes per datum</span>
<span class="cm"> * @get_length:		get number of datums in buffer</span>
<span class="cm"> * @set_length:		set number of datums in buffer</span>
<span class="cm"> *</span>
<span class="cm"> * The purpose of this structure is to make the buffer element</span>
<span class="cm"> * modular as event for a given driver, different usecases may require</span>
<span class="cm"> * different buffer designs (space efficiency vs speed for example).</span>
<span class="cm"> *</span>
<span class="cm"> * It is worth noting that a given buffer implementation may only support a</span>
<span class="cm"> * small proportion of these functions.  The core code &#39;should&#39; cope fine with</span>
<span class="cm"> * any of them not existing.</span>
<span class="cm"> **/</span>
<span class="k">struct</span> <span class="n">iio_buffer_access_funcs</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">store_to</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">s64</span> <span class="n">timestamp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_first_n</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">request_update</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_bytes_per_datum</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_bytes_per_datum</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bpd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_length</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_length</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct iio_buffer - general buffer structure</span>
<span class="cm"> * @length:		[DEVICE] number of datums in buffer</span>
<span class="cm"> * @bytes_per_datum:	[DEVICE] size of individual datum including timestamp</span>
<span class="cm"> * @scan_el_attrs:	[DRIVER] control of scan elements if that scan mode</span>
<span class="cm"> *			control method is used</span>
<span class="cm"> * @scan_mask:		[INTERN] bitmask used in masking scan mode elements</span>
<span class="cm"> * @scan_timestamp:	[INTERN] does the scan mode include a timestamp</span>
<span class="cm"> * @access:		[DRIVER] buffer access functions associated with the</span>
<span class="cm"> *			implementation.</span>
<span class="cm"> * @scan_el_dev_attr_list:[INTERN] list of scan element related attributes.</span>
<span class="cm"> * @scan_el_group:	[DRIVER] attribute group for those attributes not</span>
<span class="cm"> *			created from the iio_chan_info array.</span>
<span class="cm"> * @pollq:		[INTERN] wait queue to allow for polling on the buffer.</span>
<span class="cm"> * @stufftoread:	[INTERN] flag to indicate new data.</span>
<span class="cm"> * @demux_list:		[INTERN] list of operations required to demux the scan.</span>
<span class="cm"> * @demux_bounce:	[INTERN] buffer for doing gather from incoming scan.</span>
<span class="cm"> **/</span>
<span class="k">struct</span> <span class="n">iio_buffer</span> <span class="p">{</span>
	<span class="kt">int</span>					<span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">bytes_per_datum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute_group</span>			<span class="o">*</span><span class="n">scan_el_attrs</span><span class="p">;</span>
	<span class="kt">long</span>					<span class="o">*</span><span class="n">scan_mask</span><span class="p">;</span>
	<span class="n">bool</span>					<span class="n">scan_timestamp</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iio_buffer_access_funcs</span>	<span class="o">*</span><span class="n">access</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>			<span class="n">scan_el_dev_attr_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute_group</span>			<span class="n">scan_el_group</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>			<span class="n">pollq</span><span class="p">;</span>
	<span class="n">bool</span>					<span class="n">stufftoread</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>			<span class="n">demux_list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>				<span class="o">*</span><span class="n">demux_bounce</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * iio_buffer_init() - Initialize the buffer structure</span>
<span class="cm"> * @buffer: buffer to be initialized</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="n">iio_buffer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __iio_update_buffer() - update common elements of buffers</span>
<span class="cm"> * @buffer:		buffer that is the event source</span>
<span class="cm"> * @bytes_per_datum:	size of individual datum including timestamp</span>
<span class="cm"> * @length:		number of datums in buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__iio_update_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">bytes_per_datum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">bytes_per_datum</span> <span class="o">=</span> <span class="n">bytes_per_datum</span><span class="p">;</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">iio_scan_mask_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * iio_scan_mask_set() - set particular bit in the scan mask</span>
<span class="cm"> * @buffer: the buffer whose scan mask we are interested in</span>
<span class="cm"> * @bit: the bit to be set.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="n">iio_scan_mask_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * iio_push_to_buffer() - push to a registered buffer.</span>
<span class="cm"> * @buffer:		IIO buffer structure for device</span>
<span class="cm"> * @scan:		Full scan.</span>
<span class="cm"> * @timestamp:</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">iio_push_to_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">s64</span> <span class="n">timestamp</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">iio_update_demux</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * iio_buffer_register() - register the buffer with IIO core</span>
<span class="cm"> * @indio_dev: device with the buffer to be registered</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="n">iio_buffer_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">iio_chan_spec</span> <span class="o">*</span><span class="n">channels</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">num_channels</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * iio_buffer_unregister() - unregister the buffer from IIO core</span>
<span class="cm"> * @indio_dev: the device with the buffer to be unregistered</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="n">iio_buffer_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * iio_buffer_read_length() - attr func to get number of datums in the buffer</span>
<span class="cm"> **/</span>
<span class="kt">ssize_t</span> <span class="n">iio_buffer_read_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="cm">/**</span>
<span class="cm"> * iio_buffer_write_length() - attr func to set number of datums in the buffer</span>
<span class="cm"> **/</span>
<span class="kt">ssize_t</span> <span class="n">iio_buffer_write_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="cm">/**</span>
<span class="cm"> * iio_buffer_store_enable() - attr to turn the buffer on</span>
<span class="cm"> **/</span>
<span class="kt">ssize_t</span> <span class="n">iio_buffer_store_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="cm">/**</span>
<span class="cm"> * iio_buffer_show_enable() - attr to see if the buffer is on</span>
<span class="cm"> **/</span>
<span class="kt">ssize_t</span> <span class="n">iio_buffer_show_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="cp">#define IIO_BUFFER_LENGTH_ATTR DEVICE_ATTR(length, S_IRUGO | S_IWUSR,	\</span>
<span class="cp">					   iio_buffer_read_length,	\</span>
<span class="cp">					   iio_buffer_write_length)</span>

<span class="cp">#define IIO_BUFFER_ENABLE_ATTR DEVICE_ATTR(enable, S_IRUGO | S_IWUSR,	\</span>
<span class="cp">					   iio_buffer_show_enable,	\</span>
<span class="cp">					   iio_buffer_store_enable)</span>

<span class="kt">int</span> <span class="n">iio_sw_buffer_preenable</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">);</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_IIO_BUFFER */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">iio_buffer_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">iio_chan_spec</span> <span class="o">*</span><span class="n">channels</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">num_channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iio_buffer_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">)</span>
<span class="p">{};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_IIO_BUFFER */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _IIO_BUFFER_GENERIC_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
