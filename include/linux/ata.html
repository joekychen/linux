<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › ata.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ata.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright 2003-2004 Red Hat, Inc.  All rights reserved.</span>
<span class="cm"> *  Copyright 2003-2004 Jeff Garzik</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *  any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  libata documentation is available via &#39;make {ps|pdf}docs&#39;,</span>
<span class="cm"> *  as Documentation/DocBook/libata.*</span>
<span class="cm"> *</span>
<span class="cm"> *  Hardware documentation available from http://www.t13.org/</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __LINUX_ATA_H__</span>
<span class="cp">#define __LINUX_ATA_H__</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cm">/* defines only for the constants which don&#39;t work well as enums */</span>
<span class="cp">#define ATA_DMA_BOUNDARY	0xffffUL</span>
<span class="cp">#define ATA_DMA_MASK		0xffffffffULL</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* various global constants */</span>
	<span class="n">ATA_MAX_DEVICES</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* per bus/port */</span>
	<span class="n">ATA_MAX_PRD</span>		<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>	<span class="cm">/* we could make these 256/256 */</span>
	<span class="n">ATA_SECT_SIZE</span>		<span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
	<span class="n">ATA_MAX_SECTORS_128</span>	<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="n">ATA_MAX_SECTORS</span>		<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
	<span class="n">ATA_MAX_SECTORS_LBA48</span>	<span class="o">=</span> <span class="mi">65535</span><span class="p">,</span><span class="cm">/* TODO: 65536? */</span>
	<span class="n">ATA_MAX_SECTORS_TAPE</span>	<span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>

	<span class="n">ATA_ID_WORDS</span>		<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
	<span class="n">ATA_ID_CONFIG</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ATA_ID_CYLS</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ATA_ID_HEADS</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ATA_ID_SECTORS</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">ATA_ID_SERNO</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">ATA_ID_BUF_SIZE</span>		<span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
	<span class="n">ATA_ID_FW_REV</span>		<span class="o">=</span> <span class="mi">23</span><span class="p">,</span>
	<span class="n">ATA_ID_PROD</span>		<span class="o">=</span> <span class="mi">27</span><span class="p">,</span>
	<span class="n">ATA_ID_MAX_MULTSECT</span>	<span class="o">=</span> <span class="mi">47</span><span class="p">,</span>
	<span class="n">ATA_ID_DWORD_IO</span>		<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="n">ATA_ID_CAPABILITY</span>	<span class="o">=</span> <span class="mi">49</span><span class="p">,</span>
	<span class="n">ATA_ID_OLD_PIO_MODES</span>	<span class="o">=</span> <span class="mi">51</span><span class="p">,</span>
	<span class="n">ATA_ID_OLD_DMA_MODES</span>	<span class="o">=</span> <span class="mi">52</span><span class="p">,</span>
	<span class="n">ATA_ID_FIELD_VALID</span>	<span class="o">=</span> <span class="mi">53</span><span class="p">,</span>
	<span class="n">ATA_ID_CUR_CYLS</span>		<span class="o">=</span> <span class="mi">54</span><span class="p">,</span>
	<span class="n">ATA_ID_CUR_HEADS</span>	<span class="o">=</span> <span class="mi">55</span><span class="p">,</span>
	<span class="n">ATA_ID_CUR_SECTORS</span>	<span class="o">=</span> <span class="mi">56</span><span class="p">,</span>
	<span class="n">ATA_ID_MULTSECT</span>		<span class="o">=</span> <span class="mi">59</span><span class="p">,</span>
	<span class="n">ATA_ID_LBA_CAPACITY</span>	<span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	<span class="n">ATA_ID_SWDMA_MODES</span>	<span class="o">=</span> <span class="mi">62</span><span class="p">,</span>
	<span class="n">ATA_ID_MWDMA_MODES</span>	<span class="o">=</span> <span class="mi">63</span><span class="p">,</span>
	<span class="n">ATA_ID_PIO_MODES</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="n">ATA_ID_EIDE_DMA_MIN</span>	<span class="o">=</span> <span class="mi">65</span><span class="p">,</span>
	<span class="n">ATA_ID_EIDE_DMA_TIME</span>	<span class="o">=</span> <span class="mi">66</span><span class="p">,</span>
	<span class="n">ATA_ID_EIDE_PIO</span>		<span class="o">=</span> <span class="mi">67</span><span class="p">,</span>
	<span class="n">ATA_ID_EIDE_PIO_IORDY</span>	<span class="o">=</span> <span class="mi">68</span><span class="p">,</span>
	<span class="n">ATA_ID_ADDITIONAL_SUPP</span>	<span class="o">=</span> <span class="mi">69</span><span class="p">,</span>
	<span class="n">ATA_ID_QUEUE_DEPTH</span>	<span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
	<span class="n">ATA_ID_MAJOR_VER</span>	<span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
	<span class="n">ATA_ID_COMMAND_SET_1</span>	<span class="o">=</span> <span class="mi">82</span><span class="p">,</span>
	<span class="n">ATA_ID_COMMAND_SET_2</span>	<span class="o">=</span> <span class="mi">83</span><span class="p">,</span>
	<span class="n">ATA_ID_CFSSE</span>		<span class="o">=</span> <span class="mi">84</span><span class="p">,</span>
	<span class="n">ATA_ID_CFS_ENABLE_1</span>	<span class="o">=</span> <span class="mi">85</span><span class="p">,</span>
	<span class="n">ATA_ID_CFS_ENABLE_2</span>	<span class="o">=</span> <span class="mi">86</span><span class="p">,</span>
	<span class="n">ATA_ID_CSF_DEFAULT</span>	<span class="o">=</span> <span class="mi">87</span><span class="p">,</span>
	<span class="n">ATA_ID_UDMA_MODES</span>	<span class="o">=</span> <span class="mi">88</span><span class="p">,</span>
	<span class="n">ATA_ID_HW_CONFIG</span>	<span class="o">=</span> <span class="mi">93</span><span class="p">,</span>
	<span class="n">ATA_ID_SPG</span>		<span class="o">=</span> <span class="mi">98</span><span class="p">,</span>
	<span class="n">ATA_ID_LBA_CAPACITY_2</span>	<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="n">ATA_ID_SECTOR_SIZE</span>	<span class="o">=</span> <span class="mi">106</span><span class="p">,</span>
	<span class="n">ATA_ID_WWN</span>		<span class="o">=</span> <span class="mi">108</span><span class="p">,</span>
	<span class="n">ATA_ID_LOGICAL_SECTOR_SIZE</span>	<span class="o">=</span> <span class="mi">117</span><span class="p">,</span>	<span class="cm">/* and 118 */</span>
	<span class="n">ATA_ID_LAST_LUN</span>		<span class="o">=</span> <span class="mi">126</span><span class="p">,</span>
	<span class="n">ATA_ID_DLF</span>		<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="n">ATA_ID_CSFO</span>		<span class="o">=</span> <span class="mi">129</span><span class="p">,</span>
	<span class="n">ATA_ID_CFA_POWER</span>	<span class="o">=</span> <span class="mi">160</span><span class="p">,</span>
	<span class="n">ATA_ID_CFA_KEY_MGMT</span>	<span class="o">=</span> <span class="mi">162</span><span class="p">,</span>
	<span class="n">ATA_ID_CFA_MODES</span>	<span class="o">=</span> <span class="mi">163</span><span class="p">,</span>
	<span class="n">ATA_ID_DATA_SET_MGMT</span>	<span class="o">=</span> <span class="mi">169</span><span class="p">,</span>
	<span class="n">ATA_ID_ROT_SPEED</span>	<span class="o">=</span> <span class="mi">217</span><span class="p">,</span>
	<span class="n">ATA_ID_PIO4</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>

	<span class="n">ATA_ID_SERNO_LEN</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="n">ATA_ID_FW_REV_LEN</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">ATA_ID_PROD_LEN</span>		<span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
	<span class="n">ATA_ID_WWN_LEN</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>

	<span class="n">ATA_PCI_CTL_OFS</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

	<span class="n">ATA_PIO0</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ATA_PIO1</span>		<span class="o">=</span> <span class="n">ATA_PIO0</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ATA_PIO2</span>		<span class="o">=</span> <span class="n">ATA_PIO1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ATA_PIO3</span>		<span class="o">=</span> <span class="n">ATA_PIO2</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">ATA_PIO4</span>		<span class="o">=</span> <span class="n">ATA_PIO3</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">ATA_PIO5</span>		<span class="o">=</span> <span class="n">ATA_PIO4</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">ATA_PIO6</span>		<span class="o">=</span> <span class="n">ATA_PIO5</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>

	<span class="n">ATA_PIO4_ONLY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>

	<span class="n">ATA_SWDMA0</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ATA_SWDMA1</span>		<span class="o">=</span> <span class="n">ATA_SWDMA0</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ATA_SWDMA2</span>		<span class="o">=</span> <span class="n">ATA_SWDMA1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>

	<span class="n">ATA_SWDMA2_ONLY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>

	<span class="n">ATA_MWDMA0</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ATA_MWDMA1</span>		<span class="o">=</span> <span class="n">ATA_MWDMA0</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ATA_MWDMA2</span>		<span class="o">=</span> <span class="n">ATA_MWDMA1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ATA_MWDMA3</span>		<span class="o">=</span> <span class="n">ATA_MWDMA2</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">ATA_MWDMA4</span>		<span class="o">=</span> <span class="n">ATA_MWDMA3</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>

	<span class="n">ATA_MWDMA12_ONLY</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ATA_MWDMA2_ONLY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>

	<span class="n">ATA_UDMA0</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ATA_UDMA1</span>		<span class="o">=</span> <span class="n">ATA_UDMA0</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ATA_UDMA2</span>		<span class="o">=</span> <span class="n">ATA_UDMA1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ATA_UDMA3</span>		<span class="o">=</span> <span class="n">ATA_UDMA2</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">ATA_UDMA4</span>		<span class="o">=</span> <span class="n">ATA_UDMA3</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">ATA_UDMA5</span>		<span class="o">=</span> <span class="n">ATA_UDMA4</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">ATA_UDMA6</span>		<span class="o">=</span> <span class="n">ATA_UDMA5</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">ATA_UDMA7</span>		<span class="o">=</span> <span class="n">ATA_UDMA6</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>
	<span class="cm">/* ATA_UDMA7 is just for completeness... doesn&#39;t exist (yet?).  */</span>

	<span class="n">ATA_UDMA24_ONLY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>

	<span class="n">ATA_UDMA_MASK_40C</span>	<span class="o">=</span> <span class="n">ATA_UDMA2</span><span class="p">,</span>	<span class="cm">/* udma0-2 */</span>

	<span class="cm">/* DMA-related */</span>
	<span class="n">ATA_PRD_SZ</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">ATA_PRD_TBL_SZ</span>		<span class="o">=</span> <span class="p">(</span><span class="n">ATA_MAX_PRD</span> <span class="o">*</span> <span class="n">ATA_PRD_SZ</span><span class="p">),</span>
	<span class="n">ATA_PRD_EOT</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">),</span>	<span class="cm">/* end-of-table flag */</span>

	<span class="n">ATA_DMA_TABLE_OFS</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ATA_DMA_STATUS</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ATA_DMA_CMD</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ATA_DMA_WR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">ATA_DMA_START</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ATA_DMA_INTR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ATA_DMA_ERR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ATA_DMA_ACTIVE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* bits in ATA command block registers */</span>
	<span class="n">ATA_HOB</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>	<span class="cm">/* LBA48 selector */</span>
	<span class="n">ATA_NIEN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* disable-irq flag */</span>
	<span class="n">ATA_LBA</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>	<span class="cm">/* LBA28 selector */</span>
	<span class="n">ATA_DEV1</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* Select Device 1 (slave) */</span>
	<span class="n">ATA_DEVICE_OBS</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="cm">/* obs bits in dev reg */</span>
	<span class="n">ATA_DEVCTL_OBS</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* obsolete bit in devctl reg */</span>
	<span class="n">ATA_BUSY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>	<span class="cm">/* BSY status bit */</span>
	<span class="n">ATA_DRDY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>	<span class="cm">/* device ready */</span>
	<span class="n">ATA_DF</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* device fault */</span>
	<span class="n">ATA_DSC</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* drive seek complete */</span>
	<span class="n">ATA_DRQ</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* data request i/o */</span>
	<span class="n">ATA_CORR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* corrected data error */</span>
	<span class="n">ATA_IDX</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* index */</span>
	<span class="n">ATA_ERR</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* have an error */</span>
	<span class="n">ATA_SRST</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* software reset */</span>
	<span class="n">ATA_ICRC</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>	<span class="cm">/* interface CRC error */</span>
	<span class="n">ATA_BBK</span>			<span class="o">=</span> <span class="n">ATA_ICRC</span><span class="p">,</span>	<span class="cm">/* pre-EIDE: block marked bad */</span>
	<span class="n">ATA_UNC</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>	<span class="cm">/* uncorrectable media error */</span>
	<span class="n">ATA_MC</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* media changed */</span>
	<span class="n">ATA_IDNF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* ID not found */</span>
	<span class="n">ATA_MCR</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* media change requested */</span>
	<span class="n">ATA_ABORTED</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* command aborted */</span>
	<span class="n">ATA_TRK0NF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* track 0 not found */</span>
	<span class="n">ATA_AMNF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* address mark not found */</span>
	<span class="n">ATAPI_LFS</span>		<span class="o">=</span> <span class="mh">0xF0</span><span class="p">,</span>		<span class="cm">/* last failed sense */</span>
	<span class="n">ATAPI_EOM</span>		<span class="o">=</span> <span class="n">ATA_TRK0NF</span><span class="p">,</span>	<span class="cm">/* end of media */</span>
	<span class="n">ATAPI_ILI</span>		<span class="o">=</span> <span class="n">ATA_AMNF</span><span class="p">,</span>	<span class="cm">/* illegal length indication */</span>
	<span class="n">ATAPI_IO</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ATAPI_COD</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* ATA command block registers */</span>
	<span class="n">ATA_REG_DATA</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">ATA_REG_ERR</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">ATA_REG_NSECT</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">ATA_REG_LBAL</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">ATA_REG_LBAM</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">ATA_REG_LBAH</span>		<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">ATA_REG_DEVICE</span>		<span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">ATA_REG_STATUS</span>		<span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>

	<span class="n">ATA_REG_FEATURE</span>		<span class="o">=</span> <span class="n">ATA_REG_ERR</span><span class="p">,</span> <span class="cm">/* and their aliases */</span>
	<span class="n">ATA_REG_CMD</span>		<span class="o">=</span> <span class="n">ATA_REG_STATUS</span><span class="p">,</span>
	<span class="n">ATA_REG_BYTEL</span>		<span class="o">=</span> <span class="n">ATA_REG_LBAM</span><span class="p">,</span>
	<span class="n">ATA_REG_BYTEH</span>		<span class="o">=</span> <span class="n">ATA_REG_LBAH</span><span class="p">,</span>
	<span class="n">ATA_REG_DEVSEL</span>		<span class="o">=</span> <span class="n">ATA_REG_DEVICE</span><span class="p">,</span>
	<span class="n">ATA_REG_IRQ</span>		<span class="o">=</span> <span class="n">ATA_REG_NSECT</span><span class="p">,</span>

	<span class="cm">/* ATA device commands */</span>
	<span class="n">ATA_CMD_DEV_RESET</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span> <span class="cm">/* ATAPI device reset */</span>
	<span class="n">ATA_CMD_CHK_POWER</span>	<span class="o">=</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="cm">/* check power mode */</span>
	<span class="n">ATA_CMD_STANDBY</span>		<span class="o">=</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="cm">/* place in standby power mode */</span>
	<span class="n">ATA_CMD_IDLE</span>		<span class="o">=</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="cm">/* place in idle power mode */</span>
	<span class="n">ATA_CMD_EDD</span>		<span class="o">=</span> <span class="mh">0x90</span><span class="p">,</span>	<span class="cm">/* execute device diagnostic */</span>
	<span class="n">ATA_CMD_DOWNLOAD_MICRO</span>  <span class="o">=</span> <span class="mh">0x92</span><span class="p">,</span>
	<span class="n">ATA_CMD_NOP</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">ATA_CMD_FLUSH</span>		<span class="o">=</span> <span class="mh">0xE7</span><span class="p">,</span>
	<span class="n">ATA_CMD_FLUSH_EXT</span>	<span class="o">=</span> <span class="mh">0xEA</span><span class="p">,</span>
	<span class="n">ATA_CMD_ID_ATA</span>		<span class="o">=</span> <span class="mh">0xEC</span><span class="p">,</span>
	<span class="n">ATA_CMD_ID_ATAPI</span>	<span class="o">=</span> <span class="mh">0xA1</span><span class="p">,</span>
	<span class="n">ATA_CMD_SERVICE</span>		<span class="o">=</span> <span class="mh">0xA2</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ</span>		<span class="o">=</span> <span class="mh">0xC8</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_EXT</span>	<span class="o">=</span> <span class="mh">0x25</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_QUEUED</span>	<span class="o">=</span> <span class="mh">0x26</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_STREAM_EXT</span>	<span class="o">=</span> <span class="mh">0x2B</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_STREAM_DMA_EXT</span> <span class="o">=</span> <span class="mh">0x2A</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE</span>		<span class="o">=</span> <span class="mh">0xCA</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_EXT</span>	<span class="o">=</span> <span class="mh">0x35</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_QUEUED</span>	<span class="o">=</span> <span class="mh">0x36</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_STREAM_EXT</span> <span class="o">=</span> <span class="mh">0x3B</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_STREAM_DMA_EXT</span> <span class="o">=</span> <span class="mh">0x3A</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_FUA_EXT</span>	<span class="o">=</span> <span class="mh">0x3D</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_QUEUED_FUA_EXT</span> <span class="o">=</span> <span class="mh">0x3E</span><span class="p">,</span>
	<span class="n">ATA_CMD_FPDMA_READ</span>	<span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="n">ATA_CMD_FPDMA_WRITE</span>	<span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span>
	<span class="n">ATA_CMD_PIO_READ</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">ATA_CMD_PIO_READ_EXT</span>	<span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="n">ATA_CMD_PIO_WRITE</span>	<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">ATA_CMD_PIO_WRITE_EXT</span>	<span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_MULTI</span>	<span class="o">=</span> <span class="mh">0xC4</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_MULTI_EXT</span>	<span class="o">=</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_MULTI</span>	<span class="o">=</span> <span class="mh">0xC5</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_MULTI_EXT</span>	<span class="o">=</span> <span class="mh">0x39</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_MULTI_FUA_EXT</span> <span class="o">=</span> <span class="mh">0xCE</span><span class="p">,</span>
	<span class="n">ATA_CMD_SET_FEATURES</span>	<span class="o">=</span> <span class="mh">0xEF</span><span class="p">,</span>
	<span class="n">ATA_CMD_SET_MULTI</span>	<span class="o">=</span> <span class="mh">0xC6</span><span class="p">,</span>
	<span class="n">ATA_CMD_PACKET</span>		<span class="o">=</span> <span class="mh">0xA0</span><span class="p">,</span>
	<span class="n">ATA_CMD_VERIFY</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">ATA_CMD_VERIFY_EXT</span>	<span class="o">=</span> <span class="mh">0x42</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_UNCORR_EXT</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">,</span>
	<span class="n">ATA_CMD_STANDBYNOW1</span>	<span class="o">=</span> <span class="mh">0xE0</span><span class="p">,</span>
	<span class="n">ATA_CMD_IDLEIMMEDIATE</span>	<span class="o">=</span> <span class="mh">0xE1</span><span class="p">,</span>
	<span class="n">ATA_CMD_SLEEP</span>		<span class="o">=</span> <span class="mh">0xE6</span><span class="p">,</span>
	<span class="n">ATA_CMD_INIT_DEV_PARAMS</span>	<span class="o">=</span> <span class="mh">0x91</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_NATIVE_MAX</span>	<span class="o">=</span> <span class="mh">0xF8</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_NATIVE_MAX_EXT</span> <span class="o">=</span> <span class="mh">0x27</span><span class="p">,</span>
	<span class="n">ATA_CMD_SET_MAX</span>		<span class="o">=</span> <span class="mh">0xF9</span><span class="p">,</span>
	<span class="n">ATA_CMD_SET_MAX_EXT</span>	<span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_LOG_EXT</span>	<span class="o">=</span> <span class="mh">0x2F</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_LOG_EXT</span>	<span class="o">=</span> <span class="mh">0x3F</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_LOG_DMA_EXT</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_LOG_DMA_EXT</span> <span class="o">=</span> <span class="mh">0x57</span><span class="p">,</span>
	<span class="n">ATA_CMD_TRUSTED_RCV</span>	<span class="o">=</span> <span class="mh">0x5C</span><span class="p">,</span>
	<span class="n">ATA_CMD_TRUSTED_RCV_DMA</span> <span class="o">=</span> <span class="mh">0x5D</span><span class="p">,</span>
	<span class="n">ATA_CMD_TRUSTED_SND</span>	<span class="o">=</span> <span class="mh">0x5E</span><span class="p">,</span>
	<span class="n">ATA_CMD_TRUSTED_SND_DMA</span> <span class="o">=</span> <span class="mh">0x5F</span><span class="p">,</span>
	<span class="n">ATA_CMD_PMP_READ</span>	<span class="o">=</span> <span class="mh">0xE4</span><span class="p">,</span>
	<span class="n">ATA_CMD_PMP_WRITE</span>	<span class="o">=</span> <span class="mh">0xE8</span><span class="p">,</span>
	<span class="n">ATA_CMD_CONF_OVERLAY</span>	<span class="o">=</span> <span class="mh">0xB1</span><span class="p">,</span>
	<span class="n">ATA_CMD_SEC_SET_PASS</span>	<span class="o">=</span> <span class="mh">0xF1</span><span class="p">,</span>
	<span class="n">ATA_CMD_SEC_UNLOCK</span>	<span class="o">=</span> <span class="mh">0xF2</span><span class="p">,</span>
	<span class="n">ATA_CMD_SEC_ERASE_PREP</span>	<span class="o">=</span> <span class="mh">0xF3</span><span class="p">,</span>
	<span class="n">ATA_CMD_SEC_ERASE_UNIT</span>	<span class="o">=</span> <span class="mh">0xF4</span><span class="p">,</span>
	<span class="n">ATA_CMD_SEC_FREEZE_LOCK</span>	<span class="o">=</span> <span class="mh">0xF5</span><span class="p">,</span>
	<span class="n">ATA_CMD_SEC_DISABLE_PASS</span> <span class="o">=</span> <span class="mh">0xF6</span><span class="p">,</span>
	<span class="n">ATA_CMD_CONFIG_STREAM</span>	<span class="o">=</span> <span class="mh">0x51</span><span class="p">,</span>
	<span class="n">ATA_CMD_SMART</span>		<span class="o">=</span> <span class="mh">0xB0</span><span class="p">,</span>
	<span class="n">ATA_CMD_MEDIA_LOCK</span>	<span class="o">=</span> <span class="mh">0xDE</span><span class="p">,</span>
	<span class="n">ATA_CMD_MEDIA_UNLOCK</span>	<span class="o">=</span> <span class="mh">0xDF</span><span class="p">,</span>
	<span class="n">ATA_CMD_DSM</span>		<span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">ATA_CMD_CHK_MED_CRD_TYP</span> <span class="o">=</span> <span class="mh">0xD1</span><span class="p">,</span>
	<span class="n">ATA_CMD_CFA_REQ_EXT_ERR</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">ATA_CMD_CFA_WRITE_NE</span>	<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="n">ATA_CMD_CFA_TRANS_SECT</span>	<span class="o">=</span> <span class="mh">0x87</span><span class="p">,</span>
	<span class="n">ATA_CMD_CFA_ERASE</span>	<span class="o">=</span> <span class="mh">0xC0</span><span class="p">,</span>
	<span class="n">ATA_CMD_CFA_WRITE_MULT_NE</span> <span class="o">=</span> <span class="mh">0xCD</span><span class="p">,</span>
	<span class="cm">/* marked obsolete in the ATA/ATAPI-7 spec */</span>
	<span class="n">ATA_CMD_RESTORE</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>

	<span class="cm">/* READ_LOG_EXT pages */</span>
	<span class="n">ATA_LOG_SATA_NCQ</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>

	<span class="cm">/* READ/WRITE LONG (obsolete) */</span>
	<span class="n">ATA_CMD_READ_LONG</span>	<span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>
	<span class="n">ATA_CMD_READ_LONG_ONCE</span>	<span class="o">=</span> <span class="mh">0x23</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_LONG</span>	<span class="o">=</span> <span class="mh">0x32</span><span class="p">,</span>
	<span class="n">ATA_CMD_WRITE_LONG_ONCE</span>	<span class="o">=</span> <span class="mh">0x33</span><span class="p">,</span>

	<span class="cm">/* SETFEATURES stuff */</span>
	<span class="n">SETFEATURES_XFER</span>	<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">XFER_UDMA_7</span>		<span class="o">=</span> <span class="mh">0x47</span><span class="p">,</span>
	<span class="n">XFER_UDMA_6</span>		<span class="o">=</span> <span class="mh">0x46</span><span class="p">,</span>
	<span class="n">XFER_UDMA_5</span>		<span class="o">=</span> <span class="mh">0x45</span><span class="p">,</span>
	<span class="n">XFER_UDMA_4</span>		<span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>
	<span class="n">XFER_UDMA_3</span>		<span class="o">=</span> <span class="mh">0x43</span><span class="p">,</span>
	<span class="n">XFER_UDMA_2</span>		<span class="o">=</span> <span class="mh">0x42</span><span class="p">,</span>
	<span class="n">XFER_UDMA_1</span>		<span class="o">=</span> <span class="mh">0x41</span><span class="p">,</span>
	<span class="n">XFER_UDMA_0</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">XFER_MW_DMA_4</span>		<span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>	<span class="cm">/* CFA only */</span>
	<span class="n">XFER_MW_DMA_3</span>		<span class="o">=</span> <span class="mh">0x23</span><span class="p">,</span>	<span class="cm">/* CFA only */</span>
	<span class="n">XFER_MW_DMA_2</span>		<span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>
	<span class="n">XFER_MW_DMA_1</span>		<span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
	<span class="n">XFER_MW_DMA_0</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">XFER_SW_DMA_2</span>		<span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="n">XFER_SW_DMA_1</span>		<span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="n">XFER_SW_DMA_0</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">XFER_PIO_6</span>		<span class="o">=</span> <span class="mh">0x0E</span><span class="p">,</span>	<span class="cm">/* CFA only */</span>
	<span class="n">XFER_PIO_5</span>		<span class="o">=</span> <span class="mh">0x0D</span><span class="p">,</span>	<span class="cm">/* CFA only */</span>
	<span class="n">XFER_PIO_4</span>		<span class="o">=</span> <span class="mh">0x0C</span><span class="p">,</span>
	<span class="n">XFER_PIO_3</span>		<span class="o">=</span> <span class="mh">0x0B</span><span class="p">,</span>
	<span class="n">XFER_PIO_2</span>		<span class="o">=</span> <span class="mh">0x0A</span><span class="p">,</span>
	<span class="n">XFER_PIO_1</span>		<span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="n">XFER_PIO_0</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">XFER_PIO_SLOW</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="n">SETFEATURES_WC_ON</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* Enable write cache */</span>
	<span class="n">SETFEATURES_WC_OFF</span>	<span class="o">=</span> <span class="mh">0x82</span><span class="p">,</span> <span class="cm">/* Disable write cache */</span>

	<span class="cm">/* Enable/Disable Automatic Acoustic Management */</span>
	<span class="n">SETFEATURES_AAM_ON</span>	<span class="o">=</span> <span class="mh">0x42</span><span class="p">,</span>
	<span class="n">SETFEATURES_AAM_OFF</span>	<span class="o">=</span> <span class="mh">0xC2</span><span class="p">,</span>

	<span class="n">SETFEATURES_SPINUP</span>	<span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span> <span class="cm">/* Spin-up drive */</span>

	<span class="n">SETFEATURES_SATA_ENABLE</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* Enable use of SATA feature */</span>
	<span class="n">SETFEATURES_SATA_DISABLE</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">,</span> <span class="cm">/* Disable use of SATA feature */</span>

	<span class="cm">/* SETFEATURE Sector counts for SATA features */</span>
	<span class="n">SATA_FPDMA_OFFSET</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* FPDMA non-zero buffer offsets */</span>
	<span class="n">SATA_FPDMA_AA</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* FPDMA Setup FIS Auto-Activate */</span>
	<span class="n">SATA_DIPM</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>	<span class="cm">/* Device Initiated Power Management */</span>
	<span class="n">SATA_FPDMA_IN_ORDER</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/* FPDMA in-order data delivery */</span>
	<span class="n">SATA_AN</span>			<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>	<span class="cm">/* Asynchronous Notification */</span>
	<span class="n">SATA_SSP</span>		<span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>	<span class="cm">/* Software Settings Preservation */</span>

	<span class="cm">/* feature values for SET_MAX */</span>
	<span class="n">ATA_SET_MAX_ADDR</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">ATA_SET_MAX_PASSWD</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">ATA_SET_MAX_LOCK</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">ATA_SET_MAX_UNLOCK</span>	<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">ATA_SET_MAX_FREEZE_LOCK</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>

	<span class="cm">/* feature values for DEVICE CONFIGURATION OVERLAY */</span>
	<span class="n">ATA_DCO_RESTORE</span>		<span class="o">=</span> <span class="mh">0xC0</span><span class="p">,</span>
	<span class="n">ATA_DCO_FREEZE_LOCK</span>	<span class="o">=</span> <span class="mh">0xC1</span><span class="p">,</span>
	<span class="n">ATA_DCO_IDENTIFY</span>	<span class="o">=</span> <span class="mh">0xC2</span><span class="p">,</span>
	<span class="n">ATA_DCO_SET</span>		<span class="o">=</span> <span class="mh">0xC3</span><span class="p">,</span>

	<span class="cm">/* feature values for SMART */</span>
	<span class="n">ATA_SMART_ENABLE</span>	<span class="o">=</span> <span class="mh">0xD8</span><span class="p">,</span>
	<span class="n">ATA_SMART_READ_VALUES</span>	<span class="o">=</span> <span class="mh">0xD0</span><span class="p">,</span>
	<span class="n">ATA_SMART_READ_THRESHOLDS</span> <span class="o">=</span> <span class="mh">0xD1</span><span class="p">,</span>

	<span class="cm">/* feature values for Data Set Management */</span>
	<span class="n">ATA_DSM_TRIM</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="cm">/* password used in LBA Mid / LBA High for executing SMART commands */</span>
	<span class="n">ATA_SMART_LBAM_PASS</span>	<span class="o">=</span> <span class="mh">0x4F</span><span class="p">,</span>
	<span class="n">ATA_SMART_LBAH_PASS</span>	<span class="o">=</span> <span class="mh">0xC2</span><span class="p">,</span>

	<span class="cm">/* ATAPI stuff */</span>
	<span class="n">ATAPI_PKT_DMA</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ATAPI_DMADIR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* ATAPI data dir:</span>
<span class="cm">						   0=to device, 1=to host */</span>
	<span class="n">ATAPI_CDB_LEN</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>

	<span class="cm">/* PMP stuff */</span>
	<span class="n">SATA_PMP_MAX_PORTS</span>	<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
	<span class="n">SATA_PMP_CTRL_PORT</span>	<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>

	<span class="n">SATA_PMP_GSCR_DWORDS</span>	<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="n">SATA_PMP_GSCR_PROD_ID</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SATA_PMP_GSCR_REV</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">SATA_PMP_GSCR_PORT_INFO</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">SATA_PMP_GSCR_ERROR</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="n">SATA_PMP_GSCR_ERROR_EN</span>	<span class="o">=</span> <span class="mi">33</span><span class="p">,</span>
	<span class="n">SATA_PMP_GSCR_FEAT</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="n">SATA_PMP_GSCR_FEAT_EN</span>	<span class="o">=</span> <span class="mi">96</span><span class="p">,</span>

	<span class="n">SATA_PMP_PSCR_STATUS</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SATA_PMP_PSCR_ERROR</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">SATA_PMP_PSCR_CONTROL</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

	<span class="n">SATA_PMP_FEAT_BIST</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SATA_PMP_FEAT_PMREQ</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SATA_PMP_FEAT_DYNSSC</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SATA_PMP_FEAT_NOTIFY</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>

	<span class="cm">/* cable types */</span>
	<span class="n">ATA_CBL_NONE</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ATA_CBL_PATA40</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ATA_CBL_PATA80</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ATA_CBL_PATA40_SHORT</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/* 40 wire cable to high UDMA spec */</span>
	<span class="n">ATA_CBL_PATA_UNK</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* don&#39;t know, maybe 80c? */</span>
	<span class="n">ATA_CBL_PATA_IGN</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/* don&#39;t know, ignore cable handling */</span>
	<span class="n">ATA_CBL_SATA</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

	<span class="cm">/* SATA Status and Control Registers */</span>
	<span class="n">SCR_STATUS</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SCR_ERROR</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">SCR_CONTROL</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">SCR_ACTIVE</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">SCR_NOTIFICATION</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>

	<span class="cm">/* SError bits */</span>
	<span class="n">SERR_DATA_RECOVERED</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* recovered data error */</span>
	<span class="n">SERR_COMM_RECOVERED</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* recovered comm failure */</span>
	<span class="n">SERR_DATA</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="cm">/* unrecovered data error */</span>
	<span class="n">SERR_PERSISTENT</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">),</span> <span class="cm">/* persistent data/comm error */</span>
	<span class="n">SERR_PROTOCOL</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="cm">/* protocol violation */</span>
	<span class="n">SERR_INTERNAL</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span> <span class="cm">/* host internal error */</span>
	<span class="n">SERR_PHYRDY_CHG</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="cm">/* PHY RDY changed */</span>
	<span class="n">SERR_PHY_INT_ERR</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* PHY internal error */</span>
	<span class="n">SERR_COMM_WAKE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">),</span> <span class="cm">/* Comm wake */</span>
	<span class="n">SERR_10B_8B_ERR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">),</span> <span class="cm">/* 10b to 8b decode error */</span>
	<span class="n">SERR_DISPARITY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">),</span> <span class="cm">/* Disparity */</span>
	<span class="n">SERR_CRC</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">),</span> <span class="cm">/* CRC error */</span>
	<span class="n">SERR_HANDSHAKE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">),</span> <span class="cm">/* Handshake error */</span>
	<span class="n">SERR_LINK_SEQ_ERR</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">),</span> <span class="cm">/* Link sequence error */</span>
	<span class="n">SERR_TRANS_ST_ERROR</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">),</span> <span class="cm">/* Transport state trans. error */</span>
	<span class="n">SERR_UNRECOG_FIS</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">),</span> <span class="cm">/* Unrecognized FIS */</span>
	<span class="n">SERR_DEV_XCHG</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">),</span> <span class="cm">/* device exchanged */</span>

	<span class="cm">/* struct ata_taskfile flags */</span>
	<span class="n">ATA_TFLAG_LBA48</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* enable 48-bit LBA and &quot;HOB&quot; */</span>
	<span class="n">ATA_TFLAG_ISADDR</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* enable r/w to nsect/lba regs */</span>
	<span class="n">ATA_TFLAG_DEVICE</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* enable r/w to device reg */</span>
	<span class="n">ATA_TFLAG_WRITE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="cm">/* data dir: host-&gt;dev==1 (write) */</span>
	<span class="n">ATA_TFLAG_LBA</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="cm">/* enable LBA */</span>
	<span class="n">ATA_TFLAG_FUA</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="cm">/* enable FUA */</span>
	<span class="n">ATA_TFLAG_POLLING</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="cm">/* set nIEN to 1 and use polling */</span>

	<span class="cm">/* protocol flags */</span>
	<span class="n">ATA_PROT_FLAG_PIO</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* is PIO */</span>
	<span class="n">ATA_PROT_FLAG_DMA</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* is DMA */</span>
	<span class="n">ATA_PROT_FLAG_DATA</span>	<span class="o">=</span> <span class="n">ATA_PROT_FLAG_PIO</span> <span class="o">|</span> <span class="n">ATA_PROT_FLAG_DMA</span><span class="p">,</span>
	<span class="n">ATA_PROT_FLAG_NCQ</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* is NCQ */</span>
	<span class="n">ATA_PROT_FLAG_ATAPI</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="cm">/* is ATAPI */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ata_tf_protocols</span> <span class="p">{</span>
	<span class="cm">/* ATA taskfile protocols */</span>
	<span class="n">ATA_PROT_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* unknown/invalid */</span>
	<span class="n">ATA_PROT_NODATA</span><span class="p">,</span>	<span class="cm">/* no data */</span>
	<span class="n">ATA_PROT_PIO</span><span class="p">,</span>		<span class="cm">/* PIO data xfer */</span>
	<span class="n">ATA_PROT_DMA</span><span class="p">,</span>		<span class="cm">/* DMA */</span>
	<span class="n">ATA_PROT_NCQ</span><span class="p">,</span>		<span class="cm">/* NCQ */</span>
	<span class="n">ATAPI_PROT_NODATA</span><span class="p">,</span>	<span class="cm">/* packet command, no data */</span>
	<span class="n">ATAPI_PROT_PIO</span><span class="p">,</span>		<span class="cm">/* packet command, PIO data xfer*/</span>
	<span class="n">ATAPI_PROT_DMA</span><span class="p">,</span>		<span class="cm">/* packet command with special DMA sauce */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ata_ioctls</span> <span class="p">{</span>
	<span class="n">ATA_IOC_GET_IO32</span>	<span class="o">=</span> <span class="mh">0x309</span><span class="p">,</span>
	<span class="n">ATA_IOC_SET_IO32</span>	<span class="o">=</span> <span class="mh">0x324</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* core structures */</span>

<span class="k">struct</span> <span class="n">ata_bmdma_prd</span> <span class="p">{</span>
	<span class="n">__le32</span>			<span class="n">addr</span><span class="p">;</span>
	<span class="n">__le32</span>			<span class="n">flags_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* ATA_TFLAG_xxx */</span>
	<span class="n">u8</span>			<span class="n">protocol</span><span class="p">;</span>	<span class="cm">/* ATA_PROT_xxx */</span>

	<span class="n">u8</span>			<span class="n">ctl</span><span class="p">;</span>		<span class="cm">/* control reg */</span>

	<span class="n">u8</span>			<span class="n">hob_feature</span><span class="p">;</span>	<span class="cm">/* additional data */</span>
	<span class="n">u8</span>			<span class="n">hob_nsect</span><span class="p">;</span>	<span class="cm">/* to support LBA48 */</span>
	<span class="n">u8</span>			<span class="n">hob_lbal</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">hob_lbam</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">hob_lbah</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">feature</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">nsect</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">lbal</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">lbam</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">lbah</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">device</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">command</span><span class="p">;</span>	<span class="cm">/* IO operation */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * protocol tests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ata_prot_flags</span><span class="p">(</span><span class="n">u8</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATA_PROT_NODATA</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_PROT_PIO</span>:
		<span class="k">return</span> <span class="n">ATA_PROT_FLAG_PIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_PROT_DMA</span>:
		<span class="k">return</span> <span class="n">ATA_PROT_FLAG_DMA</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_PROT_NCQ</span>:
		<span class="k">return</span> <span class="n">ATA_PROT_FLAG_DMA</span> <span class="o">|</span> <span class="n">ATA_PROT_FLAG_NCQ</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATAPI_PROT_NODATA</span>:
		<span class="k">return</span> <span class="n">ATA_PROT_FLAG_ATAPI</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATAPI_PROT_PIO</span>:
		<span class="k">return</span> <span class="n">ATA_PROT_FLAG_ATAPI</span> <span class="o">|</span> <span class="n">ATA_PROT_FLAG_PIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATAPI_PROT_DMA</span>:
		<span class="k">return</span> <span class="n">ATA_PROT_FLAG_ATAPI</span> <span class="o">|</span> <span class="n">ATA_PROT_FLAG_DMA</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_is_atapi</span><span class="p">(</span><span class="n">u8</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_prot_flags</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATA_PROT_FLAG_ATAPI</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_is_nodata</span><span class="p">(</span><span class="n">u8</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">ata_prot_flags</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATA_PROT_FLAG_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_is_pio</span><span class="p">(</span><span class="n">u8</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_prot_flags</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATA_PROT_FLAG_PIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_is_dma</span><span class="p">(</span><span class="n">u8</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_prot_flags</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATA_PROT_FLAG_DMA</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_is_ncq</span><span class="p">(</span><span class="n">u8</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_prot_flags</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATA_PROT_FLAG_NCQ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_is_data</span><span class="p">(</span><span class="n">u8</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_prot_flags</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATA_PROT_FLAG_DATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * id tests</span>
<span class="cm"> */</span>
<span class="cp">#define ata_id_is_ata(id)	(((id)[ATA_ID_CONFIG] &amp; (1 &lt;&lt; 15)) == 0)</span>
<span class="cp">#define ata_id_has_lba(id)	((id)[ATA_ID_CAPABILITY] &amp; (1 &lt;&lt; 9))</span>
<span class="cp">#define ata_id_has_dma(id)	((id)[ATA_ID_CAPABILITY] &amp; (1 &lt;&lt; 8))</span>
<span class="cp">#define ata_id_has_ncq(id)	((id)[76] &amp; (1 &lt;&lt; 8))</span>
<span class="cp">#define ata_id_queue_depth(id)	(((id)[ATA_ID_QUEUE_DEPTH] &amp; 0x1f) + 1)</span>
<span class="cp">#define ata_id_removeable(id)	((id)[ATA_ID_CONFIG] &amp; (1 &lt;&lt; 7))</span>
<span class="cp">#define ata_id_has_atapi_AN(id)	\</span>
<span class="cp">	( (((id)[76] != 0x0000) &amp;&amp; ((id)[76] != 0xffff)) &amp;&amp; \</span>
<span class="cp">	  ((id)[78] &amp; (1 &lt;&lt; 5)) )</span>
<span class="cp">#define ata_id_has_fpdma_aa(id)	\</span>
<span class="cp">	( (((id)[76] != 0x0000) &amp;&amp; ((id)[76] != 0xffff)) &amp;&amp; \</span>
<span class="cp">	  ((id)[78] &amp; (1 &lt;&lt; 2)) )</span>
<span class="cp">#define ata_id_iordy_disable(id) ((id)[ATA_ID_CAPABILITY] &amp; (1 &lt;&lt; 10))</span>
<span class="cp">#define ata_id_has_iordy(id) ((id)[ATA_ID_CAPABILITY] &amp; (1 &lt;&lt; 11))</span>
<span class="cp">#define ata_id_u32(id,n)	\</span>
<span class="cp">	(((u32) (id)[(n) + 1] &lt;&lt; 16) | ((u32) (id)[(n)]))</span>
<span class="cp">#define ata_id_u64(id,n)	\</span>
<span class="cp">	( ((u64) (id)[(n) + 3] &lt;&lt; 48) |	\</span>
<span class="cp">	  ((u64) (id)[(n) + 2] &lt;&lt; 32) |	\</span>
<span class="cp">	  ((u64) (id)[(n) + 1] &lt;&lt; 16) |	\</span>
<span class="cp">	  ((u64) (id)[(n) + 0]) )</span>

<span class="cp">#define ata_id_cdb_intr(id)	(((id)[ATA_ID_CONFIG] &amp; 0x60) == 0x20)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_hipm</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="mi">76</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_dipm</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="mi">78</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_fua</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFSSE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFSSE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_flush</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_flush_enabled</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_flush</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CSF_DEFAULT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFS_ENABLE_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_flush_ext</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_flush_ext_enabled</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_flush_ext</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CSF_DEFAULT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * some Maxtor disks have bit 13 defined incorrectly</span>
<span class="cm">	 * so check bit 10 too</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFS_ENABLE_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x2400</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x2400</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">ata_id_logical_sector_size</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* T13/1699-D Revision 6a, Sep 6, 2008. Page 128.</span>
<span class="cm">	 * IDENTIFY DEVICE data, word 117-118.</span>
<span class="cm">	 * 0xd000 ignores bit 13 (logical:physical &gt; 1)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTOR_SIZE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xd000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x5000</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_LOGICAL_SECTOR_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
			 <span class="o">+</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_LOGICAL_SECTOR_SIZE</span><span class="p">])</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">ATA_SECT_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">ata_id_log2_per_physical_sector</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* T13/1699-D Revision 6a, Sep 6, 2008. Page 128.</span>
<span class="cm">	 * IDENTIFY DEVICE data, word 106.</span>
<span class="cm">	 * 0xe000 ignores bit 12 (logical sector &gt; 512 bytes)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTOR_SIZE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x6000</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTOR_SIZE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Offset of logical sectors relative to physical sectors.</span>
<span class="cm"> *</span>
<span class="cm"> * If device has more than one logical sector per physical sector</span>
<span class="cm"> * (aka 512 byte emulation), vendors might offset the &quot;sector 0&quot; address</span>
<span class="cm"> * so sector 63 is &quot;naturally aligned&quot; - e.g. FAT partition table.</span>
<span class="cm"> * This avoids Read/Mod/Write penalties when using FAT partition table</span>
<span class="cm"> * and updating &quot;well aligned&quot; (FS perspective) physical sectors on every</span>
<span class="cm"> * transaction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">ata_id_logical_sector_offset</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
	 <span class="n">u8</span> <span class="n">log2_per_phys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">word_209</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="mi">209</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">log2_per_phys</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">word_209</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">first</span> <span class="o">=</span> <span class="n">word_209</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log2_per_phys</span><span class="p">)</span> <span class="o">-</span> <span class="n">first</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_lba48</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_id_u64</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ATA_ID_LBA_CAPACITY_2</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_lba48_enabled</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_lba48</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CSF_DEFAULT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFS_ENABLE_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_hpa_enabled</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Yes children, word 83 valid bits cover word 82 data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* And 87 covers 85-87 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CSF_DEFAULT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* Check command sets enabled as well as supported */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFS_ENABLE_1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_wcache</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Yes children, word 83 valid bits cover word 82 data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_pm</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_rahead_enabled</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CSF_DEFAULT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFS_ENABLE_1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_wcache_enabled</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CSF_DEFAULT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFS_ENABLE_1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_id_major_version	-	get ATA level of drive</span>
<span class="cm"> *	@id: Identify data</span>
<span class="cm"> *</span>
<span class="cm"> *	Caveats:</span>
<span class="cm"> *		ATA-1 considers identify optional</span>
<span class="cm"> *		ATA-2 introduces mandatory identify</span>
<span class="cm"> *		ATA-3 introduces word 80 and accurate reporting</span>
<span class="cm"> *</span>
<span class="cm"> *	The practical impact of this is that ata_id_major_version cannot</span>
<span class="cm"> *	reliably report on drives below ATA3.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ata_id_major_version</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MAJOR_VER</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mver</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="n">mver</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">mver</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MAJOR_VER</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mver</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mver</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_is_sata</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * See if word 93 is 0 AND drive is at least ATA-5 compatible</span>
<span class="cm">	 * verifying that word 80 by casting it to a signed type --</span>
<span class="cm">	 * this trick allows us to filter out the reserved values of</span>
<span class="cm">	 * 0x0000 and 0xffff along with the earlier ATA revisions...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HW_CONFIG</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MAJOR_VER</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x0020</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_tpm</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The TPM bits are only valid on ATA8 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_major_version</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_dword_io</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ATA 8 reuses this flag for &quot;trusted&quot; computing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_major_version</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_DWORD_IO</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_unload</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_major_version</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFSSE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4000</span> <span class="o">&amp;&amp;</span>
	    <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CFSSE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_wwn</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CSF_DEFAULT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC100</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4100</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_id_form_factor</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="mi">168</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_major_version</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_id_rotation_rate</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="mi">217</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_major_version</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mh">0x401</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_trim</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_major_version</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_DATA_SET_MGMT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_has_zero_after_trim</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* DSM supported, deterministic read, and read zero after trim set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_trim</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_ADDITIONAL_SUPP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x4020</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4020</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_current_chs_valid</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* For ATA-1 devices, if the INITIALIZE DEVICE PARAMETERS command</span>
<span class="cm">	   has not been issued to the device then the values of</span>
<span class="cm">	   id[ATA_ID_CUR_CYLS] to id[ATA_ID_CUR_SECTORS] are vendor specific. */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FIELD_VALID</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="cm">/* Current translation valid */</span>
		<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_CYLS</span><span class="p">]</span> <span class="o">&amp;&amp;</span>  <span class="cm">/* cylinders in current translation */</span>
		<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_HEADS</span><span class="p">]</span> <span class="o">&amp;&amp;</span>  <span class="cm">/* heads in current translation */</span>
		<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_HEADS</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span>
		<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_SECTORS</span><span class="p">];</span>    <span class="cm">/* sectors in current translation */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_is_cfa</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CONFIG</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x848A</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* Traditional CF */</span>
	    <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CONFIG</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x844A</span><span class="p">))</span>	<span class="cm">/* Delkin Devices CF */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * CF specs don&#39;t require specific value in the word 0 anymore and yet</span>
<span class="cm">	 * they forbid to report the ATA version in the word 80 and require the</span>
<span class="cm">	 * CFA feature set support to be indicated in the word 83 in this case.</span>
<span class="cm">	 * Unfortunately, some cards only follow either of this requirements,</span>
<span class="cm">	 * and while those that don&#39;t indicate CFA feature support need some</span>
<span class="cm">	 * sort of quirk list, it seems impractical for the ones that do...</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC004</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4004</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_is_ssd</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_ROT_SPEED</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_pio_need_iordy</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* CF spec. r4.1 Table 22 says no IORDY on PIO5 and PIO6. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">ata_id_is_cfa</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* For PIO3 and higher it is mandatory. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/* Turn it on when possible. */</span>
	<span class="k">return</span> <span class="n">ata_id_has_iordy</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_drive_40wire</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_is_sata</span><span class="p">(</span><span class="n">dev_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* SATA */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_id</span><span class="p">[</span><span class="n">ATA_ID_HW_CONFIG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x6000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* 80 wire */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_drive_40wire_relaxed</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_id</span><span class="p">[</span><span class="n">ATA_ID_HW_CONFIG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x2000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* 80 wire */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">atapi_cdb_len</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">[</span><span class="n">ATA_ID_CONFIG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="k">return</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">atapi_command_packet_set</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dev_id</span><span class="p">[</span><span class="n">ATA_ID_CONFIG</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">atapi_id_dmadir</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_id_major_version</span><span class="p">(</span><span class="n">dev_id</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_id</span><span class="p">[</span><span class="mi">62</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ata_id_is_lba_capacity_ok() performs a sanity check on</span>
<span class="cm"> * the claimed LBA capacity value for the device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if LBA capacity looks sensible, 0 otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * It is called only once for each device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_id_is_lba_capacity_ok</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lba_sects</span><span class="p">,</span> <span class="n">chs_sects</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>

	<span class="cm">/* No non-LBA info .. so valid! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">lba_sects</span> <span class="o">=</span> <span class="n">ata_id_u32</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ATA_ID_LBA_CAPACITY</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ATA spec tells large drives to return</span>
<span class="cm">	 * C/H/S = 16383/16/63 independent of their size.</span>
<span class="cm">	 * Some drives can be jumpered to use 15 heads instead of 16.</span>
<span class="cm">	 * Some drives can be jumpered to use 4092 cyls instead of 16383.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16383</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4092</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_CYLS</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16383</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">]</span> <span class="o">==</span> <span class="mi">63</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]</span> <span class="o">==</span> <span class="mi">15</span> <span class="o">||</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lba_sects</span> <span class="o">&gt;=</span> <span class="mi">16383</span> <span class="o">*</span> <span class="mi">63</span> <span class="o">*</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">chs_sects</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">]</span> <span class="o">*</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]</span> <span class="o">*</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">];</span>

	<span class="cm">/* perform a rough sanity check on lba_sects: within 10% is OK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lba_sects</span> <span class="o">-</span> <span class="n">chs_sects</span> <span class="o">&lt;</span> <span class="n">chs_sects</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* some drives have the word order reversed */</span>
	<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba_sects</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">lba_sects</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">lba_sects</span> <span class="o">=</span> <span class="n">head</span> <span class="o">|</span> <span class="p">(</span><span class="n">tail</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lba_sects</span> <span class="o">-</span> <span class="n">chs_sects</span> <span class="o">&lt;</span> <span class="n">chs_sects</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_LBA_CAPACITY</span><span class="p">]</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">lba_sects</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>	<span class="cm">/* LBA capacity is (now) good */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* LBA capacity value may be bad */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ata_id_to_hd_driveid</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="cm">/* accessed in struct hd_driveid as 8-bit values */</span>
	<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MAX_MULTSECT</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MAX_MULTSECT</span><span class="p">]);</span>
	<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CAPABILITY</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CAPABILITY</span><span class="p">]);</span>
	<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_PIO_MODES</span><span class="p">]</span> <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_PIO_MODES</span><span class="p">]);</span>
	<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_DMA_MODES</span><span class="p">]</span> <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_DMA_MODES</span><span class="p">]);</span>
	<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MULTSECT</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MULTSECT</span><span class="p">]);</span>

	<span class="cm">/* as 32-bit values */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_LBA_CAPACITY</span><span class="p">]</span> <span class="o">=</span> <span class="n">ata_id_u32</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ATA_ID_LBA_CAPACITY</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SPG</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">ata_id_u32</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ATA_ID_SPG</span><span class="p">);</span>

	<span class="cm">/* as 64-bit value */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_LBA_CAPACITY_2</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">ata_id_u64</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ATA_ID_LBA_CAPACITY_2</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write LBA Range Entries to the buffer that will cover the extent from</span>
<span class="cm"> * sector to sector + count.  This is used for TRIM and for ADD LBA(S)</span>
<span class="cm"> * TO NV CACHE PINNED SET.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">ata_set_lba_range_entries</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_buffer</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le64</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">_buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">used_bytes</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_size</span> <span class="o">/</span> <span class="mi">8</span> <span class="p">)</span> <span class="p">{</span> <span class="cm">/* 6-byte LBA + 2-byte range per entry */</span>
		<span class="n">u64</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mh">0xffff</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="n">count</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">__cpu_to_le64</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">sector</span> <span class="o">+=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">used_bytes</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">used_bytes</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">used_bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_multi_taskfile</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_READ_MULTI</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_WRITE_MULTI</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_READ_MULTI_EXT</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_WRITE_MULTI_EXT</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_WRITE_MULTI_FUA_EXT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ata_ok</span><span class="p">(</span><span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRDY</span> <span class="o">|</span> <span class="n">ATA_DF</span> <span class="o">|</span> <span class="n">ATA_DRQ</span> <span class="o">|</span> <span class="n">ATA_ERR</span><span class="p">))</span>
			<span class="o">==</span> <span class="n">ATA_DRDY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">lba_28_ok</span><span class="p">(</span><span class="n">u64</span> <span class="n">block</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n_block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check the ending block number: must be LESS THAN 0x0fffffff */</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">block</span> <span class="o">+</span> <span class="n">n_block</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n_block</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">lba_48_ok</span><span class="p">(</span><span class="n">u64</span> <span class="n">block</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n_block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check the ending block number */</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">block</span> <span class="o">+</span> <span class="n">n_block</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n_block</span> <span class="o">&lt;=</span> <span class="mi">65536</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define sata_pmp_gscr_vendor(gscr)	((gscr)[SATA_PMP_GSCR_PROD_ID] &amp; 0xffff)</span>
<span class="cp">#define sata_pmp_gscr_devid(gscr)	((gscr)[SATA_PMP_GSCR_PROD_ID] &gt;&gt; 16)</span>
<span class="cp">#define sata_pmp_gscr_rev(gscr)		(((gscr)[SATA_PMP_GSCR_REV] &gt;&gt; 8) &amp; 0xff)</span>
<span class="cp">#define sata_pmp_gscr_ports(gscr)	((gscr)[SATA_PMP_GSCR_PORT_INFO] &amp; 0xf)</span>

<span class="cp">#endif </span><span class="cm">/* __LINUX_ATA_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
