<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › percpu-defs.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>percpu-defs.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _LINUX_PERCPU_DEFS_H</span>
<span class="cp">#define _LINUX_PERCPU_DEFS_H</span>

<span class="cm">/*</span>
<span class="cm"> * Base implementations of per-CPU variable declarations and definitions, where</span>
<span class="cm"> * the section in which the variable is to be placed is provided by the</span>
<span class="cm"> * &#39;sec&#39; argument.  This may be used to affect the parameters governing the</span>
<span class="cm"> * variable&#39;s storage.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE!  The sections for the DECLARE and for the DEFINE must match, lest</span>
<span class="cm"> * linkage errors occur due the compiler generating the wrong code to access</span>
<span class="cm"> * that section.</span>
<span class="cm"> */</span>
<span class="cp">#define __PCPU_ATTRS(sec)						\</span>
<span class="cp">	__percpu __attribute__((section(PER_CPU_BASE_SECTION sec)))	\</span>
<span class="cp">	PER_CPU_ATTRIBUTES</span>

<span class="cp">#define __PCPU_DUMMY_ATTRS						\</span>
<span class="cp">	__attribute__((section(&quot;.discard&quot;), unused))</span>

<span class="cm">/*</span>
<span class="cm"> * Macro which verifies @ptr is a percpu pointer without evaluating</span>
<span class="cm"> * @ptr.  This is to be used in percpu accessors to verify that the</span>
<span class="cm"> * input parameter is a percpu pointer.</span>
<span class="cm"> */</span>
<span class="cp">#define __verify_pcpu_ptr(ptr)	do {					\</span>
<span class="cp">	const void __percpu *__vpp_verify = (typeof(ptr))NULL;		\</span>
<span class="cp">	(void)__vpp_verify;						\</span>
<span class="cp">} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * s390 and alpha modules require percpu variables to be defined as</span>
<span class="cm"> * weak to force the compiler to generate GOT based external</span>
<span class="cm"> * references for them.  This is necessary because percpu sections</span>
<span class="cm"> * will be located outside of the usually addressable area.</span>
<span class="cm"> *</span>
<span class="cm"> * This definition puts the following two extra restrictions when</span>
<span class="cm"> * defining percpu variables.</span>
<span class="cm"> *</span>
<span class="cm"> * 1. The symbol must be globally unique, even the static ones.</span>
<span class="cm"> * 2. Static percpu variables cannot be defined inside a function.</span>
<span class="cm"> *</span>
<span class="cm"> * Archs which need weak percpu definitions should define</span>
<span class="cm"> * ARCH_NEEDS_WEAK_PER_CPU in asm/percpu.h when necessary.</span>
<span class="cm"> *</span>
<span class="cm"> * To ensure that the generic code observes the above two</span>
<span class="cm"> * restrictions, if CONFIG_DEBUG_FORCE_WEAK_PER_CPU is set weak</span>
<span class="cm"> * definition is used for all cases.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(ARCH_NEEDS_WEAK_PER_CPU) || defined(CONFIG_DEBUG_FORCE_WEAK_PER_CPU)</span>
<span class="cm">/*</span>
<span class="cm"> * __pcpu_scope_* dummy variable is used to enforce scope.  It</span>
<span class="cm"> * receives the static modifier when it&#39;s used in front of</span>
<span class="cm"> * DEFINE_PER_CPU() and will trigger build failure if</span>
<span class="cm"> * DECLARE_PER_CPU() is used for the same variable.</span>
<span class="cm"> *</span>
<span class="cm"> * __pcpu_unique_* dummy variable is used to enforce symbol uniqueness</span>
<span class="cm"> * such that hidden weak symbol collision, which will cause unrelated</span>
<span class="cm"> * variables to share the same address, can be detected during build.</span>
<span class="cm"> */</span>
<span class="cp">#define DECLARE_PER_CPU_SECTION(type, name, sec)			\</span>
<span class="cp">	extern __PCPU_DUMMY_ATTRS char __pcpu_scope_##name;		\</span>
<span class="cp">	extern __PCPU_ATTRS(sec) __typeof__(type) name</span>

<span class="cp">#define DEFINE_PER_CPU_SECTION(type, name, sec)				\</span>
<span class="cp">	__PCPU_DUMMY_ATTRS char __pcpu_scope_##name;			\</span>
<span class="cp">	extern __PCPU_DUMMY_ATTRS char __pcpu_unique_##name;		\</span>
<span class="cp">	__PCPU_DUMMY_ATTRS char __pcpu_unique_##name;			\</span>
<span class="cp">	__PCPU_ATTRS(sec) PER_CPU_DEF_ATTRIBUTES __weak			\</span>
<span class="cp">	__typeof__(type) name</span>
<span class="cp">#else</span>
<span class="cm">/*</span>
<span class="cm"> * Normal declaration and definition macros.</span>
<span class="cm"> */</span>
<span class="cp">#define DECLARE_PER_CPU_SECTION(type, name, sec)			\</span>
<span class="cp">	extern __PCPU_ATTRS(sec) __typeof__(type) name</span>

<span class="cp">#define DEFINE_PER_CPU_SECTION(type, name, sec)				\</span>
<span class="cp">	__PCPU_ATTRS(sec) PER_CPU_DEF_ATTRIBUTES			\</span>
<span class="cp">	__typeof__(type) name</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Variant on the per-CPU variable declaration/definition theme used for</span>
<span class="cm"> * ordinary per-CPU variables.</span>
<span class="cm"> */</span>
<span class="cp">#define DECLARE_PER_CPU(type, name)					\</span>
<span class="cp">	DECLARE_PER_CPU_SECTION(type, name, &quot;&quot;)</span>

<span class="cp">#define DEFINE_PER_CPU(type, name)					\</span>
<span class="cp">	DEFINE_PER_CPU_SECTION(type, name, &quot;&quot;)</span>

<span class="cm">/*</span>
<span class="cm"> * Declaration/definition used for per-CPU variables that must come first in</span>
<span class="cm"> * the set of variables.</span>
<span class="cm"> */</span>
<span class="cp">#define DECLARE_PER_CPU_FIRST(type, name)				\</span>
<span class="cp">	DECLARE_PER_CPU_SECTION(type, name, PER_CPU_FIRST_SECTION)</span>

<span class="cp">#define DEFINE_PER_CPU_FIRST(type, name)				\</span>
<span class="cp">	DEFINE_PER_CPU_SECTION(type, name, PER_CPU_FIRST_SECTION)</span>

<span class="cm">/*</span>
<span class="cm"> * Declaration/definition used for per-CPU variables that must be cacheline</span>
<span class="cm"> * aligned under SMP conditions so that, whilst a particular instance of the</span>
<span class="cm"> * data corresponds to a particular CPU, inefficiencies due to direct access by</span>
<span class="cm"> * other CPUs are reduced by preventing the data from unnecessarily spanning</span>
<span class="cm"> * cachelines.</span>
<span class="cm"> *</span>
<span class="cm"> * An example of this would be statistical data, where each CPU&#39;s set of data</span>
<span class="cm"> * is updated by that CPU alone, but the data from across all CPUs is collated</span>
<span class="cm"> * by a CPU processing a read from a proc file.</span>
<span class="cm"> */</span>
<span class="cp">#define DECLARE_PER_CPU_SHARED_ALIGNED(type, name)			\</span>
<span class="cp">	DECLARE_PER_CPU_SECTION(type, name, PER_CPU_SHARED_ALIGNED_SECTION) \</span>
<span class="cp">	____cacheline_aligned_in_smp</span>

<span class="cp">#define DEFINE_PER_CPU_SHARED_ALIGNED(type, name)			\</span>
<span class="cp">	DEFINE_PER_CPU_SECTION(type, name, PER_CPU_SHARED_ALIGNED_SECTION) \</span>
<span class="cp">	____cacheline_aligned_in_smp</span>

<span class="cp">#define DECLARE_PER_CPU_ALIGNED(type, name)				\</span>
<span class="cp">	DECLARE_PER_CPU_SECTION(type, name, PER_CPU_ALIGNED_SECTION)	\</span>
<span class="cp">	____cacheline_aligned</span>

<span class="cp">#define DEFINE_PER_CPU_ALIGNED(type, name)				\</span>
<span class="cp">	DEFINE_PER_CPU_SECTION(type, name, PER_CPU_ALIGNED_SECTION)	\</span>
<span class="cp">	____cacheline_aligned</span>

<span class="cm">/*</span>
<span class="cm"> * Declaration/definition used for per-CPU variables that must be page aligned.</span>
<span class="cm"> */</span>
<span class="cp">#define DECLARE_PER_CPU_PAGE_ALIGNED(type, name)			\</span>
<span class="cp">	DECLARE_PER_CPU_SECTION(type, name, &quot;..page_aligned&quot;)		\</span>
<span class="cp">	__aligned(PAGE_SIZE)</span>

<span class="cp">#define DEFINE_PER_CPU_PAGE_ALIGNED(type, name)				\</span>
<span class="cp">	DEFINE_PER_CPU_SECTION(type, name, &quot;..page_aligned&quot;)		\</span>
<span class="cp">	__aligned(PAGE_SIZE)</span>

<span class="cm">/*</span>
<span class="cm"> * Declaration/definition used for per-CPU variables that must be read mostly.</span>
<span class="cm"> */</span>
<span class="cp">#define DECLARE_PER_CPU_READ_MOSTLY(type, name)			\</span>
<span class="cp">	DECLARE_PER_CPU_SECTION(type, name, &quot;..readmostly&quot;)</span>

<span class="cp">#define DEFINE_PER_CPU_READ_MOSTLY(type, name)				\</span>
<span class="cp">	DEFINE_PER_CPU_SECTION(type, name, &quot;..readmostly&quot;)</span>

<span class="cm">/*</span>
<span class="cm"> * Intermodule exports for per-CPU variables.  sparse forgets about</span>
<span class="cm"> * address space across EXPORT_SYMBOL(), change EXPORT_SYMBOL() to</span>
<span class="cm"> * noop if __CHECKER__.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __CHECKER__</span>
<span class="cp">#define EXPORT_PER_CPU_SYMBOL(var) EXPORT_SYMBOL(var)</span>
<span class="cp">#define EXPORT_PER_CPU_SYMBOL_GPL(var) EXPORT_SYMBOL_GPL(var)</span>
<span class="cp">#else</span>
<span class="cp">#define EXPORT_PER_CPU_SYMBOL(var)</span>
<span class="cp">#define EXPORT_PER_CPU_SYMBOL_GPL(var)</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_PERCPU_DEFS_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
