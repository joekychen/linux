<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › hdlcdrv.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hdlcdrv.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * hdlcdrv.h  -- HDLC packet radio network driver.</span>
<span class="cm"> * The Linux soundcard driver for 1200 baud and 9600 baud packet radio</span>
<span class="cm"> * (C) 1996-1998 by Thomas Sailer, HB9JNX/AE4WA</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _HDLCDRV_H</span>
<span class="cp">#define _HDLCDRV_H</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * structs for the IOCTL commands</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">hdlcdrv_params</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seriobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pariobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">midiiobase</span><span class="p">;</span>
<span class="p">};</span>	

<span class="k">struct</span> <span class="n">hdlcdrv_channel_params</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">tx_delay</span><span class="p">;</span>  <span class="cm">/* the transmitter keyup delay in 10ms units */</span>
	<span class="kt">int</span> <span class="n">tx_tail</span><span class="p">;</span>   <span class="cm">/* the transmitter keyoff delay in 10ms units */</span>
	<span class="kt">int</span> <span class="n">slottime</span><span class="p">;</span>  <span class="cm">/* the slottime in 10ms; usually 10 = 100ms */</span>
	<span class="kt">int</span> <span class="n">ppersist</span><span class="p">;</span>  <span class="cm">/* the p-persistence 0..255 */</span>
	<span class="kt">int</span> <span class="n">fulldup</span><span class="p">;</span>   <span class="cm">/* some driver do not support full duplex, setting */</span>
	               <span class="cm">/* this just makes them send even if DCD is on */</span>
<span class="p">};</span>	

<span class="k">struct</span> <span class="n">hdlcdrv_old_channel_state</span> <span class="p">{</span>
  	<span class="kt">int</span> <span class="n">ptt</span><span class="p">;</span>
  	<span class="kt">int</span> <span class="n">dcd</span><span class="p">;</span>
  	<span class="kt">int</span> <span class="n">ptt_keyed</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdlcdrv_channel_state</span> <span class="p">{</span>
 	<span class="kt">int</span> <span class="n">ptt</span><span class="p">;</span>
 	<span class="kt">int</span> <span class="n">dcd</span><span class="p">;</span>
 	<span class="kt">int</span> <span class="n">ptt_keyed</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_packets</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_errors</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_packets</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_errors</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdlcdrv_params</span> <span class="n">mp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hdlcdrv_channel_params</span> <span class="n">cp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hdlcdrv_channel_state</span> <span class="n">cs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hdlcdrv_old_channel_state</span> <span class="n">ocs</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">calibrate</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">modename</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">drivername</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * ioctl values</span>
<span class="cm"> */</span>
<span class="cp">#define HDLCDRVCTL_GETMODEMPAR       0</span>
<span class="cp">#define HDLCDRVCTL_SETMODEMPAR       1</span>
<span class="cp">#define HDLCDRVCTL_MODEMPARMASK      2  </span><span class="cm">/* not handled by hdlcdrv */</span><span class="cp"></span>
<span class="cp">#define HDLCDRVCTL_GETCHANNELPAR    10</span>
<span class="cp">#define HDLCDRVCTL_SETCHANNELPAR    11</span>
<span class="cp">#define HDLCDRVCTL_OLDGETSTAT       20</span>
<span class="cp">#define HDLCDRVCTL_CALIBRATE        21</span>
<span class="cp">#define HDLCDRVCTL_GETSTAT          22</span>

<span class="cm">/*</span>
<span class="cm"> * these are mainly for debugging purposes</span>
<span class="cm"> */</span>
<span class="cp">#define HDLCDRVCTL_GETSAMPLES       30</span>
<span class="cp">#define HDLCDRVCTL_GETBITS          31</span>

<span class="cm">/*</span>
<span class="cm"> * not handled by hdlcdrv, but by its depending drivers</span>
<span class="cm"> */</span>
<span class="cp">#define HDLCDRVCTL_GETMODE          40</span>
<span class="cp">#define HDLCDRVCTL_SETMODE          41</span>
<span class="cp">#define HDLCDRVCTL_MODELIST         42</span>
<span class="cp">#define HDLCDRVCTL_DRIVERNAME       43</span>

<span class="cm">/*</span>
<span class="cm"> * mask of needed modem parameters, returned by HDLCDRVCTL_MODEMPARMASK</span>
<span class="cm"> */</span>
<span class="cp">#define HDLCDRV_PARMASK_IOBASE      (1&lt;&lt;0)</span>
<span class="cp">#define HDLCDRV_PARMASK_IRQ         (1&lt;&lt;1)</span>
<span class="cp">#define HDLCDRV_PARMASK_DMA         (1&lt;&lt;2)</span>
<span class="cp">#define HDLCDRV_PARMASK_DMA2        (1&lt;&lt;3)</span>
<span class="cp">#define HDLCDRV_PARMASK_SERIOBASE   (1&lt;&lt;4)</span>
<span class="cp">#define HDLCDRV_PARMASK_PARIOBASE   (1&lt;&lt;5)</span>
<span class="cp">#define HDLCDRV_PARMASK_MIDIIOBASE  (1&lt;&lt;6)</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#define HDLCDRV_MAGIC      0x5ac6e778</span>
<span class="cp">#define HDLCDRV_HDLCBUFFER  32 </span><span class="cm">/* should be a power of 2 for speed reasons */</span><span class="cp"></span>
<span class="cp">#define HDLCDRV_BITBUFFER  256 </span><span class="cm">/* should be a power of 2 for speed reasons */</span><span class="cp"></span>
<span class="cp">#undef HDLCDRV_LOOPBACK  </span><span class="cm">/* define for HDLC debugging purposes */</span><span class="cp"></span>
<span class="cp">#define HDLCDRV_DEBUG</span>

<span class="cm">/* maximum packet length, excluding CRC */</span>
<span class="cp">#define HDLCDRV_MAXFLEN             400	</span>


<span class="k">struct</span> <span class="n">hdlcdrv_hdlcbuffer</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rd</span><span class="p">,</span> <span class="n">wr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">buf</span><span class="p">[</span><span class="n">HDLCDRV_HDLCBUFFER</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#ifdef HDLCDRV_DEBUG</span>
<span class="k">struct</span> <span class="n">hdlcdrv_bitbuffer</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shreg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">HDLCDRV_BITBUFFER</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlcdrv_add_bitbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_bitbuffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> 
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">shreg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">shreg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">shreg</span> <span class="o">|=</span> <span class="p">(</span><span class="o">!!</span><span class="n">bit</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">shreg</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">shreg</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlcdrv_add_bitbuffer_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_bitbuffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> 
					      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">wr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>

<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* HDLCDRV_DEBUG */</span><span class="cp"></span>

<span class="cm">/* -------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * Information that need to be kept for each driver. </span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">hdlcdrv_ops</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * first some informations needed by the hdlcdrv routines</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">drvname</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * the routines called by the hdlcdrv routines</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="p">,</span> 
		     <span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">magic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opened</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">hdlcdrv_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bitrate</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">par</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hdlcdrv_pttoutput</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dma2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">seriobase</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pariobase</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">midiiobase</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ptt_out</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hdlcdrv_channel_params</span> <span class="n">ch_params</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hdlcdrv_hdlcrx</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdlcdrv_hdlcbuffer</span> <span class="n">hbuf</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">in_hdlc_rx</span><span class="p">;</span>
		<span class="cm">/* 0 = sync hunt, != 0 receiving */</span>
		<span class="kt">int</span> <span class="n">rx_state</span><span class="p">;</span>	
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitstream</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitbuf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">numbits</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dcd</span><span class="p">;</span>
		
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">HDLCDRV_MAXFLEN</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">hdlcrx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hdlcdrv_hdlctx</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdlcdrv_hdlcbuffer</span> <span class="n">hbuf</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">in_hdlc_tx</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * 0 = send flags</span>
<span class="cm">		 * 1 = send txtail (flags)</span>
<span class="cm">		 * 2 = send packet</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">tx_state</span><span class="p">;</span>	
		<span class="kt">int</span> <span class="n">numflags</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitstream</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ptt</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">calibrate</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">slotcnt</span><span class="p">;</span>

		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitbuf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">numbits</span><span class="p">;</span>
		
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">HDLCDRV_MAXFLEN</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">hdlctx</span><span class="p">;</span>

<span class="cp">#ifdef HDLCDRV_DEBUG</span>
	<span class="k">struct</span> <span class="n">hdlcdrv_bitbuffer</span> <span class="n">bitbuf_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdlcdrv_bitbuffer</span> <span class="n">bitbuf_hdlc</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* HDLCDRV_DEBUG */</span><span class="cp"></span>

	<span class="kt">int</span> <span class="n">ptt_keyed</span><span class="p">;</span>

	<span class="cm">/* queued skb for transmission */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hdlcdrv_hbuf_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_hdlcbuffer</span> <span class="o">*</span><span class="n">hb</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">!</span><span class="p">((</span><span class="n">HDLCDRV_HDLCBUFFER</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">-</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">)</span> <span class="o">%</span> <span class="n">HDLCDRV_HDLCBUFFER</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hdlcdrv_hbuf_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_hdlcbuffer</span> <span class="o">*</span><span class="n">hb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">==</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">hdlcdrv_hbuf_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_hdlcbuffer</span> <span class="o">*</span><span class="n">hb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">newr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">==</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">newr</span> <span class="o">=</span> <span class="p">(</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">rd</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">HDLCDRV_HDLCBUFFER</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">];</span>
		<span class="n">hb</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="n">newr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlcdrv_hbuf_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_hdlcbuffer</span> <span class="o">*</span><span class="n">hb</span><span class="p">,</span> 
				    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">newp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">newp</span> <span class="o">=</span> <span class="p">(</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">wr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">HDLCDRV_HDLCBUFFER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newp</span> <span class="o">!=</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">)</span> <span class="p">{</span> 
		<span class="n">hb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">hb</span><span class="o">-&gt;</span><span class="n">wr</span> <span class="o">=</span> <span class="n">newp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlcdrv_putbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdlcdrv_hbuf_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlcrx</span><span class="p">.</span><span class="n">hbuf</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hdlcdrv_getbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdlcdrv_hbuf_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlctx</span><span class="p">.</span><span class="n">hbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlctx</span><span class="p">.</span><span class="n">calibrate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlctx</span><span class="p">.</span><span class="n">calibrate</span><span class="o">--</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlctx</span><span class="p">.</span><span class="n">ptt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> 
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hdlcdrv_hbuf_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlctx</span><span class="p">.</span><span class="n">hbuf</span><span class="p">);</span>
<span class="cp">#ifdef HDLCDRV_LOOPBACK</span>
	<span class="n">hdlcdrv_hbuf_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlcrx</span><span class="p">.</span><span class="n">hbuf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* HDLCDRV_LOOPBACK */</span><span class="cp"></span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlcdrv_channelbit</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef HDLCDRV_DEBUG</span>
	<span class="n">hdlcdrv_add_bitbuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">bitbuf_channel</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* HDLCDRV_DEBUG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlcdrv_setdcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlcrx</span><span class="p">.</span><span class="n">dcd</span> <span class="o">=</span> <span class="o">!!</span><span class="n">dcd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hdlcdrv_ptt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlctx</span><span class="p">.</span><span class="n">ptt</span> <span class="o">||</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hdlctx</span><span class="p">.</span><span class="n">calibrate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="kt">void</span> <span class="n">hdlcdrv_receiver</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hdlcdrv_transmitter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hdlcdrv_arbitrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="o">*</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">hdlcdrv_register</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">hdlcdrv_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">privsize</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baseaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> 
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hdlcdrv_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>



<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="cp">#endif </span><span class="cm">/* _HDLCDRV_H */</span><span class="cp"></span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
