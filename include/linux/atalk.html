<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › atalk.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>atalk.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __LINUX_ATALK_H__</span>
<span class="cp">#define __LINUX_ATALK_H__</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * AppleTalk networking structures</span>
<span class="cm"> *</span>
<span class="cm"> * The following are directly referenced from the University Of Michigan</span>
<span class="cm"> * netatalk for compatibility reasons.</span>
<span class="cm"> */</span>
<span class="cp">#define ATPORT_FIRST	1</span>
<span class="cp">#define ATPORT_RESERVED	128</span>
<span class="cp">#define ATPORT_LAST	254		</span><span class="cm">/* 254 is only legal on localtalk */</span><span class="cp"> </span>
<span class="cp">#define ATADDR_ANYNET	(__u16)0</span>
<span class="cp">#define ATADDR_ANYNODE	(__u8)0</span>
<span class="cp">#define ATADDR_ANYPORT  (__u8)0</span>
<span class="cp">#define ATADDR_BCAST	(__u8)255</span>
<span class="cp">#define DDP_MAXSZ	587</span>
<span class="cp">#define DDP_MAXHOPS     15		</span><span class="cm">/* 4 bits of hop counter */</span><span class="cp"></span>

<span class="cp">#define SIOCATALKDIFADDR       (SIOCPROTOPRIVATE + 0)</span>

<span class="k">struct</span> <span class="n">atalk_addr</span> <span class="p">{</span>
	<span class="n">__be16</span>	<span class="n">s_net</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">s_node</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sockaddr_at</span> <span class="p">{</span>
	<span class="n">__kernel_sa_family_t</span> <span class="n">sat_family</span><span class="p">;</span>
	<span class="n">__u8</span>		  <span class="n">sat_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atalk_addr</span> <span class="n">sat_addr</span><span class="p">;</span>
	<span class="kt">char</span>		  <span class="n">sat_zero</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">atalk_netrange</span> <span class="p">{</span>
	<span class="n">__u8</span>	<span class="n">nr_phase</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">nr_firstnet</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">nr_lastnet</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="k">struct</span> <span class="n">atalk_route</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atalk_addr</span>  <span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atalk_addr</span>  <span class="n">gateway</span><span class="p">;</span>
	<span class="kt">int</span>		   <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atalk_route</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	struct atalk_iface - AppleTalk Interface</span>
<span class="cm"> *	@dev - Network device associated with this interface</span>
<span class="cm"> *	@address - Our address</span>
<span class="cm"> *	@status - What are we doing?</span>
<span class="cm"> *	@nets - Associated direct netrange</span>
<span class="cm"> *	@next - next element in the list of interfaces</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">atalk_iface</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atalk_addr</span>	<span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>
<span class="cp">#define ATIF_PROBE	1		</span><span class="cm">/* Probing for an address */</span><span class="cp"></span>
<span class="cp">#define ATIF_PROBE_FAIL	2		</span><span class="cm">/* Probe collided */</span><span class="cp"></span>
	<span class="k">struct</span> <span class="n">atalk_netrange</span>	<span class="n">nets</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atalk_iface</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>
	
<span class="k">struct</span> <span class="n">atalk_sock</span> <span class="p">{</span>
	<span class="cm">/* struct sock has to be the first member of atalk_sock */</span>
	<span class="k">struct</span> <span class="n">sock</span>	<span class="n">sk</span><span class="p">;</span>
	<span class="n">__be16</span>		<span class="n">dest_net</span><span class="p">;</span>
	<span class="n">__be16</span>		<span class="n">src_net</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">dest_node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">src_node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">dest_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">src_port</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">atalk_sock</span> <span class="o">*</span><span class="nf">at_sk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atalk_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ddpehdr</span> <span class="p">{</span>
	<span class="n">__be16</span>	<span class="n">deh_len_hops</span><span class="p">;</span>	<span class="cm">/* lower 10 bits are length, next 4 - hops */</span>
	<span class="n">__be16</span>	<span class="n">deh_sum</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">deh_dnet</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">deh_snet</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">deh_dnode</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">deh_snode</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">deh_dport</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">deh_sport</span><span class="p">;</span>
	<span class="cm">/* And netatalk apps expect to stick the type in themselves */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="k">struct</span> <span class="n">ddpehdr</span> <span class="o">*</span><span class="nf">ddp_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ddpehdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* AppleTalk AARP headers */</span>
<span class="k">struct</span> <span class="n">elapaarp</span> <span class="p">{</span>
	<span class="n">__be16</span>	<span class="n">hw_type</span><span class="p">;</span>
<span class="cp">#define AARP_HW_TYPE_ETHERNET		1</span>
<span class="cp">#define AARP_HW_TYPE_TOKENRING		2</span>
	<span class="n">__be16</span>	<span class="n">pa_type</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">hw_len</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">pa_len</span><span class="p">;</span>
<span class="cp">#define AARP_PA_ALEN			4</span>
	<span class="n">__be16</span>	<span class="n">function</span><span class="p">;</span>
<span class="cp">#define AARP_REQUEST			1</span>
<span class="cp">#define AARP_REPLY			2</span>
<span class="cp">#define AARP_PROBE			3</span>
	<span class="n">__u8</span>	<span class="n">hw_src</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__u8</span>	<span class="n">pa_src_zero</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">pa_src_net</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">pa_src_node</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">hw_dst</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__u8</span>	<span class="n">pa_dst_zero</span><span class="p">;</span>
	<span class="n">__be16</span>	<span class="n">pa_dst_net</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">pa_dst_node</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="k">struct</span> <span class="n">elapaarp</span> <span class="o">*</span><span class="nf">aarp_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">elapaarp</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Not specified - how long till we drop a resolved entry */</span>
<span class="cp">#define AARP_EXPIRY_TIME	(5 * 60 * HZ)</span>
<span class="cm">/* Size of hash table */</span>
<span class="cp">#define AARP_HASH_SIZE		16</span>
<span class="cm">/* Fast retransmission timer when resolving */</span>
<span class="cp">#define AARP_TICK_TIME		(HZ / 5)</span>
<span class="cm">/* Send 10 requests then give up (2 seconds) */</span>
<span class="cp">#define AARP_RETRANSMIT_LIMIT	10</span>
<span class="cm">/*</span>
<span class="cm"> * Some value bigger than total retransmit time + a bit for last reply to</span>
<span class="cm"> * appear and to stop continual requests</span>
<span class="cm"> */</span>
<span class="cp">#define AARP_RESOLVE_TIME	(10 * HZ)</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">datalink_proto</span> <span class="o">*</span><span class="n">ddp_dl</span><span class="p">,</span> <span class="o">*</span><span class="n">aarp_dl</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">aarp_proto_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Inter module exports */</span>

<span class="cm">/* Give a device find its atif control structure */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">atalk_iface</span> <span class="o">*</span><span class="nf">atalk_find_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atalk_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">atalk_addr</span> <span class="o">*</span><span class="n">atalk_find_dev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">atrtr_get_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">atalk_addr</span> <span class="o">*</span><span class="n">sa</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>		 <span class="n">aarp_send_ddp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">atalk_addr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hwaddr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>		 <span class="n">aarp_device_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>		 <span class="n">aarp_probe_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">atalk_iface</span> <span class="o">*</span><span class="n">atif</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> 		 <span class="n">aarp_proxy_probe_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">atalk_iface</span> <span class="o">*</span><span class="n">atif</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">atalk_addr</span> <span class="o">*</span><span class="n">sa</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span>		 <span class="n">aarp_proxy_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">atalk_addr</span> <span class="o">*</span><span class="n">sa</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span>		<span class="n">aarp_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">atalk_sockets</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">rwlock_t</span> <span class="n">atalk_sockets_lock</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">atalk_route</span> <span class="o">*</span><span class="n">atalk_routes</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">rwlock_t</span> <span class="n">atalk_routes_lock</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">atalk_iface</span> <span class="o">*</span><span class="n">atalk_interfaces</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">rwlock_t</span> <span class="n">atalk_interfaces_lock</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">atalk_route</span> <span class="n">atrtr_default</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">atalk_seq_arp_fops</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">sysctl_aarp_expiry_time</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sysctl_aarp_tick_time</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sysctl_aarp_retransmit_limit</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sysctl_aarp_resolve_time</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">atalk_register_sysctl</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">atalk_unregister_sysctl</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define atalk_register_sysctl()		do { } while(0)</span>
<span class="cp">#define atalk_unregister_sysctl()	do { } while(0)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">atalk_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">atalk_proc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define atalk_proc_init()	({ 0; })</span>
<span class="cp">#define atalk_proc_exit()	do { } while(0)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* __LINUX_ATALK_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
