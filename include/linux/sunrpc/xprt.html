<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › sunrpc › xprt.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xprt.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/include/linux/sunrpc/xprt.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Declarations for the RPC transport interface.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _LINUX_SUNRPC_XPRT_H</span>
<span class="cp">#define _LINUX_SUNRPC_XPRT_H</span>

<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ktime.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/sched.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/xdr.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/msg_prot.h&gt;</span>

<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#define RPC_MIN_SLOT_TABLE	(2U)</span>
<span class="cp">#define RPC_DEF_SLOT_TABLE	(16U)</span>
<span class="cp">#define RPC_MAX_SLOT_TABLE_LIMIT	(65536U)</span>
<span class="cp">#define RPC_MAX_SLOT_TABLE	RPC_MAX_SLOT_TABLE_LIMIT</span>

<span class="cm">/*</span>
<span class="cm"> * This describes a timeout strategy</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">to_initval</span><span class="p">,</span>		<span class="cm">/* initial timeout */</span>
				<span class="n">to_maxval</span><span class="p">,</span>		<span class="cm">/* max timeout */</span>
				<span class="n">to_increment</span><span class="p">;</span>		<span class="cm">/* if !exponential */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">to_retries</span><span class="p">;</span>		<span class="cm">/* max # of retries */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">to_exponential</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rpc_display_format_t</span> <span class="p">{</span>
	<span class="n">RPC_DISPLAY_ADDR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RPC_DISPLAY_PORT</span><span class="p">,</span>
	<span class="n">RPC_DISPLAY_PROTO</span><span class="p">,</span>
	<span class="n">RPC_DISPLAY_HEX_ADDR</span><span class="p">,</span>
	<span class="n">RPC_DISPLAY_HEX_PORT</span><span class="p">,</span>
	<span class="n">RPC_DISPLAY_NETID</span><span class="p">,</span>
	<span class="n">RPC_DISPLAY_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rpc_task</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rpc_xprt</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">seq_file</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This describes a complete RPC request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is the user-visible part</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span>	<span class="n">rq_xprt</span><span class="p">;</span>		<span class="cm">/* RPC client */</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>		<span class="n">rq_snd_buf</span><span class="p">;</span>		<span class="cm">/* send buffer */</span>
	<span class="k">struct</span> <span class="n">xdr_buf</span>		<span class="n">rq_rcv_buf</span><span class="p">;</span>		<span class="cm">/* recv buffer */</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is the private part</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span>	<span class="n">rq_task</span><span class="p">;</span>	<span class="cm">/* RPC task data */</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span>	<span class="n">rq_cred</span><span class="p">;</span>	<span class="cm">/* Bound cred */</span>
	<span class="n">__be32</span>			<span class="n">rq_xid</span><span class="p">;</span>		<span class="cm">/* request XID */</span>
	<span class="kt">int</span>			<span class="n">rq_cong</span><span class="p">;</span>	<span class="cm">/* has incremented xprt-&gt;cong */</span>
	<span class="n">u32</span>			<span class="n">rq_seqno</span><span class="p">;</span>	<span class="cm">/* gss seq no. used on req. */</span>
	<span class="kt">int</span>			<span class="n">rq_enc_pages_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span>		<span class="o">**</span><span class="n">rq_enc_pages</span><span class="p">;</span>	<span class="cm">/* scratch pages for use by</span>
<span class="cm">						   gss privacy code */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rq_release_snd_buf</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="p">);</span> <span class="cm">/* release rq_enc_pages */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rq_list</span><span class="p">;</span>

	<span class="n">__u32</span> <span class="o">*</span>			<span class="n">rq_buffer</span><span class="p">;</span>	<span class="cm">/* XDR encode buffer */</span>
	<span class="kt">size_t</span>			<span class="n">rq_callsize</span><span class="p">,</span>
				<span class="n">rq_rcvsize</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">rq_xmit_bytes_sent</span><span class="p">;</span>	<span class="cm">/* total bytes sent */</span>
	<span class="kt">size_t</span>			<span class="n">rq_reply_bytes_recvd</span><span class="p">;</span>	<span class="cm">/* total reply bytes */</span>
							<span class="cm">/* received */</span>

	<span class="k">struct</span> <span class="n">xdr_buf</span>		<span class="n">rq_private_buf</span><span class="p">;</span>		<span class="cm">/* The receive buffer</span>
<span class="cm">							 * used in the softirq.</span>
<span class="cm">							 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">rq_majortimeo</span><span class="p">;</span>	<span class="cm">/* major timeout alarm */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">rq_timeout</span><span class="p">;</span>	<span class="cm">/* Current timeout value */</span>
	<span class="n">ktime_t</span>			<span class="n">rq_rtt</span><span class="p">;</span>		<span class="cm">/* round-trip time */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rq_retries</span><span class="p">;</span>	<span class="cm">/* # of retries */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rq_connect_cookie</span><span class="p">;</span>
						<span class="cm">/* A cookie used to track the</span>
<span class="cm">						   state of the transport</span>
<span class="cm">						   connection */</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Partial send handling</span>
<span class="cm">	 */</span>
	<span class="n">u32</span>			<span class="n">rq_bytes_sent</span><span class="p">;</span>	<span class="cm">/* Bytes we have sent */</span>

	<span class="n">ktime_t</span>			<span class="n">rq_xtime</span><span class="p">;</span>	<span class="cm">/* transmit time stamp */</span>
	<span class="kt">int</span>			<span class="n">rq_ntrans</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_SUNRPC_BACKCHANNEL)</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rq_bc_list</span><span class="p">;</span>	<span class="cm">/* Callback service list */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">rq_bc_pa_state</span><span class="p">;</span>	<span class="cm">/* Backchannel prealloc state */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">rq_bc_pa_list</span><span class="p">;</span>	<span class="cm">/* Backchannel prealloc list */</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANEL */</span><span class="cp"></span>
<span class="p">};</span>
<span class="cp">#define rq_svec			rq_snd_buf.head</span>
<span class="cp">#define rq_slen			rq_snd_buf.len</span>

<span class="k">struct</span> <span class="n">rpc_xprt_ops</span> <span class="p">{</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">set_buffer_size</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sndsize</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">rcvsize</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">reserve_xprt</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">release_xprt</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">rpcbind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">set_port</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">connect</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span>		<span class="p">(</span><span class="o">*</span><span class="n">buf_alloc</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">buf_free</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">send_request</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">set_retrans_timeout</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">timer</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">release_request</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">destroy</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">print_stats</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * RPC transport identifiers</span>
<span class="cm"> *</span>
<span class="cm"> * To preserve compatibility with the historical use of raw IP protocol</span>
<span class="cm"> * id&#39;s for transport selection, UDP and TCP identifiers are specified</span>
<span class="cm"> * with the previous values. No such restriction exists for new transports,</span>
<span class="cm"> * except that they may not collide with these values (17 and 6,</span>
<span class="cm"> * respectively).</span>
<span class="cm"> */</span>
<span class="cp">#define XPRT_TRANSPORT_BC       (1 &lt;&lt; 31)</span>
<span class="k">enum</span> <span class="n">xprt_transports</span> <span class="p">{</span>
	<span class="n">XPRT_TRANSPORT_UDP</span>	<span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span>
	<span class="n">XPRT_TRANSPORT_TCP</span>	<span class="o">=</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span>
	<span class="n">XPRT_TRANSPORT_BC_TCP</span>	<span class="o">=</span> <span class="n">IPPROTO_TCP</span> <span class="o">|</span> <span class="n">XPRT_TRANSPORT_BC</span><span class="p">,</span>
	<span class="n">XPRT_TRANSPORT_RDMA</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
	<span class="n">XPRT_TRANSPORT_LOCAL</span>	<span class="o">=</span> <span class="mi">257</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="p">{</span>
	<span class="n">atomic_t</span>		<span class="n">count</span><span class="p">;</span>		<span class="cm">/* Reference count */</span>
	<span class="k">struct</span> <span class="n">rpc_xprt_ops</span> <span class="o">*</span>	<span class="n">ops</span><span class="p">;</span>		<span class="cm">/* transport methods */</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_timeout</span> <span class="o">*</span><span class="n">timeout</span><span class="p">;</span>	<span class="cm">/* timeout parms */</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span>	<span class="n">addr</span><span class="p">;</span>		<span class="cm">/* server address */</span>
	<span class="kt">size_t</span>			<span class="n">addrlen</span><span class="p">;</span>	<span class="cm">/* size of server address */</span>
	<span class="kt">int</span>			<span class="n">prot</span><span class="p">;</span>		<span class="cm">/* IP protocol */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">cong</span><span class="p">;</span>		<span class="cm">/* current congestion */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">cwnd</span><span class="p">;</span>		<span class="cm">/* congestion window */</span>

	<span class="kt">size_t</span>			<span class="n">max_payload</span><span class="p">;</span>	<span class="cm">/* largest RPC payload size,</span>
<span class="cm">						   in bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">tsh_size</span><span class="p">;</span>	<span class="cm">/* size of transport specific</span>
<span class="cm">						   header */</span>

	<span class="k">struct</span> <span class="n">rpc_wait_queue</span>	<span class="n">binding</span><span class="p">;</span>	<span class="cm">/* requests waiting on rpcbind */</span>
	<span class="k">struct</span> <span class="n">rpc_wait_queue</span>	<span class="n">sending</span><span class="p">;</span>	<span class="cm">/* requests waiting to send */</span>
	<span class="k">struct</span> <span class="n">rpc_wait_queue</span>	<span class="n">pending</span><span class="p">;</span>	<span class="cm">/* requests in flight */</span>
	<span class="k">struct</span> <span class="n">rpc_wait_queue</span>	<span class="n">backlog</span><span class="p">;</span>	<span class="cm">/* waiting for slot */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">free</span><span class="p">;</span>		<span class="cm">/* free slots */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">max_reqs</span><span class="p">;</span>	<span class="cm">/* max number of slots */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">min_reqs</span><span class="p">;</span>	<span class="cm">/* min number of slots */</span>
	<span class="n">atomic_t</span>		<span class="n">num_reqs</span><span class="p">;</span>	<span class="cm">/* total slots */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">state</span><span class="p">;</span>		<span class="cm">/* transport state */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">shutdown</span>   <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* being shut down */</span>
				<span class="n">resvport</span>   <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* use a reserved port */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">bind_index</span><span class="p">;</span>	<span class="cm">/* bind function index */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Connection of transports</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">bind_timeout</span><span class="p">,</span>
				<span class="n">reestablish_timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">connect_cookie</span><span class="p">;</span>	<span class="cm">/* A cookie that gets bumped</span>
<span class="cm">						   every time the transport</span>
<span class="cm">						   is reconnected */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disconnection of idle transports</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">task_cleanup</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">last_used</span><span class="p">,</span>
				<span class="n">idle_timeout</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send stuff</span>
<span class="cm">	 */</span>
	<span class="n">spinlock_t</span>		<span class="n">transport_lock</span><span class="p">;</span>	<span class="cm">/* lock transport info */</span>
	<span class="n">spinlock_t</span>		<span class="n">reserve_lock</span><span class="p">;</span>	<span class="cm">/* lock slot table */</span>
	<span class="n">u32</span>			<span class="n">xid</span><span class="p">;</span>		<span class="cm">/* Next XID value to use */</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span>	<span class="n">snd_task</span><span class="p">;</span>	<span class="cm">/* Task blocked in send */</span>
	<span class="k">struct</span> <span class="n">svc_xprt</span>		<span class="o">*</span><span class="n">bc_xprt</span><span class="p">;</span>	<span class="cm">/* NFSv4.1 backchannel */</span>
<span class="cp">#if defined(CONFIG_SUNRPC_BACKCHANNEL)</span>
	<span class="k">struct</span> <span class="n">svc_serv</span>		<span class="o">*</span><span class="n">bc_serv</span><span class="p">;</span>       <span class="cm">/* The RPC service which will */</span>
						<span class="cm">/* process the callback */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">bc_alloc_count</span><span class="p">;</span>	<span class="cm">/* Total number of preallocs */</span>
	<span class="n">spinlock_t</span>		<span class="n">bc_pa_lock</span><span class="p">;</span>	<span class="cm">/* Protects the preallocated</span>
<span class="cm">						 * items */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">bc_pa_list</span><span class="p">;</span>	<span class="cm">/* List of preallocated</span>
<span class="cm">						 * backchannel rpc_rqst&#39;s */</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANNEL */</span><span class="cp"></span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">recv</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">bind_count</span><span class="p">,</span>	<span class="cm">/* total number of binds */</span>
					<span class="n">connect_count</span><span class="p">,</span>	<span class="cm">/* total number of connects */</span>
					<span class="n">connect_start</span><span class="p">,</span>	<span class="cm">/* connect start timestamp */</span>
					<span class="n">connect_time</span><span class="p">,</span>	<span class="cm">/* jiffies waiting for connect */</span>
					<span class="n">sends</span><span class="p">,</span>		<span class="cm">/* how many complete requests */</span>
					<span class="n">recvs</span><span class="p">,</span>		<span class="cm">/* how many complete requests */</span>
					<span class="n">bad_xids</span><span class="p">,</span>	<span class="cm">/* lookup_rqst didn&#39;t find XID */</span>
					<span class="n">max_slots</span><span class="p">;</span>	<span class="cm">/* max rpc_slots used */</span>

		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>	<span class="n">req_u</span><span class="p">,</span>		<span class="cm">/* average requests on the wire */</span>
					<span class="n">bklog_u</span><span class="p">,</span>	<span class="cm">/* backlog queue utilization */</span>
					<span class="n">sending_u</span><span class="p">,</span>	<span class="cm">/* send q utilization */</span>
					<span class="n">pending_u</span><span class="p">;</span>	<span class="cm">/* pend q utilization */</span>
	<span class="p">}</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net</span>		<span class="o">*</span><span class="n">xprt_net</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">servername</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">address_strings</span><span class="p">[</span><span class="n">RPC_DISPLAY_MAX</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_SUNRPC_BACKCHANNEL)</span>
<span class="cm">/*</span>
<span class="cm"> * Backchannel flags</span>
<span class="cm"> */</span>
<span class="cp">#define	RPC_BC_PA_IN_USE	0x0001		</span><span class="cm">/* Preallocated backchannel */</span><span class="cp"></span>
						<span class="cm">/* buffer in use */</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANNEL */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_SUNRPC_BACKCHANNEL)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bc_prealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">RPC_BC_PA_IN_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_bc_pa_state</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bc_prealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SUNRPC_BACKCHANNEL */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">xprt_create</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">ident</span><span class="p">;</span>		<span class="cm">/* XPRT_TRANSPORT identifier */</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span>		<span class="n">net</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span>	<span class="n">srcaddr</span><span class="p">;</span>	<span class="cm">/* optional local address */</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span>	<span class="n">dstaddr</span><span class="p">;</span>	<span class="cm">/* remote peer address */</span>
	<span class="kt">size_t</span>			<span class="n">addrlen</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">servername</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_xprt</span>		<span class="o">*</span><span class="n">bc_xprt</span><span class="p">;</span>	<span class="cm">/* NFSv4.1 backchannel */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">xprt_class</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ident</span><span class="p">;</span>		<span class="cm">/* XPRT_TRANSPORT identifier */</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span>	<span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">)(</span><span class="k">struct</span> <span class="n">xprt_create</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">module</span>		<span class="o">*</span><span class="n">owner</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Generic internal transport functions</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpc_xprt</span>		<span class="o">*</span><span class="n">xprt_create_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">xprt_create</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">int</span>			<span class="n">xprt_reserve_xprt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">int</span>			<span class="n">xprt_reserve_xprt_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">int</span>			<span class="n">xprt_prepare_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_end_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">int</span>			<span class="n">xprt_adjust_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_release_xprt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_release_xprt_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span>	<span class="n">xprt_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span>	<span class="n">xprt_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_prealloc</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_req</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span> <span class="o">*</span><span class="nf">xprt_skip_transport_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">+</span> <span class="n">xprt</span><span class="o">-&gt;</span><span class="n">tsh_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transport switch helper functions</span>
<span class="cm"> */</span>
<span class="kt">int</span>			<span class="n">xprt_register_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">xprt_class</span> <span class="o">*</span><span class="n">type</span><span class="p">);</span>
<span class="kt">int</span>			<span class="n">xprt_unregister_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">xprt_class</span> <span class="o">*</span><span class="n">type</span><span class="p">);</span>
<span class="kt">int</span>			<span class="n">xprt_load_transport</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_set_retrans_timeout_def</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_set_retrans_timeout_rtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_wake_pending_tasks</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_wait_for_buffer_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">rpc_action</span> <span class="n">action</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_write_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_adjust_cwnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">rpc_rqst</span> <span class="o">*</span>	<span class="n">xprt_lookup_rqst</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">xid</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_complete_rqst</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">copied</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_release_rqst_cong</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_disconnect_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_force_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">);</span>
<span class="kt">void</span>			<span class="n">xprt_conditional_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cookie</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Reserved bit positions in xprt-&gt;state</span>
<span class="cm"> */</span>
<span class="cp">#define XPRT_LOCKED		(0)</span>
<span class="cp">#define XPRT_CONNECTED		(1)</span>
<span class="cp">#define XPRT_CONNECTING		(2)</span>
<span class="cp">#define XPRT_CLOSE_WAIT		(3)</span>
<span class="cp">#define XPRT_BOUND		(4)</span>
<span class="cp">#define XPRT_BINDING		(5)</span>
<span class="cp">#define XPRT_CLOSING		(6)</span>
<span class="cp">#define XPRT_CONNECTION_ABORT	(7)</span>
<span class="cp">#define XPRT_CONNECTION_CLOSE	(8)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xprt_set_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xprt_clear_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_test_and_set_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_test_and_clear_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xprt_clear_connecting</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_connecting</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_test_and_set_connecting</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_CONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xprt_set_bound</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_BOUND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_bound</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">XPRT_BOUND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xprt_clear_bound</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPRT_BOUND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xprt_clear_binding</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">XPRT_BINDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xprt_test_and_set_binding</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">XPRT_BINDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xprt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__*/</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_SUNRPC_XPRT_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
