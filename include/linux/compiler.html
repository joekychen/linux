<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › compiler.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>compiler.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __LINUX_COMPILER_H</span>
<span class="cp">#define __LINUX_COMPILER_H</span>

<span class="cp">#ifndef __ASSEMBLY__</span>

<span class="cp">#ifdef __CHECKER__</span>
<span class="cp"># define __user		__attribute__((noderef, address_space(1)))</span>
<span class="cp"># define __kernel	__attribute__((address_space(0)))</span>
<span class="cp"># define __safe		__attribute__((safe))</span>
<span class="cp"># define __force	__attribute__((force))</span>
<span class="cp"># define __nocast	__attribute__((nocast))</span>
<span class="cp"># define __iomem	__attribute__((noderef, address_space(2)))</span>
<span class="cp"># define __acquires(x)	__attribute__((context(x,0,1)))</span>
<span class="cp"># define __releases(x)	__attribute__((context(x,1,0)))</span>
<span class="cp"># define __acquire(x)	__context__(x,1)</span>
<span class="cp"># define __release(x)	__context__(x,-1)</span>
<span class="cp"># define __cond_lock(x,c)	((c) ? ({ __acquire(x); 1; }) : 0)</span>
<span class="cp"># define __percpu	__attribute__((noderef, address_space(3)))</span>
<span class="cp">#ifdef CONFIG_SPARSE_RCU_POINTER</span>
<span class="cp"># define __rcu		__attribute__((noderef, address_space(4)))</span>
<span class="cp">#else</span>
<span class="cp"># define __rcu</span>
<span class="cp">#endif</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__chk_user_ptr</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__chk_io_ptr</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp"># define __user</span>
<span class="cp"># define __kernel</span>
<span class="cp"># define __safe</span>
<span class="cp"># define __force</span>
<span class="cp"># define __nocast</span>
<span class="cp"># define __iomem</span>
<span class="cp"># define __chk_user_ptr(x) (void)0</span>
<span class="cp"># define __chk_io_ptr(x) (void)0</span>
<span class="cp"># define __builtin_warning(x, y...) (1)</span>
<span class="cp"># define __acquires(x)</span>
<span class="cp"># define __releases(x)</span>
<span class="cp"># define __acquire(x) (void)0</span>
<span class="cp"># define __release(x) (void)0</span>
<span class="cp"># define __cond_lock(x,c) (c)</span>
<span class="cp"># define __percpu</span>
<span class="cp"># define __rcu</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#ifdef __GNUC__</span>
<span class="cp">#include &lt;linux/compiler-gcc.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define notrace __attribute__((no_instrument_function))</span>

<span class="cm">/* Intel compiler defines __GNUC__. So we will overwrite implementations</span>
<span class="cm"> * coming from above header files here</span>
<span class="cm"> */</span>
<span class="cp">#ifdef __INTEL_COMPILER</span>
<span class="cp"># include &lt;linux/compiler-intel.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Generic compiler-dependent macros required for kernel</span>
<span class="cm"> * build go below this comment. Actual compiler/compiler version</span>
<span class="cm"> * specific implementations come from the above header files</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ftrace_branch_data</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">line</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">correct</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">incorrect</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">miss</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hit</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">miss_hit</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Note: DISABLE_BRANCH_PROFILING can be used by special lowlevel code</span>
<span class="cm"> * to disable branch tracing on a per file basis.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_TRACE_BRANCH_PROFILING) \</span>
<span class="cp">    &amp;&amp; !defined(DISABLE_BRANCH_PROFILING) &amp;&amp; !defined(__CHECKER__)</span>
<span class="kt">void</span> <span class="n">ftrace_likely_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_branch_data</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">expect</span><span class="p">);</span>

<span class="cp">#define likely_notrace(x)	__builtin_expect(!!(x), 1)</span>
<span class="cp">#define unlikely_notrace(x)	__builtin_expect(!!(x), 0)</span>

<span class="cp">#define __branch_check__(x, expect) ({					\</span>
<span class="cp">			int ______r;					\</span>
<span class="cp">			static struct ftrace_branch_data		\</span>
<span class="cp">				__attribute__((__aligned__(4)))		\</span>
<span class="cp">				__attribute__((section(&quot;_ftrace_annotated_branch&quot;))) \</span>
<span class="cp">				______f = {				\</span>
<span class="cp">				.func = __func__,			\</span>
<span class="cp">				.file = __FILE__,			\</span>
<span class="cp">				.line = __LINE__,			\</span>
<span class="cp">			};						\</span>
<span class="cp">			______r = likely_notrace(x);			\</span>
<span class="cp">			ftrace_likely_update(&amp;______f, ______r, expect); \</span>
<span class="cp">			______r;					\</span>
<span class="cp">		})</span>

<span class="cm">/*</span>
<span class="cm"> * Using __builtin_constant_p(x) to ignore cases where the return</span>
<span class="cm"> * value is always the same.  This idea is taken from a similar patch</span>
<span class="cm"> * written by Daniel Walker.</span>
<span class="cm"> */</span>
<span class="cp"># ifndef likely</span>
<span class="cp">#  define likely(x)	(__builtin_constant_p(x) ? !!(x) : __branch_check__(x, 1))</span>
<span class="cp"># endif</span>
<span class="cp"># ifndef unlikely</span>
<span class="cp">#  define unlikely(x)	(__builtin_constant_p(x) ? !!(x) : __branch_check__(x, 0))</span>
<span class="cp"># endif</span>

<span class="cp">#ifdef CONFIG_PROFILE_ALL_BRANCHES</span>
<span class="cm">/*</span>
<span class="cm"> * &quot;Define &#39;is&#39;&quot;, Bill Clinton</span>
<span class="cm"> * &quot;Define &#39;if&#39;&quot;, Steven Rostedt</span>
<span class="cm"> */</span>
<span class="cp">#define if(cond, ...) __trace_if( (cond , ## __VA_ARGS__) )</span>
<span class="cp">#define __trace_if(cond) \</span>
<span class="cp">	if (__builtin_constant_p((cond)) ? !!(cond) :			\</span>
<span class="cp">	({								\</span>
<span class="cp">		int ______r;						\</span>
<span class="cp">		static struct ftrace_branch_data			\</span>
<span class="cp">			__attribute__((__aligned__(4)))			\</span>
<span class="cp">			__attribute__((section(&quot;_ftrace_branch&quot;)))	\</span>
<span class="cp">			______f = {					\</span>
<span class="cp">				.func = __func__,			\</span>
<span class="cp">				.file = __FILE__,			\</span>
<span class="cp">				.line = __LINE__,			\</span>
<span class="cp">			};						\</span>
<span class="cp">		______r = !!(cond);					\</span>
<span class="cp">		______f.miss_hit[______r]++;					\</span>
<span class="cp">		______r;						\</span>
<span class="cp">	}))</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROFILE_ALL_BRANCHES */</span><span class="cp"></span>

<span class="cp">#else</span>
<span class="cp"># define likely(x)	__builtin_expect(!!(x), 1)</span>
<span class="cp"># define unlikely(x)	__builtin_expect(!!(x), 0)</span>
<span class="cp">#endif</span>

<span class="cm">/* Optimization barrier */</span>
<span class="cp">#ifndef barrier</span>
<span class="cp"># define barrier() __memory_barrier()</span>
<span class="cp">#endif</span>

<span class="cm">/* Unreachable code */</span>
<span class="cp">#ifndef unreachable</span>
<span class="cp"># define unreachable() do { } while (1)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef RELOC_HIDE</span>
<span class="cp"># define RELOC_HIDE(ptr, off)					\</span>
<span class="cp">  ({ unsigned long __ptr;					\</span>
<span class="cp">     __ptr = (unsigned long) (ptr);				\</span>
<span class="cp">    (typeof(ptr)) (__ptr + (off)); })</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* __ASSEMBLY__ */</span><span class="cp"></span>

<span class="cp">#ifdef __KERNEL__</span>
<span class="cm">/*</span>
<span class="cm"> * Allow us to mark functions as &#39;deprecated&#39; and have gcc emit a nice</span>
<span class="cm"> * warning for each use, in hopes of speeding the functions removal.</span>
<span class="cm"> * Usage is:</span>
<span class="cm"> * 		int __deprecated foo(void)</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __deprecated</span>
<span class="cp"># define __deprecated		</span><span class="cm">/* unimplemented */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#ifdef MODULE</span>
<span class="cp">#define __deprecated_for_modules __deprecated</span>
<span class="cp">#else</span>
<span class="cp">#define __deprecated_for_modules</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef __must_check</span>
<span class="cp">#define __must_check</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_ENABLE_MUST_CHECK</span>
<span class="cp">#undef __must_check</span>
<span class="cp">#define __must_check</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_ENABLE_WARN_DEPRECATED</span>
<span class="cp">#undef __deprecated</span>
<span class="cp">#undef __deprecated_for_modules</span>
<span class="cp">#define __deprecated</span>
<span class="cp">#define __deprecated_for_modules</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Allow us to avoid &#39;defined but not used&#39; warnings on functions and data,</span>
<span class="cm"> * as well as force them to be emitted to the assembly file.</span>
<span class="cm"> *</span>
<span class="cm"> * As of gcc 3.4, static functions that are not marked with attribute((used))</span>
<span class="cm"> * may be elided from the assembly file.  As of gcc 3.4, static data not so</span>
<span class="cm"> * marked will not be elided, but this may change in a future gcc version.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Because distributions shipped with a backported unit-at-a-time</span>
<span class="cm"> * compiler in gcc 3.3, we must define __used to be __attribute__((used))</span>
<span class="cm"> * for gcc &gt;=3.3 instead of 3.4.</span>
<span class="cm"> *</span>
<span class="cm"> * In prior versions of gcc, such functions and data would be emitted, but</span>
<span class="cm"> * would be warned about except with attribute((unused)).</span>
<span class="cm"> *</span>
<span class="cm"> * Mark functions that are referenced only in inline assembly as __used so</span>
<span class="cm"> * the code is emitted even though it appears to be unreferenced.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __used</span>
<span class="cp"># define __used			</span><span class="cm">/* unimplemented */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#ifndef __maybe_unused</span>
<span class="cp"># define __maybe_unused		</span><span class="cm">/* unimplemented */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#ifndef __always_unused</span>
<span class="cp"># define __always_unused	</span><span class="cm">/* unimplemented */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#ifndef noinline</span>
<span class="cp">#define noinline</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Rather then using noinline to prevent stack consumption, use</span>
<span class="cm"> * noinline_for_stack instead.  For documentation reasons.</span>
<span class="cm"> */</span>
<span class="cp">#define noinline_for_stack noinline</span>

<span class="cp">#ifndef __always_inline</span>
<span class="cp">#define __always_inline inline</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * From the GCC manual:</span>
<span class="cm"> *</span>
<span class="cm"> * Many functions do not examine any values except their arguments,</span>
<span class="cm"> * and have no effects except the return value.  Basically this is</span>
<span class="cm"> * just slightly more strict class than the `pure&#39; attribute above,</span>
<span class="cm"> * since function is not allowed to read global memory.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that a function that has pointer arguments and examines the</span>
<span class="cm"> * data pointed to must _not_ be declared `const&#39;.  Likewise, a</span>
<span class="cm"> * function that calls a non-`const&#39; function usually must not be</span>
<span class="cm"> * `const&#39;.  It does not make sense for a `const&#39; function to return</span>
<span class="cm"> * `void&#39;.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __attribute_const__</span>
<span class="cp"># define __attribute_const__	</span><span class="cm">/* unimplemented */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Tell gcc if a function is cold. The compiler will assume any path</span>
<span class="cm"> * directly leading to the call is unlikely.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __cold</span>
<span class="cp">#define __cold</span>
<span class="cp">#endif</span>

<span class="cm">/* Simple shorthand for a section definition */</span>
<span class="cp">#ifndef __section</span>
<span class="cp"># define __section(S) __attribute__ ((__section__(#S)))</span>
<span class="cp">#endif</span>

<span class="cm">/* Are two types/vars the same type (ignoring qualifiers)? */</span>
<span class="cp">#ifndef __same_type</span>
<span class="cp"># define __same_type(a, b) __builtin_types_compatible_p(typeof(a), typeof(b))</span>
<span class="cp">#endif</span>

<span class="cm">/* Compile time object size, -1 for unknown */</span>
<span class="cp">#ifndef __compiletime_object_size</span>
<span class="cp"># define __compiletime_object_size(obj) -1</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef __compiletime_warning</span>
<span class="cp"># define __compiletime_warning(message)</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef __compiletime_error</span>
<span class="cp"># define __compiletime_error(message)</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef __linktime_error</span>
<span class="cp"># define __linktime_error(message)</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm"> * Prevent the compiler from merging or refetching accesses.  The compiler</span>
<span class="cm"> * is also forbidden from reordering successive instances of ACCESS_ONCE(),</span>
<span class="cm"> * but only when the compiler is aware of some particular ordering.  One way</span>
<span class="cm"> * to make the compiler aware of ordering is to put the two invocations of</span>
<span class="cm"> * ACCESS_ONCE() in different C statements.</span>
<span class="cm"> *</span>
<span class="cm"> * This macro does absolutely -nothing- to prevent the CPU from reordering,</span>
<span class="cm"> * merging, or refetching absolutely anything at any time.  Its main intended</span>
<span class="cm"> * use is to mediate communication between process-level code and irq/NMI</span>
<span class="cm"> * handlers, all running on the same CPU.</span>
<span class="cm"> */</span>
<span class="cp">#define ACCESS_ONCE(x) (*(volatile typeof(x) *)&amp;(x))</span>

<span class="cp">#endif </span><span class="cm">/* __LINUX_COMPILER_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
