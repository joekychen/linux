<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › vhost.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>vhost.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _LINUX_VHOST_H</span>
<span class="cp">#define _LINUX_VHOST_H</span>
<span class="cm">/* Userspace interface for in-kernel virtio accelerators. */</span>

<span class="cm">/* vhost is used to reduce the number of system calls involved in virtio.</span>
<span class="cm"> *</span>
<span class="cm"> * Existing virtio net code is used in the guest without modification.</span>
<span class="cm"> *</span>
<span class="cm"> * This header includes interface used by userspace hypervisor for</span>
<span class="cm"> * device configuration.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_config.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_ring.h&gt;</span>

<span class="k">struct</span> <span class="n">vhost_vring_state</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vhost_vring_file</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span> <span class="cm">/* Pass -1 to unbind from file. */</span>

<span class="p">};</span>

<span class="k">struct</span> <span class="n">vhost_vring_addr</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="cm">/* Option flags. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="cm">/* Flag values: */</span>
	<span class="cm">/* Whether log address is valid. If set enables logging. */</span>
<span class="cp">#define VHOST_VRING_F_LOG 0</span>

	<span class="cm">/* Start of array of descriptors (virtually contiguous) */</span>
	<span class="n">__u64</span> <span class="n">desc_user_addr</span><span class="p">;</span>
	<span class="cm">/* Used structure address. Must be 32 bit aligned */</span>
	<span class="n">__u64</span> <span class="n">used_user_addr</span><span class="p">;</span>
	<span class="cm">/* Available structure address. Must be 16 bit aligned */</span>
	<span class="n">__u64</span> <span class="n">avail_user_addr</span><span class="p">;</span>
	<span class="cm">/* Logging support. */</span>
	<span class="cm">/* Log writes to used structure, at offset calculated from specified</span>
<span class="cm">	 * address. Address must be 32 bit aligned. */</span>
	<span class="n">__u64</span> <span class="n">log_guest_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vhost_memory_region</span> <span class="p">{</span>
	<span class="n">__u64</span> <span class="n">guest_phys_addr</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">memory_size</span><span class="p">;</span> <span class="cm">/* bytes */</span>
	<span class="n">__u64</span> <span class="n">userspace_addr</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">flags_padding</span><span class="p">;</span> <span class="cm">/* No flags are currently specified. */</span>
<span class="p">};</span>

<span class="cm">/* All region addresses and sizes must be 4K aligned. */</span>
<span class="cp">#define VHOST_PAGE_SIZE 0x1000</span>

<span class="k">struct</span> <span class="n">vhost_memory</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">nregions</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">padding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vhost_memory_region</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* ioctls */</span>

<span class="cp">#define VHOST_VIRTIO 0xAF</span>

<span class="cm">/* Features bitmask for forward compatibility.  Transport bits are used for</span>
<span class="cm"> * vhost specific features. */</span>
<span class="cp">#define VHOST_GET_FEATURES	_IOR(VHOST_VIRTIO, 0x00, __u64)</span>
<span class="cp">#define VHOST_SET_FEATURES	_IOW(VHOST_VIRTIO, 0x00, __u64)</span>

<span class="cm">/* Set current process as the (exclusive) owner of this file descriptor.  This</span>
<span class="cm"> * must be called before any other vhost command.  Further calls to</span>
<span class="cm"> * VHOST_OWNER_SET fail until VHOST_OWNER_RESET is called. */</span>
<span class="cp">#define VHOST_SET_OWNER _IO(VHOST_VIRTIO, 0x01)</span>
<span class="cm">/* Give up ownership, and reset the device to default values.</span>
<span class="cm"> * Allows subsequent call to VHOST_OWNER_SET to succeed. */</span>
<span class="cp">#define VHOST_RESET_OWNER _IO(VHOST_VIRTIO, 0x02)</span>

<span class="cm">/* Set up/modify memory layout */</span>
<span class="cp">#define VHOST_SET_MEM_TABLE	_IOW(VHOST_VIRTIO, 0x03, struct vhost_memory)</span>

<span class="cm">/* Write logging setup. */</span>
<span class="cm">/* Memory writes can optionally be logged by setting bit at an offset</span>
<span class="cm"> * (calculated from the physical address) from specified log base.</span>
<span class="cm"> * The bit is set using an atomic 32 bit operation. */</span>
<span class="cm">/* Set base address for logging. */</span>
<span class="cp">#define VHOST_SET_LOG_BASE _IOW(VHOST_VIRTIO, 0x04, __u64)</span>
<span class="cm">/* Specify an eventfd file descriptor to signal on log write. */</span>
<span class="cp">#define VHOST_SET_LOG_FD _IOW(VHOST_VIRTIO, 0x07, int)</span>

<span class="cm">/* Ring setup. */</span>
<span class="cm">/* Set number of descriptors in ring. This parameter can not</span>
<span class="cm"> * be modified while ring is running (bound to a device). */</span>
<span class="cp">#define VHOST_SET_VRING_NUM _IOW(VHOST_VIRTIO, 0x10, struct vhost_vring_state)</span>
<span class="cm">/* Set addresses for the ring. */</span>
<span class="cp">#define VHOST_SET_VRING_ADDR _IOW(VHOST_VIRTIO, 0x11, struct vhost_vring_addr)</span>
<span class="cm">/* Base value where queue looks for available descriptors */</span>
<span class="cp">#define VHOST_SET_VRING_BASE _IOW(VHOST_VIRTIO, 0x12, struct vhost_vring_state)</span>
<span class="cm">/* Get accessor: reads index, writes value in num */</span>
<span class="cp">#define VHOST_GET_VRING_BASE _IOWR(VHOST_VIRTIO, 0x12, struct vhost_vring_state)</span>

<span class="cm">/* The following ioctls use eventfd file descriptors to signal and poll</span>
<span class="cm"> * for events. */</span>

<span class="cm">/* Set eventfd to poll for added buffers */</span>
<span class="cp">#define VHOST_SET_VRING_KICK _IOW(VHOST_VIRTIO, 0x20, struct vhost_vring_file)</span>
<span class="cm">/* Set eventfd to signal when buffers have beed used */</span>
<span class="cp">#define VHOST_SET_VRING_CALL _IOW(VHOST_VIRTIO, 0x21, struct vhost_vring_file)</span>
<span class="cm">/* Set eventfd to signal an error */</span>
<span class="cp">#define VHOST_SET_VRING_ERR _IOW(VHOST_VIRTIO, 0x22, struct vhost_vring_file)</span>

<span class="cm">/* VHOST_NET specific defines */</span>

<span class="cm">/* Attach virtio net ring to a raw socket, or tap device.</span>
<span class="cm"> * The socket must be already bound to an ethernet device, this device will be</span>
<span class="cm"> * used for transmit.  Pass fd -1 to unbind from the socket and the transmit</span>
<span class="cm"> * device.  This can be used to stop the ring (e.g. for migration). */</span>
<span class="cp">#define VHOST_NET_SET_BACKEND _IOW(VHOST_VIRTIO, 0x30, struct vhost_vring_file)</span>

<span class="cm">/* Feature bits */</span>
<span class="cm">/* Log all write descriptors. Can be changed while device is active. */</span>
<span class="cp">#define VHOST_F_LOG_ALL 26</span>
<span class="cm">/* vhost-net should add virtio_net_hdr for RX, and strip for TX packets. */</span>
<span class="cp">#define VHOST_NET_F_VIRTIO_NET_HDR 27</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
