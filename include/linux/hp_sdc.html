<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › hp_sdc.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hp_sdc.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * HP i8042 System Device Controller -- header</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001 Brian S. Julin</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. The name of the author may not be used to endorse or promote products</span>
<span class="cm"> *    derived from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;).</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="cm"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> *</span>
<span class="cm"> * References:</span>
<span class="cm"> * </span>
<span class="cm"> * HP-HIL Technical Reference Manual.  Hewlett Packard Product No. 45918A</span>
<span class="cm"> *</span>
<span class="cm"> * System Device Controller Microprocessor Firmware Theory of Operation</span>
<span class="cm"> * 	for Part Number 1820-4784 Revision B.  Dwg No. A-1820-4784-2</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _LINUX_HP_SDC_H</span>
<span class="cp">#define _LINUX_HP_SDC_H</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#if defined(__hppa__)</span>
<span class="cp">#include &lt;asm/hardware.h&gt;</span>
<span class="cp">#endif</span>


<span class="cm">/* No 4X status reads take longer than this (in usec).</span>
<span class="cm"> */</span>
<span class="cp">#define HP_SDC_MAX_REG_DELAY 20000</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">hp_sdc_irqhook</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> 
			       <span class="kt">uint8_t</span> <span class="n">status</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">hp_sdc_request_timer_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hp_sdc_request_hil_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hp_sdc_request_cooked_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hp_sdc_release_timer_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hp_sdc_release_hil_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hp_sdc_release_cooked_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">actidx</span><span class="p">;</span>	<span class="cm">/* Start of act.  Acts are atomic WRT I/O to SDC */</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>	<span class="cm">/* Index within the act */</span>
	<span class="kt">int</span> <span class="n">endidx</span><span class="p">;</span>	<span class="cm">/* transaction is over and done if idx == endidx */</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">seq</span><span class="p">;</span>	<span class="cm">/* commands/data for the transaction */</span>
	<span class="k">union</span> <span class="p">{</span>
	  <span class="n">hp_sdc_irqhook</span>   <span class="o">*</span><span class="n">irqhook</span><span class="p">;</span>	<span class="cm">/* Callback, isr or tasklet context */</span>
	  <span class="k">struct</span> <span class="n">semaphore</span> <span class="o">*</span><span class="n">semaphore</span><span class="p">;</span>	<span class="cm">/* Semaphore to sleep on. */</span>
	<span class="p">}</span> <span class="n">act</span><span class="p">;</span>
<span class="p">}</span> <span class="n">hp_sdc_transaction</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">__hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">this</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">this</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hp_sdc_dequeue_transaction</span><span class="p">(</span><span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">this</span><span class="p">);</span>

<span class="cm">/* The HP_SDC_ACT* values are peculiar to this driver.</span>
<span class="cm"> * Nuance: never HP_SDC_ACT_DATAIN | HP_SDC_ACT_DEALLOC, use another</span>
<span class="cm"> * act to perform the dealloc.</span>
<span class="cm"> */</span>
<span class="cp">#define HP_SDC_ACT_PRECMD	0x01		</span><span class="cm">/* Send a command first */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_ACT_DATAREG	0x02		</span><span class="cm">/* Set data registers */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_ACT_DATAOUT	0x04		</span><span class="cm">/* Send data bytes */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_ACT_POSTCMD      0x08            </span><span class="cm">/* Send command after */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_ACT_DATAIN	0x10		</span><span class="cm">/* Collect data after */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_ACT_DURING	0x1f</span>
<span class="cp">#define HP_SDC_ACT_SEMAPHORE    0x20            </span><span class="cm">/* Raise semaphore after */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_ACT_CALLBACK	0x40		</span><span class="cm">/* Pass data to IRQ handler */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_ACT_DEALLOC	0x80		</span><span class="cm">/* Destroy transaction after */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_ACT_AFTER	0xe0</span>
<span class="cp">#define HP_SDC_ACT_DEAD		0x60		</span><span class="cm">/* Act timed out. */</span><span class="cp"></span>

<span class="cm">/* Rest of the flags are straightforward representation of the SDC interface */</span>
<span class="cp">#define HP_SDC_STATUS_IBF	0x02	</span><span class="cm">/* Input buffer full */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_STATUS_IRQMASK	0xf0	</span><span class="cm">/* Bits containing &quot;level 1&quot; irq */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_PERIODIC  0x10    </span><span class="cm">/* Periodic 10ms timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_USERTIMER 0x20    </span><span class="cm">/* &quot;Special purpose&quot; timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_TIMER     0x30    </span><span class="cm">/* Both PERIODIC and USERTIMER */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_REG	0x40	</span><span class="cm">/* Data from an i8042 register */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_HILCMD    0x50	</span><span class="cm">/* Command from HIL MLC */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_HILDATA   0x60	</span><span class="cm">/* Data from HIL MLC */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_PUP	0x70	</span><span class="cm">/* Successful power-up self test */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_KCOOKED	0x80	</span><span class="cm">/* Key from cooked kbd */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_KRPG	0xc0	</span><span class="cm">/* Key from Repeat Gen */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_KMOD_SUP	0x10	</span><span class="cm">/* Shift key is up */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STATUS_KMOD_CUP	0x20	</span><span class="cm">/* Control key is up */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_NMISTATUS_FHS	0x40	</span><span class="cm">/* NMI is a fast handshake irq */</span><span class="cp"></span>

<span class="cm">/* Internal i8042 registers (there are more, but they are not too useful). */</span>

<span class="cp">#define HP_SDC_USE		0x02	</span><span class="cm">/* Resource usage (including OB bit) */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_IM		0x04	</span><span class="cm">/* Interrupt mask */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CFG		0x11	</span><span class="cm">/* Configuration register */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_KBLANGUAGE	0x12	</span><span class="cm">/* Keyboard language */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_D0		0x70	</span><span class="cm">/* General purpose data buffer 0 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_D1		0x71	</span><span class="cm">/* General purpose data buffer 1 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_D2		0x72	</span><span class="cm">/* General purpose data buffer 2 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_D3		0x73	</span><span class="cm">/* General purpose data buffer 3 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_VT1		0x74	</span><span class="cm">/* Timer for voice 1 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_VT2		0x75	</span><span class="cm">/* Timer for voice 2 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_VT3		0x76	</span><span class="cm">/* Timer for voice 3 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_VT4		0x77	</span><span class="cm">/* Timer for voice 4 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_KBN		0x78	</span><span class="cm">/* Which HIL devs are Nimitz */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_KBC		0x79	</span><span class="cm">/* Which HIL devs are cooked kbds */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPS		0x7a	</span><span class="cm">/* i8042&#39;s view of HIL status */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPC		0x7b	</span><span class="cm">/* i8042&#39;s view of HIL &quot;control&quot; */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_RSV  		0x7c	</span><span class="cm">/* Reserved &quot;for testing&quot; */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPR		0x7d    </span><span class="cm">/* i8042 count of HIL reconfigs */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_XTD		0x7e    </span><span class="cm">/* &quot;Extended Configuration&quot; register */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_STR		0x7f    </span><span class="cm">/* i8042 self-test result */</span><span class="cp"></span>

<span class="cm">/* Bitfields for above registers */</span>
<span class="cp">#define HP_SDC_USE_LOOP		0x04	</span><span class="cm">/* Command is currently on the loop. */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_IM_MASK          0x1f    </span><span class="cm">/* these bits not part of cmd/status */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_IM_FH		0x10	</span><span class="cm">/* Mask the fast handshake irq */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_IM_PT		0x08	</span><span class="cm">/* Mask the periodic timer irq */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_IM_TIMERS	0x04	</span><span class="cm">/* Mask the MT/DT/CT irq */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_IM_RESET		0x02	</span><span class="cm">/* Mask the reset key irq */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_IM_HIL		0x01	</span><span class="cm">/* Mask the HIL MLC irq */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_CFG_ROLLOVER	0x08	</span><span class="cm">/* WTF is &quot;N-key rollover&quot;? */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CFG_KBD		0x10	</span><span class="cm">/* There is a keyboard */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CFG_NEW		0x20	</span><span class="cm">/* Supports/uses HIL MLC */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CFG_KBD_OLD	0x03	</span><span class="cm">/* keyboard code for non-HIL */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CFG_KBD_NEW	0x07	</span><span class="cm">/* keyboard code from HIL autoconfig */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CFG_REV		0x40	</span><span class="cm">/* Code revision bit */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CFG_IDPROM	0x80	</span><span class="cm">/* IDPROM present in kbd (not HIL) */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_LPS_NDEV		0x07	</span><span class="cm">/* # devices autoconfigured on HIL */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPS_ACSUCC	0x08	</span><span class="cm">/* loop autoconfigured successfully */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPS_ACFAIL	0x80	</span><span class="cm">/* last loop autoconfigure failed */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_LPC_APE_IPF	0x01	</span><span class="cm">/* HIL MLC APE/IPF (autopoll) set */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPC_ARCONERR	0x02	</span><span class="cm">/* i8042 autoreconfigs loop on err */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPC_ARCQUIET	0x03	</span><span class="cm">/* i8042 doesn&#39;t report autoreconfigs*/</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPC_COOK		0x10	</span><span class="cm">/* i8042 cooks devices in _KBN */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_LPC_RC		0x80	</span><span class="cm">/* causes autoreconfig */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_XTD_REV		0x07	</span><span class="cm">/* contains revision code */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_XTD_REV_STRINGS(val, str) \</span>
<span class="cp">switch (val) {						\</span>
<span class="cp">	case 0x1: str = &quot;1820-3712&quot;; break;		\</span>
<span class="cp">	case 0x2: str = &quot;1820-4379&quot;; break;		\</span>
<span class="cp">	case 0x3: str = &quot;1820-4784&quot;; break;		\</span>
<span class="cp">	default: str = &quot;unknown&quot;;			\</span>
<span class="cp">};</span>
<span class="cp">#define HP_SDC_XTD_BEEPER	0x08	</span><span class="cm">/* TI SN76494 beeper available */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_XTD_BBRTC	0x20	</span><span class="cm">/* OKI MSM-58321 BBRTC present */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_CMD_LOAD_RT	0x31	</span><span class="cm">/* Load real time (from 8042) */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_LOAD_FHS	0x36	</span><span class="cm">/* Load the fast handshake timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_LOAD_MT	0x38	</span><span class="cm">/* Load the match timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_LOAD_DT	0x3B	</span><span class="cm">/* Load the delay timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_LOAD_CT	0x3E	</span><span class="cm">/* Load the cycle timer */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_CMD_SET_IM	0x40    </span><span class="cm">/* 010xxxxx == set irq mask */</span><span class="cp"></span>

<span class="cm">/* The documents provided do not explicitly state that all registers betweem </span>
<span class="cm"> * 0x01 and 0x1f inclusive can be read by sending their register index as a </span>
<span class="cm"> * command, but this is implied and appears to be the case.</span>
<span class="cm"> */</span>
<span class="cp">#define HP_SDC_CMD_READ_RAM	0x00	</span><span class="cm">/* Load from i8042 RAM (autoinc) */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_USE	0x02	</span><span class="cm">/* Undocumented! Load from usage reg */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_IM	0x04	</span><span class="cm">/* Load current interrupt mask */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_KCC	0x11	</span><span class="cm">/* Load primary kbd config code */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_KLC	0x12	</span><span class="cm">/* Load primary kbd language code */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_T1	0x13	</span><span class="cm">/* Load timer output buffer byte 1 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_T2	0x14	</span><span class="cm">/* Load timer output buffer byte 1 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_T3	0x15	</span><span class="cm">/* Load timer output buffer byte 1 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_T4	0x16	</span><span class="cm">/* Load timer output buffer byte 1 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_T5	0x17	</span><span class="cm">/* Load timer output buffer byte 1 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_D0	0xf0	</span><span class="cm">/* Load from i8042 RAM location 0x70 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_D1	0xf1	</span><span class="cm">/* Load from i8042 RAM location 0x71 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_D2	0xf2	</span><span class="cm">/* Load from i8042 RAM location 0x72 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_D3	0xf3	</span><span class="cm">/* Load from i8042 RAM location 0x73 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_VT1	0xf4	</span><span class="cm">/* Load from i8042 RAM location 0x74 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_VT2	0xf5	</span><span class="cm">/* Load from i8042 RAM location 0x75 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_VT3	0xf6	</span><span class="cm">/* Load from i8042 RAM location 0x76 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_VT4	0xf7	</span><span class="cm">/* Load from i8042 RAM location 0x77 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_KBN	0xf8	</span><span class="cm">/* Load from i8042 RAM location 0x78 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_KBC	0xf9	</span><span class="cm">/* Load from i8042 RAM location 0x79 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_LPS	0xfa	</span><span class="cm">/* Load from i8042 RAM location 0x7a */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_LPC	0xfb	</span><span class="cm">/* Load from i8042 RAM location 0x7b */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_RSV	0xfc	</span><span class="cm">/* Load from i8042 RAM location 0x7c */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_LPR	0xfd	</span><span class="cm">/* Load from i8042 RAM location 0x7d */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_XTD	0xfe	</span><span class="cm">/* Load from i8042 RAM location 0x7e */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_READ_STR	0xff	</span><span class="cm">/* Load from i8042 RAM location 0x7f */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_CMD_SET_ARD	0xA0	</span><span class="cm">/* Set emulated autorepeat delay */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_ARR	0xA2	</span><span class="cm">/* Set emulated autorepeat rate */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_BELL	0xA3	</span><span class="cm">/* Set voice 3 params for &quot;beep&quot; cmd */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_RPGR	0xA6	</span><span class="cm">/* Set &quot;RPG&quot; irq rate (doesn&#39;t work) */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_RTMS	0xAD	</span><span class="cm">/* Set the RTC time (milliseconds) */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_RTD	0xAF	</span><span class="cm">/* Set the RTC time (days) */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_FHS	0xB2	</span><span class="cm">/* Set fast handshake timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_MT	0xB4	</span><span class="cm">/* Set match timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_DT	0xB7	</span><span class="cm">/* Set delay timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_CT	0xBA	</span><span class="cm">/* Set cycle timer */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_RAMP	0xC1	</span><span class="cm">/* Reset READ_RAM autoinc counter */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_D0	0xe0	</span><span class="cm">/* Load to i8042 RAM location 0x70 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_D1	0xe1	</span><span class="cm">/* Load to i8042 RAM location 0x71 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_D2	0xe2	</span><span class="cm">/* Load to i8042 RAM location 0x72 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_D3	0xe3	</span><span class="cm">/* Load to i8042 RAM location 0x73 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_VT1	0xe4	</span><span class="cm">/* Load to i8042 RAM location 0x74 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_VT2	0xe5	</span><span class="cm">/* Load to i8042 RAM location 0x75 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_VT3	0xe6	</span><span class="cm">/* Load to i8042 RAM location 0x76 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_VT4	0xe7	</span><span class="cm">/* Load to i8042 RAM location 0x77 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_KBN	0xe8	</span><span class="cm">/* Load to i8042 RAM location 0x78 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_KBC	0xe9	</span><span class="cm">/* Load to i8042 RAM location 0x79 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_LPS	0xea	</span><span class="cm">/* Load to i8042 RAM location 0x7a */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_LPC	0xeb	</span><span class="cm">/* Load to i8042 RAM location 0x7b */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_RSV	0xec	</span><span class="cm">/* Load to i8042 RAM location 0x7c */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_LPR	0xed	</span><span class="cm">/* Load to i8042 RAM location 0x7d */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_XTD	0xee	</span><span class="cm">/* Load to i8042 RAM location 0x7e */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_SET_STR	0xef	</span><span class="cm">/* Load to i8042 RAM location 0x7f */</span><span class="cp"></span>

<span class="cp">#define HP_SDC_CMD_DO_RTCW	0xc2	</span><span class="cm">/* i8042 RAM 0x70 --&gt; RTC */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_DO_RTCR	0xc3	</span><span class="cm">/* RTC[0x70 0:3] --&gt; irq/status/data */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_DO_BEEP	0xc4	</span><span class="cm">/* i8042 RAM 0x70-74  --&gt; beeper,VT3 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_CMD_DO_HIL	0xc5	</span><span class="cm">/* i8042 RAM 0x70-73 --&gt; </span>
<span class="cm">					   HIL MLC R0,R1 i8042 HIL watchdog */</span><span class="cp"></span>

<span class="cm">/* Values used to (de)mangle input/output to/from the HIL MLC */</span>
<span class="cp">#define HP_SDC_DATA		0x40	</span><span class="cm">/* Data from an 8042 register */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_HIL_CMD		0x50	</span><span class="cm">/* Data from HIL MLC R1/8042 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_HIL_R1MASK	0x0f	</span><span class="cm">/* Contents of HIL MLC R1 0:3 */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_HIL_AUTO		0x10	</span><span class="cm">/* Set if POL results from i8042 */</span><span class="cp">   </span>
<span class="cp">#define HP_SDC_HIL_ISERR	0x80	</span><span class="cm">/* Has meaning as in next 4 values */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_HIL_RC_DONE	0x80	</span><span class="cm">/* i8042 auto-configured loop */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_HIL_ERR		0x81	</span><span class="cm">/* HIL MLC R2 had a bit set */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_HIL_TO		0x82	</span><span class="cm">/* i8042 HIL watchdog expired */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_HIL_RC		0x84	</span><span class="cm">/* i8042 is auto-configuring loop */</span><span class="cp"></span>
<span class="cp">#define HP_SDC_HIL_DAT		0x60	</span><span class="cm">/* Data from HIL MLC R0 */</span><span class="cp"></span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">rwlock_t</span>	<span class="n">ibf_lock</span><span class="p">;</span>
	<span class="n">rwlock_t</span>	<span class="n">lock</span><span class="p">;</span>		<span class="cm">/* user/tasklet lock */</span>
	<span class="n">rwlock_t</span>	<span class="n">rtq_lock</span><span class="p">;</span>	<span class="cm">/* isr/tasklet lock */</span>
	<span class="n">rwlock_t</span>	<span class="n">hook_lock</span><span class="p">;</span>	<span class="cm">/* isr/user lock for handler add/del */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">irq</span><span class="p">,</span> <span class="n">nmi</span><span class="p">;</span>	<span class="cm">/* Our IRQ lines */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">base_io</span><span class="p">,</span> <span class="n">status_io</span><span class="p">,</span> <span class="n">data_io</span><span class="p">;</span> <span class="cm">/* Our IO ports */</span>

	<span class="kt">uint8_t</span>		<span class="n">im</span><span class="p">;</span>		<span class="cm">/* Interrupt mask */</span>
	<span class="kt">int</span>		<span class="n">set_im</span><span class="p">;</span> 	<span class="cm">/* Interrupt mask needs to be set. */</span>

	<span class="kt">int</span>		<span class="n">ibf</span><span class="p">;</span>		<span class="cm">/* Last known status of IBF flag */</span>
	<span class="kt">uint8_t</span>		<span class="n">wi</span><span class="p">;</span>		<span class="cm">/* current i8042 write index */</span>
	<span class="kt">uint8_t</span>		<span class="n">r7</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>          <span class="cm">/* current i8042[0x70 - 0x74] values */</span>
	<span class="kt">uint8_t</span>		<span class="n">r11</span><span class="p">,</span> <span class="n">r7e</span><span class="p">;</span>	<span class="cm">/* Values from version/revision regs */</span>

	<span class="n">hp_sdc_irqhook</span>	<span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="n">hil</span><span class="p">,</span> <span class="o">*</span><span class="n">pup</span><span class="p">,</span> <span class="o">*</span><span class="n">cooked</span><span class="p">;</span>

<span class="cp">#define HP_SDC_QUEUE_LEN 16</span>
	<span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">tq</span><span class="p">[</span><span class="n">HP_SDC_QUEUE_LEN</span><span class="p">];</span> <span class="cm">/* All pending read/writes */</span>

	<span class="kt">int</span>		<span class="n">rcurr</span><span class="p">,</span> <span class="n">rqty</span><span class="p">;</span>	<span class="cm">/* Current read transact in process */</span>
	<span class="k">struct</span> <span class="n">timeval</span>	<span class="n">rtv</span><span class="p">;</span>		<span class="cm">/* Time when current read started */</span>
	<span class="kt">int</span>		<span class="n">wcurr</span><span class="p">;</span>		<span class="cm">/* Current write transact in process */</span>

	<span class="kt">int</span>		<span class="n">dev_err</span><span class="p">;</span>	<span class="cm">/* carries status from registration */</span>
<span class="cp">#if defined(__hppa__)</span>
	<span class="k">struct</span> <span class="n">parisc_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#elif defined(__mc68000__)</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#error No support for device registration on this arch yet.</span>
<span class="cp">#endif</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">kicker</span><span class="p">;</span>	<span class="cm">/* Keeps below task alive */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>	<span class="n">task</span><span class="p">;</span>

<span class="p">}</span> <span class="n">hp_i8042_sdc</span><span class="p">;</span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_HP_SDC_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
