<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › msg.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>msg.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _LINUX_MSG_H</span>
<span class="cp">#define _LINUX_MSG_H</span>

<span class="cp">#include &lt;linux/ipc.h&gt;</span>

<span class="cm">/* ipcs ctl commands */</span>
<span class="cp">#define MSG_STAT 11</span>
<span class="cp">#define MSG_INFO 12</span>

<span class="cm">/* msgrcv options */</span>
<span class="cp">#define MSG_NOERROR     010000  </span><span class="cm">/* no error if message is too big */</span><span class="cp"></span>
<span class="cp">#define MSG_EXCEPT      020000  </span><span class="cm">/* recv any msg except of specified type.*/</span><span class="cp"></span>

<span class="cm">/* Obsolete, used only for backwards compatibility and libc5 compiles */</span>
<span class="k">struct</span> <span class="n">msqid_ds</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipc_perm</span> <span class="n">msg_perm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msg</span> <span class="o">*</span><span class="n">msg_first</span><span class="p">;</span>		<span class="cm">/* first message on queue,unused  */</span>
	<span class="k">struct</span> <span class="n">msg</span> <span class="o">*</span><span class="n">msg_last</span><span class="p">;</span>		<span class="cm">/* last message in queue,unused */</span>
	<span class="n">__kernel_time_t</span> <span class="n">msg_stime</span><span class="p">;</span>	<span class="cm">/* last msgsnd time */</span>
	<span class="n">__kernel_time_t</span> <span class="n">msg_rtime</span><span class="p">;</span>	<span class="cm">/* last msgrcv time */</span>
	<span class="n">__kernel_time_t</span> <span class="n">msg_ctime</span><span class="p">;</span>	<span class="cm">/* last change time */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">msg_lcbytes</span><span class="p">;</span>	<span class="cm">/* Reuse junk fields for 32 bit */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">msg_lqbytes</span><span class="p">;</span>	<span class="cm">/* ditto */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">msg_cbytes</span><span class="p">;</span>	<span class="cm">/* current number of bytes on queue */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">msg_qnum</span><span class="p">;</span>	<span class="cm">/* number of messages in queue */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">msg_qbytes</span><span class="p">;</span>	<span class="cm">/* max number of bytes on queue */</span>
	<span class="n">__kernel_ipc_pid_t</span> <span class="n">msg_lspid</span><span class="p">;</span>	<span class="cm">/* pid of last msgsnd */</span>
	<span class="n">__kernel_ipc_pid_t</span> <span class="n">msg_lrpid</span><span class="p">;</span>	<span class="cm">/* last receive pid */</span>
<span class="p">};</span>

<span class="cm">/* Include the definition of msqid64_ds */</span>
<span class="cp">#include &lt;asm/msgbuf.h&gt;</span>

<span class="cm">/* message buffer for msgsnd and msgrcv calls */</span>
<span class="k">struct</span> <span class="n">msgbuf</span> <span class="p">{</span>
	<span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>         <span class="cm">/* type of message */</span>
	<span class="kt">char</span> <span class="n">mtext</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>      <span class="cm">/* message text */</span>
<span class="p">};</span>

<span class="cm">/* buffer for msgctl calls IPC_INFO, MSG_INFO */</span>
<span class="k">struct</span> <span class="n">msginfo</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">msgpool</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msgmap</span><span class="p">;</span> 
	<span class="kt">int</span> <span class="n">msgmax</span><span class="p">;</span> 
	<span class="kt">int</span> <span class="n">msgmnb</span><span class="p">;</span> 
	<span class="kt">int</span> <span class="n">msgmni</span><span class="p">;</span> 
	<span class="kt">int</span> <span class="n">msgssz</span><span class="p">;</span> 
	<span class="kt">int</span> <span class="n">msgtql</span><span class="p">;</span> 
	<span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">msgseg</span><span class="p">;</span> 
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Scaling factor to compute msgmni:</span>
<span class="cm"> * the memory dedicated to msg queues (msgmni * msgmnb) should occupy</span>
<span class="cm"> * at most 1/MSG_MEM_SCALE of the lowmem (see the formula in ipc/msg.c):</span>
<span class="cm"> * up to 8MB       : msgmni = 16 (MSGMNI)</span>
<span class="cm"> * 4 GB            : msgmni = 8K</span>
<span class="cm"> * more than 16 GB : msgmni = 32K (IPCMNI)</span>
<span class="cm"> */</span>
<span class="cp">#define MSG_MEM_SCALE 32</span>

<span class="cp">#define MSGMNI    16   </span><span class="cm">/* &lt;= IPCMNI */</span><span class="cp">     </span><span class="cm">/* max # of msg queue identifiers */</span><span class="cp"></span>
<span class="cp">#define MSGMAX  8192   </span><span class="cm">/* &lt;= INT_MAX */</span><span class="cp">   </span><span class="cm">/* max size of message (bytes) */</span><span class="cp"></span>
<span class="cp">#define MSGMNB 16384   </span><span class="cm">/* &lt;= INT_MAX */</span><span class="cp">   </span><span class="cm">/* default max size of a message queue */</span><span class="cp"></span>

<span class="cm">/* unused */</span>
<span class="cp">#define MSGPOOL (MSGMNI * MSGMNB / 1024) </span><span class="cm">/* size in kbytes of message pool */</span><span class="cp"></span>
<span class="cp">#define MSGTQL  MSGMNB            </span><span class="cm">/* number of system message headers */</span><span class="cp"></span>
<span class="cp">#define MSGMAP  MSGMNB            </span><span class="cm">/* number of entries in message map */</span><span class="cp"></span>
<span class="cp">#define MSGSSZ  16                </span><span class="cm">/* message segment size */</span><span class="cp"></span>
<span class="cp">#define __MSGSEG ((MSGPOOL * 1024) / MSGSSZ) </span><span class="cm">/* max no. of segments */</span><span class="cp"></span>
<span class="cp">#define MSGSEG (__MSGSEG &lt;= 0xffff ? __MSGSEG : 0xffff)</span>

<span class="cp">#ifdef __KERNEL__</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="cm">/* one msg_msg structure for each message */</span>
<span class="k">struct</span> <span class="n">msg_msg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">m_list</span><span class="p">;</span> 
	<span class="kt">long</span>  <span class="n">m_type</span><span class="p">;</span>          
	<span class="kt">int</span> <span class="n">m_ts</span><span class="p">;</span>           <span class="cm">/* message text size */</span>
	<span class="k">struct</span> <span class="n">msg_msgseg</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">security</span><span class="p">;</span>
	<span class="cm">/* the actual message follows immediately */</span>
<span class="p">};</span>

<span class="cm">/* one msq_queue structure for each present queue on the system */</span>
<span class="k">struct</span> <span class="n">msg_queue</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="n">q_perm</span><span class="p">;</span>
	<span class="kt">time_t</span> <span class="n">q_stime</span><span class="p">;</span>			<span class="cm">/* last msgsnd time */</span>
	<span class="kt">time_t</span> <span class="n">q_rtime</span><span class="p">;</span>			<span class="cm">/* last msgrcv time */</span>
	<span class="kt">time_t</span> <span class="n">q_ctime</span><span class="p">;</span>			<span class="cm">/* last change time */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_cbytes</span><span class="p">;</span>		<span class="cm">/* current number of bytes on queue */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_qnum</span><span class="p">;</span>		<span class="cm">/* number of messages in queue */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_qbytes</span><span class="p">;</span>		<span class="cm">/* max number of bytes on queue */</span>
	<span class="n">pid_t</span> <span class="n">q_lspid</span><span class="p">;</span>			<span class="cm">/* pid of last msgsnd */</span>
	<span class="n">pid_t</span> <span class="n">q_lrpid</span><span class="p">;</span>			<span class="cm">/* last receive pid */</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">q_messages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">q_receivers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">q_senders</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Helper routines for sys_msgsnd and sys_msgrcv */</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="n">do_msgsnd</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">long</span> <span class="n">mtype</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mtext</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="n">do_msgrcv</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pmtype</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mtext</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">long</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_MSG_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
