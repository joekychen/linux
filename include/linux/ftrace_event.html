<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › ftrace_event.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ftrace_event.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _LINUX_FTRACE_EVENT_H</span>
<span class="cp">#define _LINUX_FTRACE_EVENT_H</span>

<span class="cp">#include &lt;linux/ring_buffer.h&gt;</span>
<span class="cp">#include &lt;linux/trace_seq.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/perf_event.h&gt;</span>

<span class="k">struct</span> <span class="n">trace_array</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">tracer</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">dentry</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">trace_print_flags</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">trace_print_flags_u64</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>	<span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ftrace_print_flags_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">delim</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_print_flags</span> <span class="o">*</span><span class="n">flag_array</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ftrace_print_symbols_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_print_flags</span> <span class="o">*</span><span class="n">symbol_array</span><span class="p">);</span>

<span class="cp">#if BITS_PER_LONG == 32</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ftrace_print_symbols_seq_u64</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_print_flags_u64</span>
								 <span class="o">*</span><span class="n">symbol_array</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ftrace_print_hex_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The trace entry - the most basic unit of tracing. This is what</span>
<span class="cm"> * is printed in the end as a single line in the trace output, such as:</span>
<span class="cm"> *</span>
<span class="cm"> *     bash-15816 [01]   235.197585: idle_cpu &lt;- irq_enter</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">trace_entry</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">preempt_count</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">padding</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FTRACE_MAX_EVENT						\</span>
<span class="cp">	((1 &lt;&lt; (sizeof(((struct trace_entry *)0)-&gt;type) * 8)) - 1)</span>

<span class="cm">/*</span>
<span class="cm"> * Trace iterator - used by printout routines who present trace</span>
<span class="cm"> * results to users and which routines might sleep, etc:</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">trace_iterator</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">trace_array</span>	<span class="o">*</span><span class="n">tr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tracer</span>		<span class="o">*</span><span class="n">trace</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cpu_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer_iter</span>	<span class="o">*</span><span class="n">buffer_iter</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">iter_flags</span><span class="p">;</span>

	<span class="cm">/* trace_seq for __print_flags() and __print_symbolic() etc. */</span>
	<span class="k">struct</span> <span class="n">trace_seq</span>	<span class="n">tmp_seq</span><span class="p">;</span>

	<span class="cm">/* The below is zeroed out in pipe_read */</span>
	<span class="k">struct</span> <span class="n">trace_seq</span>	<span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_entry</span>	<span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">lost_events</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">leftover</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ent_size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cpu</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">ts</span><span class="p">;</span>

	<span class="n">loff_t</span>			<span class="n">pos</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">idx</span><span class="p">;</span>

	<span class="n">cpumask_var_t</span>		<span class="n">started</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">trace_event</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="n">print_line_t</span> <span class="p">(</span><span class="o">*</span><span class="n">trace_print_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">trace_event_functions</span> <span class="p">{</span>
	<span class="n">trace_print_func</span>	<span class="n">trace</span><span class="p">;</span>
	<span class="n">trace_print_func</span>	<span class="n">raw</span><span class="p">;</span>
	<span class="n">trace_print_func</span>	<span class="n">hex</span><span class="p">;</span>
	<span class="n">trace_print_func</span>	<span class="n">binary</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">trace_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span>		<span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_event_functions</span>	<span class="o">*</span><span class="n">funcs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">register_ftrace_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">unregister_ftrace_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>

<span class="cm">/* Return values for print_line callback */</span>
<span class="k">enum</span> <span class="n">print_line_t</span> <span class="p">{</span>
	<span class="n">TRACE_TYPE_PARTIAL_LINE</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Retry after flushing the seq */</span>
	<span class="n">TRACE_TYPE_HANDLED</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">TRACE_TYPE_UNHANDLED</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* Relay to other output functions */</span>
	<span class="n">TRACE_TYPE_NO_CONSUME</span>	<span class="o">=</span> <span class="mi">3</span>	<span class="cm">/* Handled but ask to not consume */</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">tracing_generic_entry_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">pc</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span>
<span class="n">trace_current_buffer_lock_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">**</span><span class="n">current_buffer</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">trace_current_buffer_unlock_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">trace_nowake_buffer_unlock_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">trace_nowake_buffer_unlock_commit_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">trace_current_buffer_discard_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">tracing_record_cmdline</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">event_filter</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">trace_reg</span> <span class="p">{</span>
	<span class="n">TRACE_REG_REGISTER</span><span class="p">,</span>
	<span class="n">TRACE_REG_UNREGISTER</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PERF_EVENTS</span>
	<span class="n">TRACE_REG_PERF_REGISTER</span><span class="p">,</span>
	<span class="n">TRACE_REG_PERF_UNREGISTER</span><span class="p">,</span>
	<span class="n">TRACE_REG_PERF_OPEN</span><span class="p">,</span>
	<span class="n">TRACE_REG_PERF_CLOSE</span><span class="p">,</span>
	<span class="n">TRACE_REG_PERF_ADD</span><span class="p">,</span>
	<span class="n">TRACE_REG_PERF_DEL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ftrace_event_call</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ftrace_event_class</span> <span class="p">{</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">system</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">probe</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PERF_EVENTS</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">perf_probe</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">reg</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">trace_reg</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">define_fields</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_fields</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">fields</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">raw_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">ftrace_event_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">trace_reg</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TRACE_EVENT_FL_ENABLED_BIT</span><span class="p">,</span>
	<span class="n">TRACE_EVENT_FL_FILTERED_BIT</span><span class="p">,</span>
	<span class="n">TRACE_EVENT_FL_RECORDED_CMD_BIT</span><span class="p">,</span>
	<span class="n">TRACE_EVENT_FL_CAP_ANY_BIT</span><span class="p">,</span>
	<span class="n">TRACE_EVENT_FL_NO_SET_FILTER_BIT</span><span class="p">,</span>
	<span class="n">TRACE_EVENT_FL_IGNORE_ENABLE_BIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TRACE_EVENT_FL_ENABLED</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TRACE_EVENT_FL_ENABLED_BIT</span><span class="p">),</span>
	<span class="n">TRACE_EVENT_FL_FILTERED</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TRACE_EVENT_FL_FILTERED_BIT</span><span class="p">),</span>
	<span class="n">TRACE_EVENT_FL_RECORDED_CMD</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TRACE_EVENT_FL_RECORDED_CMD_BIT</span><span class="p">),</span>
	<span class="n">TRACE_EVENT_FL_CAP_ANY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TRACE_EVENT_FL_CAP_ANY_BIT</span><span class="p">),</span>
	<span class="n">TRACE_EVENT_FL_NO_SET_FILTER</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TRACE_EVENT_FL_NO_SET_FILTER_BIT</span><span class="p">),</span>
	<span class="n">TRACE_EVENT_FL_IGNORE_ENABLE</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TRACE_EVENT_FL_IGNORE_ENABLE_BIT</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_event_class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_event</span>	<span class="n">event</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">print_fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_filter</span>	<span class="o">*</span><span class="n">filter</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">mod</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 32 bit flags:</span>
<span class="cm">	 *   bit 1:		enabled</span>
<span class="cm">	 *   bit 2:		filter_active</span>
<span class="cm">	 *   bit 3:		enabled cmd record</span>
<span class="cm">	 *</span>
<span class="cm">	 * Changes to flags must hold the event_mutex.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: Reads of flags do not hold the event_mutex since</span>
<span class="cm">	 * they occur in critical sections. But the way flags</span>
<span class="cm">	 * is currently used, these changes do no affect the code</span>
<span class="cm">	 * except that when a change is made, it may have a slight</span>
<span class="cm">	 * delay in propagating the changes to other CPUs due to</span>
<span class="cm">	 * caching and such.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PERF_EVENTS</span>
	<span class="kt">int</span>				<span class="n">perf_refcount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">__percpu</span>	<span class="o">*</span><span class="n">perf_events</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#define __TRACE_EVENT_FLAGS(name, value)				\</span>
<span class="cp">	static int __init trace_init_flags_##name(void)			\</span>
<span class="cp">	{								\</span>
<span class="cp">		event_##name.flags = value;				\</span>
<span class="cp">		return 0;						\</span>
<span class="cp">	}								\</span>
<span class="cp">	early_initcall(trace_init_flags_##name);</span>

<span class="cp">#define PERF_MAX_TRACE_SIZE	2048</span>

<span class="cp">#define MAX_FILTER_STR_VAL	256	</span><span class="cm">/* Should handle KSYM_SYMBOL_LEN */</span><span class="cp"></span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">destroy_preds</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">call</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">filter_match_preds</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rec</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">filter_current_check_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">FILTER_OTHER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">FILTER_STATIC_STRING</span><span class="p">,</span>
	<span class="n">FILTER_DYN_STRING</span><span class="p">,</span>
	<span class="n">FILTER_PTR_STRING</span><span class="p">,</span>
	<span class="n">FILTER_TRACE_FN</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define EVENT_STORAGE_SIZE 128</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">event_storage_mutex</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">event_storage</span><span class="p">[</span><span class="n">EVENT_STORAGE_SIZE</span><span class="p">];</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">trace_event_raw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">call</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">trace_define_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">is_signed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">filter_type</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">trace_add_event_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">call</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">trace_remove_event_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">call</span><span class="p">);</span>

<span class="cp">#define is_signed_type(type)	(((type)(-1)) &lt; 0)</span>

<span class="kt">int</span> <span class="n">trace_set_clr_event</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">system</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The double __builtin_constant_p is because gcc will give us an error</span>
<span class="cm"> * if we try to allocate the static variable to fmt if it is not a</span>
<span class="cm"> * constant. Even with the outer if statement optimizing out.</span>
<span class="cm"> */</span>
<span class="cp">#define event_trace_printk(ip, fmt, args...)				\</span>
<span class="cp">do {									\</span>
<span class="cp">	__trace_printk_check_format(fmt, ##args);			\</span>
<span class="cp">	tracing_record_cmdline(current);				\</span>
<span class="cp">	if (__builtin_constant_p(fmt)) {				\</span>
<span class="cp">		static const char *trace_printk_fmt			\</span>
<span class="cp">		  __attribute__((section(&quot;__trace_printk_fmt&quot;))) =	\</span>
<span class="cp">			__builtin_constant_p(fmt) ? fmt : NULL;		\</span>
<span class="cp">									\</span>
<span class="cp">		__trace_bprintk(ip, trace_printk_fmt, ##args);		\</span>
<span class="cp">	} else								\</span>
<span class="cp">		__trace_printk(ip, fmt, ##args);			\</span>
<span class="cp">} while (0)</span>

<span class="cp">#ifdef CONFIG_PERF_EVENTS</span>
<span class="k">struct</span> <span class="n">perf_event</span><span class="p">;</span>

<span class="n">DECLARE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">perf_trace_regs</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span>  <span class="n">perf_trace_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">perf_trace_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">perf_trace_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">perf_trace_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span>  <span class="n">ftrace_profile_set_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event_id</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">filter_str</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ftrace_profile_free_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="o">*</span><span class="n">perf_trace_buf_prepare</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rctxp</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">perf_trace_buf_submit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span>
		       <span class="n">u64</span> <span class="n">count</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">perf_tp_event</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">rctx</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_FTRACE_EVENT_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
