<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › n_r3964.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>n_r3964.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* r3964 linediscipline for linux</span>
<span class="cm"> *</span>
<span class="cm"> * -----------------------------------------------------------</span>
<span class="cm"> * Copyright by</span>
<span class="cm"> * Philips Automation Projects</span>
<span class="cm"> * Kassel (Germany)</span>
<span class="cm"> * -----------------------------------------------------------</span>
<span class="cm"> * This software may be used and distributed according to the terms of</span>
<span class="cm"> * the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> * L. Haag</span>
<span class="cm"> *</span>
<span class="cm"> * $Log: r3964.h,v $</span>
<span class="cm"> * Revision 1.4  2005/12/21 19:54:24  Kurt Huwig &lt;kurt huwig de&gt;</span>
<span class="cm"> * Fixed HZ usage on 2.6 kernels</span>
<span class="cm"> * Removed unnecessary include</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.3  2001/03/18 13:02:24  dwmw2</span>
<span class="cm"> * Fix timer usage, use spinlocks properly.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.2  2001/03/18 12:53:15  dwmw2</span>
<span class="cm"> * Merge changes in 2.4.2</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.1.1.1  1998/10/13 16:43:14  dwmw2</span>
<span class="cm"> * This&#39;ll screw the version control</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.6  1998/09/30 00:40:38  dwmw2</span>
<span class="cm"> * Updated to use kernel&#39;s N_R3964 if available</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.4  1998/04/02 20:29:44  lhaag</span>
<span class="cm"> * select, blocking, ...</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.3  1998/02/12 18:58:43  root</span>
<span class="cm"> * fixed some memory leaks</span>
<span class="cm"> * calculation of checksum characters</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.2  1998/02/07 13:03:17  root</span>
<span class="cm"> * ioctl read_telegram</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.1  1998/02/06 19:19:43  root</span>
<span class="cm"> * Initial revision</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __LINUX_N_R3964_H__</span>
<span class="cp">#define __LINUX_N_R3964_H__</span>

<span class="cm">/* line disciplines for r3964 protocol */</span>

<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#include &lt;linux/param.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Common ascii handshake characters:</span>
<span class="cm"> */</span>

<span class="cp">#define STX 0x02</span>
<span class="cp">#define ETX 0x03</span>
<span class="cp">#define DLE 0x10</span>
<span class="cp">#define NAK 0x15</span>

<span class="cm">/*</span>
<span class="cm"> * Timeouts (from milliseconds to jiffies)</span>
<span class="cm"> */</span>

<span class="cp">#define R3964_TO_QVZ ((550)*HZ/1000)</span>
<span class="cp">#define R3964_TO_ZVZ ((220)*HZ/1000)</span>
<span class="cp">#define R3964_TO_NO_BUF ((400)*HZ/1000)</span>
<span class="cp">#define R3964_NO_TX_ROOM ((100)*HZ/1000)</span>
<span class="cp">#define R3964_TO_RX_PANIC ((4000)*HZ/1000)</span>
<span class="cp">#define R3964_MAX_RETRIES 5</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Ioctl-commands</span>
<span class="cm"> */</span>

<span class="cp">#define R3964_ENABLE_SIGNALS      0x5301</span>
<span class="cp">#define R3964_SETPRIORITY         0x5302</span>
<span class="cp">#define R3964_USE_BCC             0x5303</span>
<span class="cp">#define R3964_READ_TELEGRAM       0x5304</span>

<span class="cm">/* Options for R3964_SETPRIORITY */</span>
<span class="cp">#define R3964_MASTER   0</span>
<span class="cp">#define R3964_SLAVE    1</span>

<span class="cm">/* Options for R3964_ENABLE_SIGNALS */</span>
<span class="cp">#define R3964_SIG_ACK   0x0001</span>
<span class="cp">#define R3964_SIG_DATA  0x0002</span>
<span class="cp">#define R3964_SIG_ALL   0x000f</span>
<span class="cp">#define R3964_SIG_NONE  0x0000</span>
<span class="cp">#define R3964_USE_SIGIO 0x1000</span>

<span class="cm">/*</span>
<span class="cm"> * r3964 operation states:</span>
<span class="cm"> */</span>
<span class="cp">#ifdef __KERNEL__</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">R3964_IDLE</span><span class="p">,</span> 
	   <span class="n">R3964_TX_REQUEST</span><span class="p">,</span> <span class="n">R3964_TRANSMITTING</span><span class="p">,</span> 
	   <span class="n">R3964_WAIT_ZVZ_BEFORE_TX_RETRY</span><span class="p">,</span> <span class="n">R3964_WAIT_FOR_TX_ACK</span><span class="p">,</span>
	   <span class="n">R3964_WAIT_FOR_RX_BUF</span><span class="p">,</span>
	   <span class="n">R3964_RECEIVING</span><span class="p">,</span> <span class="n">R3964_WAIT_FOR_BCC</span><span class="p">,</span> <span class="n">R3964_WAIT_FOR_RX_REPEAT</span>
	   <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * All open file-handles are &#39;clients&#39; and are stored in a linked list:</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">r3964_message</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>     <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid</span>    <span class="o">*</span><span class="n">pid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">sig_flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">first_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">last_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">next_block_to_read</span><span class="p">;</span>
	<span class="kt">int</span>            <span class="n">msg_count</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#endif</span>

<span class="cm">/* types for msg_id: */</span>
<span class="k">enum</span> <span class="p">{</span><span class="n">R3964_MSG_ACK</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">R3964_MSG_DATA</span> <span class="p">};</span>

<span class="cp">#define R3964_MAX_MSG_COUNT 32</span>

<span class="cm">/* error codes for client messages */</span>
<span class="cp">#define R3964_OK 0        </span><span class="cm">/* no error. */</span><span class="cp"></span>
<span class="cp">#define R3964_TX_FAIL -1  </span><span class="cm">/* transmission error, block NOT sent */</span><span class="cp"></span>
<span class="cp">#define R3964_OVERFLOW -2 </span><span class="cm">/* msg queue overflow */</span><span class="cp"></span>

<span class="cm">/* the client gets this struct when calling read(fd,...): */</span>
<span class="k">struct</span> <span class="n">r3964_client_message</span> <span class="p">{</span>
	  <span class="kt">int</span>     <span class="n">msg_id</span><span class="p">;</span>
	  <span class="kt">int</span>     <span class="n">arg</span><span class="p">;</span>
	  <span class="kt">int</span>     <span class="n">error_code</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define R3964_MTU      256</span>


<span class="cp">#ifdef __KERNEL__</span>

<span class="k">struct</span> <span class="n">r3964_block_header</span><span class="p">;</span>

<span class="cm">/* internal version of client_message: */</span>
<span class="k">struct</span> <span class="n">r3964_message</span> <span class="p">{</span>
	  <span class="kt">int</span>     <span class="n">msg_id</span><span class="p">;</span>
	  <span class="kt">int</span>     <span class="n">arg</span><span class="p">;</span>
	  <span class="kt">int</span>     <span class="n">error_code</span><span class="p">;</span>
	  <span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	  <span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Header of received block in rx_buf/tx_buf:</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">r3964_block_header</span> 
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>             <span class="cm">/* length in chars without header */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>             <span class="cm">/* usually data is located </span>
<span class="cm">                                        immediately behind this struct */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">locks</span><span class="p">;</span>              <span class="cm">/* only used in rx_buffer */</span>
	  
    <span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>  <span class="cm">/* =NULL in rx_buffer */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * If rx_buf hasn&#39;t enough space to store R3964_MTU chars,</span>
<span class="cm"> * we will reject all incoming STX-requests by sending NAK.</span>
<span class="cm"> */</span>

<span class="cp">#define RX_BUF_SIZE    4000</span>
<span class="cp">#define TX_BUF_SIZE    4000</span>
<span class="cp">#define R3964_MAX_BLOCKS_IN_RX_QUEUE 100</span>

<span class="cp">#define R3964_PARITY 0x0001</span>
<span class="cp">#define R3964_FRAME  0x0002</span>
<span class="cp">#define R3964_OVERRUN 0x0004</span>
<span class="cp">#define R3964_UNKNOWN 0x0008</span>
<span class="cp">#define R3964_BREAK   0x0010</span>
<span class="cp">#define R3964_CHECKSUM 0x0020</span>
<span class="cp">#define R3964_ERROR  0x003f</span>
<span class="cp">#define R3964_BCC   0x4000</span>
<span class="cp">#define R3964_DEBUG 0x8000</span>


<span class="k">struct</span> <span class="n">r3964_info</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>     <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">priority</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rx_buf</span><span class="p">;</span>            <span class="cm">/* ring buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tx_buf</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span> <span class="n">read_wait</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>struct wait<em>queue *read</em>wait;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">rx_first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">rx_last</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">tx_first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">tx_last</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_position</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_position</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">last_rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bcc</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">blocks_in_rx_queue</span><span class="p">;</span>
	  
	
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">firstClient</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">tmr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nRetry</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif	</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
