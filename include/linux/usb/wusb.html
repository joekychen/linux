<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › usb › wusb.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wusb.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Wireless USB Standard Definitions</span>
<span class="cm"> * Event Size Tables</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Intel Corporation</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: docs</span>
<span class="cm"> * FIXME: organize properly, group logically</span>
<span class="cm"> *</span>
<span class="cm"> * All the event structures are defined in uwb/spec.h, as they are</span>
<span class="cm"> * common to the WHCI and WUSB radio control interfaces.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __WUSB_H__</span>
<span class="cp">#define __WUSB_H__</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/uwb/spec.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/param.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB Information Element header</span>
<span class="cm"> *</span>
<span class="cm"> * I don&#39;t know why, they decided to make it different to the MBOA MAC</span>
<span class="cm"> * IE Header; beats me.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">bLength</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bIEIdentifier</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">WUIE_ID_WCTA</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">WUIE_ID_CONNECTACK</span><span class="p">,</span>
	<span class="n">WUIE_ID_HOST_INFO</span><span class="p">,</span>
	<span class="n">WUIE_ID_CHANGE_ANNOUNCE</span><span class="p">,</span>
	<span class="n">WUIE_ID_DEVICE_DISCONNECT</span><span class="p">,</span>
	<span class="n">WUIE_ID_HOST_DISCONNECT</span><span class="p">,</span>
	<span class="n">WUIE_ID_KEEP_ALIVE</span> <span class="o">=</span> <span class="mh">0x89</span><span class="p">,</span>
	<span class="n">WUIE_ID_ISOCH_DISCARD</span><span class="p">,</span>
	<span class="n">WUIE_ID_RESET_DEVICE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Maximum number of array elements in a WUSB IE.</span>
<span class="cm"> *</span>
<span class="cm"> * WUSB1.0[7.5 before table 7-38] says that in WUSB IEs that</span>
<span class="cm"> * are &quot;arrays&quot; have to limited to 4 elements. So we define it</span>
<span class="cm"> * like that to ease up and submit only the neeed size.</span>
<span class="cm"> */</span>
<span class="cp">#define WUIE_ELT_MAX 4</span>

<span class="cm">/**</span>
<span class="cm"> * Wrapper for the data that defines a CHID, a CDID or a CK</span>
<span class="cm"> *</span>
<span class="cm"> * WUSB defines that CHIDs, CDIDs and CKs are a 16 byte string of</span>
<span class="cm"> * data. In order to avoid confusion and enforce types, we wrap it.</span>
<span class="cm"> *</span>
<span class="cm"> * Make it packed, as we use it in some hw definitions.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">wusb_ckhdid_zero</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">};</span>

<span class="cp">#define WUSB_CKHDID_STRSIZE (3 * sizeof(struct wusb_ckhdid) + 1)</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB IE: Host Information (WUSB1.0[7.5.2])</span>
<span class="cm"> *</span>
<span class="cm"> * Used to provide information about the host to the Wireless USB</span>
<span class="cm"> * devices in range (CHID can be used as an ASCII string).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wuie_host_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">attributes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">CHID</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB IE: Connect Ack (WUSB1.0[7.5.1])</span>
<span class="cm"> *</span>
<span class="cm"> * Used to acknowledge device connect requests. See note for</span>
<span class="cm"> * WUIE_ELT_MAX.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wuie_connect_ack</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">CDID</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">bDeviceAddress</span><span class="p">;</span>	<span class="cm">/* 0 means unused */</span>
		<span class="n">u8</span> <span class="n">bReserved</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">blk</span><span class="p">[</span><span class="n">WUIE_ELT_MAX</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB IE Host Information Element, Connect Availability</span>
<span class="cm"> *</span>
<span class="cm"> * WUSB1.0[7.5.2], bmAttributes description</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">WUIE_HI_CAP_RECONNECT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">WUIE_HI_CAP_LIMITED</span><span class="p">,</span>
	<span class="n">WUIE_HI_CAP_RESERVED</span><span class="p">,</span>
	<span class="n">WUIE_HI_CAP_ALL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB IE: Channel Stop (WUSB1.0[7.5.8])</span>
<span class="cm"> *</span>
<span class="cm"> * Tells devices the host is going to stop sending MMCs and will disappear.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wuie_channel_stop</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">attributes</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">timestamp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB IE: Keepalive (WUSB1.0[7.5.9])</span>
<span class="cm"> *</span>
<span class="cm"> * Ask device(s) to send keepalives.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wuie_keep_alive</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bDeviceAddress</span><span class="p">[</span><span class="n">WUIE_ELT_MAX</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB IE: Reset device (WUSB1.0[7.5.11])</span>
<span class="cm"> *</span>
<span class="cm"> * Tell device to reset; in all truth, we can fit 4 CDIDs, but we only</span>
<span class="cm"> * use it for one at the time...</span>
<span class="cm"> *</span>
<span class="cm"> * In any case, this request is a wee bit silly: why don&#39;t they target</span>
<span class="cm"> * by address??</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wuie_reset</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">CDID</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB IE: Disconnect device (WUSB1.0[7.5.11])</span>
<span class="cm"> *</span>
<span class="cm"> * Tell device to disconnect; we can fit 4 addresses, but we only use</span>
<span class="cm"> * it for one at the time...</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wuie_disconnect</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bDeviceAddress</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB IE: Host disconnect ([WUSB] section 7.5.5)</span>
<span class="cm"> *</span>
<span class="cm"> * Tells all connected devices to disconnect.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wuie_host_disconnect</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="n">hdr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB Device Notification header (WUSB1.0[7.6])</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wusb_dn_hdr</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">bType</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">notifdata</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/** Device Notification codes (WUSB1.0[Table 7-54]) */</span>
<span class="k">enum</span> <span class="n">WUSB_DN</span> <span class="p">{</span>
	<span class="n">WUSB_DN_CONNECT</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">WUSB_DN_DISCONNECT</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">WUSB_DN_EPRDY</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">WUSB_DN_MASAVAILCHANGED</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">WUSB_DN_RWAKE</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">WUSB_DN_SLEEP</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">WUSB_DN_ALIVE</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/** WUSB Device Notification Connect */</span>
<span class="k">struct</span> <span class="n">wusb_dn_connect</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusb_dn_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">attributes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">CDID</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wusb_dn_connect_prev_dev_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_dn_connect</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wusb_dn_connect_new_connection</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_dn_connect</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wusb_dn_connect_beacon_behavior</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_dn_connect</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Device is alive (aka: pong) (WUSB1.0[7.6.7]) */</span>
<span class="k">struct</span> <span class="n">wusb_dn_alive</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusb_dn_hdr</span> <span class="n">hdr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/** Device is disconnecting (WUSB1.0[7.6.2]) */</span>
<span class="k">struct</span> <span class="n">wusb_dn_disconnect</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusb_dn_hdr</span> <span class="n">hdr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* General constants */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">WUSB_TRUST_TIMEOUT_MS</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>	<span class="cm">/* [WUSB] section 4.15.1 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">ckhdid_printf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pr_ckhdid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="o">*</span><span class="n">ckhdid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">pr_ckhdid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			 <span class="s">&quot;%02hx %02hx %02hx %02hx %02hx %02hx %02hx %02hx &quot;</span>
			 <span class="s">&quot;%02hx %02hx %02hx %02hx %02hx %02hx %02hx %02hx&quot;</span><span class="p">,</span>
			 <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			 <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			 <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>  <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			 <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>  <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			 <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>  <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
			 <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
			 <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
			 <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">ckhdid</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * WUSB Crypto stuff (WUSB1.0[6])</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wusb_et_name</span><span class="p">(</span><span class="n">u8</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * WUSB key index WUSB1.0[7.3.2.4], for usage when setting keys for</span>
<span class="cm"> * the host or the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">wusb_key_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">originator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">originator</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WUSB_KEY_INDEX_TYPE_PTK			0 </span><span class="cm">/* for HWA only */</span><span class="cp"></span>
<span class="cp">#define WUSB_KEY_INDEX_TYPE_ASSOC		1</span>
<span class="cp">#define WUSB_KEY_INDEX_TYPE_GTK			2</span>
<span class="cp">#define WUSB_KEY_INDEX_ORIGINATOR_HOST		0</span>
<span class="cp">#define WUSB_KEY_INDEX_ORIGINATOR_DEVICE	1</span>

<span class="cm">/* A CCM Nonce, defined in WUSB1.0[6.4.1] */</span>
<span class="k">struct</span> <span class="n">aes_ccm_nonce</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">sfn</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>              <span class="cm">/* Little Endian */</span>
	<span class="n">u8</span> <span class="n">tkid</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>             <span class="cm">/* LE */</span>
	<span class="k">struct</span> <span class="n">uwb_dev_addr</span> <span class="n">dest_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_dev_addr</span> <span class="n">src_addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* A CCM operation label, defined on WUSB1.0[6.5.x] */</span>
<span class="k">struct</span> <span class="n">aes_ccm_label</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * Input to the key derivation sequence defined in</span>
<span class="cm"> * WUSB1.0[6.5.1]. Rest of the data is in the CCM Nonce passed to the</span>
<span class="cm"> * PRF function.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wusb_keydvt_in</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">hnonce</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">dnonce</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * Output from the key derivation sequence defined in</span>
<span class="cm"> * WUSB1.0[6.5.1].</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wusb_keydvt_out</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">kck</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ptk</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* Pseudo Random Function WUSB1.0[6.5] */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">wusb_crypto_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">wusb_crypto_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">ssize_t</span> <span class="n">wusb_prf</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">out_size</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_nonce</span> <span class="o">*</span><span class="n">_n</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_label</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">blen</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wusb_prf_64</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">out_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_nonce</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_label</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">blen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wusb_prf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">out_size</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wusb_prf_128</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">out_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_nonce</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_label</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">blen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wusb_prf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">out_size</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wusb_prf_256</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">out_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_nonce</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_label</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">blen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wusb_prf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">out_size</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Key derivation WUSB1.0[6.5.1] */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wusb_key_derive</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusb_keydvt_out</span> <span class="o">*</span><span class="n">keydvt_out</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_nonce</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_keydvt_in</span> <span class="o">*</span><span class="n">keydvt_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_label</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">&quot;Pair-wise keys&quot;</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">wusb_prf_256</span><span class="p">(</span><span class="n">keydvt_out</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">keydvt_out</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span>
			    <span class="n">keydvt_in</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">keydvt_in</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Out-of-band MIC Generation WUSB1.0[6.5.2]</span>
<span class="cm"> *</span>
<span class="cm"> * Compute the MIC over @key, @n and @hs and place it in @mic_out.</span>
<span class="cm"> *</span>
<span class="cm"> * @mic_out:  Where to place the 8 byte MIC tag</span>
<span class="cm"> * @key:      KCK from the derivation process</span>
<span class="cm"> * @n:        CCM nonce, n-&gt;sfn == 0, TKID as established in the</span>
<span class="cm"> *            process.</span>
<span class="cm"> * @hs:       Handshake struct for phase 2 of the 4-way.</span>
<span class="cm"> *            hs-&gt;bStatus and hs-&gt;bReserved are zero.</span>
<span class="cm"> *            hs-&gt;bMessageNumber is 2 (WUSB1.0[7.3.2.5.2]</span>
<span class="cm"> *            hs-&gt;dest_addr is the device&#39;s USB address padded with 0</span>
<span class="cm"> *            hs-&gt;src_addr is the hosts&#39;s UWB device address</span>
<span class="cm"> *            hs-&gt;mic is ignored (as we compute that value).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wusb_oob_mic</span><span class="p">(</span><span class="n">u8</span> <span class="n">mic_out</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_nonce</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_handshake</span> <span class="o">*</span><span class="n">hs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">aes_ccm_label</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">&quot;out-of-bandMIC&quot;</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">wusb_prf_64</span><span class="p">(</span><span class="n">mic_out</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span>
			   <span class="n">hs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hs</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hs</span><span class="o">-&gt;</span><span class="n">MIC</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* #ifndef __WUSB_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
