<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › pmu.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pmu.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Definitions for talking to the PMU.  The PMU is a microcontroller</span>
<span class="cm"> * which controls battery charging and system power on PowerBook 3400</span>
<span class="cm"> * and 2400 models as well as the RTC and various other things.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1998 Paul Mackerras.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _LINUX_PMU_H</span>
<span class="cp">#define _LINUX_PMU_H</span>

<span class="cp">#define PMU_DRIVER_VERSION	2</span>

<span class="cm">/*</span>
<span class="cm"> * PMU commands</span>
<span class="cm"> */</span>
<span class="cp">#define PMU_POWER_CTRL0		0x10	</span><span class="cm">/* control power of some devices */</span><span class="cp"></span>
<span class="cp">#define PMU_POWER_CTRL		0x11	</span><span class="cm">/* control power of some devices */</span><span class="cp"></span>
<span class="cp">#define PMU_ADB_CMD		0x20	</span><span class="cm">/* send ADB packet */</span><span class="cp"></span>
<span class="cp">#define PMU_ADB_POLL_OFF	0x21	</span><span class="cm">/* disable ADB auto-poll */</span><span class="cp"></span>
<span class="cp">#define PMU_WRITE_NVRAM		0x33	</span><span class="cm">/* write non-volatile RAM */</span><span class="cp"></span>
<span class="cp">#define PMU_READ_NVRAM		0x3b	</span><span class="cm">/* read non-volatile RAM */</span><span class="cp"></span>
<span class="cp">#define PMU_SET_RTC		0x30	</span><span class="cm">/* set real-time clock */</span><span class="cp"></span>
<span class="cp">#define PMU_READ_RTC		0x38	</span><span class="cm">/* read real-time clock */</span><span class="cp"></span>
<span class="cp">#define PMU_SET_VOLBUTTON	0x40	</span><span class="cm">/* set volume up/down position */</span><span class="cp"></span>
<span class="cp">#define PMU_BACKLIGHT_BRIGHT	0x41	</span><span class="cm">/* set backlight brightness */</span><span class="cp"></span>
<span class="cp">#define PMU_GET_VOLBUTTON	0x48	</span><span class="cm">/* get volume up/down position */</span><span class="cp"></span>
<span class="cp">#define PMU_PCEJECT		0x4c	</span><span class="cm">/* eject PC-card from slot */</span><span class="cp"></span>
<span class="cp">#define PMU_BATTERY_STATE	0x6b	</span><span class="cm">/* report battery state etc. */</span><span class="cp"></span>
<span class="cp">#define PMU_SMART_BATTERY_STATE	0x6f	</span><span class="cm">/* report battery state (new way) */</span><span class="cp"></span>
<span class="cp">#define PMU_SET_INTR_MASK	0x70	</span><span class="cm">/* set PMU interrupt mask */</span><span class="cp"></span>
<span class="cp">#define PMU_INT_ACK		0x78	</span><span class="cm">/* read interrupt bits */</span><span class="cp"></span>
<span class="cp">#define PMU_SHUTDOWN		0x7e	</span><span class="cm">/* turn power off */</span><span class="cp"></span>
<span class="cp">#define PMU_CPU_SPEED		0x7d	</span><span class="cm">/* control CPU speed on some models */</span><span class="cp"></span>
<span class="cp">#define PMU_SLEEP		0x7f	</span><span class="cm">/* put CPU to sleep */</span><span class="cp"></span>
<span class="cp">#define PMU_POWER_EVENTS	0x8f	</span><span class="cm">/* Send power-event commands to PMU */</span><span class="cp"></span>
<span class="cp">#define PMU_I2C_CMD		0x9a	</span><span class="cm">/* I2C operations */</span><span class="cp"></span>
<span class="cp">#define PMU_RESET		0xd0	</span><span class="cm">/* reset CPU */</span><span class="cp"></span>
<span class="cp">#define PMU_GET_BRIGHTBUTTON	0xd9	</span><span class="cm">/* report brightness up/down pos */</span><span class="cp"></span>
<span class="cp">#define PMU_GET_COVER		0xdc	</span><span class="cm">/* report cover open/closed */</span><span class="cp"></span>
<span class="cp">#define PMU_SYSTEM_READY	0xdf	</span><span class="cm">/* tell PMU we are awake */</span><span class="cp"></span>
<span class="cp">#define PMU_GET_VERSION		0xea	</span><span class="cm">/* read the PMU version */</span><span class="cp"></span>

<span class="cm">/* Bits to use with the PMU_POWER_CTRL0 command */</span>
<span class="cp">#define PMU_POW0_ON		0x80	</span><span class="cm">/* OR this to power ON the device */</span><span class="cp"></span>
<span class="cp">#define PMU_POW0_OFF		0x00	</span><span class="cm">/* leave bit 7 to 0 to power it OFF */</span><span class="cp"></span>
<span class="cp">#define PMU_POW0_HARD_DRIVE	0x04	</span><span class="cm">/* Hard drive power (on wallstreet/lombard ?) */</span><span class="cp"></span>

<span class="cm">/* Bits to use with the PMU_POWER_CTRL command */</span>
<span class="cp">#define PMU_POW_ON		0x80	</span><span class="cm">/* OR this to power ON the device */</span><span class="cp"></span>
<span class="cp">#define PMU_POW_OFF		0x00	</span><span class="cm">/* leave bit 7 to 0 to power it OFF */</span><span class="cp"></span>
<span class="cp">#define PMU_POW_BACKLIGHT	0x01	</span><span class="cm">/* backlight power */</span><span class="cp"></span>
<span class="cp">#define PMU_POW_CHARGER		0x02	</span><span class="cm">/* battery charger power */</span><span class="cp"></span>
<span class="cp">#define PMU_POW_IRLED		0x04	</span><span class="cm">/* IR led power (on wallstreet) */</span><span class="cp"></span>
<span class="cp">#define PMU_POW_MEDIABAY	0x08	</span><span class="cm">/* media bay power (wallstreet/lombard ?) */</span><span class="cp"></span>

<span class="cm">/* Bits in PMU interrupt and interrupt mask bytes */</span>
<span class="cp">#define PMU_INT_PCEJECT		0x04	</span><span class="cm">/* PC-card eject buttons */</span><span class="cp"></span>
<span class="cp">#define PMU_INT_SNDBRT		0x08	</span><span class="cm">/* sound/brightness up/down buttons */</span><span class="cp"></span>
<span class="cp">#define PMU_INT_ADB		0x10	</span><span class="cm">/* ADB autopoll or reply data */</span><span class="cp"></span>
<span class="cp">#define PMU_INT_BATTERY		0x20	</span><span class="cm">/* Battery state change */</span><span class="cp"></span>
<span class="cp">#define PMU_INT_ENVIRONMENT	0x40	</span><span class="cm">/* Environment interrupts */</span><span class="cp"></span>
<span class="cp">#define PMU_INT_TICK		0x80	</span><span class="cm">/* 1-second tick interrupt */</span><span class="cp"></span>

<span class="cm">/* Other bits in PMU interrupt valid when PMU_INT_ADB is set */</span>
<span class="cp">#define PMU_INT_ADB_AUTO	0x04	</span><span class="cm">/* ADB autopoll, when PMU_INT_ADB */</span><span class="cp"></span>
<span class="cp">#define PMU_INT_WAITING_CHARGER	0x01	</span><span class="cm">/* ??? */</span><span class="cp"></span>
<span class="cp">#define PMU_INT_AUTO_SRQ_POLL	0x02	</span><span class="cm">/* ??? */</span><span class="cp"></span>

<span class="cm">/* Bits in the environement message (either obtained via PMU_GET_COVER,</span>
<span class="cm"> * or via PMU_INT_ENVIRONMENT on core99 */</span>
<span class="cp">#define PMU_ENV_LID_CLOSED	0x01	</span><span class="cm">/* The lid is closed */</span><span class="cp"></span>

<span class="cm">/* I2C related definitions */</span>
<span class="cp">#define PMU_I2C_MODE_SIMPLE	0</span>
<span class="cp">#define PMU_I2C_MODE_STDSUB	1</span>
<span class="cp">#define PMU_I2C_MODE_COMBINED	2</span>

<span class="cp">#define PMU_I2C_BUS_STATUS	0</span>
<span class="cp">#define PMU_I2C_BUS_SYSCLK	1</span>
<span class="cp">#define PMU_I2C_BUS_POWER	2</span>

<span class="cp">#define PMU_I2C_STATUS_OK	0</span>
<span class="cp">#define PMU_I2C_STATUS_DATAREAD	1</span>
<span class="cp">#define PMU_I2C_STATUS_BUSY	0xfe</span>


<span class="cm">/* Kind of PMU (model) */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PMU_UNKNOWN</span><span class="p">,</span>
	<span class="n">PMU_OHARE_BASED</span><span class="p">,</span>	<span class="cm">/* 2400, 3400, 3500 (old G3 powerbook) */</span>
	<span class="n">PMU_HEATHROW_BASED</span><span class="p">,</span>	<span class="cm">/* PowerBook G3 series */</span>
	<span class="n">PMU_PADDINGTON_BASED</span><span class="p">,</span>	<span class="cm">/* 1999 PowerBook G3 */</span>
	<span class="n">PMU_KEYLARGO_BASED</span><span class="p">,</span>	<span class="cm">/* Core99 motherboard (PMU99) */</span>
	<span class="n">PMU_68K_V1</span><span class="p">,</span>		<span class="cm">/* 68K PMU, version 1 */</span>
	<span class="n">PMU_68K_V2</span><span class="p">,</span> 		<span class="cm">/* 68K PMU, version 2 */</span>
<span class="p">};</span>

<span class="cm">/* PMU PMU_POWER_EVENTS commands */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PMU_PWR_GET_POWERUP_EVENTS</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">PMU_PWR_SET_POWERUP_EVENTS</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">PMU_PWR_CLR_POWERUP_EVENTS</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">PMU_PWR_GET_WAKEUP_EVENTS</span>	<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">PMU_PWR_SET_WAKEUP_EVENTS</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">PMU_PWR_CLR_WAKEUP_EVENTS</span>	<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Power events wakeup bits */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PMU_PWR_WAKEUP_KEY</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* Wake on key press */</span>
	<span class="n">PMU_PWR_WAKEUP_AC_INSERT</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* Wake on AC adapter plug */</span>
	<span class="n">PMU_PWR_WAKEUP_AC_CHANGE</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">PMU_PWR_WAKEUP_LID_OPEN</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">PMU_PWR_WAKEUP_RING</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
<span class="p">};</span>
	
<span class="cm">/*</span>
<span class="cm"> * Ioctl commands for the /dev/pmu device</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>

<span class="cm">/* no param */</span>
<span class="cp">#define PMU_IOC_SLEEP		_IO(&#39;B&#39;, 0)</span>
<span class="cm">/* out param: u32*	backlight value: 0 to 15 */</span>
<span class="cp">#define PMU_IOC_GET_BACKLIGHT	_IOR(&#39;B&#39;, 1, size_t)</span>
<span class="cm">/* in param: u32	backlight value: 0 to 15 */</span>
<span class="cp">#define PMU_IOC_SET_BACKLIGHT	_IOW(&#39;B&#39;, 2, size_t)</span>
<span class="cm">/* out param: u32*	PMU model */</span>
<span class="cp">#define PMU_IOC_GET_MODEL	_IOR(&#39;B&#39;, 3, size_t)</span>
<span class="cm">/* out param: u32*	has_adb: 0 or 1 */</span>
<span class="cp">#define PMU_IOC_HAS_ADB		_IOR(&#39;B&#39;, 4, size_t) </span>
<span class="cm">/* out param: u32*	can_sleep: 0 or 1 */</span>
<span class="cp">#define PMU_IOC_CAN_SLEEP	_IOR(&#39;B&#39;, 5, size_t) </span>
<span class="cm">/* no param, but historically was _IOR(&#39;B&#39;, 6, 0), meaning 4 bytes */</span>
<span class="cp">#define PMU_IOC_GRAB_BACKLIGHT	_IOR(&#39;B&#39;, 6, size_t) </span>

<span class="cp">#ifdef __KERNEL__</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">find_via_pmu</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">pmu_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="p">),</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">pmu_queue_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_poll</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_poll_adb</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span> <span class="cm">/* For use by xmon */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_wait_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>

<span class="cm">/* For use before switching interrupts off for a long time;</span>
<span class="cm"> * warning: not stackable</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_ADB_PMU)</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmu_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmu_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{}</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_enable_irled</span><span class="p">(</span><span class="kt">int</span> <span class="n">on</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_restart</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_unlock</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">pmu_present</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">pmu_get_model</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_backlight_set_sleep</span><span class="p">(</span><span class="kt">int</span> <span class="n">sleep</span><span class="p">);</span>

<span class="cp">#define PMU_MAX_BATTERIES	2</span>

<span class="cm">/* values for pmu_power_flags */</span>
<span class="cp">#define PMU_PWR_AC_PRESENT	0x00000001</span>

<span class="cm">/* values for pmu_battery_info.flags */</span>
<span class="cp">#define PMU_BATT_PRESENT	0x00000001</span>
<span class="cp">#define PMU_BATT_CHARGING	0x00000002</span>
<span class="cp">#define PMU_BATT_TYPE_MASK	0x000000f0</span>
<span class="cp">#define PMU_BATT_TYPE_SMART	0x00000010 </span><span class="cm">/* Smart battery */</span><span class="cp"></span>
<span class="cp">#define PMU_BATT_TYPE_HOOPER	0x00000020 </span><span class="cm">/* 3400/3500 */</span><span class="cp"></span>
<span class="cp">#define PMU_BATT_TYPE_COMET	0x00000030 </span><span class="cm">/* 2400 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">pmu_battery_info</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">charge</span><span class="p">;</span>		<span class="cm">/* current charge */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">max_charge</span><span class="p">;</span>	<span class="cm">/* maximum charge */</span>
	<span class="kt">signed</span> <span class="kt">int</span>	<span class="n">amperage</span><span class="p">;</span>	<span class="cm">/* current, positive if charging */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">voltage</span><span class="p">;</span>	<span class="cm">/* voltage */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">time_remaining</span><span class="p">;</span>	<span class="cm">/* remaining time */</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">pmu_battery_count</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">pmu_battery_info</span> <span class="n">pmu_batteries</span><span class="p">[</span><span class="n">PMU_MAX_BATTERIES</span><span class="p">];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pmu_power_flags</span><span class="p">;</span>

<span class="cm">/* Backlight */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pmu_backlight_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* some code needs to know if the PMU was suspended for hibernation */</span>
<span class="cp">#if defined(CONFIG_SUSPEND) &amp;&amp; defined(CONFIG_PPC32)</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">pmu_sys_suspended</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cm">/* if power management is not configured it can&#39;t be suspended */</span>
<span class="cp">#define pmu_sys_suspended	0</span>
<span class="cp">#endif</span>

<span class="cp">#endif	</span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_PMU_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
