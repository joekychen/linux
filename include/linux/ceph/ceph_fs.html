<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › ceph › ceph_fs.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ceph_fs.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ceph_fs.h - Ceph constants and data types to share between kernel and</span>
<span class="cm"> * user space.</span>
<span class="cm"> *</span>
<span class="cm"> * Most types in this file are defined as little-endian, and are</span>
<span class="cm"> * primarily intended to describe data structures that pass over the</span>
<span class="cm"> * wire or that are stored on disk.</span>
<span class="cm"> *</span>
<span class="cm"> * LGPL2</span>
<span class="cm"> */</span>

<span class="cp">#ifndef CEPH_FS_H</span>
<span class="cp">#define CEPH_FS_H</span>

<span class="cp">#include &quot;msgr.h&quot;</span>
<span class="cp">#include &quot;rados.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * subprotocol versions.  when specific messages types or high-level</span>
<span class="cm"> * protocols change, bump the affected components.  we keep rev</span>
<span class="cm"> * internal cluster protocols separately from the public,</span>
<span class="cm"> * client-facing protocol.</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_OSD_PROTOCOL     8 </span><span class="cm">/* cluster internal */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_PROTOCOL    12 </span><span class="cm">/* cluster internal */</span><span class="cp"></span>
<span class="cp">#define CEPH_MON_PROTOCOL     5 </span><span class="cm">/* cluster internal */</span><span class="cp"></span>
<span class="cp">#define CEPH_OSDC_PROTOCOL   24 </span><span class="cm">/* server/client */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDSC_PROTOCOL   32 </span><span class="cm">/* server/client */</span><span class="cp"></span>
<span class="cp">#define CEPH_MONC_PROTOCOL   15 </span><span class="cm">/* server/client */</span><span class="cp"></span>


<span class="cp">#define CEPH_INO_ROOT  1</span>
<span class="cp">#define CEPH_INO_CEPH  2        </span><span class="cm">/* hidden .ceph dir */</span><span class="cp"></span>

<span class="cm">/* arbitrary limit on max # of monitors (cluster of 3 is typical) */</span>
<span class="cp">#define CEPH_MAX_MON   31</span>


<span class="cm">/*</span>
<span class="cm"> * feature bits</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_FEATURE_UID            (1&lt;&lt;0)</span>
<span class="cp">#define CEPH_FEATURE_NOSRCADDR      (1&lt;&lt;1)</span>
<span class="cp">#define CEPH_FEATURE_MONCLOCKCHECK  (1&lt;&lt;2)</span>
<span class="cp">#define CEPH_FEATURE_FLOCK          (1&lt;&lt;3)</span>
<span class="cp">#define CEPH_FEATURE_SUBSCRIBE2     (1&lt;&lt;4)</span>
<span class="cp">#define CEPH_FEATURE_MONNAMES       (1&lt;&lt;5)</span>
<span class="cp">#define CEPH_FEATURE_RECONNECT_SEQ  (1&lt;&lt;6)</span>
<span class="cp">#define CEPH_FEATURE_DIRLAYOUTHASH  (1&lt;&lt;7)</span>


<span class="cm">/*</span>
<span class="cm"> * ceph_file_layout - describe data layout for a file/inode</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="p">{</span>
	<span class="cm">/* file -&gt; object mapping */</span>
	<span class="n">__le32</span> <span class="n">fl_stripe_unit</span><span class="p">;</span>     <span class="cm">/* stripe unit, in bytes.  must be multiple</span>
<span class="cm">				      of page size. */</span>
	<span class="n">__le32</span> <span class="n">fl_stripe_count</span><span class="p">;</span>    <span class="cm">/* over this many objects */</span>
	<span class="n">__le32</span> <span class="n">fl_object_size</span><span class="p">;</span>     <span class="cm">/* until objects are this big, then move to</span>
<span class="cm">				      new objects */</span>
	<span class="n">__le32</span> <span class="n">fl_cas_hash</span><span class="p">;</span>        <span class="cm">/* UNUSED.  0 = none; 1 = sha256 */</span>

	<span class="cm">/* pg -&gt; disk layout */</span>
	<span class="n">__le32</span> <span class="n">fl_object_stripe_unit</span><span class="p">;</span>  <span class="cm">/* UNUSED.  for per-object parity, if any */</span>

	<span class="cm">/* object -&gt; pg layout */</span>
	<span class="n">__le32</span> <span class="n">fl_unused</span><span class="p">;</span>       <span class="cm">/* unused; used to be preferred primary (-1) */</span>
	<span class="n">__le32</span> <span class="n">fl_pg_pool</span><span class="p">;</span>      <span class="cm">/* namespace, crush ruleset, rep level */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define CEPH_MIN_STRIPE_UNIT 65536</span>

<span class="kt">int</span> <span class="n">ceph_file_layout_is_valid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="o">*</span><span class="n">layout</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ceph_dir_layout</span> <span class="p">{</span>
	<span class="n">__u8</span>   <span class="n">dl_dir_hash</span><span class="p">;</span>   <span class="cm">/* see ceph_hash.h for ids */</span>
	<span class="n">__u8</span>   <span class="n">dl_unused1</span><span class="p">;</span>
	<span class="n">__u16</span>  <span class="n">dl_unused2</span><span class="p">;</span>
	<span class="n">__u32</span>  <span class="n">dl_unused3</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* crypto algorithms */</span>
<span class="cp">#define CEPH_CRYPTO_NONE 0x0</span>
<span class="cp">#define CEPH_CRYPTO_AES  0x1</span>

<span class="cp">#define CEPH_AES_IV &quot;cephsageyudagreg&quot;</span>

<span class="cm">/* security/authentication protocols */</span>
<span class="cp">#define CEPH_AUTH_UNKNOWN	0x0</span>
<span class="cp">#define CEPH_AUTH_NONE	 	0x1</span>
<span class="cp">#define CEPH_AUTH_CEPHX	 	0x2</span>

<span class="cp">#define CEPH_AUTH_UID_DEFAULT ((__u64) -1)</span>


<span class="cm">/*********************************************</span>
<span class="cm"> * message layer</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * message types</span>
<span class="cm"> */</span>

<span class="cm">/* misc */</span>
<span class="cp">#define CEPH_MSG_SHUTDOWN               1</span>
<span class="cp">#define CEPH_MSG_PING                   2</span>

<span class="cm">/* client &lt;-&gt; monitor */</span>
<span class="cp">#define CEPH_MSG_MON_MAP                4</span>
<span class="cp">#define CEPH_MSG_MON_GET_MAP            5</span>
<span class="cp">#define CEPH_MSG_STATFS                 13</span>
<span class="cp">#define CEPH_MSG_STATFS_REPLY           14</span>
<span class="cp">#define CEPH_MSG_MON_SUBSCRIBE          15</span>
<span class="cp">#define CEPH_MSG_MON_SUBSCRIBE_ACK      16</span>
<span class="cp">#define CEPH_MSG_AUTH			17</span>
<span class="cp">#define CEPH_MSG_AUTH_REPLY		18</span>

<span class="cm">/* client &lt;-&gt; mds */</span>
<span class="cp">#define CEPH_MSG_MDS_MAP                21</span>

<span class="cp">#define CEPH_MSG_CLIENT_SESSION         22</span>
<span class="cp">#define CEPH_MSG_CLIENT_RECONNECT       23</span>

<span class="cp">#define CEPH_MSG_CLIENT_REQUEST         24</span>
<span class="cp">#define CEPH_MSG_CLIENT_REQUEST_FORWARD 25</span>
<span class="cp">#define CEPH_MSG_CLIENT_REPLY           26</span>
<span class="cp">#define CEPH_MSG_CLIENT_CAPS            0x310</span>
<span class="cp">#define CEPH_MSG_CLIENT_LEASE           0x311</span>
<span class="cp">#define CEPH_MSG_CLIENT_SNAP            0x312</span>
<span class="cp">#define CEPH_MSG_CLIENT_CAPRELEASE      0x313</span>

<span class="cm">/* pool ops */</span>
<span class="cp">#define CEPH_MSG_POOLOP_REPLY           48</span>
<span class="cp">#define CEPH_MSG_POOLOP                 49</span>


<span class="cm">/* osd */</span>
<span class="cp">#define CEPH_MSG_OSD_MAP                41</span>
<span class="cp">#define CEPH_MSG_OSD_OP                 42</span>
<span class="cp">#define CEPH_MSG_OSD_OPREPLY            43</span>
<span class="cp">#define CEPH_MSG_WATCH_NOTIFY           44</span>


<span class="cm">/* watch-notify operations */</span>
<span class="k">enum</span> <span class="p">{</span>
  <span class="n">WATCH_NOTIFY</span>				<span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* notifying watcher */</span>
  <span class="n">WATCH_NOTIFY_COMPLETE</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* notifier notified when done */</span>
<span class="p">};</span>


<span class="cm">/* pool operations */</span>
<span class="k">enum</span> <span class="p">{</span>
  <span class="n">POOL_OP_CREATE</span>			<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
  <span class="n">POOL_OP_DELETE</span>			<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
  <span class="n">POOL_OP_AUID_CHANGE</span>			<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
  <span class="n">POOL_OP_CREATE_SNAP</span>			<span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
  <span class="n">POOL_OP_DELETE_SNAP</span>			<span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>
  <span class="n">POOL_OP_CREATE_UNMANAGED_SNAP</span>		<span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
  <span class="n">POOL_OP_DELETE_UNMANAGED_SNAP</span>		<span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ceph_mon_request_header</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">have_version</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">session_mon</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">session_mon_tid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mon_statfs</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mon_request_header</span> <span class="n">monhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_statfs</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">kb</span><span class="p">,</span> <span class="n">kb_used</span><span class="p">,</span> <span class="n">kb_avail</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">num_objects</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mon_statfs_reply</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_statfs</span> <span class="n">st</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ceph_pool_op_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ceph_mon_poolop</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mon_request_header</span> <span class="n">monhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">pool</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">auid</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">snapid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">name_len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mon_poolop_reply</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mon_request_header</span> <span class="n">monhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">reply_code</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">epoch</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">has_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mon_unmanaged_snap</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">snapid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_osd_getmap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mon_request_header</span> <span class="n">monhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mds_getmap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mon_request_header</span> <span class="n">monhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_client_mount</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mon_request_header</span> <span class="n">monhdr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define CEPH_SUBSCRIBE_ONETIME    1  </span><span class="cm">/* i want only 1 update after have */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">ceph_mon_subscribe_item</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">have_version</span><span class="p">;</span>    <span class="n">__le64</span> <span class="n">have</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">onetime</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mon_subscribe_ack</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">duration</span><span class="p">;</span>         <span class="cm">/* seconds */</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * mds states</span>
<span class="cm"> *   &gt; 0 -&gt; in</span>
<span class="cm"> *  &lt;= 0 -&gt; out</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_MDS_STATE_DNE          0  </span><span class="cm">/* down, does not exist. */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_STOPPED     -1  </span><span class="cm">/* down, once existed, but no subtrees.</span>
<span class="cm">					  empty log. */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_BOOT        -4  </span><span class="cm">/* up, boot announcement. */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_STANDBY     -5  </span><span class="cm">/* up, idle.  waiting for assignment. */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_CREATING    -6  </span><span class="cm">/* up, creating MDS instance. */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_STARTING    -7  </span><span class="cm">/* up, starting previously stopped mds */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_STANDBY_REPLAY -8 </span><span class="cm">/* up, tailing active node&#39;s journal */</span><span class="cp"></span>

<span class="cp">#define CEPH_MDS_STATE_REPLAY       8  </span><span class="cm">/* up, replaying journal. */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_RESOLVE      9  </span><span class="cm">/* up, disambiguating distributed</span>
<span class="cm">					  operations (import, rename, etc.) */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_RECONNECT    10 </span><span class="cm">/* up, reconnect to clients */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_REJOIN       11 </span><span class="cm">/* up, rejoining distributed cache */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_CLIENTREPLAY 12 </span><span class="cm">/* up, replaying client operations */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_ACTIVE       13 </span><span class="cm">/* up, active */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_STATE_STOPPING     14 </span><span class="cm">/* up, but exporting metadata */</span><span class="cp"></span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ceph_mds_state_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * metadata lock types.</span>
<span class="cm"> *  - these are bitmasks.. we can compose them</span>
<span class="cm"> *  - they also define the lock ordering by the MDS</span>
<span class="cm"> *  - a few of these are internal to the mds</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_LOCK_DVERSION    1</span>
<span class="cp">#define CEPH_LOCK_DN          2</span>
<span class="cp">#define CEPH_LOCK_ISNAP       16</span>
<span class="cp">#define CEPH_LOCK_IVERSION    32    </span><span class="cm">/* mds internal */</span><span class="cp"></span>
<span class="cp">#define CEPH_LOCK_IFILE       64</span>
<span class="cp">#define CEPH_LOCK_IAUTH       128</span>
<span class="cp">#define CEPH_LOCK_ILINK       256</span>
<span class="cp">#define CEPH_LOCK_IDFT        512   </span><span class="cm">/* dir frag tree */</span><span class="cp"></span>
<span class="cp">#define CEPH_LOCK_INEST       1024  </span><span class="cm">/* mds internal */</span><span class="cp"></span>
<span class="cp">#define CEPH_LOCK_IXATTR      2048</span>
<span class="cp">#define CEPH_LOCK_IFLOCK      4096  </span><span class="cm">/* advisory file locks */</span><span class="cp"></span>
<span class="cp">#define CEPH_LOCK_INO         8192  </span><span class="cm">/* immutable inode bits; not a lock */</span><span class="cp"></span>

<span class="cm">/* client_session ops */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CEPH_SESSION_REQUEST_OPEN</span><span class="p">,</span>
	<span class="n">CEPH_SESSION_OPEN</span><span class="p">,</span>
	<span class="n">CEPH_SESSION_REQUEST_CLOSE</span><span class="p">,</span>
	<span class="n">CEPH_SESSION_CLOSE</span><span class="p">,</span>
	<span class="n">CEPH_SESSION_REQUEST_RENEWCAPS</span><span class="p">,</span>
	<span class="n">CEPH_SESSION_RENEWCAPS</span><span class="p">,</span>
	<span class="n">CEPH_SESSION_STALE</span><span class="p">,</span>
	<span class="n">CEPH_SESSION_RECALL_STATE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ceph_session_op_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ceph_mds_session_head</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">stamp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">max_caps</span><span class="p">,</span> <span class="n">max_leases</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* client_request */</span>
<span class="cm">/*</span>
<span class="cm"> * metadata ops.</span>
<span class="cm"> *  &amp; 0x001000 -&gt; write op</span>
<span class="cm"> *  &amp; 0x010000 -&gt; follow symlink (e.g. stat(), not lstat()).</span>
<span class="cm"> &amp;  &amp; 0x100000 -&gt; use weird ino/path trace</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_MDS_OP_WRITE        0x001000</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CEPH_MDS_OP_LOOKUP</span>     <span class="o">=</span> <span class="mh">0x00100</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_GETATTR</span>    <span class="o">=</span> <span class="mh">0x00101</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_LOOKUPHASH</span> <span class="o">=</span> <span class="mh">0x00102</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_LOOKUPPARENT</span> <span class="o">=</span> <span class="mh">0x00103</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_LOOKUPINO</span>  <span class="o">=</span> <span class="mh">0x00104</span><span class="p">,</span>

	<span class="n">CEPH_MDS_OP_SETXATTR</span>   <span class="o">=</span> <span class="mh">0x01105</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_RMXATTR</span>    <span class="o">=</span> <span class="mh">0x01106</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_SETLAYOUT</span>  <span class="o">=</span> <span class="mh">0x01107</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_SETATTR</span>    <span class="o">=</span> <span class="mh">0x01108</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_SETFILELOCK</span><span class="o">=</span> <span class="mh">0x01109</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_GETFILELOCK</span><span class="o">=</span> <span class="mh">0x00110</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_SETDIRLAYOUT</span><span class="o">=</span><span class="mh">0x0110a</span><span class="p">,</span>

	<span class="n">CEPH_MDS_OP_MKNOD</span>      <span class="o">=</span> <span class="mh">0x01201</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_LINK</span>       <span class="o">=</span> <span class="mh">0x01202</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_UNLINK</span>     <span class="o">=</span> <span class="mh">0x01203</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_RENAME</span>     <span class="o">=</span> <span class="mh">0x01204</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_MKDIR</span>      <span class="o">=</span> <span class="mh">0x01220</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_RMDIR</span>      <span class="o">=</span> <span class="mh">0x01221</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_SYMLINK</span>    <span class="o">=</span> <span class="mh">0x01222</span><span class="p">,</span>

	<span class="n">CEPH_MDS_OP_CREATE</span>     <span class="o">=</span> <span class="mh">0x01301</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_OPEN</span>       <span class="o">=</span> <span class="mh">0x00302</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_READDIR</span>    <span class="o">=</span> <span class="mh">0x00305</span><span class="p">,</span>

	<span class="n">CEPH_MDS_OP_LOOKUPSNAP</span> <span class="o">=</span> <span class="mh">0x00400</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_MKSNAP</span>     <span class="o">=</span> <span class="mh">0x01400</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_RMSNAP</span>     <span class="o">=</span> <span class="mh">0x01401</span><span class="p">,</span>
	<span class="n">CEPH_MDS_OP_LSSNAP</span>     <span class="o">=</span> <span class="mh">0x00402</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ceph_mds_op_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">);</span>


<span class="cp">#define CEPH_SETATTR_MODE   1</span>
<span class="cp">#define CEPH_SETATTR_UID    2</span>
<span class="cp">#define CEPH_SETATTR_GID    4</span>
<span class="cp">#define CEPH_SETATTR_MTIME  8</span>
<span class="cp">#define CEPH_SETATTR_ATIME 16</span>
<span class="cp">#define CEPH_SETATTR_SIZE  32</span>
<span class="cp">#define CEPH_SETATTR_CTIME 64</span>

<span class="k">union</span> <span class="n">ceph_mds_request_args</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">mask</span><span class="p">;</span>                 <span class="cm">/* CEPH_CAP_* */</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">getattr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">uid</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">gid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">mtime</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">atime</span><span class="p">;</span>
		<span class="n">__le64</span> <span class="n">size</span><span class="p">,</span> <span class="n">old_size</span><span class="p">;</span>       <span class="cm">/* old_size needed by truncate */</span>
		<span class="n">__le32</span> <span class="n">mask</span><span class="p">;</span>                 <span class="cm">/* CEPH_SETATTR_* */</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">setattr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">frag</span><span class="p">;</span>                 <span class="cm">/* which dir fragment */</span>
		<span class="n">__le32</span> <span class="n">max_entries</span><span class="p">;</span>          <span class="cm">/* how many dentries to grab */</span>
		<span class="n">__le32</span> <span class="n">max_bytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">readdir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">mknod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">mkdir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">stripe_unit</span><span class="p">;</span>          <span class="cm">/* layout for newly created file */</span>
		<span class="n">__le32</span> <span class="n">stripe_count</span><span class="p">;</span>         <span class="cm">/* ... */</span>
		<span class="n">__le32</span> <span class="n">object_size</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">file_replication</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">unused</span><span class="p">;</span>               <span class="cm">/* used to be preferred osd */</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">open</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">setxattr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="n">layout</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">setlayout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">rule</span><span class="p">;</span> <span class="cm">/* currently fcntl or flock */</span>
		<span class="n">__u8</span> <span class="n">type</span><span class="p">;</span> <span class="cm">/* shared, exclusive, remove*/</span>
		<span class="n">__le64</span> <span class="n">pid</span><span class="p">;</span> <span class="cm">/* process id requesting the lock */</span>
		<span class="n">__le64</span> <span class="n">pid_namespace</span><span class="p">;</span>
		<span class="n">__le64</span> <span class="n">start</span><span class="p">;</span> <span class="cm">/* initial location to lock */</span>
		<span class="n">__le64</span> <span class="n">length</span><span class="p">;</span> <span class="cm">/* num bytes to lock from start */</span>
		<span class="n">__u8</span> <span class="n">wait</span><span class="p">;</span> <span class="cm">/* will caller wait for lock to become available? */</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">filelock_change</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define CEPH_MDS_FLAG_REPLAY        1  </span><span class="cm">/* this is a replayed op */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_FLAG_WANT_DENTRY   2  </span><span class="cm">/* want dentry in reply */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">ceph_mds_request_head</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">oldest_client_tid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">mdsmap_epoch</span><span class="p">;</span>           <span class="cm">/* on client */</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>                  <span class="cm">/* CEPH_MDS_FLAG_* */</span>
	<span class="n">__u8</span> <span class="n">num_retry</span><span class="p">,</span> <span class="n">num_fwd</span><span class="p">;</span>       <span class="cm">/* count retry, fwd attempts */</span>
	<span class="n">__le16</span> <span class="n">num_releases</span><span class="p">;</span>           <span class="cm">/* # include cap/lease release records */</span>
	<span class="n">__le32</span> <span class="n">op</span><span class="p">;</span>                     <span class="cm">/* mds op code */</span>
	<span class="n">__le32</span> <span class="n">caller_uid</span><span class="p">,</span> <span class="n">caller_gid</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">ino</span><span class="p">;</span>                    <span class="cm">/* use this ino for openc, mkdir, mknod,</span>
<span class="cm">					  etc. (if replaying) */</span>
	<span class="k">union</span> <span class="n">ceph_mds_request_args</span> <span class="n">args</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* cap/lease release record */</span>
<span class="k">struct</span> <span class="n">ceph_mds_request_release</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">ino</span><span class="p">,</span> <span class="n">cap_id</span><span class="p">;</span>            <span class="cm">/* ino and unique cap id */</span>
	<span class="n">__le32</span> <span class="n">caps</span><span class="p">,</span> <span class="n">wanted</span><span class="p">;</span>           <span class="cm">/* new issued, wanted */</span>
	<span class="n">__le32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">issue_seq</span><span class="p">,</span> <span class="n">mseq</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">dname_seq</span><span class="p">;</span>              <span class="cm">/* if releasing a dentry lease, a */</span>
	<span class="n">__le32</span> <span class="n">dname_len</span><span class="p">;</span>              <span class="cm">/* string follows. */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* client reply */</span>
<span class="k">struct</span> <span class="n">ceph_mds_reply_head</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">mdsmap_epoch</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">safe</span><span class="p">;</span>                     <span class="cm">/* true if committed to disk */</span>
	<span class="n">__u8</span> <span class="n">is_dentry</span><span class="p">,</span> <span class="n">is_target</span><span class="p">;</span>     <span class="cm">/* true if dentry, target inode records</span>
<span class="cm">					  are included with reply */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* one for each node split */</span>
<span class="k">struct</span> <span class="n">ceph_frag_tree_split</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">frag</span><span class="p">;</span>                   <span class="cm">/* this frag splits... */</span>
	<span class="n">__le32</span> <span class="n">by</span><span class="p">;</span>                     <span class="cm">/* ...by this many bits */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_frag_tree_head</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">nsplits</span><span class="p">;</span>                <span class="cm">/* num ceph_frag_tree_split records */</span>
	<span class="k">struct</span> <span class="n">ceph_frag_tree_split</span> <span class="n">splits</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* capability issue, for bundling with mds reply */</span>
<span class="k">struct</span> <span class="n">ceph_mds_reply_cap</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">caps</span><span class="p">,</span> <span class="n">wanted</span><span class="p">;</span>           <span class="cm">/* caps issued, wanted */</span>
	<span class="n">__le64</span> <span class="n">cap_id</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">mseq</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">realm</span><span class="p">;</span>                  <span class="cm">/* snap realm */</span>
	<span class="n">__u8</span> <span class="n">flags</span><span class="p">;</span>                    <span class="cm">/* CEPH_CAP_FLAG_* */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define CEPH_CAP_FLAG_AUTH  1          </span><span class="cm">/* cap is issued by auth mds */</span><span class="cp"></span>

<span class="cm">/* inode record, for bundling with mds reply */</span>
<span class="k">struct</span> <span class="n">ceph_mds_reply_inode</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">ino</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">snapid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">version</span><span class="p">;</span>                <span class="cm">/* inode version */</span>
	<span class="n">__le64</span> <span class="n">xattr_version</span><span class="p">;</span>          <span class="cm">/* version for xattr blob */</span>
	<span class="k">struct</span> <span class="n">ceph_mds_reply_cap</span> <span class="n">cap</span><span class="p">;</span> <span class="cm">/* caps issued for this inode */</span>
	<span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="n">layout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">atime</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">time_warp_seq</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">truncate_size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">truncate_seq</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">mode</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">nlink</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">files</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">rbytes</span><span class="p">,</span> <span class="n">rfiles</span><span class="p">,</span> <span class="n">rsubdirs</span><span class="p">;</span>  <span class="cm">/* dir stats */</span>
	<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">rctime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_frag_tree_head</span> <span class="n">fragtree</span><span class="p">;</span>  <span class="cm">/* (must be at end of struct) */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="cm">/* followed by frag array, symlink string, dir layout, xattr blob */</span>

<span class="cm">/* reply_lease follows dname, and reply_inode */</span>
<span class="k">struct</span> <span class="n">ceph_mds_reply_lease</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">mask</span><span class="p">;</span>            <span class="cm">/* lease type(s) */</span>
	<span class="n">__le32</span> <span class="n">duration_ms</span><span class="p">;</span>     <span class="cm">/* lease duration */</span>
	<span class="n">__le32</span> <span class="n">seq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mds_reply_dirfrag</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">frag</span><span class="p">;</span>            <span class="cm">/* fragment */</span>
	<span class="n">__le32</span> <span class="n">auth</span><span class="p">;</span>            <span class="cm">/* auth mds, if this is a delegation point */</span>
	<span class="n">__le32</span> <span class="n">ndist</span><span class="p">;</span>           <span class="cm">/* number of mds&#39; this is replicated on */</span>
	<span class="n">__le32</span> <span class="n">dist</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define CEPH_LOCK_FCNTL    1</span>
<span class="cp">#define CEPH_LOCK_FLOCK    2</span>

<span class="cp">#define CEPH_LOCK_SHARED   1</span>
<span class="cp">#define CEPH_LOCK_EXCL     2</span>
<span class="cp">#define CEPH_LOCK_UNLOCK   4</span>

<span class="k">struct</span> <span class="n">ceph_filelock</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">start</span><span class="p">;</span><span class="cm">/* file offset to start lock at */</span>
	<span class="n">__le64</span> <span class="n">length</span><span class="p">;</span> <span class="cm">/* num bytes to lock; 0 for all following start */</span>
	<span class="n">__le64</span> <span class="n">client</span><span class="p">;</span> <span class="cm">/* which client holds the lock */</span>
	<span class="n">__le64</span> <span class="n">pid</span><span class="p">;</span> <span class="cm">/* process id holding the lock on the client */</span>
	<span class="n">__le64</span> <span class="n">pid_namespace</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">type</span><span class="p">;</span> <span class="cm">/* shared lock, exclusive lock, or unlock */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>


<span class="cm">/* file access modes */</span>
<span class="cp">#define CEPH_FILE_MODE_PIN        0</span>
<span class="cp">#define CEPH_FILE_MODE_RD         1</span>
<span class="cp">#define CEPH_FILE_MODE_WR         2</span>
<span class="cp">#define CEPH_FILE_MODE_RDWR       3  </span><span class="cm">/* RD | WR */</span><span class="cp"></span>
<span class="cp">#define CEPH_FILE_MODE_LAZY       4  </span><span class="cm">/* lazy io */</span><span class="cp"></span>
<span class="cp">#define CEPH_FILE_MODE_NUM        8  </span><span class="cm">/* bc these are bit fields.. mostly */</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">ceph_flags_to_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>


<span class="cm">/* capability bits */</span>
<span class="cp">#define CEPH_CAP_PIN         1  </span><span class="cm">/* no specific capabilities beyond the pin */</span><span class="cp"></span>

<span class="cm">/* generic cap bits */</span>
<span class="cp">#define CEPH_CAP_GSHARED     1  </span><span class="cm">/* client can reads */</span><span class="cp"></span>
<span class="cp">#define CEPH_CAP_GEXCL       2  </span><span class="cm">/* client can read and update */</span><span class="cp"></span>
<span class="cp">#define CEPH_CAP_GCACHE      4  </span><span class="cm">/* (file) client can cache reads */</span><span class="cp"></span>
<span class="cp">#define CEPH_CAP_GRD         8  </span><span class="cm">/* (file) client can read */</span><span class="cp"></span>
<span class="cp">#define CEPH_CAP_GWR        16  </span><span class="cm">/* (file) client can write */</span><span class="cp"></span>
<span class="cp">#define CEPH_CAP_GBUFFER    32  </span><span class="cm">/* (file) client can buffer writes */</span><span class="cp"></span>
<span class="cp">#define CEPH_CAP_GWREXTEND  64  </span><span class="cm">/* (file) client can extend EOF */</span><span class="cp"></span>
<span class="cp">#define CEPH_CAP_GLAZYIO   128  </span><span class="cm">/* (file) client can perform lazy io */</span><span class="cp"></span>

<span class="cm">/* per-lock shift */</span>
<span class="cp">#define CEPH_CAP_SAUTH      2</span>
<span class="cp">#define CEPH_CAP_SLINK      4</span>
<span class="cp">#define CEPH_CAP_SXATTR     6</span>
<span class="cp">#define CEPH_CAP_SFILE      8</span>
<span class="cp">#define CEPH_CAP_SFLOCK    20 </span>

<span class="cp">#define CEPH_CAP_BITS       22</span>

<span class="cm">/* composed values */</span>
<span class="cp">#define CEPH_CAP_AUTH_SHARED  (CEPH_CAP_GSHARED  &lt;&lt; CEPH_CAP_SAUTH)</span>
<span class="cp">#define CEPH_CAP_AUTH_EXCL     (CEPH_CAP_GEXCL     &lt;&lt; CEPH_CAP_SAUTH)</span>
<span class="cp">#define CEPH_CAP_LINK_SHARED  (CEPH_CAP_GSHARED  &lt;&lt; CEPH_CAP_SLINK)</span>
<span class="cp">#define CEPH_CAP_LINK_EXCL     (CEPH_CAP_GEXCL     &lt;&lt; CEPH_CAP_SLINK)</span>
<span class="cp">#define CEPH_CAP_XATTR_SHARED (CEPH_CAP_GSHARED  &lt;&lt; CEPH_CAP_SXATTR)</span>
<span class="cp">#define CEPH_CAP_XATTR_EXCL    (CEPH_CAP_GEXCL     &lt;&lt; CEPH_CAP_SXATTR)</span>
<span class="cp">#define CEPH_CAP_FILE(x)    (x &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FILE_SHARED   (CEPH_CAP_GSHARED   &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FILE_EXCL     (CEPH_CAP_GEXCL     &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FILE_CACHE    (CEPH_CAP_GCACHE    &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FILE_RD       (CEPH_CAP_GRD       &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FILE_WR       (CEPH_CAP_GWR       &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FILE_BUFFER   (CEPH_CAP_GBUFFER   &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FILE_WREXTEND (CEPH_CAP_GWREXTEND &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FILE_LAZYIO   (CEPH_CAP_GLAZYIO   &lt;&lt; CEPH_CAP_SFILE)</span>
<span class="cp">#define CEPH_CAP_FLOCK_SHARED  (CEPH_CAP_GSHARED   &lt;&lt; CEPH_CAP_SFLOCK)</span>
<span class="cp">#define CEPH_CAP_FLOCK_EXCL    (CEPH_CAP_GEXCL     &lt;&lt; CEPH_CAP_SFLOCK)</span>


<span class="cm">/* cap masks (for getattr) */</span>
<span class="cp">#define CEPH_STAT_CAP_INODE    CEPH_CAP_PIN</span>
<span class="cp">#define CEPH_STAT_CAP_TYPE     CEPH_CAP_PIN  </span><span class="cm">/* mode &gt;&gt; 12 */</span><span class="cp"></span>
<span class="cp">#define CEPH_STAT_CAP_SYMLINK  CEPH_CAP_PIN</span>
<span class="cp">#define CEPH_STAT_CAP_UID      CEPH_CAP_AUTH_SHARED</span>
<span class="cp">#define CEPH_STAT_CAP_GID      CEPH_CAP_AUTH_SHARED</span>
<span class="cp">#define CEPH_STAT_CAP_MODE     CEPH_CAP_AUTH_SHARED</span>
<span class="cp">#define CEPH_STAT_CAP_NLINK    CEPH_CAP_LINK_SHARED</span>
<span class="cp">#define CEPH_STAT_CAP_LAYOUT   CEPH_CAP_FILE_SHARED</span>
<span class="cp">#define CEPH_STAT_CAP_MTIME    CEPH_CAP_FILE_SHARED</span>
<span class="cp">#define CEPH_STAT_CAP_SIZE     CEPH_CAP_FILE_SHARED</span>
<span class="cp">#define CEPH_STAT_CAP_ATIME    CEPH_CAP_FILE_SHARED  </span><span class="cm">/* fixme */</span><span class="cp"></span>
<span class="cp">#define CEPH_STAT_CAP_XATTR    CEPH_CAP_XATTR_SHARED</span>
<span class="cp">#define CEPH_STAT_CAP_INODE_ALL (CEPH_CAP_PIN |			\</span>
<span class="cp">				 CEPH_CAP_AUTH_SHARED |	\</span>
<span class="cp">				 CEPH_CAP_LINK_SHARED |	\</span>
<span class="cp">				 CEPH_CAP_FILE_SHARED |	\</span>
<span class="cp">				 CEPH_CAP_XATTR_SHARED)</span>

<span class="cp">#define CEPH_CAP_ANY_SHARED (CEPH_CAP_AUTH_SHARED |			\</span>
<span class="cp">			      CEPH_CAP_LINK_SHARED |			\</span>
<span class="cp">			      CEPH_CAP_XATTR_SHARED |			\</span>
<span class="cp">			      CEPH_CAP_FILE_SHARED)</span>
<span class="cp">#define CEPH_CAP_ANY_RD   (CEPH_CAP_ANY_SHARED | CEPH_CAP_FILE_RD |	\</span>
<span class="cp">			   CEPH_CAP_FILE_CACHE)</span>

<span class="cp">#define CEPH_CAP_ANY_EXCL (CEPH_CAP_AUTH_EXCL |		\</span>
<span class="cp">			   CEPH_CAP_LINK_EXCL |		\</span>
<span class="cp">			   CEPH_CAP_XATTR_EXCL |	\</span>
<span class="cp">			   CEPH_CAP_FILE_EXCL)</span>
<span class="cp">#define CEPH_CAP_ANY_FILE_WR (CEPH_CAP_FILE_WR | CEPH_CAP_FILE_BUFFER |	\</span>
<span class="cp">			      CEPH_CAP_FILE_EXCL)</span>
<span class="cp">#define CEPH_CAP_ANY_WR   (CEPH_CAP_ANY_EXCL | CEPH_CAP_ANY_FILE_WR)</span>
<span class="cp">#define CEPH_CAP_ANY      (CEPH_CAP_ANY_RD | CEPH_CAP_ANY_EXCL | \</span>
<span class="cp">			   CEPH_CAP_ANY_FILE_WR | CEPH_CAP_FILE_LAZYIO | \</span>
<span class="cp">			   CEPH_CAP_PIN)</span>

<span class="cp">#define CEPH_CAP_LOCKS (CEPH_LOCK_IFILE | CEPH_LOCK_IAUTH | CEPH_LOCK_ILINK | \</span>
<span class="cp">			CEPH_LOCK_IXATTR)</span>

<span class="kt">int</span> <span class="n">ceph_caps_for_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CEPH_CAP_OP_GRANT</span><span class="p">,</span>         <span class="cm">/* mds-&gt;client grant */</span>
	<span class="n">CEPH_CAP_OP_REVOKE</span><span class="p">,</span>        <span class="cm">/* mds-&gt;client revoke */</span>
	<span class="n">CEPH_CAP_OP_TRUNC</span><span class="p">,</span>         <span class="cm">/* mds-&gt;client trunc notify */</span>
	<span class="n">CEPH_CAP_OP_EXPORT</span><span class="p">,</span>        <span class="cm">/* mds has exported the cap */</span>
	<span class="n">CEPH_CAP_OP_IMPORT</span><span class="p">,</span>        <span class="cm">/* mds has imported the cap */</span>
	<span class="n">CEPH_CAP_OP_UPDATE</span><span class="p">,</span>        <span class="cm">/* client-&gt;mds update */</span>
	<span class="n">CEPH_CAP_OP_DROP</span><span class="p">,</span>          <span class="cm">/* client-&gt;mds drop cap bits */</span>
	<span class="n">CEPH_CAP_OP_FLUSH</span><span class="p">,</span>         <span class="cm">/* client-&gt;mds cap writeback */</span>
	<span class="n">CEPH_CAP_OP_FLUSH_ACK</span><span class="p">,</span>     <span class="cm">/* mds-&gt;client flushed */</span>
	<span class="n">CEPH_CAP_OP_FLUSHSNAP</span><span class="p">,</span>     <span class="cm">/* client-&gt;mds flush snapped metadata */</span>
	<span class="n">CEPH_CAP_OP_FLUSHSNAP_ACK</span><span class="p">,</span> <span class="cm">/* mds-&gt;client flushed snapped metadata */</span>
	<span class="n">CEPH_CAP_OP_RELEASE</span><span class="p">,</span>       <span class="cm">/* client-&gt;mds release (clean) cap */</span>
	<span class="n">CEPH_CAP_OP_RENEW</span><span class="p">,</span>         <span class="cm">/* client-&gt;mds renewal request */</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ceph_cap_op_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * caps message, used for capability callbacks, acks, requests, etc.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_mds_caps</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">op</span><span class="p">;</span>                  <span class="cm">/* CEPH_CAP_OP_* */</span>
	<span class="n">__le64</span> <span class="n">ino</span><span class="p">,</span> <span class="n">realm</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">cap_id</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">seq</span><span class="p">,</span> <span class="n">issue_seq</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">caps</span><span class="p">,</span> <span class="n">wanted</span><span class="p">,</span> <span class="n">dirty</span><span class="p">;</span> <span class="cm">/* latest issued/wanted/dirty */</span>
	<span class="n">__le32</span> <span class="n">migrate_seq</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">snap_follows</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">snap_trace_len</span><span class="p">;</span>

	<span class="cm">/* authlock */</span>
	<span class="n">__le32</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* linklock */</span>
	<span class="n">__le32</span> <span class="n">nlink</span><span class="p">;</span>

	<span class="cm">/* xattrlock */</span>
	<span class="n">__le32</span> <span class="n">xattr_len</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">xattr_version</span><span class="p">;</span>

	<span class="cm">/* filelock */</span>
	<span class="n">__le64</span> <span class="n">size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">truncate_size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">truncate_seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">ctime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_file_layout</span> <span class="n">layout</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">time_warp_seq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* cap release msg head */</span>
<span class="k">struct</span> <span class="n">ceph_mds_cap_release</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">num</span><span class="p">;</span>                <span class="cm">/* number of cap_items that follow */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mds_cap_item</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">ino</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">cap_id</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">migrate_seq</span><span class="p">,</span> <span class="n">seq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define CEPH_MDS_LEASE_REVOKE           1  </span><span class="cm">/*    mds  -&gt; client */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_LEASE_RELEASE          2  </span><span class="cm">/* client  -&gt; mds    */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_LEASE_RENEW            3  </span><span class="cm">/* client &lt;-&gt; mds    */</span><span class="cp"></span>
<span class="cp">#define CEPH_MDS_LEASE_REVOKE_ACK       4  </span><span class="cm">/* client  -&gt; mds    */</span><span class="cp"></span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ceph_lease_op_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">o</span><span class="p">);</span>

<span class="cm">/* lease msg header */</span>
<span class="k">struct</span> <span class="n">ceph_mds_lease</span> <span class="p">{</span>
	<span class="n">__u8</span> <span class="n">action</span><span class="p">;</span>            <span class="cm">/* CEPH_MDS_LEASE_* */</span>
	<span class="n">__le16</span> <span class="n">mask</span><span class="p">;</span>            <span class="cm">/* which lease */</span>
	<span class="n">__le64</span> <span class="n">ino</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>     <span class="cm">/* snap range */</span>
	<span class="n">__le32</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">duration_ms</span><span class="p">;</span>     <span class="cm">/* duration of renewal */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="cm">/* followed by a __le32+string for dname */</span>

<span class="cm">/* client reconnect */</span>
<span class="k">struct</span> <span class="n">ceph_mds_cap_reconnect</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">cap_id</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">wanted</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">issued</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">snaprealm</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">pathbase</span><span class="p">;</span>        <span class="cm">/* base ino for our path to this ino */</span>
	<span class="n">__le32</span> <span class="n">flock_len</span><span class="p">;</span>       <span class="cm">/* size of flock state blob, if any */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="cm">/* followed by flock blob */</span>

<span class="k">struct</span> <span class="n">ceph_mds_cap_reconnect_v1</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">cap_id</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">wanted</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">issued</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">atime</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">snaprealm</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">pathbase</span><span class="p">;</span>        <span class="cm">/* base ino for our path to this ino */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_mds_snaprealm_reconnect</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">ino</span><span class="p">;</span>     <span class="cm">/* snap realm base */</span>
	<span class="n">__le64</span> <span class="n">seq</span><span class="p">;</span>     <span class="cm">/* snap seq for this snap realm */</span>
	<span class="n">__le64</span> <span class="n">parent</span><span class="p">;</span>  <span class="cm">/* parent realm */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * snaps</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CEPH_SNAP_OP_UPDATE</span><span class="p">,</span>  <span class="cm">/* CREATE or DESTROY */</span>
	<span class="n">CEPH_SNAP_OP_CREATE</span><span class="p">,</span>
	<span class="n">CEPH_SNAP_OP_DESTROY</span><span class="p">,</span>
	<span class="n">CEPH_SNAP_OP_SPLIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ceph_snap_op_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">o</span><span class="p">);</span>

<span class="cm">/* snap msg header */</span>
<span class="k">struct</span> <span class="n">ceph_mds_snap_head</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">op</span><span class="p">;</span>                <span class="cm">/* CEPH_SNAP_OP_* */</span>
	<span class="n">__le64</span> <span class="n">split</span><span class="p">;</span>             <span class="cm">/* ino to split off, if any */</span>
	<span class="n">__le32</span> <span class="n">num_split_inos</span><span class="p">;</span>    <span class="cm">/* # inos belonging to new child realm */</span>
	<span class="n">__le32</span> <span class="n">num_split_realms</span><span class="p">;</span>  <span class="cm">/* # child realms udner new child realm */</span>
	<span class="n">__le32</span> <span class="n">trace_len</span><span class="p">;</span>         <span class="cm">/* size of snap trace blob */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="cm">/* followed by split ino list, then split realms, then the trace blob */</span>

<span class="cm">/*</span>
<span class="cm"> * encode info about a snaprealm, as viewed by a client</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_mds_snap_realm</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">ino</span><span class="p">;</span>           <span class="cm">/* ino */</span>
	<span class="n">__le64</span> <span class="n">created</span><span class="p">;</span>       <span class="cm">/* snap: when created */</span>
	<span class="n">__le64</span> <span class="n">parent</span><span class="p">;</span>        <span class="cm">/* ino: parent realm */</span>
	<span class="n">__le64</span> <span class="n">parent_since</span><span class="p">;</span>  <span class="cm">/* snap: same parent since */</span>
	<span class="n">__le64</span> <span class="n">seq</span><span class="p">;</span>           <span class="cm">/* snap: version */</span>
	<span class="n">__le32</span> <span class="n">num_snaps</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_prior_parent_snaps</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="cm">/* followed by my snap list, then prior parent snap list */</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
