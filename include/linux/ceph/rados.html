<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › ceph › rados.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rados.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef CEPH_RADOS_H</span>
<span class="cp">#define CEPH_RADOS_H</span>

<span class="cm">/*</span>
<span class="cm"> * Data types for the Ceph distributed object storage layer RADOS</span>
<span class="cm"> * (Reliable Autonomic Distributed Object Store).</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;msgr.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * osdmap encoding versions</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_OSDMAP_INC_VERSION     5</span>
<span class="cp">#define CEPH_OSDMAP_INC_VERSION_EXT 6</span>
<span class="cp">#define CEPH_OSDMAP_VERSION         5</span>
<span class="cp">#define CEPH_OSDMAP_VERSION_EXT     6</span>

<span class="cm">/*</span>
<span class="cm"> * fs id</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fsid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_fsid_compare</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ino, object, etc.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="n">__le64</span> <span class="n">ceph_snapid_t</span><span class="p">;</span>
<span class="cp">#define CEPH_SNAPDIR ((__u64)(-1))  </span><span class="cm">/* reserved for hidden .snap dir */</span><span class="cp"></span>
<span class="cp">#define CEPH_NOSNAP  ((__u64)(-2))  </span><span class="cm">/* &quot;head&quot;, &quot;live&quot; revision */</span><span class="cp"></span>
<span class="cp">#define CEPH_MAXSNAP ((__u64)(-3))  </span><span class="cm">/* largest valid snapid */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tv_nsec</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>


<span class="cm">/*</span>
<span class="cm"> * object layout - how objects are mapped into PGs</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_OBJECT_LAYOUT_HASH     1</span>
<span class="cp">#define CEPH_OBJECT_LAYOUT_LINEAR   2</span>
<span class="cp">#define CEPH_OBJECT_LAYOUT_HASHINO  3</span>

<span class="cm">/*</span>
<span class="cm"> * pg layout -- how PGs are mapped onto (sets of) OSDs</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_PG_LAYOUT_CRUSH  0</span>
<span class="cp">#define CEPH_PG_LAYOUT_HASH   1</span>
<span class="cp">#define CEPH_PG_LAYOUT_LINEAR 2</span>
<span class="cp">#define CEPH_PG_LAYOUT_HYBRID 3</span>

<span class="cp">#define CEPH_PG_MAX_SIZE      16  </span><span class="cm">/* max # osds in a single pg */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * placement group.</span>
<span class="cm"> * we encode this into one __le64.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_pg</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">preferred</span><span class="p">;</span> <span class="cm">/* preferred primary osd */</span>
	<span class="n">__le16</span> <span class="n">ps</span><span class="p">;</span>        <span class="cm">/* placement seed */</span>
	<span class="n">__le32</span> <span class="n">pool</span><span class="p">;</span>      <span class="cm">/* object pool */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * pg_pool is a set of pgs storing a pool of objects</span>
<span class="cm"> *</span>
<span class="cm"> *  pg_num -- base number of pseudorandomly placed pgs</span>
<span class="cm"> *</span>
<span class="cm"> *  pgp_num -- effective number when calculating pg placement.  this</span>
<span class="cm"> * is used for pg_num increases.  new pgs result in data being &quot;split&quot;</span>
<span class="cm"> * into new pgs.  for this to proceed smoothly, new pgs are intiially</span>
<span class="cm"> * colocated with their parents; that is, pgp_num doesn&#39;t increase</span>
<span class="cm"> * until the new pgs have successfully split.  only _then_ are the new</span>
<span class="cm"> * pgs placed independently.</span>
<span class="cm"> *</span>
<span class="cm"> *  lpg_num -- localized pg count (per device).  replicas are randomly</span>
<span class="cm"> * selected.</span>
<span class="cm"> *</span>
<span class="cm"> *  lpgp_num -- as above.</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_PG_TYPE_REP     1</span>
<span class="cp">#define CEPH_PG_TYPE_RAID4   2</span>
<span class="cp">#define CEPH_PG_POOL_VERSION 2</span>
<span class="k">struct</span> <span class="n">ceph_pg_pool</span> <span class="p">{</span>
	<span class="n">__u8</span> <span class="n">type</span><span class="p">;</span>                <span class="cm">/* CEPH_PG_TYPE_* */</span>
	<span class="n">__u8</span> <span class="n">size</span><span class="p">;</span>                <span class="cm">/* number of osds in each pg */</span>
	<span class="n">__u8</span> <span class="n">crush_ruleset</span><span class="p">;</span>       <span class="cm">/* crush placement rule */</span>
	<span class="n">__u8</span> <span class="n">object_hash</span><span class="p">;</span>         <span class="cm">/* hash mapping object name to ps */</span>
	<span class="n">__le32</span> <span class="n">pg_num</span><span class="p">,</span> <span class="n">pgp_num</span><span class="p">;</span>   <span class="cm">/* number of pg&#39;s */</span>
	<span class="n">__le32</span> <span class="n">lpg_num</span><span class="p">,</span> <span class="n">lpgp_num</span><span class="p">;</span> <span class="cm">/* number of localized pg&#39;s */</span>
	<span class="n">__le32</span> <span class="n">last_change</span><span class="p">;</span>       <span class="cm">/* most recent epoch changed */</span>
	<span class="n">__le64</span> <span class="n">snap_seq</span><span class="p">;</span>          <span class="cm">/* seq for per-pool snapshot */</span>
	<span class="n">__le32</span> <span class="n">snap_epoch</span><span class="p">;</span>        <span class="cm">/* epoch of last snap */</span>
	<span class="n">__le32</span> <span class="n">num_snaps</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_removed_snap_intervals</span><span class="p">;</span> <span class="cm">/* if non-empty, NO per-pool snaps */</span>
	<span class="n">__le64</span> <span class="n">auid</span><span class="p">;</span>               <span class="cm">/* who owns the pg */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * stable_mod func is used to control number of placement groups.</span>
<span class="cm"> * similar to straight-up modulo, but produces a stable mapping as b</span>
<span class="cm"> * increases over time.  b is the number of bins, and bmask is the</span>
<span class="cm"> * containing power of 2 minus 1.</span>
<span class="cm"> *</span>
<span class="cm"> * b &lt;= bmask and bmask=(2**n)-1</span>
<span class="cm"> * e.g., b=12 -&gt; bmask=15, b=123 -&gt; bmask=127</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_stable_mod</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">bmask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="n">bmask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bmask</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * object layout - how a given object should be stored.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_object_layout</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_pg</span> <span class="n">ol_pgid</span><span class="p">;</span>   <span class="cm">/* raw pg, with _full_ ps precision. */</span>
	<span class="n">__le32</span> <span class="n">ol_stripe_unit</span><span class="p">;</span>    <span class="cm">/* for per-object parity, if any */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * compound epoch+version, used by storage layer to serialize mutations</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_eversion</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">epoch</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">version</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * osd map bits</span>
<span class="cm"> */</span>

<span class="cm">/* status bits */</span>
<span class="cp">#define CEPH_OSD_EXISTS 1</span>
<span class="cp">#define CEPH_OSD_UP     2</span>

<span class="cm">/* osd weights.  fixed point value: 0x10000 == 1.0 (&quot;in&quot;), 0 == &quot;out&quot; */</span>
<span class="cp">#define CEPH_OSD_IN  0x10000</span>
<span class="cp">#define CEPH_OSD_OUT 0</span>


<span class="cm">/*</span>
<span class="cm"> * osd map flag bits</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_OSDMAP_NEARFULL (1&lt;&lt;0)  </span><span class="cm">/* sync writes (near ENOSPC) */</span><span class="cp"></span>
<span class="cp">#define CEPH_OSDMAP_FULL     (1&lt;&lt;1)  </span><span class="cm">/* no data writes (ENOSPC) */</span><span class="cp"></span>
<span class="cp">#define CEPH_OSDMAP_PAUSERD  (1&lt;&lt;2)  </span><span class="cm">/* pause all reads */</span><span class="cp"></span>
<span class="cp">#define CEPH_OSDMAP_PAUSEWR  (1&lt;&lt;3)  </span><span class="cm">/* pause all writes */</span><span class="cp"></span>
<span class="cp">#define CEPH_OSDMAP_PAUSEREC (1&lt;&lt;4)  </span><span class="cm">/* pause recovery */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * osd ops</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_OSD_OP_MODE       0xf000</span>
<span class="cp">#define CEPH_OSD_OP_MODE_RD    0x1000</span>
<span class="cp">#define CEPH_OSD_OP_MODE_WR    0x2000</span>
<span class="cp">#define CEPH_OSD_OP_MODE_RMW   0x3000</span>
<span class="cp">#define CEPH_OSD_OP_MODE_SUB   0x4000</span>

<span class="cp">#define CEPH_OSD_OP_TYPE       0x0f00</span>
<span class="cp">#define CEPH_OSD_OP_TYPE_LOCK  0x0100</span>
<span class="cp">#define CEPH_OSD_OP_TYPE_DATA  0x0200</span>
<span class="cp">#define CEPH_OSD_OP_TYPE_ATTR  0x0300</span>
<span class="cp">#define CEPH_OSD_OP_TYPE_EXEC  0x0400</span>
<span class="cp">#define CEPH_OSD_OP_TYPE_PG    0x0500</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/** data **/</span>
	<span class="cm">/* read */</span>
	<span class="n">CEPH_OSD_OP_READ</span>      <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_STAT</span>      <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_MAPEXT</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span>

	<span class="cm">/* fancy read */</span>
	<span class="n">CEPH_OSD_OP_MASKTRUNC</span>   <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_SPARSE_READ</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">5</span><span class="p">,</span>

	<span class="n">CEPH_OSD_OP_NOTIFY</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_NOTIFY_ACK</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">7</span><span class="p">,</span>

	<span class="cm">/* versioning */</span>
	<span class="n">CEPH_OSD_OP_ASSERT_VER</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">8</span><span class="p">,</span>

	<span class="cm">/* write */</span>
	<span class="n">CEPH_OSD_OP_WRITE</span>     <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_WRITEFULL</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_TRUNCATE</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_ZERO</span>      <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_DELETE</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">5</span><span class="p">,</span>

	<span class="cm">/* fancy write */</span>
	<span class="n">CEPH_OSD_OP_APPEND</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_STARTSYNC</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_SETTRUNC</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_TRIMTRUNC</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">9</span><span class="p">,</span>

	<span class="n">CEPH_OSD_OP_TMAPUP</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RMW</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_TMAPPUT</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_TMAPGET</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">12</span><span class="p">,</span>

	<span class="n">CEPH_OSD_OP_CREATE</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">13</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_ROLLBACK</span><span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">14</span><span class="p">,</span>

	<span class="n">CEPH_OSD_OP_WATCH</span>   <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span> <span class="o">|</span> <span class="mi">15</span><span class="p">,</span>

	<span class="cm">/** attrs **/</span>
	<span class="cm">/* read */</span>
	<span class="n">CEPH_OSD_OP_GETXATTR</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_ATTR</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_GETXATTRS</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_ATTR</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_CMPXATTR</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_ATTR</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span>

	<span class="cm">/* write */</span>
	<span class="n">CEPH_OSD_OP_SETXATTR</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_ATTR</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_SETXATTRS</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_ATTR</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_RESETXATTRS</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span><span class="o">|</span><span class="n">CEPH_OSD_OP_TYPE_ATTR</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_RMXATTR</span>   <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_ATTR</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span>

	<span class="cm">/** subop **/</span>
	<span class="n">CEPH_OSD_OP_PULL</span>            <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_PUSH</span>            <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_BALANCEREADS</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_UNBALANCEREADS</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_SCRUB</span>           <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span> <span class="o">|</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_SCRUB_RESERVE</span>   <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_SCRUB_UNRESERVE</span> <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span> <span class="o">|</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_SCRUB_STOP</span>      <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span> <span class="o">|</span> <span class="mi">8</span><span class="p">,</span>

	<span class="cm">/** lock **/</span>
	<span class="n">CEPH_OSD_OP_WRLOCK</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_LOCK</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_WRUNLOCK</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_LOCK</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_RDLOCK</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_LOCK</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_RDUNLOCK</span>  <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_LOCK</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_UPLOCK</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_LOCK</span> <span class="o">|</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">CEPH_OSD_OP_DNLOCK</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_WR</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_LOCK</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span>

	<span class="cm">/** exec **/</span>
	<span class="n">CEPH_OSD_OP_CALL</span>    <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_EXEC</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/** pg **/</span>
	<span class="n">CEPH_OSD_OP_PGLS</span>      <span class="o">=</span> <span class="n">CEPH_OSD_OP_MODE_RD</span> <span class="o">|</span> <span class="n">CEPH_OSD_OP_TYPE_PG</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_osd_op_type_lock</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_OP_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_TYPE_LOCK</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_osd_op_type_data</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_OP_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_TYPE_DATA</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_osd_op_type_attr</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_OP_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_TYPE_ATTR</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_osd_op_type_exec</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_OP_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_TYPE_EXEC</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_osd_op_type_pg</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_OP_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_TYPE_PG</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_osd_op_mode_subop</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_OP_MODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_MODE_SUB</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_osd_op_mode_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_OP_MODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_MODE_RD</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ceph_osd_op_mode_modify</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">CEPH_OSD_OP_MODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_OSD_OP_MODE_WR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * note that the following tmap stuff is also defined in the ceph librados.h</span>
<span class="cm"> * any modification here needs to be updated there</span>
<span class="cm"> */</span>
<span class="cp">#define CEPH_OSD_TMAP_HDR &#39;h&#39;</span>
<span class="cp">#define CEPH_OSD_TMAP_SET &#39;s&#39;</span>
<span class="cp">#define CEPH_OSD_TMAP_RM  &#39;r&#39;</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ceph_osd_op_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * osd op flags</span>
<span class="cm"> *</span>
<span class="cm"> * An op may be READ, WRITE, or READ|WRITE.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CEPH_OSD_FLAG_ACK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>          <span class="cm">/* want (or is) &quot;ack&quot; ack */</span>
	<span class="n">CEPH_OSD_FLAG_ONNVRAM</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>      <span class="cm">/* want (or is) &quot;onnvram&quot; ack */</span>
	<span class="n">CEPH_OSD_FLAG_ONDISK</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>       <span class="cm">/* want (or is) &quot;ondisk&quot; ack */</span>
	<span class="n">CEPH_OSD_FLAG_RETRY</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>        <span class="cm">/* resend attempt */</span>
	<span class="n">CEPH_OSD_FLAG_READ</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>        <span class="cm">/* op may read */</span>
	<span class="n">CEPH_OSD_FLAG_WRITE</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>       <span class="cm">/* op may write */</span>
	<span class="n">CEPH_OSD_FLAG_ORDERSNAP</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>   <span class="cm">/* EOLDSNAP if snapc is out of order */</span>
	<span class="n">CEPH_OSD_FLAG_PEERSTAT</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>   <span class="cm">/* msg includes osd_peer_stat */</span>
	<span class="n">CEPH_OSD_FLAG_BALANCE_READS</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
	<span class="n">CEPH_OSD_FLAG_PARALLELEXEC</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="cm">/* execute op in parallel */</span>
	<span class="n">CEPH_OSD_FLAG_PGOP</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>      <span class="cm">/* pg op, no object */</span>
	<span class="n">CEPH_OSD_FLAG_EXEC</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>      <span class="cm">/* op may exec */</span>
	<span class="n">CEPH_OSD_FLAG_EXEC_PUBLIC</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span> <span class="cm">/* op may exec (public) */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CEPH_OSD_OP_FLAG_EXCL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>      <span class="cm">/* EXCL object create */</span>
<span class="p">};</span>

<span class="cp">#define EOLDSNAPC    ERESTART  </span><span class="cm">/* ORDERSNAP flag set; writer has old snapc*/</span><span class="cp"></span>
<span class="cp">#define EBLACKLISTED ESHUTDOWN </span><span class="cm">/* blacklisted */</span><span class="cp"></span>

<span class="cm">/* xattr comparison */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CEPH_OSD_CMPXATTR_OP_NOP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CEPH_OSD_CMPXATTR_OP_EQ</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CEPH_OSD_CMPXATTR_OP_NE</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">CEPH_OSD_CMPXATTR_OP_GT</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">CEPH_OSD_CMPXATTR_OP_GTE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">CEPH_OSD_CMPXATTR_OP_LT</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">CEPH_OSD_CMPXATTR_OP_LTE</span> <span class="o">=</span> <span class="mi">6</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CEPH_OSD_CMPXATTR_MODE_STRING</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">CEPH_OSD_CMPXATTR_MODE_U64</span>    <span class="o">=</span> <span class="mi">2</span>
<span class="p">};</span>

<span class="cp">#define RADOS_NOTIFY_VER	1</span>

<span class="cm">/*</span>
<span class="cm"> * an individual object operation.  each may be accompanied by some data</span>
<span class="cm"> * payload</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_osd_op</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">op</span><span class="p">;</span>           <span class="cm">/* CEPH_OSD_OP_* */</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>        <span class="cm">/* CEPH_OSD_FLAG_* */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">__le64</span> <span class="n">truncate_size</span><span class="p">;</span>
			<span class="n">__le32</span> <span class="n">truncate_seq</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">extent</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le32</span> <span class="n">name_len</span><span class="p">;</span>
			<span class="n">__le32</span> <span class="n">value_len</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="n">cmp_op</span><span class="p">;</span>       <span class="cm">/* CEPH_OSD_CMPXATTR_OP_* */</span>
			<span class="n">__u8</span> <span class="n">cmp_mode</span><span class="p">;</span>     <span class="cm">/* CEPH_OSD_CMPXATTR_MODE_* */</span>
		<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">xattr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__u8</span> <span class="n">class_len</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="n">method_len</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="n">argc</span><span class="p">;</span>
			<span class="n">__le32</span> <span class="n">indata_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">cls</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le64</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">pgls</span><span class="p">;</span>
	        <span class="k">struct</span> <span class="p">{</span>
		        <span class="n">__le64</span> <span class="n">snapid</span><span class="p">;</span>
	        <span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">snap</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le64</span> <span class="n">cookie</span><span class="p">;</span>
			<span class="n">__le64</span> <span class="n">ver</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="n">flag</span><span class="p">;</span>	<span class="cm">/* 0 = unwatch, 1 = watch */</span>
		<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">watch</span><span class="p">;</span>
<span class="p">};</span>
	<span class="n">__le32</span> <span class="n">payload_len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * osd request message header.  each request may include multiple</span>
<span class="cm"> * ceph_osd_op object operations.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_osd_request_head</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">client_inc</span><span class="p">;</span>                 <span class="cm">/* client incarnation */</span>
	<span class="k">struct</span> <span class="n">ceph_object_layout</span> <span class="n">layout</span><span class="p">;</span>  <span class="cm">/* pgid */</span>
	<span class="n">__le32</span> <span class="n">osdmap_epoch</span><span class="p">;</span>               <span class="cm">/* client&#39;s osdmap epoch */</span>

	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ceph_timespec</span> <span class="n">mtime</span><span class="p">;</span>        <span class="cm">/* for mutations only */</span>
	<span class="k">struct</span> <span class="n">ceph_eversion</span> <span class="n">reassert_version</span><span class="p">;</span> <span class="cm">/* if we are replaying op */</span>

	<span class="n">__le32</span> <span class="n">object_len</span><span class="p">;</span>     <span class="cm">/* length of object name */</span>

	<span class="n">__le64</span> <span class="n">snapid</span><span class="p">;</span>         <span class="cm">/* snapid to read */</span>
	<span class="n">__le64</span> <span class="n">snap_seq</span><span class="p">;</span>       <span class="cm">/* writer&#39;s snap context */</span>
	<span class="n">__le32</span> <span class="n">num_snaps</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">num_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_op</span> <span class="n">ops</span><span class="p">[];</span>  <span class="cm">/* followed by ops[], obj, ticket, snaps */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">ceph_osd_reply_head</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">client_inc</span><span class="p">;</span>                <span class="cm">/* client incarnation */</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_object_layout</span> <span class="n">layout</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">osdmap_epoch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_eversion</span> <span class="n">reassert_version</span><span class="p">;</span> <span class="cm">/* for replaying uncommitted */</span>

	<span class="n">__le32</span> <span class="n">result</span><span class="p">;</span>                    <span class="cm">/* result code */</span>

	<span class="n">__le32</span> <span class="n">object_len</span><span class="p">;</span>                <span class="cm">/* length of object name */</span>
	<span class="n">__le32</span> <span class="n">num_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_osd_op</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>  <span class="cm">/* ops[], object */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>



<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
