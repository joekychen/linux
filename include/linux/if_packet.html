<!DOCTYPE html>
<html><head><title>joekychen/linux » include › linux › if_packet.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>if_packet.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __LINUX_IF_PACKET_H</span>
<span class="cp">#define __LINUX_IF_PACKET_H</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="k">struct</span> <span class="n">sockaddr_pkt</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">spkt_family</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">spkt_device</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="n">__be16</span> <span class="n">spkt_protocol</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sockaddr_ll</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">sll_family</span><span class="p">;</span>
	<span class="n">__be16</span>		<span class="n">sll_protocol</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">sll_ifindex</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">sll_hatype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">sll_pkttype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">sll_halen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">sll_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Packet types */</span>

<span class="cp">#define PACKET_HOST		0		</span><span class="cm">/* To us		*/</span><span class="cp"></span>
<span class="cp">#define PACKET_BROADCAST	1		</span><span class="cm">/* To all		*/</span><span class="cp"></span>
<span class="cp">#define PACKET_MULTICAST	2		</span><span class="cm">/* To group		*/</span><span class="cp"></span>
<span class="cp">#define PACKET_OTHERHOST	3		</span><span class="cm">/* To someone else 	*/</span><span class="cp"></span>
<span class="cp">#define PACKET_OUTGOING		4		</span><span class="cm">/* Outgoing of any type */</span><span class="cp"></span>
<span class="cm">/* These ones are invisible by user level */</span>
<span class="cp">#define PACKET_LOOPBACK		5		</span><span class="cm">/* MC/BRD frame looped back */</span><span class="cp"></span>
<span class="cp">#define PACKET_FASTROUTE	6		</span><span class="cm">/* Fastrouted frame	*/</span><span class="cp"></span>

<span class="cm">/* Packet socket options */</span>

<span class="cp">#define PACKET_ADD_MEMBERSHIP		1</span>
<span class="cp">#define PACKET_DROP_MEMBERSHIP		2</span>
<span class="cp">#define PACKET_RECV_OUTPUT		3</span>
<span class="cm">/* Value 4 is still used by obsolete turbo-packet. */</span>
<span class="cp">#define PACKET_RX_RING			5</span>
<span class="cp">#define PACKET_STATISTICS		6</span>
<span class="cp">#define PACKET_COPY_THRESH		7</span>
<span class="cp">#define PACKET_AUXDATA			8</span>
<span class="cp">#define PACKET_ORIGDEV			9</span>
<span class="cp">#define PACKET_VERSION			10</span>
<span class="cp">#define PACKET_HDRLEN			11</span>
<span class="cp">#define PACKET_RESERVE			12</span>
<span class="cp">#define PACKET_TX_RING			13</span>
<span class="cp">#define PACKET_LOSS			14</span>
<span class="cp">#define PACKET_VNET_HDR			15</span>
<span class="cp">#define PACKET_TX_TIMESTAMP		16</span>
<span class="cp">#define PACKET_TIMESTAMP		17</span>
<span class="cp">#define PACKET_FANOUT			18</span>

<span class="cp">#define PACKET_FANOUT_HASH		0</span>
<span class="cp">#define PACKET_FANOUT_LB		1</span>
<span class="cp">#define PACKET_FANOUT_CPU		2</span>
<span class="cp">#define PACKET_FANOUT_FLAG_DEFRAG	0x8000</span>

<span class="k">struct</span> <span class="n">tpacket_stats</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_packets</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_drops</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacket_stats_v3</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_packets</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_drops</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_freeze_q_cnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">tpacket_stats_u</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_stats</span> <span class="n">stats1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_stats_v3</span> <span class="n">stats3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacket_auxdata</span> <span class="p">{</span>
	<span class="n">__u32</span>		<span class="n">tp_status</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_len</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_snaplen</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_mac</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_net</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_vlan_tci</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_padding</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Rx ring - header status */</span>
<span class="cp">#define TP_STATUS_KERNEL	0x0</span>
<span class="cp">#define TP_STATUS_USER		0x1</span>
<span class="cp">#define TP_STATUS_COPY		0x2</span>
<span class="cp">#define TP_STATUS_LOSING	0x4</span>
<span class="cp">#define TP_STATUS_CSUMNOTREADY	0x8</span>
<span class="cp">#define TP_STATUS_VLAN_VALID   0x10 </span><span class="cm">/* auxdata has valid tp_vlan_tci */</span><span class="cp"></span>
<span class="cp">#define TP_STATUS_BLK_TMO	0x20</span>

<span class="cm">/* Tx ring - header status */</span>
<span class="cp">#define TP_STATUS_AVAILABLE	0x0</span>
<span class="cp">#define TP_STATUS_SEND_REQUEST	0x1</span>
<span class="cp">#define TP_STATUS_SENDING	0x2</span>
<span class="cp">#define TP_STATUS_WRONG_FORMAT	0x4</span>

<span class="cm">/* Rx ring - feature request bits */</span>
<span class="cp">#define TP_FT_REQ_FILL_RXHASH	0x1</span>

<span class="k">struct</span> <span class="n">tpacket_hdr</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">tp_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_snaplen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">tp_mac</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">tp_net</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_sec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_usec</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define TPACKET_ALIGNMENT	16</span>
<span class="cp">#define TPACKET_ALIGN(x)	(((x)+TPACKET_ALIGNMENT-1)&amp;~(TPACKET_ALIGNMENT-1))</span>
<span class="cp">#define TPACKET_HDRLEN		(TPACKET_ALIGN(sizeof(struct tpacket_hdr)) + sizeof(struct sockaddr_ll))</span>

<span class="k">struct</span> <span class="n">tpacket2_hdr</span> <span class="p">{</span>
	<span class="n">__u32</span>		<span class="n">tp_status</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_len</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_snaplen</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_mac</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_net</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_sec</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_nsec</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_vlan_tci</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_padding</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacket_hdr_variant1</span> <span class="p">{</span>
	<span class="n">__u32</span>	<span class="n">tp_rxhash</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">tp_vlan_tci</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacket3_hdr</span> <span class="p">{</span>
	<span class="n">__u32</span>		<span class="n">tp_next_offset</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_sec</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_nsec</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_snaplen</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_len</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">tp_status</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_mac</span><span class="p">;</span>
	<span class="n">__u16</span>		<span class="n">tp_net</span><span class="p">;</span>
	<span class="cm">/* pkt_hdr variants */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tpacket_hdr_variant1</span> <span class="n">hv1</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacket_bd_ts</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ts_sec</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ts_usec</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ts_nsec</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacket_hdr_v1</span> <span class="p">{</span>
	<span class="n">__u32</span>	<span class="n">block_status</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">num_pkts</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">offset_to_first_pkt</span><span class="p">;</span>

	<span class="cm">/* Number of valid bytes (including padding)</span>
<span class="cm">	 * blk_len &lt;= tp_block_size</span>
<span class="cm">	 */</span>
	<span class="n">__u32</span>	<span class="n">blk_len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Quite a few uses of sequence number:</span>
<span class="cm">	 * 1. Make sure cache flush etc worked.</span>
<span class="cm">	 *    Well, one can argue - why not use the increasing ts below?</span>
<span class="cm">	 *    But look at 2. below first.</span>
<span class="cm">	 * 2. When you pass around blocks to other user space decoders,</span>
<span class="cm">	 *    you can see which blk[s] is[are] outstanding etc.</span>
<span class="cm">	 * 3. Validate kernel code.</span>
<span class="cm">	 */</span>
	<span class="n">__aligned_u64</span>	<span class="n">seq_num</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ts_last_pkt:</span>
<span class="cm">	 *</span>
<span class="cm">	 * Case 1.	Block has &#39;N&#39;(N &gt;=1) packets and TMO&#39;d(timed out)</span>
<span class="cm">	 *		ts_last_pkt == &#39;time-stamp of last packet&#39; and NOT the</span>
<span class="cm">	 *		time when the timer fired and the block was closed.</span>
<span class="cm">	 *		By providing the ts of the last packet we can absolutely</span>
<span class="cm">	 *		guarantee that time-stamp wise, the first packet in the</span>
<span class="cm">	 *		next block will never precede the last packet of the</span>
<span class="cm">	 *		previous block.</span>
<span class="cm">	 * Case 2.	Block has zero packets and TMO&#39;d</span>
<span class="cm">	 *		ts_last_pkt = time when the timer fired and the block</span>
<span class="cm">	 *		was closed.</span>
<span class="cm">	 * Case 3.	Block has &#39;N&#39; packets and NO TMO.</span>
<span class="cm">	 *		ts_last_pkt = time-stamp of the last pkt in the block.</span>
<span class="cm">	 *</span>
<span class="cm">	 * ts_first_pkt:</span>
<span class="cm">	 *		Is always the time-stamp when the block was opened.</span>
<span class="cm">	 *		Case a)	ZERO packets</span>
<span class="cm">	 *			No packets to deal with but atleast you know the</span>
<span class="cm">	 *			time-interval of this block.</span>
<span class="cm">	 *		Case b) Non-zero packets</span>
<span class="cm">	 *			Use the ts of the first packet in the block.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">tpacket_bd_ts</span>	<span class="n">ts_first_pkt</span><span class="p">,</span> <span class="n">ts_last_pkt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">tpacket_bd_header_u</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_hdr_v1</span> <span class="n">bh1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacket_block_desc</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">offset_to_priv</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">tpacket_bd_header_u</span> <span class="n">hdr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define TPACKET2_HDRLEN		(TPACKET_ALIGN(sizeof(struct tpacket2_hdr)) + sizeof(struct sockaddr_ll))</span>
<span class="cp">#define TPACKET3_HDRLEN		(TPACKET_ALIGN(sizeof(struct tpacket3_hdr)) + sizeof(struct sockaddr_ll))</span>

<span class="k">enum</span> <span class="n">tpacket_versions</span> <span class="p">{</span>
	<span class="n">TPACKET_V1</span><span class="p">,</span>
	<span class="n">TPACKET_V2</span><span class="p">,</span>
	<span class="n">TPACKET_V3</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">   Frame structure:</span>

<span class="cm">   - Start. Frame must be aligned to TPACKET_ALIGNMENT=16</span>
<span class="cm">   - struct tpacket_hdr</span>
<span class="cm">   - pad to TPACKET_ALIGNMENT=16</span>
<span class="cm">   - struct sockaddr_ll</span>
<span class="cm">   - Gap, chosen so that packet data (Start+tp_net) alignes to TPACKET_ALIGNMENT=16</span>
<span class="cm">   - Start+tp_mac: [ Optional MAC header ]</span>
<span class="cm">   - Start+tp_net: Packet data, aligned to TPACKET_ALIGNMENT=16.</span>
<span class="cm">   - Pad to align to TPACKET_ALIGNMENT=16</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">tpacket_req</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_block_size</span><span class="p">;</span>	<span class="cm">/* Minimal size of contiguous block */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_block_nr</span><span class="p">;</span>	<span class="cm">/* Number of blocks */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_frame_size</span><span class="p">;</span>	<span class="cm">/* Size of frame */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_frame_nr</span><span class="p">;</span>	<span class="cm">/* Total number of frames */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacket_req3</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_block_size</span><span class="p">;</span>	<span class="cm">/* Minimal size of contiguous block */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_block_nr</span><span class="p">;</span>	<span class="cm">/* Number of blocks */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_frame_size</span><span class="p">;</span>	<span class="cm">/* Size of frame */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_frame_nr</span><span class="p">;</span>	<span class="cm">/* Total number of frames */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_retire_blk_tov</span><span class="p">;</span> <span class="cm">/* timeout in msecs */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_sizeof_priv</span><span class="p">;</span> <span class="cm">/* offset to private data area */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tp_feature_req_word</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">tpacket_req_u</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacket_req</span>	<span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacket_req3</span>	<span class="n">req3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">packet_mreq</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">mr_ifindex</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">mr_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">mr_alen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">mr_address</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define PACKET_MR_MULTICAST	0</span>
<span class="cp">#define PACKET_MR_PROMISC	1</span>
<span class="cp">#define PACKET_MR_ALLMULTI	2</span>
<span class="cp">#define PACKET_MR_UNICAST	3</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
