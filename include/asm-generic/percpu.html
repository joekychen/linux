<!DOCTYPE html>
<html><head><title>joekychen/linux » include › asm-generic › percpu.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>percpu.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_GENERIC_PERCPU_H_</span>
<span class="cp">#define _ASM_GENERIC_PERCPU_H_</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/threads.h&gt;</span>
<span class="cp">#include &lt;linux/percpu-defs.h&gt;</span>

<span class="cp">#ifdef CONFIG_SMP</span>

<span class="cm">/*</span>
<span class="cm"> * per_cpu_offset() is the offset that has to be added to a</span>
<span class="cm"> * percpu variable to get to the instance for a certain processor.</span>
<span class="cm"> *</span>
<span class="cm"> * Most arches use the __per_cpu_offset array for those offsets but</span>
<span class="cm"> * some arches have their own ways of determining the offset (x86_64, s390).</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __per_cpu_offset</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__per_cpu_offset</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>

<span class="cp">#define per_cpu_offset(x) (__per_cpu_offset[x])</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Determine the offset for the currently active processor.</span>
<span class="cm"> * An arch may define __my_cpu_offset to provide a more effective</span>
<span class="cm"> * means of obtaining the offset to the per cpu variables of the</span>
<span class="cm"> * current processor.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __my_cpu_offset</span>
<span class="cp">#define __my_cpu_offset per_cpu_offset(raw_smp_processor_id())</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_DEBUG_PREEMPT</span>
<span class="cp">#define my_cpu_offset per_cpu_offset(smp_processor_id())</span>
<span class="cp">#else</span>
<span class="cp">#define my_cpu_offset __my_cpu_offset</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Add a offset to a pointer but keep the pointer as is.</span>
<span class="cm"> *</span>
<span class="cm"> * Only S390 provides its own means of moving the pointer.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef SHIFT_PERCPU_PTR</span>
<span class="cm">/* Weird cast keeps both GCC and sparse happy. */</span>
<span class="cp">#define SHIFT_PERCPU_PTR(__p, __offset)	({				\</span>
<span class="cp">	__verify_pcpu_ptr((__p));					\</span>
<span class="cp">	RELOC_HIDE((typeof(*(__p)) __kernel __force *)(__p), (__offset)); \</span>
<span class="cp">})</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * A percpu variable may point to a discarded regions. The following are</span>
<span class="cm"> * established ways to produce a usable pointer from the percpu variable</span>
<span class="cm"> * offset.</span>
<span class="cm"> */</span>
<span class="cp">#define per_cpu(var, cpu) \</span>
<span class="cp">	(*SHIFT_PERCPU_PTR(&amp;(var), per_cpu_offset(cpu)))</span>

<span class="cp">#ifndef __this_cpu_ptr</span>
<span class="cp">#define __this_cpu_ptr(ptr) SHIFT_PERCPU_PTR(ptr, __my_cpu_offset)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_DEBUG_PREEMPT</span>
<span class="cp">#define this_cpu_ptr(ptr) SHIFT_PERCPU_PTR(ptr, my_cpu_offset)</span>
<span class="cp">#else</span>
<span class="cp">#define this_cpu_ptr(ptr) __this_cpu_ptr(ptr)</span>
<span class="cp">#endif</span>

<span class="cp">#define __get_cpu_var(var) (*this_cpu_ptr(&amp;(var)))</span>
<span class="cp">#define __raw_get_cpu_var(var) (*__this_cpu_ptr(&amp;(var)))</span>

<span class="cp">#ifdef CONFIG_HAVE_SETUP_PER_CPU_AREA</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">setup_per_cpu_areas</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#else </span><span class="cm">/* ! SMP */</span><span class="cp"></span>

<span class="cp">#define VERIFY_PERCPU_PTR(__p) ({			\</span>
<span class="cp">	__verify_pcpu_ptr((__p));			\</span>
<span class="cp">	(typeof(*(__p)) __kernel __force *)(__p);	\</span>
<span class="cp">})</span>

<span class="cp">#define per_cpu(var, cpu)	(*((void)(cpu), VERIFY_PERCPU_PTR(&amp;(var))))</span>
<span class="cp">#define __get_cpu_var(var)	(*VERIFY_PERCPU_PTR(&amp;(var)))</span>
<span class="cp">#define __raw_get_cpu_var(var)	(*VERIFY_PERCPU_PTR(&amp;(var)))</span>
<span class="cp">#define this_cpu_ptr(ptr)	per_cpu_ptr(ptr, 0)</span>
<span class="cp">#define __this_cpu_ptr(ptr)	this_cpu_ptr(ptr)</span>

<span class="cp">#endif	</span><span class="cm">/* SMP */</span><span class="cp"></span>

<span class="cp">#ifndef PER_CPU_BASE_SECTION</span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="cp">#define PER_CPU_BASE_SECTION &quot;.data..percpu&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define PER_CPU_BASE_SECTION &quot;.data&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SMP</span>

<span class="cp">#ifdef MODULE</span>
<span class="cp">#define PER_CPU_SHARED_ALIGNED_SECTION &quot;&quot;</span>
<span class="cp">#define PER_CPU_ALIGNED_SECTION &quot;&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define PER_CPU_SHARED_ALIGNED_SECTION &quot;..shared_aligned&quot;</span>
<span class="cp">#define PER_CPU_ALIGNED_SECTION &quot;..shared_aligned&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#define PER_CPU_FIRST_SECTION &quot;..first&quot;</span>

<span class="cp">#else</span>

<span class="cp">#define PER_CPU_SHARED_ALIGNED_SECTION &quot;&quot;</span>
<span class="cp">#define PER_CPU_ALIGNED_SECTION &quot;..shared_aligned&quot;</span>
<span class="cp">#define PER_CPU_FIRST_SECTION &quot;&quot;</span>

<span class="cp">#endif</span>

<span class="cp">#ifndef PER_CPU_ATTRIBUTES</span>
<span class="cp">#define PER_CPU_ATTRIBUTES</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef PER_CPU_DEF_ATTRIBUTES</span>
<span class="cp">#define PER_CPU_DEF_ATTRIBUTES</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* _ASM_GENERIC_PERCPU_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
