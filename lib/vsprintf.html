<!DOCTYPE html>
<html><head><title>joekychen/linux » lib › vsprintf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>vsprintf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/lib/vsprintf.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cm">/* vsprintf.c -- Lars Wirzenius &amp; Linus Torvalds. */</span>
<span class="cm">/*</span>
<span class="cm"> * Wirzenius wrote this portably, Torvalds fucked it up :-)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Fri Jul 13 2001 Crutcher Dunnavant &lt;crutcher+kernel@datastacks.com&gt;</span>
<span class="cm"> * - changed to provide snprintf and vsnprintf functions</span>
<span class="cm"> * So Feb  1 16:51:32 CET 2004 Juergen Quade &lt;quade@hsnr.de&gt;</span>
<span class="cm"> * - scnprintf and vscnprintf</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;	</span><span class="cm">/* for KSYM_SYMBOL_LEN */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;net/addrconf.h&gt;</span>

<span class="cp">#include &lt;asm/page.h&gt;		</span><span class="cm">/* for PAGE_SIZE */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;	</span><span class="cm">/* for dereference_function_descriptor() */</span><span class="cp"></span>

<span class="cp">#include &quot;kstrtox.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * simple_strtoull - convert a string to an unsigned long long</span>
<span class="cm"> * @cp: The start of the string</span>
<span class="cm"> * @endp: A pointer to the end of the parsed string will be placed here</span>
<span class="cm"> * @base: The number base to use</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">simple_strtoull</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">_parse_integer_fixup_radix</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">_parse_integer</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="cm">/* FIXME */</span>
	<span class="n">cp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">KSTRTOX_OVERFLOW</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">endp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">simple_strtoull</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * simple_strtoul - convert a string to an unsigned long</span>
<span class="cm"> * @cp: The start of the string</span>
<span class="cm"> * @endp: A pointer to the end of the parsed string will be placed here</span>
<span class="cm"> * @base: The number base to use</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">simple_strtoul</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">simple_strtoul</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * simple_strtol - convert a string to a signed long</span>
<span class="cm"> * @cp: The start of the string</span>
<span class="cm"> * @endp: A pointer to the end of the parsed string will be placed here</span>
<span class="cm"> * @base: The number base to use</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">simple_strtol</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">simple_strtol</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * simple_strtoll - convert a string to a signed long long</span>
<span class="cm"> * @cp: The start of the string</span>
<span class="cm"> * @endp: A pointer to the end of the parsed string will be placed here</span>
<span class="cm"> * @base: The number base to use</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="nf">simple_strtoll</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">simple_strtoull</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">simple_strtoll</span><span class="p">);</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">int</span> <span class="nf">skip_atoi</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">**</span><span class="n">s</span><span class="p">))</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">++</span><span class="p">)</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Decimal conversion is by far the most typical, and is used</span>
<span class="cm"> * for /proc and /sys data. This directly impacts e.g. top performance</span>
<span class="cm"> * with many processes running. We optimize it for speed</span>
<span class="cm"> * using ideas described at &lt;http://www.cs.uiowa.edu/~jones/bcd/divide.html&gt;</span>
<span class="cm"> * (with permission from the author, Douglas W. Jones).</span>
<span class="cm"> */</span>

<span class="cp">#if BITS_PER_LONG != 32 || BITS_PER_LONG_LONG != 64</span>
<span class="cm">/* Formats correctly any integer in [0, 999999999] */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">put_dec_full9</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Possible ways to approx. divide by 10</span>
<span class="cm">	 * (x * 0x1999999a) &gt;&gt; 32 x &lt; 1073741829 (multiply must be 64-bit)</span>
<span class="cm">	 * (x * 0xcccd) &gt;&gt; 19     x &lt;      81920 (x &lt; 262149 when 64-bit mul)</span>
<span class="cm">	 * (x * 0x6667) &gt;&gt; 18     x &lt;      43699</span>
<span class="cm">	 * (x * 0x3334) &gt;&gt; 17     x &lt;      16389</span>
<span class="cm">	 * (x * 0x199a) &gt;&gt; 16     x &lt;      16389</span>
<span class="cm">	 * (x * 0x0ccd) &gt;&gt; 15     x &lt;      16389</span>
<span class="cm">	 * (x * 0x0667) &gt;&gt; 14     x &lt;       2739</span>
<span class="cm">	 * (x * 0x0334) &gt;&gt; 13     x &lt;       1029</span>
<span class="cm">	 * (x * 0x019a) &gt;&gt; 12     x &lt;       1029</span>
<span class="cm">	 * (x * 0x00cd) &gt;&gt; 11     x &lt;       1029 shorter code than * 0x67 (on i386)</span>
<span class="cm">	 * (x * 0x0067) &gt;&gt; 10     x &lt;        179</span>
<span class="cm">	 * (x * 0x0034) &gt;&gt;  9     x &lt;         69 same</span>
<span class="cm">	 * (x * 0x001a) &gt;&gt;  8     x &lt;         69 same</span>
<span class="cm">	 * (x * 0x000d) &gt;&gt;  7     x &lt;         69 same, shortest code (on i386)</span>
<span class="cm">	 * (x * 0x0007) &gt;&gt;  6     x &lt;         19</span>
<span class="cm">	 * See &lt;http://www.cs.uiowa.edu/~jones/bcd/divide.html&gt;</span>
<span class="cm">	 */</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 1 */</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 2 */</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 3 */</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 4 */</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 5 */</span>
	<span class="cm">/* Now value is under 10000, can avoid 64-bit multiply */</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mh">0x199a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>  <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 6 */</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mh">0xcd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>  <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 7 */</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mh">0xcd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 8 */</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 9 */</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Similar to above but do not pad with zeros.</span>
<span class="cm"> * Code can be easily arranged to print 9 digits too, but our callers</span>
<span class="cm"> * always call put_dec_full9() instead when the number has 9 decimal digits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">put_dec_trunc8</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">q</span><span class="p">;</span>

	<span class="cm">/* Copy of previous function&#39;s body with added early returns */</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mh">0x1999999a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 5 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mh">0x199a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>  <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 6 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mh">0xcd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>  <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 7 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mh">0xcd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 8 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="cm">/* 9 */</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* There are two algorithms to print larger numbers.</span>
<span class="cm"> * One is generic: divide by 1000000000 and repeatedly print</span>
<span class="cm"> * groups of (up to) 9 digits. It&#39;s conceptually simple,</span>
<span class="cm"> * but requires a (unsigned long long) / 1000000000 division.</span>
<span class="cm"> *</span>
<span class="cm"> * Second algorithm splits 64-bit unsigned long long into 16-bit chunks,</span>
<span class="cm"> * manipulates them cleverly and generates groups of 4 decimal digits.</span>
<span class="cm"> * It so happens that it does NOT require long long division.</span>
<span class="cm"> *</span>
<span class="cm"> * If long is &gt; 32 bits, division of 64-bit values is relatively easy,</span>
<span class="cm"> * and we will use the first algorithm.</span>
<span class="cm"> * If long long is &gt; 64 bits (strange architecture with VERY large long long),</span>
<span class="cm"> * second algorithm can&#39;t be used, and we again use the first one.</span>
<span class="cm"> *</span>
<span class="cm"> * Else (if long is 32 bits and long long is 64 bits) we use second one.</span>
<span class="cm"> */</span>

<span class="cp">#if BITS_PER_LONG != 32 || BITS_PER_LONG_LONG != 64</span>

<span class="cm">/* First algorithm: generic */</span>

<span class="k">static</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">put_dec</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">put_dec_full9</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">do_div</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">put_dec_full9</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">put_dec_trunc8</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cm">/* Second algorithm: valid only for 64-bit long longs */</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">put_dec_full4</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mh">0xcccd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">q</span>      <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mh">0x199a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>  <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">r</span>      <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mh">0xcd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>  <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Based on code by Douglas W. Jones found at</span>
<span class="cm"> * &lt;http://www.cs.uiowa.edu/~jones/bcd/decimal.html#sixtyfour&gt;</span>
<span class="cm"> * (with permission from the author).</span>
<span class="cm"> * Performs no 64-bit division and hence should be fast on 32-bit machines.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">put_dec</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">d3</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">put_dec_trunc8</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">d1</span>  <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span> <span class="cm">/* implicit &quot;&amp; 0xffff&quot; */</span>
	<span class="n">h</span>   <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">d2</span>  <span class="o">=</span> <span class="p">(</span><span class="n">h</span>      <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">d3</span>  <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span> <span class="cm">/* implicit &quot;&amp; 0xffff&quot; */</span>

	<span class="n">q</span>   <span class="o">=</span> <span class="mi">656</span> <span class="o">*</span> <span class="n">d3</span> <span class="o">+</span> <span class="mi">7296</span> <span class="o">*</span> <span class="n">d2</span> <span class="o">+</span> <span class="mi">5536</span> <span class="o">*</span> <span class="n">d1</span> <span class="o">+</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">put_dec_full4</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">q</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="n">q</span>   <span class="o">=</span> <span class="n">q</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">d1</span>  <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">7671</span> <span class="o">*</span> <span class="n">d3</span> <span class="o">+</span> <span class="mi">9496</span> <span class="o">*</span> <span class="n">d2</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">d1</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">put_dec_full4</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">d1</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="n">q</span>   <span class="o">=</span> <span class="n">d1</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">d2</span>  <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">4749</span> <span class="o">*</span> <span class="n">d3</span> <span class="o">+</span> <span class="mi">42</span> <span class="o">*</span> <span class="n">d2</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">put_dec_full4</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">d2</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="n">q</span>   <span class="o">=</span> <span class="n">d2</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">d3</span>  <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">281</span> <span class="o">*</span> <span class="n">d3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">put_dec_full4</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">d3</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="n">q</span>   <span class="o">=</span> <span class="n">d3</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">put_dec_full4</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
 <span class="nl">done:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
		<span class="o">--</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Convert passed number to decimal string.</span>
<span class="cm"> * Returns the length of string.  On buffer overflow, returns 0.</span>
<span class="cm"> *</span>
<span class="cm"> * If speed is not important, use snprintf(). It&#39;s easy to read the code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">num_to_str</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* put_dec() may work incorrectly for num = 0 (generate &quot;&quot;, not &quot;0&quot;) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">put_dec</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ZEROPAD	1		</span><span class="cm">/* pad with zero */</span><span class="cp"></span>
<span class="cp">#define SIGN	2		</span><span class="cm">/* unsigned/signed long */</span><span class="cp"></span>
<span class="cp">#define PLUS	4		</span><span class="cm">/* show plus */</span><span class="cp"></span>
<span class="cp">#define SPACE	8		</span><span class="cm">/* space if plus */</span><span class="cp"></span>
<span class="cp">#define LEFT	16		</span><span class="cm">/* left justified */</span><span class="cp"></span>
<span class="cp">#define SMALL	32		</span><span class="cm">/* use lowercase in hex (must be 32 == 0x20) */</span><span class="cp"></span>
<span class="cp">#define SPECIAL	64		</span><span class="cm">/* prefix hex with &quot;0x&quot;, octal with &quot;0&quot; */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">format_type</span> <span class="p">{</span>
	<span class="n">FORMAT_TYPE_NONE</span><span class="p">,</span> <span class="cm">/* Just a string part */</span>
	<span class="n">FORMAT_TYPE_WIDTH</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_PRECISION</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_CHAR</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_STR</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_PTR</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_PERCENT_CHAR</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_INVALID</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_LONG_LONG</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_ULONG</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_LONG</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_UBYTE</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_BYTE</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_USHORT</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_SHORT</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_UINT</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_INT</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_NRCHARS</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_SIZE_T</span><span class="p">,</span>
	<span class="n">FORMAT_TYPE_PTRDIFF</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">printf_spec</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">type</span><span class="p">;</span>		<span class="cm">/* format_type enum */</span>
	<span class="n">u8</span>	<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* flags to number() */</span>
	<span class="n">u8</span>	<span class="n">base</span><span class="p">;</span>		<span class="cm">/* number base, 8, 10 or 16 only */</span>
	<span class="n">u8</span>	<span class="n">qualifier</span><span class="p">;</span>	<span class="cm">/* number qualifier, one of &#39;hHlLtzZ&#39; */</span>
	<span class="n">s16</span>	<span class="n">field_width</span><span class="p">;</span>	<span class="cm">/* width of output field */</span>
	<span class="n">s16</span>	<span class="n">precision</span><span class="p">;</span>	<span class="cm">/* # of digits/chars */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">number</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">num</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* we are called with base 8, 10 or 16, only, thus don&#39;t need &quot;G...&quot;  */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">digits</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0123456789ABCDEF&quot;</span><span class="p">;</span> <span class="cm">/* &quot;GHIJKLMNOPQRSTUVWXYZ&quot;; */</span>

	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">66</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">sign</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">locase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_pfx</span> <span class="o">=</span> <span class="p">((</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SPECIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_zero</span> <span class="o">=</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0LL</span><span class="p">;</span>

	<span class="cm">/* locase = 0 or 0x20. ORing digits or letters with &#39;locase&#39;</span>
<span class="cm">	 * produces same digits or (maybe lowercased) letters */</span>
	<span class="n">locase</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SMALL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEFT</span><span class="p">)</span>
		<span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ZEROPAD</span><span class="p">;</span>
	<span class="n">sign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">signed</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sign</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
			<span class="n">num</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="kt">signed</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">num</span><span class="p">;</span>
			<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PLUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sign</span> <span class="o">=</span> <span class="sc">&#39;+&#39;</span><span class="p">;</span>
			<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SPACE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sign</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_pfx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero</span><span class="p">)</span>
			<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* generate full string in tmp[], in reverse order */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="p">.</span><span class="n">base</span><span class="p">)</span>
		<span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">|</span> <span class="n">locase</span><span class="p">;</span>
	<span class="cm">/* Generic code, for any base:</span>
<span class="cm">	else do {</span>
<span class="cm">		tmp[i++] = (digits[do_div(num,base)] | locase);</span>
<span class="cm">	} while (num != 0);</span>
<span class="cm">	*/</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 8 or 16 */</span>
		<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">shift</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">digits</span><span class="p">[((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">num</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">]</span> <span class="o">|</span> <span class="n">locase</span><span class="p">);</span>
			<span class="n">num</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* base 10 */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">put_dec</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* printing 100 using %2d gives &quot;100&quot;, not &quot;00&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">spec</span><span class="p">.</span><span class="n">precision</span><span class="p">)</span>
		<span class="n">spec</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* leading space padding */</span>
	<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">-=</span> <span class="n">spec</span><span class="p">.</span><span class="n">precision</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ZEROPAD</span><span class="o">+</span><span class="n">LEFT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* sign */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sign</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sign</span><span class="p">;</span>
		<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* &quot;0x&quot; / &quot;0&quot; prefix */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_pfx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_zero</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="sc">&#39;X&#39;</span> <span class="o">|</span> <span class="n">locase</span><span class="p">);</span>
			<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* zero or space padding */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ZEROPAD</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;0&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* hmm even more zero padding? */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="o">--</span><span class="n">spec</span><span class="p">.</span><span class="n">precision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* actual digits of result */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* trailing space padding */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">spec</span><span class="p">.</span><span class="n">precision</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="p">.</span><span class="n">field_width</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="o">++</span><span class="n">buf</span><span class="p">;</span> <span class="o">++</span><span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="p">.</span><span class="n">field_width</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="o">++</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">symbol_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_KALLSYMS</span>
	<span class="kt">char</span> <span class="n">sym</span><span class="p">[</span><span class="n">KSYM_SYMBOL_LEN</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
		<span class="n">sprint_backtrace</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="o">!=</span> <span class="sc">&#39;f&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ext</span> <span class="o">!=</span> <span class="sc">&#39;s&#39;</span><span class="p">)</span>
		<span class="n">sprint_symbol</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprint_symbol_no_offset</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SPECIAL</span> <span class="o">|</span> <span class="n">SMALL</span> <span class="o">|</span> <span class="n">ZEROPAD</span><span class="p">;</span>
	<span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">number</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">resource_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef IO_RSRC_PRINTK_SIZE</span>
<span class="cp">#define IO_RSRC_PRINTK_SIZE	6</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef MEM_RSRC_PRINTK_SIZE</span>
<span class="cp">#define MEM_RSRC_PRINTK_SIZE	10</span>
<span class="cp">#endif</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">io_spec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="n">IO_RSRC_PRINTK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SPECIAL</span> <span class="o">|</span> <span class="n">SMALL</span> <span class="o">|</span> <span class="n">ZEROPAD</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">mem_spec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="n">MEM_RSRC_PRINTK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SPECIAL</span> <span class="o">|</span> <span class="n">SMALL</span> <span class="o">|</span> <span class="n">ZEROPAD</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">bus_spec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SMALL</span> <span class="o">|</span> <span class="n">ZEROPAD</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">dec_spec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">str_spec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LEFT</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">flag_spec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SPECIAL</span> <span class="o">|</span> <span class="n">SMALL</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/* 32-bit res (sizeof==4): 10 chars in dec, 10 in hex (&quot;0x&quot; + 8)</span>
<span class="cm">	 * 64-bit res (sizeof==8): 20 chars in dec, 18 in hex (&quot;0x&quot; + 16) */</span>
<span class="cp">#define RSRC_BUF_SIZE		((2 * sizeof(resource_size_t)) + 4)</span>
<span class="cp">#define FLAG_BUF_SIZE		(2 * sizeof(res-&gt;flags))</span>
<span class="cp">#define DECODED_BUF_SIZE	sizeof(&quot;[mem - 64bit pref window disabled]&quot;)</span>
<span class="cp">#define RAW_BUF_SIZE		sizeof(&quot;[mem - flags 0x]&quot;)</span>
	<span class="kt">char</span> <span class="n">sym</span><span class="p">[</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">RSRC_BUF_SIZE</span> <span class="o">+</span> <span class="n">DECODED_BUF_SIZE</span><span class="p">,</span>
		     <span class="mi">2</span><span class="o">*</span><span class="n">RSRC_BUF_SIZE</span> <span class="o">+</span> <span class="n">FLAG_BUF_SIZE</span> <span class="o">+</span> <span class="n">RAW_BUF_SIZE</span><span class="p">)];</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">sym</span><span class="p">,</span> <span class="o">*</span><span class="n">pend</span> <span class="o">=</span> <span class="n">sym</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">decode</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="o">*</span><span class="n">specp</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;[&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot;io  &quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="n">specp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">io_spec</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot;mem &quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="n">specp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mem_spec</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot;irq &quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="n">specp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dec_spec</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot;dma &quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="n">specp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dec_spec</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_BUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot;bus &quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="n">specp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus_spec</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot;??? &quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="n">specp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mem_spec</span><span class="p">;</span>
		<span class="n">decode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">number</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">specp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">!=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">number</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">specp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot; 64bit&quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot; pref&quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_WINDOW</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot; window&quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_DISABLED</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot; disabled&quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="s">&quot; flags &quot;</span><span class="p">,</span> <span class="n">str_spec</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">number</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pend</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">flag_spec</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;]&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">mac_address_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">mac_addr</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;xx:xx:xx:xx:xx:xx&quot;</span><span class="p">)];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">mac_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">separator</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;F&#39;</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* FDDI canonical format */</span>
		<span class="n">separator</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">separator</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">separator</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">ip4_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">leading_zeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;i&#39;</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">step</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
	<span class="nl">default:</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* hold each IP quad in reverse order */</span>
		<span class="kt">int</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">put_dec_trunc8</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">-</span> <span class="n">temp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leading_zeros</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">digits</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">digits</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* reverse the digits in the quad */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">digits</span><span class="o">--</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">digits</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">+=</span> <span class="n">step</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">ip6_compressed_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">range</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">zerolength</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">longest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">colonpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">needcolon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">useIPv4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">in6</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in6_addr</span><span class="p">));</span>

	<span class="n">useIPv4</span> <span class="o">=</span> <span class="n">ipv6_addr_v4mapped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipv6_addr_is_isatap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in6</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">zerolength</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zerolength</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">useIPv4</span><span class="p">)</span>
		<span class="n">range</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">range</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* find position of longest 0 run */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in6</span><span class="p">.</span><span class="n">s6_addr16</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">zerolength</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zerolength</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">longest</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">longest</span> <span class="o">=</span> <span class="n">zerolength</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">colonpos</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">longest</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>		<span class="cm">/* don&#39;t compress a single 0 */</span>
		<span class="n">colonpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* emit address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">colonpos</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">needcolon</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
			<span class="n">needcolon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">longest</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">needcolon</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
			<span class="n">needcolon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* hex u16 without leading 0s */</span>
		<span class="n">word</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">in6</span><span class="p">.</span><span class="n">s6_addr16</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">hi</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">lo</span><span class="p">);</span>
		<span class="n">needcolon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">useIPv4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">needcolon</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">ip4_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in6</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="s">&quot;I4&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">ip6_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="o">++</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;I&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">ip6_addr_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ip6_addr</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:255.255.255.255&quot;</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;I&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span><span class="p">)</span>
		<span class="n">ip6_compressed_string</span><span class="p">(</span><span class="n">ip6_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ip6_string</span><span class="p">(</span><span class="n">ip6_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ip6_addr</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">ip4_addr_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ip4_addr</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;255.255.255.255&quot;</span><span class="p">)];</span>

	<span class="n">ip4_string</span><span class="p">(</span><span class="n">ip4_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ip4_addr</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">uuid_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">uuid</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</span><span class="p">)];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">be</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">le</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">};</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">be</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">uc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">++</span><span class="n">fmt</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
		<span class="n">uc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="n">le</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;B&#39;</span>:
		<span class="n">uc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">case</span> <span class="mi">9</span>:
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">++</span><span class="n">p</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">netdev_feature_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SPECIAL</span> <span class="o">|</span> <span class="n">SMALL</span> <span class="o">|</span> <span class="n">ZEROPAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">netdev_features_t</span><span class="p">);</span>
	<span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">number</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="n">netdev_features_t</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">kptr_restrict</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Show a &#39;%p&#39; thing.  A kernel extension is that the &#39;%p&#39; is followed</span>
<span class="cm"> * by an extra set of alphanumeric characters that are extended format</span>
<span class="cm"> * specifiers.</span>
<span class="cm"> *</span>
<span class="cm"> * Right now we handle:</span>
<span class="cm"> *</span>
<span class="cm"> * - &#39;F&#39; For symbolic function descriptor pointers with offset</span>
<span class="cm"> * - &#39;f&#39; For simple symbolic function names without offset</span>
<span class="cm"> * - &#39;S&#39; For symbolic direct pointers with offset</span>
<span class="cm"> * - &#39;s&#39; For symbolic direct pointers without offset</span>
<span class="cm"> * - &#39;B&#39; For backtraced symbolic direct pointers with offset</span>
<span class="cm"> * - &#39;R&#39; For decoded struct resource, e.g., [mem 0x0-0x1f 64bit pref]</span>
<span class="cm"> * - &#39;r&#39; For raw struct resource, e.g., [mem 0x0-0x1f flags 0x201]</span>
<span class="cm"> * - &#39;M&#39; For a 6-byte MAC address, it prints the address in the</span>
<span class="cm"> *       usual colon-separated hex notation</span>
<span class="cm"> * - &#39;m&#39; For a 6-byte MAC address, it prints the hex address without colons</span>
<span class="cm"> * - &#39;MF&#39; For a 6-byte MAC FDDI address, it prints the address</span>
<span class="cm"> *       with a dash-separated hex notation</span>
<span class="cm"> * - &#39;I&#39; [46] for IPv4/IPv6 addresses printed in the usual way</span>
<span class="cm"> *       IPv4 uses dot-separated decimal without leading 0&#39;s (1.2.3.4)</span>
<span class="cm"> *       IPv6 uses colon separated network-order 16 bit hex with leading 0&#39;s</span>
<span class="cm"> * - &#39;i&#39; [46] for &#39;raw&#39; IPv4/IPv6 addresses</span>
<span class="cm"> *       IPv6 omits the colons (01020304...0f)</span>
<span class="cm"> *       IPv4 uses dot-separated decimal with leading 0&#39;s (010.123.045.006)</span>
<span class="cm"> * - &#39;[Ii]4[hnbl]&#39; IPv4 addresses in host, network, big or little endian order</span>
<span class="cm"> * - &#39;I6c&#39; for IPv6 addresses printed as specified by</span>
<span class="cm"> *       http://tools.ietf.org/html/rfc5952</span>
<span class="cm"> * - &#39;U&#39; For a 16 byte UUID/GUID, it prints the UUID/GUID in the form</span>
<span class="cm"> *       &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</span>
<span class="cm"> *       Options for %pU are:</span>
<span class="cm"> *         b big endian lower case hex (default)</span>
<span class="cm"> *         B big endian UPPER case hex</span>
<span class="cm"> *         l little endian lower case hex</span>
<span class="cm"> *         L little endian UPPER case hex</span>
<span class="cm"> *           big endian output byte order is:</span>
<span class="cm"> *             [0][1][2][3]-[4][5]-[6][7]-[8][9]-[10][11][12][13][14][15]</span>
<span class="cm"> *           little endian output byte order is:</span>
<span class="cm"> *             [3][2][1][0]-[5][4]-[7][6]-[8][9]-[10][11][12][13][14][15]</span>
<span class="cm"> * - &#39;V&#39; For a struct va_format which contains a format string * and va_list *,</span>
<span class="cm"> *       call vsnprintf(-&gt;format, *-&gt;va_list).</span>
<span class="cm"> *       Implements a &quot;recursive vsnprintf&quot;.</span>
<span class="cm"> *       Do not use this feature without some mechanism to verify the</span>
<span class="cm"> *       correctness of the format string and va_list arguments.</span>
<span class="cm"> * - &#39;K&#39; For a kernel pointer that should be hidden from unprivileged users</span>
<span class="cm"> * - &#39;NF&#39; For a netdev_features_t</span>
<span class="cm"> *</span>
<span class="cm"> * Note: The difference between &#39;S&#39; and &#39;F&#39; is that on ia64 and ppc64</span>
<span class="cm"> * function pointers are really function descriptors, which contain a</span>
<span class="cm"> * pointer to the real address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">pointer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">default_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SPECIAL</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">!=</span> <span class="sc">&#39;K&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Print (null) with the same width as a pointer so it makes</span>
<span class="cm">		 * tabular output look nice.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="n">default_width</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s">&quot;(null)&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;F&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">dereference_function_descriptor</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="cm">/* Fallthrough */</span>
	<span class="k">case</span> <span class="sc">&#39;S&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;B&#39;</span>:
		<span class="k">return</span> <span class="n">symbol_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="o">*</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">case</span> <span class="sc">&#39;R&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
		<span class="k">return</span> <span class="n">resource_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:			<span class="cm">/* Colon separated: 00:01:02:03:04:05 */</span>
	<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:			<span class="cm">/* Contiguous: 000102030405 */</span>
					<span class="cm">/* [mM]F (FDDI, bit reversed) */</span>
		<span class="k">return</span> <span class="n">mac_address_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">case</span> <span class="sc">&#39;I&#39;</span>:			<span class="cm">/* Formatted IP supported</span>
<span class="cm">					 * 4:	1.2.3.4</span>
<span class="cm">					 * 6:	0001:0203:...:0708</span>
<span class="cm">					 * 6c:	1::708 or 1::1.2.3.4</span>
<span class="cm">					 */</span>
	<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:			<span class="cm">/* Contiguous:</span>
<span class="cm">					 * 4:	001.002.003.004</span>
<span class="cm">					 * 6:   000102...0f</span>
<span class="cm">					 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;6&#39;</span>:
			<span class="k">return</span> <span class="n">ip6_addr_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
		<span class="k">case</span> <span class="sc">&#39;4&#39;</span>:
			<span class="k">return</span> <span class="n">ip4_addr_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;U&#39;</span>:
		<span class="k">return</span> <span class="n">uuid_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">case</span> <span class="sc">&#39;V&#39;</span>:
		<span class="p">{</span>
			<span class="kt">va_list</span> <span class="n">va</span><span class="p">;</span>

			<span class="n">va_copy</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">va_format</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">buf</span> <span class="o">?</span> <span class="n">end</span> <span class="o">-</span> <span class="n">buf</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="p">((</span><span class="k">struct</span> <span class="n">va_format</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
			<span class="n">va_end</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
		<span class="cm">/*</span>
<span class="cm">		 * %pK cannot be used in IRQ context because its test</span>
<span class="cm">		 * for CAP_SYSLOG would be meaningless.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_irq</span><span class="p">()</span> <span class="o">||</span> <span class="n">in_serving_softirq</span><span class="p">()</span> <span class="o">||</span> <span class="n">in_nmi</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="n">default_width</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s">&quot;pK-error&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">kptr_restrict</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		      <span class="p">(</span><span class="n">kptr_restrict</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		       <span class="n">has_capability_noaudit</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">CAP_SYSLOG</span><span class="p">))))</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;N&#39;</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;F&#39;</span>:
			<span class="k">return</span> <span class="n">netdev_feature_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SMALL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="n">default_width</span><span class="p">;</span>
		<span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ZEROPAD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spec</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">number</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Helper function to decode printf style format.</span>
<span class="cm"> * Each call decode a token from the format and return the</span>
<span class="cm"> * number of characters read (or likely the delta where it wants</span>
<span class="cm"> * to go on the next call).</span>
<span class="cm"> * The decoded token is returned through the parameters</span>
<span class="cm"> *</span>
<span class="cm"> * &#39;h&#39;, &#39;l&#39;, or &#39;L&#39; for integer fields</span>
<span class="cm"> * &#39;z&#39; support added 23/7/1999 S.H.</span>
<span class="cm"> * &#39;z&#39; changed to &#39;Z&#39; --davidm 1/25/99</span>
<span class="cm"> * &#39;t&#39; added for ptrdiff_t</span>
<span class="cm"> *</span>
<span class="cm"> * @fmt: the format string</span>
<span class="cm"> * @type of the token returned</span>
<span class="cm"> * @flags: various flags such as +, -, # tokens..</span>
<span class="cm"> * @field_width: overwritten width</span>
<span class="cm"> * @base: base of the number (octal, hex, ...)</span>
<span class="cm"> * @precision: precision of a number</span>
<span class="cm"> * @qualifier: qualifier of a number (long, size_t, ...)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span>
<span class="kt">int</span> <span class="nf">format_decode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">printf_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="cm">/* we finished early by reading the field width */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FORMAT_TYPE_WIDTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">field_width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">field_width</span> <span class="o">=</span> <span class="o">-</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">field_width</span><span class="p">;</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">LEFT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">precision</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we finished early by reading the precision */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FORMAT_TYPE_PRECISION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">precision</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">qualifier</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* By default */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_NONE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">fmt</span> <span class="p">;</span> <span class="o">++</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Return the current non-format string */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">!=</span> <span class="n">start</span> <span class="o">||</span> <span class="o">!*</span><span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="cm">/* Process flags */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* this also skips first &#39;%&#39; */</span>
		<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="o">++</span><span class="n">fmt</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;-&#39;</span>: <span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">LEFT</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>: <span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PLUS</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39; &#39;</span>: <span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SPACE</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;#&#39;</span>: <span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SPECIAL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>: <span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ZEROPAD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>  <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get field width */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">field_width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">))</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">field_width</span> <span class="o">=</span> <span class="n">skip_atoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* it&#39;s the next argument */</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_WIDTH</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">++</span><span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">precision:</span>
	<span class="cm">/* get the precision */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">fmt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">precision</span> <span class="o">=</span> <span class="n">skip_atoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">precision</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* it&#39;s the next argument */</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_PRECISION</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">++</span><span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">qualifier:</span>
	<span class="cm">/* get the conversion qualifier */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span> <span class="o">||</span> <span class="n">_tolower</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span> <span class="o">||</span>
	    <span class="n">_tolower</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;z&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;t&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">=</span> <span class="o">*</span><span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">==</span> <span class="o">*</span><span class="n">fmt</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">=</span> <span class="sc">&#39;L&#39;</span><span class="p">;</span>
				<span class="o">++</span><span class="n">fmt</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">=</span> <span class="sc">&#39;H&#39;</span><span class="p">;</span>
				<span class="o">++</span><span class="n">fmt</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* default base */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_CHAR</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">++</span><span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_STR</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">++</span><span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_PTR</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="cm">/* skip alnum */</span>

	<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_NRCHARS</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">++</span><span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;%&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_PERCENT_CHAR</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">++</span><span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="cm">/* integer number formats - set up the flags and &quot;break&quot; */</span>
	<span class="k">case</span> <span class="sc">&#39;o&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SMALL</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SIGN</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_INVALID</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;L&#39;</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_LONG_LONG</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SIGN</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_LONG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_ULONG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_tolower</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;z&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_SIZE_T</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;t&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_PTRDIFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;H&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SIGN</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_BYTE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_UBYTE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SIGN</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_SHORT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_USHORT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SIGN</span><span class="p">)</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_INT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">spec</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FORMAT_TYPE_UINT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">++</span><span class="n">fmt</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vsnprintf - Format a string and place it in a buffer</span>
<span class="cm"> * @buf: The buffer to place the result into</span>
<span class="cm"> * @size: The size of the buffer, including the trailing null space</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @args: Arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * This function follows C99 vsnprintf, but has some extensions:</span>
<span class="cm"> * %pS output the name of a text symbol with offset</span>
<span class="cm"> * %ps output the name of a text symbol without offset</span>
<span class="cm"> * %pF output the name of a function pointer with its offset</span>
<span class="cm"> * %pf output the name of a function pointer without its offset</span>
<span class="cm"> * %pB output the name of a backtrace symbol with its offset</span>
<span class="cm"> * %pR output the address range in a struct resource with decoded flags</span>
<span class="cm"> * %pr output the address range in a struct resource with raw flags</span>
<span class="cm"> * %pM output a 6-byte MAC address with colons</span>
<span class="cm"> * %pm output a 6-byte MAC address without colons</span>
<span class="cm"> * %pI4 print an IPv4 address without leading zeros</span>
<span class="cm"> * %pi4 print an IPv4 address with leading zeros</span>
<span class="cm"> * %pI6 print an IPv6 address with colons</span>
<span class="cm"> * %pi6 print an IPv6 address without colons</span>
<span class="cm"> * %pI6c print an IPv6 address as specified by RFC 5952</span>
<span class="cm"> * %pU[bBlL] print a UUID/GUID in big or little endian using lower or upper</span>
<span class="cm"> *   case.</span>
<span class="cm"> * %n is ignored</span>
<span class="cm"> *</span>
<span class="cm"> * The return value is the number of characters which would</span>
<span class="cm"> * be generated for the given input, excluding the trailing</span>
<span class="cm"> * &#39;\0&#39;, as per ISO C99. If you want to have the exact</span>
<span class="cm"> * number of characters written into @buf as return value</span>
<span class="cm"> * (not including the trailing &#39;\0&#39;), use vscnprintf(). If the</span>
<span class="cm"> * return is greater than or equal to @size, the resulting</span>
<span class="cm"> * string is truncated.</span>
<span class="cm"> *</span>
<span class="cm"> * If you&#39;re not already dealing with a va_list consider using snprintf().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vsnprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="cm">/* Reject out-of-range values early.  Large positive sizes are</span>
<span class="cm">	   used for unknown buffer sizes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Make sure end is always &gt;= buf */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">format_decode</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="p">);</span>

		<span class="n">fmt</span> <span class="o">+=</span> <span class="n">read</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FORMAT_TYPE_NONE</span>: <span class="p">{</span>
			<span class="kt">int</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">end</span> <span class="o">-</span> <span class="n">str</span><span class="p">)</span>
					<span class="n">copy</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">str</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">old_fmt</span><span class="p">,</span> <span class="n">copy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">str</span> <span class="o">+=</span> <span class="n">read</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_WIDTH</span>:
			<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_PRECISION</span>:
			<span class="n">spec</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_CHAR</span>: <span class="p">{</span>
			<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEFT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
						<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
					<span class="o">++</span><span class="n">str</span><span class="p">;</span>

				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="o">++</span><span class="n">str</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
					<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
				<span class="o">++</span><span class="n">str</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_STR</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">),</span> <span class="n">spec</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_PTR</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">(</span><span class="n">fmt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
				      <span class="n">spec</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">))</span>
				<span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_PERCENT_CHAR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;%&#39;</span><span class="p">;</span>
			<span class="o">++</span><span class="n">str</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_INVALID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;%&#39;</span><span class="p">;</span>
			<span class="o">++</span><span class="n">str</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_NRCHARS</span>: <span class="p">{</span>
			<span class="n">u8</span> <span class="n">qualifier</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="n">qualifier</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">long</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_tolower</span><span class="p">(</span><span class="n">qualifier</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;z&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">size_t</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nl">default:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_LONG_LONG</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_ULONG</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_LONG</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_SIZE_T</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_PTRDIFF</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">ptrdiff_t</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_UBYTE</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_BYTE</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_USHORT</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_SHORT</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_INT</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">num</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">str</span> <span class="o">=</span> <span class="n">number</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the trailing null byte doesn&#39;t count towards the total */</span>
	<span class="k">return</span> <span class="n">str</span><span class="o">-</span><span class="n">buf</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vsnprintf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * vscnprintf - Format a string and place it in a buffer</span>
<span class="cm"> * @buf: The buffer to place the result into</span>
<span class="cm"> * @size: The size of the buffer, including the trailing null space</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @args: Arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * The return value is the number of characters which have been written into</span>
<span class="cm"> * the @buf not including the trailing &#39;\0&#39;. If @size is == 0 the function</span>
<span class="cm"> * returns 0.</span>
<span class="cm"> *</span>
<span class="cm"> * If you&#39;re not already dealing with a va_list consider using scnprintf().</span>
<span class="cm"> *</span>
<span class="cm"> * See the vsnprintf() documentation for format string extensions over C99.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vscnprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vscnprintf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * snprintf - Format a string and place it in a buffer</span>
<span class="cm"> * @buf: The buffer to place the result into</span>
<span class="cm"> * @size: The size of the buffer, including the trailing null space</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @...: Arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * The return value is the number of characters which would be</span>
<span class="cm"> * generated for the given input, excluding the trailing null,</span>
<span class="cm"> * as per ISO C99.  If the return is greater than or equal to</span>
<span class="cm"> * @size, the resulting string is truncated.</span>
<span class="cm"> *</span>
<span class="cm"> * See the vsnprintf() documentation for format string extensions over C99.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">snprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snprintf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * scnprintf - Format a string and place it in a buffer</span>
<span class="cm"> * @buf: The buffer to place the result into</span>
<span class="cm"> * @size: The size of the buffer, including the trailing null space</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @...: Arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * The return value is the number of characters written into @buf not including</span>
<span class="cm"> * the trailing &#39;\0&#39;. If @size is == 0 the function returns 0.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">scnprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">vscnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scnprintf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * vsprintf - Format a string and place it in a buffer</span>
<span class="cm"> * @buf: The buffer to place the result into</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @args: Arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * The function returns the number of characters written</span>
<span class="cm"> * into @buf. Use vsnprintf() or vscnprintf() in order to avoid</span>
<span class="cm"> * buffer overflows.</span>
<span class="cm"> *</span>
<span class="cm"> * If you&#39;re not already dealing with a va_list consider using sprintf().</span>
<span class="cm"> *</span>
<span class="cm"> * See the vsnprintf() documentation for format string extensions over C99.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vsprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vsprintf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * sprintf - Format a string and place it in a buffer</span>
<span class="cm"> * @buf: The buffer to place the result into</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @...: Arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * The function returns the number of characters written</span>
<span class="cm"> * into @buf. Use snprintf() or scnprintf() in order to avoid</span>
<span class="cm"> * buffer overflows.</span>
<span class="cm"> *</span>
<span class="cm"> * See the vsnprintf() documentation for format string extensions over C99.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sprintf</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BINARY_PRINTF</span>
<span class="cm">/*</span>
<span class="cm"> * bprintf service:</span>
<span class="cm"> * vbin_printf() - VA arguments to binary data</span>
<span class="cm"> * bstr_printf() - Binary data to text string</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * vbin_printf - Parse a format string and place args&#39; binary value in a buffer</span>
<span class="cm"> * @bin_buf: The buffer to place args&#39; binary value</span>
<span class="cm"> * @size: The size of the buffer(by words(32bits), not characters)</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @args: Arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * The format follows C99 vsnprintf, except %n is ignored, and its argument</span>
<span class="cm"> * is skiped.</span>
<span class="cm"> *</span>
<span class="cm"> * The return value is the number of words(32bits) which would be generated for</span>
<span class="cm"> * the given input.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:</span>
<span class="cm"> * If the return value is greater than @size, the resulting bin_buf is NOT</span>
<span class="cm"> * valid for bstr_printf().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vbin_printf</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">bin_buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bin_buf</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">bin_buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>

<span class="cp">#define save_arg(type)							\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (sizeof(type) == 8) {					\</span>
<span class="cp">		unsigned long long value;				\</span>
<span class="cp">		str = PTR_ALIGN(str, sizeof(u32));			\</span>
<span class="cp">		value = va_arg(args, unsigned long long);		\</span>
<span class="cp">		if (str + sizeof(type) &lt;= end) {			\</span>
<span class="cp">			*(u32 *)str = *(u32 *)&amp;value;			\</span>
<span class="cp">			*(u32 *)(str + 4) = *((u32 *)&amp;value + 1);	\</span>
<span class="cp">		}							\</span>
<span class="cp">	} else {							\</span>
<span class="cp">		unsigned long value;					\</span>
<span class="cp">		str = PTR_ALIGN(str, sizeof(type));			\</span>
<span class="cp">		value = va_arg(args, int);				\</span>
<span class="cp">		if (str + sizeof(type) &lt;= end)				\</span>
<span class="cp">			*(typeof(type) *)str = (type)value;		\</span>
<span class="cp">	}								\</span>
<span class="cp">	str += sizeof(type);						\</span>
<span class="cp">} while (0)</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">format_decode</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="p">);</span>

		<span class="n">fmt</span> <span class="o">+=</span> <span class="n">read</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FORMAT_TYPE_NONE</span>:
		<span class="k">case</span> <span class="n">FORMAT_TYPE_INVALID</span>:
		<span class="k">case</span> <span class="n">FORMAT_TYPE_PERCENT_CHAR</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_WIDTH</span>:
		<span class="k">case</span> <span class="n">FORMAT_TYPE_PRECISION</span>:
			<span class="n">save_arg</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_CHAR</span>:
			<span class="n">save_arg</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_STR</span>: <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">save_str</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">save_str</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="n">PAGE_SIZE</span>
					<span class="o">||</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">save_str</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
				<span class="n">save_str</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">save_str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">save_str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">str</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_PTR</span>:
			<span class="n">save_arg</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
			<span class="cm">/* skip all alphanumeric pointer suffixes */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">))</span>
				<span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_NRCHARS</span>: <span class="p">{</span>
			<span class="cm">/* skip %n &#39;s argument */</span>
			<span class="n">u8</span> <span class="n">qualifier</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="n">qualifier</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">skip_arg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span><span class="p">)</span>
				<span class="n">skip_arg</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_tolower</span><span class="p">(</span><span class="n">qualifier</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;z&#39;</span><span class="p">)</span>
				<span class="n">skip_arg</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">skip_arg</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nl">default:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">case</span> <span class="n">FORMAT_TYPE_LONG_LONG</span>:
				<span class="n">save_arg</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_ULONG</span>:
			<span class="k">case</span> <span class="n">FORMAT_TYPE_LONG</span>:
				<span class="n">save_arg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_SIZE_T</span>:
				<span class="n">save_arg</span><span class="p">(</span><span class="kt">size_t</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_PTRDIFF</span>:
				<span class="n">save_arg</span><span class="p">(</span><span class="kt">ptrdiff_t</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_UBYTE</span>:
			<span class="k">case</span> <span class="n">FORMAT_TYPE_BYTE</span>:
				<span class="n">save_arg</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_USHORT</span>:
			<span class="k">case</span> <span class="n">FORMAT_TYPE_SHORT</span>:
				<span class="n">save_arg</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">save_arg</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="o">-</span> <span class="n">bin_buf</span><span class="p">;</span>
<span class="cp">#undef save_arg</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">vbin_printf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * bstr_printf - Format a string from binary arguments and place it in a buffer</span>
<span class="cm"> * @buf: The buffer to place the result into</span>
<span class="cm"> * @size: The size of the buffer, including the trailing null space</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @bin_buf: Binary arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * This function like C99 vsnprintf, but the difference is that vsnprintf gets</span>
<span class="cm"> * arguments from stack, and bstr_printf gets arguments from @bin_buf which is</span>
<span class="cm"> * a binary buffer that generated by vbin_printf.</span>
<span class="cm"> *</span>
<span class="cm"> * The format follows C99 vsnprintf, but has some extensions:</span>
<span class="cm"> *  see vsnprintf comment for details.</span>
<span class="cm"> *</span>
<span class="cm"> * The return value is the number of characters which would</span>
<span class="cm"> * be generated for the given input, excluding the trailing</span>
<span class="cm"> * &#39;\0&#39;, as per ISO C99. If you want to have the exact</span>
<span class="cm"> * number of characters written into @buf as return value</span>
<span class="cm"> * (not including the trailing &#39;\0&#39;), use vscnprintf(). If the</span>
<span class="cm"> * return is greater than or equal to @size, the resulting</span>
<span class="cm"> * string is truncated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bstr_printf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bin_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">printf_spec</span> <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bin_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

<span class="cp">#define get_arg(type)							\</span>
<span class="cp">({									\</span>
<span class="cp">	typeof(type) value;						\</span>
<span class="cp">	if (sizeof(type) == 8) {					\</span>
<span class="cp">		args = PTR_ALIGN(args, sizeof(u32));			\</span>
<span class="cp">		*(u32 *)&amp;value = *(u32 *)args;				\</span>
<span class="cp">		*((u32 *)&amp;value + 1) = *(u32 *)(args + 4);		\</span>
<span class="cp">	} else {							\</span>
<span class="cp">		args = PTR_ALIGN(args, sizeof(type));			\</span>
<span class="cp">		value = *(typeof(type) *)args;				\</span>
<span class="cp">	}								\</span>
<span class="cp">	args += sizeof(type);						\</span>
<span class="cp">	value;								\</span>
<span class="cp">})</span>

	<span class="cm">/* Make sure end is always &gt;= buf */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">format_decode</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="p">);</span>

		<span class="n">fmt</span> <span class="o">+=</span> <span class="n">read</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FORMAT_TYPE_NONE</span>: <span class="p">{</span>
			<span class="kt">int</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">end</span> <span class="o">-</span> <span class="n">str</span><span class="p">)</span>
					<span class="n">copy</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">str</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">old_fmt</span><span class="p">,</span> <span class="n">copy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">str</span> <span class="o">+=</span> <span class="n">read</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_WIDTH</span>:
			<span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_PRECISION</span>:
			<span class="n">spec</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_CHAR</span>: <span class="p">{</span>
			<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEFT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
						<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
					<span class="o">++</span><span class="n">str</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="o">++</span><span class="n">str</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">spec</span><span class="p">.</span><span class="n">field_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
					<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
				<span class="o">++</span><span class="n">str</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_STR</span>: <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>
			<span class="n">args</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str_arg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">str</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">str_arg</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_PTR</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">(</span><span class="n">fmt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">spec</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">))</span>
				<span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_PERCENT_CHAR</span>:
		<span class="k">case</span> <span class="n">FORMAT_TYPE_INVALID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;%&#39;</span><span class="p">;</span>
			<span class="o">++</span><span class="n">str</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FORMAT_TYPE_NRCHARS</span>:
			<span class="cm">/* skip */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">num</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">case</span> <span class="n">FORMAT_TYPE_LONG_LONG</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_ULONG</span>:
			<span class="k">case</span> <span class="n">FORMAT_TYPE_LONG</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_SIZE_T</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">size_t</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_PTRDIFF</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">ptrdiff_t</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_UBYTE</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_BYTE</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_USHORT</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_SHORT</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FORMAT_TYPE_UINT</span>:
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">num</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">str</span> <span class="o">=</span> <span class="n">number</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
		<span class="p">}</span> <span class="cm">/* default: */</span>
		<span class="p">}</span> <span class="cm">/* switch(spec.type) */</span>
	<span class="p">}</span> <span class="cm">/* while(*fmt) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#undef get_arg</span>

	<span class="cm">/* the trailing null byte doesn&#39;t count towards the total */</span>
	<span class="k">return</span> <span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">bstr_printf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * bprintf - Parse a format string and place args&#39; binary value in a buffer</span>
<span class="cm"> * @bin_buf: The buffer to place args&#39; binary value</span>
<span class="cm"> * @size: The size of the buffer(by words(32bits), not characters)</span>
<span class="cm"> * @fmt: The format string to use</span>
<span class="cm"> * @...: Arguments for the format string</span>
<span class="cm"> *</span>
<span class="cm"> * The function returns the number of words(u32) written</span>
<span class="cm"> * into @bin_buf.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bprintf</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">bin_buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vbin_printf</span><span class="p">(</span><span class="n">bin_buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">bprintf</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_BINARY_PRINTF */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * vsscanf - Unformat a buffer into a list of arguments</span>
<span class="cm"> * @buf:	input buffer</span>
<span class="cm"> * @fmt:	format of buffer</span>
<span class="cm"> * @args:	arguments</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vsscanf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">digit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">qualifier</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">field_width</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_sign</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skip any white space in format */</span>
		<span class="cm">/* white space in format matchs any amount of</span>
<span class="cm">		 * white space, including none, in the input.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="o">++</span><span class="n">fmt</span><span class="p">);</span>
			<span class="n">str</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* anything that is not a conversion must match exactly */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">!=</span> <span class="sc">&#39;%&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="o">++</span> <span class="o">!=</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">fmt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="o">++</span><span class="n">fmt</span><span class="p">;</span>

		<span class="cm">/* skip this conversion.</span>
<span class="cm">		 * advance both strings to next white space</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">!=</span> <span class="sc">&#39;%&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
				<span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
				<span class="n">str</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get field width */</span>
		<span class="n">field_width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">))</span>
			<span class="n">field_width</span> <span class="o">=</span> <span class="n">skip_atoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>

		<span class="cm">/* get conversion qualifier */</span>
		<span class="n">qualifier</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span> <span class="o">||</span> <span class="n">_tolower</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span> <span class="o">||</span>
		    <span class="n">_tolower</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;z&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qualifier</span> <span class="o">=</span> <span class="o">*</span><span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">qualifier</span> <span class="o">==</span> <span class="o">*</span><span class="n">fmt</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">qualifier</span> <span class="o">=</span> <span class="sc">&#39;H&#39;</span><span class="p">;</span>
					<span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qualifier</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">qualifier</span> <span class="o">=</span> <span class="sc">&#39;L&#39;</span><span class="p">;</span>
					<span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">fmt</span> <span class="o">||</span> <span class="o">!*</span><span class="n">str</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">is_sign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
		<span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field_width</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">field_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">field_width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
			<span class="n">num</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field_width</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">field_width</span> <span class="o">=</span> <span class="n">SHRT_MAX</span><span class="p">;</span>
			<span class="cm">/* first, skip leading white space in buffer */</span>
			<span class="n">str</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

			<span class="cm">/* now copy until next white space */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">field_width</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">num</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
			<span class="cm">/* return number of characters read so far */</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span><span class="p">);</span>
			<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;o&#39;</span>:
			<span class="n">base</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:
			<span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:
			<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="n">is_sign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;%&#39;</span>:
			<span class="cm">/* looking for &#39;%&#39; in str */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* invalid format; stop here */</span>
			<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* have some sort of integer conversion.</span>
<span class="cm">		 * first, skip white space in buffer.</span>
<span class="cm">		 */</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

		<span class="n">digit</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_sign</span> <span class="o">&amp;&amp;</span> <span class="n">digit</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
			<span class="n">digit</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">digit</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">digit</span><span class="p">))</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">digit</span><span class="p">))</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">digit</span><span class="p">)</span> <span class="o">||</span> <span class="n">digit</span> <span class="o">&gt;</span> <span class="sc">&#39;7&#39;</span><span class="p">))</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">digit</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">qualifier</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;H&#39;</span>:	<span class="cm">/* that&#39;s &#39;hh&#39; in format */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_sign</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">signed</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">signed</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)</span><span class="n">simple_strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">is_sign</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">short</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">simple_strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">is_sign</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">long</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">is_sign</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">simple_strtoll</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;Z&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
		<span class="p">{</span>
			<span class="kt">size_t</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="p">);</span>
			<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_sign</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">);</span>
				<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we&#39;ve come all the way through so either the input string or the</span>
<span class="cm">	 * format ended. In the former case, there can be a %n at the current</span>
<span class="cm">	 * position in the format that needs to be filled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">fmt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vsscanf</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * sscanf - Unformat a buffer into a list of arguments</span>
<span class="cm"> * @buf:	input buffer</span>
<span class="cm"> * @fmt:	formatting of buffer</span>
<span class="cm"> * @...:	resulting arguments</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sscanf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">vsscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sscanf</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
