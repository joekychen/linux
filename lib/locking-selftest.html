<!DOCTYPE html>
<html><head><title>joekychen/linux » lib › locking-selftest.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>locking-selftest.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * lib/locking-selftest.c</span>
<span class="cm"> *</span>
<span class="cm"> * Testsuite for various locking APIs: spinlocks, rwlocks,</span>
<span class="cm"> * mutexes and rw-semaphores.</span>
<span class="cm"> *</span>
<span class="cm"> * It is checking both false positives and false negatives.</span>
<span class="cm"> *</span>
<span class="cm"> * Started by Ingo Molnar:</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Red Hat, Inc., Ingo Molnar &lt;mingo@redhat.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/rwsem.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/lockdep.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/debug_locks.h&gt;</span>
<span class="cp">#include &lt;linux/irqflags.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Change this to 1 if you want to see the failure printouts:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug_locks_verbose</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_debug_locks_verbose</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_locks_verbose</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;debug_locks_verbose=&quot;</span><span class="p">,</span> <span class="n">setup_debug_locks_verbose</span><span class="p">);</span>

<span class="cp">#define FAILURE		0</span>
<span class="cp">#define SUCCESS		1</span>

<span class="cp">#define LOCKTYPE_SPIN	0x1</span>
<span class="cp">#define LOCKTYPE_RWLOCK	0x2</span>
<span class="cp">#define LOCKTYPE_MUTEX	0x4</span>
<span class="cp">#define LOCKTYPE_RWSEM	0x8</span>

<span class="cm">/*</span>
<span class="cm"> * Normal standalone locks, for the circular and irq-context</span>
<span class="cm"> * dependency tests:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_C</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_D</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_A</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_B</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_C</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_D</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_A</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_B</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_C</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_D</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_A</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_B</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_C</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_D</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Locks that we initialize dynamically as well so that</span>
<span class="cm"> * e.g. X1 and X2 becomes two instances of the same class,</span>
<span class="cm"> * but X* and Y* are different classes. We do this so that</span>
<span class="cm"> * we do not trigger a real lockup:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_X1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_X2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_Y1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_Y2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_Z1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock_Z2</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_X1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_X2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_Y1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_Y2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_Z1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">rwlock_Z2</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_X1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_X2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_Y1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_Y2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_Z1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mutex_Z2</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_X1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_X2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_Y1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_Y2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_Z1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">rwsem_Z2</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * non-inlined runtime initializers, to let separate locks share</span>
<span class="cm"> * the same lock-class:</span>
<span class="cm"> */</span>
<span class="cp">#define INIT_CLASS_FUNC(class) 				\</span>
<span class="cp">static noinline void					\</span>
<span class="cp">init_class_##class(spinlock_t *lock, rwlock_t *rwlock, struct mutex *mutex, \</span>
<span class="cp">		 struct rw_semaphore *rwsem)		\</span>
<span class="cp">{							\</span>
<span class="cp">	spin_lock_init(lock);				\</span>
<span class="cp">	rwlock_init(rwlock);				\</span>
<span class="cp">	mutex_init(mutex);				\</span>
<span class="cp">	init_rwsem(rwsem);				\</span>
<span class="cp">}</span>

<span class="n">INIT_CLASS_FUNC</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">INIT_CLASS_FUNC</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
<span class="n">INIT_CLASS_FUNC</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">init_shared_classes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_class_X</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_X1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwlock_X1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_X1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwsem_X1</span><span class="p">);</span>
	<span class="n">init_class_X</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_X2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwlock_X2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_X2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwsem_X2</span><span class="p">);</span>

	<span class="n">init_class_Y</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_Y1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwlock_Y1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_Y1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwsem_Y1</span><span class="p">);</span>
	<span class="n">init_class_Y</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_Y2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwlock_Y2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_Y2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwsem_Y2</span><span class="p">);</span>

	<span class="n">init_class_Z</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_Z1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwlock_Z1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_Z1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwsem_Z1</span><span class="p">);</span>
	<span class="n">init_class_Z</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_Z2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwlock_Z2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_Z2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rwsem_Z2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For spinlocks and rwlocks we also do hardirq-safe / softirq-safe tests.</span>
<span class="cm"> * The following functions use a lock from a simulated hardirq/softirq</span>
<span class="cm"> * context, causing the locks to be marked as hardirq-safe/softirq-safe:</span>
<span class="cm"> */</span>

<span class="cp">#define HARDIRQ_DISABLE		local_irq_disable</span>
<span class="cp">#define HARDIRQ_ENABLE		local_irq_enable</span>

<span class="cp">#define HARDIRQ_ENTER()				\</span>
<span class="cp">	local_irq_disable();			\</span>
<span class="cp">	__irq_enter();				\</span>
<span class="cp">	WARN_ON(!in_irq());</span>

<span class="cp">#define HARDIRQ_EXIT()				\</span>
<span class="cp">	__irq_exit();				\</span>
<span class="cp">	local_irq_enable();</span>

<span class="cp">#define SOFTIRQ_DISABLE		local_bh_disable</span>
<span class="cp">#define SOFTIRQ_ENABLE		local_bh_enable</span>

<span class="cp">#define SOFTIRQ_ENTER()				\</span>
<span class="cp">		local_bh_disable();		\</span>
<span class="cp">		local_irq_disable();		\</span>
<span class="cp">		lockdep_softirq_enter();	\</span>
<span class="cp">		WARN_ON(!in_softirq());</span>

<span class="cp">#define SOFTIRQ_EXIT()				\</span>
<span class="cp">		lockdep_softirq_exit();		\</span>
<span class="cp">		local_irq_enable();		\</span>
<span class="cp">		local_bh_enable();</span>

<span class="cm">/*</span>
<span class="cm"> * Shortcuts for lock/unlock API variants, to keep</span>
<span class="cm"> * the testcases compact:</span>
<span class="cm"> */</span>
<span class="cp">#define L(x)			spin_lock(&amp;lock_##x)</span>
<span class="cp">#define U(x)			spin_unlock(&amp;lock_##x)</span>
<span class="cp">#define LU(x)			L(x); U(x)</span>
<span class="cp">#define SI(x)			spin_lock_init(&amp;lock_##x)</span>

<span class="cp">#define WL(x)			write_lock(&amp;rwlock_##x)</span>
<span class="cp">#define WU(x)			write_unlock(&amp;rwlock_##x)</span>
<span class="cp">#define WLU(x)			WL(x); WU(x)</span>

<span class="cp">#define RL(x)			read_lock(&amp;rwlock_##x)</span>
<span class="cp">#define RU(x)			read_unlock(&amp;rwlock_##x)</span>
<span class="cp">#define RLU(x)			RL(x); RU(x)</span>
<span class="cp">#define RWI(x)			rwlock_init(&amp;rwlock_##x)</span>

<span class="cp">#define ML(x)			mutex_lock(&amp;mutex_##x)</span>
<span class="cp">#define MU(x)			mutex_unlock(&amp;mutex_##x)</span>
<span class="cp">#define MI(x)			mutex_init(&amp;mutex_##x)</span>

<span class="cp">#define WSL(x)			down_write(&amp;rwsem_##x)</span>
<span class="cp">#define WSU(x)			up_write(&amp;rwsem_##x)</span>

<span class="cp">#define RSL(x)			down_read(&amp;rwsem_##x)</span>
<span class="cp">#define RSU(x)			up_read(&amp;rwsem_##x)</span>
<span class="cp">#define RWSI(x)			init_rwsem(&amp;rwsem_##x)</span>

<span class="cp">#define LOCK_UNLOCK_2(x,y)	LOCK(x); LOCK(y); UNLOCK(y); UNLOCK(x)</span>

<span class="cm">/*</span>
<span class="cm"> * Generate different permutations of the same testcase, using</span>
<span class="cm"> * the same basic lock-dependency/state events:</span>
<span class="cm"> */</span>

<span class="cp">#define GENERATE_TESTCASE(name)			\</span>
<span class="cp">						\</span>
<span class="cp">static void name(void) { E(); }</span>

<span class="cp">#define GENERATE_PERMUTATIONS_2_EVENTS(name)	\</span>
<span class="cp">						\</span>
<span class="cp">static void name##_12(void) { E1(); E2(); }	\</span>
<span class="cp">static void name##_21(void) { E2(); E1(); }</span>

<span class="cp">#define GENERATE_PERMUTATIONS_3_EVENTS(name)		\</span>
<span class="cp">							\</span>
<span class="cp">static void name##_123(void) { E1(); E2(); E3(); }	\</span>
<span class="cp">static void name##_132(void) { E1(); E3(); E2(); }	\</span>
<span class="cp">static void name##_213(void) { E2(); E1(); E3(); }	\</span>
<span class="cp">static void name##_231(void) { E2(); E3(); E1(); }	\</span>
<span class="cp">static void name##_312(void) { E3(); E1(); E2(); }	\</span>
<span class="cp">static void name##_321(void) { E3(); E2(); E1(); }</span>

<span class="cm">/*</span>
<span class="cm"> * AA deadlock:</span>
<span class="cm"> */</span>

<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK(X1);				\</span>
<span class="cp">	LOCK(X2); </span><span class="cm">/* this one should fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">AA_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">AA_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">AA_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">AA_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">AA_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">AA_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * Special-case for read-locking, they are</span>
<span class="cm"> * allowed to recurse on the same lock class:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rlock_AA1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span>
	<span class="n">RL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span> <span class="c1">// this one should NOT fail</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rlock_AA1B</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span>
	<span class="n">RL</span><span class="p">(</span><span class="n">X2</span><span class="p">);</span> <span class="c1">// this one should NOT fail</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rsem_AA1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RSL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span>
	<span class="n">RSL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span> <span class="c1">// this one should fail</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rsem_AA1B</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RSL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span>
	<span class="n">RSL</span><span class="p">(</span><span class="n">X2</span><span class="p">);</span> <span class="c1">// this one should fail</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * The mixing of read and write locks is not allowed:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rlock_AA2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span>
	<span class="n">WL</span><span class="p">(</span><span class="n">X2</span><span class="p">);</span> <span class="c1">// this one should fail</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rsem_AA2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RSL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span>
	<span class="n">WSL</span><span class="p">(</span><span class="n">X2</span><span class="p">);</span> <span class="c1">// this one should fail</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rlock_AA3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span>
	<span class="n">RL</span><span class="p">(</span><span class="n">X2</span><span class="p">);</span> <span class="c1">// this one should fail</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rsem_AA3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WSL</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span>
	<span class="n">RSL</span><span class="p">(</span><span class="n">X2</span><span class="p">);</span> <span class="c1">// this one should fail</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ABBA deadlock:</span>
<span class="cm"> */</span>

<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK_UNLOCK_2(A, B);			\</span>
<span class="cp">	LOCK_UNLOCK_2(B, A); </span><span class="cm">/* fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBA_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBA_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBA_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBA_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBA_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBA_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * AB BC CA deadlock:</span>
<span class="cm"> */</span>

<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK_UNLOCK_2(A, B);			\</span>
<span class="cp">	LOCK_UNLOCK_2(B, C);			\</span>
<span class="cp">	LOCK_UNLOCK_2(C, A); </span><span class="cm">/* fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCA_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCA_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCA_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCA_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCA_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCA_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * AB CA BC deadlock:</span>
<span class="cm"> */</span>

<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK_UNLOCK_2(A, B);			\</span>
<span class="cp">	LOCK_UNLOCK_2(C, A);			\</span>
<span class="cp">	LOCK_UNLOCK_2(B, C); </span><span class="cm">/* fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCABC_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCABC_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCABC_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCABC_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCABC_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCABC_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * AB BC CD DA deadlock:</span>
<span class="cm"> */</span>

<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK_UNLOCK_2(A, B);			\</span>
<span class="cp">	LOCK_UNLOCK_2(B, C);			\</span>
<span class="cp">	LOCK_UNLOCK_2(C, D);			\</span>
<span class="cp">	LOCK_UNLOCK_2(D, A); </span><span class="cm">/* fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCDDA_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCDDA_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCDDA_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCDDA_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCDDA_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABBCCDDA_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * AB CD BD DA deadlock:</span>
<span class="cm"> */</span>
<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK_UNLOCK_2(A, B);			\</span>
<span class="cp">	LOCK_UNLOCK_2(C, D);			\</span>
<span class="cp">	LOCK_UNLOCK_2(B, D);			\</span>
<span class="cp">	LOCK_UNLOCK_2(D, A); </span><span class="cm">/* fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBDDA_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBDDA_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBDDA_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBDDA_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBDDA_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBDDA_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * AB CD BC DA deadlock:</span>
<span class="cm"> */</span>
<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK_UNLOCK_2(A, B);			\</span>
<span class="cp">	LOCK_UNLOCK_2(C, D);			\</span>
<span class="cp">	LOCK_UNLOCK_2(B, C);			\</span>
<span class="cp">	LOCK_UNLOCK_2(D, A); </span><span class="cm">/* fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBCDA_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBCDA_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBCDA_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBCDA_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBCDA_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">ABCDBCDA_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * Double unlock:</span>
<span class="cm"> */</span>
<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK(A);				\</span>
<span class="cp">	UNLOCK(A);				\</span>
<span class="cp">	UNLOCK(A); </span><span class="cm">/* fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">double_unlock_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">double_unlock_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">double_unlock_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">double_unlock_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">double_unlock_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">double_unlock_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * Bad unlock ordering:</span>
<span class="cm"> */</span>
<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK(A);				\</span>
<span class="cp">	LOCK(B);				\</span>
<span class="cp">	UNLOCK(A); </span><span class="cm">/* fail */</span><span class="cp">			\</span>
<span class="cp">	UNLOCK(B);</span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">bad_unlock_order_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">bad_unlock_order_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">bad_unlock_order_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">bad_unlock_order_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">bad_unlock_order_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">bad_unlock_order_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * initializing a held lock:</span>
<span class="cm"> */</span>
<span class="cp">#define E()					\</span>
<span class="cp">						\</span>
<span class="cp">	LOCK(A);				\</span>
<span class="cp">	INIT(A); </span><span class="cm">/* fail */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * 6 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">init_held_spin</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">init_held_wlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">init_held_rlock</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-mutex.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">init_held_mutex</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-wsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">init_held_wsem</span><span class="p">)</span>
<span class="cp">#include &quot;locking-selftest-rsem.h&quot;</span>
<span class="n">GENERATE_TESTCASE</span><span class="p">(</span><span class="n">init_held_rsem</span><span class="p">)</span>

<span class="cp">#undef E</span>

<span class="cm">/*</span>
<span class="cm"> * locking an irq-safe lock with irqs enabled:</span>
<span class="cm"> */</span>
<span class="cp">#define E1()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_ENTER();			\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	UNLOCK(A);			\</span>
<span class="cp">	IRQ_EXIT();</span>

<span class="cp">#define E2()				\</span>
<span class="cp">					\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	UNLOCK(A);</span>

<span class="cm">/*</span>
<span class="cm"> * Generate 24 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe1_hard_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe1_hard_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe1_hard_wlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-spin-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe1_soft_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe1_soft_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe1_soft_wlock</span><span class="p">)</span>

<span class="cp">#undef E1</span>
<span class="cp">#undef E2</span>

<span class="cm">/*</span>
<span class="cm"> * Enabling hardirqs with a softirq-safe lock held:</span>
<span class="cm"> */</span>
<span class="cp">#define E1()				\</span>
<span class="cp">					\</span>
<span class="cp">	SOFTIRQ_ENTER();		\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	UNLOCK(A);			\</span>
<span class="cp">	SOFTIRQ_EXIT();</span>

<span class="cp">#define E2()				\</span>
<span class="cp">					\</span>
<span class="cp">	HARDIRQ_DISABLE();		\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	HARDIRQ_ENABLE();		\</span>
<span class="cp">	UNLOCK(A);</span>

<span class="cm">/*</span>
<span class="cm"> * Generate 12 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2A_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2A_wlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2A_rlock</span><span class="p">)</span>

<span class="cp">#undef E1</span>
<span class="cp">#undef E2</span>

<span class="cm">/*</span>
<span class="cm"> * Enabling irqs with an irq-safe lock held:</span>
<span class="cm"> */</span>
<span class="cp">#define E1()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_ENTER();			\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	UNLOCK(A);			\</span>
<span class="cp">	IRQ_EXIT();</span>

<span class="cp">#define E2()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_DISABLE();			\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	IRQ_ENABLE();			\</span>
<span class="cp">	UNLOCK(A);</span>

<span class="cm">/*</span>
<span class="cm"> * Generate 24 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2B_hard_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2B_hard_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2B_hard_wlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-spin-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2B_soft_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2B_soft_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_2_EVENTS</span><span class="p">(</span><span class="n">irqsafe2B_soft_wlock</span><span class="p">)</span>

<span class="cp">#undef E1</span>
<span class="cp">#undef E2</span>

<span class="cm">/*</span>
<span class="cm"> * Acquiring a irq-unsafe lock while holding an irq-safe-lock:</span>
<span class="cm"> */</span>
<span class="cp">#define E1()				\</span>
<span class="cp">					\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	LOCK(B);			\</span>
<span class="cp">	UNLOCK(B);			\</span>
<span class="cp">	UNLOCK(A);			\</span>

<span class="cp">#define E2()				\</span>
<span class="cp">					\</span>
<span class="cp">	LOCK(B);			\</span>
<span class="cp">	UNLOCK(B);</span>

<span class="cp">#define E3()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_ENTER();			\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	UNLOCK(A);			\</span>
<span class="cp">	IRQ_EXIT();</span>

<span class="cm">/*</span>
<span class="cm"> * Generate 36 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe3_hard_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe3_hard_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe3_hard_wlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-spin-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe3_soft_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe3_soft_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe3_soft_wlock</span><span class="p">)</span>

<span class="cp">#undef E1</span>
<span class="cp">#undef E2</span>
<span class="cp">#undef E3</span>

<span class="cm">/*</span>
<span class="cm"> * If a lock turns into softirq-safe, but earlier it took</span>
<span class="cm"> * a softirq-unsafe lock:</span>
<span class="cm"> */</span>

<span class="cp">#define E1()				\</span>
<span class="cp">	IRQ_DISABLE();			\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	LOCK(B);			\</span>
<span class="cp">	UNLOCK(B);			\</span>
<span class="cp">	UNLOCK(A);			\</span>
<span class="cp">	IRQ_ENABLE();</span>

<span class="cp">#define E2()				\</span>
<span class="cp">	LOCK(B);			\</span>
<span class="cp">	UNLOCK(B);</span>

<span class="cp">#define E3()				\</span>
<span class="cp">	IRQ_ENTER();			\</span>
<span class="cp">	LOCK(A);			\</span>
<span class="cp">	UNLOCK(A);			\</span>
<span class="cp">	IRQ_EXIT();</span>

<span class="cm">/*</span>
<span class="cm"> * Generate 36 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe4_hard_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe4_hard_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe4_hard_wlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-spin-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe4_soft_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe4_soft_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irqsafe4_soft_wlock</span><span class="p">)</span>

<span class="cp">#undef E1</span>
<span class="cp">#undef E2</span>
<span class="cp">#undef E3</span>

<span class="cm">/*</span>
<span class="cm"> * read-lock / write-lock irq inversion.</span>
<span class="cm"> *</span>
<span class="cm"> * Deadlock scenario:</span>
<span class="cm"> *</span>
<span class="cm"> * CPU#1 is at #1, i.e. it has write-locked A, but has not</span>
<span class="cm"> * taken B yet.</span>
<span class="cm"> *</span>
<span class="cm"> * CPU#2 is at #2, i.e. it has locked B.</span>
<span class="cm"> *</span>
<span class="cm"> * Hardirq hits CPU#2 at point #2 and is trying to read-lock A.</span>
<span class="cm"> *</span>
<span class="cm"> * The deadlock occurs because CPU#1 will spin on B, and CPU#2</span>
<span class="cm"> * will spin on A.</span>
<span class="cm"> */</span>

<span class="cp">#define E1()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_DISABLE();			\</span>
<span class="cp">	WL(A);				\</span>
<span class="cp">	LOCK(B);			\</span>
<span class="cp">	UNLOCK(B);			\</span>
<span class="cp">	WU(A);				\</span>
<span class="cp">	IRQ_ENABLE();</span>

<span class="cp">#define E2()				\</span>
<span class="cp">					\</span>
<span class="cp">	LOCK(B);			\</span>
<span class="cp">	UNLOCK(B);</span>

<span class="cp">#define E3()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_ENTER();			\</span>
<span class="cp">	RL(A);				\</span>
<span class="cp">	RU(A);				\</span>
<span class="cp">	IRQ_EXIT();</span>

<span class="cm">/*</span>
<span class="cm"> * Generate 36 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-spin-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irq_inversion_hard_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irq_inversion_hard_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irq_inversion_hard_wlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-spin-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irq_inversion_soft_spin</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-rlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irq_inversion_soft_rlock</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-wlock-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irq_inversion_soft_wlock</span><span class="p">)</span>

<span class="cp">#undef E1</span>
<span class="cp">#undef E2</span>
<span class="cp">#undef E3</span>

<span class="cm">/*</span>
<span class="cm"> * read-lock / write-lock recursion that is actually safe.</span>
<span class="cm"> */</span>

<span class="cp">#define E1()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_DISABLE();			\</span>
<span class="cp">	WL(A);				\</span>
<span class="cp">	WU(A);				\</span>
<span class="cp">	IRQ_ENABLE();</span>

<span class="cp">#define E2()				\</span>
<span class="cp">					\</span>
<span class="cp">	RL(A);				\</span>
<span class="cp">	RU(A);				\</span>

<span class="cp">#define E3()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_ENTER();			\</span>
<span class="cp">	RL(A);				\</span>
<span class="cp">	L(B);				\</span>
<span class="cp">	U(B);				\</span>
<span class="cp">	RU(A);				\</span>
<span class="cp">	IRQ_EXIT();</span>

<span class="cm">/*</span>
<span class="cm"> * Generate 12 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-hardirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irq_read_recursion_hard</span><span class="p">)</span>

<span class="cp">#include &quot;locking-selftest-softirq.h&quot;</span>
<span class="n">GENERATE_PERMUTATIONS_3_EVENTS</span><span class="p">(</span><span class="n">irq_read_recursion_soft</span><span class="p">)</span>

<span class="cp">#undef E1</span>
<span class="cp">#undef E2</span>
<span class="cp">#undef E3</span>

<span class="cm">/*</span>
<span class="cm"> * read-lock / write-lock recursion that is unsafe.</span>
<span class="cm"> */</span>

<span class="cp">#define E1()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_DISABLE();			\</span>
<span class="cp">	L(B);				\</span>
<span class="cp">	WL(A);				\</span>
<span class="cp">	WU(A);				\</span>
<span class="cp">	U(B);				\</span>
<span class="cp">	IRQ_ENABLE();</span>

<span class="cp">#define E2()				\</span>
<span class="cp">					\</span>
<span class="cp">	RL(A);				\</span>
<span class="cp">	RU(A);				\</span>

<span class="cp">#define E3()				\</span>
<span class="cp">					\</span>
<span class="cp">	IRQ_ENTER();			\</span>
<span class="cp">	L(B);				\</span>
<span class="cp">	U(B);				\</span>
<span class="cp">	IRQ_EXIT();</span>

<span class="cm">/*</span>
<span class="cm"> * Generate 12 testcases:</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;locking-selftest-hardirq.h&quot;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>GENERATE<em>PERMUTATIONS</em>3<em>EVENTS(irq</em>read<em>recursion2</em>hard)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;locking-selftest-softirq.h&quot;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>GENERATE<em>PERMUTATIONS</em>3<em>EVENTS(irq</em>read<em>recursion2</em>soft)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef CONFIG_DEBUG_LOCK_ALLOC</span>
<span class="cp"># define I_SPINLOCK(x)	lockdep_reset_lock(&amp;lock_##x.dep_map)</span>
<span class="cp"># define I_RWLOCK(x)	lockdep_reset_lock(&amp;rwlock_##x.dep_map)</span>
<span class="cp"># define I_MUTEX(x)	lockdep_reset_lock(&amp;mutex_##x.dep_map)</span>
<span class="cp"># define I_RWSEM(x)	lockdep_reset_lock(&amp;rwsem_##x.dep_map)</span>
<span class="cp">#else</span>
<span class="cp"># define I_SPINLOCK(x)</span>
<span class="cp"># define I_RWLOCK(x)</span>
<span class="cp"># define I_MUTEX(x)</span>
<span class="cp"># define I_RWSEM(x)</span>
<span class="cp">#endif</span>

<span class="cp">#define I1(x)					\</span>
<span class="cp">	do {					\</span>
<span class="cp">		I_SPINLOCK(x);			\</span>
<span class="cp">		I_RWLOCK(x);			\</span>
<span class="cp">		I_MUTEX(x);			\</span>
<span class="cp">		I_RWSEM(x);			\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define I2(x)					\</span>
<span class="cp">	do {					\</span>
<span class="cp">		spin_lock_init(&amp;lock_##x);	\</span>
<span class="cp">		rwlock_init(&amp;rwlock_##x);	\</span>
<span class="cp">		mutex_init(&amp;mutex_##x);		\</span>
<span class="cp">		init_rwsem(&amp;rwsem_##x);		\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_locks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">I1</span><span class="p">(</span><span class="n">A</span><span class="p">);</span> <span class="n">I1</span><span class="p">(</span><span class="n">B</span><span class="p">);</span> <span class="n">I1</span><span class="p">(</span><span class="n">C</span><span class="p">);</span> <span class="n">I1</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
	<span class="n">I1</span><span class="p">(</span><span class="n">X1</span><span class="p">);</span> <span class="n">I1</span><span class="p">(</span><span class="n">X2</span><span class="p">);</span> <span class="n">I1</span><span class="p">(</span><span class="n">Y1</span><span class="p">);</span> <span class="n">I1</span><span class="p">(</span><span class="n">Y2</span><span class="p">);</span> <span class="n">I1</span><span class="p">(</span><span class="n">Z1</span><span class="p">);</span> <span class="n">I1</span><span class="p">(</span><span class="n">Z2</span><span class="p">);</span>
	<span class="n">lockdep_reset</span><span class="p">();</span>
	<span class="n">I2</span><span class="p">(</span><span class="n">A</span><span class="p">);</span> <span class="n">I2</span><span class="p">(</span><span class="n">B</span><span class="p">);</span> <span class="n">I2</span><span class="p">(</span><span class="n">C</span><span class="p">);</span> <span class="n">I2</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
	<span class="n">init_shared_classes</span><span class="p">();</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#undef I</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">testcase_total</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">testcase_successes</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">expected_testcase_failures</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">unexpected_testcase_failures</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dotest</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">testcase_fn</span><span class="p">)(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">int</span> <span class="n">expected</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lockclass_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saved_preempt_count</span> <span class="o">=</span> <span class="n">preempt_count</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">expected_failure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">irqs_disabled</span><span class="p">());</span>

	<span class="n">testcase_fn</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * Filter out expected failures:</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef CONFIG_PROVE_LOCKING</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lockclass_mask</span> <span class="o">&amp;</span> <span class="n">LOCKTYPE_SPIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">debug_locks</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">)</span>
		<span class="n">expected_failure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lockclass_mask</span> <span class="o">&amp;</span> <span class="n">LOCKTYPE_RWLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">debug_locks</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">)</span>
		<span class="n">expected_failure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lockclass_mask</span> <span class="o">&amp;</span> <span class="n">LOCKTYPE_MUTEX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">debug_locks</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">)</span>
		<span class="n">expected_failure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lockclass_mask</span> <span class="o">&amp;</span> <span class="n">LOCKTYPE_RWSEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">debug_locks</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">)</span>
		<span class="n">expected_failure</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_locks</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">expected_failure</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">expected_testcase_failures</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;failed|&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">unexpected_testcase_failures</span><span class="o">++</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FAILED|&quot;</span><span class="p">);</span>
			<span class="n">dump_stack</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">testcase_successes</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  ok  |&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">testcase_total</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_locks_verbose</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; lockclass mask: %x, debug_locks: %d, expected: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">lockclass_mask</span><span class="p">,</span> <span class="n">debug_locks</span><span class="p">,</span> <span class="n">expected</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Some tests (e.g. double-unlock) might corrupt the preemption</span>
<span class="cm">	 * count, so restore it:</span>
<span class="cm">	 */</span>
	<span class="n">preempt_count</span><span class="p">()</span> <span class="o">=</span> <span class="n">saved_preempt_count</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TRACE_IRQFLAGS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">softirq_count</span><span class="p">())</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">softirqs_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">softirqs_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">reset_locks</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">print_testname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">testname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%33s:&quot;</span><span class="p">,</span> <span class="n">testname</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DO_TESTCASE_1(desc, name, nr)				\</span>
<span class="cp">	print_testname(desc&quot;/&quot;#nr);				\</span>
<span class="cp">	dotest(name##_##nr, SUCCESS, LOCKTYPE_RWLOCK);		\</span>
<span class="cp">	printk(&quot;\n&quot;);</span>

<span class="cp">#define DO_TESTCASE_1B(desc, name, nr)				\</span>
<span class="cp">	print_testname(desc&quot;/&quot;#nr);				\</span>
<span class="cp">	dotest(name##_##nr, FAILURE, LOCKTYPE_RWLOCK);		\</span>
<span class="cp">	printk(&quot;\n&quot;);</span>

<span class="cp">#define DO_TESTCASE_3(desc, name, nr)				\</span>
<span class="cp">	print_testname(desc&quot;/&quot;#nr);				\</span>
<span class="cp">	dotest(name##_spin_##nr, FAILURE, LOCKTYPE_SPIN);	\</span>
<span class="cp">	dotest(name##_wlock_##nr, FAILURE, LOCKTYPE_RWLOCK);	\</span>
<span class="cp">	dotest(name##_rlock_##nr, SUCCESS, LOCKTYPE_RWLOCK);	\</span>
<span class="cp">	printk(&quot;\n&quot;);</span>

<span class="cp">#define DO_TESTCASE_3RW(desc, name, nr)				\</span>
<span class="cp">	print_testname(desc&quot;/&quot;#nr);				\</span>
<span class="cp">	dotest(name##_spin_##nr, FAILURE, LOCKTYPE_SPIN|LOCKTYPE_RWLOCK);\</span>
<span class="cp">	dotest(name##_wlock_##nr, FAILURE, LOCKTYPE_RWLOCK);	\</span>
<span class="cp">	dotest(name##_rlock_##nr, SUCCESS, LOCKTYPE_RWLOCK);	\</span>
<span class="cp">	printk(&quot;\n&quot;);</span>

<span class="cp">#define DO_TESTCASE_6(desc, name)				\</span>
<span class="cp">	print_testname(desc);					\</span>
<span class="cp">	dotest(name##_spin, FAILURE, LOCKTYPE_SPIN);		\</span>
<span class="cp">	dotest(name##_wlock, FAILURE, LOCKTYPE_RWLOCK);		\</span>
<span class="cp">	dotest(name##_rlock, FAILURE, LOCKTYPE_RWLOCK);		\</span>
<span class="cp">	dotest(name##_mutex, FAILURE, LOCKTYPE_MUTEX);		\</span>
<span class="cp">	dotest(name##_wsem, FAILURE, LOCKTYPE_RWSEM);		\</span>
<span class="cp">	dotest(name##_rsem, FAILURE, LOCKTYPE_RWSEM);		\</span>
<span class="cp">	printk(&quot;\n&quot;);</span>

<span class="cp">#define DO_TESTCASE_6_SUCCESS(desc, name)			\</span>
<span class="cp">	print_testname(desc);					\</span>
<span class="cp">	dotest(name##_spin, SUCCESS, LOCKTYPE_SPIN);		\</span>
<span class="cp">	dotest(name##_wlock, SUCCESS, LOCKTYPE_RWLOCK);		\</span>
<span class="cp">	dotest(name##_rlock, SUCCESS, LOCKTYPE_RWLOCK);		\</span>
<span class="cp">	dotest(name##_mutex, SUCCESS, LOCKTYPE_MUTEX);		\</span>
<span class="cp">	dotest(name##_wsem, SUCCESS, LOCKTYPE_RWSEM);		\</span>
<span class="cp">	dotest(name##_rsem, SUCCESS, LOCKTYPE_RWSEM);		\</span>
<span class="cp">	printk(&quot;\n&quot;);</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;read&#39; variant: rlocks must not trigger.</span>
<span class="cm"> */</span>
<span class="cp">#define DO_TESTCASE_6R(desc, name)				\</span>
<span class="cp">	print_testname(desc);					\</span>
<span class="cp">	dotest(name##_spin, FAILURE, LOCKTYPE_SPIN);		\</span>
<span class="cp">	dotest(name##_wlock, FAILURE, LOCKTYPE_RWLOCK);		\</span>
<span class="cp">	dotest(name##_rlock, SUCCESS, LOCKTYPE_RWLOCK);		\</span>
<span class="cp">	dotest(name##_mutex, FAILURE, LOCKTYPE_MUTEX);		\</span>
<span class="cp">	dotest(name##_wsem, FAILURE, LOCKTYPE_RWSEM);		\</span>
<span class="cp">	dotest(name##_rsem, FAILURE, LOCKTYPE_RWSEM);		\</span>
<span class="cp">	printk(&quot;\n&quot;);</span>

<span class="cp">#define DO_TESTCASE_2I(desc, name, nr)				\</span>
<span class="cp">	DO_TESTCASE_1(&quot;hard-&quot;desc, name##_hard, nr);		\</span>
<span class="cp">	DO_TESTCASE_1(&quot;soft-&quot;desc, name##_soft, nr);</span>

<span class="cp">#define DO_TESTCASE_2IB(desc, name, nr)				\</span>
<span class="cp">	DO_TESTCASE_1B(&quot;hard-&quot;desc, name##_hard, nr);		\</span>
<span class="cp">	DO_TESTCASE_1B(&quot;soft-&quot;desc, name##_soft, nr);</span>

<span class="cp">#define DO_TESTCASE_6I(desc, name, nr)				\</span>
<span class="cp">	DO_TESTCASE_3(&quot;hard-&quot;desc, name##_hard, nr);		\</span>
<span class="cp">	DO_TESTCASE_3(&quot;soft-&quot;desc, name##_soft, nr);</span>

<span class="cp">#define DO_TESTCASE_6IRW(desc, name, nr)			\</span>
<span class="cp">	DO_TESTCASE_3RW(&quot;hard-&quot;desc, name##_hard, nr);		\</span>
<span class="cp">	DO_TESTCASE_3RW(&quot;soft-&quot;desc, name##_soft, nr);</span>

<span class="cp">#define DO_TESTCASE_2x3(desc, name)				\</span>
<span class="cp">	DO_TESTCASE_3(desc, name, 12);				\</span>
<span class="cp">	DO_TESTCASE_3(desc, name, 21);</span>

<span class="cp">#define DO_TESTCASE_2x6(desc, name)				\</span>
<span class="cp">	DO_TESTCASE_6I(desc, name, 12);				\</span>
<span class="cp">	DO_TESTCASE_6I(desc, name, 21);</span>

<span class="cp">#define DO_TESTCASE_6x2(desc, name)				\</span>
<span class="cp">	DO_TESTCASE_2I(desc, name, 123);			\</span>
<span class="cp">	DO_TESTCASE_2I(desc, name, 132);			\</span>
<span class="cp">	DO_TESTCASE_2I(desc, name, 213);			\</span>
<span class="cp">	DO_TESTCASE_2I(desc, name, 231);			\</span>
<span class="cp">	DO_TESTCASE_2I(desc, name, 312);			\</span>
<span class="cp">	DO_TESTCASE_2I(desc, name, 321);</span>

<span class="cp">#define DO_TESTCASE_6x2B(desc, name)				\</span>
<span class="cp">	DO_TESTCASE_2IB(desc, name, 123);			\</span>
<span class="cp">	DO_TESTCASE_2IB(desc, name, 132);			\</span>
<span class="cp">	DO_TESTCASE_2IB(desc, name, 213);			\</span>
<span class="cp">	DO_TESTCASE_2IB(desc, name, 231);			\</span>
<span class="cp">	DO_TESTCASE_2IB(desc, name, 312);			\</span>
<span class="cp">	DO_TESTCASE_2IB(desc, name, 321);</span>

<span class="cp">#define DO_TESTCASE_6x6(desc, name)				\</span>
<span class="cp">	DO_TESTCASE_6I(desc, name, 123);			\</span>
<span class="cp">	DO_TESTCASE_6I(desc, name, 132);			\</span>
<span class="cp">	DO_TESTCASE_6I(desc, name, 213);			\</span>
<span class="cp">	DO_TESTCASE_6I(desc, name, 231);			\</span>
<span class="cp">	DO_TESTCASE_6I(desc, name, 312);			\</span>
<span class="cp">	DO_TESTCASE_6I(desc, name, 321);</span>

<span class="cp">#define DO_TESTCASE_6x6RW(desc, name)				\</span>
<span class="cp">	DO_TESTCASE_6IRW(desc, name, 123);			\</span>
<span class="cp">	DO_TESTCASE_6IRW(desc, name, 132);			\</span>
<span class="cp">	DO_TESTCASE_6IRW(desc, name, 213);			\</span>
<span class="cp">	DO_TESTCASE_6IRW(desc, name, 231);			\</span>
<span class="cp">	DO_TESTCASE_6IRW(desc, name, 312);			\</span>
<span class="cp">	DO_TESTCASE_6IRW(desc, name, 321);</span>


<span class="kt">void</span> <span class="nf">locking_selftest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Got a locking failure before the selftest ran?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug_locks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;----------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;| Locking API testsuite disabled |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;----------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Run the testsuite:</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;| Locking API testsuite:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;----------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;                                 | spin |wlock |rlock |mutex | wsem | rsem |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  --------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">init_shared_classes</span><span class="p">();</span>
	<span class="n">debug_locks_silent</span> <span class="o">=</span> <span class="o">!</span><span class="n">debug_locks_verbose</span><span class="p">;</span>

	<span class="n">DO_TESTCASE_6R</span><span class="p">(</span><span class="s">&quot;A-A deadlock&quot;</span><span class="p">,</span> <span class="n">AA</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6R</span><span class="p">(</span><span class="s">&quot;A-B-B-A deadlock&quot;</span><span class="p">,</span> <span class="n">ABBA</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6R</span><span class="p">(</span><span class="s">&quot;A-B-B-C-C-A deadlock&quot;</span><span class="p">,</span> <span class="n">ABBCCA</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6R</span><span class="p">(</span><span class="s">&quot;A-B-C-A-B-C deadlock&quot;</span><span class="p">,</span> <span class="n">ABCABC</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6R</span><span class="p">(</span><span class="s">&quot;A-B-B-C-C-D-D-A deadlock&quot;</span><span class="p">,</span> <span class="n">ABBCCDDA</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6R</span><span class="p">(</span><span class="s">&quot;A-B-C-D-B-D-D-A deadlock&quot;</span><span class="p">,</span> <span class="n">ABCDBDDA</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6R</span><span class="p">(</span><span class="s">&quot;A-B-C-D-B-C-D-A deadlock&quot;</span><span class="p">,</span> <span class="n">ABCDBCDA</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6</span><span class="p">(</span><span class="s">&quot;double unlock&quot;</span><span class="p">,</span> <span class="n">double_unlock</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6</span><span class="p">(</span><span class="s">&quot;initialize held&quot;</span><span class="p">,</span> <span class="n">init_held</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6_SUCCESS</span><span class="p">(</span><span class="s">&quot;bad unlock order&quot;</span><span class="p">,</span> <span class="n">bad_unlock_order</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  --------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_testname</span><span class="p">(</span><span class="s">&quot;recursive read-lock&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;             |&quot;</span><span class="p">);</span>
	<span class="n">dotest</span><span class="p">(</span><span class="n">rlock_AA1</span><span class="p">,</span> <span class="n">SUCCESS</span><span class="p">,</span> <span class="n">LOCKTYPE_RWLOCK</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;             |&quot;</span><span class="p">);</span>
	<span class="n">dotest</span><span class="p">(</span><span class="n">rsem_AA1</span><span class="p">,</span> <span class="n">FAILURE</span><span class="p">,</span> <span class="n">LOCKTYPE_RWSEM</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">print_testname</span><span class="p">(</span><span class="s">&quot;recursive read-lock #2&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;             |&quot;</span><span class="p">);</span>
	<span class="n">dotest</span><span class="p">(</span><span class="n">rlock_AA1B</span><span class="p">,</span> <span class="n">SUCCESS</span><span class="p">,</span> <span class="n">LOCKTYPE_RWLOCK</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;             |&quot;</span><span class="p">);</span>
	<span class="n">dotest</span><span class="p">(</span><span class="n">rsem_AA1B</span><span class="p">,</span> <span class="n">FAILURE</span><span class="p">,</span> <span class="n">LOCKTYPE_RWSEM</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">print_testname</span><span class="p">(</span><span class="s">&quot;mixed read-write-lock&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;             |&quot;</span><span class="p">);</span>
	<span class="n">dotest</span><span class="p">(</span><span class="n">rlock_AA2</span><span class="p">,</span> <span class="n">FAILURE</span><span class="p">,</span> <span class="n">LOCKTYPE_RWLOCK</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;             |&quot;</span><span class="p">);</span>
	<span class="n">dotest</span><span class="p">(</span><span class="n">rsem_AA2</span><span class="p">,</span> <span class="n">FAILURE</span><span class="p">,</span> <span class="n">LOCKTYPE_RWSEM</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">print_testname</span><span class="p">(</span><span class="s">&quot;mixed write-read-lock&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;             |&quot;</span><span class="p">);</span>
	<span class="n">dotest</span><span class="p">(</span><span class="n">rlock_AA3</span><span class="p">,</span> <span class="n">FAILURE</span><span class="p">,</span> <span class="n">LOCKTYPE_RWLOCK</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;             |&quot;</span><span class="p">);</span>
	<span class="n">dotest</span><span class="p">(</span><span class="n">rsem_AA3</span><span class="p">,</span> <span class="n">FAILURE</span><span class="p">,</span> <span class="n">LOCKTYPE_RWSEM</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  --------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * irq-context testcases:</span>
<span class="cm">	 */</span>
	<span class="n">DO_TESTCASE_2x6</span><span class="p">(</span><span class="s">&quot;irqs-on + irq-safe-A&quot;</span><span class="p">,</span> <span class="n">irqsafe1</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_2x3</span><span class="p">(</span><span class="s">&quot;sirq-safe-A =&gt; hirqs-on&quot;</span><span class="p">,</span> <span class="n">irqsafe2A</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_2x6</span><span class="p">(</span><span class="s">&quot;safe-A + irqs-on&quot;</span><span class="p">,</span> <span class="n">irqsafe2B</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6x6</span><span class="p">(</span><span class="s">&quot;safe-A + unsafe-B #1&quot;</span><span class="p">,</span> <span class="n">irqsafe3</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6x6</span><span class="p">(</span><span class="s">&quot;safe-A + unsafe-B #2&quot;</span><span class="p">,</span> <span class="n">irqsafe4</span><span class="p">);</span>
	<span class="n">DO_TESTCASE_6x6RW</span><span class="p">(</span><span class="s">&quot;irq lock-inversion&quot;</span><span class="p">,</span> <span class="n">irq_inversion</span><span class="p">);</span>

	<span class="n">DO_TESTCASE_6x2</span><span class="p">(</span><span class="s">&quot;irq read-recursion&quot;</span><span class="p">,</span> <span class="n">irq_read_recursion</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>DO<em>TESTCASE</em>6x2B("irq read-recursion #2", irq<em>read</em>recursion2);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">unexpected_testcase_failures</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;-----------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">debug_locks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BUG: %3d unexpected failures (out of %3d) - debugging disabled! |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">unexpected_testcase_failures</span><span class="p">,</span> <span class="n">testcase_total</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;-----------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">expected_testcase_failures</span> <span class="o">&amp;&amp;</span> <span class="n">testcase_successes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;--------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%3d out of %3d testcases failed, as expected. |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">expected_testcase_failures</span><span class="p">,</span> <span class="n">testcase_total</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;----------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">debug_locks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">expected_testcase_failures</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">testcase_successes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;--------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;All %3d testcases failed, as expected. |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">expected_testcase_failures</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;----------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">debug_locks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;-------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Good, all %3d testcases passed! |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">testcase_successes</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;---------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">debug_locks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debug_locks_silent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
