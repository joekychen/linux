<!DOCTYPE html>
<html><head><title>joekychen/linux » lib › random32.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>random32.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  This is a maximally equidistributed combined Tausworthe generator</span>
<span class="cm">  based on code from GNU Scientific Library 1.5 (30 Jun 2004)</span>

<span class="cm">   x_n = (s1_n ^ s2_n ^ s3_n)</span>

<span class="cm">   s1_{n+1} = (((s1_n &amp; 4294967294) &lt;&lt;12) ^ (((s1_n &lt;&lt;13) ^ s1_n) &gt;&gt;19))</span>
<span class="cm">   s2_{n+1} = (((s2_n &amp; 4294967288) &lt;&lt; 4) ^ (((s2_n &lt;&lt; 2) ^ s2_n) &gt;&gt;25))</span>
<span class="cm">   s3_{n+1} = (((s3_n &amp; 4294967280) &lt;&lt;17) ^ (((s3_n &lt;&lt; 3) ^ s3_n) &gt;&gt;11))</span>

<span class="cm">   The period of this generator is about 2^88.</span>

<span class="cm">   From: P. L&#39;Ecuyer, &quot;Maximally Equidistributed Combined Tausworthe</span>
<span class="cm">   Generators&quot;, Mathematics of Computation, 65, 213 (1996), 203--213.</span>

<span class="cm">   This is available on the net from L&#39;Ecuyer&#39;s home page,</span>

<span class="cm">   http://www.iro.umontreal.ca/~lecuyer/myftp/papers/tausme.ps</span>
<span class="cm">   ftp://ftp.iro.umontreal.ca/pub/simulation/lecuyer/papers/tausme.ps</span>

<span class="cm">   There is an erratum in the paper &quot;Tables of Maximally</span>
<span class="cm">   Equidistributed Combined LFSR Generators&quot;, Mathematics of</span>
<span class="cm">   Computation, 68, 225 (1999), 261--269:</span>
<span class="cm">   http://www.iro.umontreal.ca/~lecuyer/myftp/papers/tausme2.ps</span>

<span class="cm">        ... the k_j most significant bits of z_j must be non-</span>
<span class="cm">        zero, for each j. (Note: this restriction also applies to the</span>
<span class="cm">        computer code given in [4], but was mistakenly not mentioned in</span>
<span class="cm">        that paper.)</span>

<span class="cm">   This affects the seeding procedure by imposing the requirement</span>
<span class="cm">   s1 &gt; 1, s2 &gt; 7, s3 &gt; 15.</span>

<span class="cm">*/</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">rnd_state</span><span class="p">,</span> <span class="n">net_rand_state</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	prandom32 - seeded pseudo-random number generator.</span>
<span class="cm"> *	@state: pointer to state structure holding seeded state.</span>
<span class="cm"> *</span>
<span class="cm"> *	This is used for pseudo-randomness with no outside seeding.</span>
<span class="cm"> *	For more random results, use random32().</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">prandom32</span><span class="p">(</span><span class="k">struct</span> <span class="n">rnd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define TAUSWORTHE(s,a,b,c,d) ((s&amp;c)&lt;&lt;d) ^ (((s &lt;&lt;a) ^ s)&gt;&gt;b)</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">s1</span> <span class="o">=</span> <span class="n">TAUSWORTHE</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">s1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">4294967294UL</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">s2</span> <span class="o">=</span> <span class="n">TAUSWORTHE</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">s2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">4294967288UL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">s3</span> <span class="o">=</span> <span class="n">TAUSWORTHE</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">s3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">4294967280UL</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">s1</span> <span class="o">^</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">s2</span> <span class="o">^</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">s3</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">prandom32</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	random32 - pseudo random number generator</span>
<span class="cm"> *</span>
<span class="cm"> *	A 32 bit pseudo-random number is generated using a fast</span>
<span class="cm"> *	algorithm suitable for simulation. This algorithm is NOT</span>
<span class="cm"> *	considered safe for cryptographic use.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">random32</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rnd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_cpu_var</span><span class="p">(</span><span class="n">net_rand_state</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">prandom32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">put_cpu_var</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">random32</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	srandom32 - add entropy to pseudo random number generator</span>
<span class="cm"> *	@seed: seed value</span>
<span class="cm"> *</span>
<span class="cm"> *	Add some additional seeding to the random32() pool.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">srandom32</span><span class="p">(</span><span class="n">u32</span> <span class="n">entropy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * No locking on the CPUs, but then somewhat random results are, well,</span>
<span class="cm">	 * expected.</span>
<span class="cm">	 */</span>
	<span class="n">for_each_possible_cpu</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rnd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">net_rand_state</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">s1</span> <span class="o">=</span> <span class="n">__seed</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">s1</span> <span class="o">^</span> <span class="n">entropy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">srandom32</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Generate some initially weak seeding values to allow</span>
<span class="cm"> *	to start the random32() engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">random32_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rnd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">net_rand_state</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>

<span class="cp">#define LCG(x)	((x) * 69069)	</span><span class="cm">/* super-duper LCG */</span><span class="cp"></span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">s1</span> <span class="o">=</span> <span class="n">__seed</span><span class="p">(</span><span class="n">LCG</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">s2</span> <span class="o">=</span> <span class="n">__seed</span><span class="p">(</span><span class="n">LCG</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">s1</span><span class="p">),</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">s3</span> <span class="o">=</span> <span class="n">__seed</span><span class="p">(</span><span class="n">LCG</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">s2</span><span class="p">),</span> <span class="mi">15</span><span class="p">);</span>

		<span class="cm">/* &quot;warm it up&quot; */</span>
		<span class="n">prandom32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">prandom32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">prandom32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">prandom32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">prandom32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">prandom32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">random32_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Generate better values after random number generator</span>
<span class="cm"> *	is fully initialized.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">random32_reseed</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rnd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">net_rand_state</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">seeds</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seeds</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">seeds</span><span class="p">));</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">s1</span> <span class="o">=</span> <span class="n">__seed</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">s2</span> <span class="o">=</span> <span class="n">__seed</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">s3</span> <span class="o">=</span> <span class="n">__seed</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">15</span><span class="p">);</span>

		<span class="cm">/* mix it in */</span>
		<span class="n">prandom32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">random32_reseed</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
