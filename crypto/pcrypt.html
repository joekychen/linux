<!DOCTYPE html>
<html><head><title>joekychen/linux » crypto › pcrypt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>pcrypt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * pcrypt - Parallel crypto wrapper.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 secunet Security Networks AG</span>
<span class="cm"> * Copyright (C) 2009 Steffen Klassert &lt;steffen.klassert@secunet.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;crypto/algapi.h&gt;</span>
<span class="cp">#include &lt;crypto/internal/aead.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;crypto/pcrypt.h&gt;</span>

<span class="k">struct</span> <span class="n">padata_pcrypt</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">padata_instance</span> <span class="o">*</span><span class="n">pinst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cpumask for callback CPUs. It should be</span>
<span class="cm">	 * equal to serial cpumask of corresponding padata instance,</span>
<span class="cm">	 * so it is updated when padata notifies us about serial</span>
<span class="cm">	 * cpumask change.</span>
<span class="cm">	 *</span>
<span class="cm">	 * cb_cpumask is protected by RCU. This fact prevents us from</span>
<span class="cm">	 * using cpumask_var_t directly because the actual type of</span>
<span class="cm">	 * cpumsak_var_t depends on kernel configuration(particularly on</span>
<span class="cm">	 * CONFIG_CPUMASK_OFFSTACK macro). Depending on the configuration</span>
<span class="cm">	 * cpumask_var_t may be either a pointer to the struct cpumask</span>
<span class="cm">	 * or a variable allocated on the stack. Thus we can not safely use</span>
<span class="cm">	 * cpumask_var_t with RCU operations such as rcu_assign_pointer or</span>
<span class="cm">	 * rcu_dereference. So cpumask_var_t is wrapped with struct</span>
<span class="cm">	 * pcrypt_cpumask which makes possible to use it with RCU.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">pcrypt_cpumask</span> <span class="p">{</span>
		<span class="n">cpumask_var_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">cb_cpumask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">nblock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">padata_pcrypt</span> <span class="n">pencrypt</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">padata_pcrypt</span> <span class="n">pdecrypt</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kset</span>           <span class="o">*</span><span class="n">pcrypt_kset</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">pcrypt_instance_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_spawn</span> <span class="n">spawn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tfm_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cb_cpu</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_do_parallel</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cb_cpu</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">padata_pcrypt</span> <span class="o">*</span><span class="n">pcrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu_index</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcrypt_cpumask</span> <span class="o">*</span><span class="n">cpumask</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="o">*</span><span class="n">cb_cpu</span><span class="p">;</span>

	<span class="n">rcu_read_lock_bh</span><span class="p">();</span>
	<span class="n">cpumask</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">cb_cpumask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">cpumask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">cpumask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cpu_index</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">%</span> <span class="n">cpumask_weight</span><span class="p">(</span><span class="n">cpumask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">cpumask_first</span><span class="p">(</span><span class="n">cpumask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cpu_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">cpumask_next</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">cpumask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>

	<span class="o">*</span><span class="n">cb_cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">rcu_read_unlock_bh</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">padata_do_parallel</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">,</span> <span class="n">padata</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_aead_setkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">crypto_aead_setkey</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_aead_setauthsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">authsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">crypto_aead_setauthsize</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">,</span> <span class="n">authsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_aead_serial</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">pcrypt_padata_request</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">pcrypt_request_ctx</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>

	<span class="n">aead_request_complete</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_aead_giv_serial</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">pcrypt_padata_request</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aead_givcrypt_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">pcrypt_request_ctx</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>

	<span class="n">aead_request_complete</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">areq</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_aead_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_async_request</span> <span class="o">*</span><span class="n">areq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">aead_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span> <span class="o">=</span> <span class="n">pcrypt_request_padata</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>

	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">;</span>

	<span class="n">padata_do_serial</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_aead_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">pcrypt_padata_request</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">pcrypt_request_ctx</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>

	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">crypto_aead_encrypt</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">padata_do_serial</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_aead_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">aead_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">creq</span> <span class="o">=</span> <span class="n">pcrypt_request_ctx</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span> <span class="o">=</span> <span class="n">pcrypt_request_padata</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">aead_request_flags</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">padata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span><span class="p">));</span>

	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">pcrypt_aead_enc</span><span class="p">;</span>
	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">pcrypt_aead_serial</span><span class="p">;</span>

	<span class="n">aead_request_set_tfm</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">);</span>
	<span class="n">aead_request_set_callback</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">,</span>
				  <span class="n">pcrypt_aead_done</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">aead_request_set_crypt</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span>
			       <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">);</span>
	<span class="n">aead_request_set_assoc</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcrypt_do_parallel</span><span class="p">(</span><span class="n">padata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cb_cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pencrypt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_aead_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">pcrypt_padata_request</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">pcrypt_request_ctx</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>

	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">crypto_aead_decrypt</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">padata_do_serial</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_aead_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">aead_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">creq</span> <span class="o">=</span> <span class="n">pcrypt_request_ctx</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span> <span class="o">=</span> <span class="n">pcrypt_request_padata</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">aead_request_flags</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">padata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span><span class="p">));</span>

	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">pcrypt_aead_dec</span><span class="p">;</span>
	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">pcrypt_aead_serial</span><span class="p">;</span>

	<span class="n">aead_request_set_tfm</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">);</span>
	<span class="n">aead_request_set_callback</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">,</span>
				  <span class="n">pcrypt_aead_done</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">aead_request_set_crypt</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span>
			       <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">);</span>
	<span class="n">aead_request_set_assoc</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcrypt_do_parallel</span><span class="p">(</span><span class="n">padata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cb_cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdecrypt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_aead_givenc</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">pcrypt_padata_request</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aead_givcrypt_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">pcrypt_request_ctx</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>

	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">crypto_aead_givencrypt</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padata</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">padata_do_serial</span><span class="p">(</span><span class="n">padata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_aead_givencrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_givcrypt_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">areq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">areq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcrypt_request</span> <span class="o">*</span><span class="n">preq</span> <span class="o">=</span> <span class="n">aead_request_ctx</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aead_givcrypt_request</span> <span class="o">*</span><span class="n">creq</span> <span class="o">=</span> <span class="n">pcrypt_request_ctx</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">padata_priv</span> <span class="o">*</span><span class="n">padata</span> <span class="o">=</span> <span class="n">pcrypt_request_padata</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">aead_givcrypt_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">aead_request_flags</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">padata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_priv</span><span class="p">));</span>

	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">pcrypt_aead_givenc</span><span class="p">;</span>
	<span class="n">padata</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">pcrypt_aead_giv_serial</span><span class="p">;</span>

	<span class="n">aead_givcrypt_set_tfm</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">);</span>
	<span class="n">aead_givcrypt_set_callback</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">,</span>
				   <span class="n">pcrypt_aead_done</span><span class="p">,</span> <span class="n">areq</span><span class="p">);</span>
	<span class="n">aead_givcrypt_set_crypt</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span>
				<span class="n">areq</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">);</span>
	<span class="n">aead_givcrypt_set_assoc</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">assoclen</span><span class="p">);</span>
	<span class="n">aead_givcrypt_set_giv</span><span class="p">(</span><span class="n">creq</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">giv</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcrypt_do_parallel</span><span class="p">(</span><span class="n">padata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cb_cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pencrypt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_aead_init_tfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">cpu_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_instance</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">crypto_tfm_alg_instance</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcrypt_instance_ctx</span> <span class="o">*</span><span class="n">ictx</span> <span class="o">=</span> <span class="n">crypto_instance_ctx</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">cipher</span><span class="p">;</span>

	<span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tfm_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">cpu_index</span> <span class="o">=</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">tfm_count</span> <span class="o">%</span> <span class="n">cpumask_weight</span><span class="p">(</span><span class="n">cpu_online_mask</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cb_cpu</span> <span class="o">=</span> <span class="n">cpumask_first</span><span class="p">(</span><span class="n">cpu_online_mask</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">cpu_index</span><span class="p">;</span> <span class="n">cpu</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cb_cpu</span> <span class="o">=</span> <span class="n">cpumask_next</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cb_cpu</span><span class="p">,</span> <span class="n">cpu_online_mask</span><span class="p">);</span>

	<span class="n">cipher</span> <span class="o">=</span> <span class="n">crypto_spawn_aead</span><span class="p">(</span><span class="n">crypto_instance_ctx</span><span class="p">(</span><span class="n">inst</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cipher</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">;</span>
	<span class="n">tfm</span><span class="o">-&gt;</span><span class="n">crt_aead</span><span class="p">.</span><span class="n">reqsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcrypt_request</span><span class="p">)</span>
		<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_givcrypt_request</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">crypto_aead_reqsize</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_aead_exit_tfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>

	<span class="n">crypto_free_aead</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">crypto_instance</span> <span class="o">*</span><span class="nf">pcrypt_alloc_instance</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_alg</span> <span class="o">*</span><span class="n">alg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_instance</span> <span class="o">*</span><span class="n">inst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcrypt_instance_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">inst</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inst</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inst</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snprintf</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_driver_name</span><span class="p">,</span> <span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">,</span>
		     <span class="s">&quot;pcrypt(%s)&quot;</span><span class="p">,</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_driver_name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_inst</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_name</span><span class="p">,</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_name</span><span class="p">,</span> <span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">);</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_instance_ctx</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">crypto_init_spawn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">spawn</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span>
				<span class="n">CRYPTO_ALG_TYPE_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_inst</span><span class="p">;</span>

	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_priority</span> <span class="o">+</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_blocksize</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_alignmask</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">inst</span><span class="p">;</span>

<span class="nl">out_free_inst:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
	<span class="n">inst</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">crypto_instance</span> <span class="o">*</span><span class="nf">pcrypt_alloc_aead</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_instance</span> <span class="o">*</span><span class="n">inst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_alg</span> <span class="o">*</span><span class="n">alg</span><span class="p">;</span>

	<span class="n">alg</span> <span class="o">=</span> <span class="n">crypto_get_attr_alg</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CRYPTO_ALG_TYPE_MASK</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">alg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span>

	<span class="n">inst</span> <span class="o">=</span> <span class="n">pcrypt_alloc_instance</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put_alg</span><span class="p">;</span>

	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span> <span class="o">|</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_aead_type</span><span class="p">;</span>

	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">ivsize</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">geniv</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">maxauthsize</span><span class="p">;</span>

	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcrypt_aead_ctx</span><span class="p">);</span>

	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">pcrypt_aead_init_tfm</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_exit</span> <span class="o">=</span> <span class="n">pcrypt_aead_exit_tfm</span><span class="p">;</span>

	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">pcrypt_aead_setkey</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">pcrypt_aead_setauthsize</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">pcrypt_aead_encrypt</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">pcrypt_aead_decrypt</span><span class="p">;</span>
	<span class="n">inst</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_aead</span><span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">pcrypt_aead_givencrypt</span><span class="p">;</span>

<span class="nl">out_put_alg:</span>
	<span class="n">crypto_mod_put</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">crypto_instance</span> <span class="o">*</span><span class="nf">pcrypt_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtattr</span> <span class="o">**</span><span class="n">tb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_attr_type</span> <span class="o">*</span><span class="n">algt</span><span class="p">;</span>

	<span class="n">algt</span> <span class="o">=</span> <span class="n">crypto_get_attr_type</span><span class="p">(</span><span class="n">tb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">algt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">algt</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">algt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">algt</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CRYPTO_ALG_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span>:
		<span class="k">return</span> <span class="n">pcrypt_alloc_aead</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">algt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">algt</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_instance</span> <span class="o">*</span><span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcrypt_instance_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_instance_ctx</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

	<span class="n">crypto_drop_spawn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">spawn</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_cpumask_change_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">padata_pcrypt</span> <span class="o">*</span><span class="n">pcrypt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcrypt_cpumask</span> <span class="o">*</span><span class="n">new_mask</span><span class="p">,</span> <span class="o">*</span><span class="n">old_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">padata_cpumask</span> <span class="o">*</span><span class="n">cpumask</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">padata_cpumask</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PADATA_CPU_SERIAL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pcrypt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="k">struct</span> <span class="n">padata_pcrypt</span><span class="p">,</span> <span class="n">nblock</span><span class="p">);</span>
	<span class="n">new_mask</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_mask</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_mask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">new_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_mask</span> <span class="o">=</span> <span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">cb_cpumask</span><span class="p">;</span>

	<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">new_mask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">cpumask</span><span class="o">-&gt;</span><span class="n">cbcpu</span><span class="p">);</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">cb_cpumask</span><span class="p">,</span> <span class="n">new_mask</span><span class="p">);</span>
	<span class="n">synchronize_rcu_bh</span><span class="p">();</span>

	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">old_mask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">old_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_sysfs_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_instance</span> <span class="o">*</span><span class="n">pinst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pinst</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">kset</span> <span class="o">=</span> <span class="n">pcrypt_kset</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">kobject_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pinst</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pinst</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcrypt_init_padata</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_pcrypt</span> <span class="o">*</span><span class="n">pcrypt</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcrypt_cpumask</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>

	<span class="n">get_online_cpus</span><span class="p">();</span>

	<span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
				     <span class="n">WQ_MEM_RECLAIM</span> <span class="o">|</span> <span class="n">WQ_CPU_INTENSIVE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span> <span class="o">=</span> <span class="n">padata_alloc_possible</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_destroy_workqueue</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_padata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_padata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpumask_and</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">cpu_possible_mask</span><span class="p">,</span> <span class="n">cpu_online_mask</span><span class="p">);</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">cb_cpumask</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">nblock</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">pcrypt_cpumask_change_notify</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">padata_register_cpumask_notifier</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">nblock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_cpumask</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcrypt_sysfs_add</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unregister_notifier</span><span class="p">;</span>

	<span class="n">put_online_cpus</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_unregister_notifier:</span>
	<span class="n">padata_unregister_cpumask_notifier</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">nblock</span><span class="p">);</span>
<span class="nl">err_free_cpumask:</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
<span class="nl">err_free_padata:</span>
	<span class="n">padata_free</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">);</span>
<span class="nl">err_destroy_workqueue:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">put_online_cpus</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcrypt_fini_padata</span><span class="p">(</span><span class="k">struct</span> <span class="n">padata_pcrypt</span> <span class="o">*</span><span class="n">pcrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">cb_cpumask</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">cb_cpumask</span><span class="p">);</span>

	<span class="n">padata_stop</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">);</span>
	<span class="n">padata_unregister_cpumask_notifier</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">nblock</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">padata_free</span><span class="p">(</span><span class="n">pcrypt</span><span class="o">-&gt;</span><span class="n">pinst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">crypto_template</span> <span class="n">pcrypt_tmpl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pcrypt&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">pcrypt_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">pcrypt_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pcrypt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pcrypt_kset</span> <span class="o">=</span> <span class="n">kset_create_and_add</span><span class="p">(</span><span class="s">&quot;pcrypt&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">kernel_kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcrypt_kset</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcrypt_init_padata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pencrypt</span><span class="p">,</span> <span class="s">&quot;pencrypt&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unreg_kset</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcrypt_init_padata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdecrypt</span><span class="p">,</span> <span class="s">&quot;pdecrypt&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_deinit_pencrypt</span><span class="p">;</span>

	<span class="n">padata_start</span><span class="p">(</span><span class="n">pencrypt</span><span class="p">.</span><span class="n">pinst</span><span class="p">);</span>
	<span class="n">padata_start</span><span class="p">(</span><span class="n">pdecrypt</span><span class="p">.</span><span class="n">pinst</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">crypto_register_template</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcrypt_tmpl</span><span class="p">);</span>

<span class="nl">err_deinit_pencrypt:</span>
	<span class="n">pcrypt_fini_padata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pencrypt</span><span class="p">);</span>
<span class="nl">err_unreg_kset:</span>
	<span class="n">kset_unregister</span><span class="p">(</span><span class="n">pcrypt_kset</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pcrypt_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcrypt_fini_padata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pencrypt</span><span class="p">);</span>
	<span class="n">pcrypt_fini_padata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdecrypt</span><span class="p">);</span>

	<span class="n">kset_unregister</span><span class="p">(</span><span class="n">pcrypt_kset</span><span class="p">);</span>
	<span class="n">crypto_unregister_template</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcrypt_tmpl</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pcrypt_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pcrypt_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Steffen Klassert &lt;steffen.klassert@secunet.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Parallel crypto wrapper&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
