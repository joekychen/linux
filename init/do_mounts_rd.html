<!DOCTYPE html>
<html><head><title>joekychen/linux » init › do_mounts_rd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>do_mounts_rd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Many of the syscalls used in this file expect some of the arguments</span>
<span class="cm"> * to be __user pointers not __kernel pointers.  To limit the sparse</span>
<span class="cm"> * noise, turn off sparse checking for this file.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef __CHECKER__</span>
<span class="cp">#undef __CHECKER__</span>
<span class="cp">#warning &quot;Sparse checking disabled for this file&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/minix_fs.h&gt;</span>
<span class="cp">#include &lt;linux/ext2_fs.h&gt;</span>
<span class="cp">#include &lt;linux/romfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/cramfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/initrd.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;do_mounts.h&quot;</span>
<span class="cp">#include &quot;../fs/squashfs/squashfs_fs.h&quot;</span>

<span class="cp">#include &lt;linux/decompress/generic.h&gt;</span>


<span class="kt">int</span> <span class="n">__initdata</span> <span class="n">rd_prompt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="cm">/* 1 = prompt for RAM disk, 0 = don&#39;t prompt */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">prompt_ramdisk</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rd_prompt</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;prompt_ramdisk=&quot;</span><span class="p">,</span> <span class="n">prompt_ramdisk</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__initdata</span> <span class="n">rd_image_start</span><span class="p">;</span>		<span class="cm">/* starting block # of image */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ramdisk_start_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rd_image_start</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ramdisk_start=&quot;</span><span class="p">,</span> <span class="n">ramdisk_start_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">crd_load</span><span class="p">(</span><span class="kt">int</span> <span class="n">in_fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out_fd</span><span class="p">,</span> <span class="n">decompress_fn</span> <span class="n">deco</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This routine tries to find a RAM disk image to load, and returns the</span>
<span class="cm"> * number of blocks to read for a non-compressed image, 0 if the image</span>
<span class="cm"> * is a compressed image, and -1 if an image with the right magic</span>
<span class="cm"> * numbers could not be found.</span>
<span class="cm"> *</span>
<span class="cm"> * We currently check for the following magic numbers:</span>
<span class="cm"> *	minix</span>
<span class="cm"> *	ext2</span>
<span class="cm"> *	romfs</span>
<span class="cm"> *	cramfs</span>
<span class="cm"> *	squashfs</span>
<span class="cm"> *	gzip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">identify_ramdisk_image</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_block</span><span class="p">,</span> <span class="n">decompress_fn</span> <span class="o">*</span><span class="n">decompressor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">minix_super_block</span> <span class="o">*</span><span class="n">minixsb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">romfs_super_block</span> <span class="o">*</span><span class="n">romfsb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cramfs_super</span> <span class="o">*</span><span class="n">cramfsb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">squashfs_super_block</span> <span class="o">*</span><span class="n">squashfsb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nblocks</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">compress_name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">minixsb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">minix_super_block</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">romfsb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">romfs_super_block</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">cramfsb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cramfs_super</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">squashfsb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">squashfs_super_block</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read block 0 to test for compressed kernel</span>
<span class="cm">	 */</span>
	<span class="n">sys_lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">start_block</span> <span class="o">*</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="o">*</span><span class="n">decompressor</span> <span class="o">=</span> <span class="n">decompress_method</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compress_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compress_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;RAMDISK: %s image found at block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">compress_name</span><span class="p">,</span> <span class="n">start_block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">decompressor</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span>
			       <span class="s">&quot;RAMDISK: %s decompressor not configured!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">compress_name</span><span class="p">);</span>
		<span class="n">nblocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* romfs is at block zero too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">romfsb</span><span class="o">-&gt;</span><span class="n">word0</span> <span class="o">==</span> <span class="n">ROMSB_WORD0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">romfsb</span><span class="o">-&gt;</span><span class="n">word1</span> <span class="o">==</span> <span class="n">ROMSB_WORD1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;RAMDISK: romfs filesystem found at block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">start_block</span><span class="p">);</span>
		<span class="n">nblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">romfsb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">BLOCK_SIZE_BITS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cramfsb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">CRAMFS_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;RAMDISK: cramfs filesystem found at block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">start_block</span><span class="p">);</span>
		<span class="n">nblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">cramfsb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">BLOCK_SIZE_BITS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* squashfs is at block zero too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">squashfsb</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">SQUASHFS_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;RAMDISK: squashfs filesystem found at block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">start_block</span><span class="p">);</span>
		<span class="n">nblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">squashfsb</span><span class="o">-&gt;</span><span class="n">bytes_used</span><span class="p">)</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			 <span class="o">&gt;&gt;</span> <span class="n">BLOCK_SIZE_BITS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read 512 bytes further to check if cramfs is padded</span>
<span class="cm">	 */</span>
	<span class="n">sys_lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">start_block</span> <span class="o">*</span> <span class="n">BLOCK_SIZE</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cramfsb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">CRAMFS_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;RAMDISK: cramfs filesystem found at block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">start_block</span><span class="p">);</span>
		<span class="n">nblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">cramfsb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">BLOCK_SIZE_BITS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read block 1 to test for minix and ext2 superblock</span>
<span class="cm">	 */</span>
	<span class="n">sys_lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="n">start_block</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Try minix */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minixsb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">==</span> <span class="n">MINIX_SUPER_MAGIC</span> <span class="o">||</span>
	    <span class="n">minixsb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">==</span> <span class="n">MINIX_SUPER_MAGIC2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;RAMDISK: Minix filesystem found at block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">start_block</span><span class="p">);</span>
		<span class="n">nblocks</span> <span class="o">=</span> <span class="n">minixsb</span><span class="o">-&gt;</span><span class="n">s_nzones</span> <span class="o">&lt;&lt;</span> <span class="n">minixsb</span><span class="o">-&gt;</span><span class="n">s_log_zone_size</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try ext2 */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">ext2_image_size</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;RAMDISK: ext2 filesystem found at block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">start_block</span><span class="p">);</span>
		<span class="n">nblocks</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
	       <span class="s">&quot;RAMDISK: Couldn&#39;t find valid RAM disk image starting at %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">start_block</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">sys_lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">start_block</span> <span class="o">*</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nblocks</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">rd_load_image</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_fd</span><span class="p">,</span> <span class="n">out_fd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rd_blocks</span><span class="p">,</span> <span class="n">devblocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">disk</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rotate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">decompress_fn</span> <span class="n">decompressor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#if !defined(CONFIG_S390)</span>
	<span class="kt">char</span> <span class="n">rotator</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">&#39;|&#39;</span> <span class="p">,</span> <span class="sc">&#39;/&#39;</span> <span class="p">,</span> <span class="sc">&#39;-&#39;</span> <span class="p">,</span> <span class="sc">&#39;\\&#39;</span> <span class="p">};</span>
<span class="cp">#endif</span>

	<span class="n">out_fd</span> <span class="o">=</span> <span class="n">sys_open</span><span class="p">(</span><span class="s">&quot;/dev/ram&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">in_fd</span> <span class="o">=</span> <span class="n">sys_open</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">noclose_input</span><span class="p">;</span>

	<span class="n">nblocks</span> <span class="o">=</span> <span class="n">identify_ramdisk_image</span><span class="p">(</span><span class="n">in_fd</span><span class="p">,</span> <span class="n">rd_image_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">decompressor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crd_load</span><span class="p">(</span><span class="n">in_fd</span><span class="p">,</span> <span class="n">out_fd</span><span class="p">,</span> <span class="n">decompressor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">successful_load</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE NOTE: nblocks is not actually blocks but</span>
<span class="cm">	 * the number of kibibytes of data to load into a ramdisk.</span>
<span class="cm">	 * So any ramdisk block size that is a multiple of 1KiB should</span>
<span class="cm">	 * work when the appropriate ramdisk_blocksize is specified</span>
<span class="cm">	 * on the command line.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The default ramdisk_blocksize is 1KiB and it is generally</span>
<span class="cm">	 * silly to use anything else, so make sure to use 1KiB</span>
<span class="cm">	 * blocksize while generating ext2fs ramdisk-images.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sys_ioctl</span><span class="p">(</span><span class="n">out_fd</span><span class="p">,</span> <span class="n">BLKGETSIZE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rd_blocks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rd_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rd_blocks</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">&gt;</span> <span class="n">rd_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RAMDISK: image too big! (%dKiB/%ldKiB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">nblocks</span><span class="p">,</span> <span class="n">rd_blocks</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK, time to copy in the data</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sys_ioctl</span><span class="p">(</span><span class="n">in_fd</span><span class="p">,</span> <span class="n">BLKGETSIZE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">devblocks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">devblocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">devblocks</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="s">&quot;/initrd.image&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">devblocks</span> <span class="o">=</span> <span class="n">nblocks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devblocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RAMDISK: could not determine device size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RAMDISK: could not allocate buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;RAMDISK: Loading %dKiB [%ld disk%s] into ram disk... &quot;</span><span class="p">,</span>
		<span class="n">nblocks</span><span class="p">,</span> <span class="p">((</span><span class="n">nblocks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">devblocks</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span><span class="o">&gt;</span><span class="n">devblocks</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">disk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nblocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">devblocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;done disk #%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">disk</span><span class="o">++</span><span class="p">);</span>
			<span class="n">rotate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sys_close</span><span class="p">(</span><span class="n">in_fd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error closing the disk.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">noclose_input</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">change_floppy</span><span class="p">(</span><span class="s">&quot;disk #%d&quot;</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
			<span class="n">in_fd</span> <span class="o">=</span> <span class="n">sys_open</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error opening disk.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">noclose_input</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Loading disk #%d... &quot;</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sys_read</span><span class="p">(</span><span class="n">in_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">sys_write</span><span class="p">(</span><span class="n">out_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BLOCK_SIZE</span><span class="p">);</span>
<span class="cp">#if !defined(CONFIG_S390)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c</span><span class="se">\b</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rotator</span><span class="p">[</span><span class="n">rotate</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">]);</span>
			<span class="n">rotate</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">successful_load:</span>
	<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">sys_close</span><span class="p">(</span><span class="n">in_fd</span><span class="p">);</span>
<span class="nl">noclose_input:</span>
	<span class="n">sys_close</span><span class="p">(</span><span class="n">out_fd</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">sys_unlink</span><span class="p">(</span><span class="s">&quot;/dev/ram&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">rd_load_disk</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rd_prompt</span><span class="p">)</span>
		<span class="n">change_floppy</span><span class="p">(</span><span class="s">&quot;root floppy disk to be loaded into RAM disk&quot;</span><span class="p">);</span>
	<span class="n">create_dev</span><span class="p">(</span><span class="s">&quot;/dev/root&quot;</span><span class="p">,</span> <span class="n">ROOT_DEV</span><span class="p">);</span>
	<span class="n">create_dev</span><span class="p">(</span><span class="s">&quot;/dev/ram&quot;</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">RAMDISK_MAJOR</span><span class="p">,</span> <span class="n">n</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rd_load_image</span><span class="p">(</span><span class="s">&quot;/dev/root&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">exit_code</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">decompress_error</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">crd_infd</span><span class="p">,</span> <span class="n">crd_outfd</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">compr_fill</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sys_read</span><span class="p">(</span><span class="n">crd_infd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RAMDISK: error while reading compressed data&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RAMDISK: EOF while reading compressed data&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">compr_flush</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">window</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">outcnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">written</span> <span class="o">=</span> <span class="n">sys_write</span><span class="p">(</span><span class="n">crd_outfd</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">outcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">!=</span> <span class="n">outcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">decompress_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;RAMDISK: incomplete write (%d != %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">written</span><span class="p">,</span> <span class="n">outcnt</span><span class="p">);</span>
		<span class="n">decompress_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">outcnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">decompress_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">crd_load</span><span class="p">(</span><span class="kt">int</span> <span class="n">in_fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out_fd</span><span class="p">,</span> <span class="n">decompress_fn</span> <span class="n">deco</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">crd_infd</span> <span class="o">=</span> <span class="n">in_fd</span><span class="p">;</span>
	<span class="n">crd_outfd</span> <span class="o">=</span> <span class="n">out_fd</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">deco</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">compr_fill</span><span class="p">,</span> <span class="n">compr_flush</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decompress_error</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
