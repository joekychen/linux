<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › xtensa › kernel › traps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/xtensa/kernel/traps.c</span>
<span class="cm"> *</span>
<span class="cm"> * Exception handling.</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from code with the following copyrights:</span>
<span class="cm"> * Copyright (C) 1994 - 1999 by Ralf Baechle</span>
<span class="cm"> * Modified for R3000 by Paul M. Antoine, 1995, 1996</span>
<span class="cm"> * Complete output from die() by Ulf Carlsson, 1998</span>
<span class="cm"> * Copyright (C) 1999 Silicon Graphics, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Essentially rewritten for the Xtensa architecture port.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001 - 2005 Tensilica Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Joe Taylor	&lt;joe@tensilica.com, joetylr@yahoo.com&gt;</span>
<span class="cm"> * Chris Zankel	&lt;chris@zankel.net&gt;</span>
<span class="cm"> * Marc Gauthier&lt;marc@tensilica.com, marc@alumni.uwaterloo.ca&gt;</span>
<span class="cm"> * Kevin Chea</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/stringify.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/timex.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>

<span class="cp">#ifdef CONFIG_KGDB</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gdb_enter</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">return_from_debug_flag</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Machine specific interrupt handlers</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">kernel_exception</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">user_exception</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">fast_syscall_kernel</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">fast_syscall_user</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">fast_alloca</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">fast_unaligned</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">fast_second_level_miss</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">fast_store_prohibited</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">fast_coprocessor</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">do_illegal_instruction</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">do_interrupt</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">do_unaligned_user</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">do_multihit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">do_page_fault</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">do_debug</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">system_call</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The vector table must be preceded by a save area (which</span>
<span class="cm"> * implies it must be in RAM, unless one places RAM immediately</span>
<span class="cm"> * before a ROM and puts the vector at the start of the ROM (!))</span>
<span class="cm"> */</span>

<span class="cp">#define KRNL		0x01</span>
<span class="cp">#define USER		0x02</span>

<span class="cp">#define COPROCESSOR(x)							\</span>
<span class="cp">{ EXCCAUSE_COPROCESSOR ## x ## _DISABLED, USER, fast_coprocessor }</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cause</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fast</span><span class="p">;</span>
	<span class="kt">void</span><span class="o">*</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dispatch_init_table_t</span><span class="p">;</span>

<span class="k">static</span> <span class="n">dispatch_init_table_t</span> <span class="n">__initdata</span> <span class="n">dispatch_init_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

<span class="p">{</span> <span class="n">EXCCAUSE_ILLEGAL_INSTRUCTION</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_illegal_instruction</span><span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_SYSTEM_CALL</span><span class="p">,</span>		<span class="n">KRNL</span><span class="p">,</span>	   <span class="n">fast_syscall_kernel</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_SYSTEM_CALL</span><span class="p">,</span>		<span class="n">USER</span><span class="p">,</span>	   <span class="n">fast_syscall_user</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_SYSTEM_CALL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>	   <span class="n">system_call</span> <span class="p">},</span>
<span class="cm">/* EXCCAUSE_INSTRUCTION_FETCH unhandled */</span>
<span class="cm">/* EXCCAUSE_LOAD_STORE_ERROR unhandled*/</span>
<span class="p">{</span> <span class="n">EXCCAUSE_LEVEL1_INTERRUPT</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_interrupt</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_ALLOCA</span><span class="p">,</span>		<span class="n">USER</span><span class="o">|</span><span class="n">KRNL</span><span class="p">,</span> <span class="n">fast_alloca</span> <span class="p">},</span>
<span class="cm">/* EXCCAUSE_INTEGER_DIVIDE_BY_ZERO unhandled */</span>
<span class="cm">/* EXCCAUSE_PRIVILEGED unhandled */</span>
<span class="cp">#if XCHAL_UNALIGNED_LOAD_EXCEPTION || XCHAL_UNALIGNED_STORE_EXCEPTION</span>
<span class="cp">#ifdef CONFIG_UNALIGNED_USER</span>
<span class="p">{</span> <span class="n">EXCCAUSE_UNALIGNED</span><span class="p">,</span>		<span class="n">USER</span><span class="p">,</span>	   <span class="n">fast_unaligned</span> <span class="p">},</span>
<span class="cp">#else</span>
<span class="p">{</span> <span class="n">EXCCAUSE_UNALIGNED</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_unaligned_user</span> <span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">{</span> <span class="n">EXCCAUSE_UNALIGNED</span><span class="p">,</span>		<span class="n">KRNL</span><span class="p">,</span>	   <span class="n">fast_unaligned</span> <span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MMU</span>
<span class="p">{</span> <span class="n">EXCCAUSE_ITLB_MISS</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_page_fault</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_ITLB_MISS</span><span class="p">,</span>		<span class="n">USER</span><span class="o">|</span><span class="n">KRNL</span><span class="p">,</span> <span class="n">fast_second_level_miss</span><span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_ITLB_MULTIHIT</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_multihit</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_ITLB_PRIVILEGE</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_page_fault</span> <span class="p">},</span>
<span class="cm">/* EXCCAUSE_SIZE_RESTRICTION unhandled */</span>
<span class="p">{</span> <span class="n">EXCCAUSE_FETCH_CACHE_ATTRIBUTE</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_page_fault</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_DTLB_MISS</span><span class="p">,</span>		<span class="n">USER</span><span class="o">|</span><span class="n">KRNL</span><span class="p">,</span> <span class="n">fast_second_level_miss</span><span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_DTLB_MISS</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_page_fault</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_DTLB_MULTIHIT</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_multihit</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_DTLB_PRIVILEGE</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_page_fault</span> <span class="p">},</span>
<span class="cm">/* EXCCAUSE_DTLB_SIZE_RESTRICTION unhandled */</span>
<span class="p">{</span> <span class="n">EXCCAUSE_STORE_CACHE_ATTRIBUTE</span><span class="p">,</span>	<span class="n">USER</span><span class="o">|</span><span class="n">KRNL</span><span class="p">,</span> <span class="n">fast_store_prohibited</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_STORE_CACHE_ATTRIBUTE</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_page_fault</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">EXCCAUSE_LOAD_CACHE_ATTRIBUTE</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	   <span class="n">do_page_fault</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MMU */</span><span class="cp"></span>
<span class="cm">/* XCCHAL_EXCCAUSE_FLOATING_POINT unhandled */</span>
<span class="cp">#if XTENSA_HAVE_COPROCESSOR(0)</span>
<span class="n">COPROCESSOR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#if XTENSA_HAVE_COPROCESSOR(1)</span>
<span class="n">COPROCESSOR</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#if XTENSA_HAVE_COPROCESSOR(2)</span>
<span class="n">COPROCESSOR</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#if XTENSA_HAVE_COPROCESSOR(3)</span>
<span class="n">COPROCESSOR</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#if XTENSA_HAVE_COPROCESSOR(4)</span>
<span class="n">COPROCESSOR</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#if XTENSA_HAVE_COPROCESSOR(5)</span>
<span class="n">COPROCESSOR</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#if XTENSA_HAVE_COPROCESSOR(6)</span>
<span class="n">COPROCESSOR</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#if XTENSA_HAVE_COPROCESSOR(7)</span>
<span class="n">COPROCESSOR</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="p">{</span> <span class="n">EXCCAUSE_MAPPED_DEBUG</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>		<span class="n">do_debug</span> <span class="p">},</span>
<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>

<span class="p">};</span>

<span class="cm">/* The exception table &lt;exc_table&gt; serves two functions:</span>
<span class="cm"> * 1. it contains three dispatch tables (fast_user, fast_kernel, default-c)</span>
<span class="cm"> * 2. it is a temporary memory buffer for the exception handlers.</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">exc_table</span><span class="p">[</span><span class="n">EXC_TABLE_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">];</span>

<span class="kt">void</span> <span class="n">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span><span class="o">*</span><span class="p">,</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">__die_if_kernel</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">die</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unhandled Exceptions. Kill user task or panic if in kernel space.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">do_unhandled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">exccause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__die_if_kernel</span><span class="p">(</span><span class="s">&quot;Caught unhandled exception - should not happen&quot;</span><span class="p">,</span>
	    		<span class="n">regs</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>

	<span class="cm">/* If in user mode, send SIGILL signal to current process */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Caught unhandled exception in &#39;%s&#39; &quot;</span>
	       <span class="s">&quot;(pid = %d, pc = %#010lx) - should not happen</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;</span><span class="se">\t</span><span class="s">EXCCAUSE is %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">exccause</span><span class="p">);</span>
	<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multi-hit exception. This if fatal!</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">do_multihit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">exccause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;Caught multihit exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Level-1 interrupt.</span>
<span class="cm"> * We currently have no priority encoding.</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ignored_level1_interrupts</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">do_IRQ</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">do_interrupt</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intread</span> <span class="o">=</span> <span class="n">get_sr</span> <span class="p">(</span><span class="n">INTREAD</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">intenable</span> <span class="o">=</span> <span class="n">get_sr</span> <span class="p">(</span><span class="n">INTENABLE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* Handle all interrupts (no priorities).</span>
<span class="cm">	 * (Clear the interrupt before processing, in case it&#39;s</span>
<span class="cm">	 *  edge-triggered or software-generated)</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XCHAL_NUM_INTERRUPTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">intread</span> <span class="o">&amp;</span> <span class="n">intenable</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_sr</span> <span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">INTCLEAR</span><span class="p">);</span>
			<span class="n">do_IRQ</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">regs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Illegal instruction. Fatal if in kernel space.</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">do_illegal_instruction</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__die_if_kernel</span><span class="p">(</span><span class="s">&quot;Illegal instruction in kernel&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>

	<span class="cm">/* If in user mode, send SIGILL signal to current process. */</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Illegal Instruction in &#39;%s&#39; (pid = %d, pc = %#010lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Handle unaligned memory accesses from user space. Kill task.</span>
<span class="cm"> *</span>
<span class="cm"> * If CONFIG_UNALIGNED_USER is not set, we don&#39;t allow unaligned memory</span>
<span class="cm"> * accesses causes from user space.</span>
<span class="cm"> */</span>

<span class="cp">#if XCHAL_UNALIGNED_LOAD_EXCEPTION || XCHAL_UNALIGNED_STORE_EXCEPTION</span>
<span class="cp">#ifndef CONFIG_UNALIGNED_USER</span>
<span class="kt">void</span>
<span class="nf">do_unaligned_user</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">__die_if_kernel</span><span class="p">(</span><span class="s">&quot;Unhandled unaligned exception in kernel&quot;</span><span class="p">,</span>
	    		<span class="n">regs</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">bad_vaddr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">excvaddr</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unaligned memory access to %08lx in &#39;%s&#39; &quot;</span>
	       <span class="s">&quot;(pid = %d, pc = %#010lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">excvaddr</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">excvaddr</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="kt">void</span>
<span class="nf">do_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_KGDB</span>
	<span class="cm">/* If remote debugging is configured AND enabled, we give control to</span>
<span class="cm">	 * kgdb.  Otherwise, we fall through, perhaps giving control to the</span>
<span class="cm">	 * native debugger.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gdb_enter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">extern</span> <span class="kt">void</span> <span class="n">gdb_handle_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
		<span class="n">gdb_handle_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">return_from_debug_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">__die_if_kernel</span><span class="p">(</span><span class="s">&quot;Breakpoint in kernel&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>

	<span class="cm">/* If in user mode, send SIGTRAP signal to current process */</span>

	<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Initialize dispatch tables.</span>
<span class="cm"> *</span>
<span class="cm"> * The exception vectors are stored compressed the __init section in the</span>
<span class="cm"> * dispatch_init_table. This function initializes the following three tables</span>
<span class="cm"> * from that compressed table:</span>
<span class="cm"> * - fast user		first dispatch table for user exceptions</span>
<span class="cm"> * - fast kernel	first dispatch table for kernel exceptions</span>
<span class="cm"> * - default C-handler	C-handler called by the default fast handler.</span>
<span class="cm"> *</span>
<span class="cm"> * See vectors.S for more details.</span>
<span class="cm"> */</span>

<span class="cp">#define set_handler(idx,handler) (exc_table[idx] = (unsigned long) (handler))</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Setup default vectors. */</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_handler</span><span class="p">(</span><span class="n">EXC_TABLE_FAST_USER</span><span class="o">/</span><span class="mi">4</span>   <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">user_exception</span><span class="p">);</span>
		<span class="n">set_handler</span><span class="p">(</span><span class="n">EXC_TABLE_FAST_KERNEL</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">kernel_exception</span><span class="p">);</span>
		<span class="n">set_handler</span><span class="p">(</span><span class="n">EXC_TABLE_DEFAULT</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">do_unhandled</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup specific handlers. */</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dispatch_init_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cause</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">fast</span> <span class="o">=</span> <span class="n">dispatch_init_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fast</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">dispatch_init_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cause</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">handler</span> <span class="o">=</span> <span class="n">dispatch_init_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fast</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">set_handler</span> <span class="p">(</span><span class="n">EXC_TABLE_DEFAULT</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="n">cause</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fast</span> <span class="o">&amp;&amp;</span> <span class="n">fast</span> <span class="o">&amp;</span> <span class="n">USER</span><span class="p">)</span>
			<span class="n">set_handler</span> <span class="p">(</span><span class="n">EXC_TABLE_FAST_USER</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="n">cause</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fast</span> <span class="o">&amp;&amp;</span> <span class="n">fast</span> <span class="o">&amp;</span> <span class="n">KRNL</span><span class="p">)</span>
			<span class="n">set_handler</span> <span class="p">(</span><span class="n">EXC_TABLE_FAST_KERNEL</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="n">cause</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize EXCSAVE_1 to hold the address of the exception table. */</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">exc_table</span><span class="p">;</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;wsr  %0, &quot;</span><span class="n">__stringify</span><span class="p">(</span><span class="n">EXCSAVE_1</span><span class="p">)</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function dumps the current valid window frame and other base registers.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">wmask</span><span class="p">;</span>

	<span class="n">wmask</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">wmask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;a%02d:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %08lx&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">areg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pc: %08lx, ps: %08lx, depc: %08lx, excvaddr: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">depc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">excvaddr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;lbeg: %08lx, lend: %08lx lcount: %08lx, sar: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lbeg</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lend</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lcount</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wb: %08lx, ws: %08lx, wmask: %08lx, syscall: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">windowbase</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">windowstart</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">wmask</span><span class="p">,</span>
		       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">syscall</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="nf">stack_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span> <span class="o">||</span> <span class="n">task</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;mov %0, a1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;=a&quot;</span><span class="p">(</span><span class="n">sp</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">sp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">spill_registers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a0</span><span class="p">,</span> <span class="n">ps</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;movi	a14,&quot;</span> <span class="n">__stringify</span> <span class="p">(</span><span class="n">PS_EXCM_BIT</span><span class="p">)</span> <span class="s">&quot; | 1</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov	a12, a0</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;rsr	a13,&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">SAR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;xsr	a14,&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">PS</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movi	a0, _spill_registers</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;rsync</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;callx0 a0</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov	a0, a12</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;wsr	a13,&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">SAR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;wsr	a14,&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">PS</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="o">::</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">a0</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ps</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;a2&quot;</span><span class="p">,</span> <span class="s">&quot;a3&quot;</span><span class="p">,</span> <span class="s">&quot;a4&quot;</span><span class="p">,</span> <span class="s">&quot;a7&quot;</span><span class="p">,</span> <span class="s">&quot;a11&quot;</span><span class="p">,</span> <span class="s">&quot;a12&quot;</span><span class="p">,</span> <span class="s">&quot;a13&quot;</span><span class="p">,</span> <span class="s">&quot;a14&quot;</span><span class="p">,</span> <span class="s">&quot;a15&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">pc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp_start</span><span class="p">,</span> <span class="n">sp_end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">a1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">a1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">stack_pointer</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="n">sp_start</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">THREAD_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">sp_end</span> <span class="o">=</span> <span class="n">sp_start</span> <span class="o">+</span> <span class="n">THREAD_SIZE</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Call Trace:&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_KALLSYMS</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spill_registers</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&gt;</span> <span class="n">sp_start</span> <span class="o">&amp;&amp;</span> <span class="n">a1</span> <span class="o">&lt;</span> <span class="n">sp_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">a1</span><span class="p">;</span>

		<span class="n">a0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">sp</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">a1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">sp</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pc</span> <span class="o">=</span> <span class="n">MAKE_PC_FROM_RA</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_text_address</span><span class="p">(</span><span class="n">pc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; [&lt;%08lx&gt;] &quot;</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
			<span class="n">print_symbol</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine abuses get_user()/put_user() to reference pointers</span>
<span class="cm"> * with at least a bit of error checking ...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">kstack_depth_to_print</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">stack_pointer</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
 	<span class="n">stack</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Stack: &quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kstack_depth_to_print</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kstack_end</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">       &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%08lx &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">sp</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">show_trace</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">stack</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dump_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_stack</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dump_stack</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">show_code</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Code:&quot;</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">insn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">pc</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (Bad address in pc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c%08lx%c&quot;</span><span class="p">,(</span><span class="n">i</span><span class="o">?</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="sc">&#39;&lt;&#39;</span><span class="p">),</span><span class="n">insn</span><span class="p">,(</span><span class="n">i</span><span class="o">?</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="sc">&#39;&gt;&#39;</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">die_lock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">die_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">console_verbose</span><span class="p">();</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die_lock</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: sig: %ld [#%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">++</span><span class="n">die_counter</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PREEMPT</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PREEMPT &quot;</span><span class="p">);</span>
	<span class="n">nl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nl</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">show_stack</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">areg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_DIE</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Fatal exception in interrupt&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">panic_on_oops</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Fatal exception&quot;</span><span class="p">);</span>

	<span class="n">do_exit</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
