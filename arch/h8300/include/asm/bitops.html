<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › h8300 › include › asm › bitops.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>bitops.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _H8300_BITOPS_H</span>
<span class="cp">#define _H8300_BITOPS_H</span>

<span class="cm">/*</span>
<span class="cm"> * Copyright 1992, Linus Torvalds.</span>
<span class="cm"> * Copyright 2002, Yoshinori Sato</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>

<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#ifndef _LINUX_BITOPS_H</span>
<span class="cp">#error only &lt;linux/bitops.h&gt; can be included directly</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Function prototypes to keep gcc -Wall happy</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ffz = Find First Zero in word. Undefined if no zero exists,</span>
<span class="cm"> * so code should check against ~0UL first..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ffz</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;1:</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;shlr.l %2</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;adds #1,%0</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;bcs 1b&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;0&quot;</span>  <span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">word</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define H8300_GEN_BITOP_CONST(OP,BIT)			    \</span>
<span class="cp">	case BIT:					    \</span>
<span class="cp">	__asm__(OP &quot; #&quot; #BIT &quot;,@%0&quot;::&quot;r&quot;(b_addr):&quot;memory&quot;); \</span>
<span class="cp">	break;</span>

<span class="cp">#define H8300_GEN_BITOP(FNAME,OP)				      \</span>
<span class="cp">static __inline__ void FNAME(int nr, volatile unsigned long* addr)    \</span>
<span class="cp">{								      \</span>
<span class="cp">	volatile unsigned char *b_addr;				      \</span>
<span class="cp">	b_addr = (volatile unsigned char *)addr + ((nr &gt;&gt; 3) ^ 3);    \</span>
<span class="cp">	if (__builtin_constant_p(nr)) {				      \</span>
<span class="cp">		switch(nr &amp; 7) {				      \</span>
<span class="cp">			H8300_GEN_BITOP_CONST(OP,0)		      \</span>
<span class="cp">			H8300_GEN_BITOP_CONST(OP,1)		      \</span>
<span class="cp">			H8300_GEN_BITOP_CONST(OP,2)		      \</span>
<span class="cp">			H8300_GEN_BITOP_CONST(OP,3)		      \</span>
<span class="cp">			H8300_GEN_BITOP_CONST(OP,4)		      \</span>
<span class="cp">			H8300_GEN_BITOP_CONST(OP,5)		      \</span>
<span class="cp">			H8300_GEN_BITOP_CONST(OP,6)		      \</span>
<span class="cp">			H8300_GEN_BITOP_CONST(OP,7)		      \</span>
<span class="cp">		}						      \</span>
<span class="cp">	} else {						      \</span>
<span class="cp">		__asm__(OP &quot; %w0,@%1&quot;::&quot;r&quot;(nr),&quot;r&quot;(b_addr):&quot;memory&quot;); \</span>
<span class="cp">	}							      \</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear_bit() doesn&#39;t provide any barrier for the compiler.</span>
<span class="cm"> */</span>
<span class="cp">#define smp_mb__before_clear_bit()	barrier()</span>
<span class="cp">#define smp_mb__after_clear_bit()	barrier()</span>

<span class="n">H8300_GEN_BITOP</span><span class="p">(</span><span class="n">set_bit</span>	  <span class="p">,</span><span class="s">&quot;bset&quot;</span><span class="p">)</span>
<span class="n">H8300_GEN_BITOP</span><span class="p">(</span><span class="n">clear_bit</span> <span class="p">,</span><span class="s">&quot;bclr&quot;</span><span class="p">)</span>
<span class="n">H8300_GEN_BITOP</span><span class="p">(</span><span class="n">change_bit</span><span class="p">,</span><span class="s">&quot;bnot&quot;</span><span class="p">)</span>
<span class="cp">#define __set_bit(nr,addr)    set_bit((nr),(addr))</span>
<span class="cp">#define __clear_bit(nr,addr)  clear_bit((nr),(addr))</span>
<span class="cp">#define __change_bit(nr,addr) change_bit((nr),(addr))</span>

<span class="cp">#undef H8300_GEN_BITOP</span>
<span class="cp">#undef H8300_GEN_BITOP_CONST</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="n">test_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span> <span class="o">+</span> 
               <span class="p">((</span><span class="n">nr</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">^</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define __test_bit(nr, addr) test_bit(nr, addr)</span>

<span class="cp">#define H8300_GEN_TEST_BITOP_CONST_INT(OP,BIT)			     \</span>
<span class="cp">	case BIT:						     \</span>
<span class="cp">	__asm__(&quot;stc ccr,%w1\n\t&quot;				     \</span>
<span class="cp">		&quot;orc #0x80,ccr\n\t&quot;				     \</span>
<span class="cp">		&quot;bld #&quot; #BIT &quot;,@%4\n\t&quot;				     \</span>
<span class="cp">		OP &quot; #&quot; #BIT &quot;,@%4\n\t&quot;				     \</span>
<span class="cp">		&quot;rotxl.l %0\n\t&quot;				     \</span>
<span class="cp">		&quot;ldc %w1,ccr&quot;					     \</span>
<span class="cp">		: &quot;=r&quot;(retval),&quot;=&amp;r&quot;(ccrsave),&quot;=m&quot;(*b_addr)	     \</span>
<span class="cp">		: &quot;0&quot; (retval),&quot;r&quot; (b_addr)			     \</span>
<span class="cp">		: &quot;memory&quot;);                                         \</span>
<span class="cp">        break;</span>

<span class="cp">#define H8300_GEN_TEST_BITOP_CONST(OP,BIT)			     \</span>
<span class="cp">	case BIT:						     \</span>
<span class="cp">	__asm__(&quot;bld #&quot; #BIT &quot;,@%3\n\t&quot;				     \</span>
<span class="cp">		OP &quot; #&quot; #BIT &quot;,@%3\n\t&quot;				     \</span>
<span class="cp">		&quot;rotxl.l %0\n\t&quot;				     \</span>
<span class="cp">		: &quot;=r&quot;(retval),&quot;=m&quot;(*b_addr)			     \</span>
<span class="cp">		: &quot;0&quot; (retval),&quot;r&quot; (b_addr)			     \</span>
<span class="cp">		: &quot;memory&quot;);                                         \</span>
<span class="cp">        break;</span>

<span class="cp">#define H8300_GEN_TEST_BITOP(FNNAME,OP)				     \</span>
<span class="cp">static __inline__ int FNNAME(int nr, volatile void * addr)	     \</span>
<span class="cp">{								     \</span>
<span class="cp">	int retval = 0;						     \</span>
<span class="cp">	char ccrsave;						     \</span>
<span class="cp">	volatile unsigned char *b_addr;				     \</span>
<span class="cp">	b_addr = (volatile unsigned char *)addr + ((nr &gt;&gt; 3) ^ 3);   \</span>
<span class="cp">	if (__builtin_constant_p(nr)) {				     \</span>
<span class="cp">		switch(nr &amp; 7) {				     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST_INT(OP,0)	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST_INT(OP,1)	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST_INT(OP,2)	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST_INT(OP,3)	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST_INT(OP,4)	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST_INT(OP,5)	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST_INT(OP,6)	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST_INT(OP,7)	     \</span>
<span class="cp">		}						     \</span>
<span class="cp">	} else {						     \</span>
<span class="cp">		__asm__(&quot;stc ccr,%w1\n\t&quot;			     \</span>
<span class="cp">			&quot;orc #0x80,ccr\n\t&quot;			     \</span>
<span class="cp">			&quot;btst %w5,@%4\n\t&quot;			     \</span>
<span class="cp">			OP &quot; %w5,@%4\n\t&quot;			     \</span>
<span class="cp">			&quot;beq 1f\n\t&quot;				     \</span>
<span class="cp">			&quot;inc.l #1,%0\n&quot;				     \</span>
<span class="cp">			&quot;1:\n\t&quot;				     \</span>
<span class="cp">			&quot;ldc %w1,ccr&quot;				     \</span>
<span class="cp">			: &quot;=r&quot;(retval),&quot;=&amp;r&quot;(ccrsave),&quot;=m&quot;(*b_addr)  \</span>
<span class="cp">			: &quot;0&quot; (retval),&quot;r&quot; (b_addr),&quot;r&quot;(nr)	     \</span>
<span class="cp">			: &quot;memory&quot;);				     \</span>
<span class="cp">	}							     \</span>
<span class="cp">	return retval;						     \</span>
<span class="cp">}								     \</span>
<span class="cp">								     \</span>
<span class="cp">static __inline__ int __ ## FNNAME(int nr, volatile void * addr)     \</span>
<span class="cp">{								     \</span>
<span class="cp">	int retval = 0;						     \</span>
<span class="cp">	volatile unsigned char *b_addr;				     \</span>
<span class="cp">	b_addr = (volatile unsigned char *)addr + ((nr &gt;&gt; 3) ^ 3);   \</span>
<span class="cp">	if (__builtin_constant_p(nr)) {				     \</span>
<span class="cp">		switch(nr &amp; 7) {				     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST(OP,0) 	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST(OP,1) 	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST(OP,2) 	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST(OP,3) 	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST(OP,4) 	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST(OP,5) 	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST(OP,6) 	     \</span>
<span class="cp">			H8300_GEN_TEST_BITOP_CONST(OP,7) 	     \</span>
<span class="cp">		}						     \</span>
<span class="cp">	} else {						     \</span>
<span class="cp">		__asm__(&quot;btst %w4,@%3\n\t&quot;			     \</span>
<span class="cp">			OP &quot; %w4,@%3\n\t&quot;			     \</span>
<span class="cp">			&quot;beq 1f\n\t&quot;				     \</span>
<span class="cp">			&quot;inc.l #1,%0\n&quot;				     \</span>
<span class="cp">			&quot;1:&quot;					     \</span>
<span class="cp">			: &quot;=r&quot;(retval),&quot;=m&quot;(*b_addr)		     \</span>
<span class="cp">			: &quot;0&quot; (retval),&quot;r&quot; (b_addr),&quot;r&quot;(nr)	     \</span>
<span class="cp">			: &quot;memory&quot;);				     \</span>
<span class="cp">	}							     \</span>
<span class="cp">	return retval;						     \</span>
<span class="cp">}</span>

<span class="n">H8300_GEN_TEST_BITOP</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">,</span>	 <span class="s">&quot;bset&quot;</span><span class="p">)</span>
<span class="n">H8300_GEN_TEST_BITOP</span><span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">,</span> <span class="s">&quot;bclr&quot;</span><span class="p">)</span>
<span class="n">H8300_GEN_TEST_BITOP</span><span class="p">(</span><span class="n">test_and_change_bit</span><span class="p">,</span><span class="s">&quot;bnot&quot;</span><span class="p">)</span>
<span class="cp">#undef H8300_GEN_TEST_BITOP_CONST</span>
<span class="cp">#undef H8300_GEN_TEST_BITOP_CONST_INT</span>
<span class="cp">#undef H8300_GEN_TEST_BITOP</span>

<span class="cp">#include &lt;asm-generic/bitops/ffs.h&gt;</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__ffs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;1:</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;shlr.l %2</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;adds #1,%0</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;bcc 1b&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">word</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#include &lt;asm-generic/bitops/find.h&gt;</span>
<span class="cp">#include &lt;asm-generic/bitops/sched.h&gt;</span>
<span class="cp">#include &lt;asm-generic/bitops/hweight.h&gt;</span>
<span class="cp">#include &lt;asm-generic/bitops/lock.h&gt;</span>
<span class="cp">#include &lt;asm-generic/bitops/le.h&gt;</span>
<span class="cp">#include &lt;asm-generic/bitops/ext2-atomic.h&gt;</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>

<span class="cp">#include &lt;asm-generic/bitops/fls.h&gt;</span>
<span class="cp">#include &lt;asm-generic/bitops/__fls.h&gt;</span>
<span class="cp">#include &lt;asm-generic/bitops/fls64.h&gt;</span>

<span class="cp">#endif </span><span class="cm">/* _H8300_BITOPS_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
