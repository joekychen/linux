<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kvm › emulate.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>emulate.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * emulate.c</span>
<span class="cm"> *</span>
<span class="cm"> * Generic x86 (32-bit and 64-bit) instruction decoder and emulator.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2005 Keir Fraser</span>
<span class="cm"> *</span>
<span class="cm"> * Linux coding style, mod r/m decoder, segment base fixes, real-mode</span>
<span class="cm"> * privileged instructions:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Qumranet</span>
<span class="cm"> * Copyright 2010 Red Hat, Inc. and/or its affiliates.</span>
<span class="cm"> *</span>
<span class="cm"> *   Avi Kivity &lt;avi@qumranet.com&gt;</span>
<span class="cm"> *   Yaniv Kamay &lt;yaniv@qumranet.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This work is licensed under the terms of the GNU GPL, version 2.  See</span>
<span class="cm"> * the COPYING file in the top-level directory.</span>
<span class="cm"> *</span>
<span class="cm"> * From: xen-unstable 10676:af9809f51f81a3c43f276f00c81a52ef558afda4</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &quot;kvm_cache_regs.h&quot;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_emulate.h&gt;</span>

<span class="cp">#include &quot;x86.h&quot;</span>
<span class="cp">#include &quot;tss.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Operand types</span>
<span class="cm"> */</span>
<span class="cp">#define OpNone             0ull</span>
<span class="cp">#define OpImplicit         1ull  </span><span class="cm">/* No generic decode */</span><span class="cp"></span>
<span class="cp">#define OpReg              2ull  </span><span class="cm">/* Register */</span><span class="cp"></span>
<span class="cp">#define OpMem              3ull  </span><span class="cm">/* Memory */</span><span class="cp"></span>
<span class="cp">#define OpAcc              4ull  </span><span class="cm">/* Accumulator: AL/AX/EAX/RAX */</span><span class="cp"></span>
<span class="cp">#define OpDI               5ull  </span><span class="cm">/* ES:DI/EDI/RDI */</span><span class="cp"></span>
<span class="cp">#define OpMem64            6ull  </span><span class="cm">/* Memory, 64-bit */</span><span class="cp"></span>
<span class="cp">#define OpImmUByte         7ull  </span><span class="cm">/* Zero-extended 8-bit immediate */</span><span class="cp"></span>
<span class="cp">#define OpDX               8ull  </span><span class="cm">/* DX register */</span><span class="cp"></span>
<span class="cp">#define OpCL               9ull  </span><span class="cm">/* CL register (for shifts) */</span><span class="cp"></span>
<span class="cp">#define OpImmByte         10ull  </span><span class="cm">/* 8-bit sign extended immediate */</span><span class="cp"></span>
<span class="cp">#define OpOne             11ull  </span><span class="cm">/* Implied 1 */</span><span class="cp"></span>
<span class="cp">#define OpImm             12ull  </span><span class="cm">/* Sign extended immediate */</span><span class="cp"></span>
<span class="cp">#define OpMem16           13ull  </span><span class="cm">/* Memory operand (16-bit). */</span><span class="cp"></span>
<span class="cp">#define OpMem32           14ull  </span><span class="cm">/* Memory operand (32-bit). */</span><span class="cp"></span>
<span class="cp">#define OpImmU            15ull  </span><span class="cm">/* Immediate operand, zero extended */</span><span class="cp"></span>
<span class="cp">#define OpSI              16ull  </span><span class="cm">/* SI/ESI/RSI */</span><span class="cp"></span>
<span class="cp">#define OpImmFAddr        17ull  </span><span class="cm">/* Immediate far address */</span><span class="cp"></span>
<span class="cp">#define OpMemFAddr        18ull  </span><span class="cm">/* Far address in memory */</span><span class="cp"></span>
<span class="cp">#define OpImmU16          19ull  </span><span class="cm">/* Immediate operand, 16 bits, zero extended */</span><span class="cp"></span>
<span class="cp">#define OpES              20ull  </span><span class="cm">/* ES */</span><span class="cp"></span>
<span class="cp">#define OpCS              21ull  </span><span class="cm">/* CS */</span><span class="cp"></span>
<span class="cp">#define OpSS              22ull  </span><span class="cm">/* SS */</span><span class="cp"></span>
<span class="cp">#define OpDS              23ull  </span><span class="cm">/* DS */</span><span class="cp"></span>
<span class="cp">#define OpFS              24ull  </span><span class="cm">/* FS */</span><span class="cp"></span>
<span class="cp">#define OpGS              25ull  </span><span class="cm">/* GS */</span><span class="cp"></span>
<span class="cp">#define OpMem8            26ull  </span><span class="cm">/* 8-bit zero extended memory operand */</span><span class="cp"></span>

<span class="cp">#define OpBits             5  </span><span class="cm">/* Width of operand field */</span><span class="cp"></span>
<span class="cp">#define OpMask             ((1ull &lt;&lt; OpBits) - 1)</span>

<span class="cm">/*</span>
<span class="cm"> * Opcode effective-address decode tables.</span>
<span class="cm"> * Note that we only emulate instructions that have at least one memory</span>
<span class="cm"> * operand (excluding implicit stack references). We assume that stack</span>
<span class="cm"> * references and instruction fetches will never occur in special memory</span>
<span class="cm"> * areas that require emulation. So, for example, &#39;mov &lt;imm&gt;,&lt;reg&gt;&#39; need</span>
<span class="cm"> * not be handled.</span>
<span class="cm"> */</span>

<span class="cm">/* Operand sizes: 8-bit operands or specified/overridden size. */</span>
<span class="cp">#define ByteOp      (1&lt;&lt;0)	</span><span class="cm">/* 8-bit operands. */</span><span class="cp"></span>
<span class="cm">/* Destination operand type. */</span>
<span class="cp">#define DstShift    1</span>
<span class="cp">#define ImplicitOps (OpImplicit &lt;&lt; DstShift)</span>
<span class="cp">#define DstReg      (OpReg &lt;&lt; DstShift)</span>
<span class="cp">#define DstMem      (OpMem &lt;&lt; DstShift)</span>
<span class="cp">#define DstAcc      (OpAcc &lt;&lt; DstShift)</span>
<span class="cp">#define DstDI       (OpDI &lt;&lt; DstShift)</span>
<span class="cp">#define DstMem64    (OpMem64 &lt;&lt; DstShift)</span>
<span class="cp">#define DstImmUByte (OpImmUByte &lt;&lt; DstShift)</span>
<span class="cp">#define DstDX       (OpDX &lt;&lt; DstShift)</span>
<span class="cp">#define DstMask     (OpMask &lt;&lt; DstShift)</span>
<span class="cm">/* Source operand type. */</span>
<span class="cp">#define SrcShift    6</span>
<span class="cp">#define SrcNone     (OpNone &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcReg      (OpReg &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcMem      (OpMem &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcMem16    (OpMem16 &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcMem32    (OpMem32 &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcImm      (OpImm &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcImmByte  (OpImmByte &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcOne      (OpOne &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcImmUByte (OpImmUByte &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcImmU     (OpImmU &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcSI       (OpSI &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcImmFAddr (OpImmFAddr &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcMemFAddr (OpMemFAddr &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcAcc      (OpAcc &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcImmU16   (OpImmU16 &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcDX       (OpDX &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcMem8     (OpMem8 &lt;&lt; SrcShift)</span>
<span class="cp">#define SrcMask     (OpMask &lt;&lt; SrcShift)</span>
<span class="cp">#define BitOp       (1&lt;&lt;11)</span>
<span class="cp">#define MemAbs      (1&lt;&lt;12)      </span><span class="cm">/* Memory operand is absolute displacement */</span><span class="cp"></span>
<span class="cp">#define String      (1&lt;&lt;13)     </span><span class="cm">/* String instruction (rep capable) */</span><span class="cp"></span>
<span class="cp">#define Stack       (1&lt;&lt;14)     </span><span class="cm">/* Stack instruction (push/pop) */</span><span class="cp"></span>
<span class="cp">#define GroupMask   (7&lt;&lt;15)     </span><span class="cm">/* Opcode uses one of the group mechanisms */</span><span class="cp"></span>
<span class="cp">#define Group       (1&lt;&lt;15)     </span><span class="cm">/* Bits 3:5 of modrm byte extend opcode */</span><span class="cp"></span>
<span class="cp">#define GroupDual   (2&lt;&lt;15)     </span><span class="cm">/* Alternate decoding of mod == 3 */</span><span class="cp"></span>
<span class="cp">#define Prefix      (3&lt;&lt;15)     </span><span class="cm">/* Instruction varies with 66/f2/f3 prefix */</span><span class="cp"></span>
<span class="cp">#define RMExt       (4&lt;&lt;15)     </span><span class="cm">/* Opcode extension in ModRM r/m if mod == 3 */</span><span class="cp"></span>
<span class="cp">#define Sse         (1&lt;&lt;18)     </span><span class="cm">/* SSE Vector instruction */</span><span class="cp"></span>
<span class="cm">/* Generic ModRM decode. */</span>
<span class="cp">#define ModRM       (1&lt;&lt;19)</span>
<span class="cm">/* Destination is only written; never read. */</span>
<span class="cp">#define Mov         (1&lt;&lt;20)</span>
<span class="cm">/* Misc flags */</span>
<span class="cp">#define Prot        (1&lt;&lt;21) </span><span class="cm">/* instruction generates #UD if not in prot-mode */</span><span class="cp"></span>
<span class="cp">#define VendorSpecific (1&lt;&lt;22) </span><span class="cm">/* Vendor specific instruction */</span><span class="cp"></span>
<span class="cp">#define NoAccess    (1&lt;&lt;23) </span><span class="cm">/* Don&#39;t access memory (lea/invlpg/verr etc) */</span><span class="cp"></span>
<span class="cp">#define Op3264      (1&lt;&lt;24) </span><span class="cm">/* Operand is 64b in long mode, 32b otherwise */</span><span class="cp"></span>
<span class="cp">#define Undefined   (1&lt;&lt;25) </span><span class="cm">/* No Such Instruction */</span><span class="cp"></span>
<span class="cp">#define Lock        (1&lt;&lt;26) </span><span class="cm">/* lock prefix is allowed for the instruction */</span><span class="cp"></span>
<span class="cp">#define Priv        (1&lt;&lt;27) </span><span class="cm">/* instruction generates #GP if current CPL != 0 */</span><span class="cp"></span>
<span class="cp">#define No64	    (1&lt;&lt;28)</span>
<span class="cp">#define PageTable   (1 &lt;&lt; 29)   </span><span class="cm">/* instruction used to write page table */</span><span class="cp"></span>
<span class="cm">/* Source 2 operand type */</span>
<span class="cp">#define Src2Shift   (30)</span>
<span class="cp">#define Src2None    (OpNone &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2CL      (OpCL &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2ImmByte (OpImmByte &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2One     (OpOne &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2Imm     (OpImm &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2ES      (OpES &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2CS      (OpCS &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2SS      (OpSS &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2DS      (OpDS &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2FS      (OpFS &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2GS      (OpGS &lt;&lt; Src2Shift)</span>
<span class="cp">#define Src2Mask    (OpMask &lt;&lt; Src2Shift)</span>
<span class="cp">#define Mmx         ((u64)1 &lt;&lt; 40)  </span><span class="cm">/* MMX Vector instruction */</span><span class="cp"></span>
<span class="cp">#define Aligned     ((u64)1 &lt;&lt; 41)  </span><span class="cm">/* Explicitly aligned (e.g. MOVDQA) */</span><span class="cp"></span>
<span class="cp">#define Unaligned   ((u64)1 &lt;&lt; 42)  </span><span class="cm">/* Explicitly unaligned (e.g. MOVDQU) */</span><span class="cp"></span>
<span class="cp">#define Avx         ((u64)1 &lt;&lt; 43)  </span><span class="cm">/* Advanced Vector Extensions */</span><span class="cp"></span>

<span class="cp">#define X2(x...) x, x</span>
<span class="cp">#define X3(x...) X2(x), x</span>
<span class="cp">#define X4(x...) X2(x), X2(x)</span>
<span class="cp">#define X5(x...) X4(x), x</span>
<span class="cp">#define X6(x...) X4(x), X2(x)</span>
<span class="cp">#define X7(x...) X4(x), X3(x)</span>
<span class="cp">#define X8(x...) X4(x), X4(x)</span>
<span class="cp">#define X16(x...) X8(x), X8(x)</span>

<span class="k">struct</span> <span class="n">opcode</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">flags</span> <span class="o">:</span> <span class="mi">56</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">intercept</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">execute</span><span class="p">)(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">opcode</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">group_dual</span> <span class="o">*</span><span class="n">gdual</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gprefix</span> <span class="o">*</span><span class="n">gprefix</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">check_perm</span><span class="p">)(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">group_dual</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">opcode</span> <span class="n">mod012</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">opcode</span> <span class="n">mod3</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gprefix</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">opcode</span> <span class="n">pfx_no</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">opcode</span> <span class="n">pfx_66</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">opcode</span> <span class="n">pfx_f2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">opcode</span> <span class="n">pfx_f3</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* EFLAGS bit definitions. */</span>
<span class="cp">#define EFLG_ID (1&lt;&lt;21)</span>
<span class="cp">#define EFLG_VIP (1&lt;&lt;20)</span>
<span class="cp">#define EFLG_VIF (1&lt;&lt;19)</span>
<span class="cp">#define EFLG_AC (1&lt;&lt;18)</span>
<span class="cp">#define EFLG_VM (1&lt;&lt;17)</span>
<span class="cp">#define EFLG_RF (1&lt;&lt;16)</span>
<span class="cp">#define EFLG_IOPL (3&lt;&lt;12)</span>
<span class="cp">#define EFLG_NT (1&lt;&lt;14)</span>
<span class="cp">#define EFLG_OF (1&lt;&lt;11)</span>
<span class="cp">#define EFLG_DF (1&lt;&lt;10)</span>
<span class="cp">#define EFLG_IF (1&lt;&lt;9)</span>
<span class="cp">#define EFLG_TF (1&lt;&lt;8)</span>
<span class="cp">#define EFLG_SF (1&lt;&lt;7)</span>
<span class="cp">#define EFLG_ZF (1&lt;&lt;6)</span>
<span class="cp">#define EFLG_AF (1&lt;&lt;4)</span>
<span class="cp">#define EFLG_PF (1&lt;&lt;2)</span>
<span class="cp">#define EFLG_CF (1&lt;&lt;0)</span>

<span class="cp">#define EFLG_RESERVED_ZEROS_MASK 0xffc0802a</span>
<span class="cp">#define EFLG_RESERVED_ONE_MASK 2</span>

<span class="cm">/*</span>
<span class="cm"> * Instruction emulation:</span>
<span class="cm"> * Most instructions are emulated directly via a fragment of inline assembly</span>
<span class="cm"> * code. This allows us to save/restore EFLAGS and thus very easily pick up</span>
<span class="cm"> * any modified flags.</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_X86_64)</span>
<span class="cp">#define _LO32 &quot;k&quot;		</span><span class="cm">/* force 32-bit operand */</span><span class="cp"></span>
<span class="cp">#define _STK  &quot;%%rsp&quot;		</span><span class="cm">/* stack pointer */</span><span class="cp"></span>
<span class="cp">#elif defined(__i386__)</span>
<span class="cp">#define _LO32 &quot;&quot;		</span><span class="cm">/* force 32-bit operand */</span><span class="cp"></span>
<span class="cp">#define _STK  &quot;%%esp&quot;		</span><span class="cm">/* stack pointer */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * These EFLAGS bits are restored from saved value during emulation, and</span>
<span class="cm"> * any changes are written back to the saved value after emulation.</span>
<span class="cm"> */</span>
<span class="cp">#define EFLAGS_MASK (EFLG_OF|EFLG_SF|EFLG_ZF|EFLG_AF|EFLG_PF|EFLG_CF)</span>

<span class="cm">/* Before executing instruction: restore necessary bits in EFLAGS. */</span>
<span class="cp">#define _PRE_EFLAGS(_sav, _msk, _tmp)					\</span>
<span class="cp">	</span><span class="cm">/* EFLAGS = (_sav &amp; _msk) | (EFLAGS &amp; ~_msk); _sav &amp;= ~_msk; */</span><span class="cp"> \</span>
<span class="cp">	&quot;movl %&quot;_sav&quot;,%&quot;_LO32 _tmp&quot;; &quot;                                  \</span>
<span class="cp">	&quot;push %&quot;_tmp&quot;; &quot;                                                \</span>
<span class="cp">	&quot;push %&quot;_tmp&quot;; &quot;                                                \</span>
<span class="cp">	&quot;movl %&quot;_msk&quot;,%&quot;_LO32 _tmp&quot;; &quot;                                  \</span>
<span class="cp">	&quot;andl %&quot;_LO32 _tmp&quot;,(&quot;_STK&quot;); &quot;                                 \</span>
<span class="cp">	&quot;pushf; &quot;                                                       \</span>
<span class="cp">	&quot;notl %&quot;_LO32 _tmp&quot;; &quot;                                          \</span>
<span class="cp">	&quot;andl %&quot;_LO32 _tmp&quot;,(&quot;_STK&quot;); &quot;                                 \</span>
<span class="cp">	&quot;andl %&quot;_LO32 _tmp&quot;,&quot;__stringify(BITS_PER_LONG/4)&quot;(&quot;_STK&quot;); &quot;	\</span>
<span class="cp">	&quot;pop  %&quot;_tmp&quot;; &quot;                                                \</span>
<span class="cp">	&quot;orl  %&quot;_LO32 _tmp&quot;,(&quot;_STK&quot;); &quot;                                 \</span>
<span class="cp">	&quot;popf; &quot;                                                        \</span>
<span class="cp">	&quot;pop  %&quot;_sav&quot;; &quot;</span>

<span class="cm">/* After executing instruction: write-back necessary bits in EFLAGS. */</span>
<span class="cp">#define _POST_EFLAGS(_sav, _msk, _tmp) \</span>
<span class="cp">	</span><span class="cm">/* _sav |= EFLAGS &amp; _msk; */</span><span class="cp">		\</span>
<span class="cp">	&quot;pushf; &quot;				\</span>
<span class="cp">	&quot;pop  %&quot;_tmp&quot;; &quot;			\</span>
<span class="cp">	&quot;andl %&quot;_msk&quot;,%&quot;_LO32 _tmp&quot;; &quot;		\</span>
<span class="cp">	&quot;orl  %&quot;_LO32 _tmp&quot;,%&quot;_sav&quot;; &quot;</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="cp">#define ON64(x) x</span>
<span class="cp">#else</span>
<span class="cp">#define ON64(x)</span>
<span class="cp">#endif</span>

<span class="cp">#define ____emulate_2op(ctxt, _op, _x, _y, _suffix, _dsttype)	\</span>
<span class="cp">	do {								\</span>
<span class="cp">		__asm__ __volatile__ (					\</span>
<span class="cp">			_PRE_EFLAGS(&quot;0&quot;, &quot;4&quot;, &quot;2&quot;)			\</span>
<span class="cp">			_op _suffix &quot; %&quot;_x&quot;3,%1; &quot;			\</span>
<span class="cp">			_POST_EFLAGS(&quot;0&quot;, &quot;4&quot;, &quot;2&quot;)			\</span>
<span class="cp">			: &quot;=m&quot; ((ctxt)-&gt;eflags),			\</span>
<span class="cp">			  &quot;+q&quot; (*(_dsttype*)&amp;(ctxt)-&gt;dst.val),		\</span>
<span class="cp">			  &quot;=&amp;r&quot; (_tmp)					\</span>
<span class="cp">			: _y ((ctxt)-&gt;src.val), &quot;i&quot; (EFLAGS_MASK));	\</span>
<span class="cp">	} while (0)</span>


<span class="cm">/* Raw emulation: instruction has two explicit operands. */</span>
<span class="cp">#define __emulate_2op_nobyte(ctxt,_op,_wx,_wy,_lx,_ly,_qx,_qy)		\</span>
<span class="cp">	do {								\</span>
<span class="cp">		unsigned long _tmp;					\</span>
<span class="cp">									\</span>
<span class="cp">		switch ((ctxt)-&gt;dst.bytes) {				\</span>
<span class="cp">		case 2:							\</span>
<span class="cp">			____emulate_2op(ctxt,_op,_wx,_wy,&quot;w&quot;,u16);	\</span>
<span class="cp">			break;						\</span>
<span class="cp">		case 4:							\</span>
<span class="cp">			____emulate_2op(ctxt,_op,_lx,_ly,&quot;l&quot;,u32);	\</span>
<span class="cp">			break;						\</span>
<span class="cp">		case 8:							\</span>
<span class="cp">			ON64(____emulate_2op(ctxt,_op,_qx,_qy,&quot;q&quot;,u64)); \</span>
<span class="cp">			break;						\</span>
<span class="cp">		}							\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define __emulate_2op(ctxt,_op,_bx,_by,_wx,_wy,_lx,_ly,_qx,_qy)		     \</span>
<span class="cp">	do {								     \</span>
<span class="cp">		unsigned long _tmp;					     \</span>
<span class="cp">		switch ((ctxt)-&gt;dst.bytes) {				     \</span>
<span class="cp">		case 1:							     \</span>
<span class="cp">			____emulate_2op(ctxt,_op,_bx,_by,&quot;b&quot;,u8);	     \</span>
<span class="cp">			break;						     \</span>
<span class="cp">		default:						     \</span>
<span class="cp">			__emulate_2op_nobyte(ctxt, _op,			     \</span>
<span class="cp">					     _wx, _wy, _lx, _ly, _qx, _qy);  \</span>
<span class="cp">			break;						     \</span>
<span class="cp">		}							     \</span>
<span class="cp">	} while (0)</span>

<span class="cm">/* Source operand is byte-sized and may be restricted to just %cl. */</span>
<span class="cp">#define emulate_2op_SrcB(ctxt, _op)					\</span>
<span class="cp">	__emulate_2op(ctxt, _op, &quot;b&quot;, &quot;c&quot;, &quot;b&quot;, &quot;c&quot;, &quot;b&quot;, &quot;c&quot;, &quot;b&quot;, &quot;c&quot;)</span>

<span class="cm">/* Source operand is byte, word, long or quad sized. */</span>
<span class="cp">#define emulate_2op_SrcV(ctxt, _op)					\</span>
<span class="cp">	__emulate_2op(ctxt, _op, &quot;b&quot;, &quot;q&quot;, &quot;w&quot;, &quot;r&quot;, _LO32, &quot;r&quot;, &quot;&quot;, &quot;r&quot;)</span>

<span class="cm">/* Source operand is word, long or quad sized. */</span>
<span class="cp">#define emulate_2op_SrcV_nobyte(ctxt, _op)				\</span>
<span class="cp">	__emulate_2op_nobyte(ctxt, _op, &quot;w&quot;, &quot;r&quot;, _LO32, &quot;r&quot;, &quot;&quot;, &quot;r&quot;)</span>

<span class="cm">/* Instruction has three operands and one operand is stored in ECX register */</span>
<span class="cp">#define __emulate_2op_cl(ctxt, _op, _suffix, _type)		\</span>
<span class="cp">	do {								\</span>
<span class="cp">		unsigned long _tmp;					\</span>
<span class="cp">		_type _clv  = (ctxt)-&gt;src2.val;				\</span>
<span class="cp">		_type _srcv = (ctxt)-&gt;src.val;				\</span>
<span class="cp">		_type _dstv = (ctxt)-&gt;dst.val;				\</span>
<span class="cp">									\</span>
<span class="cp">		__asm__ __volatile__ (					\</span>
<span class="cp">			_PRE_EFLAGS(&quot;0&quot;, &quot;5&quot;, &quot;2&quot;)			\</span>
<span class="cp">			_op _suffix &quot; %4,%1 \n&quot;				\</span>
<span class="cp">			_POST_EFLAGS(&quot;0&quot;, &quot;5&quot;, &quot;2&quot;)			\</span>
<span class="cp">			: &quot;=m&quot; ((ctxt)-&gt;eflags), &quot;+r&quot; (_dstv), &quot;=&amp;r&quot; (_tmp) \</span>
<span class="cp">			: &quot;c&quot; (_clv) , &quot;r&quot; (_srcv), &quot;i&quot; (EFLAGS_MASK)	\</span>
<span class="cp">			);						\</span>
<span class="cp">									\</span>
<span class="cp">		(ctxt)-&gt;src2.val  = (unsigned long) _clv;		\</span>
<span class="cp">		(ctxt)-&gt;src2.val = (unsigned long) _srcv;		\</span>
<span class="cp">		(ctxt)-&gt;dst.val = (unsigned long) _dstv;		\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define emulate_2op_cl(ctxt, _op)					\</span>
<span class="cp">	do {								\</span>
<span class="cp">		switch ((ctxt)-&gt;dst.bytes) {				\</span>
<span class="cp">		case 2:							\</span>
<span class="cp">			__emulate_2op_cl(ctxt, _op, &quot;w&quot;, u16);		\</span>
<span class="cp">			break;						\</span>
<span class="cp">		case 4:							\</span>
<span class="cp">			__emulate_2op_cl(ctxt, _op, &quot;l&quot;, u32);		\</span>
<span class="cp">			break;						\</span>
<span class="cp">		case 8:							\</span>
<span class="cp">			ON64(__emulate_2op_cl(ctxt, _op, &quot;q&quot;, ulong));	\</span>
<span class="cp">			break;						\</span>
<span class="cp">		}							\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define __emulate_1op(ctxt, _op, _suffix)				\</span>
<span class="cp">	do {								\</span>
<span class="cp">		unsigned long _tmp;					\</span>
<span class="cp">									\</span>
<span class="cp">		__asm__ __volatile__ (					\</span>
<span class="cp">			_PRE_EFLAGS(&quot;0&quot;, &quot;3&quot;, &quot;2&quot;)			\</span>
<span class="cp">			_op _suffix &quot; %1; &quot;				\</span>
<span class="cp">			_POST_EFLAGS(&quot;0&quot;, &quot;3&quot;, &quot;2&quot;)			\</span>
<span class="cp">			: &quot;=m&quot; ((ctxt)-&gt;eflags), &quot;+m&quot; ((ctxt)-&gt;dst.val), \</span>
<span class="cp">			  &quot;=&amp;r&quot; (_tmp)					\</span>
<span class="cp">			: &quot;i&quot; (EFLAGS_MASK));				\</span>
<span class="cp">	} while (0)</span>

<span class="cm">/* Instruction has only one explicit operand (no source operand). */</span>
<span class="cp">#define emulate_1op(ctxt, _op)						\</span>
<span class="cp">	do {								\</span>
<span class="cp">		switch ((ctxt)-&gt;dst.bytes) {				\</span>
<span class="cp">		case 1:	__emulate_1op(ctxt, _op, &quot;b&quot;); break;		\</span>
<span class="cp">		case 2:	__emulate_1op(ctxt, _op, &quot;w&quot;); break;		\</span>
<span class="cp">		case 4:	__emulate_1op(ctxt, _op, &quot;l&quot;); break;		\</span>
<span class="cp">		case 8:	ON64(__emulate_1op(ctxt, _op, &quot;q&quot;)); break;	\</span>
<span class="cp">		}							\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define __emulate_1op_rax_rdx(ctxt, _op, _suffix, _ex)			\</span>
<span class="cp">	do {								\</span>
<span class="cp">		unsigned long _tmp;					\</span>
<span class="cp">		ulong *rax = &amp;(ctxt)-&gt;regs[VCPU_REGS_RAX];		\</span>
<span class="cp">		ulong *rdx = &amp;(ctxt)-&gt;regs[VCPU_REGS_RDX];		\</span>
<span class="cp">									\</span>
<span class="cp">		__asm__ __volatile__ (					\</span>
<span class="cp">			_PRE_EFLAGS(&quot;0&quot;, &quot;5&quot;, &quot;1&quot;)			\</span>
<span class="cp">			&quot;1: \n\t&quot;					\</span>
<span class="cp">			_op _suffix &quot; %6; &quot;				\</span>
<span class="cp">			&quot;2: \n\t&quot;					\</span>
<span class="cp">			_POST_EFLAGS(&quot;0&quot;, &quot;5&quot;, &quot;1&quot;)			\</span>
<span class="cp">			&quot;.pushsection .fixup,\&quot;ax\&quot; \n\t&quot;		\</span>
<span class="cp">			&quot;3: movb $1, %4 \n\t&quot;				\</span>
<span class="cp">			&quot;jmp 2b \n\t&quot;					\</span>
<span class="cp">			&quot;.popsection \n\t&quot;				\</span>
<span class="cp">			_ASM_EXTABLE(1b, 3b)				\</span>
<span class="cp">			: &quot;=m&quot; ((ctxt)-&gt;eflags), &quot;=&amp;r&quot; (_tmp),		\</span>
<span class="cp">			  &quot;+a&quot; (*rax), &quot;+d&quot; (*rdx), &quot;+qm&quot;(_ex)		\</span>
<span class="cp">			: &quot;i&quot; (EFLAGS_MASK), &quot;m&quot; ((ctxt)-&gt;src.val),	\</span>
<span class="cp">			  &quot;a&quot; (*rax), &quot;d&quot; (*rdx));			\</span>
<span class="cp">	} while (0)</span>

<span class="cm">/* instruction has only one source operand, destination is implicit (e.g. mul, div, imul, idiv) */</span>
<span class="cp">#define emulate_1op_rax_rdx(ctxt, _op, _ex)	\</span>
<span class="cp">	do {								\</span>
<span class="cp">		switch((ctxt)-&gt;src.bytes) {				\</span>
<span class="cp">		case 1:							\</span>
<span class="cp">			__emulate_1op_rax_rdx(ctxt, _op, &quot;b&quot;, _ex);	\</span>
<span class="cp">			break;						\</span>
<span class="cp">		case 2:							\</span>
<span class="cp">			__emulate_1op_rax_rdx(ctxt, _op, &quot;w&quot;, _ex);	\</span>
<span class="cp">			break;						\</span>
<span class="cp">		case 4:							\</span>
<span class="cp">			__emulate_1op_rax_rdx(ctxt, _op, &quot;l&quot;, _ex);	\</span>
<span class="cp">			break;						\</span>
<span class="cp">		case 8: ON64(						\</span>
<span class="cp">			__emulate_1op_rax_rdx(ctxt, _op, &quot;q&quot;, _ex));	\</span>
<span class="cp">			break;						\</span>
<span class="cp">		}							\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulator_check_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">x86_intercept</span> <span class="n">intercept</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">x86_intercept_stage</span> <span class="n">stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_instruction_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">intercept</span>  <span class="o">=</span> <span class="n">intercept</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rep_prefix</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span><span class="p">,</span>
		<span class="p">.</span><span class="n">modrm_mod</span>  <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span><span class="p">,</span>
		<span class="p">.</span><span class="n">modrm_reg</span>  <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">modrm_rm</span>   <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span><span class="p">,</span>
		<span class="p">.</span><span class="n">src_val</span>    <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">src_bytes</span>  <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dst_bytes</span>  <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ad_bytes</span>   <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span><span class="p">,</span>
		<span class="p">.</span><span class="n">next_rip</span>   <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eip</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ad_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Access/update address held in a register, based on addressing mode. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">address_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">ad_mask</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">register_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">address_mask</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">register_address_increment</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
		<span class="o">*</span><span class="n">reg</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ad_mask</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="o">*</span><span class="n">reg</span> <span class="o">+</span> <span class="n">inc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ad_mask</span><span class="p">(</span><span class="n">ctxt</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">jmp_rel</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_address_increment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">,</span> <span class="n">rel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">desc_limit_scaled</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">get_desc_limit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">g</span> <span class="o">?</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xfff</span> <span class="o">:</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_seg_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">has_seg_override</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">seg_override</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">seg_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span> <span class="o">&amp;&amp;</span> <span class="n">seg</span> <span class="o">&lt;</span> <span class="n">VCPU_SREG_FS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cached_segment_base</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">seg_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">has_seg_override</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">seg_override</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">error</span><span class="p">,</span> <span class="n">bool</span> <span class="n">valid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">vec</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">.</span><span class="n">error_code_valid</span> <span class="o">=</span> <span class="n">valid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_PROPAGATE_FAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">DB_VECTOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_gp</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">GP_VECTOR</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_ss</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">SS_VECTOR</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_ud</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">UD_VECTOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_ts</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">TS_VECTOR</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_de</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">DE_VECTOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_nm</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">NM_VECTOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_segment_selector</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">selector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">selector</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_segment_selector</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">u16</span> <span class="n">selector</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base3</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="n">base3</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * x86 defines three classes of vector instructions: explicitly</span>
<span class="cm"> * aligned, explicitly unaligned, and the rest, which change behaviour</span>
<span class="cm"> * depending on whether they&#39;re AVX encoded or not.</span>
<span class="cm"> *</span>
<span class="cm"> * Also included is CMPXCHG16B which is not a vector instruction, yet it is</span>
<span class="cm"> * subject to the same check.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">insn_aligned</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Aligned</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Unaligned</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Avx</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__linearize</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">,</span> <span class="n">bool</span> <span class="n">fetch</span><span class="p">,</span>
		     <span class="n">ulong</span> <span class="o">*</span><span class="n">linear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usable</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">la</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lim</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">rpl</span><span class="p">;</span>

	<span class="n">la</span> <span class="o">=</span> <span class="n">seg_base</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">seg</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span><span class="p">.</span><span class="n">ea</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_REAL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT64</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="kt">signed</span> <span class="kt">long</span><span class="p">)</span><span class="n">la</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">!=</span> <span class="n">la</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">usable</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						<span class="n">addr</span><span class="p">.</span><span class="n">seg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usable</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="cm">/* code segment or read-only data segment */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">write</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="cm">/* unreadable code segment */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fetch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">lim</span> <span class="o">=</span> <span class="n">desc_limit_scaled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* expand-up segment */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">&gt;</span> <span class="n">lim</span> <span class="o">||</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lim</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* exapand-down segment */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">&lt;=</span> <span class="n">lim</span> <span class="o">||</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">lim</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="n">lim</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">d</span> <span class="o">?</span> <span class="mh">0xffffffff</span> <span class="o">:</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">&gt;</span> <span class="n">lim</span> <span class="o">||</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lim</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cpl</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="n">rpl</span> <span class="o">=</span> <span class="n">sel</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">cpl</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">cpl</span><span class="p">,</span> <span class="n">rpl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* data segment */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpl</span> <span class="o">&gt;</span> <span class="n">desc</span><span class="p">.</span><span class="n">dpl</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* nonconforming code segment */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpl</span> <span class="o">!=</span> <span class="n">desc</span><span class="p">.</span><span class="n">dpl</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* conforming code segment */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpl</span> <span class="o">&lt;</span> <span class="n">desc</span><span class="p">.</span><span class="n">dpl</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fetch</span> <span class="o">?</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">X86EMUL_MODE_PROT64</span> <span class="o">:</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">la</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn_aligned</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">la</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">linear</span> <span class="o">=</span> <span class="n">la</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">seg</span> <span class="o">==</span> <span class="n">VCPU_SREG_SS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_ss</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">seg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">seg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">linearize</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">,</span>
		     <span class="n">ulong</span> <span class="o">*</span><span class="n">linear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__linearize</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">linear</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">segmented_read_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">linear</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">linearize</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linear</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fetch the next byte of the instruction being emulated which is pointed to</span>
<span class="cm"> * by ctxt-&gt;_eip, then increment ctxt-&gt;_eip.</span>
<span class="cm"> *</span>
<span class="cm"> * Also prefetch the remaining bytes of the instruction without crossing page</span>
<span class="cm"> * boundary if they are not in fetch_cache yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_insn_fetch_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fetch_cache</span> <span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">fetch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">cur_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">==</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">linear</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">seg</span> <span class="o">=</span> <span class="n">VCPU_SREG_CS</span><span class="p">,</span>
						  <span class="p">.</span><span class="n">ea</span>  <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="p">};</span>
		<span class="n">cur_size</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">15UL</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">,</span>
			   <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">__linearize</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linear</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fetch</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">cur_size</span><span class="p">,</span>
				      <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">fc</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">-</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">];</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_insn_fetch</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* x86 instructions are limited to 15 bytes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">X86EMUL_UNHANDLEABLE</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_insn_fetch_byte</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">dest</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fetch next part of the instruction being emulated. */</span>
<span class="cp">#define insn_fetch(_type, _ctxt)					\</span>
<span class="cp">({	unsigned long _x;						\</span>
<span class="cp">	rc = do_insn_fetch(_ctxt, &amp;_x, sizeof(_type));			\</span>
<span class="cp">	if (rc != X86EMUL_CONTINUE)					\</span>
<span class="cp">		goto done;						\</span>
<span class="cp">	(_type)_x;							\</span>
<span class="cp">})</span>

<span class="cp">#define insn_fetch_arr(_arr, _size, _ctxt)				\</span>
<span class="cp">({	rc = do_insn_fetch(_ctxt, _arr, (_size));			\</span>
<span class="cp">	if (rc != X86EMUL_CONTINUE)					\</span>
<span class="cp">		goto done;						\</span>
<span class="cp">})</span>

<span class="cm">/*</span>
<span class="cm"> * Given the &#39;reg&#39; portion of a ModRM byte, and a register block, return a</span>
<span class="cm"> * pointer into the block that addresses the relevant register.</span>
<span class="cm"> * @highbyte_regs specifies whether to decode AH,CH,DH,BH.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">decode_register</span><span class="p">(</span><span class="n">u8</span> <span class="n">modrm_reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">highbyte_regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">[</span><span class="n">modrm_reg</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">highbyte_regs</span> <span class="o">&amp;&amp;</span> <span class="n">modrm_reg</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">modrm_reg</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">[</span><span class="n">modrm_reg</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op_bytes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">op_bytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">segmented_read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">segmented_read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_cc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">condition</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">condition</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* o */</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EFLG_OF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* b/c/nae */</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EFLG_CF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* z/e */</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EFLG_ZF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* be/na */</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EFLG_CF</span><span class="o">|</span><span class="n">EFLG_ZF</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* s */</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EFLG_SF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* p/pe */</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EFLG_PF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* le/ng */</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EFLG_ZF</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* l/nge */</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EFLG_SF</span><span class="p">)</span> <span class="o">!=</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EFLG_OF</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Odd condition identifiers (lsb == 1) have inverted sense. */</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!!</span><span class="n">rc</span> <span class="o">^</span> <span class="p">(</span><span class="n">condition</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fetch_register_operand</span><span class="p">(</span><span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_sse_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">sse128_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm0, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm1, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm2, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm3, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm4, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm5, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm6, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm7, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm8, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm9, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm10, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm11, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm12, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm13, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm14, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %%xmm15, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span> <span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_sse_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">sse128_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm1&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm2&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm3&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm4&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm5&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm6&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm7&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm8&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm9&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm10&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm11&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm12&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm13&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm14&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movdqu %0, %%xmm15&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span> <span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_mmx_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %%mm0, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %%mm1, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %%mm2, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %%mm3, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %%mm4, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %%mm5, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %%mm6, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %%mm7, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_mmx_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %0, %%mm0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %0, %%mm1&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %0, %%mm2&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %0, %%mm3&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %0, %%mm4&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %0, %%mm5&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %0, %%mm6&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="n">asm</span><span class="p">(</span><span class="s">&quot;movq %0, %%mm7&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_register_operand</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">highbyte_regs</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ModRM</span><span class="p">))</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Sse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_XMM</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">xmm</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">read_sse_reg</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">vec_val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Mmx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_MM</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mm</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">decode_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">highbyte_regs</span><span class="p">);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">decode_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fetch_register_operand</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">orig_val</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">decode_modrm</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">sib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">base_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">modrm_ea</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* REX.R */</span>
		<span class="n">index_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* REX.X */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">=</span> <span class="n">base_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* REG.B */</span>
	<span class="p">}</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_seg</span> <span class="o">=</span> <span class="n">VCPU_SREG_DS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">decode_register</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span><span class="p">,</span>
					       <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Sse</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_XMM</span><span class="p">;</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">xmm</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span><span class="p">;</span>
			<span class="n">read_sse_reg</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">vec_val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Mmx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_MM</span><span class="p">;</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">xmm</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fetch_register_operand</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_MEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">bx</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBX</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="n">bp</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBP</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="n">si</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSI</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="n">di</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">];</span>

		<span class="cm">/* 16-bit ModR/M decode. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">s8</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">bx</span> <span class="o">+</span> <span class="n">si</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">bx</span> <span class="o">+</span> <span class="n">di</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">si</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">di</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">si</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">di</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">bp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">bx</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_seg</span> <span class="o">=</span> <span class="n">VCPU_SREG_SS</span><span class="p">;</span>
		<span class="n">modrm_ea</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">modrm_ea</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 32/64-bit ModR/M decode. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sib</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
			<span class="n">index_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sib</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">base_reg</span> <span class="o">|=</span> <span class="n">sib</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="n">sib</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">base_reg</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">s32</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">base_reg</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index_reg</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">index_reg</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">scale</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">)</span>
				<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rip_relative</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">s32</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">s8</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">modrm_ea</span> <span class="o">+=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">s32</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">modrm_ea</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">decode_abs</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>

	<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_MEM</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fetch_bit_operand</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">sv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP_MEM</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP_REG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">sv</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">sv</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">mask</span><span class="p">;</span>

		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sv</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* only subword offset */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_emulated</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">read_cache</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mem_read</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">read_cached</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_emulated</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">mc</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>

	<span class="nl">read_cached:</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">mc</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">dest</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">segmented_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">linear</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">linearize</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linear</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">read_emulated</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">segmented_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">linear</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">linearize</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linear</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_emulated</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">segmented_cmpxchg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">orig_data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">linear</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">linearize</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linear</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cmpxchg_emulated</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">orig_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					   <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pio_in_emulated</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">read_cache</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">io_read</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">==</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* refill pio read ahead */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_page</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span> <span class="o">?</span>
			<span class="n">address_mask</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">])</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">in_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">EFLG_DF</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">offset_in_page</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">])</span> <span class="o">:</span>
			<span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">]);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">in_page</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="o">/</span> <span class="n">size</span><span class="p">,</span>
			<span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pio_in_emulated</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_interrupt_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">desc_ptr</span> <span class="n">dt</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_idt</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">dt</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_descriptor_table_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">selector</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">desc</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">sel</span><span class="p">;</span>

		<span class="n">memset</span> <span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">dt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">VCPU_SREG_LDTR</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">dt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">desc_limit_scaled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span> <span class="cm">/* what if limit &gt; 65535? */</span>
		<span class="n">dt</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">get_desc_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_gdt</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">dt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* allowed just for 8 bytes segments */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_segment_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">selector</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">desc_ptr</span> <span class="n">dt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="n">selector</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">get_descriptor_table_ptr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">selector</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">dt</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* allowed just for 8 bytes segments */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_segment_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">selector</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">desc_ptr</span> <span class="n">dt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="n">selector</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">get_descriptor_table_ptr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">selector</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">dt</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Does not support long mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_segment_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">selector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">seg_desc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dpl</span><span class="p">,</span> <span class="n">rpl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">err_vec</span> <span class="o">=</span> <span class="n">GP_VECTOR</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">null_selector</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">);</span> <span class="cm">/* 0000-0003 are null */</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">seg_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">seg</span> <span class="o">&lt;=</span> <span class="n">VCPU_SREG_GS</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_VM86</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_REAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set real mode segment descriptor */</span>
		<span class="n">set_desc_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg_desc</span><span class="p">,</span> <span class="n">selector</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">set_desc_limit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg_desc</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">seg_desc</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">seg_desc</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_VM86</span><span class="p">)</span>
			<span class="n">seg_desc</span><span class="p">.</span><span class="n">dpl</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">load</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NULL selector is not valid for TR, CS and SS */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">seg</span> <span class="o">==</span> <span class="n">VCPU_SREG_CS</span> <span class="o">||</span> <span class="n">seg</span> <span class="o">==</span> <span class="n">VCPU_SREG_SS</span> <span class="o">||</span> <span class="n">seg</span> <span class="o">==</span> <span class="n">VCPU_SREG_TR</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">null_selector</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>

	<span class="cm">/* TR should be in GDT only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="n">VCPU_SREG_TR</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">null_selector</span><span class="p">)</span> <span class="cm">/* for NULL selector skip all following checks */</span>
		<span class="k">goto</span> <span class="n">load</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">err_code</span> <span class="o">=</span> <span class="n">selector</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">;</span>
	<span class="n">err_vec</span> <span class="o">=</span> <span class="n">GP_VECTOR</span><span class="p">;</span>

	<span class="cm">/* can&#39;t load system descriptor into segment selecor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg</span> <span class="o">&lt;=</span> <span class="n">VCPU_SREG_GS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">s</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="n">VCPU_SREG_SS</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_VECTOR</span> <span class="o">:</span> <span class="n">NP_VECTOR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpl</span> <span class="o">=</span> <span class="n">selector</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">dpl</span> <span class="o">=</span> <span class="n">seg_desc</span><span class="p">.</span><span class="n">dpl</span><span class="p">;</span>
	<span class="n">cpl</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">seg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_SS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * segment is not a writable data segment or segment</span>
<span class="cm">		 * selector&#39;s RPL != CPL or segment selector&#39;s RPL != CPL</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span> <span class="o">!=</span> <span class="n">cpl</span> <span class="o">||</span> <span class="p">(</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0xa</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x2</span> <span class="o">||</span> <span class="n">dpl</span> <span class="o">!=</span> <span class="n">cpl</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_CS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* conforming */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dpl</span> <span class="o">&gt;</span> <span class="n">cpl</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* nonconforming */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span> <span class="o">&gt;</span> <span class="n">cpl</span> <span class="o">||</span> <span class="n">dpl</span> <span class="o">!=</span> <span class="n">cpl</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* CS(RPL) &lt;- CPL */</span>
		<span class="n">selector</span> <span class="o">=</span> <span class="p">(</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">)</span> <span class="o">|</span> <span class="n">cpl</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_TR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">s</span> <span class="o">||</span> <span class="p">(</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_LDTR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">s</span> <span class="o">||</span> <span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/*  DS, ES, FS, or GS */</span>
		<span class="cm">/*</span>
<span class="cm">		 * segment is not a data or readable code segment or</span>
<span class="cm">		 * ((segment is a data or nonconforming code segment)</span>
<span class="cm">		 * and (both RPL and CPL &gt; DPL))</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0xa</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8</span> <span class="o">||</span>
		    <span class="p">(((</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">rpl</span> <span class="o">&gt;</span> <span class="n">dpl</span> <span class="o">&amp;&amp;</span> <span class="n">cpl</span> <span class="o">&gt;</span> <span class="n">dpl</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">exception</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seg_desc</span><span class="p">.</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mark segment as accessed */</span>
		<span class="n">seg_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">load:</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="nl">exception:</span>
	<span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">err_vec</span><span class="p">,</span> <span class="n">err_code</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_PROPAGATE_FAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_register_operand</span><span class="p">(</span><span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The 4-byte case *is* correct: in 64-bit mode we zero-extend. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>	<span class="cm">/* 64b: zero-extend */</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="o">*</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">writeback</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OP_REG</span>:
		<span class="n">write_register_operand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OP_MEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">lock_prefix</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">segmented_cmpxchg</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span>
					       <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">orig_val</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">,</span>
					       <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">segmented_write</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span>
					     <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">,</span>
					     <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OP_XMM</span>:
		<span class="n">write_sse_reg</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">vec_val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">xmm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OP_MM</span>:
		<span class="n">write_mmx_reg</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">mm_val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OP_NONE</span>:
		<span class="cm">/* no writeback */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">register_address_increment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">],</span> <span class="o">-</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">register_address</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">]);</span>
	<span class="n">addr</span><span class="p">.</span><span class="n">seg</span> <span class="o">=</span> <span class="n">VCPU_SREG_SS</span><span class="p">;</span>

	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">segmented_write</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">segmented_address</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">register_address</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">]);</span>
	<span class="n">addr</span><span class="p">.</span><span class="n">seg</span> <span class="o">=</span> <span class="n">VCPU_SREG_SS</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">segmented_read</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">register_address_increment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_popf</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="n">change_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iopl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_IOPL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IOPL_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpl</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">change_mask</span> <span class="o">=</span> <span class="n">EFLG_CF</span> <span class="o">|</span> <span class="n">EFLG_PF</span> <span class="o">|</span> <span class="n">EFLG_AF</span> <span class="o">|</span> <span class="n">EFLG_ZF</span> <span class="o">|</span> <span class="n">EFLG_SF</span> <span class="o">|</span> <span class="n">EFLG_OF</span>
		<span class="o">|</span> <span class="n">EFLG_TF</span> <span class="o">|</span> <span class="n">EFLG_DF</span> <span class="o">|</span> <span class="n">EFLG_NT</span> <span class="o">|</span> <span class="n">EFLG_RF</span> <span class="o">|</span> <span class="n">EFLG_AC</span> <span class="o">|</span> <span class="n">EFLG_ID</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT64</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT32</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">change_mask</span> <span class="o">|=</span> <span class="n">EFLG_IOPL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpl</span> <span class="o">&lt;=</span> <span class="n">iopl</span><span class="p">)</span>
			<span class="n">change_mask</span> <span class="o">|=</span> <span class="n">EFLG_IF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_VM86</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iopl</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">change_mask</span> <span class="o">|=</span> <span class="n">EFLG_IF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* real mode */</span>
		<span class="n">change_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">EFLG_IOPL</span> <span class="o">|</span> <span class="n">EFLG_IF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">change_mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">change_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_popf</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">emulate_popf</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_push_sreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_pop_sreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">selector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selector</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">selector</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_pusha</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_esp</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">VCPU_REGS_RAX</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">VCPU_REGS_RDI</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">VCPU_REGS_RSP</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">old_esp</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="o">++</span><span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_pushf</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span>  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_popa</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">VCPU_REGS_RDI</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">VCPU_REGS_RAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">VCPU_REGS_RSP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">register_address_increment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">],</span>
							<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
			<span class="o">--</span><span class="n">reg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">],</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="o">--</span><span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">emulate_int_real</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_ptr</span> <span class="n">dt</span><span class="p">;</span>
	<span class="n">gva_t</span> <span class="n">cs_addr</span><span class="p">;</span>
	<span class="n">gva_t</span> <span class="n">eip_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cs</span><span class="p">,</span> <span class="n">eip</span><span class="p">;</span>

	<span class="cm">/* TODO: Add limit checks */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EFLG_IF</span> <span class="o">|</span> <span class="n">EFLG_TF</span> <span class="o">|</span> <span class="n">EFLG_AC</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_idt</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dt</span><span class="p">);</span>

	<span class="n">eip_addr</span> <span class="o">=</span> <span class="n">dt</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">cs_addr</span> <span class="o">=</span> <span class="n">dt</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">cs_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">eip_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">eip</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_REAL</span>:
		<span class="k">return</span> <span class="n">emulate_int_real</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_VM86</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT16</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT32</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT64</span>:
	<span class="nl">default:</span>
		<span class="cm">/* Protected mode interrupts unimplemented yet */</span>
		<span class="k">return</span> <span class="n">X86EMUL_UNHANDLEABLE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_iret_real</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">temp_eip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">temp_eflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">EFLG_CF</span> <span class="o">|</span> <span class="n">EFLG_PF</span> <span class="o">|</span> <span class="n">EFLG_AF</span> <span class="o">|</span> <span class="n">EFLG_ZF</span> <span class="o">|</span> <span class="n">EFLG_SF</span> <span class="o">|</span> <span class="n">EFLG_TF</span> <span class="o">|</span>
			     <span class="n">EFLG_IF</span> <span class="o">|</span> <span class="n">EFLG_DF</span> <span class="o">|</span> <span class="n">EFLG_OF</span> <span class="o">|</span> <span class="n">EFLG_IOPL</span> <span class="o">|</span> <span class="n">EFLG_NT</span> <span class="o">|</span> <span class="n">EFLG_RF</span> <span class="o">|</span>
			     <span class="n">EFLG_AC</span> <span class="o">|</span> <span class="n">EFLG_ID</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Last one is the reserved bit */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vm86_mask</span> <span class="o">=</span> <span class="n">EFLG_VM</span> <span class="o">|</span> <span class="n">EFLG_VIF</span> <span class="o">|</span> <span class="n">EFLG_VIP</span><span class="p">;</span>

	<span class="cm">/* TODO: Add stack limit check */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_eip</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_eip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_eflags</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">cs</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">temp_eip</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp_eflags</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">vm86_mask</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">temp_eflags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EFLG_RESERVED_ZEROS_MASK</span><span class="p">;</span> <span class="cm">/* Clear reserved zeros */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">EFLG_RESERVED_ONE_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_iret</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_REAL</span>:
		<span class="k">return</span> <span class="n">emulate_iret_real</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_VM86</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT16</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT32</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT64</span>:
	<span class="nl">default:</span>
		<span class="cm">/* iret from protected mode unimplemented yet */</span>
		<span class="k">return</span> <span class="n">X86EMUL_UNHANDLEABLE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_jmp_far</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sel</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">valptr</span> <span class="o">+</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">valptr</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_grp2</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* rol */</span>
		<span class="n">emulate_2op_SrcB</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;rol&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* ror */</span>
		<span class="n">emulate_2op_SrcB</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;ror&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* rcl */</span>
		<span class="n">emulate_2op_SrcB</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;rcl&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* rcr */</span>
		<span class="n">emulate_2op_SrcB</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;rcr&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* sal/shl */</span>
	<span class="k">case</span> <span class="mi">6</span>:	<span class="cm">/* sal/shl */</span>
		<span class="n">emulate_2op_SrcB</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;sal&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* shr */</span>
		<span class="n">emulate_2op_SrcB</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;shr&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:	<span class="cm">/* sar */</span>
		<span class="n">emulate_2op_SrcB</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;sar&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_not</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_neg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_1op</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;neg&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_mul_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">emulate_1op_rax_rdx</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;mul&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_imul_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">emulate_1op_rax_rdx</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;imul&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_div_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">de</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">emulate_1op_rax_rdx</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;div&quot;</span><span class="p">,</span> <span class="n">de</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_de</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_idiv_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">de</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">emulate_1op_rax_rdx</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;idiv&quot;</span><span class="p">,</span> <span class="n">de</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_de</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_grp45</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* inc */</span>
		<span class="n">emulate_1op</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;inc&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* dec */</span>
		<span class="n">emulate_1op</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;dec&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* call near abs */</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="kt">int</span> <span class="n">old_eip</span><span class="p">;</span>
		<span class="n">old_eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">old_eip</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* jmp abs */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* jmp far */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em_jmp_far</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:	<span class="cm">/* push */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_cmpxchg8b</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">old</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">orig_val64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">old</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">old</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">old</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">old</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EFLG_ZF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val64</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBX</span><span class="p">];</span>

		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">EFLG_ZF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_ret</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">em_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_ret_far</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cs</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">cs</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_cmpxchg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Save real source value, then compare EAX against destination. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">orig_val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">];</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;cmp&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">EFLG_ZF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Success: write back to memory. */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">orig_val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Failure: write the value we saw to EAX. */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_lseg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">valptr</span> <span class="o">+</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setup_syscalls_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">selector</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span><span class="p">));</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selector</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span><span class="p">));</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* will be adjusted later */</span>
	<span class="n">set_desc_base</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* flat segment */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 4kb granularity */</span>
	<span class="n">set_desc_limit</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0xfffff</span><span class="p">);</span>	<span class="cm">/* 4GB limit */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>	<span class="cm">/* Read, Execute, Accessed */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dpl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* will be adjusted later */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">set_desc_base</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* flat segment */</span>
	<span class="n">set_desc_limit</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="mh">0xfffff</span><span class="p">);</span>	<span class="cm">/* 4GB limit */</span>
	<span class="n">ss</span><span class="o">-&gt;</span><span class="n">g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 4kb granularity */</span>
	<span class="n">ss</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ss</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="cm">/* Read/Write, Accessed */</span>
	<span class="n">ss</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 32bit stack segment */</span>
	<span class="n">ss</span><span class="o">-&gt;</span><span class="n">dpl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ss</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">vendor_intel</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span><span class="p">;</span>

	<span class="n">eax</span> <span class="o">=</span> <span class="n">ecx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cpuid</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="n">ebx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_GenuineIntel_ebx</span>
		<span class="o">&amp;&amp;</span> <span class="n">ecx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_GenuineIntel_ecx</span>
		<span class="o">&amp;&amp;</span> <span class="n">edx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_GenuineIntel_edx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">em_syscall_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * syscall should always be enabled in longmode - so only become</span>
<span class="cm">	 * vendor specific (cpuid) if other modes are active...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">eax</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">ecx</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cpuid</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Intel (&quot;GenuineIntel&quot;)</span>
<span class="cm">		 * remark: Intel CPUs only support &quot;syscall&quot; in 64bit</span>
<span class="cm">		 * longmode. Also an 64bit guest with a</span>
<span class="cm">		 * 32bit compat-app running will #UD !! While this</span>
<span class="cm">		 * behaviour can be fixed (by emulating) into AMD</span>
<span class="cm">		 * response - CPUs of AMD can&#39;t behave like Intel.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ebx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_GenuineIntel_ebx</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ecx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_GenuineIntel_ecx</span> <span class="o">&amp;&amp;</span>
		    <span class="n">edx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_GenuineIntel_edx</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* AMD (&quot;AuthenticAMD&quot;) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ebx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_AuthenticAMD_ebx</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ecx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_AuthenticAMD_ecx</span> <span class="o">&amp;&amp;</span>
		    <span class="n">edx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_AuthenticAMD_edx</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/* AMD (&quot;AMDisbetter!&quot;) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ebx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_AMDisbetterI_ebx</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ecx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_AMDisbetterI_ecx</span> <span class="o">&amp;&amp;</span>
		    <span class="n">edx</span> <span class="o">==</span> <span class="n">X86EMUL_CPUID_VENDOR_AMDisbetterI_edx</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* default: (not Intel, not AMD), apply Intel&#39;s stricter rules... */</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_syscall</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">cs</span><span class="p">,</span> <span class="n">ss</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">msr_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cs_sel</span><span class="p">,</span> <span class="n">ss_sel</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">efer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* syscall is not available in real mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_REAL</span> <span class="o">||</span>
	    <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_VM86</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">em_syscall_is_enabled</span><span class="p">(</span><span class="n">ctxt</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_EFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efer</span><span class="p">);</span>
	<span class="n">setup_syscalls_segments</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_SCE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_STAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">);</span>
	<span class="n">msr_data</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cs_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">msr_data</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">);</span>
	<span class="n">ss_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">msr_data</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">cs_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ss_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LMA</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R11</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EFLG_RF</span><span class="p">;</span>

		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span>
			     <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span> <span class="o">?</span>
			     <span class="n">MSR_LSTAR</span> <span class="o">:</span> <span class="n">MSR_CSTAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">);</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">msr_data</span><span class="p">;</span>

		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_SYSCALL_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">);</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">msr_data</span> <span class="o">|</span> <span class="n">EFLG_RF</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* legacy mode */</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_STAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">);</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">msr_data</span><span class="p">;</span>

		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EFLG_VM</span> <span class="o">|</span> <span class="n">EFLG_IF</span> <span class="o">|</span> <span class="n">EFLG_RF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_sysenter</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">cs</span><span class="p">,</span> <span class="n">ss</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">msr_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cs_sel</span><span class="p">,</span> <span class="n">ss_sel</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">efer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_EFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efer</span><span class="p">);</span>
	<span class="cm">/* inject #GP if in real mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_REAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Not recognized on AMD in compat mode (but is recognized in legacy</span>
<span class="cm">	 * mode).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LMA</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vendor_intel</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="cm">/* XXX sysenter/sysexit have not been tested in 64bit mode.</span>
<span class="cm">	* Therefore, we inject an #UD.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="n">setup_syscalls_segments</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_IA32_SYSENTER_CS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT32</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">msr_data</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT64</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">msr_data</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EFLG_VM</span> <span class="o">|</span> <span class="n">EFLG_IF</span> <span class="o">|</span> <span class="n">EFLG_RF</span><span class="p">);</span>
	<span class="n">cs_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">msr_data</span><span class="p">;</span>
	<span class="n">cs_sel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SELECTOR_RPL_MASK</span><span class="p">;</span>
	<span class="n">ss_sel</span> <span class="o">=</span> <span class="n">cs_sel</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ss_sel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SELECTOR_RPL_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span> <span class="o">||</span> <span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">cs_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ss_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_IA32_SYSENTER_EIP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">);</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">msr_data</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_IA32_SYSENTER_ESP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">);</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">]</span> <span class="o">=</span> <span class="n">msr_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_sysexit</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">cs</span><span class="p">,</span> <span class="n">ss</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">msr_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usermode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cs_sel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ss_sel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* inject #GP if in real mode or Virtual 8086 mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_REAL</span> <span class="o">||</span>
	    <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_VM86</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">setup_syscalls_segments</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span>
		<span class="n">usermode</span> <span class="o">=</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">usermode</span> <span class="o">=</span> <span class="n">X86EMUL_MODE_PROT32</span><span class="p">;</span>

	<span class="n">cs</span><span class="p">.</span><span class="n">dpl</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ss</span><span class="p">.</span><span class="n">dpl</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_IA32_SYSENTER_CS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">usermode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT32</span>:
		<span class="n">cs_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">msr_data</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">msr_data</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ss_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">msr_data</span> <span class="o">+</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT64</span>:
		<span class="n">cs_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">msr_data</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr_data</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ss_sel</span> <span class="o">=</span> <span class="n">cs_sel</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs_sel</span> <span class="o">|=</span> <span class="n">SELECTOR_RPL_MASK</span><span class="p">;</span>
	<span class="n">ss_sel</span> <span class="o">|=</span> <span class="n">SELECTOR_RPL_MASK</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">cs_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ss_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">];</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">emulator_bad_iopl</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iopl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_REAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_VM86</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">iopl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_IOPL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IOPL_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iopl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">emulator_io_port_access_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
					    <span class="n">u16</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">tr_seg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tr</span><span class="p">,</span> <span class="n">io_bitmap_ptr</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">bit_idx</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr_seg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base3</span><span class="p">,</span> <span class="n">VCPU_SREG_TR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tr_seg</span><span class="p">.</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc_limit_scaled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr_seg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">103</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">get_desc_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr_seg</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">base</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">base3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">102</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_bitmap_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_bitmap_ptr</span> <span class="o">+</span> <span class="n">port</span><span class="o">/</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">desc_limit_scaled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr_seg</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">io_bitmap_ptr</span> <span class="o">+</span> <span class="n">port</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">perm</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">perm</span> <span class="o">&gt;&gt;</span> <span class="n">bit_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">emulator_io_permited</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">port</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">perm_ok</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emulator_bad_iopl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emulator_io_port_access_allowed</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">perm_ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">save_state_to_tss16</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tss_segment_16</span> <span class="o">*</span><span class="n">tss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">;</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">dx</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">bx</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBX</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">bp</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBP</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">si</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSI</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">di</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">];</span>

	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">es</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_ES</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ss</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ds</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_DS</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ldt</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_LDTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_state_from_tss16</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tss_segment_16</span> <span class="o">*</span><span class="n">tss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ax</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">bx</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBP</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSI</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SDM says that segment selectors are loaded before segment</span>
<span class="cm">	 * descriptors</span>
<span class="cm">	 */</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">,</span> <span class="n">VCPU_SREG_LDTR</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">,</span> <span class="n">VCPU_SREG_ES</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">,</span> <span class="n">VCPU_SREG_DS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now load segment descriptors. If fault happenes at this stage</span>
<span class="cm">	 * it is handled in a context of new task</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">,</span> <span class="n">VCPU_SREG_LDTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">,</span> <span class="n">VCPU_SREG_ES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">,</span> <span class="n">VCPU_SREG_DS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">task_switch_16</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="n">u16</span> <span class="n">old_tss_sel</span><span class="p">,</span>
			  <span class="n">ulong</span> <span class="n">old_tss_base</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">new_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tss_segment_16</span> <span class="n">tss_seg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_tss_base</span> <span class="o">=</span> <span class="n">get_desc_base</span><span class="p">(</span><span class="n">new_desc</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">old_tss_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tss_seg</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="cm">/* FIXME: need to provide precise fault address */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">save_state_to_tss16</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">old_tss_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tss_seg</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="cm">/* FIXME: need to provide precise fault address */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">new_tss_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tss_seg</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="cm">/* FIXME: need to provide precise fault address */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_tss_sel</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tss_seg</span><span class="p">.</span><span class="n">prev_task_link</span> <span class="o">=</span> <span class="n">old_tss_sel</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">new_tss_base</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">.</span><span class="n">prev_task_link</span><span class="p">,</span>
				     <span class="k">sizeof</span> <span class="n">tss_seg</span><span class="p">.</span><span class="n">prev_task_link</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="cm">/* FIXME: need to provide precise fault address */</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">load_state_from_tss16</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">save_state_to_tss32</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tss_segment_32</span> <span class="o">*</span><span class="n">tss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">cr3</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">;</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBX</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">esp</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ebp</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBP</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">esi</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSI</span><span class="p">];</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">edi</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">];</span>

	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">es</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_ES</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ss</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ds</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_DS</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">fs</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_FS</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">gs</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_GS</span><span class="p">);</span>
	<span class="n">tss</span><span class="o">-&gt;</span><span class="n">ldt_selector</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_LDTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_state_from_tss32</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tss_segment_32</span> <span class="o">*</span><span class="n">tss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">cr3</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">eip</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* General purpose registers */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">eax</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ecx</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">edx</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ebx</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">esp</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBP</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ebp</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSI</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">]</span> <span class="o">=</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">edi</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SDM says that segment selectors are loaded before segment</span>
<span class="cm">	 * descriptors</span>
<span class="cm">	 */</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ldt_selector</span><span class="p">,</span> <span class="n">VCPU_SREG_LDTR</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">,</span> <span class="n">VCPU_SREG_ES</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">,</span> <span class="n">VCPU_SREG_DS</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span> <span class="n">VCPU_SREG_FS</span><span class="p">);</span>
	<span class="n">set_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">,</span> <span class="n">VCPU_SREG_GS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re switching between Protected Mode and VM86, we need to make</span>
<span class="cm">	 * sure to update the mode before loading the segment descriptors so</span>
<span class="cm">	 * that the selectors are interpreted correctly.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Need to get rflags to the vcpu struct immediately because it</span>
<span class="cm">	 * influences the CPL which is checked at least when loading the segment</span>
<span class="cm">	 * descriptors and when pushing an error code to the new kernel stack.</span>
<span class="cm">	 *</span>
<span class="cm">	 * TODO Introduce a separate ctxt-&gt;ops-&gt;set_cpl callback</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_VM</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">X86EMUL_MODE_VM86</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">X86EMUL_MODE_PROT32</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rflags</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now load segment descriptors. If fault happenes at this stage</span>
<span class="cm">	 * it is handled in a context of new task</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ldt_selector</span><span class="p">,</span> <span class="n">VCPU_SREG_LDTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">,</span> <span class="n">VCPU_SREG_ES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">,</span> <span class="n">VCPU_SREG_SS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">,</span> <span class="n">VCPU_SREG_DS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span> <span class="n">VCPU_SREG_FS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">,</span> <span class="n">VCPU_SREG_GS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">task_switch_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="n">u16</span> <span class="n">old_tss_sel</span><span class="p">,</span>
			  <span class="n">ulong</span> <span class="n">old_tss_base</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">new_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tss_segment_32</span> <span class="n">tss_seg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_tss_base</span> <span class="o">=</span> <span class="n">get_desc_base</span><span class="p">(</span><span class="n">new_desc</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">old_tss_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tss_seg</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="cm">/* FIXME: need to provide precise fault address */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">save_state_to_tss32</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">old_tss_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tss_seg</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="cm">/* FIXME: need to provide precise fault address */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">new_tss_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tss_seg</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="cm">/* FIXME: need to provide precise fault address */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_tss_sel</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tss_seg</span><span class="p">.</span><span class="n">prev_task_link</span> <span class="o">=</span> <span class="n">old_tss_sel</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_std</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">new_tss_base</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">.</span><span class="n">prev_task_link</span><span class="p">,</span>
				     <span class="k">sizeof</span> <span class="n">tss_seg</span><span class="p">.</span><span class="n">prev_task_link</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">exception</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="cm">/* FIXME: need to provide precise fault address */</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">load_state_from_tss32</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tss_seg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulator_do_task_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idt_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="n">has_error_code</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">curr_tss_desc</span><span class="p">,</span> <span class="n">next_tss_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">old_tss_sel</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_TR</span><span class="p">);</span>
	<span class="n">ulong</span> <span class="n">old_tss_base</span> <span class="o">=</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cached_segment_base</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_TR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">desc_limit</span><span class="p">;</span>

	<span class="cm">/* FIXME: old_tss_base == ~0 ? */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_tss_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">old_tss_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curr_tss_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* FIXME: check that next_tss_desc is tss */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check privileges. The three cases are task switch caused by...</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1. jmp/call/int to task gate: Check against DPL of the task gate</span>
<span class="cm">	 * 2. Exception/IRQ/iret: No check is performed</span>
<span class="cm">	 * 3. jmp/call to TSS: Check agains DPL of the TSS</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">TASK_SWITCH_GATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idt_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Software interrupts */</span>
			<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">task_gate_desc</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">dpl</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">read_interrupt_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">idt_index</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">task_gate_desc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">dpl</span> <span class="o">=</span> <span class="n">task_gate_desc</span><span class="p">.</span><span class="n">dpl</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tss_selector</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dpl</span> <span class="o">||</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dpl</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="p">(</span><span class="n">idt_index</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">TASK_SWITCH_IRET</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dpl</span> <span class="o">=</span> <span class="n">next_tss_desc</span><span class="p">.</span><span class="n">dpl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tss_selector</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dpl</span> <span class="o">||</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dpl</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss_selector</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">desc_limit</span> <span class="o">=</span> <span class="n">desc_limit_scaled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next_tss_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_tss_desc</span><span class="p">.</span><span class="n">p</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">desc_limit</span> <span class="o">&lt;</span> <span class="mh">0x67</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">next_tss_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">||</span>
	     <span class="n">desc_limit</span> <span class="o">&lt;</span> <span class="mh">0x2b</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">emulate_ts</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss_selector</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">X86EMUL_PROPAGATE_FAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">TASK_SWITCH_IRET</span> <span class="o">||</span> <span class="n">reason</span> <span class="o">==</span> <span class="n">TASK_SWITCH_JMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">curr_tss_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* clear busy flag */</span>
		<span class="n">write_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">old_tss_sel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curr_tss_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">TASK_SWITCH_IRET</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">X86_EFLAGS_NT</span><span class="p">;</span>

	<span class="cm">/* set back link to prev task only if NT bit is set in eflags</span>
<span class="cm">	   note that old_tss_sel is not used afetr this point */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">TASK_SWITCH_CALL</span> <span class="o">&amp;&amp;</span> <span class="n">reason</span> <span class="o">!=</span> <span class="n">TASK_SWITCH_GATE</span><span class="p">)</span>
		<span class="n">old_tss_sel</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_tss_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">task_switch_32</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="n">old_tss_sel</span><span class="p">,</span>
				     <span class="n">old_tss_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_tss_desc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">task_switch_16</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="n">old_tss_sel</span><span class="p">,</span>
				     <span class="n">old_tss_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_tss_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">TASK_SWITCH_CALL</span> <span class="o">||</span> <span class="n">reason</span> <span class="o">==</span> <span class="n">TASK_SWITCH_GATE</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|</span> <span class="n">X86_EFLAGS_NT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">TASK_SWITCH_IRET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next_tss_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* set busy flag */</span>
		<span class="n">write_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_tss_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">X86_CR0_TS</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_segment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_tss_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCPU_SREG_TR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_error_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_tss_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">lock_prefix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">error_code</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">emulator_task_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idt_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span>
			 <span class="n">bool</span> <span class="n">has_error_code</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eip</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulator_do_task_switch</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="n">idt_index</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span>
				     <span class="n">has_error_code</span><span class="p">,</span> <span class="n">error_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">X86EMUL_UNHANDLEABLE</span><span class="p">)</span> <span class="o">?</span> <span class="n">EMULATION_FAILED</span> <span class="o">:</span> <span class="n">EMULATION_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">string_addr_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">seg</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">EFLG_DF</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">register_address_increment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">],</span> <span class="n">df</span> <span class="o">*</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">register_address</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]);</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">seg</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_das</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">al</span><span class="p">,</span> <span class="n">old_al</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">af</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">old_cf</span><span class="p">;</span>

	<span class="n">cf</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_CF</span><span class="p">;</span>
	<span class="n">al</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

	<span class="n">old_al</span> <span class="o">=</span> <span class="n">al</span><span class="p">;</span>
	<span class="n">old_cf</span> <span class="o">=</span> <span class="n">cf</span><span class="p">;</span>
	<span class="n">cf</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">af</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_AF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">al</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="o">||</span> <span class="n">af</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">al</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">cf</span> <span class="o">=</span> <span class="n">old_cf</span> <span class="o">|</span> <span class="p">(</span><span class="n">al</span> <span class="o">&gt;=</span> <span class="mi">250</span><span class="p">);</span>
		<span class="n">af</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">af</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_al</span> <span class="o">&gt;</span> <span class="mh">0x99</span> <span class="o">||</span> <span class="n">old_cf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">al</span> <span class="o">-=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">cf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">al</span><span class="p">;</span>
	<span class="cm">/* Set PF, ZF, SF */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_IMM</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;or&quot;</span><span class="p">);</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">X86_EFLAGS_AF</span> <span class="o">|</span> <span class="n">X86_EFLAGS_CF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">X86_EFLAGS_CF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">af</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">X86_EFLAGS_AF</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">rel</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="n">jmp_rel</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">rel</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_call_far</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sel</span><span class="p">,</span> <span class="n">old_cs</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">old_eip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">old_cs</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">);</span>
	<span class="n">old_eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sel</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">valptr</span> <span class="o">+</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">VCPU_SREG_CS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">valptr</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">old_cs</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">old_eip</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">em_push</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_ret_near_imm</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_pop</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">register_address_increment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">],</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;add&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_or</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;or&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;adc&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_sbb</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;sbb&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_and</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;and&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_sub</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;sub&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_xor</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;xor&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;cmp&quot;</span><span class="p">);</span>
	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">);</span>
	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_xchg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Write back the register source. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="n">write_register_operand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>

	<span class="cm">/* Write back the memory destination with implicit LOCK prefix. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">orig_val</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">lock_prefix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_imul</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV_nobyte</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;imul&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_imul_3op</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">em_imul</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_cwd</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">];</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_rdtsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tsc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_IA32_TSC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsc</span><span class="p">);</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tsc</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsc</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_rdpmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">pmc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_pmc</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pmc</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmc</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_mov</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">valptr</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">valptr</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_cr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_dr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>

	<span class="cm">/* #UD condition is already handled. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_dr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_wrmsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">msr_data</span><span class="p">;</span>

	<span class="n">msr_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">],</span> <span class="n">msr_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_rdmsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">msr_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">msr_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">msr_data</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">msr_data</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_mov_rm_sreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span> <span class="o">&gt;</span> <span class="n">VCPU_SREG_GS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">get_segment_selector</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_mov_sreg_rm</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sel</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span> <span class="o">==</span> <span class="n">VCPU_SREG_CS</span> <span class="o">||</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span> <span class="o">&gt;</span> <span class="n">VCPU_SREG_GS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span> <span class="o">==</span> <span class="n">VCPU_SREG_SS</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">interruptibility</span> <span class="o">=</span> <span class="n">KVM_X86_SHADOW_INT_MOV_SS</span><span class="p">;</span>

	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">load_segment_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_invlpg</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">linear</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">linearize</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linear</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">invlpg</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">linear</span><span class="p">);</span>
	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_clts</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">cr0</span><span class="p">;</span>

	<span class="n">cr0</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">X86_CR0_TS</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cr0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_vmcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_mod</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_rm</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">X86EMUL_UNHANDLEABLE</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fix_hypercall</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Let the processor re-execute the fixed hypercall */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eip</span><span class="p">;</span>
	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_lgdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">desc_ptr</span> <span class="n">desc_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">read_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">desc_ptr</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc_ptr</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
			     <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_gdt</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc_ptr</span><span class="p">);</span>
	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_vmmcall</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fix_hypercall</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_lidt</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">desc_ptr</span> <span class="n">desc_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">read_descriptor</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">desc_ptr</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc_ptr</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
			     <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_idt</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc_ptr</span><span class="p">);</span>
	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_smsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_lmsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0eul</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_loop</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_address_increment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">address_mask</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xe2</span> <span class="o">||</span> <span class="n">test_cc</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">^</span> <span class="mh">0x5</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">)))</span>
		<span class="n">jmp_rel</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_jcxz</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address_mask</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">jmp_rel</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pio_in_emulated</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">X86EMUL_IO_NEEDED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pio_out_emulated</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_cli</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emulator_bad_iopl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">X86_EFLAGS_IF</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_sti</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emulator_bad_iopl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">interruptibility</span> <span class="o">=</span> <span class="n">KVM_X86_SHADOW_INT_STI</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">X86_EFLAGS_IF</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_bt</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable writeback. */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="cm">/* only subword offset */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">emulate_2op_SrcV_nobyte</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;bt&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_bts</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV_nobyte</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;bts&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_btr</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV_nobyte</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;btr&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_btc</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV_nobyte</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;btc&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_bsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV_nobyte</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;bsf&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">em_bsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emulate_2op_SrcV_nobyte</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;bsr&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">valid_cr</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">2</span> <span class="p">...</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_cr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_cr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">new_val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">efer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">static</span> <span class="n">u64</span> <span class="n">cr_reserved_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xffffffff00000000ULL</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* CR3 checked later */</span>
		<span class="n">CR4_RESERVED_BITS</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CR8_RESERVED_BITS</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_cr</span><span class="p">(</span><span class="n">cr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="n">cr_reserved_bits</span><span class="p">[</span><span class="n">cr</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="p">{</span>
		<span class="n">u64</span> <span class="n">cr4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="n">X86_CR0_PG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="n">X86_CR0_PE</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="n">X86_CR0_NW</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="n">X86_CR0_CD</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">cr4</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_EFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="n">X86_CR0_PG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">cr4</span> <span class="o">&amp;</span> <span class="n">X86_CR4_PAE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="p">{</span>
		<span class="n">u64</span> <span class="n">rsvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_EFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LMA</span><span class="p">)</span>
			<span class="n">rsvd</span> <span class="o">=</span> <span class="n">CR3_L_MODE_RESERVED_BITS</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_CR4_PAE</span><span class="p">)</span>
			<span class="n">rsvd</span> <span class="o">=</span> <span class="n">CR3_PAE_RESERVED_BITS</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_CR0_PG</span><span class="p">)</span>
			<span class="n">rsvd</span> <span class="o">=</span> <span class="n">CR3_NONPAE_RESERVED_BITS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="n">rsvd</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="p">{</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_EFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="n">X86_CR4_PAE</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_dr7_gd</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dr7</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_dr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dr7</span><span class="p">);</span>

	<span class="cm">/* Check if DR7.Global_Enable is set */</span>
	<span class="k">return</span> <span class="n">dr7</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_dr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dr</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cr4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dr</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="n">cr4</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cr4</span> <span class="o">&amp;</span> <span class="n">X86_CR4_DE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dr</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">dr</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_dr7_gd</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_db</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_dr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">new_val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dr</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dr</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">dr</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">new_val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000ULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">check_dr_read</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_svme</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">efer</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_msr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MSR_EFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_SVME</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_svme_pa</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">rax</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">];</span>

	<span class="cm">/* Valid physical address? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rax</span> <span class="o">&amp;</span> <span class="mh">0xffff000000000000ULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">check_svme</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_rdtsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">cr4</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr4</span> <span class="o">&amp;</span> <span class="n">X86_CR4_TSD</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_rdpmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">cr4</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">rcx</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">cr4</span> <span class="o">&amp;</span> <span class="n">X86_CR4_PCE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rcx</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_perm_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">4u</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emulator_io_permited</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_perm_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">4u</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">emulator_io_permited</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define D(_y) { .flags = (_y) }</span>
<span class="cp">#define DI(_y, _i) { .flags = (_y), .intercept = x86_intercept_##_i }</span>
<span class="cp">#define DIP(_y, _i, _p) { .flags = (_y), .intercept = x86_intercept_##_i, \</span>
<span class="cp">		      .check_perm = (_p) }</span>
<span class="cp">#define N    D(0)</span>
<span class="cp">#define EXT(_f, _e) { .flags = ((_f) | RMExt), .u.group = (_e) }</span>
<span class="cp">#define G(_f, _g) { .flags = ((_f) | Group | ModRM), .u.group = (_g) }</span>
<span class="cp">#define GD(_f, _g) { .flags = ((_f) | GroupDual | ModRM), .u.gdual = (_g) }</span>
<span class="cp">#define I(_f, _e) { .flags = (_f), .u.execute = (_e) }</span>
<span class="cp">#define II(_f, _e, _i) \</span>
<span class="cp">	{ .flags = (_f), .u.execute = (_e), .intercept = x86_intercept_##_i }</span>
<span class="cp">#define IIP(_f, _e, _i, _p) \</span>
<span class="cp">	{ .flags = (_f), .u.execute = (_e), .intercept = x86_intercept_##_i, \</span>
<span class="cp">	  .check_perm = (_p) }</span>
<span class="cp">#define GP(_f, _g) { .flags = ((_f) | Prefix), .u.gprefix = (_g) }</span>

<span class="cp">#define D2bv(_f)      D((_f) | ByteOp), D(_f)</span>
<span class="cp">#define D2bvIP(_f, _i, _p) DIP((_f) | ByteOp, _i, _p), DIP(_f, _i, _p)</span>
<span class="cp">#define I2bv(_f, _e)  I((_f) | ByteOp, _e), I(_f, _e)</span>
<span class="cp">#define I2bvIP(_f, _e, _i, _p) \</span>
<span class="cp">	IIP((_f) | ByteOp, _e, _i, _p), IIP(_f, _e, _i, _p)</span>

<span class="cp">#define I6ALU(_f, _e) I2bv((_f) | DstMem | SrcReg | ModRM, _e),		\</span>
<span class="cp">		I2bv(((_f) | DstReg | SrcMem | ModRM) &amp; ~Lock, _e),	\</span>
<span class="cp">		I2bv(((_f) &amp; ~Lock) | DstAcc | SrcImm, _e)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group7_rm1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span> <span class="n">monitor</span><span class="p">),</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span> <span class="n">mwait</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group7_rm3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">vmrun</span><span class="p">,</span>		<span class="n">check_svme_pa</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">SrcNone</span>  <span class="o">|</span> <span class="n">Prot</span> <span class="o">|</span> <span class="n">VendorSpecific</span><span class="p">,</span>	<span class="n">em_vmmcall</span><span class="p">,</span>	<span class="n">vmmcall</span><span class="p">),</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">vmload</span><span class="p">,</span>		<span class="n">check_svme_pa</span><span class="p">),</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">vmsave</span><span class="p">,</span>		<span class="n">check_svme_pa</span><span class="p">),</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">stgi</span><span class="p">,</span>		<span class="n">check_svme</span><span class="p">),</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">clgi</span><span class="p">,</span>		<span class="n">check_svme</span><span class="p">),</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">skinit</span><span class="p">,</span>		<span class="n">check_svme</span><span class="p">),</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">invlpga</span><span class="p">,</span>	<span class="n">check_svme</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group7_rm7</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">N</span><span class="p">,</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">SrcNone</span><span class="p">,</span> <span class="n">rdtscp</span><span class="p">,</span> <span class="n">check_rdtsc</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_add</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_or</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_adc</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_sbb</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_and</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_sub</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_xor</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">em_cmp</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group1A</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_pop</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImm</span><span class="p">,</span> <span class="n">em_test</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImm</span><span class="p">,</span> <span class="n">em_test</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">em_not</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">em_neg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMem</span><span class="p">,</span> <span class="n">em_mul_ex</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMem</span><span class="p">,</span> <span class="n">em_imul_ex</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMem</span><span class="p">,</span> <span class="n">em_div_ex</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMem</span><span class="p">,</span> <span class="n">em_idiv_ex</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ByteOp</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">em_grp45</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ByteOp</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">em_grp45</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group5</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">,</span>		<span class="n">em_grp45</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">,</span>		<span class="n">em_grp45</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMem</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span>			<span class="n">em_grp45</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMemFAddr</span> <span class="o">|</span> <span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span>	<span class="n">em_call_far</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMem</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span>			<span class="n">em_grp45</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMemFAddr</span> <span class="o">|</span> <span class="n">ImplicitOps</span><span class="p">,</span>		<span class="n">em_grp45</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcMem</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span>			<span class="n">em_grp45</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group6</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">Prot</span><span class="p">,</span>	<span class="n">sldt</span><span class="p">),</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">Prot</span><span class="p">,</span>	<span class="n">str</span><span class="p">),</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>	<span class="n">lldt</span><span class="p">),</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">Prot</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>	<span class="n">ltr</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">group_dual</span> <span class="n">group7</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">Mov</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>			<span class="n">sgdt</span><span class="p">),</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">Mov</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>			<span class="n">sidt</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">SrcMem</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>			<span class="n">em_lgdt</span><span class="p">,</span> <span class="n">lgdt</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">SrcMem</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>			<span class="n">em_lidt</span><span class="p">,</span> <span class="n">lidt</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">,</span>		<span class="n">em_smsw</span><span class="p">,</span> <span class="n">smsw</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">II</span><span class="p">(</span><span class="n">SrcMem16</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">em_lmsw</span><span class="p">,</span> <span class="n">lmsw</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">SrcMem</span> <span class="o">|</span> <span class="n">ByteOp</span> <span class="o">|</span> <span class="n">Priv</span> <span class="o">|</span> <span class="n">NoAccess</span><span class="p">,</span>	<span class="n">em_invlpg</span><span class="p">,</span> <span class="n">invlpg</span><span class="p">),</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">Priv</span> <span class="o">|</span> <span class="n">VendorSpecific</span><span class="p">,</span>	<span class="n">em_vmcall</span><span class="p">),</span>
	<span class="n">EXT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group7_rm1</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">EXT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group7_rm3</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">SrcNone</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">,</span>		<span class="n">em_smsw</span><span class="p">,</span> <span class="n">smsw</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">II</span><span class="p">(</span><span class="n">SrcMem16</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span>		<span class="n">em_lmsw</span><span class="p">,</span> <span class="n">lmsw</span><span class="p">),</span>
	<span class="n">EXT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group7_rm7</span><span class="p">),</span>
<span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group8</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImmByte</span><span class="p">,</span>				<span class="n">em_bt</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImmByte</span> <span class="o">|</span> <span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span>	<span class="n">em_bts</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImmByte</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">,</span>			<span class="n">em_btr</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImmByte</span> <span class="o">|</span> <span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span>	<span class="n">em_btc</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">group_dual</span> <span class="n">group9</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">I</span><span class="p">(</span><span class="n">DstMem64</span> <span class="o">|</span> <span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_cmpxchg8b</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
<span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">group11</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImm</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
	<span class="n">X7</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">Undefined</span><span class="p">)),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gprefix</span> <span class="n">pfx_0f_6f_0f_7f</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Mmx</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span> <span class="n">I</span><span class="p">(</span><span class="n">Sse</span> <span class="o">|</span> <span class="n">Aligned</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">I</span><span class="p">(</span><span class="n">Sse</span> <span class="o">|</span> <span class="n">Unaligned</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gprefix</span> <span class="n">pfx_vmovntpx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">opcode_table</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x00 - 0x07 */</span>
	<span class="n">I6ALU</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_add</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2ES</span><span class="p">,</span> <span class="n">em_push_sreg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2ES</span><span class="p">,</span> <span class="n">em_pop_sreg</span><span class="p">),</span>
	<span class="cm">/* 0x08 - 0x0F */</span>
	<span class="n">I6ALU</span><span class="p">(</span><span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_or</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2CS</span><span class="p">,</span> <span class="n">em_push_sreg</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x10 - 0x17 */</span>
	<span class="n">I6ALU</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_adc</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2SS</span><span class="p">,</span> <span class="n">em_push_sreg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2SS</span><span class="p">,</span> <span class="n">em_pop_sreg</span><span class="p">),</span>
	<span class="cm">/* 0x18 - 0x1F */</span>
	<span class="n">I6ALU</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_sbb</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2DS</span><span class="p">,</span> <span class="n">em_push_sreg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2DS</span><span class="p">,</span> <span class="n">em_pop_sreg</span><span class="p">),</span>
	<span class="cm">/* 0x20 - 0x27 */</span>
	<span class="n">I6ALU</span><span class="p">(</span><span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_and</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x28 - 0x2F */</span>
	<span class="n">I6ALU</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_sub</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">I</span><span class="p">(</span><span class="n">ByteOp</span> <span class="o">|</span> <span class="n">DstAcc</span> <span class="o">|</span> <span class="n">No64</span><span class="p">,</span> <span class="n">em_das</span><span class="p">),</span>
	<span class="cm">/* 0x30 - 0x37 */</span>
	<span class="n">I6ALU</span><span class="p">(</span><span class="n">Lock</span><span class="p">,</span> <span class="n">em_xor</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x38 - 0x3F */</span>
	<span class="n">I6ALU</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">em_cmp</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x40 - 0x4F */</span>
	<span class="n">X16</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">DstReg</span><span class="p">)),</span>
	<span class="cm">/* 0x50 - 0x57 */</span>
	<span class="n">X8</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">SrcReg</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_push</span><span class="p">)),</span>
	<span class="cm">/* 0x58 - 0x5F */</span>
	<span class="n">X8</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_pop</span><span class="p">)),</span>
	<span class="cm">/* 0x60 - 0x67 */</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span><span class="p">,</span> <span class="n">em_pusha</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">No64</span><span class="p">,</span> <span class="n">em_popa</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem32</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">)</span> <span class="cm">/* movsxd (x86/64) */</span> <span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x68 - 0x6F */</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcImm</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_push</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Src2Imm</span><span class="p">,</span> <span class="n">em_imul_3op</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcImmByte</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_push</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Src2ImmByte</span><span class="p">,</span> <span class="n">em_imul_3op</span><span class="p">),</span>
	<span class="n">I2bvIP</span><span class="p">(</span><span class="n">DstDI</span> <span class="o">|</span> <span class="n">SrcDX</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">String</span><span class="p">,</span> <span class="n">em_in</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">check_perm_in</span><span class="p">),</span> <span class="cm">/* insb, insw/insd */</span>
	<span class="n">I2bvIP</span><span class="p">(</span><span class="n">SrcSI</span> <span class="o">|</span> <span class="n">DstDX</span> <span class="o">|</span> <span class="n">String</span><span class="p">,</span> <span class="n">em_out</span><span class="p">,</span> <span class="n">outs</span><span class="p">,</span> <span class="n">check_perm_out</span><span class="p">),</span> <span class="cm">/* outsb, outsw/outsd */</span>
	<span class="cm">/* 0x70 - 0x7F */</span>
	<span class="n">X16</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">SrcImmByte</span><span class="p">)),</span>
	<span class="cm">/* 0x80 - 0x87 */</span>
	<span class="n">G</span><span class="p">(</span><span class="n">ByteOp</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImm</span><span class="p">,</span> <span class="n">group1</span><span class="p">),</span>
	<span class="n">G</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImm</span><span class="p">,</span> <span class="n">group1</span><span class="p">),</span>
	<span class="n">G</span><span class="p">(</span><span class="n">ByteOp</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImm</span> <span class="o">|</span> <span class="n">No64</span><span class="p">,</span> <span class="n">group1</span><span class="p">),</span>
	<span class="n">G</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImmByte</span><span class="p">,</span> <span class="n">group1</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">,</span> <span class="n">em_test</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_xchg</span><span class="p">),</span>
	<span class="cm">/* 0x88 - 0x8F */</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_mov_rm_sreg</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">ModRM</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">NoAccess</span> <span class="o">|</span> <span class="n">DstReg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">SrcMem16</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">,</span> <span class="n">em_mov_sreg_rm</span><span class="p">),</span>
	<span class="n">G</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group1A</span><span class="p">),</span>
	<span class="cm">/* 0x90 - 0x97 */</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">SrcAcc</span> <span class="o">|</span> <span class="n">DstReg</span><span class="p">,</span> <span class="n">pause</span><span class="p">),</span> <span class="n">X7</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">SrcAcc</span> <span class="o">|</span> <span class="n">DstReg</span><span class="p">)),</span>
	<span class="cm">/* 0x98 - 0x9F */</span>
	<span class="n">D</span><span class="p">(</span><span class="n">DstAcc</span> <span class="o">|</span> <span class="n">SrcNone</span><span class="p">),</span> <span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">SrcAcc</span><span class="p">,</span> <span class="n">em_cwd</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcImmFAddr</span> <span class="o">|</span> <span class="n">No64</span><span class="p">,</span> <span class="n">em_call_far</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">II</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_pushf</span><span class="p">,</span> <span class="n">pushf</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_popf</span><span class="p">,</span> <span class="n">popf</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0xA0 - 0xA7 */</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">DstAcc</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">MemAbs</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcAcc</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">MemAbs</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">SrcSI</span> <span class="o">|</span> <span class="n">DstDI</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">String</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">SrcSI</span> <span class="o">|</span> <span class="n">DstDI</span> <span class="o">|</span> <span class="n">String</span><span class="p">,</span> <span class="n">em_cmp</span><span class="p">),</span>
	<span class="cm">/* 0xA8 - 0xAF */</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">DstAcc</span> <span class="o">|</span> <span class="n">SrcImm</span><span class="p">,</span> <span class="n">em_test</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">SrcAcc</span> <span class="o">|</span> <span class="n">DstDI</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">String</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">SrcSI</span> <span class="o">|</span> <span class="n">DstAcc</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">String</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">),</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">SrcAcc</span> <span class="o">|</span> <span class="n">DstDI</span> <span class="o">|</span> <span class="n">String</span><span class="p">,</span> <span class="n">em_cmp</span><span class="p">),</span>
	<span class="cm">/* 0xB0 - 0xB7 */</span>
	<span class="n">X8</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">ByteOp</span> <span class="o">|</span> <span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcImm</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">)),</span>
	<span class="cm">/* 0xB8 - 0xBF */</span>
	<span class="n">X8</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcImm</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">,</span> <span class="n">em_mov</span><span class="p">)),</span>
	<span class="cm">/* 0xC0 - 0xC7 */</span>
	<span class="n">D2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcImmByte</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">SrcImmU16</span><span class="p">,</span> <span class="n">em_ret_near_imm</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_ret</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMemFAddr</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2ES</span><span class="p">,</span> <span class="n">em_lseg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMemFAddr</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">No64</span> <span class="o">|</span> <span class="n">Src2DS</span><span class="p">,</span> <span class="n">em_lseg</span><span class="p">),</span>
	<span class="n">G</span><span class="p">(</span><span class="n">ByteOp</span><span class="p">,</span> <span class="n">group11</span><span class="p">),</span> <span class="n">G</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group11</span><span class="p">),</span>
	<span class="cm">/* 0xC8 - 0xCF */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_ret_far</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">),</span> <span class="n">DI</span><span class="p">(</span><span class="n">SrcImmByte</span><span class="p">,</span> <span class="n">intn</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">No64</span><span class="p">),</span> <span class="n">II</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">,</span> <span class="n">em_iret</span><span class="p">,</span> <span class="n">iret</span><span class="p">),</span>
	<span class="cm">/* 0xD0 - 0xD7 */</span>
	<span class="n">D2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcOne</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span> <span class="n">D2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0xD8 - 0xDF */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0xE0 - 0xE7 */</span>
	<span class="n">X3</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">SrcImmByte</span><span class="p">,</span> <span class="n">em_loop</span><span class="p">)),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcImmByte</span><span class="p">,</span> <span class="n">em_jcxz</span><span class="p">),</span>
	<span class="n">I2bvIP</span><span class="p">(</span><span class="n">SrcImmUByte</span> <span class="o">|</span> <span class="n">DstAcc</span><span class="p">,</span> <span class="n">em_in</span><span class="p">,</span>  <span class="n">in</span><span class="p">,</span>  <span class="n">check_perm_in</span><span class="p">),</span>
	<span class="n">I2bvIP</span><span class="p">(</span><span class="n">SrcAcc</span> <span class="o">|</span> <span class="n">DstImmUByte</span><span class="p">,</span> <span class="n">em_out</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">check_perm_out</span><span class="p">),</span>
	<span class="cm">/* 0xE8 - 0xEF */</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcImm</span> <span class="o">|</span> <span class="n">Stack</span><span class="p">,</span> <span class="n">em_call</span><span class="p">),</span> <span class="n">D</span><span class="p">(</span><span class="n">SrcImm</span> <span class="o">|</span> <span class="n">ImplicitOps</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">SrcImmFAddr</span> <span class="o">|</span> <span class="n">No64</span><span class="p">,</span> <span class="n">em_jmp_far</span><span class="p">),</span> <span class="n">D</span><span class="p">(</span><span class="n">SrcImmByte</span> <span class="o">|</span> <span class="n">ImplicitOps</span><span class="p">),</span>
	<span class="n">I2bvIP</span><span class="p">(</span><span class="n">SrcDX</span> <span class="o">|</span> <span class="n">DstAcc</span><span class="p">,</span> <span class="n">em_in</span><span class="p">,</span>  <span class="n">in</span><span class="p">,</span>  <span class="n">check_perm_in</span><span class="p">),</span>
	<span class="n">I2bvIP</span><span class="p">(</span><span class="n">SrcAcc</span> <span class="o">|</span> <span class="n">DstDX</span><span class="p">,</span> <span class="n">em_out</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">check_perm_out</span><span class="p">),</span>
	<span class="cm">/* 0xF0 - 0xF7 */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">DI</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">,</span> <span class="n">icebp</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span> <span class="n">hlt</span><span class="p">),</span> <span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">),</span>
	<span class="n">G</span><span class="p">(</span><span class="n">ByteOp</span><span class="p">,</span> <span class="n">group3</span><span class="p">),</span> <span class="n">G</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group3</span><span class="p">),</span>
	<span class="cm">/* 0xF8 - 0xFF */</span>
	<span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">),</span> <span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">,</span> <span class="n">em_cli</span><span class="p">),</span> <span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">,</span> <span class="n">em_sti</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">),</span> <span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">),</span> <span class="n">G</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group4</span><span class="p">),</span> <span class="n">G</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group5</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">opcode</span> <span class="n">twobyte_table</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x00 - 0x0F */</span>
	<span class="n">G</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group6</span><span class="p">),</span> <span class="n">GD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group7</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">VendorSpecific</span><span class="p">,</span> <span class="n">em_syscall</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span> <span class="n">em_clts</span><span class="p">,</span> <span class="n">clts</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span> <span class="n">invd</span><span class="p">),</span> <span class="n">DI</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span> <span class="n">wbinvd</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x10 - 0x1F */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x20 - 0x2F */</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">ModRM</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">Priv</span> <span class="o">|</span> <span class="n">Op3264</span><span class="p">,</span> <span class="n">cr_read</span><span class="p">,</span> <span class="n">check_cr_read</span><span class="p">),</span>
	<span class="n">DIP</span><span class="p">(</span><span class="n">ModRM</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">Priv</span> <span class="o">|</span> <span class="n">Op3264</span><span class="p">,</span> <span class="n">dr_read</span><span class="p">,</span> <span class="n">check_dr_read</span><span class="p">),</span>
	<span class="n">IIP</span><span class="p">(</span><span class="n">ModRM</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">Priv</span> <span class="o">|</span> <span class="n">Op3264</span><span class="p">,</span> <span class="n">em_cr_write</span><span class="p">,</span> <span class="n">cr_write</span><span class="p">,</span> <span class="n">check_cr_write</span><span class="p">),</span>
	<span class="n">IIP</span><span class="p">(</span><span class="n">ModRM</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">Priv</span> <span class="o">|</span> <span class="n">Op3264</span><span class="p">,</span> <span class="n">em_dr_write</span><span class="p">,</span> <span class="n">dr_write</span><span class="p">,</span> <span class="n">check_dr_write</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">GP</span><span class="p">(</span><span class="n">ModRM</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">Sse</span> <span class="o">|</span> <span class="n">Mov</span> <span class="o">|</span> <span class="n">Aligned</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfx_vmovntpx</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x30 - 0x3F */</span>
	<span class="n">II</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span> <span class="n">em_wrmsr</span><span class="p">,</span> <span class="n">wrmsr</span><span class="p">),</span>
	<span class="n">IIP</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">,</span> <span class="n">em_rdtsc</span><span class="p">,</span> <span class="n">rdtsc</span><span class="p">,</span> <span class="n">check_rdtsc</span><span class="p">),</span>
	<span class="n">II</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Priv</span><span class="p">,</span> <span class="n">em_rdmsr</span><span class="p">,</span> <span class="n">rdmsr</span><span class="p">),</span>
	<span class="n">IIP</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">,</span> <span class="n">em_rdpmc</span><span class="p">,</span> <span class="n">rdpmc</span><span class="p">,</span> <span class="n">check_rdpmc</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">VendorSpecific</span><span class="p">,</span> <span class="n">em_sysenter</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">ImplicitOps</span> <span class="o">|</span> <span class="n">Priv</span> <span class="o">|</span> <span class="n">VendorSpecific</span><span class="p">,</span> <span class="n">em_sysexit</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x40 - 0x4F */</span>
	<span class="n">X16</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">)),</span>
	<span class="cm">/* 0x50 - 0x5F */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0x60 - 0x6F */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">GP</span><span class="p">(</span><span class="n">SrcMem</span> <span class="o">|</span> <span class="n">DstReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfx_0f_6f_0f_7f</span><span class="p">),</span>
	<span class="cm">/* 0x70 - 0x7F */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">GP</span><span class="p">(</span><span class="n">SrcReg</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfx_0f_6f_0f_7f</span><span class="p">),</span>
	<span class="cm">/* 0x80 - 0x8F */</span>
	<span class="n">X16</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">SrcImm</span><span class="p">)),</span>
	<span class="cm">/* 0x90 - 0x9F */</span>
	<span class="n">X16</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">ByteOp</span> <span class="o">|</span> <span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcNone</span> <span class="o">|</span> <span class="n">ModRM</span><span class="o">|</span> <span class="n">Mov</span><span class="p">)),</span>
	<span class="cm">/* 0xA0 - 0xA7 */</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Stack</span> <span class="o">|</span> <span class="n">Src2FS</span><span class="p">,</span> <span class="n">em_push_sreg</span><span class="p">),</span> <span class="n">I</span><span class="p">(</span><span class="n">Stack</span> <span class="o">|</span> <span class="n">Src2FS</span><span class="p">,</span> <span class="n">em_pop_sreg</span><span class="p">),</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">,</span> <span class="n">cpuid</span><span class="p">),</span> <span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">BitOp</span><span class="p">,</span> <span class="n">em_bt</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">Src2ImmByte</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">Src2CL</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0xA8 - 0xAF */</span>
	<span class="n">I</span><span class="p">(</span><span class="n">Stack</span> <span class="o">|</span> <span class="n">Src2GS</span><span class="p">,</span> <span class="n">em_push_sreg</span><span class="p">),</span> <span class="n">I</span><span class="p">(</span><span class="n">Stack</span> <span class="o">|</span> <span class="n">Src2GS</span><span class="p">,</span> <span class="n">em_pop_sreg</span><span class="p">),</span>
	<span class="n">DI</span><span class="p">(</span><span class="n">ImplicitOps</span><span class="p">,</span> <span class="n">rsm</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">BitOp</span> <span class="o">|</span> <span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_bts</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">Src2ImmByte</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">Src2CL</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">ModRM</span><span class="p">),</span> <span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">,</span> <span class="n">em_imul</span><span class="p">),</span>
	<span class="cm">/* 0xB0 - 0xB7 */</span>
	<span class="n">I2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_cmpxchg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMemFAddr</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Src2SS</span><span class="p">,</span> <span class="n">em_lseg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">BitOp</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">em_btr</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMemFAddr</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Src2FS</span><span class="p">,</span> <span class="n">em_lseg</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMemFAddr</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Src2GS</span><span class="p">,</span> <span class="n">em_lseg</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem8</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">),</span> <span class="n">D</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem16</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">),</span>
	<span class="cm">/* 0xB8 - 0xBF */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="n">G</span><span class="p">(</span><span class="n">BitOp</span><span class="p">,</span> <span class="n">group8</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">BitOp</span> <span class="o">|</span> <span class="n">Lock</span> <span class="o">|</span> <span class="n">PageTable</span><span class="p">,</span> <span class="n">em_btc</span><span class="p">),</span>
	<span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">,</span> <span class="n">em_bsf</span><span class="p">),</span> <span class="n">I</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem</span> <span class="o">|</span> <span class="n">ModRM</span><span class="p">,</span> <span class="n">em_bsr</span><span class="p">),</span>
	<span class="n">D</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem8</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">),</span> <span class="n">D</span><span class="p">(</span><span class="n">DstReg</span> <span class="o">|</span> <span class="n">SrcMem16</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">),</span>
	<span class="cm">/* 0xC0 - 0xCF */</span>
	<span class="n">D2bv</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Lock</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">(</span><span class="n">DstMem</span> <span class="o">|</span> <span class="n">SrcReg</span> <span class="o">|</span> <span class="n">ModRM</span> <span class="o">|</span> <span class="n">Mov</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">GD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group9</span><span class="p">),</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0xD0 - 0xDF */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0xE0 - 0xEF */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span>
	<span class="cm">/* 0xF0 - 0xFF */</span>
	<span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span>
<span class="p">};</span>

<span class="cp">#undef D</span>
<span class="cp">#undef N</span>
<span class="cp">#undef G</span>
<span class="cp">#undef GD</span>
<span class="cp">#undef I</span>
<span class="cp">#undef GP</span>
<span class="cp">#undef EXT</span>

<span class="cp">#undef D2bv</span>
<span class="cp">#undef D2bvIP</span>
<span class="cp">#undef I2bv</span>
<span class="cp">#undef I2bvIP</span>
<span class="cp">#undef I6ALU</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">imm_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">decode_imm</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sign_extension</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>

	<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_IMM</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="cm">/* NB. Immediates are sign-extended as necessary. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">s8</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">s16</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">s32</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sign_extension</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">decode_operand</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OpReg</span>:
		<span class="n">decode_register_operand</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpImmUByte</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_imm</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpMem</span>:
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
	<span class="nl">mem_common:</span>
		<span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memopp</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">BitOp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">op</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">)</span>
			<span class="n">fetch_bit_operand</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">orig_val</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpMem64</span>:
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mem_common</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpAcc</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">];</span>
		<span class="n">fetch_register_operand</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">orig_val</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpDI</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_MEM</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span>
			<span class="n">register_address</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">]);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">seg</span> <span class="o">=</span> <span class="n">VCPU_SREG_ES</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpDX</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_REG</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">];</span>
		<span class="n">fetch_register_operand</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpCL</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpImmByte</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_imm</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpOne</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpImm</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_imm</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">imm_size</span><span class="p">(</span><span class="n">ctxt</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpMem8</span>:
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mem_common</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpMem16</span>:
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mem_common</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpMem32</span>:
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mem_common</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpImmU16</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_imm</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpImmU</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_imm</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">imm_size</span><span class="p">(</span><span class="n">ctxt</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpSI</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_MEM</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span>
			<span class="n">register_address</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSI</span><span class="p">]);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">seg</span> <span class="o">=</span> <span class="n">seg_override</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpImmFAddr</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_IMM</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">insn_fetch_arr</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">valptr</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpMemFAddr</span>:
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mem_common</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpES</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">VCPU_SREG_ES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpCS</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">VCPU_SREG_CS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpSS</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">VCPU_SREG_SS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpDS</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">VCPU_SREG_DS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpFS</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">VCPU_SREG_FS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpGS</span>:
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">VCPU_SREG_GS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OpImplicit</span>:
		<span class="cm">/* Special instructions do their own operand decoding. */</span>
	<span class="nl">default:</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span> <span class="cm">/* Disable writeback. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">x86_decode_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">insn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">insn_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">def_op_bytes</span><span class="p">,</span> <span class="n">def_ad_bytes</span><span class="p">,</span> <span class="n">goffset</span><span class="p">,</span> <span class="n">simd_prefix</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">op_prefix</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">opcode</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memopp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eip</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">fetch</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">fetch</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">fetch</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">insn_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">fetch</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">insn_len</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_REAL</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_VM86</span>:
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT16</span>:
		<span class="n">def_op_bytes</span> <span class="o">=</span> <span class="n">def_ad_bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT32</span>:
		<span class="n">def_op_bytes</span> <span class="o">=</span> <span class="n">def_ad_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">case</span> <span class="n">X86EMUL_MODE_PROT64</span>:
		<span class="n">def_op_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">def_ad_bytes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">EMULATION_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="n">def_op_bytes</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">=</span> <span class="n">def_ad_bytes</span><span class="p">;</span>

	<span class="cm">/* Legacy prefixes. */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x66</span>:	<span class="cm">/* operand-size override */</span>
			<span class="n">op_prefix</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* switch between 2/4 bytes */</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="n">def_op_bytes</span> <span class="o">^</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x67</span>:	<span class="cm">/* address-size override */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">)</span>
				<span class="cm">/* switch between 4/8 bytes */</span>
				<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">=</span> <span class="n">def_ad_bytes</span> <span class="o">^</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* switch between 2/4 bytes */</span>
				<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">=</span> <span class="n">def_ad_bytes</span> <span class="o">^</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x26</span>:	<span class="cm">/* ES override */</span>
		<span class="k">case</span> <span class="mh">0x2e</span>:	<span class="cm">/* CS override */</span>
		<span class="k">case</span> <span class="mh">0x36</span>:	<span class="cm">/* SS override */</span>
		<span class="k">case</span> <span class="mh">0x3e</span>:	<span class="cm">/* DS override */</span>
			<span class="n">set_seg_override</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x64</span>:	<span class="cm">/* FS override */</span>
		<span class="k">case</span> <span class="mh">0x65</span>:	<span class="cm">/* GS override */</span>
			<span class="n">set_seg_override</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x40</span> <span class="p">...</span> <span class="mh">0x4f</span>: <span class="cm">/* REX */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done_prefixes</span><span class="p">;</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xf0</span>:	<span class="cm">/* LOCK */</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">lock_prefix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xf2</span>:	<span class="cm">/* REPNE/REPNZ */</span>
		<span class="k">case</span> <span class="mh">0xf3</span>:	<span class="cm">/* REP/REPE/REPZ */</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">done_prefixes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Any legacy prefix after a REX prefix nullifies its effect. */</span>

		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done_prefixes:</span>

	<span class="cm">/* REX prefix. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rex_prefix</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* REX.W */</span>

	<span class="cm">/* Opcode byte(s). */</span>
	<span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode_table</span><span class="p">[</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">];</span>
	<span class="cm">/* Two-byte opcode? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">twobyte</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">twobyte_table</span><span class="p">[</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ModRM</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm</span> <span class="o">=</span> <span class="n">insn_fetch</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">GroupMask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">GroupMask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Group</span>:
			<span class="n">goffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">group</span><span class="p">[</span><span class="n">goffset</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GroupDual</span>:
			<span class="n">goffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gdual</span><span class="o">-&gt;</span><span class="n">mod3</span><span class="p">[</span><span class="n">goffset</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gdual</span><span class="o">-&gt;</span><span class="n">mod012</span><span class="p">[</span><span class="n">goffset</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RMExt</span>:
			<span class="n">goffset</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">group</span><span class="p">[</span><span class="n">goffset</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Prefix</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span> <span class="o">&amp;&amp;</span> <span class="n">op_prefix</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">EMULATION_FAILED</span><span class="p">;</span>
			<span class="n">simd_prefix</span> <span class="o">=</span> <span class="n">op_prefix</span> <span class="o">?</span> <span class="mh">0x66</span> <span class="o">:</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">simd_prefix</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x00</span>: <span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gprefix</span><span class="o">-&gt;</span><span class="n">pfx_no</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x66</span>: <span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gprefix</span><span class="o">-&gt;</span><span class="n">pfx_66</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xf2</span>: <span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gprefix</span><span class="o">-&gt;</span><span class="n">pfx_f2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xf3</span>: <span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gprefix</span><span class="o">-&gt;</span><span class="n">pfx_f3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">EMULATION_FAILED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">GroupMask</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">|=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">execute</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">execute</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">check_perm</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">check_perm</span><span class="p">;</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">.</span><span class="n">intercept</span><span class="p">;</span>

	<span class="cm">/* Unrecognised? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Undefined</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">EMULATION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">VendorSpecific</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">only_vendor_specific_insn</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EMULATION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Stack</span><span class="p">))</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Op3264</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">)</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Sse</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Mmx</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* ModRM and SIB bytes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ModRM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_modrm</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">has_seg_override</span><span class="p">)</span>
			<span class="n">set_seg_override</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_seg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">MemAbs</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_abs</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">has_seg_override</span><span class="p">)</span>
		<span class="n">set_seg_override</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_DS</span><span class="p">);</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">seg</span> <span class="o">=</span> <span class="n">seg_override</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP_MEM</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memop</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Decode and fetch the source operand: register, memory</span>
<span class="cm">	 * or immediate.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_operand</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="n">SrcShift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OpMask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Decode and fetch the second source operand: register, memory</span>
<span class="cm">	 * or immediate.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_operand</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">,</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="n">Src2Shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OpMask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Decode and fetch the destination operand: register or memory. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_operand</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="n">DstShift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OpMask</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memopp</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memopp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP_MEM</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rip_relative</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">memopp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span> <span class="o">+=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span> <span class="o">?</span> <span class="n">EMULATION_FAILED</span> <span class="o">:</span> <span class="n">EMULATION_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">x86_page_table_writing_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">PageTable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">string_insn_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The second termination condition only applies for REPE</span>
<span class="cm">	 * and REPNE. Test if the repeat string operation prefix is</span>
<span class="cm">	 * REPE/REPZ or REPNE/REPNZ and if it&#39;s the case it tests the</span>
<span class="cm">	 * corresponding termination condition according to:</span>
<span class="cm">	 * 	- if REPE/REPZ and ZF = 0 then done</span>
<span class="cm">	 * 	- if REPNE/REPNZ and ZF = 1 then done</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xa6</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xa7</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xae</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xaf</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span> <span class="o">==</span> <span class="n">REPE_PREFIX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">EFLG_ZF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="o">||</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span> <span class="o">==</span> <span class="n">REPNE_PREFIX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">EFLG_ZF</span><span class="p">)</span> <span class="o">==</span> <span class="n">EFLG_ZF</span><span class="p">))))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flush_pending_x87_faults</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">fault</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;1: fwait </span><span class="se">\n\t</span><span class="s">&quot;</span>
		     <span class="s">&quot;2: </span><span class="se">\n\t</span><span class="s">&quot;</span>
		     <span class="s">&quot;.pushsection .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\n\t</span><span class="s">&quot;</span>
		     <span class="s">&quot;3: </span><span class="se">\n\t</span><span class="s">&quot;</span>
		     <span class="s">&quot;movb $1, %[fault] </span><span class="se">\n\t</span><span class="s">&quot;</span>
		     <span class="s">&quot;jmp 2b </span><span class="se">\n\t</span><span class="s">&quot;</span>
		     <span class="s">&quot;.popsection </span><span class="se">\n\t</span><span class="s">&quot;</span>
		     <span class="n">_ASM_EXTABLE</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span> <span class="mi">3</span><span class="n">b</span><span class="p">)</span>
		     <span class="o">:</span> <span class="p">[</span><span class="n">fault</span><span class="p">]</span><span class="s">&quot;+qm&quot;</span><span class="p">(</span><span class="n">fault</span><span class="p">));</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">put_fpu</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fault</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_exception</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">MF_VECTOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fetch_possible_mmx_operand</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">operand</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP_MM</span><span class="p">)</span>
		<span class="n">read_mmx_reg</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">mm_val</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">mm</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">x86_emulate_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">x86_emulate_ctxt</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">x86_emulate_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">saved_dst_type</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mem_read</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">X86EMUL_MODE_PROT64</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">No64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* LOCK prefix is allowed only with some instructions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">lock_prefix</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Lock</span><span class="p">)</span> <span class="o">||</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OP_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">SrcMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">SrcMemFAddr</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OP_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Sse</span><span class="o">|</span><span class="n">Mmx</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_CR0_EM</span><span class="p">)))</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Sse</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_CR4_OSFXSR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Sse</span><span class="o">|</span><span class="n">Mmx</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_CR0_TS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_nm</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Mmx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">flush_pending_x87_faults</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Now that we know the fpu is exception safe, we can fetch</span>
<span class="cm">		 * operands from it.</span>
<span class="cm">		 */</span>
		<span class="n">fetch_possible_mmx_operand</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
		<span class="n">fetch_possible_mmx_operand</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Mov</span><span class="p">))</span>
			<span class="n">fetch_possible_mmx_operand</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">guest_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulator_check_intercept</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">,</span>
					      <span class="n">X86_ICPT_PRE_EXCEPT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Privileged instruction can be executed only in CPL=0 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_gp</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Instruction can only be executed in protected mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Prot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">X86EMUL_MODE_PROT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_ud</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do instruction specific permission checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">check_perm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">check_perm</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">guest_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulator_check_intercept</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">,</span>
					      <span class="n">X86_ICPT_POST_EXCEPT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">String</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* All REP prefixes have the same first termination condition */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">address_mask</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP_MEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">NoAccess</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">segmented_read</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span>
				    <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">valptr</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">orig_val64</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val64</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">segmented_read</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src2</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">DstMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">ImplicitOps</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">special_insn</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP_MEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">Mov</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* optimisation - avoid slow emulated read if Mov */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">segmented_read</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">orig_val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

<span class="nl">special_insn:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">guest_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulator_check_intercept</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">,</span>
					      <span class="n">X86_ICPT_POST_MEMACCESS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">writeback</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">twobyte</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">twobyte_insn</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x40</span> <span class="p">...</span> <span class="mh">0x47</span>: <span class="cm">/* inc r16/r32 */</span>
		<span class="n">emulate_1op</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;inc&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x48</span> <span class="p">...</span> <span class="mh">0x4f</span>: <span class="cm">/* dec r16/r32 */</span>
		<span class="n">emulate_1op</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;dec&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x63</span>:		<span class="cm">/* movsxd */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">X86EMUL_MODE_PROT64</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cannot_emulate</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x70</span> <span class="p">...</span> <span class="mh">0x7f</span>: <span class="cm">/* jcc (short) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_cc</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">))</span>
			<span class="n">jmp_rel</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8d</span>: <span class="cm">/* lea r16/r32, m */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">ea</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x90</span> <span class="p">...</span> <span class="mh">0x97</span>: <span class="cm">/* nop / xchg reg, rax */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">reg</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em_xchg</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x98</span>: <span class="cm">/* cbw/cwde/cdqe */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>: <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xc0</span> <span class="p">...</span> <span class="mh">0xc1</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em_grp2</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xcc</span>:		<span class="cm">/* int3 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_int</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xcd</span>:		<span class="cm">/* int n */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_int</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xce</span>:		<span class="cm">/* into */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">EFLG_OF</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">emulate_int</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xd0</span> <span class="p">...</span> <span class="mh">0xd1</span>:	<span class="cm">/* Grp2 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em_grp2</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xd2</span> <span class="p">...</span> <span class="mh">0xd3</span>:	<span class="cm">/* Grp2 */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">];</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">em_grp2</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xe9</span>: <span class="cm">/* jmp rel */</span>
	<span class="k">case</span> <span class="mh">0xeb</span>: <span class="cm">/* jmp rel short */</span>
		<span class="n">jmp_rel</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span> <span class="cm">/* Disable writeback. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xf4</span>:              <span class="cm">/* hlt */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">halt</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xf5</span>:	<span class="cm">/* cmc */</span>
		<span class="cm">/* complement carry flag from eflags reg */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">^=</span> <span class="n">EFLG_CF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xf8</span>: <span class="cm">/* clc */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EFLG_CF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xf9</span>: <span class="cm">/* stc */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">EFLG_CF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xfc</span>: <span class="cm">/* cld */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EFLG_DF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xfd</span>: <span class="cm">/* std */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">EFLG_DF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">cannot_emulate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">writeback:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">writeback</span><span class="p">(</span><span class="n">ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * restore dst type in case the decoding will be reused</span>
<span class="cm">	 * (happens for string instruction )</span>
<span class="cm">	 */</span>
	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">saved_dst_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">SrcMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">SrcSI</span><span class="p">)</span>
		<span class="n">string_addr_inc</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">seg_override</span><span class="p">(</span><span class="n">ctxt</span><span class="p">),</span>
				<span class="n">VCPU_REGS_RSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">DstMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">DstDI</span><span class="p">)</span>
		<span class="n">string_addr_inc</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">VCPU_SREG_ES</span><span class="p">,</span> <span class="n">VCPU_REGS_RDI</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">rep_prefix</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">String</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">read_cache</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">io_read</span><span class="p">;</span>
		<span class="n">register_address_increment</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">string_insn_completed</span><span class="p">(</span><span class="n">ctxt</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Re-enter guest when pio read ahead buffer is empty</span>
<span class="cm">			 * or, if it is not used, after each 1024 iteration.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">!=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Reset read cache. Usually happens before</span>
<span class="cm">				 * decode, but since instruction is restarted</span>
<span class="cm">				 * we have to do it here.</span>
<span class="cm">				 */</span>
				<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">mem_read</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">EMULATION_RESTART</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span> <span class="cm">/* skip rip writeback */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">X86EMUL_PROPAGATE_FAULT</span><span class="p">)</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">have_exception</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">X86EMUL_INTERCEPTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EMULATION_INTERCEPTED</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">X86EMUL_UNHANDLEABLE</span><span class="p">)</span> <span class="o">?</span> <span class="n">EMULATION_FAILED</span> <span class="o">:</span> <span class="n">EMULATION_OK</span><span class="p">;</span>

<span class="nl">twobyte_insn:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x09</span>:		<span class="cm">/* wbinvd */</span>
		<span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">wbinvd</span><span class="p">)(</span><span class="n">ctxt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x08</span>:		<span class="cm">/* invd */</span>
	<span class="k">case</span> <span class="mh">0x0d</span>:		<span class="cm">/* GrpP (prefetch) */</span>
	<span class="k">case</span> <span class="mh">0x18</span>:		<span class="cm">/* Grp16 (prefetch/nop) */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x20</span>: <span class="cm">/* mov cr, reg */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x21</span>: <span class="cm">/* mov from dr to reg */</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_dr</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x40</span> <span class="p">...</span> <span class="mh">0x4f</span>:	<span class="cm">/* cmov */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">orig_val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cc</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">))</span>
			<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">OP_NONE</span><span class="p">;</span> <span class="cm">/* no writeback */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x80</span> <span class="p">...</span> <span class="mh">0x8f</span>: <span class="cm">/* jnz rel, etc*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_cc</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">))</span>
			<span class="n">jmp_rel</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x90</span> <span class="p">...</span> <span class="mh">0x9f</span>:     <span class="cm">/* setcc r/m8 */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">test_cc</span><span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xa4</span>: <span class="cm">/* shld imm8, r, r/m */</span>
	<span class="k">case</span> <span class="mh">0xa5</span>: <span class="cm">/* shld cl, r, r/m */</span>
		<span class="n">emulate_2op_cl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;shld&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xac</span>: <span class="cm">/* shrd imm8, r, r/m */</span>
	<span class="k">case</span> <span class="mh">0xad</span>: <span class="cm">/* shrd cl, r, r/m */</span>
		<span class="n">emulate_2op_cl</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;shrd&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xae</span>:              <span class="cm">/* clflush */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xb6</span> <span class="p">...</span> <span class="mh">0xb7</span>:	<span class="cm">/* movzx */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span>
						       <span class="o">:</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xbe</span> <span class="p">...</span> <span class="mh">0xbf</span>:	<span class="cm">/* movsx */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">ByteOp</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">:</span>
							<span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xc0</span> <span class="p">...</span> <span class="mh">0xc1</span>:	<span class="cm">/* xadd */</span>
		<span class="n">emulate_2op_SrcV</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="s">&quot;add&quot;</span><span class="p">);</span>
		<span class="cm">/* Write back the register source. */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">orig_val</span><span class="p">;</span>
		<span class="n">write_register_operand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xc3</span>:		<span class="cm">/* movnti */</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span><span class="p">;</span>
		<span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">op_bytes</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span> <span class="o">:</span>
							<span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">ctxt</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">cannot_emulate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">writeback</span><span class="p">;</span>

<span class="nl">cannot_emulate:</span>
	<span class="k">return</span> <span class="n">EMULATION_FAILED</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
