<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kvm › cpuid.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cpuid.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Kernel-based Virtual Machine driver for Linux</span>
<span class="cm"> * cpuid support routines</span>
<span class="cm"> *</span>
<span class="cm"> * derived from arch/x86/kvm/x86.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2011 Red Hat, Inc. and/or its affiliates.</span>
<span class="cm"> * Copyright IBM Corporation, 2008</span>
<span class="cm"> *</span>
<span class="cm"> * This work is licensed under the terms of the GNU GPL, version 2.  See</span>
<span class="cm"> * the COPYING file in the top-level directory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/user.h&gt;</span>
<span class="cp">#include &lt;asm/xsave.h&gt;</span>
<span class="cp">#include &quot;cpuid.h&quot;</span>
<span class="cp">#include &quot;lapic.h&quot;</span>
<span class="cp">#include &quot;mmu.h&quot;</span>
<span class="cp">#include &quot;trace.h&quot;</span>

<span class="kt">void</span> <span class="nf">kvm_update_cpuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">best</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="n">best</span> <span class="o">=</span> <span class="n">kvm_find_cpuid_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">best</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Update OSXSAVE bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_xsave</span> <span class="o">&amp;&amp;</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">best</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">bit</span><span class="p">(</span><span class="n">X86_FEATURE_OSXSAVE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kvm_read_cr4_bits</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">X86_CR4_OSXSAVE</span><span class="p">))</span>
			<span class="n">best</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">(</span><span class="n">X86_FEATURE_OSXSAVE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">best</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">(</span><span class="n">X86_FEATURE_TSC_DEADLINE_TIMER</span><span class="p">))</span>
			<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer_mode_mask</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer_mode_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvm_pmu_cpuid_update</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_efer_nx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">efer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rdmsrl_safe</span><span class="p">(</span><span class="n">MSR_EFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_NX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpuid_fix_nx_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_nent</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="mh">0x80000001</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_efer_nx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;kvm: guest NX capability removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* when an old userspace process fills a new kernel module */</span>
<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_set_cpuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">kvm_cpuid</span> <span class="o">*</span><span class="n">cpuid</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">kvm_cpuid_entry</span> <span class="n">__user</span> <span class="o">*</span><span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry</span> <span class="o">*</span><span class="n">cpuid_entries</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">&gt;</span> <span class="n">KVM_MAX_CPUID_ENTRIES</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cpuid_entries</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry</span><span class="p">)</span> <span class="o">*</span> <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpuid_entries</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">cpuid_entries</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span>
			   <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eax</span> <span class="o">=</span> <span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eax</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ebx</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ecx</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">edx</span> <span class="o">=</span> <span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">edx</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_nent</span> <span class="o">=</span> <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">;</span>
	<span class="n">cpuid_fix_nx_cap</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kvm_apic_set_version</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_x86_ops</span><span class="o">-&gt;</span><span class="n">cpuid_update</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_update_cpuid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">cpuid_entries</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_set_cpuid2</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">kvm_cpuid2</span> <span class="o">*</span><span class="n">cpuid</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="n">__user</span> <span class="o">*</span><span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">&gt;</span> <span class="n">KVM_MAX_CPUID_ENTRIES</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span>
			   <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_nent</span> <span class="o">=</span> <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">;</span>
	<span class="n">kvm_apic_set_version</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_x86_ops</span><span class="o">-&gt;</span><span class="n">cpuid_update</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_update_cpuid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_get_cpuid2</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">kvm_cpuid2</span> <span class="o">*</span><span class="n">cpuid</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="n">__user</span> <span class="o">*</span><span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">&lt;</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_nent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">,</span>
			 <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_nent</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_nent</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpuid_mask</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">word</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wordnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">word</span> <span class="o">&amp;=</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_capability</span><span class="p">[</span><span class="n">wordnum</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_cpuid_1_ent</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">u32</span> <span class="n">function</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">cpuid_count</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">supported_xcr0_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XSTATE_FP</span> <span class="o">|</span> <span class="n">XSTATE_SSE</span> <span class="o">|</span> <span class="n">XSTATE_YMM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">host_xcr0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define F(x) bit(X86_FEATURE_##x)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_cpuid_ent</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">u32</span> <span class="n">function</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxnent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">f_nx</span> <span class="o">=</span> <span class="n">is_efer_nx</span><span class="p">()</span> <span class="o">?</span> <span class="n">F</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="kt">unsigned</span> <span class="n">f_gbpages</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvm_x86_ops</span><span class="o">-&gt;</span><span class="n">get_lpage_level</span><span class="p">()</span> <span class="o">==</span> <span class="n">PT_PDPE_LEVEL</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">F</span><span class="p">(</span><span class="n">GBPAGES</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">f_lm</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">LM</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="kt">unsigned</span> <span class="n">f_gbpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">f_lm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="n">f_rdtscp</span> <span class="o">=</span> <span class="n">kvm_x86_ops</span><span class="o">-&gt;</span><span class="n">rdtscp_supported</span><span class="p">()</span> <span class="o">?</span> <span class="n">F</span><span class="p">(</span><span class="n">RDTSCP</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* cpuid 1.edx */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">kvm_supported_word0_x86_features</span> <span class="o">=</span>
		<span class="n">F</span><span class="p">(</span><span class="n">FPU</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">VME</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">DE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PSE</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">TSC</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PAE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MCE</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">CX8</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">APIC</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* Reserved */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">SEP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">MTRR</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PGE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MCA</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">CMOV</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">PAT</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PSE36</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* PSN */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">CLFLSH</span><span class="p">)</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="cm">/* Reserved, DS, ACPI */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MMX</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">FXSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">XMM</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">XMM2</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">SELFSNOOP</span><span class="p">)</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="cm">/* HTT, TM, Reserved, PBE */</span><span class="p">;</span>
	<span class="cm">/* cpuid 0x80000001.edx */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">kvm_supported_word1_x86_features</span> <span class="o">=</span>
		<span class="n">F</span><span class="p">(</span><span class="n">FPU</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">VME</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">DE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PSE</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">TSC</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PAE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MCE</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">CX8</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">APIC</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* Reserved */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">SYSCALL</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">MTRR</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PGE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MCA</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">CMOV</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">PAT</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PSE36</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* Reserved */</span> <span class="o">|</span>
		<span class="n">f_nx</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* Reserved */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MMXEXT</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MMX</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">FXSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">FXSR_OPT</span><span class="p">)</span> <span class="o">|</span> <span class="n">f_gbpages</span> <span class="o">|</span> <span class="n">f_rdtscp</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="cm">/* Reserved */</span> <span class="o">|</span> <span class="n">f_lm</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="mi">3</span><span class="n">DNOWEXT</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="mi">3</span><span class="n">DNOW</span><span class="p">);</span>
	<span class="cm">/* cpuid 1.ecx */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">kvm_supported_word4_x86_features</span> <span class="o">=</span>
		<span class="n">F</span><span class="p">(</span><span class="n">XMM3</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PCLMULQDQ</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* DTES64, MONITOR */</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="cm">/* DS-CPL, VMX, SMX, EST */</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="cm">/* TM2 */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">SSSE3</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* CNXT-ID */</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* Reserved */</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">FMA</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">CX16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* xTPR Update, PDCM */</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="cm">/* Reserved, DCA */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">XMM4_1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">XMM4_2</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">X2APIC</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MOVBE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">POPCNT</span><span class="p">)</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="cm">/* Reserved*/</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">AES</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">XSAVE</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* OSXSAVE */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">AVX</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">F16C</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">RDRAND</span><span class="p">);</span>
	<span class="cm">/* cpuid 0x80000001.ecx */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">kvm_supported_word6_x86_features</span> <span class="o">=</span>
		<span class="n">F</span><span class="p">(</span><span class="n">LAHF_LM</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">CMP_LEGACY</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/*SVM*/</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* ExtApicSpace */</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">CR8_LEGACY</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">ABM</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">SSE4A</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">MISALIGNSSE</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="mi">3</span><span class="n">DNOWPREFETCH</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">OSVW</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* IBS */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">XOP</span><span class="p">)</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="cm">/* SKINIT, WDT, LWP */</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">FMA4</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">TBM</span><span class="p">);</span>

	<span class="cm">/* cpuid 0xC0000001.edx */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">kvm_supported_word5_x86_features</span> <span class="o">=</span>
		<span class="n">F</span><span class="p">(</span><span class="n">XSTORE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">XSTORE_EN</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">XCRYPT</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">XCRYPT_EN</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">ACE2</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">ACE2_EN</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PHE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PHE_EN</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">PMM</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">PMM_EN</span><span class="p">);</span>

	<span class="cm">/* cpuid 7.0.ebx */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">kvm_supported_word9_x86_features</span> <span class="o">=</span>
		<span class="n">F</span><span class="p">(</span><span class="n">FSGSBASE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">BMI1</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">HLE</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">AVX2</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">SMEP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">F</span><span class="p">(</span><span class="n">BMI2</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">ERMS</span><span class="p">)</span> <span class="o">|</span> <span class="n">F</span><span class="p">(</span><span class="n">RTM</span><span class="p">);</span>

	<span class="cm">/* all calls to cpuid_count() should be made on the same cpu */</span>
	<span class="n">get_cpu</span><span class="p">();</span>

	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nent</span> <span class="o">&gt;=</span> <span class="n">maxnent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">do_cpuid_1_ent</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="o">++*</span><span class="n">nent</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mh">0xd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">&amp;=</span> <span class="n">kvm_supported_word0_x86_features</span><span class="p">;</span>
		<span class="n">cpuid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">&amp;=</span> <span class="n">kvm_supported_word4_x86_features</span><span class="p">;</span>
		<span class="n">cpuid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="cm">/* we support x2apic emulation even if host does not support</span>
<span class="cm">		 * it since we emulate x2apic in software */</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">|=</span> <span class="n">F</span><span class="p">(</span><span class="n">X2APIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* function 2 entries are STATEFUL. That is, repeated cpuid commands</span>
<span class="cm">	 * may return different values. This forces us to get_cpu() before</span>
<span class="cm">	 * issuing the first command, and also to emulate this annoying behavior</span>
<span class="cm">	 * in kvm_emulate_cpuid() using KVM_CPUID_FLAG_STATE_READ_NEXT */</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KVM_CPUID_FLAG_STATEFUL_FUNC</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KVM_CPUID_FLAG_STATE_READ_NEXT</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">times</span><span class="p">;</span> <span class="o">++</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nent</span> <span class="o">&gt;=</span> <span class="n">maxnent</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">do_cpuid_1_ent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">function</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">entry</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KVM_CPUID_FLAG_STATEFUL_FUNC</span><span class="p">;</span>
			<span class="o">++*</span><span class="n">nent</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* function 4 has additional index. */</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cache_type</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KVM_CPUID_FLAG_SIGNIFCANT_INDEX</span><span class="p">;</span>
		<span class="cm">/* read more entries until cache_type is zero */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nent</span> <span class="o">&gt;=</span> <span class="n">maxnent</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">cache_type</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache_type</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">do_cpuid_1_ent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">function</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			       <span class="n">KVM_CPUID_FLAG_SIGNIFCANT_INDEX</span><span class="p">;</span>
			<span class="o">++*</span><span class="n">nent</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KVM_CPUID_FLAG_SIGNIFCANT_INDEX</span><span class="p">;</span>
		<span class="cm">/* Mask ebx against host capbability word 9 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">&amp;=</span> <span class="n">kvm_supported_word9_x86_features</span><span class="p">;</span>
			<span class="n">cpuid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xa</span>: <span class="p">{</span> <span class="cm">/* Architectural Performance Monitoring */</span>
		<span class="k">struct</span> <span class="n">x86_pmu_capability</span> <span class="n">cap</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">cpuid10_eax</span> <span class="n">eax</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">cpuid10_edx</span> <span class="n">edx</span><span class="p">;</span>

		<span class="n">perf_get_x86_pmu_capability</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Only support guest architectural pmu on a host</span>
<span class="cm">		 * with architectural pmu.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="p">));</span>

		<span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">version_id</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cap</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">num_counters</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">num_counters_gp</span><span class="p">;</span>
		<span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">bit_width</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">bit_width_gp</span><span class="p">;</span>
		<span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">mask_length</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">events_mask_len</span><span class="p">;</span>

		<span class="n">edx</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">num_counters_fixed</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">num_counters_fixed</span><span class="p">;</span>
		<span class="n">edx</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">bit_width_fixed</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">bit_width_fixed</span><span class="p">;</span>
		<span class="n">edx</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="n">eax</span><span class="p">.</span><span class="n">full</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="n">events_mask</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="n">edx</span><span class="p">.</span><span class="n">full</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* function 0xb has additional index. */</span>
	<span class="k">case</span> <span class="mh">0xb</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">level_type</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KVM_CPUID_FLAG_SIGNIFCANT_INDEX</span><span class="p">;</span>
		<span class="cm">/* read more entries until level_type is zero */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nent</span> <span class="o">&gt;=</span> <span class="n">maxnent</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">level_type</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">ecx</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">level_type</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">do_cpuid_1_ent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">function</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			       <span class="n">KVM_CPUID_FLAG_SIGNIFCANT_INDEX</span><span class="p">;</span>
			<span class="o">++*</span><span class="n">nent</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mh">0xd</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KVM_CPUID_FLAG_SIGNIFCANT_INDEX</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nent</span> <span class="o">&gt;=</span> <span class="n">maxnent</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">do_cpuid_1_ent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">function</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eax</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">supported_xcr0_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			       <span class="n">KVM_CPUID_FLAG_SIGNIFCANT_INDEX</span><span class="p">;</span>
			<span class="o">++*</span><span class="n">nent</span><span class="p">;</span>
			<span class="o">++</span><span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">KVM_CPUID_SIGNATURE</span>: <span class="p">{</span>
		<span class="kt">char</span> <span class="n">signature</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;KVMKVMKVM</span><span class="se">\0\0</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">sigptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">signature</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="n">KVM_CPUID_FEATURES</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">sigptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">sigptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="n">sigptr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">KVM_CPUID_FEATURES</span>:
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KVM_FEATURE_CLOCKSOURCE</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KVM_FEATURE_NOP_IO_DELAY</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KVM_FEATURE_CLOCKSOURCE2</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KVM_FEATURE_ASYNC_PF</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KVM_FEATURE_CLOCKSOURCE_STABLE_BIT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sched_info_on</span><span class="p">())</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KVM_FEATURE_STEAL_TIME</span><span class="p">);</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x80000000</span>:
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span><span class="p">,</span> <span class="mh">0x8000001a</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x80000001</span>:
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">&amp;=</span> <span class="n">kvm_supported_word1_x86_features</span><span class="p">;</span>
		<span class="n">cpuid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">&amp;=</span> <span class="n">kvm_supported_word6_x86_features</span><span class="p">;</span>
		<span class="n">cpuid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x80000008</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">g_phys_as</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">virt_as</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">48U</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="n">phys_as</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_phys_as</span><span class="p">)</span>
			<span class="n">g_phys_as</span> <span class="o">=</span> <span class="n">phys_as</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="n">g_phys_as</span> <span class="o">|</span> <span class="p">(</span><span class="n">virt_as</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mh">0x80000019</span>:
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8000001a</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8000001d</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*Add support for Centaur&#39;s CPUID instruction*/</span>
	<span class="k">case</span> <span class="mh">0xC0000000</span>:
		<span class="cm">/*Just support up to 0xC0000004 now*/</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span><span class="p">,</span> <span class="mh">0xC0000004</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xC0000001</span>:
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">&amp;=</span> <span class="n">kvm_supported_word5_x86_features</span><span class="p">;</span>
		<span class="n">cpuid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* Processor serial number */</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* MONITOR/MWAIT */</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* Thermal management */</span>
	<span class="k">case</span> <span class="mh">0x80000007</span>: <span class="cm">/* Advanced power management */</span>
	<span class="k">case</span> <span class="mh">0xC0000002</span>:
	<span class="k">case</span> <span class="mh">0xC0000003</span>:
	<span class="k">case</span> <span class="mh">0xC0000004</span>:
	<span class="nl">default:</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvm_x86_ops</span><span class="o">-&gt;</span><span class="n">set_supported_cpuid</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">put_cpu</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef F</span>

<span class="k">struct</span> <span class="n">kvm_cpuid_param</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_leaf_count</span><span class="p">;</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">qualifier</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_cpuid_param</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_centaur_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_vendor</span> <span class="o">==</span> <span class="n">X86_VENDOR_CENTAUR</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_dev_ioctl_get_supported_cpuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid2</span> <span class="o">*</span><span class="n">cpuid</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="n">__user</span> <span class="o">*</span><span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">cpuid_entries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="n">nent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">func</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">kvm_cpuid_param</span> <span class="n">param</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">has_leaf_count</span> <span class="o">=</span> <span class="nb">true</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="p">.</span><span class="n">has_leaf_count</span> <span class="o">=</span> <span class="nb">true</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="mh">0xC0000000</span><span class="p">,</span> <span class="p">.</span><span class="n">qualifier</span> <span class="o">=</span> <span class="n">is_centaur_cpu</span><span class="p">,</span> <span class="p">.</span><span class="n">has_leaf_count</span> <span class="o">=</span> <span class="nb">true</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">KVM_CPUID_SIGNATURE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">KVM_CPUID_FEATURES</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">&gt;</span> <span class="n">KVM_MAX_CPUID_ENTRIES</span><span class="p">)</span>
		<span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">=</span> <span class="n">KVM_MAX_CPUID_ENTRIES</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cpuid_entries</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpuid_entries</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">param</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_cpuid_param</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">qualifier</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">qualifier</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">do_cpuid_ent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">nent</span><span class="p">],</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">nent</span><span class="p">,</span> <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">has_leaf_count</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">limit</span> <span class="o">=</span> <span class="n">cpuid_entries</span><span class="p">[</span><span class="n">nent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">eax</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">func</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">func</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">nent</span> <span class="o">&lt;</span> <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">func</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">do_cpuid_ent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">nent</span><span class="p">],</span> <span class="n">func</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">nent</span><span class="p">,</span> <span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">cpuid_entries</span><span class="p">,</span>
			 <span class="n">nent</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">cpuid</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">=</span> <span class="n">nent</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">cpuid_entries</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">move_to_next_stateful_cpuid_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">nent</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_nent</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KVM_CPUID_FLAG_STATE_READ_NEXT</span><span class="p">;</span>
	<span class="cm">/* when no next entry is found, the current entry[i] is reselected */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">ej</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ej</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ej</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">KVM_CPUID_FLAG_STATE_READ_NEXT</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* silence gcc, even though control never reaches here */</span>
<span class="p">}</span>

<span class="cm">/* find an entry with matching function, matching index (if needed), and that</span>
<span class="cm"> * should be read next (if it&#39;s stateful) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_matching_cpuid_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">function</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="n">function</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_CPUID_FLAG_SIGNIFCANT_INDEX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_CPUID_FLAG_STATEFUL_FUNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_CPUID_FLAG_STATE_READ_NEXT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="nf">kvm_find_cpuid_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">function</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">best</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_nent</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

		<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpuid_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_matching_cpuid_entry</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_CPUID_FLAG_STATEFUL_FUNC</span><span class="p">)</span>
				<span class="n">move_to_next_stateful_cpuid_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">best</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">kvm_find_cpuid_entry</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cpuid_maxphyaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">best</span><span class="p">;</span>

	<span class="n">best</span> <span class="o">=</span> <span class="n">kvm_find_cpuid_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">best</span> <span class="o">||</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">&lt;</span> <span class="mh">0x80000008</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
	<span class="n">best</span> <span class="o">=</span> <span class="n">kvm_find_cpuid_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mh">0x80000008</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="nl">not_found:</span>
	<span class="k">return</span> <span class="mi">36</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If no match is found, check whether we exceed the vCPU&#39;s limit</span>
<span class="cm"> * and return the content of the highest valid _standard_ leaf instead.</span>
<span class="cm"> * This is to satisfy the CPUID specification.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span><span class="o">*</span> <span class="nf">check_cpuid_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                                  <span class="n">u32</span> <span class="n">function</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">maxlevel</span><span class="p">;</span>

	<span class="n">maxlevel</span> <span class="o">=</span> <span class="n">kvm_find_cpuid_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">function</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">maxlevel</span> <span class="o">||</span> <span class="n">maxlevel</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">&gt;=</span> <span class="n">function</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">function</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxlevel</span> <span class="o">=</span> <span class="n">kvm_find_cpuid_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">maxlevel</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">kvm_find_cpuid_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">maxlevel</span><span class="o">-&gt;</span><span class="n">eax</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_emulate_cpuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">function</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">best</span><span class="p">;</span>

	<span class="n">function</span> <span class="o">=</span> <span class="n">kvm_register_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RAX</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">kvm_register_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RCX</span><span class="p">);</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RBX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RCX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RDX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">best</span> <span class="o">=</span> <span class="n">kvm_find_cpuid_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">best</span><span class="p">)</span>
		<span class="n">best</span> <span class="o">=</span> <span class="n">check_cpuid_limit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">best</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvm_register_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RAX</span><span class="p">,</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">eax</span><span class="p">);</span>
		<span class="n">kvm_register_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RBX</span><span class="p">,</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">ebx</span><span class="p">);</span>
		<span class="n">kvm_register_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RCX</span><span class="p">,</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">ecx</span><span class="p">);</span>
		<span class="n">kvm_register_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RDX</span><span class="p">,</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">edx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kvm_x86_ops</span><span class="o">-&gt;</span><span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">trace_kvm_cpuid</span><span class="p">(</span><span class="n">function</span><span class="p">,</span>
			<span class="n">kvm_register_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RAX</span><span class="p">),</span>
			<span class="n">kvm_register_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RBX</span><span class="p">),</span>
			<span class="n">kvm_register_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RCX</span><span class="p">),</span>
			<span class="n">kvm_register_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RDX</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">kvm_emulate_cpuid</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
