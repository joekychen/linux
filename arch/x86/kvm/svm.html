<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kvm › svm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>svm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Kernel-based Virtual Machine driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * AMD SVM support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Qumranet, Inc.</span>
<span class="cm"> * Copyright 2010 Red Hat, Inc. and/or its affiliates.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Yaniv Kamay  &lt;yaniv@qumranet.com&gt;</span>
<span class="cm"> *   Avi Kivity   &lt;avi@qumranet.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This work is licensed under the terms of the GNU GPL, version 2.  See</span>
<span class="cm"> * the COPYING file in the top-level directory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>

<span class="cp">#include &quot;irq.h&quot;</span>
<span class="cp">#include &quot;mmu.h&quot;</span>
<span class="cp">#include &quot;kvm_cache_regs.h&quot;</span>
<span class="cp">#include &quot;x86.h&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mod_devicetable.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/ftrace_event.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/perf_event.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/desc.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_para.h&gt;</span>

<span class="cp">#include &lt;asm/virtext.h&gt;</span>
<span class="cp">#include &quot;trace.h&quot;</span>

<span class="cp">#define __ex(x) __kvm_handle_fault_on_reboot(x)</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Qumranet&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_cpu_id</span> <span class="n">svm_cpu_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">X86_FEATURE_MATCH</span><span class="p">(</span><span class="n">X86_FEATURE_SVM</span><span class="p">),</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">x86cpu</span><span class="p">,</span> <span class="n">svm_cpu_id</span><span class="p">);</span>

<span class="cp">#define IOPM_ALLOC_ORDER 2</span>
<span class="cp">#define MSRPM_ALLOC_ORDER 1</span>

<span class="cp">#define SEG_TYPE_LDT 2</span>
<span class="cp">#define SEG_TYPE_BUSY_TSS16 3</span>

<span class="cp">#define SVM_FEATURE_NPT            (1 &lt;&lt;  0)</span>
<span class="cp">#define SVM_FEATURE_LBRV           (1 &lt;&lt;  1)</span>
<span class="cp">#define SVM_FEATURE_SVML           (1 &lt;&lt;  2)</span>
<span class="cp">#define SVM_FEATURE_NRIP           (1 &lt;&lt;  3)</span>
<span class="cp">#define SVM_FEATURE_TSC_RATE       (1 &lt;&lt;  4)</span>
<span class="cp">#define SVM_FEATURE_VMCB_CLEAN     (1 &lt;&lt;  5)</span>
<span class="cp">#define SVM_FEATURE_FLUSH_ASID     (1 &lt;&lt;  6)</span>
<span class="cp">#define SVM_FEATURE_DECODE_ASSIST  (1 &lt;&lt;  7)</span>
<span class="cp">#define SVM_FEATURE_PAUSE_FILTER   (1 &lt;&lt; 10)</span>

<span class="cp">#define NESTED_EXIT_HOST	0	</span><span class="cm">/* Exit handled on host level */</span><span class="cp"></span>
<span class="cp">#define NESTED_EXIT_DONE	1	</span><span class="cm">/* Exit caused nested vmexit  */</span><span class="cp"></span>
<span class="cp">#define NESTED_EXIT_CONTINUE	2	</span><span class="cm">/* Further checks needed      */</span><span class="cp"></span>

<span class="cp">#define DEBUGCTL_RESERVED_BITS (~(0x3fULL))</span>

<span class="cp">#define TSC_RATIO_RSVD          0xffffff0000000000ULL</span>
<span class="cp">#define TSC_RATIO_MIN		0x0000000000000001ULL</span>
<span class="cp">#define TSC_RATIO_MAX		0x000000ffffffffffULL</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">erratum_383_found</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">host_save_user_msrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">MSR_STAR</span><span class="p">,</span> <span class="n">MSR_LSTAR</span><span class="p">,</span> <span class="n">MSR_CSTAR</span><span class="p">,</span> <span class="n">MSR_SYSCALL_MASK</span><span class="p">,</span> <span class="n">MSR_KERNEL_GS_BASE</span><span class="p">,</span>
	<span class="n">MSR_FS_BASE</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="n">MSR_IA32_SYSENTER_CS</span><span class="p">,</span> <span class="n">MSR_IA32_SYSENTER_ESP</span><span class="p">,</span> <span class="n">MSR_IA32_SYSENTER_EIP</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define NR_HOST_SAVE_USER_MSRS ARRAY_SIZE(host_save_user_msrs)</span>

<span class="k">struct</span> <span class="n">kvm_vcpu</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">nested_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">hsave</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hsave_msr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vm_cr_msr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vmcb</span><span class="p">;</span>

	<span class="cm">/* These are the merged vectors */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">msrpm</span><span class="p">;</span>

	<span class="cm">/* gpa pointers to the real vectors */</span>
	<span class="n">u64</span> <span class="n">vmcb_msrpm</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vmcb_iopm</span><span class="p">;</span>

	<span class="cm">/* A VMEXIT is required but not yet emulated */</span>
	<span class="n">bool</span> <span class="n">exit_required</span><span class="p">;</span>

	<span class="cm">/* cache for intercepts of the guest */</span>
	<span class="n">u32</span> <span class="n">intercept_cr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intercept_dr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intercept_exceptions</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">intercept</span><span class="p">;</span>

	<span class="cm">/* Nested Paging related state */</span>
	<span class="n">u64</span> <span class="n">nested_cr3</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MSRPM_OFFSETS	16</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">msrpm_offsets</span><span class="p">[</span><span class="n">MSRPM_OFFSETS</span><span class="p">]</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Set osvw_len to higher value when updated Revision Guides</span>
<span class="cm"> * are published and we know what the new status bits are</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">osvw_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">osvw_status</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="n">vcpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vmcb_pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="o">*</span><span class="n">svm_data</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">asid_generation</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">sysenter_esp</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">sysenter_eip</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">next_rip</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">host_user_msrs</span><span class="p">[</span><span class="n">NR_HOST_SAVE_USER_MSRS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">fs</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">gs</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ldt</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">gs_base</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">host</span><span class="p">;</span>

	<span class="n">u32</span> <span class="o">*</span><span class="n">msrpm</span><span class="p">;</span>

	<span class="n">ulong</span> <span class="n">nmi_iret_rip</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">nested_state</span> <span class="n">nested</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">nmi_singlestep</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">int3_injected</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">int3_rip</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">apf_reason</span><span class="p">;</span>

	<span class="n">u64</span>  <span class="n">tsc_ratio</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">current_tsc_ratio</span><span class="p">);</span>
<span class="cp">#define TSC_RATIO_DEFAULT	0x0100000000ULL</span>

<span class="cp">#define MSR_INVALID			0xffffffffU</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svm_direct_access_msrs</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>   <span class="cm">/* Index of the MSR */</span>
	<span class="n">bool</span> <span class="n">always</span><span class="p">;</span> <span class="cm">/* True if intercept is always on */</span>
<span class="p">}</span> <span class="n">direct_access_msrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_STAR</span><span class="p">,</span>				<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_IA32_SYSENTER_CS</span><span class="p">,</span>		<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">},</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_GS_BASE</span><span class="p">,</span>				<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_FS_BASE</span><span class="p">,</span>				<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_KERNEL_GS_BASE</span><span class="p">,</span>			<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_LSTAR</span><span class="p">,</span>				<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_CSTAR</span><span class="p">,</span>				<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_SYSCALL_MASK</span><span class="p">,</span>			<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_IA32_LASTBRANCHFROMIP</span><span class="p">,</span>		<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">false</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_IA32_LASTBRANCHTOIP</span><span class="p">,</span>		<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">false</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_IA32_LASTINTFROMIP</span><span class="p">,</span>		<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">false</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_IA32_LASTINTTOIP</span><span class="p">,</span>		<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">false</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">MSR_INVALID</span><span class="p">,</span>				<span class="p">.</span><span class="n">always</span> <span class="o">=</span> <span class="nb">false</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* enable NPT for AMD64 and X86 with PAE */</span>
<span class="cp">#if defined(CONFIG_X86_64) || defined(CONFIG_X86_PAE)</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">npt_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">npt_enabled</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* allow nested paging (virtualized MMU) for all guests */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">npt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">npt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>

<span class="cm">/* allow nested virtualization in KVM/SVM */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">svm_flush_tlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">svm_complete_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nested_svm_exit_handled</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nested_svm_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nested_svm_vmexit</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nested_svm_check_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nr</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">has_error_code</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error_code</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">__scale_tsc</span><span class="p">(</span><span class="n">u64</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsc</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">VMCB_INTERCEPTS</span><span class="p">,</span> <span class="cm">/* Intercept vectors, TSC offset,</span>
<span class="cm">			    pause filter count */</span>
	<span class="n">VMCB_PERM_MAP</span><span class="p">,</span>   <span class="cm">/* IOPM Base and MSRPM Base */</span>
	<span class="n">VMCB_ASID</span><span class="p">,</span>	 <span class="cm">/* ASID */</span>
	<span class="n">VMCB_INTR</span><span class="p">,</span>	 <span class="cm">/* int_ctl, int_vector */</span>
	<span class="n">VMCB_NPT</span><span class="p">,</span>        <span class="cm">/* npt_en, nCR3, gPAT */</span>
	<span class="n">VMCB_CR</span><span class="p">,</span>	 <span class="cm">/* CR0, CR3, CR4, EFER */</span>
	<span class="n">VMCB_DR</span><span class="p">,</span>         <span class="cm">/* DR6, DR7 */</span>
	<span class="n">VMCB_DT</span><span class="p">,</span>         <span class="cm">/* GDT, IDT */</span>
	<span class="n">VMCB_SEG</span><span class="p">,</span>        <span class="cm">/* CS, DS, SS, ES, CPL */</span>
	<span class="n">VMCB_CR2</span><span class="p">,</span>        <span class="cm">/* CR2 only */</span>
	<span class="n">VMCB_LBR</span><span class="p">,</span>        <span class="cm">/* DBGCTL, BR_FROM, BR_TO, LAST_EX_FROM, LAST_EX_TO */</span>
	<span class="n">VMCB_DIRTY_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* TPR and CR2 are always written before VMRUN */</span>
<span class="cp">#define VMCB_ALWAYS_DIRTY_MASK	((1U &lt;&lt; VMCB_INTR) | (1U &lt;&lt; VMCB_CR2))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mark_all_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mark_all_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">clean</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VMCB_DIRTY_MAX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			       <span class="o">&amp;</span> <span class="o">~</span><span class="n">VMCB_ALWAYS_DIRTY_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mark_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">clean</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="nf">to_svm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recalc_intercepts</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nested_state</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>

	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_INTERCEPTS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="n">g</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">intercept_cr</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">intercept_cr</span> <span class="o">|</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">intercept_cr</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">intercept_dr</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">intercept_dr</span> <span class="o">|</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">intercept_dr</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">intercept_exceptions</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">intercept_exceptions</span> <span class="o">|</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">intercept_exceptions</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">|</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="nf">get_host_vmcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_cr_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_cr</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clr_cr_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_cr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_cr_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_cr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_dr_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_dr</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clr_dr_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_dr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_exception_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_exceptions</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clr_exception_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_exceptions</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clr_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enable_gif</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">HF_GIF_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">disable_gif</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HF_GIF_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">gif_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_GIF_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iopm_base</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">kvm_ldttss_desc</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">limit0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">base0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">base1</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span> <span class="n">type</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">dpl</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">limit1</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">zero0</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">g</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">base2</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">zero1</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">asid_generation</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_asid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">next_asid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_ldttss_desc</span> <span class="o">*</span><span class="n">tss_desc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">save_area</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="o">*</span><span class="p">,</span> <span class="n">svm_data</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">svm_init_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">msrpm_ranges</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xc0000000</span><span class="p">,</span> <span class="mh">0xc0010000</span><span class="p">};</span>

<span class="cp">#define NUM_MSR_MAPS ARRAY_SIZE(msrpm_ranges)</span>
<span class="cp">#define MSRS_RANGE_SIZE 2048</span>
<span class="cp">#define MSRS_IN_RANGE (MSRS_RANGE_SIZE * 8 / 2)</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">svm_msrpm_offset</span><span class="p">(</span><span class="n">u32</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_MSR_MAPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&lt;</span> <span class="n">msrpm_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span>
		    <span class="n">msr</span> <span class="o">&gt;=</span> <span class="n">msrpm_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">MSRS_IN_RANGE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">offset</span>  <span class="o">=</span> <span class="p">(</span><span class="n">msr</span> <span class="o">-</span> <span class="n">msrpm_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* 4 msrs per u8 */</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">MSRS_RANGE_SIZE</span><span class="p">);</span>       <span class="cm">/* add range offset */</span>

		<span class="cm">/* Now we have the u8 offset - but need the u32 offset */</span>
		<span class="k">return</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MSR not in any range */</span>
	<span class="k">return</span> <span class="n">MSR_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_INST_SIZE 15</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clgi</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="n">__ex</span><span class="p">(</span><span class="n">SVM_CLGI</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">stgi</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="n">__ex</span><span class="p">(</span><span class="n">SVM_STGI</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">invlpga</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">asid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="n">__ex</span><span class="p">(</span><span class="n">SVM_INVLPGA</span><span class="p">)</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;c&quot;</span><span class="p">(</span><span class="n">asid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_npt_level</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">return</span> <span class="n">PT64_ROOT_LEVEL</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">PT32E_ROOT_LEVEL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_efer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">efer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">efer</span> <span class="o">=</span> <span class="n">efer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npt_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LMA</span><span class="p">))</span>
		<span class="n">efer</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EFER_LME</span><span class="p">;</span>

	<span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">efer</span> <span class="o">=</span> <span class="n">efer</span> <span class="o">|</span> <span class="n">EFER_SVME</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_CR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_external_interrupt</span><span class="p">(</span><span class="n">u32</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span> <span class="o">&amp;=</span> <span class="n">SVM_EVTINJ_TYPE_MASK</span> <span class="o">|</span> <span class="n">SVM_EVTINJ_VALID</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">info</span> <span class="o">==</span> <span class="p">(</span><span class="n">SVM_EVTINJ_VALID</span> <span class="o">|</span> <span class="n">SVM_EVTINJ_TYPE_INTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">svm_get_interrupt_shadow</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span> <span class="o">&amp;</span> <span class="n">SVM_INTERRUPT_SHADOW_MASK</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">KVM_X86_SHADOW_INT_STI</span> <span class="o">|</span> <span class="n">KVM_X86_SHADOW_INT_MOV_SS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_interrupt_shadow</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SVM_INTERRUPT_SHADOW_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span> <span class="o">|=</span> <span class="n">SVM_INTERRUPT_SHADOW_MASK</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">skip_emulated_instruction</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">next_rip</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">next_rip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emulate_instruction</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULTYPE_SKIP</span><span class="p">)</span> <span class="o">!=</span>
				<span class="n">EMULATE_DONE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: NOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">-</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_INST_SIZE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ip 0x%lx next 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span><span class="p">);</span>

	<span class="n">kvm_rip_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span><span class="p">);</span>
	<span class="n">svm_set_interrupt_shadow</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_queue_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nr</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">has_error_code</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error_code</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">reinject</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are within a nested VM we&#39;d better #VMEXIT and let the guest</span>
<span class="cm">	 * handle the exception</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reinject</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nested_svm_check_exception</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">has_error_code</span><span class="p">,</span> <span class="n">error_code</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">BP_VECTOR</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_NRIPS</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rip</span><span class="p">,</span> <span class="n">old_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * For guest debugging where we have to reinject #BP if some</span>
<span class="cm">		 * INT3 is guest-owned:</span>
<span class="cm">		 * Emulate nRIP by moving RIP forward. Will fail if injection</span>
<span class="cm">		 * raises a fault that is not intercepted. Still better than</span>
<span class="cm">		 * failing in all cases.</span>
<span class="cm">		 */</span>
		<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">int3_rip</span> <span class="o">=</span> <span class="n">rip</span> <span class="o">+</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">int3_injected</span> <span class="o">=</span> <span class="n">rip</span> <span class="o">-</span> <span class="n">old_rip</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span> <span class="o">=</span> <span class="n">nr</span>
		<span class="o">|</span> <span class="n">SVM_EVTINJ_VALID</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">has_error_code</span> <span class="o">?</span> <span class="n">SVM_EVTINJ_VALID_ERR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">SVM_EVTINJ_TYPE_EXEPT</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj_err</span> <span class="o">=</span> <span class="n">error_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_init_erratum_383</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_amd_erratum</span><span class="p">(</span><span class="n">amd_erratum_383</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Use _safe variants to not break nested virtualization */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">native_read_msr_safe</span><span class="p">(</span><span class="n">MSR_AMD64_DC_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">47</span><span class="p">);</span>

	<span class="n">low</span>  <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">high</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">native_write_msr_safe</span><span class="p">(</span><span class="n">MSR_AMD64_DC_CFG</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>

	<span class="n">erratum_383_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_init_osvw</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Guests should see errata 400 and 415 as fixed (assuming that</span>
<span class="cm">	 * HLT and IO instructions are intercepted).</span>
<span class="cm">	 */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">osvw</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">osvw_len</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">osvw_len</span><span class="p">)</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">osvw</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">osvw_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">6ULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * By increasing VCPU&#39;s osvw.length to 3 we are telling the guest that</span>
<span class="cm">	 * all osvw.status bits inside that length, including bit 0 (which is</span>
<span class="cm">	 * reserved for erratum 298), are valid. However, if host processor&#39;s</span>
<span class="cm">	 * osvw_len is 0 then osvw_status[0] carries no information. We need to</span>
<span class="cm">	 * be conservative here and therefore we tell the guest that erratum 298</span>
<span class="cm">	 * is present (because we really don&#39;t know).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osvw_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">osvw</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">has_svm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_svm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;has_svm: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_hardware_disable</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">garbage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make sure we clean up behind us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_TSCRATEMSR</span><span class="p">))</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_AMD64_TSC_RATIO</span><span class="p">,</span> <span class="n">TSC_RATIO_DEFAULT</span><span class="p">);</span>

	<span class="n">cpu_svm_disable</span><span class="p">();</span>

	<span class="n">amd_pmu_disable_virt</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_hardware_enable</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">garbage</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">efer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_ptr</span> <span class="n">gdt_descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">gdt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">me</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_EFER</span><span class="p">,</span> <span class="n">efer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_SVME</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_svm</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;svm_hardware_enable: err EOPNOTSUPP on %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">me</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sd</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">svm_data</span><span class="p">,</span> <span class="n">me</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;svm_hardware_enable: svm_data is NULL on %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">me</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">asid_generation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">max_asid</span> <span class="o">=</span> <span class="n">cpuid_ebx</span><span class="p">(</span><span class="n">SVM_CPUID_FUNC</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">next_asid</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">max_asid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">native_store_gdt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdt_descr</span><span class="p">);</span>
	<span class="n">gdt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">gdt_descr</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">tss_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kvm_ldttss_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">gdt</span> <span class="o">+</span> <span class="n">GDT_ENTRY_TSS</span><span class="p">);</span>

	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_EFER</span><span class="p">,</span> <span class="n">efer</span> <span class="o">|</span> <span class="n">EFER_SVME</span><span class="p">);</span>

	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VM_HSAVE_PA</span><span class="p">,</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">save_area</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_TSCRATEMSR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_AMD64_TSC_RATIO</span><span class="p">,</span> <span class="n">TSC_RATIO_DEFAULT</span><span class="p">);</span>
		<span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">current_tsc_ratio</span><span class="p">)</span> <span class="o">=</span> <span class="n">TSC_RATIO_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Get OSVW bits.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that it is possible to have a system with mixed processor</span>
<span class="cm">	 * revisions and therefore different OSVW bits. If bits are not the same</span>
<span class="cm">	 * on different processors then choose the worst case (i.e. if erratum</span>
<span class="cm">	 * is present on one processor and not on another then assume that the</span>
<span class="cm">	 * erratum is present everywhere).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_cpu_data</span><span class="p">,</span> <span class="n">X86_FEATURE_OSVW</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">native_read_msr_safe</span><span class="p">(</span><span class="n">MSR_AMD64_OSVW_ID_LENGTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">native_read_msr_safe</span><span class="p">(</span><span class="n">MSR_AMD64_OSVW_STATUS</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">osvw_status</span> <span class="o">=</span> <span class="n">osvw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">osvw_len</span><span class="p">)</span>
				<span class="n">osvw_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">osvw_status</span> <span class="o">|=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">osvw_status</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">osvw_len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">osvw_status</span> <span class="o">=</span> <span class="n">osvw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">svm_init_erratum_383</span><span class="p">();</span>

	<span class="n">amd_pmu_enable_virt</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_cpu_uninit</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">svm_data</span><span class="p">,</span> <span class="n">raw_smp_processor_id</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">per_cpu</span><span class="p">(</span><span class="n">svm_data</span><span class="p">,</span> <span class="n">raw_smp_processor_id</span><span class="p">())</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__free_page</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">save_area</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_cpu_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">svm_cpu_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">save_area</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">save_area</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_1</span><span class="p">;</span>

	<span class="n">per_cpu</span><span class="p">(</span><span class="n">svm_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">valid_msr_intercept</span><span class="p">(</span><span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">direct_access_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">!=</span> <span class="n">MSR_INVALID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direct_access_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_msr_interception</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">msrpm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">msr</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">read</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bit_read</span><span class="p">,</span> <span class="n">bit_write</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this warning triggers extend the direct_access_msrs list at the</span>
<span class="cm">	 * beginning of the file</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">valid_msr_intercept</span><span class="p">(</span><span class="n">msr</span><span class="p">));</span>

	<span class="n">offset</span>    <span class="o">=</span> <span class="n">svm_msrpm_offset</span><span class="p">(</span><span class="n">msr</span><span class="p">);</span>
	<span class="n">bit_read</span>  <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">bit_write</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tmp</span>       <span class="o">=</span> <span class="n">msrpm</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">MSR_INVALID</span><span class="p">);</span>

	<span class="n">read</span>  <span class="o">?</span> <span class="n">clear_bit</span><span class="p">(</span><span class="n">bit_read</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">:</span> <span class="n">set_bit</span><span class="p">(</span><span class="n">bit_read</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">write</span> <span class="o">?</span> <span class="n">clear_bit</span><span class="p">(</span><span class="n">bit_write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">:</span> <span class="n">set_bit</span><span class="p">(</span><span class="n">bit_write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

	<span class="n">msrpm</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_vcpu_init_msrpm</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">msrpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MSRPM_ALLOC_ORDER</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">direct_access_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">!=</span> <span class="n">MSR_INVALID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct_access_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">always</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">direct_access_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_msr_offset</span><span class="p">(</span><span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MSRPM_OFFSETS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Offset already in list? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msrpm_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">offset</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* Slot used by another offset? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msrpm_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MSR_INVALID</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Add offset to list */</span>
		<span class="n">msrpm_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this BUG triggers the msrpm_offsets table has an overflow. Just</span>
<span class="cm">	 * increase MSRPM_OFFSETS in this case.</span>
<span class="cm">	 */</span>
	<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_msrpm_offsets</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msrpm_offsets</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msrpm_offsets</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">direct_access_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">!=</span> <span class="n">MSR_INVALID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">svm_msrpm_offset</span><span class="p">(</span><span class="n">direct_access_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">MSR_INVALID</span><span class="p">);</span>

		<span class="n">add_msr_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_enable_lbrv</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">msrpm</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">msrpm</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">lbr_ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">MSR_IA32_LASTBRANCHFROMIP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">MSR_IA32_LASTBRANCHTOIP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">MSR_IA32_LASTINTFROMIP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">MSR_IA32_LASTINTTOIP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_disable_lbrv</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">msrpm</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">msrpm</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">lbr_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">MSR_IA32_LASTBRANCHFROMIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">MSR_IA32_LASTBRANCHTOIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">MSR_IA32_LASTINTFROMIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_msr_interception</span><span class="p">(</span><span class="n">msrpm</span><span class="p">,</span> <span class="n">MSR_IA32_LASTINTTOIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">svm_hardware_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">iopm_pages</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">iopm_va</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">iopm_pages</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">IOPM_ALLOC_ORDER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iopm_pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">iopm_va</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">iopm_pages</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">iopm_va</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IOPM_ALLOC_ORDER</span><span class="p">));</span>
	<span class="n">iopm_base</span> <span class="o">=</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">iopm_pages</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">init_msrpm_offsets</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_NX</span><span class="p">))</span>
		<span class="n">kvm_enable_efer_bits</span><span class="p">(</span><span class="n">EFER_NX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_FXSR_OPT</span><span class="p">))</span>
		<span class="n">kvm_enable_efer_bits</span><span class="p">(</span><span class="n">EFER_FFXSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_TSCRATEMSR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">max</span><span class="p">;</span>

		<span class="n">kvm_has_tsc_control</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Make sure the user can only configure tsc_khz values that</span>
<span class="cm">		 * fit into a signed integer.</span>
<span class="cm">		 * A min value is not calculated needed because it will always</span>
<span class="cm">		 * be 1 on all machines and a value of 0 is used to disable</span>
<span class="cm">		 * tsc-scaling for the vcpu.</span>
<span class="cm">		 */</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mh">0x7fffffffULL</span><span class="p">,</span> <span class="n">__scale_tsc</span><span class="p">(</span><span class="n">tsc_khz</span><span class="p">,</span> <span class="n">TSC_RATIO_MAX</span><span class="p">));</span>

		<span class="n">kvm_max_guest_tsc_khz</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nested</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;kvm: Nested Virtualization enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kvm_enable_efer_bits</span><span class="p">(</span><span class="n">EFER_SVME</span> <span class="o">|</span> <span class="n">EFER_LMSLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">svm_cpu_init</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_NPT</span><span class="p">))</span>
		<span class="n">npt_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">npt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;kvm: Nested Paging disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">npt_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;kvm: Nested Paging enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kvm_enable_tdp</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">kvm_disable_tdp</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">__free_pages</span><span class="p">(</span><span class="n">iopm_pages</span><span class="p">,</span> <span class="n">IOPM_ALLOC_ORDER</span><span class="p">);</span>
	<span class="n">iopm_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">svm_hardware_unsetup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
		<span class="n">svm_cpu_uninit</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">__free_pages</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">iopm_base</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">),</span> <span class="n">IOPM_ALLOC_ORDER</span><span class="p">);</span>
	<span class="n">iopm_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_seg</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmcb_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">=</span> <span class="n">SVM_SELECTOR_P_MASK</span> <span class="o">|</span> <span class="n">SVM_SELECTOR_S_MASK</span> <span class="o">|</span>
		      <span class="n">SVM_SELECTOR_WRITE_MASK</span><span class="p">;</span> <span class="cm">/* Read/Write Data Segment */</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_sys_seg</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmcb_seg</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">=</span> <span class="n">SVM_SELECTOR_P_MASK</span> <span class="o">|</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">__scale_tsc</span><span class="p">(</span><span class="n">u64</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mult</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">_tsc</span><span class="p">;</span>

	<span class="n">mult</span>  <span class="o">=</span> <span class="n">ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">frac</span>  <span class="o">=</span> <span class="n">ratio</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">_tsc</span>  <span class="o">=</span> <span class="n">tsc</span><span class="p">;</span>
	<span class="n">_tsc</span> <span class="o">*=</span> <span class="n">mult</span><span class="p">;</span>
	<span class="n">_tsc</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tsc</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="n">frac</span><span class="p">;</span>
	<span class="n">_tsc</span> <span class="o">+=</span> <span class="p">((</span><span class="n">tsc</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">frac</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">_tsc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">svm_scale_tsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">_tsc</span> <span class="o">=</span> <span class="n">tsc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">tsc_ratio</span> <span class="o">!=</span> <span class="n">TSC_RATIO_DEFAULT</span><span class="p">)</span>
		<span class="n">_tsc</span> <span class="o">=</span> <span class="n">__scale_tsc</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">tsc_ratio</span><span class="p">,</span> <span class="n">tsc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">_tsc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_tsc_khz</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">user_tsc_khz</span><span class="p">,</span> <span class="n">bool</span> <span class="n">scale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">ratio</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">khz</span><span class="p">;</span>

	<span class="cm">/* Guest TSC same frequency as host TSC? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scale</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">tsc_ratio</span> <span class="o">=</span> <span class="n">TSC_RATIO_DEFAULT</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TSC scaling supported? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_TSCRATEMSR</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_tsc_khz</span> <span class="o">&gt;</span> <span class="n">tsc_khz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tsc_catchup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tsc_always_catchup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;user requested TSC rate below hardware speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">khz</span> <span class="o">=</span> <span class="n">user_tsc_khz</span><span class="p">;</span>

	<span class="cm">/* TSC scaling required  - calculate ratio */</span>
	<span class="n">ratio</span> <span class="o">=</span> <span class="n">khz</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">tsc_khz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ratio</span> <span class="o">&amp;</span> <span class="n">TSC_RATIO_RSVD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Invalid TSC ratio - virtual-tsc-khz=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">user_tsc_khz</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">tsc_ratio</span>             <span class="o">=</span> <span class="n">ratio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_write_tsc_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">g_tsc_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">g_tsc_offset</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span> <span class="o">-</span>
			       <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">g_tsc_offset</span><span class="p">;</span>

	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_INTERCEPTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_adjust_tsc_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">s64</span> <span class="n">adjustment</span><span class="p">,</span> <span class="n">bool</span> <span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">adjustment</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span>
		<span class="n">adjustment</span> <span class="o">=</span> <span class="n">svm_scale_tsc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">adjustment</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span> <span class="o">+=</span> <span class="n">adjustment</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span> <span class="o">+=</span> <span class="n">adjustment</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_INTERCEPTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">svm_compute_tsc_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">target_tsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tsc</span><span class="p">;</span>

	<span class="n">tsc</span> <span class="o">=</span> <span class="n">svm_scale_tsc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">native_read_tsc</span><span class="p">());</span>

	<span class="k">return</span> <span class="n">target_tsc</span> <span class="o">-</span> <span class="n">tsc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_vmcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb_save_area</span> <span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">fpu_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR0_READ</span><span class="p">);</span>
	<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR3_READ</span><span class="p">);</span>
	<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR4_READ</span><span class="p">);</span>
	<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR0_WRITE</span><span class="p">);</span>
	<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR3_WRITE</span><span class="p">);</span>
	<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR4_WRITE</span><span class="p">);</span>
	<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR8_WRITE</span><span class="p">);</span>

	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR0_READ</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR1_READ</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR2_READ</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR3_READ</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR4_READ</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR5_READ</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR6_READ</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR7_READ</span><span class="p">);</span>

	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR0_WRITE</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR1_WRITE</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR2_WRITE</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR3_WRITE</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR4_WRITE</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR5_WRITE</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR6_WRITE</span><span class="p">);</span>
	<span class="n">set_dr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_DR7_WRITE</span><span class="p">);</span>

	<span class="n">set_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">PF_VECTOR</span><span class="p">);</span>
	<span class="n">set_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">UD_VECTOR</span><span class="p">);</span>
	<span class="n">set_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">MC_VECTOR</span><span class="p">);</span>

	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_INTR</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_NMI</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_SMI</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_SELECTIVE_CR0</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_RDPMC</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CPUID</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_INVD</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_HLT</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_INVLPG</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_INVLPGA</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_IOIO_PROT</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_MSR_PROT</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_TASK_SWITCH</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_SHUTDOWN</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_VMRUN</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_VMMCALL</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_VMLOAD</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_VMSAVE</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_STGI</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CLGI</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_SKINIT</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_WBINVD</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_MONITOR</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_MWAIT</span><span class="p">);</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_XSETBV</span><span class="p">);</span>

	<span class="n">control</span><span class="o">-&gt;</span><span class="n">iopm_base_pa</span> <span class="o">=</span> <span class="n">iopm_base</span><span class="p">;</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">msrpm_base_pa</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">msrpm</span><span class="p">);</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">int_ctl</span> <span class="o">=</span> <span class="n">V_INTR_MASKING_MASK</span><span class="p">;</span>

	<span class="n">init_seg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">);</span>
	<span class="n">init_seg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">);</span>
	<span class="n">init_seg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">);</span>
	<span class="n">init_seg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">init_seg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">);</span>

	<span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="mh">0xf000</span><span class="p">;</span>
	<span class="cm">/* Executable/Readable Code Segment */</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">attrib</span> <span class="o">=</span> <span class="n">SVM_SELECTOR_READ_MASK</span> <span class="o">|</span> <span class="n">SVM_SELECTOR_P_MASK</span> <span class="o">|</span>
		<span class="n">SVM_SELECTOR_S_MASK</span> <span class="o">|</span> <span class="n">SVM_SELECTOR_CODE_MASK</span><span class="p">;</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * cs.base should really be 0xffff0000, but vmx can&#39;t handle that, so</span>
<span class="cm">	 * be consistent with it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Replace when we have real mode working for vmx.</span>
<span class="cm">	 */</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mh">0xf0000</span><span class="p">;</span>

	<span class="n">save</span><span class="o">-&gt;</span><span class="n">gdtr</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">idtr</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">init_sys_seg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">ldtr</span><span class="p">,</span> <span class="n">SEG_TYPE_LDT</span><span class="p">);</span>
	<span class="n">init_sys_seg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">tr</span><span class="p">,</span> <span class="n">SEG_TYPE_BUSY_TSS16</span><span class="p">);</span>

	<span class="n">svm_set_efer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">dr6</span> <span class="o">=</span> <span class="mh">0xffff0ff0</span><span class="p">;</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">dr7</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
	<span class="n">kvm_set_rflags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">rip</span> <span class="o">=</span> <span class="mh">0x0000fff0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RIP</span><span class="p">]</span> <span class="o">=</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">rip</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is the guest-visible cr0 value.</span>
<span class="cm">	 * svm_set_cr0() sets PG and WP and clears NW and CD on save-&gt;cr0.</span>
<span class="cm">	 */</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">kvm_set_cr0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">X86_CR0_NW</span> <span class="o">|</span> <span class="n">X86_CR0_CD</span> <span class="o">|</span> <span class="n">X86_CR0_ET</span><span class="p">);</span>

	<span class="n">save</span><span class="o">-&gt;</span><span class="n">cr4</span> <span class="o">=</span> <span class="n">X86_CR4_PAE</span><span class="p">;</span>
	<span class="cm">/* rdx = ?? */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setup VMCB for Nested Paging */</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">nested_ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_INVLPG</span><span class="p">);</span>
		<span class="n">clr_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">PF_VECTOR</span><span class="p">);</span>
		<span class="n">clr_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR3_READ</span><span class="p">);</span>
		<span class="n">clr_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR3_WRITE</span><span class="p">);</span>
		<span class="n">save</span><span class="o">-&gt;</span><span class="n">g_pat</span> <span class="o">=</span> <span class="mh">0x0007040600070406ULL</span><span class="p">;</span>
		<span class="n">save</span><span class="o">-&gt;</span><span class="n">cr3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">save</span><span class="o">-&gt;</span><span class="n">cr4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">asid_generation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_PAUSEFILTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">control</span><span class="o">-&gt;</span><span class="n">pause_filter_count</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
		<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_PAUSE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mark_all_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">);</span>

	<span class="n">enable_gif</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_vcpu_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">init_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvm_vcpu_is_bsp</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvm_rip_write</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">sipi_vector</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">sipi_vector</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs_avail</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs_dirty</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="nf">svm_create_vcpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">msrpm_pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">hsave_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">nested_msrpm_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">svm</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">kvm_vcpu_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">svm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">tsc_ratio</span> <span class="o">=</span> <span class="n">TSC_RATIO_DEFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kvm_vcpu_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvm</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_svm</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">uninit</span><span class="p">;</span>

	<span class="n">msrpm_pages</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">MSRPM_ALLOC_ORDER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msrpm_pages</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_page1</span><span class="p">;</span>

	<span class="n">nested_msrpm_pages</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">MSRPM_ALLOC_ORDER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nested_msrpm_pages</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_page2</span><span class="p">;</span>

	<span class="n">hsave_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsave_page</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_page3</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">hsave_page</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">msrpm</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">msrpm_pages</span><span class="p">);</span>
	<span class="n">svm_vcpu_init_msrpm</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">msrpm</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">msrpm</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">nested_msrpm_pages</span><span class="p">);</span>
	<span class="n">svm_vcpu_init_msrpm</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">msrpm</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">clear_page</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb_pa</span> <span class="o">=</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">asid_generation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
	<span class="n">kvm_write_tsc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fx_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_page4</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">=</span> <span class="mh">0xfee00000</span> <span class="o">|</span> <span class="n">MSR_IA32_APICBASE_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kvm_vcpu_is_bsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">|=</span> <span class="n">MSR_IA32_APICBASE_BSP</span><span class="p">;</span>

	<span class="n">svm_init_osvw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>

<span class="nl">free_page4:</span>
	<span class="n">__free_page</span><span class="p">(</span><span class="n">hsave_page</span><span class="p">);</span>
<span class="nl">free_page3:</span>
	<span class="n">__free_pages</span><span class="p">(</span><span class="n">nested_msrpm_pages</span><span class="p">,</span> <span class="n">MSRPM_ALLOC_ORDER</span><span class="p">);</span>
<span class="nl">free_page2:</span>
	<span class="n">__free_pages</span><span class="p">(</span><span class="n">msrpm_pages</span><span class="p">,</span> <span class="n">MSRPM_ALLOC_ORDER</span><span class="p">);</span>
<span class="nl">free_page1:</span>
	<span class="n">__free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="nl">uninit:</span>
	<span class="n">kvm_vcpu_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
<span class="nl">free_svm:</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">kvm_vcpu_cache</span><span class="p">,</span> <span class="n">svm</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_free_vcpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">__free_page</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb_pa</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>
	<span class="n">__free_pages</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">msrpm</span><span class="p">),</span> <span class="n">MSRPM_ALLOC_ORDER</span><span class="p">);</span>
	<span class="n">__free_page</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span><span class="p">));</span>
	<span class="n">__free_pages</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">msrpm</span><span class="p">),</span> <span class="n">MSRPM_ALLOC_ORDER</span><span class="p">);</span>
	<span class="n">kvm_vcpu_uninit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">kvm_vcpu_cache</span><span class="p">,</span> <span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_vcpu_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">asid_generation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mark_all_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_GS_BASE</span><span class="p">,</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">gs_base</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">savesegment</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">savesegment</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">gs</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">ldt</span> <span class="o">=</span> <span class="n">kvm_read_ldt</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_HOST_SAVE_USER_MSRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rdmsrl</span><span class="p">(</span><span class="n">host_save_user_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host_user_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_TSCRATEMSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">svm</span><span class="o">-&gt;</span><span class="n">tsc_ratio</span> <span class="o">!=</span> <span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">current_tsc_ratio</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">current_tsc_ratio</span><span class="p">)</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">tsc_ratio</span><span class="p">;</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_AMD64_TSC_RATIO</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">tsc_ratio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_vcpu_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="o">++</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">host_state_reload</span><span class="p">;</span>
	<span class="n">kvm_load_ldt</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">ldt</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">loadsegment</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_KERNEL_GS_BASE</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">gs</span><span class="p">);</span>
	<span class="n">load_gs_index</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">gs</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#ifdef CONFIG_X86_32_LAZY_GS</span>
	<span class="n">loadsegment</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">gs</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_HOST_SAVE_USER_MSRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">host_save_user_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host_user_msrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_update_cpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cpl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_protmode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="n">cpl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_VM</span><span class="p">)</span>
		<span class="n">cpl</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cpl</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cpl</span> <span class="o">=</span> <span class="n">cpl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">svm_get_rflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_rflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_rflags</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span><span class="p">;</span>

	<span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span> <span class="o">=</span> <span class="n">rflags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_rflags</span> <span class="o">^</span> <span class="n">rflags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_VM</span><span class="p">)</span>
		<span class="n">svm_update_cpl</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_cache_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">enum</span> <span class="n">kvm_reg</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VCPU_EXREG_PDPTR</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">npt_enabled</span><span class="p">);</span>
		<span class="n">load_pdptrs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">walk_mmu</span><span class="p">,</span> <span class="n">kvm_read_cr3</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_vintr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_VINTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_clear_vintr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_VINTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vmcb_seg</span> <span class="o">*</span><span class="nf">svm_seg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_save_area</span> <span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">seg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_CS</span>: <span class="k">return</span> <span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_DS</span>: <span class="k">return</span> <span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_ES</span>: <span class="k">return</span> <span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_FS</span>: <span class="k">return</span> <span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_GS</span>: <span class="k">return</span> <span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_SS</span>: <span class="k">return</span> <span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_TR</span>: <span class="k">return</span> <span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">tr</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_LDTR</span>: <span class="k">return</span> <span class="o">&amp;</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">ldtr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">svm_get_segment_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_seg</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">svm_seg</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_get_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">kvm_segment</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_seg</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">svm_seg</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>

	<span class="n">var</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">&amp;</span> <span class="n">SVM_SELECTOR_TYPE_MASK</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">&gt;&gt;</span> <span class="n">SVM_SELECTOR_S_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">dpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">&gt;&gt;</span> <span class="n">SVM_SELECTOR_DPL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">&gt;&gt;</span> <span class="n">SVM_SELECTOR_P_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">avl</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">&gt;&gt;</span> <span class="n">SVM_SELECTOR_AVL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">&gt;&gt;</span> <span class="n">SVM_SELECTOR_L_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">&gt;&gt;</span> <span class="n">SVM_SELECTOR_DB_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">&gt;&gt;</span> <span class="n">SVM_SELECTOR_G_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * AMD&#39;s VMCB does not have an explicit unusable field, so emulate it</span>
<span class="cm">	 * for cross vendor migration purposes by &quot;not present&quot;</span>
<span class="cm">	 */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">unusable</span> <span class="o">=</span> <span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">||</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">seg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_CS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * SVM always stores 0 for the &#39;G&#39; bit in the CS selector in</span>
<span class="cm">		 * the VMCB on a VMEXIT. This hurts cross-vendor migration:</span>
<span class="cm">		 * Intel&#39;s VMENTRY has a check on the &#39;G&#39; bit.</span>
<span class="cm">		 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">g</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mh">0xfffff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_TR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Work around a bug where the busy flag in the tr selector</span>
<span class="cm">		 * isn&#39;t exposed</span>
<span class="cm">		 */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_DS</span>:
	<span class="k">case</span> <span class="n">VCPU_SREG_ES</span>:
	<span class="k">case</span> <span class="n">VCPU_SREG_FS</span>:
	<span class="k">case</span> <span class="n">VCPU_SREG_GS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The accessed bit must always be set in the segment</span>
<span class="cm">		 * descriptor cache, although it can be cleared in the</span>
<span class="cm">		 * descriptor, the cached bit always remains at 1. Since</span>
<span class="cm">		 * Intel has a check on this, set it here to support</span>
<span class="cm">		 * cross-vendor migration.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">unusable</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCPU_SREG_SS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * On AMD CPUs sometimes the DB bit in the segment</span>
<span class="cm">		 * descriptor is left as 1, although the whole segment has</span>
<span class="cm">		 * been made unusable. Clear it here to pass an Intel VMX</span>
<span class="cm">		 * entry check when cross vendor migrating.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">unusable</span><span class="p">)</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_get_cpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_save_area</span> <span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_get_idt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span><span class="p">.</span><span class="n">limit</span><span class="p">;</span>
	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_idt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">dt</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">dt</span><span class="o">-&gt;</span><span class="n">address</span> <span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_DT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_get_gdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span><span class="p">.</span><span class="n">limit</span><span class="p">;</span>
	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_gdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">dt</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">dt</span><span class="o">-&gt;</span><span class="n">address</span> <span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_DT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_decache_cr0_guest_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_decache_cr3</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_decache_cr4_guest_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_cr0_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">gcr0</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">hcr0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">fpu_active</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hcr0</span> <span class="o">|=</span> <span class="n">SVM_CR0_SELECTIVE_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">hcr0</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">hcr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SVM_CR0_SELECTIVE_MASK</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">gcr0</span> <span class="o">&amp;</span> <span class="n">SVM_CR0_SELECTIVE_MASK</span><span class="p">);</span>

	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_CR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gcr0</span> <span class="o">==</span> <span class="o">*</span><span class="n">hcr0</span> <span class="o">&amp;&amp;</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">fpu_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clr_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR0_READ</span><span class="p">);</span>
		<span class="n">clr_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR0_WRITE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR0_READ</span><span class="p">);</span>
		<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR0_WRITE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_cr0</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_LME</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_paging</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="n">X86_CR0_PG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">efer</span> <span class="o">|=</span> <span class="n">EFER_LMA</span><span class="p">;</span>
			<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">efer</span> <span class="o">|=</span> <span class="n">EFER_LMA</span> <span class="o">|</span> <span class="n">EFER_LME</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_paging</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="n">X86_CR0_PG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">efer</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EFER_LMA</span><span class="p">;</span>
			<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">efer</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EFER_LMA</span> <span class="o">|</span> <span class="n">EFER_LME</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr0</span> <span class="o">=</span> <span class="n">cr0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npt_enabled</span><span class="p">)</span>
		<span class="n">cr0</span> <span class="o">|=</span> <span class="n">X86_CR0_PG</span> <span class="o">|</span> <span class="n">X86_CR0_WP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">fpu_active</span><span class="p">)</span>
		<span class="n">cr0</span> <span class="o">|=</span> <span class="n">X86_CR0_TS</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * re-enable caching here because the QEMU bios</span>
<span class="cm">	 * does not do it - this results in some delay at</span>
<span class="cm">	 * reboot</span>
<span class="cm">	 */</span>
	<span class="n">cr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">X86_CR0_CD</span> <span class="o">|</span> <span class="n">X86_CR0_NW</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr0</span> <span class="o">=</span> <span class="n">cr0</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_CR</span><span class="p">);</span>
	<span class="n">update_cr0_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_set_cr4</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">host_cr4_mce</span> <span class="o">=</span> <span class="n">read_cr4</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">X86_CR4_MCE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_cr4</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr4</span> <span class="o">&amp;</span> <span class="n">X86_CR4_VMXE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">old_cr4</span> <span class="o">^</span> <span class="n">cr4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_CR4_PGE</span><span class="p">))</span>
		<span class="n">svm_flush_tlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr4</span> <span class="o">=</span> <span class="n">cr4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npt_enabled</span><span class="p">)</span>
		<span class="n">cr4</span> <span class="o">|=</span> <span class="n">X86_CR4_PAE</span><span class="p">;</span>
	<span class="n">cr4</span> <span class="o">|=</span> <span class="n">host_cr4_mce</span><span class="p">;</span>
	<span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr4</span> <span class="o">=</span> <span class="n">cr4</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_CR</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">kvm_segment</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vmcb_seg</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">svm_seg</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">unusable</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SVM_SELECTOR_TYPE_MASK</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_SELECTOR_S_SHIFT</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">dpl</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_SELECTOR_DPL_SHIFT</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_SELECTOR_P_SHIFT</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">avl</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_SELECTOR_AVL_SHIFT</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_SELECTOR_L_SHIFT</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_SELECTOR_DB_SHIFT</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">attrib</span> <span class="o">|=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">g</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_SELECTOR_G_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="n">VCPU_SREG_CS</span><span class="p">)</span>
		<span class="n">svm_update_cpl</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_SEG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_db_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">clr_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">DB_VECTOR</span><span class="p">);</span>
	<span class="n">clr_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">BP_VECTOR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nmi_singlestep</span><span class="p">)</span>
		<span class="n">set_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">DB_VECTOR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">guest_debug</span> <span class="o">&amp;</span> <span class="n">KVM_GUESTDBG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">guest_debug</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">KVM_GUESTDBG_SINGLESTEP</span> <span class="o">|</span> <span class="n">KVM_GUESTDBG_USE_HW_BP</span><span class="p">))</span>
			<span class="n">set_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">DB_VECTOR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">guest_debug</span> <span class="o">&amp;</span> <span class="n">KVM_GUESTDBG_USE_SW_BP</span><span class="p">)</span>
			<span class="n">set_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">BP_VECTOR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">guest_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_guest_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_guest_debug</span> <span class="o">*</span><span class="n">dbg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">guest_debug</span> <span class="o">&amp;</span> <span class="n">KVM_GUESTDBG_USE_HW_BP</span><span class="p">)</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr7</span> <span class="o">=</span> <span class="n">dbg</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">debugreg</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr7</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dr7</span><span class="p">;</span>

	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_DR</span><span class="p">);</span>

	<span class="n">update_db_intercept</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">new_asid</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">next_asid</span> <span class="o">&gt;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">max_asid</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">asid_generation</span><span class="p">;</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">next_asid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tlb_ctl</span> <span class="o">=</span> <span class="n">TLB_CONTROL_FLUSH_ALL_ASID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">asid_generation</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">asid_generation</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">asid</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">next_asid</span><span class="o">++</span><span class="p">;</span>

	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_ASID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_dr7</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr7</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_DR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pf_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">fault_address</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error_code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">apf_reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">error_code</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span><span class="p">;</span>

		<span class="n">trace_kvm_page_fault</span><span class="p">(</span><span class="n">fault_address</span><span class="p">,</span> <span class="n">error_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npt_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">kvm_event_needs_reinjection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
			<span class="n">kvm_mmu_unprotect_page_virt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault_address</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_mmu_page_fault</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault_address</span><span class="p">,</span> <span class="n">error_code</span><span class="p">,</span>
			<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">insn_bytes</span><span class="p">,</span>
			<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">insn_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_PV_REASON_PAGE_NOT_PRESENT</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">apf_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">kvm_async_pf_task_wait</span><span class="p">(</span><span class="n">fault_address</span><span class="p">);</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_PV_REASON_PAGE_READY</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">apf_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">kvm_async_pf_task_wake</span><span class="p">(</span><span class="n">fault_address</span><span class="p">);</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">kvm_run</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">run</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">guest_debug</span> <span class="o">&amp;</span>
	      <span class="p">(</span><span class="n">KVM_GUESTDBG_SINGLESTEP</span> <span class="o">|</span> <span class="n">KVM_GUESTDBG_USE_HW_BP</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nmi_singlestep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvm_queue_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">DB_VECTOR</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nmi_singlestep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nmi_singlestep</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">guest_debug</span> <span class="o">&amp;</span> <span class="n">KVM_GUESTDBG_SINGLESTEP</span><span class="p">))</span>
			<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="n">X86_EFLAGS_TF</span> <span class="o">|</span> <span class="n">X86_EFLAGS_RF</span><span class="p">);</span>
		<span class="n">update_db_intercept</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">guest_debug</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">KVM_GUESTDBG_SINGLESTEP</span> <span class="o">|</span> <span class="n">KVM_GUESTDBG_USE_HW_BP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_DEBUG</span><span class="p">;</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span>
			<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">;</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">DB_VECTOR</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bp_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">kvm_run</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">run</span><span class="p">;</span>

	<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_DEBUG</span><span class="p">;</span>
	<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">;</span>
	<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">BP_VECTOR</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ud_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">er</span><span class="p">;</span>

	<span class="n">er</span> <span class="o">=</span> <span class="n">emulate_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULTYPE_TRAP_UD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">er</span> <span class="o">!=</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
		<span class="n">kvm_queue_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">UD_VECTOR</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_fpu_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">clr_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">NM_VECTOR</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">fpu_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">update_cr0_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nm_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svm_fpu_activate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_erratum_383</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">erratum_383_found</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">native_read_msr_safe</span><span class="p">(</span><span class="n">MSR_IA32_MC0_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Bit 62 may or may not be set for this mce */</span>
	<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">62</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mh">0xb600000000010015ULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Clear MCi_STATUS registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">native_write_msr_safe</span><span class="p">(</span><span class="n">MSR_IA32_MCx_STATUS</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">native_read_msr_safe</span><span class="p">(</span><span class="n">MSR_IA32_MCG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">low</span>    <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="n">high</span>   <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

		<span class="n">native_write_msr_safe</span><span class="p">(</span><span class="n">MSR_IA32_MCG_STATUS</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Flush tlb to evict multi-match entries */</span>
	<span class="n">__flush_tlb_all</span><span class="p">();</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_handle_mce</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_erratum_383</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Erratum 383 triggered. Guest state is corrupt so kill the</span>
<span class="cm">		 * guest.</span>
<span class="cm">		 */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;KVM: Guest triggered AMD Erratum 383</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_TRIPLE_FAULT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * On an #MC intercept the MCE handler is not called automatically in</span>
<span class="cm">	 * the host. So do it by hand here.</span>
<span class="cm">	 */</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
		<span class="s">&quot;int $0x12</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* not sure if we ever come back to this point */</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mc_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">shutdown_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">kvm_run</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">run</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * VMCB is undefined after a SHUTDOWN intercept</span>
<span class="cm">	 * so reinitialize it.</span>
<span class="cm">	 */</span>
	<span class="n">clear_page</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">);</span>
	<span class="n">init_vmcb</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_SHUTDOWN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">io_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">io_info</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span><span class="p">;</span> <span class="cm">/* address size bug? */</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">string</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port</span><span class="p">;</span>

	<span class="o">++</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">io_exits</span><span class="p">;</span>
	<span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_info</span> <span class="o">&amp;</span> <span class="n">SVM_IOIO_STR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_info</span> <span class="o">&amp;</span> <span class="n">SVM_IOIO_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">||</span> <span class="n">in</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">emulate_instruction</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">io_info</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_info</span> <span class="o">&amp;</span> <span class="n">SVM_IOIO_SIZE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SVM_IOIO_SIZE_SHIFT</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span><span class="p">;</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">kvm_fast_pio_out</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nmi_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intr_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">++</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">irq_exits</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nop_on_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">halt_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">kvm_emulate_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vmmcall_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_emulate_hypercall</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">nested_svm_get_tdp_cr3</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">nested_cr3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">nested_svm_get_tdp_pdptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">cr3</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">nested_cr3</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pdpte</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kvm_read_guest_page</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gpa_to_gfn</span><span class="p">(</span><span class="n">cr3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdpte</span><span class="p">,</span>
				  <span class="n">offset_in_page</span><span class="p">(</span><span class="n">cr3</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pdpte</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nested_svm_set_tdp_cr3</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">nested_cr3</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_NPT</span><span class="p">);</span>
	<span class="n">svm_flush_tlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nested_svm_inject_npf_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">x86_exception</span> <span class="o">*</span><span class="n">fault</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">SVM_EXIT_NPF</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>

	<span class="n">nested_svm_vmexit</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_init_mmu_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_init_shadow_mmu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">);</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">set_cr3</span>           <span class="o">=</span> <span class="n">nested_svm_set_tdp_cr3</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">get_cr3</span>           <span class="o">=</span> <span class="n">nested_svm_get_tdp_cr3</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">get_pdptr</span>         <span class="o">=</span> <span class="n">nested_svm_get_tdp_pdptr</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">inject_page_fault</span> <span class="o">=</span> <span class="n">nested_svm_inject_npf_exit</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">shadow_root_level</span> <span class="o">=</span> <span class="n">get_npt_level</span><span class="p">();</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">walk_mmu</span>              <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">nested_mmu</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nested_svm_uninit_mmu_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">walk_mmu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_check_permissions</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_SVME</span><span class="p">)</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">is_paging</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvm_queue_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">UD_VECTOR</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cpl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvm_inject_gp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_check_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nr</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">has_error_code</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vmexit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">=</span> <span class="n">error_code</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr2</span><span class="p">;</span>

	<span class="n">vmexit</span> <span class="o">=</span> <span class="n">nested_svm_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmexit</span> <span class="o">==</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">)</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">exit_required</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vmexit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function returns true if it is save to enable the irq window */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">nested_svm_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_VINTR_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_HIF_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if vmexit was already requested (by intercepted exception</span>
<span class="cm">	 * for instance) do not overwrite it with &quot;external interrupt&quot;</span>
<span class="cm">	 * vmexit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">exit_required</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span>   <span class="o">=</span> <span class="n">SVM_EXIT_INTR</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="mi">1ULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The #vmexit can&#39;t be emulated here directly because this</span>
<span class="cm">		 * code path runs with irqs and preemtion disabled. A</span>
<span class="cm">		 * #vmexit emulation might sleep. Only signal request for</span>
<span class="cm">		 * the #vmexit here.</span>
<span class="cm">		 */</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">exit_required</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">trace_kvm_nested_intr_vmexit</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function returns true if it is save to enable the nmi window */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">nested_svm_nmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">INTERCEPT_NMI</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">SVM_EXIT_NMI</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">exit_required</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">nested_svm_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="n">u64</span> <span class="n">gpa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">gfn_to_page</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gpa</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_error_page</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">kvm_release_page_clean</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">kvm_inject_gp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nested_svm_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">kvm_release_page_dirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_intercept_ioio</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">gpa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">INTERCEPT_IOIO_PROT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">NESTED_EXIT_HOST</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">gpa</span>  <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb_iopm</span> <span class="o">+</span> <span class="p">(</span><span class="n">port</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">bit</span>  <span class="o">=</span> <span class="n">port</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">val</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kvm_read_guest</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gpa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span> <span class="o">?</span> <span class="n">NESTED_EXIT_DONE</span> <span class="o">:</span> <span class="n">NESTED_EXIT_HOST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_exit_handled_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">msr</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">INTERCEPT_MSR_PROT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">NESTED_EXIT_HOST</span><span class="p">;</span>

	<span class="n">msr</span>    <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">];</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">svm_msrpm_offset</span><span class="p">(</span><span class="n">msr</span><span class="p">);</span>
	<span class="n">write</span>  <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mask</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="o">+</span> <span class="n">write</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">MSR_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">;</span>

	<span class="cm">/* Offset is in 32 bit units but need in 8 bit units */</span>
	<span class="n">offset</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kvm_read_guest</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">kvm</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb_msrpm</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="n">NESTED_EXIT_DONE</span> <span class="o">:</span> <span class="n">NESTED_EXIT_HOST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_exit_special</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">exit_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_INTR</span>:
	<span class="k">case</span> <span class="n">SVM_EXIT_NMI</span>:
	<span class="k">case</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">MC_VECTOR</span>:
		<span class="k">return</span> <span class="n">NESTED_EXIT_HOST</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_NPF</span>:
		<span class="cm">/* For now we are always handling NPFs when using them */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NESTED_EXIT_HOST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">PF_VECTOR</span>:
		<span class="cm">/* When we&#39;re shadowing, trap PFs, but not async PF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npt_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">apf_reason</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NESTED_EXIT_HOST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">NM_VECTOR</span>:
		<span class="n">nm_interception</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NESTED_EXIT_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If this function returns true, this #vmexit was already handled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vmexit</span> <span class="o">=</span> <span class="n">NESTED_EXIT_HOST</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">exit_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_MSR</span>:
		<span class="n">vmexit</span> <span class="o">=</span> <span class="n">nested_svm_exit_handled_msr</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_IOIO</span>:
		<span class="n">vmexit</span> <span class="o">=</span> <span class="n">nested_svm_intercept_ioio</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_READ_CR0</span> <span class="p">...</span> <span class="n">SVM_EXIT_WRITE_CR8</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">exit_code</span> <span class="o">-</span> <span class="n">SVM_EXIT_READ_CR0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept_cr</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
			<span class="n">vmexit</span> <span class="o">=</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_READ_DR0</span> <span class="p">...</span> <span class="n">SVM_EXIT_WRITE_DR7</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">exit_code</span> <span class="o">-</span> <span class="n">SVM_EXIT_READ_DR0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept_dr</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
			<span class="n">vmexit</span> <span class="o">=</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="p">...</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="mh">0x1f</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">excp_bits</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">exit_code</span> <span class="o">-</span> <span class="n">SVM_EXIT_EXCP_BASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept_exceptions</span> <span class="o">&amp;</span> <span class="n">excp_bits</span><span class="p">)</span>
			<span class="n">vmexit</span> <span class="o">=</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">;</span>
		<span class="cm">/* async page fault always cause vmexit */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">exit_code</span> <span class="o">==</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">PF_VECTOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">svm</span><span class="o">-&gt;</span><span class="n">apf_reason</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vmexit</span> <span class="o">=</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_ERR</span>: <span class="p">{</span>
		<span class="n">vmexit</span> <span class="o">=</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">exit_bits</span> <span class="o">=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">exit_code</span> <span class="o">-</span> <span class="n">SVM_EXIT_INTR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="n">exit_bits</span><span class="p">)</span>
			<span class="n">vmexit</span> <span class="o">=</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">vmexit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_exit_handled</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vmexit</span><span class="p">;</span>

	<span class="n">vmexit</span> <span class="o">=</span> <span class="n">nested_svm_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vmexit</span> <span class="o">==</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">)</span>
		<span class="n">nested_svm_vmexit</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vmexit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">copy_vmcb_control_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">dst_vmcb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">from_vmcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">dst</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dst_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">intercept_cr</span>         <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">intercept_cr</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">intercept_dr</span>         <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">intercept_dr</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">intercept_exceptions</span> <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">intercept_exceptions</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">intercept</span>            <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">iopm_base_pa</span>         <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">iopm_base_pa</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">msrpm_base_pa</span>        <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">msrpm_base_pa</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">tsc_offset</span>           <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">tsc_offset</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">asid</span>                 <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">asid</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">tlb_ctl</span>              <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">tlb_ctl</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">int_ctl</span>              <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">int_ctl</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">int_vector</span>           <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">int_vector</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">int_state</span>            <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">int_state</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">exit_code</span>            <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">exit_code</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">exit_code_hi</span>         <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">exit_code_hi</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">exit_info_1</span>          <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">exit_info_1</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">exit_info_2</span>          <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">exit_info_2</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">exit_int_info</span>        <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">exit_int_info</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">exit_int_info_err</span>    <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">exit_int_info_err</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">nested_ctl</span>           <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">nested_ctl</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">event_inj</span>            <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">event_inj</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">event_inj_err</span>        <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">event_inj_err</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">nested_cr3</span>           <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">nested_cr3</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">lbr_ctl</span>              <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">lbr_ctl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nested_svm_vmexit</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">nested_vmcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">hsave</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">trace_kvm_nested_vmexit_inject</span><span class="p">(</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span><span class="p">,</span>
				       <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span><span class="p">,</span>
				       <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span><span class="p">,</span>
				       <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span><span class="p">,</span>
				       <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info_err</span><span class="p">,</span>
				       <span class="n">KVM_ISA_SVM</span><span class="p">);</span>

	<span class="n">nested_vmcb</span> <span class="o">=</span> <span class="n">nested_svm_map</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nested_vmcb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Exit Guest-Mode */</span>
	<span class="n">leave_guest_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Give the current vmcb to the guest */</span>
	<span class="n">disable_gif</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">es</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">es</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ss</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ss</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ds</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ds</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span>   <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span>   <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">efer</span>   <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">efer</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr0</span>    <span class="o">=</span> <span class="n">kvm_read_cr0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span>    <span class="o">=</span> <span class="n">kvm_read_cr3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr2</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr2</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr4</span>    <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr4</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span> <span class="o">=</span> <span class="n">kvm_get_rflags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr7</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr7</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr6</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr6</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cpl</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cpl</span><span class="p">;</span>

	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span>           <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_vector</span>        <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_vector</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span>         <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span>         <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code_hi</span>      <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code_hi</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span>       <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span>       <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info_err</span> <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info_err</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">next_rip</span>          <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">next_rip</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we emulate a VMRUN/#VMEXIT in the same host #vmexit cycle we have</span>
<span class="cm">	 * to make sure that we do not lose injected events. So check event_inj</span>
<span class="cm">	 * here and copy it to exit_int_info if it is valid.</span>
<span class="cm">	 * Exit_int_info and event_inj can&#39;t be both valid because the case</span>
<span class="cm">	 * below only happens on a VMRUN instruction intercept which has</span>
<span class="cm">	 * no valid exit_int_info set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span> <span class="o">&amp;</span> <span class="n">SVM_EVTINJ_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">nc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>

		<span class="n">nc</span><span class="o">-&gt;</span><span class="n">exit_int_info</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span><span class="p">;</span>
		<span class="n">nc</span><span class="o">-&gt;</span><span class="n">exit_int_info_err</span> <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tlb_ctl</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj_err</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We always set V_INTR_MASKING and remember the old value in hflags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_VINTR_MASK</span><span class="p">))</span>
		<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V_INTR_MASKING_MASK</span><span class="p">;</span>

	<span class="cm">/* Restore the original control entries */</span>
	<span class="n">copy_vmcb_control_area</span><span class="p">(</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">hsave</span><span class="p">);</span>

	<span class="n">kvm_clear_exception_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_clear_interrupt_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">nested_cr3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Restore selected save entries */</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">es</span> <span class="o">=</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">es</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ss</span> <span class="o">=</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ss</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ds</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span> <span class="o">=</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span> <span class="o">=</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span><span class="p">;</span>
	<span class="n">kvm_set_rflags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span><span class="p">);</span>
	<span class="n">svm_set_efer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">efer</span><span class="p">);</span>
	<span class="n">svm_set_cr0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr0</span> <span class="o">|</span> <span class="n">X86_CR0_PE</span><span class="p">);</span>
	<span class="n">svm_set_cr4</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span> <span class="o">=</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr3</span> <span class="o">=</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">kvm_set_cr3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RAX</span><span class="p">,</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">);</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RSP</span><span class="p">,</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RIP</span><span class="p">,</span> <span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cpl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mark_all_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">);</span>

	<span class="n">nested_svm_unmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="n">nested_svm_uninit_mmu_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_mmu_reset_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_mmu_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nested_svm_vmrun_msrpm</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This function merges the msr permission bitmaps of kvm and the</span>
<span class="cm">	 * nested vmcb. It is omptimized in that it only merges the parts where</span>
<span class="cm">	 * the kvm msr permission bitmap may contain zero bits</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">INTERCEPT_MSR_PROT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MSRPM_OFFSETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msrpm_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">p</span>      <span class="o">=</span> <span class="n">msrpm_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb_msrpm</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kvm_read_guest</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">kvm</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">msrpm</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">msrpm</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">msrpm_base_pa</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">msrpm</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nested_vmcb_checks</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">INTERCEPT_VMRUN</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">asid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">nested_ctl</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">npt_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nested_svm_vmrun</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">nested_vmcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">hsave</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vmcb_gpa</span><span class="p">;</span>

	<span class="n">vmcb_gpa</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">;</span>

	<span class="n">nested_vmcb</span> <span class="o">=</span> <span class="n">nested_svm_map</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nested_vmcb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nested_vmcb_checks</span><span class="p">(</span><span class="n">nested_vmcb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span>    <span class="o">=</span> <span class="n">SVM_EXIT_ERR</span><span class="p">;</span>
		<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">nested_svm_unmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_kvm_nested_vmrun</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">,</span> <span class="n">vmcb_gpa</span><span class="p">,</span>
			       <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">,</span>
			       <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span><span class="p">,</span>
			       <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span><span class="p">,</span>
			       <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">nested_ctl</span><span class="p">);</span>

	<span class="n">trace_kvm_nested_intercepts</span><span class="p">(</span><span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_cr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
				    <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_cr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
				    <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_exceptions</span><span class="p">,</span>
				    <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept</span><span class="p">);</span>

	<span class="cm">/* Clear internal status */</span>
	<span class="n">kvm_clear_exception_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_clear_interrupt_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save the old vmcb, so we don&#39;t need to pick what we save, but can</span>
<span class="cm">	 * restore everything when a VMEXIT occurs</span>
<span class="cm">	 */</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">es</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">es</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ss</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ss</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ds</span>     <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ds</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span>   <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span>   <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">efer</span>   <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">efer</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr0</span>    <span class="o">=</span> <span class="n">kvm_read_cr0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr4</span>    <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr4</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span> <span class="o">=</span> <span class="n">kvm_get_rflags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span>    <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span>
		<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span>    <span class="o">=</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hsave</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span>    <span class="o">=</span> <span class="n">kvm_read_cr3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">copy_vmcb_control_area</span><span class="p">(</span><span class="n">hsave</span><span class="p">,</span> <span class="n">vmcb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kvm_get_rflags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_IF</span><span class="p">)</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">HF_HIF_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HF_HIF_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">nested_ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvm_mmu_unload</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">nested_cr3</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">nested_cr3</span><span class="p">;</span>
		<span class="n">nested_svm_init_mmu_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Load the nested guest state */</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">es</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">es</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ss</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ss</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ds</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gdtr</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">idtr</span><span class="p">;</span>
	<span class="n">kvm_set_rflags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span><span class="p">);</span>
	<span class="n">svm_set_efer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">efer</span><span class="p">);</span>
	<span class="n">svm_set_cr0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr0</span><span class="p">);</span>
	<span class="n">svm_set_cr4</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr3</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">kvm_set_cr3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span><span class="p">);</span>

	<span class="cm">/* Guest paging mode is active - reset mmu */</span>
	<span class="n">kvm_mmu_reset_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr2</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr2</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr2</span><span class="p">;</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RAX</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">);</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RSP</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">kvm_register_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RIP</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">);</span>

	<span class="cm">/* In case we don&#39;t even reach vcpu_run, the fields are not updated */</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr7</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr7</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr6</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dr6</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cpl</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cpl</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb_msrpm</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">msrpm_base_pa</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0fffULL</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb_iopm</span>  <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">iopm_base_pa</span>  <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0fffULL</span><span class="p">;</span>

	<span class="cm">/* cache intercepts */</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept_cr</span>         <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_cr</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept_dr</span>         <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_dr</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept_exceptions</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept_exceptions</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span>            <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">intercept</span><span class="p">;</span>

	<span class="n">svm_flush_tlb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">|</span> <span class="n">V_INTR_MASKING_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">&amp;</span> <span class="n">V_INTR_MASKING_MASK</span><span class="p">)</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">HF_VINTR_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HF_VINTR_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_VINTR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We only want the cr8 intercept bits of the guest */</span>
		<span class="n">clr_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR8_READ</span><span class="p">);</span>
		<span class="n">clr_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR8_WRITE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We don&#39;t want to see VMMCALLs from a nested guest */</span>
	<span class="n">clr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_VMMCALL</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">lbr_ctl</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">lbr_ctl</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_vector</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_vector</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span> <span class="o">+=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj_err</span> <span class="o">=</span> <span class="n">nested_vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj_err</span><span class="p">;</span>

	<span class="n">nested_svm_unmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="cm">/* Enter Guest-Mode */</span>
	<span class="n">enter_guest_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Merge guest and host intercepts - must be called  with vcpu in</span>
<span class="cm">	 * guest-mode to take affect here</span>
<span class="cm">	 */</span>
	<span class="n">recalc_intercepts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">vmcb_gpa</span><span class="p">;</span>

	<span class="n">enable_gif</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">mark_all_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nested_svm_vmloadsave</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">from_vmcb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">to_vmcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">fs</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gs</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">gs</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">tr</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ldtr</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">ldtr</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">kernel_gs_base</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">kernel_gs_base</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">star</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">star</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">lstar</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">lstar</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cstar</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cstar</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sfmask</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sfmask</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_cs</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_cs</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_esp</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_esp</span><span class="p">;</span>
	<span class="n">to_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_eip</span> <span class="o">=</span> <span class="n">from_vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_eip</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vmload_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">nested_vmcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nested_svm_check_permissions</span><span class="p">(</span><span class="n">svm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">nested_vmcb</span> <span class="o">=</span> <span class="n">nested_svm_map</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nested_vmcb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">nested_svm_vmloadsave</span><span class="p">(</span><span class="n">nested_vmcb</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">);</span>
	<span class="n">nested_svm_unmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vmsave_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">nested_vmcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nested_svm_check_permissions</span><span class="p">(</span><span class="n">svm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">nested_vmcb</span> <span class="o">=</span> <span class="n">nested_svm_map</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nested_vmcb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">nested_svm_vmloadsave</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">nested_vmcb</span><span class="p">);</span>
	<span class="n">nested_svm_unmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vmrun_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nested_svm_check_permissions</span><span class="p">(</span><span class="n">svm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Save rip after vmrun instruction */</span>
	<span class="n">kvm_rip_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nested_svm_vmrun</span><span class="p">(</span><span class="n">svm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nested_svm_vmrun_msrpm</span><span class="p">(</span><span class="n">svm</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">failed:</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span>    <span class="o">=</span> <span class="n">SVM_EXIT_ERR</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nested_svm_vmexit</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stgi_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nested_svm_check_permissions</span><span class="p">(</span><span class="n">svm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">enable_gif</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clgi_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nested_svm_check_permissions</span><span class="p">(</span><span class="n">svm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">disable_gif</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="cm">/* After a CLGI no interrupts should come */</span>
	<span class="n">svm_clear_vintr</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V_IRQ_MASK</span><span class="p">;</span>

	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_INTR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">invlpga_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>

	<span class="n">trace_kvm_invlpga</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">],</span>
			  <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]);</span>

	<span class="cm">/* Let&#39;s treat INVLPGA the same as INVLPG (can be optimized!) */</span>
	<span class="n">kvm_mmu_invlpg</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">skinit_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">trace_kvm_skinit</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]);</span>

	<span class="n">kvm_queue_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">UD_VECTOR</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xsetbv_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">new_bv</span> <span class="o">=</span> <span class="n">kvm_read_edx_eax</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="n">kvm_register_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU_REGS_RCX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kvm_set_xcr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">new_bv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">invalid_op_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvm_queue_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">UD_VECTOR</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">task_switch_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tss_selector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reason</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">int_type</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span> <span class="o">&amp;</span>
		<span class="n">SVM_EXITINTINFO_TYPE_MASK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">int_vec</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span> <span class="o">&amp;</span> <span class="n">SVM_EVTINJ_VEC_MASK</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">type</span> <span class="o">=</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span> <span class="o">&amp;</span> <span class="n">SVM_EXITINTINFO_TYPE_MASK</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">idt_v</span> <span class="o">=</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span> <span class="o">&amp;</span> <span class="n">SVM_EXITINTINFO_VALID</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_error_code</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tss_selector</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_EXITINFOSHIFT_TS_REASON_IRET</span><span class="p">))</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">TASK_SWITCH_IRET</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span> <span class="o">&amp;</span>
		 <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_EXITINFOSHIFT_TS_REASON_JMP</span><span class="p">))</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">TASK_SWITCH_JMP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idt_v</span><span class="p">)</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">TASK_SWITCH_GATE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">TASK_SWITCH_CALL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">TASK_SWITCH_GATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SVM_EXITINTINFO_TYPE_NMI</span>:
			<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">nmi_injected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SVM_EXITINTINFO_TYPE_EXEPT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span> <span class="o">&amp;</span>
			    <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_EXITINFOSHIFT_TS_HAS_ERROR_CODE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">has_error_code</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">error_code</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kvm_clear_exception_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SVM_EXITINTINFO_TYPE_INTR</span>:
			<span class="n">kvm_clear_interrupt_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">TASK_SWITCH_GATE</span> <span class="o">||</span>
	    <span class="n">int_type</span> <span class="o">==</span> <span class="n">SVM_EXITINTINFO_TYPE_SOFT</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">int_type</span> <span class="o">==</span> <span class="n">SVM_EXITINTINFO_TYPE_EXEPT</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">int_vec</span> <span class="o">==</span> <span class="n">OF_VECTOR</span> <span class="o">||</span> <span class="n">int_vec</span> <span class="o">==</span> <span class="n">BP_VECTOR</span><span class="p">)))</span>
		<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_type</span> <span class="o">!=</span> <span class="n">SVM_EXITINTINFO_TYPE_SOFT</span><span class="p">)</span>
		<span class="n">int_vec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kvm_task_switch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tss_selector</span><span class="p">,</span> <span class="n">int_vec</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span>
				<span class="n">has_error_code</span><span class="p">,</span> <span class="n">error_code</span><span class="p">)</span> <span class="o">==</span> <span class="n">EMULATE_FAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_INTERNAL_ERROR</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">.</span><span class="n">suberror</span> <span class="o">=</span> <span class="n">KVM_INTERNAL_ERROR_EMULATION</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">.</span><span class="n">ndata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpuid_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">kvm_emulate_cpuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iret_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">++</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">nmi_window_exits</span><span class="p">;</span>
	<span class="n">clr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_IRET</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">HF_IRET_MASK</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nmi_iret_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">invlpg_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_DECODEASSISTS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>

	<span class="n">kvm_mmu_invlpg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span><span class="p">);</span>
	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_on_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">emulate_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdpmc_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_NRIPS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_on_interception</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kvm_rdpmc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_complete_insn_gp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">check_selective_cr0_intercepted</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr0</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">intercept</span><span class="p">;</span>

	<span class="n">intercept</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">INTERCEPT_SELECTIVE_CR0</span><span class="p">))))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">cr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SVM_CR0_SELECTIVE_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SVM_CR0_SELECTIVE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">^</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">SVM_EXIT_CR0_SEL_WRITE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">nested_svm_exit_handled</span><span class="p">(</span><span class="n">svm</span><span class="p">)</span> <span class="o">==</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CR_VALID (1ULL &lt;&lt; 63)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cr_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">cr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_DECODEASSISTS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_on_interception</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">&amp;</span> <span class="n">CR_VALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_on_interception</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">&amp;</span> <span class="n">SVM_EXITINFO_REG_MASK</span><span class="p">;</span>
	<span class="n">cr</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">-</span> <span class="n">SVM_EXIT_READ_CR0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* mov to cr */</span>
		<span class="n">cr</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">kvm_register_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_selective_cr0_intercepted</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">kvm_set_cr0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">kvm_set_cr3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">kvm_set_cr4</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">kvm_set_cr8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unhandled write to CR%d&quot;</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
			<span class="n">kvm_queue_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">UD_VECTOR</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* mov from cr */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">kvm_read_cr0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">cr2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">kvm_read_cr3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">kvm_read_cr4</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">kvm_get_cr8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unhandled read from CR%d&quot;</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
			<span class="n">kvm_queue_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">UD_VECTOR</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kvm_register_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kvm_complete_insn_gp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dr_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">dr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_DECODEASSISTS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">emulate_on_interception</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">&amp;</span> <span class="n">SVM_EXITINFO_REG_MASK</span><span class="p">;</span>
	<span class="n">dr</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">-</span> <span class="n">SVM_EXIT_READ_DR0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dr</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* mov to DRn */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">kvm_register_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">kvm_set_dr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">dr</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">kvm_get_dr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">kvm_register_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cr8_write_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">kvm_run</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">run</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">cr8_prev</span> <span class="o">=</span> <span class="n">kvm_get_cr8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="cm">/* instruction emulation calls kvm_set_cr8() */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">cr_interception</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">kvm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clr_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR8_WRITE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr8_prev</span> <span class="o">&lt;=</span> <span class="n">kvm_get_cr8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_SET_TPR</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">svm_read_l1_tsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">get_host_vmcb</span><span class="p">(</span><span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span> <span class="o">+</span>
		<span class="n">svm_scale_tsc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">native_read_tsc</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_get_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ecx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSR_IA32_TSC</span>: <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tsc_offset</span> <span class="o">+</span>
			<span class="n">svm_scale_tsc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">native_read_tsc</span><span class="p">());</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MSR_STAR</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">star</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">case</span> <span class="n">MSR_LSTAR</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">lstar</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_CSTAR</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cstar</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_KERNEL_GS_BASE</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">kernel_gs_base</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_SYSCALL_MASK</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sfmask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_CS</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_cs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_EIP</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">sysenter_eip</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_ESP</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">sysenter_esp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Nobody will change the following 5 values in the VMCB so we can</span>
<span class="cm">	 * safely return them on rdmsr. They will always be 0 until LBRV is</span>
<span class="cm">	 * implemented.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">MSR_IA32_DEBUGCTLMSR</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dbgctl</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_LASTBRANCHFROMIP</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">br_from</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_LASTBRANCHTOIP</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">br_to</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_LASTINTFROMIP</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">last_excp_from</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_LASTINTTOIP</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">last_excp_to</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_VM_HSAVE_PA</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave_msr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_VM_CR</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vm_cr_msr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_UCODE_REV</span>:
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mh">0x01000065</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">kvm_get_msr_common</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rdmsr_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ecx</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm_get_msr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">trace_kvm_msr_read_ex</span><span class="p">(</span><span class="n">ecx</span><span class="p">);</span>
		<span class="n">kvm_inject_gp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">trace_kvm_msr_read</span><span class="p">(</span><span class="n">ecx</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_set_vm_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">svm_dis</span><span class="p">,</span> <span class="n">chg_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SVM_VM_CR_VALID_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">chg_mask</span> <span class="o">=</span> <span class="n">SVM_VM_CR_VALID_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vm_cr_msr</span> <span class="o">&amp;</span> <span class="n">SVM_VM_CR_SVM_DIS_MASK</span><span class="p">)</span>
		<span class="n">chg_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SVM_VM_CR_SVM_LOCK_MASK</span> <span class="o">|</span> <span class="n">SVM_VM_CR_SVM_DIS_MASK</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vm_cr_msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">chg_mask</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vm_cr_msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">chg_mask</span><span class="p">);</span>

	<span class="n">svm_dis</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">vm_cr_msr</span> <span class="o">&amp;</span> <span class="n">SVM_VM_CR_SVM_DIS_MASK</span><span class="p">;</span>

	<span class="cm">/* check for svm_disable while efer.svme is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svm_dis</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">efer</span> <span class="o">&amp;</span> <span class="n">EFER_SVME</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_set_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ecx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSR_IA32_TSC</span>:
		<span class="n">kvm_write_tsc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_STAR</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">star</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">case</span> <span class="n">MSR_LSTAR</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">lstar</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_CSTAR</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cstar</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_KERNEL_GS_BASE</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">kernel_gs_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_SYSCALL_MASK</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sfmask</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_CS</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_cs</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_EIP</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">sysenter_eip</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_eip</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_ESP</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">sysenter_esp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">sysenter_esp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_IA32_DEBUGCTLMSR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_LBRV</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_unimpl</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;%s: MSR_IA32_DEBUGCTL 0x%llx, nop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">DEBUGCTL_RESERVED_BITS</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">dbgctl</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_LBR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span>
			<span class="n">svm_enable_lbrv</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">svm_disable_lbrv</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_VM_HSAVE_PA</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">hsave_msr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_VM_CR</span>:
		<span class="k">return</span> <span class="n">svm_set_vm_cr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MSR_VM_IGNNE</span>:
		<span class="n">pr_unimpl</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;unimplemented wrmsr: 0x%x data 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">kvm_set_msr_common</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wrmsr_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ecx</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">1u</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">1u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>


	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svm_set_msr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">trace_kvm_msr_write_ex</span><span class="p">(</span><span class="n">ecx</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">kvm_inject_gp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">trace_kvm_msr_write</span><span class="p">(</span><span class="n">ecx</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">skip_emulated_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msr_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">wrmsr_interception</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">rdmsr_interception</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">interrupt_window_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">kvm_run</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">run</span><span class="p">;</span>

	<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svm_clear_vintr</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V_IRQ_MASK</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_INTR</span><span class="p">);</span>
	<span class="o">++</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">irq_window_exits</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the user space waits to inject interrupts, exit as soon as</span>
<span class="cm">	 * possible</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">kvm</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">request_interrupt_window</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">kvm_cpu_has_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_IRQ_WINDOW_OPEN</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pause_interception</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvm_vcpu_on_spin</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">svm_exit_handlers</span><span class="p">[])(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_CR0</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_CR3</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_CR4</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_CR8</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_CR0_SEL_WRITE</span><span class="p">]</span>		<span class="o">=</span> <span class="n">emulate_on_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_CR0</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_CR3</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_CR4</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_CR8</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cr8_write_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_DR0</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_DR1</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_DR2</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_DR3</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_DR4</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_DR5</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_DR6</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_READ_DR7</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_DR0</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_DR1</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_DR2</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_DR3</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_DR4</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_DR5</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_DR6</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WRITE_DR7</span><span class="p">]</span>			<span class="o">=</span> <span class="n">dr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">DB_VECTOR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">db_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">BP_VECTOR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">bp_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">UD_VECTOR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ud_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">PF_VECTOR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pf_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">NM_VECTOR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">nm_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">MC_VECTOR</span><span class="p">]</span>	<span class="o">=</span> <span class="n">mc_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_INTR</span><span class="p">]</span>				<span class="o">=</span> <span class="n">intr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_NMI</span><span class="p">]</span>				<span class="o">=</span> <span class="n">nmi_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_SMI</span><span class="p">]</span>				<span class="o">=</span> <span class="n">nop_on_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_INIT</span><span class="p">]</span>				<span class="o">=</span> <span class="n">nop_on_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_VINTR</span><span class="p">]</span>			<span class="o">=</span> <span class="n">interrupt_window_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_RDPMC</span><span class="p">]</span>			<span class="o">=</span> <span class="n">rdpmc_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_CPUID</span><span class="p">]</span>			<span class="o">=</span> <span class="n">cpuid_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_IRET</span><span class="p">]</span>                         <span class="o">=</span> <span class="n">iret_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_INVD</span><span class="p">]</span>                         <span class="o">=</span> <span class="n">emulate_on_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_PAUSE</span><span class="p">]</span>			<span class="o">=</span> <span class="n">pause_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_HLT</span><span class="p">]</span>				<span class="o">=</span> <span class="n">halt_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_INVLPG</span><span class="p">]</span>			<span class="o">=</span> <span class="n">invlpg_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_INVLPGA</span><span class="p">]</span>			<span class="o">=</span> <span class="n">invlpga_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_IOIO</span><span class="p">]</span>				<span class="o">=</span> <span class="n">io_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_MSR</span><span class="p">]</span>				<span class="o">=</span> <span class="n">msr_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_TASK_SWITCH</span><span class="p">]</span>			<span class="o">=</span> <span class="n">task_switch_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_SHUTDOWN</span><span class="p">]</span>			<span class="o">=</span> <span class="n">shutdown_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_VMRUN</span><span class="p">]</span>			<span class="o">=</span> <span class="n">vmrun_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_VMMCALL</span><span class="p">]</span>			<span class="o">=</span> <span class="n">vmmcall_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_VMLOAD</span><span class="p">]</span>			<span class="o">=</span> <span class="n">vmload_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_VMSAVE</span><span class="p">]</span>			<span class="o">=</span> <span class="n">vmsave_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_STGI</span><span class="p">]</span>				<span class="o">=</span> <span class="n">stgi_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_CLGI</span><span class="p">]</span>				<span class="o">=</span> <span class="n">clgi_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_SKINIT</span><span class="p">]</span>			<span class="o">=</span> <span class="n">skinit_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_WBINVD</span><span class="p">]</span>                       <span class="o">=</span> <span class="n">emulate_on_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_MONITOR</span><span class="p">]</span>			<span class="o">=</span> <span class="n">invalid_op_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_MWAIT</span><span class="p">]</span>			<span class="o">=</span> <span class="n">invalid_op_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_XSETBV</span><span class="p">]</span>			<span class="o">=</span> <span class="n">xsetbv_interception</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SVM_EXIT_NPF</span><span class="p">]</span>				<span class="o">=</span> <span class="n">pf_interception</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_vmcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb_save_area</span> <span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">;</span>

	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;VMCB Control Area:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;cr_read:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">intercept_cr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;cr_write:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">intercept_cr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;dr_read:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">intercept_dr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;dr_write:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">intercept_dr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;exceptions:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">intercept_exceptions</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;intercepts:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;pause filter count:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">pause_filter_count</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;iopm_base_pa:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">iopm_base_pa</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;msrpm_base_pa:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">msrpm_base_pa</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;tsc_offset:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">tsc_offset</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;asid:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">asid</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;tlb_ctl:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">tlb_ctl</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;int_ctl:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">int_ctl</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;int_vector:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">int_vector</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;int_state:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">int_state</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;exit_code:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_code</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;exit_info1:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_info_1</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;exit_info2:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_info_2</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;exit_int_info:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_int_info</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;exit_int_info_err:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_int_info_err</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;nested_ctl:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">nested_ctl</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;nested_cr3:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">nested_cr3</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;event_inj:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">event_inj</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;event_inj_err:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">event_inj_err</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;lbr_ctl:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">lbr_ctl</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-20s%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;next_rip:&quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">next_rip</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;VMCB State Save Area:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;es:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">es</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;cs:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;ss:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;ds:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">ds</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;fs:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;gs:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">gs</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;gdtr:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">gdtr</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">gdtr</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">gdtr</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">gdtr</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;ldtr:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">ldtr</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">ldtr</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">ldtr</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">ldtr</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;idtr:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">idtr</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">idtr</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">idtr</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">idtr</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-5s s: %04x a: %04x l: %08x b: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;tr:&quot;</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">tr</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">tr</span><span class="p">.</span><span class="n">attrib</span><span class="p">,</span>
	       <span class="n">save</span><span class="o">-&gt;</span><span class="n">tr</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">tr</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cpl:            %d                efer:         %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">save</span><span class="o">-&gt;</span><span class="n">cpl</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">efer</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;cr0:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">cr0</span><span class="p">,</span> <span class="s">&quot;cr2:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">cr2</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;cr3:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">cr3</span><span class="p">,</span> <span class="s">&quot;cr4:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">cr4</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;dr6:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">dr6</span><span class="p">,</span> <span class="s">&quot;dr7:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">dr7</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;rip:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">rip</span><span class="p">,</span> <span class="s">&quot;rflags:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">rflags</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;rsp:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">,</span> <span class="s">&quot;rax:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">rax</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;star:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">star</span><span class="p">,</span> <span class="s">&quot;lstar:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">lstar</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;cstar:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">cstar</span><span class="p">,</span> <span class="s">&quot;sfmask:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">sfmask</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;kernel_gs_base:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">kernel_gs_base</span><span class="p">,</span>
	       <span class="s">&quot;sysenter_cs:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">sysenter_cs</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;sysenter_esp:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">sysenter_esp</span><span class="p">,</span>
	       <span class="s">&quot;sysenter_eip:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">sysenter_eip</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;gpat:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">g_pat</span><span class="p">,</span> <span class="s">&quot;dbgctl:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">dbgctl</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;br_from:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">br_from</span><span class="p">,</span> <span class="s">&quot;br_to:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">br_to</span><span class="p">);</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%-15s %016llx %-13s %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="s">&quot;excp_from:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">last_excp_from</span><span class="p">,</span>
	       <span class="s">&quot;excp_to:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">-&gt;</span><span class="n">last_excp_to</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_get_exit_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">info1</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">info2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>

	<span class="o">*</span><span class="n">info1</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_info_1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">info2</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_info_2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">kvm_run</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR0_WRITE</span><span class="p">))</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr0</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr3</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">exit_required</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nested_svm_vmexit</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">exit_required</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">vmexit</span><span class="p">;</span>

		<span class="n">trace_kvm_nested_vmexit</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span>
					<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span><span class="p">,</span>
					<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span><span class="p">,</span>
					<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span><span class="p">,</span>
					<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info_err</span><span class="p">,</span>
					<span class="n">KVM_ISA_SVM</span><span class="p">);</span>

		<span class="n">vmexit</span> <span class="o">=</span> <span class="n">nested_svm_exit_special</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vmexit</span> <span class="o">==</span> <span class="n">NESTED_EXIT_CONTINUE</span><span class="p">)</span>
			<span class="n">vmexit</span> <span class="o">=</span> <span class="n">nested_svm_exit_handled</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vmexit</span> <span class="o">==</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">svm_complete_interrupts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">==</span> <span class="n">SVM_EXIT_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_FAIL_ENTRY</span><span class="p">;</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">fail_entry</span><span class="p">.</span><span class="n">hardware_entry_failure_reason</span>
			<span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;KVM: FAILED VMRUN WITH VMCB:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_vmcb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_external_interrupt</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">exit_code</span> <span class="o">!=</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">PF_VECTOR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">exit_code</span> <span class="o">!=</span> <span class="n">SVM_EXIT_NPF</span> <span class="o">&amp;&amp;</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="n">SVM_EXIT_TASK_SWITCH</span> <span class="o">&amp;&amp;</span>
	    <span class="n">exit_code</span> <span class="o">!=</span> <span class="n">SVM_EXIT_INTR</span> <span class="o">&amp;&amp;</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="n">SVM_EXIT_NMI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unexpected exit_ini_info 0x%x &quot;</span>
		       <span class="s">&quot;exit_code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span><span class="p">,</span>
		       <span class="n">exit_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exit_code</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">svm_exit_handlers</span><span class="p">)</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">svm_exit_handlers</span><span class="p">[</span><span class="n">exit_code</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_UNKNOWN</span><span class="p">;</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hardware_exit_reason</span> <span class="o">=</span> <span class="n">exit_code</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">svm_exit_handlers</span><span class="p">[</span><span class="n">exit_code</span><span class="p">](</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reload_tss</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>

	<span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">svm_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">tss_desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* available 32/64-bit TSS */</span>
	<span class="n">load_TR_desc</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pre_svm_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>

	<span class="k">struct</span> <span class="n">svm_cpu_data</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">svm_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/* FIXME: handle wraparound of asid_generation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">asid_generation</span> <span class="o">!=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">asid_generation</span><span class="p">)</span>
		<span class="n">new_asid</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_inject_nmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span> <span class="o">=</span> <span class="n">SVM_EVTINJ_VALID</span> <span class="o">|</span> <span class="n">SVM_EVTINJ_TYPE_NMI</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">HF_NMI_MASK</span><span class="p">;</span>
	<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_IRET</span><span class="p">);</span>
	<span class="o">++</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">nmi_injections</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">svm_inject_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">control</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">int_vector</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">int_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V_INTR_PRIO_MASK</span><span class="p">;</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">int_ctl</span> <span class="o">|=</span> <span class="n">V_IRQ_MASK</span> <span class="o">|</span>
		<span class="p">((</span><span class="cm">/*control-&gt;int_vector &gt;&gt; 4*/</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">V_INTR_PRIO_SHIFT</span><span class="p">);</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_INTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gif_set</span><span class="p">(</span><span class="n">svm</span><span class="p">)));</span>

	<span class="n">trace_kvm_inj_virq</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
	<span class="o">++</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">irq_injections</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">event_inj</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">interrupt</span><span class="p">.</span><span class="n">nr</span> <span class="o">|</span>
		<span class="n">SVM_EVTINJ_VALID</span> <span class="o">|</span> <span class="n">SVM_EVTINJ_TYPE_INTR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_cr8_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tpr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_VINTR_MASK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpr</span> <span class="o">&gt;=</span> <span class="n">irr</span><span class="p">)</span>
		<span class="n">set_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR8_WRITE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_nmi_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span> <span class="o">&amp;</span> <span class="n">SVM_INTERRUPT_SHADOW_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_NMI_MASK</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">gif_set</span><span class="p">(</span><span class="n">svm</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">nested_svm_nmi</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">svm_get_nmi_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_NMI_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_nmi_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">bool</span> <span class="n">masked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">masked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">HF_NMI_MASK</span><span class="p">;</span>
		<span class="n">set_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_IRET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HF_NMI_MASK</span><span class="p">;</span>
		<span class="n">clr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_IRET</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_interrupt_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gif_set</span><span class="p">(</span><span class="n">svm</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_state</span> <span class="o">&amp;</span> <span class="n">SVM_INTERRUPT_SHADOW_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">kvm_get_rflags</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_IF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_VINTR_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_irq_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case GIF=0 we can&#39;t rely on the CPU to tell us when GIF becomes</span>
<span class="cm">	 * 1, because that&#39;s a separate STGI/VMRUN intercept.  The next time we</span>
<span class="cm">	 * get that intercept, this function will be called again though and</span>
<span class="cm">	 * we&#39;ll get the vintr intercept.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gif_set</span><span class="p">(</span><span class="n">svm</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">nested_svm_intr</span><span class="p">(</span><span class="n">svm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">svm_set_vintr</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
		<span class="n">svm_inject_irq</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_nmi_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HF_NMI_MASK</span> <span class="o">|</span> <span class="n">HF_IRET_MASK</span><span class="p">))</span>
	    <span class="o">==</span> <span class="n">HF_NMI_MASK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* IRET will cause a vm exit */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Something prevents NMI from been injected. Single step over possible</span>
<span class="cm">	 * problem (IRET or exception injection or interrupt shadow)</span>
<span class="cm">	 */</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">nmi_singlestep</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">X86_EFLAGS_TF</span> <span class="o">|</span> <span class="n">X86_EFLAGS_RF</span><span class="p">);</span>
	<span class="n">update_db_intercept</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_set_tss_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_flush_tlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_FLUSHBYASID</span><span class="p">))</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tlb_ctl</span> <span class="o">=</span> <span class="n">TLB_CONTROL_FLUSH_ASID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">asid_generation</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_prepare_guest_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sync_cr8_to_lapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_VINTR_MASK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cr_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">INTERCEPT_CR8_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cr8</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">&amp;</span> <span class="n">V_TPR_MASK</span><span class="p">;</span>
		<span class="n">kvm_set_cr8</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cr8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sync_lapic_to_cr8</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">cr8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_guest_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_VINTR_MASK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cr8</span> <span class="o">=</span> <span class="n">kvm_get_cr8</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V_TPR_MASK</span><span class="p">;</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">int_ctl</span> <span class="o">|=</span> <span class="n">cr8</span> <span class="o">&amp;</span> <span class="n">V_TPR_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_complete_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">vector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">exitintinfo</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">int3_injected</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">int3_injected</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">int3_injected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;ve made progress since setting HF_IRET_MASK, we&#39;ve</span>
<span class="cm">	 * executed an IRET and can allow NMI injection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">HF_IRET_MASK</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">!=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nmi_iret_rip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HF_NMI_MASK</span> <span class="o">|</span> <span class="n">HF_IRET_MASK</span><span class="p">);</span>
		<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">nmi_injected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">kvm_clear_exception_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_clear_interrupt_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">exitintinfo</span> <span class="o">&amp;</span> <span class="n">SVM_EXITINTINFO_VALID</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">vector</span> <span class="o">=</span> <span class="n">exitintinfo</span> <span class="o">&amp;</span> <span class="n">SVM_EXITINTINFO_VEC_MASK</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">exitintinfo</span> <span class="o">&amp;</span> <span class="n">SVM_EXITINTINFO_TYPE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SVM_EXITINTINFO_TYPE_NMI</span>:
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">nmi_injected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXITINTINFO_TYPE_EXEPT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * In case of software exceptions, do not reinject the vector,</span>
<span class="cm">		 * but re-execute the instruction instead. Rewind RIP first</span>
<span class="cm">		 * if we emulated INT3 before.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kvm_exception_is_soft</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="n">BP_VECTOR</span> <span class="o">&amp;&amp;</span> <span class="n">int3_injected</span> <span class="o">&amp;&amp;</span>
			    <span class="n">kvm_is_linear_rip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">int3_rip</span><span class="p">))</span>
				<span class="n">kvm_rip_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span>
					      <span class="n">kvm_rip_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">-</span>
					      <span class="n">int3_injected</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exitintinfo</span> <span class="o">&amp;</span> <span class="n">SVM_EXITINTINFO_VALID_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">err</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_int_info_err</span><span class="p">;</span>
			<span class="n">kvm_requeue_exception_e</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">kvm_requeue_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXITINTINFO_TYPE_INTR</span>:
		<span class="n">kvm_queue_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_cancel_injection</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vmcb_control_area</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>

	<span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_int_info</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">event_inj</span><span class="p">;</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">exit_int_info_err</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">event_inj_err</span><span class="p">;</span>
	<span class="n">control</span><span class="o">-&gt;</span><span class="n">event_inj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">svm_complete_interrupts</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="cp">#define R &quot;r&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define R &quot;e&quot;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_vcpu_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">];</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">];</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RIP</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * A vmexit emulation is required before the vcpu can be executed</span>
<span class="cm">	 * again.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">exit_required</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pre_svm_run</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">sync_lapic_to_cr8</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr2</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr2</span><span class="p">;</span>

	<span class="n">clgi</span><span class="p">();</span>

	<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
		<span class="s">&quot;push %%&quot;</span><span class="n">R</span><span class="s">&quot;bp; </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[rbx](%[svm]), %%&quot;</span><span class="n">R</span><span class="s">&quot;bx </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[rcx](%[svm]), %%&quot;</span><span class="n">R</span><span class="s">&quot;cx </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[rdx](%[svm]), %%&quot;</span><span class="n">R</span><span class="s">&quot;dx </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[rsi](%[svm]), %%&quot;</span><span class="n">R</span><span class="s">&quot;si </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[rdi](%[svm]), %%&quot;</span><span class="n">R</span><span class="s">&quot;di </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[rbp](%[svm]), %%&quot;</span><span class="n">R</span><span class="s">&quot;bp </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
		<span class="s">&quot;mov %c[r8](%[svm]),  %%r8  </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[r9](%[svm]),  %%r9  </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[r10](%[svm]), %%r10 </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[r11](%[svm]), %%r11 </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[r12](%[svm]), %%r12 </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[r13](%[svm]), %%r13 </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[r14](%[svm]), %%r14 </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[r15](%[svm]), %%r15 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="cp">#endif</span>

		<span class="cm">/* Enter guest mode */</span>
		<span class="s">&quot;push %%&quot;</span><span class="n">R</span><span class="s">&quot;ax </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %c[vmcb](%[svm]), %%&quot;</span><span class="n">R</span><span class="s">&quot;ax </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="n">__ex</span><span class="p">(</span><span class="n">SVM_VMLOAD</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="n">__ex</span><span class="p">(</span><span class="n">SVM_VMRUN</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="n">__ex</span><span class="p">(</span><span class="n">SVM_VMSAVE</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;pop %%&quot;</span><span class="n">R</span><span class="s">&quot;ax </span><span class="se">\n\t</span><span class="s">&quot;</span>

		<span class="cm">/* Save guest registers, load host registers */</span>
		<span class="s">&quot;mov %%&quot;</span><span class="n">R</span><span class="s">&quot;bx, %c[rbx](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%&quot;</span><span class="n">R</span><span class="s">&quot;cx, %c[rcx](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%&quot;</span><span class="n">R</span><span class="s">&quot;dx, %c[rdx](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%&quot;</span><span class="n">R</span><span class="s">&quot;si, %c[rsi](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%&quot;</span><span class="n">R</span><span class="s">&quot;di, %c[rdi](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%&quot;</span><span class="n">R</span><span class="s">&quot;bp, %c[rbp](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
		<span class="s">&quot;mov %%r8,  %c[r8](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%r9,  %c[r9](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%r10, %c[r10](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%r11, %c[r11](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%r12, %c[r12](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%r13, %c[r13](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%r14, %c[r14](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov %%r15, %c[r15](%[svm]) </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
		<span class="s">&quot;pop %%&quot;</span><span class="n">R</span><span class="s">&quot;bp&quot;</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="p">[</span><span class="n">svm</span><span class="p">]</span><span class="s">&quot;a&quot;</span><span class="p">(</span><span class="n">svm</span><span class="p">),</span>
		  <span class="p">[</span><span class="n">vmcb</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vmcb_pa</span><span class="p">)),</span>
		  <span class="p">[</span><span class="n">rbx</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBX</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">rcx</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RCX</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">rdx</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">rsi</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSI</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">rdi</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDI</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">rbp</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RBP</span><span class="p">]))</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
		  <span class="p">,</span> <span class="p">[</span><span class="n">r8</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R8</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">r9</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R9</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">r10</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R10</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">r11</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R11</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">r12</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R12</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">r13</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R13</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">r14</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R14</span><span class="p">])),</span>
		  <span class="p">[</span><span class="n">r15</span><span class="p">]</span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_R15</span><span class="p">]))</span>
<span class="cp">#endif</span>
		<span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span>
		<span class="p">,</span> <span class="n">R</span><span class="s">&quot;bx&quot;</span><span class="p">,</span> <span class="n">R</span><span class="s">&quot;cx&quot;</span><span class="p">,</span> <span class="n">R</span><span class="s">&quot;dx&quot;</span><span class="p">,</span> <span class="n">R</span><span class="s">&quot;si&quot;</span><span class="p">,</span> <span class="n">R</span><span class="s">&quot;di&quot;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
		<span class="p">,</span> <span class="s">&quot;r8&quot;</span><span class="p">,</span> <span class="s">&quot;r9&quot;</span><span class="p">,</span> <span class="s">&quot;r10&quot;</span><span class="p">,</span> <span class="s">&quot;r11&quot;</span> <span class="p">,</span> <span class="s">&quot;r12&quot;</span><span class="p">,</span> <span class="s">&quot;r13&quot;</span><span class="p">,</span> <span class="s">&quot;r14&quot;</span><span class="p">,</span> <span class="s">&quot;r15&quot;</span>
<span class="cp">#endif</span>
		<span class="p">);</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_GS_BASE</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">gs_base</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">loadsegment</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">fs</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_X86_32_LAZY_GS</span>
	<span class="n">loadsegment</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">.</span><span class="n">gs</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

	<span class="n">reload_tss</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr2</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr2</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rax</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RSP</span><span class="p">]</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RIP</span><span class="p">]</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">rip</span><span class="p">;</span>

	<span class="n">trace_kvm_exit</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">KVM_ISA_SVM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">==</span> <span class="n">SVM_EXIT_NMI</span><span class="p">))</span>
		<span class="n">kvm_before_handle_nmi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">stgi</span><span class="p">();</span>

	<span class="cm">/* Any pending NMI will happen here */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">==</span> <span class="n">SVM_EXIT_NMI</span><span class="p">))</span>
		<span class="n">kvm_after_handle_nmi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">sync_cr8_to_lapic</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">next_rip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">tlb_ctl</span> <span class="o">=</span> <span class="n">TLB_CONTROL_DO_NOTHING</span><span class="p">;</span>

	<span class="cm">/* if exit due to PF check for async PF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">==</span> <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">PF_VECTOR</span><span class="p">)</span>
		<span class="n">svm</span><span class="o">-&gt;</span><span class="n">apf_reason</span> <span class="o">=</span> <span class="n">kvm_read_and_reset_pf_reason</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs_avail</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VCPU_EXREG_PDPTR</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs_dirty</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VCPU_EXREG_PDPTR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to handle MC intercepts here before the vcpu has a chance to</span>
<span class="cm">	 * change the physical cpu</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">==</span>
		     <span class="n">SVM_EXIT_EXCP_BASE</span> <span class="o">+</span> <span class="n">MC_VECTOR</span><span class="p">))</span>
		<span class="n">svm_handle_mce</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">mark_all_clean</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#undef R</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_cr3</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_CR</span><span class="p">);</span>
	<span class="n">svm_flush_tlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_tdp_cr3</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">nested_cr3</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_NPT</span><span class="p">);</span>

	<span class="cm">/* Also sync guest cr3 here in case we live migrate */</span>
	<span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">.</span><span class="n">cr3</span> <span class="o">=</span> <span class="n">kvm_read_cr3</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">mark_dirty</span><span class="p">(</span><span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">,</span> <span class="n">VMCB_CR</span><span class="p">);</span>

	<span class="n">svm_flush_tlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_disabled</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">vm_cr</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_VM_CR</span><span class="p">,</span> <span class="n">vm_cr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vm_cr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_VM_CR_SVM_DISABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">svm_patch_hypercall</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hypercall</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Patch in the VMMCALL instruction:</span>
<span class="cm">	 */</span>
	<span class="n">hypercall</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">hypercall</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">hypercall</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd9</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_check_processor_compat</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rtn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">rtn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">svm_cpu_has_accelerated_tpr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">svm_get_mt_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_mmio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_cpuid_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_set_supported_cpuid</span><span class="p">(</span><span class="n">u32</span> <span class="n">func</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x80000001</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nested</span><span class="p">)</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* Set SVM bit */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8000000A</span>:
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* SVM revision 1 */</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ebx</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* Lets support 8 ASIDs in case we add proper</span>
<span class="cm">				   ASID emulation to nested SVM */</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Reserved */</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Per default do not support any</span>
<span class="cm">				   additional features */</span>

		<span class="cm">/* Support next_rip if host supports it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_NRIPS</span><span class="p">))</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">|=</span> <span class="n">SVM_FEATURE_NRIP</span><span class="p">;</span>

		<span class="cm">/* Support NPT for the guest if enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npt_enabled</span><span class="p">)</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">edx</span> <span class="o">|=</span> <span class="n">SVM_FEATURE_NPT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_get_lpage_level</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PT_PDPE_LEVEL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">svm_rdtscp_supported</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">svm_has_wbinvd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">svm_fpu_deactivate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">set_exception_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">,</span> <span class="n">NM_VECTOR</span><span class="p">);</span>
	<span class="n">update_cr0_intercept</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PRE_EX(exit)  { .exit_code = (exit), \</span>
<span class="cp">			.stage = X86_ICPT_PRE_EXCEPT, }</span>
<span class="cp">#define POST_EX(exit) { .exit_code = (exit), \</span>
<span class="cp">			.stage = X86_ICPT_POST_EXCEPT, }</span>
<span class="cp">#define POST_MEM(exit) { .exit_code = (exit), \</span>
<span class="cp">			.stage = X86_ICPT_POST_MEMACCESS, }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">__x86_intercept</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">exit_code</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">x86_intercept_stage</span> <span class="n">stage</span><span class="p">;</span>
<span class="p">}</span> <span class="n">x86_intercept_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">x86_intercept_cr_read</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_READ_CR0</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_cr_write</span><span class="p">]</span>	<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_WRITE_CR0</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_clts</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_WRITE_CR0</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_lmsw</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_WRITE_CR0</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_smsw</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_READ_CR0</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_dr_read</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_READ_DR0</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_dr_write</span><span class="p">]</span>	<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_WRITE_DR0</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_sldt</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_LDTR_READ</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_str</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_TR_READ</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_lldt</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_LDTR_WRITE</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_ltr</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_TR_WRITE</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_sgdt</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_GDTR_READ</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_sidt</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_IDTR_READ</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_lgdt</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_GDTR_WRITE</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_lidt</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_IDTR_WRITE</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_vmrun</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_VMRUN</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_vmmcall</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_VMMCALL</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_vmload</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_VMLOAD</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_vmsave</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_VMSAVE</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_stgi</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_STGI</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_clgi</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_CLGI</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_skinit</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_SKINIT</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_invlpga</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_INVLPGA</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_rdtscp</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_RDTSCP</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_monitor</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_MEM</span><span class="p">(</span><span class="n">SVM_EXIT_MONITOR</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_mwait</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_MWAIT</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_invlpg</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_INVLPG</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_invd</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_INVD</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_wbinvd</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_WBINVD</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_wrmsr</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_MSR</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_rdtsc</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_RDTSC</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_rdmsr</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_MSR</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_rdpmc</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_RDPMC</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_cpuid</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PRE_EX</span><span class="p">(</span><span class="n">SVM_EXIT_CPUID</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_rsm</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PRE_EX</span><span class="p">(</span><span class="n">SVM_EXIT_RSM</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_pause</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PRE_EX</span><span class="p">(</span><span class="n">SVM_EXIT_PAUSE</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_pushf</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PRE_EX</span><span class="p">(</span><span class="n">SVM_EXIT_PUSHF</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_popf</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PRE_EX</span><span class="p">(</span><span class="n">SVM_EXIT_POPF</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_intn</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PRE_EX</span><span class="p">(</span><span class="n">SVM_EXIT_SWINT</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_iret</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PRE_EX</span><span class="p">(</span><span class="n">SVM_EXIT_IRET</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_icebp</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PRE_EX</span><span class="p">(</span><span class="n">SVM_EXIT_ICEBP</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_hlt</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_HLT</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_in</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_IOIO</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_ins</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_IOIO</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_out</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_IOIO</span><span class="p">),</span>
	<span class="p">[</span><span class="n">x86_intercept_outs</span><span class="p">]</span>		<span class="o">=</span> <span class="n">POST_EX</span><span class="p">(</span><span class="n">SVM_EXIT_IOIO</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#undef PRE_EX</span>
<span class="cp">#undef POST_EX</span>
<span class="cp">#undef POST_MEM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">svm_check_intercept</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">x86_instruction_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">x86_intercept_stage</span> <span class="n">stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_svm</span> <span class="o">*</span><span class="n">svm</span> <span class="o">=</span> <span class="n">to_svm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vmexit</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__x86_intercept</span> <span class="n">icpt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vmcb</span> <span class="o">*</span><span class="n">vmcb</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">vmcb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">x86_intercept_map</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">icpt_info</span> <span class="o">=</span> <span class="n">x86_intercept_map</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stage</span> <span class="o">!=</span> <span class="n">icpt_info</span><span class="p">.</span><span class="n">stage</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">icpt_info</span><span class="p">.</span><span class="n">exit_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_READ_CR0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">==</span> <span class="n">x86_intercept_cr_read</span><span class="p">)</span>
			<span class="n">icpt_info</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_WRITE_CR0</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr0</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">intercept</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">==</span> <span class="n">x86_intercept_cr_write</span><span class="p">)</span>
			<span class="n">icpt_info</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">icpt_info</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="n">SVM_EXIT_WRITE_CR0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">intercept</span> <span class="o">=</span> <span class="n">svm</span><span class="o">-&gt;</span><span class="n">nested</span><span class="p">.</span><span class="n">intercept</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intercept</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">INTERCEPT_SELECTIVE_CR0</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cr0</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SVM_CR0_SELECTIVE_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">src_val</span>  <span class="o">&amp;</span> <span class="o">~</span><span class="n">SVM_CR0_SELECTIVE_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">==</span> <span class="n">x86_intercept_lmsw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cr0</span> <span class="o">&amp;=</span> <span class="mh">0xfUL</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xfUL</span><span class="p">;</span>
			<span class="cm">/* lmsw can&#39;t clear PE - catch this here */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="n">X86_CR0_PE</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">X86_CR0_PE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">^</span> <span class="n">val</span><span class="p">)</span>
			<span class="n">icpt_info</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">SVM_EXIT_CR0_SEL_WRITE</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_READ_DR0</span>:
	<span class="k">case</span> <span class="n">SVM_EXIT_WRITE_DR0</span>:
		<span class="n">icpt_info</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">modrm_reg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_MSR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">==</span> <span class="n">x86_intercept_wrmsr</span><span class="p">)</span>
			<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_PAUSE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * We get this for NOP only, but pause</span>
<span class="cm">		 * is rep not, check this here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rep_prefix</span> <span class="o">!=</span> <span class="n">REPE_PREFIX</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SVM_EXIT_IOIO</span>: <span class="p">{</span>
		<span class="n">u64</span> <span class="n">exit_info</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bytes</span><span class="p">;</span>

		<span class="n">exit_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs</span><span class="p">[</span><span class="n">VCPU_REGS_RDX</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">==</span> <span class="n">x86_intercept_in</span> <span class="o">||</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">==</span> <span class="n">x86_intercept_ins</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exit_info</span> <span class="o">|=</span> <span class="n">SVM_IOIO_TYPE_MASK</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">src_bytes</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dst_bytes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">==</span> <span class="n">x86_intercept_outs</span> <span class="o">||</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">intercept</span> <span class="o">==</span> <span class="n">x86_intercept_ins</span><span class="p">)</span>
			<span class="n">exit_info</span> <span class="o">|=</span> <span class="n">SVM_IOIO_STR_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rep_prefix</span><span class="p">)</span>
			<span class="n">exit_info</span> <span class="o">|=</span> <span class="n">SVM_IOIO_REP_MASK</span><span class="p">;</span>

		<span class="n">bytes</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">4u</span><span class="p">);</span>

		<span class="n">exit_info</span> <span class="o">|=</span> <span class="n">bytes</span> <span class="o">&lt;&lt;</span> <span class="n">SVM_IOIO_SIZE_SHIFT</span><span class="p">;</span>

		<span class="n">exit_info</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ad_bytes</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SVM_IOIO_ASIZE_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_1</span> <span class="o">=</span> <span class="n">exit_info</span><span class="p">;</span>
		<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_info_2</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_rip</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">next_rip</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_rip</span><span class="p">;</span>
	<span class="n">vmcb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">icpt_info</span><span class="p">.</span><span class="n">exit_code</span><span class="p">;</span>
	<span class="n">vmexit</span> <span class="o">=</span> <span class="n">nested_svm_exit_handled</span><span class="p">(</span><span class="n">svm</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmexit</span> <span class="o">==</span> <span class="n">NESTED_EXIT_DONE</span><span class="p">)</span> <span class="o">?</span> <span class="n">X86EMUL_INTERCEPTED</span>
					   <span class="o">:</span> <span class="n">X86EMUL_CONTINUE</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kvm_x86_ops</span> <span class="n">svm_x86_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cpu_has_kvm_support</span> <span class="o">=</span> <span class="n">has_svm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disabled_by_bios</span> <span class="o">=</span> <span class="n">is_disabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardware_setup</span> <span class="o">=</span> <span class="n">svm_hardware_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardware_unsetup</span> <span class="o">=</span> <span class="n">svm_hardware_unsetup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_processor_compatibility</span> <span class="o">=</span> <span class="n">svm_check_processor_compat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardware_enable</span> <span class="o">=</span> <span class="n">svm_hardware_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardware_disable</span> <span class="o">=</span> <span class="n">svm_hardware_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_has_accelerated_tpr</span> <span class="o">=</span> <span class="n">svm_cpu_has_accelerated_tpr</span><span class="p">,</span>

	<span class="p">.</span><span class="n">vcpu_create</span> <span class="o">=</span> <span class="n">svm_create_vcpu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vcpu_free</span> <span class="o">=</span> <span class="n">svm_free_vcpu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vcpu_reset</span> <span class="o">=</span> <span class="n">svm_vcpu_reset</span><span class="p">,</span>

	<span class="p">.</span><span class="n">prepare_guest_switch</span> <span class="o">=</span> <span class="n">svm_prepare_guest_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vcpu_load</span> <span class="o">=</span> <span class="n">svm_vcpu_load</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vcpu_put</span> <span class="o">=</span> <span class="n">svm_vcpu_put</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_guest_debug</span> <span class="o">=</span> <span class="n">svm_guest_debug</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msr</span> <span class="o">=</span> <span class="n">svm_get_msr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msr</span> <span class="o">=</span> <span class="n">svm_set_msr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_segment_base</span> <span class="o">=</span> <span class="n">svm_get_segment_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_segment</span> <span class="o">=</span> <span class="n">svm_get_segment</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_segment</span> <span class="o">=</span> <span class="n">svm_set_segment</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cpl</span> <span class="o">=</span> <span class="n">svm_get_cpl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cs_db_l_bits</span> <span class="o">=</span> <span class="n">kvm_get_cs_db_l_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decache_cr0_guest_bits</span> <span class="o">=</span> <span class="n">svm_decache_cr0_guest_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decache_cr3</span> <span class="o">=</span> <span class="n">svm_decache_cr3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decache_cr4_guest_bits</span> <span class="o">=</span> <span class="n">svm_decache_cr4_guest_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_cr0</span> <span class="o">=</span> <span class="n">svm_set_cr0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_cr3</span> <span class="o">=</span> <span class="n">svm_set_cr3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_cr4</span> <span class="o">=</span> <span class="n">svm_set_cr4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_efer</span> <span class="o">=</span> <span class="n">svm_set_efer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_idt</span> <span class="o">=</span> <span class="n">svm_get_idt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_idt</span> <span class="o">=</span> <span class="n">svm_set_idt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_gdt</span> <span class="o">=</span> <span class="n">svm_get_gdt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_gdt</span> <span class="o">=</span> <span class="n">svm_set_gdt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dr7</span> <span class="o">=</span> <span class="n">svm_set_dr7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_reg</span> <span class="o">=</span> <span class="n">svm_cache_reg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rflags</span> <span class="o">=</span> <span class="n">svm_get_rflags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rflags</span> <span class="o">=</span> <span class="n">svm_set_rflags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fpu_activate</span> <span class="o">=</span> <span class="n">svm_fpu_activate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fpu_deactivate</span> <span class="o">=</span> <span class="n">svm_fpu_deactivate</span><span class="p">,</span>

	<span class="p">.</span><span class="n">tlb_flush</span> <span class="o">=</span> <span class="n">svm_flush_tlb</span><span class="p">,</span>

	<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">svm_vcpu_run</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_exit</span> <span class="o">=</span> <span class="n">handle_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_emulated_instruction</span> <span class="o">=</span> <span class="n">skip_emulated_instruction</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_interrupt_shadow</span> <span class="o">=</span> <span class="n">svm_set_interrupt_shadow</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_interrupt_shadow</span> <span class="o">=</span> <span class="n">svm_get_interrupt_shadow</span><span class="p">,</span>
	<span class="p">.</span><span class="n">patch_hypercall</span> <span class="o">=</span> <span class="n">svm_patch_hypercall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_irq</span> <span class="o">=</span> <span class="n">svm_set_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_nmi</span> <span class="o">=</span> <span class="n">svm_inject_nmi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue_exception</span> <span class="o">=</span> <span class="n">svm_queue_exception</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel_injection</span> <span class="o">=</span> <span class="n">svm_cancel_injection</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_allowed</span> <span class="o">=</span> <span class="n">svm_interrupt_allowed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nmi_allowed</span> <span class="o">=</span> <span class="n">svm_nmi_allowed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_nmi_mask</span> <span class="o">=</span> <span class="n">svm_get_nmi_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_nmi_mask</span> <span class="o">=</span> <span class="n">svm_set_nmi_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_nmi_window</span> <span class="o">=</span> <span class="n">enable_nmi_window</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_irq_window</span> <span class="o">=</span> <span class="n">enable_irq_window</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_cr8_intercept</span> <span class="o">=</span> <span class="n">update_cr8_intercept</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_tss_addr</span> <span class="o">=</span> <span class="n">svm_set_tss_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tdp_level</span> <span class="o">=</span> <span class="n">get_npt_level</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mt_mask</span> <span class="o">=</span> <span class="n">svm_get_mt_mask</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_exit_info</span> <span class="o">=</span> <span class="n">svm_get_exit_info</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_lpage_level</span> <span class="o">=</span> <span class="n">svm_get_lpage_level</span><span class="p">,</span>

	<span class="p">.</span><span class="n">cpuid_update</span> <span class="o">=</span> <span class="n">svm_cpuid_update</span><span class="p">,</span>

	<span class="p">.</span><span class="n">rdtscp_supported</span> <span class="o">=</span> <span class="n">svm_rdtscp_supported</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_supported_cpuid</span> <span class="o">=</span> <span class="n">svm_set_supported_cpuid</span><span class="p">,</span>

	<span class="p">.</span><span class="n">has_wbinvd_exit</span> <span class="o">=</span> <span class="n">svm_has_wbinvd_exit</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_tsc_khz</span> <span class="o">=</span> <span class="n">svm_set_tsc_khz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_tsc_offset</span> <span class="o">=</span> <span class="n">svm_write_tsc_offset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adjust_tsc_offset</span> <span class="o">=</span> <span class="n">svm_adjust_tsc_offset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compute_tsc_offset</span> <span class="o">=</span> <span class="n">svm_compute_tsc_offset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_l1_tsc</span> <span class="o">=</span> <span class="n">svm_read_l1_tsc</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_tdp_cr3</span> <span class="o">=</span> <span class="n">set_tdp_cr3</span><span class="p">,</span>

	<span class="p">.</span><span class="n">check_intercept</span> <span class="o">=</span> <span class="n">svm_check_intercept</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">svm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kvm_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">svm_x86_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">),</span>
			<span class="n">__alignof__</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_svm</span><span class="p">),</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">svm_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvm_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">svm_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">svm_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
