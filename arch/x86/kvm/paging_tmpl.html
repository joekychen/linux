<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kvm › paging_tmpl.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>paging_tmpl.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Kernel-based Virtual Machine driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * This module enables machines with Intel VT-x extensions to run virtual</span>
<span class="cm"> * machines without emulation or binary translation.</span>
<span class="cm"> *</span>
<span class="cm"> * MMU support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Qumranet, Inc.</span>
<span class="cm"> * Copyright 2010 Red Hat, Inc. and/or its affiliates.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Yaniv Kamay  &lt;yaniv@qumranet.com&gt;</span>
<span class="cm"> *   Avi Kivity   &lt;avi@qumranet.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This work is licensed under the terms of the GNU GPL, version 2.  See</span>
<span class="cm"> * the COPYING file in the top-level directory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * We need the mmu code to access both 32-bit and 64-bit guest ptes,</span>
<span class="cm"> * so the code in this file is compiled twice, once per pte size.</span>
<span class="cm"> */</span>

<span class="cp">#if PTTYPE == 64</span>
	<span class="cp">#define pt_element_t u64</span>
	<span class="cp">#define guest_walker guest_walker64</span>
	<span class="cp">#define FNAME(name) paging##64_##name</span>
	<span class="cp">#define PT_BASE_ADDR_MASK PT64_BASE_ADDR_MASK</span>
	<span class="cp">#define PT_LVL_ADDR_MASK(lvl) PT64_LVL_ADDR_MASK(lvl)</span>
	<span class="cp">#define PT_LVL_OFFSET_MASK(lvl) PT64_LVL_OFFSET_MASK(lvl)</span>
	<span class="cp">#define PT_INDEX(addr, level) PT64_INDEX(addr, level)</span>
	<span class="cp">#define PT_LEVEL_BITS PT64_LEVEL_BITS</span>
	<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="cp">#define PT_MAX_FULL_LEVELS 4</span>
	<span class="cp">#define CMPXCHG cmpxchg</span>
	<span class="cp">#else</span>
	<span class="cp">#define CMPXCHG cmpxchg64</span>
	<span class="cp">#define PT_MAX_FULL_LEVELS 2</span>
	<span class="cp">#endif</span>
<span class="cp">#elif PTTYPE == 32</span>
	<span class="cp">#define pt_element_t u32</span>
	<span class="cp">#define guest_walker guest_walker32</span>
	<span class="cp">#define FNAME(name) paging##32_##name</span>
	<span class="cp">#define PT_BASE_ADDR_MASK PT32_BASE_ADDR_MASK</span>
	<span class="cp">#define PT_LVL_ADDR_MASK(lvl) PT32_LVL_ADDR_MASK(lvl)</span>
	<span class="cp">#define PT_LVL_OFFSET_MASK(lvl) PT32_LVL_OFFSET_MASK(lvl)</span>
	<span class="cp">#define PT_INDEX(addr, level) PT32_INDEX(addr, level)</span>
	<span class="cp">#define PT_LEVEL_BITS PT32_LEVEL_BITS</span>
	<span class="cp">#define PT_MAX_FULL_LEVELS 2</span>
	<span class="cp">#define CMPXCHG cmpxchg</span>
<span class="cp">#else</span>
	<span class="cp">#error Invalid PTTYPE value</span>
<span class="cp">#endif</span>

<span class="cp">#define gpte_to_gfn_lvl FNAME(gpte_to_gfn_lvl)</span>
<span class="cp">#define gpte_to_gfn(pte) gpte_to_gfn_lvl((pte), PT_PAGE_TABLE_LEVEL)</span>

<span class="cm">/*</span>
<span class="cm"> * The guest_walker structure emulates the behavior of the hardware page</span>
<span class="cm"> * table walker.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">guest_walker</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">gfn_t</span> <span class="n">table_gfn</span><span class="p">[</span><span class="n">PT_MAX_FULL_LEVELS</span><span class="p">];</span>
	<span class="n">pt_element_t</span> <span class="n">ptes</span><span class="p">[</span><span class="n">PT_MAX_FULL_LEVELS</span><span class="p">];</span>
	<span class="n">pt_element_t</span> <span class="n">prefetch_ptes</span><span class="p">[</span><span class="n">PTE_PREFETCH_NUM</span><span class="p">];</span>
	<span class="n">gpa_t</span> <span class="n">pte_gpa</span><span class="p">[</span><span class="n">PT_MAX_FULL_LEVELS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">pt_access</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pte_access</span><span class="p">;</span>
	<span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">x86_exception</span> <span class="n">fault</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">gfn_t</span> <span class="nf">gpte_to_gfn_lvl</span><span class="p">(</span><span class="n">pt_element_t</span> <span class="n">gpte</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">gpte</span> <span class="o">&amp;</span> <span class="n">PT_LVL_ADDR_MASK</span><span class="p">(</span><span class="n">lvl</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">cmpxchg_gpte</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_mmu</span> <span class="o">*</span><span class="n">mmu</span><span class="p">,</span>
			       <span class="n">pt_element_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptep_user</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">index</span><span class="p">,</span>
			       <span class="n">pt_element_t</span> <span class="n">orig_pte</span><span class="p">,</span> <span class="n">pt_element_t</span> <span class="n">new_pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
	<span class="n">pt_element_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">pt_element_t</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">npages</span> <span class="o">=</span> <span class="n">get_user_pages_fast</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptep_user</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">);</span>
	<span class="cm">/* Check if the user is doing something meaningless. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">npages</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">CMPXCHG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">orig_pte</span><span class="p">,</span> <span class="n">new_pte</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>

	<span class="n">kvm_release_page_dirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">orig_pte</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">gpte_access</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pt_element_t</span> <span class="n">gpte</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">access</span><span class="p">;</span>

	<span class="n">access</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PT_WRITABLE_MASK</span> <span class="o">|</span> <span class="n">PT_USER_MASK</span><span class="p">))</span> <span class="o">|</span> <span class="n">ACC_EXEC_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_dirty_gpte</span><span class="p">(</span><span class="n">gpte</span><span class="p">))</span>
		<span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACC_WRITE_MASK</span><span class="p">;</span>

<span class="cp">#if PTTYPE == 64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">nx</span><span class="p">)</span>
		<span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gpte</span> <span class="o">&gt;&gt;</span> <span class="n">PT64_NX_SHIFT</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">access</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">is_last_gpte</span><span class="p">)(</span><span class="k">struct</span> <span class="n">guest_walker</span> <span class="o">*</span><span class="n">walker</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_mmu</span> <span class="o">*</span><span class="n">mmu</span><span class="p">,</span>
				<span class="n">pt_element_t</span> <span class="n">gpte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">PT_DIRECTORY_LEVEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_large_pte</span><span class="p">(</span><span class="n">gpte</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">PTTYPE</span> <span class="o">==</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">is_pse</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">PT_PDPE_LEVEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_large_pte</span><span class="p">(</span><span class="n">gpte</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_level</span> <span class="o">==</span> <span class="n">PT64_ROOT_LEVEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fetch a guest pte for a guest virtual address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">walk_addr_generic</span><span class="p">)(</span><span class="k">struct</span> <span class="n">guest_walker</span> <span class="o">*</span><span class="n">walker</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_mmu</span> <span class="o">*</span><span class="n">mmu</span><span class="p">,</span>
				    <span class="n">gva_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pt_element_t</span> <span class="n">pte</span><span class="p">;</span>
	<span class="n">pt_element_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">ptep_user</span><span class="p">);</span>
	<span class="n">gfn_t</span> <span class="n">table_gfn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">index</span><span class="p">,</span> <span class="n">pt_access</span><span class="p">,</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">pte_access</span><span class="p">);</span>
	<span class="n">gpa_t</span> <span class="n">pte_gpa</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">eperm</span><span class="p">,</span> <span class="n">last_gpte</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">write_fault</span> <span class="o">=</span> <span class="n">access</span> <span class="o">&amp;</span> <span class="n">PFERR_WRITE_MASK</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">user_fault</span>  <span class="o">=</span> <span class="n">access</span> <span class="o">&amp;</span> <span class="n">PFERR_USER_MASK</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">fetch_fault</span> <span class="o">=</span> <span class="n">access</span> <span class="o">&amp;</span> <span class="n">PFERR_FETCH_MASK</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">errcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_kvm_mmu_pagetable_walk</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">write_fault</span><span class="p">,</span> <span class="n">user_fault</span><span class="p">,</span>
				     <span class="n">fetch_fault</span><span class="p">);</span>
<span class="nl">retry_walk:</span>
	<span class="n">eperm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_level</span><span class="p">;</span>
	<span class="n">pte</span>           <span class="o">=</span> <span class="n">mmu</span><span class="o">-&gt;</span><span class="n">get_cr3</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

<span class="cp">#if PTTYPE == 64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">PT32E_ROOT_LEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pte</span> <span class="o">=</span> <span class="n">mmu</span><span class="o">-&gt;</span><span class="n">get_pdptr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">trace_kvm_mmu_paging_element</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_present_gpte</span><span class="p">(</span><span class="n">pte</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="o">--</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="o">!</span><span class="n">is_long_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_pae</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">get_cr3</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CR3_NONPAE_RESERVED_BITS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pt_access</span> <span class="o">=</span> <span class="n">ACC_ALL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">gfn_t</span> <span class="n">real_gfn</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">host_addr</span><span class="p">;</span>

		<span class="n">index</span> <span class="o">=</span> <span class="n">PT_INDEX</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>

		<span class="n">table_gfn</span> <span class="o">=</span> <span class="n">gpte_to_gfn</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span>
		<span class="n">offset</span>    <span class="o">=</span> <span class="n">index</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pt_element_t</span><span class="p">);</span>
		<span class="n">pte_gpa</span>   <span class="o">=</span> <span class="n">gfn_to_gpa</span><span class="p">(</span><span class="n">table_gfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">walker</span><span class="o">-&gt;</span><span class="n">table_gfn</span><span class="p">[</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_gfn</span><span class="p">;</span>
		<span class="n">walker</span><span class="o">-&gt;</span><span class="n">pte_gpa</span><span class="p">[</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pte_gpa</span><span class="p">;</span>

		<span class="n">real_gfn</span> <span class="o">=</span> <span class="n">mmu</span><span class="o">-&gt;</span><span class="n">translate_gpa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn_to_gpa</span><span class="p">(</span><span class="n">table_gfn</span><span class="p">),</span>
					      <span class="n">PFERR_USER_MASK</span><span class="o">|</span><span class="n">PFERR_WRITE_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">real_gfn</span> <span class="o">==</span> <span class="n">UNMAPPED_GVA</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">real_gfn</span> <span class="o">=</span> <span class="n">gpa_to_gfn</span><span class="p">(</span><span class="n">real_gfn</span><span class="p">);</span>

		<span class="n">host_addr</span> <span class="o">=</span> <span class="n">gfn_to_hva</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">real_gfn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">kvm_is_error_hva</span><span class="p">(</span><span class="n">host_addr</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">ptep_user</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt_element_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">host_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="n">ptep_user</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pte</span><span class="p">))))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">trace_kvm_mmu_paging_element</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_present_gpte</span><span class="p">(</span><span class="n">pte</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_rsvd_bits_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span>
					      <span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">errcode</span> <span class="o">|=</span> <span class="n">PFERR_RSVD_MASK</span> <span class="o">|</span> <span class="n">PFERR_PRESENT_MASK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_write_user_access</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">write_fault</span><span class="p">,</span> <span class="n">user_fault</span><span class="p">,</span>
					  <span class="n">pte</span><span class="p">))</span>
			<span class="n">eperm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="cp">#if PTTYPE == 64</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fetch_fault</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="n">PT64_NX_MASK</span><span class="p">)))</span>
			<span class="n">eperm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">last_gpte</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">is_last_gpte</span><span class="p">)(</span><span class="n">walker</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">mmu</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_gpte</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pte_access</span> <span class="o">=</span> <span class="n">pt_access</span> <span class="o">&amp;</span>
				     <span class="n">FNAME</span><span class="p">(</span><span class="n">gpte_access</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="cm">/* check if the kernel is fetching from user page */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pte_access</span> <span class="o">&amp;</span> <span class="n">PT_USER_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">kvm_read_cr4_bits</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">X86_CR4_SMEP</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fetch_fault</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user_fault</span><span class="p">)</span>
					<span class="n">eperm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eperm</span> <span class="o">&amp;&amp;</span> <span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="n">PT_ACCESSED_MASK</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">trace_kvm_mmu_set_accessed_bit</span><span class="p">(</span><span class="n">table_gfn</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
						       <span class="k">sizeof</span><span class="p">(</span><span class="n">pte</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">cmpxchg_gpte</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">mmu</span><span class="p">,</span> <span class="n">ptep_user</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
						  <span class="n">pte</span><span class="p">,</span> <span class="n">pte</span><span class="o">|</span><span class="n">PT_ACCESSED_MASK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">retry_walk</span><span class="p">;</span>

			<span class="n">mark_page_dirty</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">table_gfn</span><span class="p">);</span>
			<span class="n">pte</span> <span class="o">|=</span> <span class="n">PT_ACCESSED_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">walker</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pte</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">last_gpte</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">lvl</span> <span class="o">=</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
			<span class="n">gpa_t</span> <span class="n">real_gpa</span><span class="p">;</span>
			<span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">ac</span><span class="p">;</span>

			<span class="n">gfn</span> <span class="o">=</span> <span class="n">gpte_to_gfn_lvl</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="n">lvl</span><span class="p">);</span>
			<span class="n">gfn</span> <span class="o">+=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">PT_LVL_OFFSET_MASK</span><span class="p">(</span><span class="n">lvl</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">PTTYPE</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span>
			    <span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">PT_DIRECTORY_LEVEL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">is_cpuid_PSE36</span><span class="p">())</span>
				<span class="n">gfn</span> <span class="o">+=</span> <span class="n">pse36_gfn_delta</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span>

			<span class="n">ac</span> <span class="o">=</span> <span class="n">write_fault</span> <span class="o">|</span> <span class="n">fetch_fault</span> <span class="o">|</span> <span class="n">user_fault</span><span class="p">;</span>

			<span class="n">real_gpa</span> <span class="o">=</span> <span class="n">mmu</span><span class="o">-&gt;</span><span class="n">translate_gpa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn_to_gpa</span><span class="p">(</span><span class="n">gfn</span><span class="p">),</span>
						      <span class="n">ac</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">real_gpa</span> <span class="o">==</span> <span class="n">UNMAPPED_GVA</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">walker</span><span class="o">-&gt;</span><span class="n">gfn</span> <span class="o">=</span> <span class="n">real_gpa</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pt_access</span> <span class="o">&amp;=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">gpte_access</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="o">--</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">eperm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">errcode</span> <span class="o">|=</span> <span class="n">PFERR_PRESENT_MASK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_fault</span> <span class="o">&amp;&amp;</span> <span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_dirty_gpte</span><span class="p">(</span><span class="n">pte</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">trace_kvm_mmu_set_dirty_bit</span><span class="p">(</span><span class="n">table_gfn</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pte</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">cmpxchg_gpte</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">mmu</span><span class="p">,</span> <span class="n">ptep_user</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
					  <span class="n">pte</span><span class="p">,</span> <span class="n">pte</span><span class="o">|</span><span class="n">PT_DIRTY_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">retry_walk</span><span class="p">;</span>

		<span class="n">mark_page_dirty</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">table_gfn</span><span class="p">);</span>
		<span class="n">pte</span> <span class="o">|=</span> <span class="n">PT_DIRTY_MASK</span><span class="p">;</span>
		<span class="n">walker</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pte</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">pt_access</span> <span class="o">=</span> <span class="n">pt_access</span><span class="p">;</span>
	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">pte_access</span> <span class="o">=</span> <span class="n">pte_access</span><span class="p">;</span>
	<span class="n">pgprintk</span><span class="p">(</span><span class="s">&quot;%s: pte %llx pte_access %x pt_access %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pte</span><span class="p">,</span> <span class="n">pte_access</span><span class="p">,</span> <span class="n">pt_access</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">errcode</span> <span class="o">|=</span> <span class="n">write_fault</span> <span class="o">|</span> <span class="n">user_fault</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fetch_fault</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">nx</span> <span class="o">||</span>
			    <span class="n">kvm_read_cr4_bits</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">X86_CR4_SMEP</span><span class="p">)))</span>
		<span class="n">errcode</span> <span class="o">|=</span> <span class="n">PFERR_FETCH_MASK</span><span class="p">;</span>

	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">PF_VECTOR</span><span class="p">;</span>
	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">.</span><span class="n">error_code_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">errcode</span><span class="p">;</span>
	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">walker</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">.</span><span class="n">nested_page_fault</span> <span class="o">=</span> <span class="n">mmu</span> <span class="o">!=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">walk_mmu</span><span class="p">;</span>

	<span class="n">trace_kvm_mmu_walker_error</span><span class="p">(</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">.</span><span class="n">error_code</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">walk_addr</span><span class="p">)(</span><span class="k">struct</span> <span class="n">guest_walker</span> <span class="o">*</span><span class="n">walker</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">walk_addr_generic</span><span class="p">)(</span><span class="n">walker</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">access</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">walk_addr_nested</span><span class="p">)(</span><span class="k">struct</span> <span class="n">guest_walker</span> <span class="o">*</span><span class="n">walker</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">addr</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">walk_addr_generic</span><span class="p">)(</span><span class="n">walker</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">nested_mmu</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">access</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">prefetch_invalid_gpte</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">spte</span><span class="p">,</span>
				    <span class="n">pt_element_t</span> <span class="n">gpte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_rsvd_bits_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">,</span> <span class="n">gpte</span><span class="p">,</span> <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_present</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_present_gpte</span><span class="p">(</span><span class="n">gpte</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_present</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gpte</span> <span class="o">&amp;</span> <span class="n">PT_ACCESSED_MASK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_present</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">no_present:</span>
	<span class="n">drop_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">spte</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">update_pte</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="o">*</span><span class="n">spte</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pt_element_t</span> <span class="n">gpte</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pte_access</span><span class="p">;</span>
	<span class="n">pfn_t</span> <span class="n">pfn</span><span class="p">;</span>

	<span class="n">gpte</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="n">pt_element_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pte</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FNAME</span><span class="p">(</span><span class="n">prefetch_invalid_gpte</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">spte</span><span class="p">,</span> <span class="n">gpte</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pgprintk</span><span class="p">(</span><span class="s">&quot;%s: gpte %llx spte %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">gpte</span><span class="p">,</span> <span class="n">spte</span><span class="p">);</span>
	<span class="n">pte_access</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">access</span> <span class="o">&amp;</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">gpte_access</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gpte</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">pfn</span> <span class="o">=</span> <span class="n">gfn_to_pfn_atomic</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gpte_to_gfn</span><span class="p">(</span><span class="n">gpte</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmu_invalid_pfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvm_release_pfn_clean</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * we call mmu_set_spte() with host_writable = true because that</span>
<span class="cm">	 * vcpu-&gt;arch.update_pte.pfn was fetched from get_user_pages(write = 1).</span>
<span class="cm">	 */</span>
	<span class="n">mmu_set_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">spte</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">access</span><span class="p">,</span> <span class="n">pte_access</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="nb">NULL</span><span class="p">,</span> <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">,</span>
		     <span class="n">gpte_to_gfn</span><span class="p">(</span><span class="n">gpte</span><span class="p">),</span> <span class="n">pfn</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">gpte_changed</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">guest_walker</span> <span class="o">*</span><span class="n">gw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pt_element_t</span> <span class="n">curr_pte</span><span class="p">;</span>
	<span class="n">gpa_t</span> <span class="n">base_gpa</span><span class="p">,</span> <span class="n">pte_gpa</span> <span class="o">=</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">pte_gpa</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">PTE_PREFETCH_NUM</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pt_element_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">base_gpa</span> <span class="o">=</span> <span class="n">pte_gpa</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte_gpa</span> <span class="o">-</span> <span class="n">base_gpa</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pt_element_t</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_read_guest_atomic</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">base_gpa</span><span class="p">,</span>
				<span class="n">gw</span><span class="o">-&gt;</span><span class="n">prefetch_ptes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gw</span><span class="o">-&gt;</span><span class="n">prefetch_ptes</span><span class="p">));</span>
		<span class="n">curr_pte</span> <span class="o">=</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">prefetch_ptes</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_read_guest_atomic</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">pte_gpa</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">curr_pte</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">curr_pte</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">r</span> <span class="o">||</span> <span class="n">curr_pte</span> <span class="o">!=</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">pte_prefetch</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">guest_walker</span> <span class="o">*</span><span class="n">gw</span><span class="p">,</span>
				<span class="n">u64</span> <span class="o">*</span><span class="n">sptep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">pt_element_t</span> <span class="o">*</span><span class="n">gptep</span> <span class="o">=</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">prefetch_ptes</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">spte</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">page_header</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">sptep</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">direct</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">__direct_pte_prefetch</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sptep</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">sptep</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PTE_PREFETCH_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spte</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTE_PREFETCH_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">spte</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pt_element_t</span> <span class="n">gpte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">pte_access</span><span class="p">;</span>
		<span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">;</span>
		<span class="n">pfn_t</span> <span class="n">pfn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spte</span> <span class="o">==</span> <span class="n">sptep</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_shadow_present_pte</span><span class="p">(</span><span class="o">*</span><span class="n">spte</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">gpte</span> <span class="o">=</span> <span class="n">gptep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">FNAME</span><span class="p">(</span><span class="n">prefetch_invalid_gpte</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">spte</span><span class="p">,</span> <span class="n">gpte</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pte_access</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">access</span> <span class="o">&amp;</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">gpte_access</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gpte</span><span class="p">,</span>
								  <span class="nb">true</span><span class="p">);</span>
		<span class="n">gfn</span> <span class="o">=</span> <span class="n">gpte_to_gfn</span><span class="p">(</span><span class="n">gpte</span><span class="p">);</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="n">pte_prefetch_gfn_to_pfn</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span>
				      <span class="n">pte_access</span> <span class="o">&amp;</span> <span class="n">ACC_WRITE_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmu_invalid_pfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kvm_release_pfn_clean</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mmu_set_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">spte</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">access</span><span class="p">,</span> <span class="n">pte_access</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span> <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span>
			     <span class="n">pfn</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fetch a shadow pte for a specific level in the paging hierarchy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="o">*</span><span class="nf">FNAME</span><span class="p">(</span><span class="n">fetch</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">addr</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">guest_walker</span> <span class="o">*</span><span class="n">gw</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">user_fault</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_fault</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hlevel</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="o">*</span><span class="n">emulate</span><span class="p">,</span> <span class="n">pfn_t</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">bool</span> <span class="n">map_writable</span><span class="p">,</span>
			 <span class="n">bool</span> <span class="n">prefault</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">access</span> <span class="o">=</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">pt_access</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">top_level</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">direct_access</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_shadow_walk_iterator</span> <span class="n">it</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_present_gpte</span><span class="p">(</span><span class="n">gw</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="n">gw</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">direct_access</span> <span class="o">=</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">pte_access</span><span class="p">;</span>

	<span class="n">top_level</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">root_level</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top_level</span> <span class="o">==</span> <span class="n">PT32E_ROOT_LEVEL</span><span class="p">)</span>
		<span class="n">top_level</span> <span class="o">=</span> <span class="n">PT32_ROOT_LEVEL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Verify that the top-level gpte is still there.  Since the page</span>
<span class="cm">	 * is a root page, it is either write protected (and cannot be</span>
<span class="cm">	 * changed from now on) or it is invalid (in which case, we don&#39;t</span>
<span class="cm">	 * really care if it changes underneath us after this point).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FNAME</span><span class="p">(</span><span class="n">gpte_changed</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gw</span><span class="p">,</span> <span class="n">top_level</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_gpte_changed</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">shadow_walk_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	     <span class="n">shadow_walk_okay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	     <span class="n">shadow_walk_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfn_t</span> <span class="n">table_gfn</span><span class="p">;</span>

		<span class="n">clear_sp_write_flooding_count</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
		<span class="n">drop_large_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>

		<span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_shadow_present_pte</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">table_gfn</span> <span class="o">=</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">table_gfn</span><span class="p">[</span><span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
			<span class="n">sp</span> <span class="o">=</span> <span class="n">kvm_mmu_get_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">table_gfn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					      <span class="nb">false</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Verify that the gpte in the page we&#39;ve just write</span>
<span class="cm">		 * protected is still there.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FNAME</span><span class="p">(</span><span class="n">gpte_changed</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gw</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_gpte_changed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
			<span class="n">link_shadow_page</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span>
	     <span class="n">shadow_walk_okay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">hlevel</span><span class="p">;</span>
	     <span class="n">shadow_walk_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gfn_t</span> <span class="n">direct_gfn</span><span class="p">;</span>

		<span class="n">clear_sp_write_flooding_count</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
		<span class="n">validate_direct_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">direct_access</span><span class="p">);</span>

		<span class="n">drop_large_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_shadow_present_pte</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">direct_gfn</span> <span class="o">=</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">gfn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">KVM_PAGES_PER_HPAGE</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">sp</span> <span class="o">=</span> <span class="n">kvm_mmu_get_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">direct_gfn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				      <span class="nb">true</span><span class="p">,</span> <span class="n">direct_access</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
		<span class="n">link_shadow_page</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_sp_write_flooding_count</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
	<span class="n">mmu_set_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">gw</span><span class="o">-&gt;</span><span class="n">pte_access</span><span class="p">,</span>
		     <span class="n">user_fault</span><span class="p">,</span> <span class="n">write_fault</span><span class="p">,</span> <span class="n">emulate</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">,</span>
		     <span class="n">gw</span><span class="o">-&gt;</span><span class="n">gfn</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">prefault</span><span class="p">,</span> <span class="n">map_writable</span><span class="p">);</span>
	<span class="n">FNAME</span><span class="p">(</span><span class="n">pte_prefetch</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gw</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">;</span>

<span class="nl">out_gpte_changed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">kvm_mmu_put_page</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
	<span class="n">kvm_release_pfn_clean</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Page fault handler.  There are several causes for a page fault:</span>
<span class="cm"> *   - there is no shadow pte for the guest pte</span>
<span class="cm"> *   - write access through a shadow pte marked read only so that we can set</span>
<span class="cm"> *     the dirty bit</span>
<span class="cm"> *   - write access to a shadow pte marked read only so we can update the page</span>
<span class="cm"> *     dirty bitmap, when userspace requests it</span>
<span class="cm"> *   - mmio access; in this case we will never install a present shadow pte</span>
<span class="cm"> *   - normal guest page fault due to the guest pte marked not present, not</span>
<span class="cm"> *     writable, or not executable</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: 1 if we need to emulate the instruction, 0 otherwise, or</span>
<span class="cm"> *           a negative value on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">page_fault</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error_code</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">prefault</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">write_fault</span> <span class="o">=</span> <span class="n">error_code</span> <span class="o">&amp;</span> <span class="n">PFERR_WRITE_MASK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">user_fault</span> <span class="o">=</span> <span class="n">error_code</span> <span class="o">&amp;</span> <span class="n">PFERR_USER_MASK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">guest_walker</span> <span class="n">walker</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">sptep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">emulate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">pfn_t</span> <span class="n">pfn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">force_pt_level</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmu_seq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">map_writable</span><span class="p">;</span>

	<span class="n">pgprintk</span><span class="p">(</span><span class="s">&quot;%s: addr %lx err %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">error_code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error_code</span> <span class="o">&amp;</span> <span class="n">PFERR_RSVD_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">handle_mmio_page_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">error_code</span><span class="p">,</span>
					      <span class="n">mmu_is_nested</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">mmu_topup_memory_caches</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Look up the guest pte for the faulting address.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">walk_addr</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">walker</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">error_code</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The page is not mapped by the guest.  Let the guest handle it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pgprintk</span><span class="p">(</span><span class="s">&quot;%s: guest page fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefault</span><span class="p">)</span>
			<span class="n">inject_page_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">walker</span><span class="p">.</span><span class="n">fault</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">walker</span><span class="p">.</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">PT_DIRECTORY_LEVEL</span><span class="p">)</span>
		<span class="n">force_pt_level</span> <span class="o">=</span> <span class="n">mapping_level_dirty_bitmap</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">walker</span><span class="p">.</span><span class="n">gfn</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">force_pt_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_pt_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">walker</span><span class="p">.</span><span class="n">level</span><span class="p">,</span> <span class="n">mapping_level</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">walker</span><span class="p">.</span><span class="n">gfn</span><span class="p">));</span>
		<span class="n">walker</span><span class="p">.</span><span class="n">gfn</span> <span class="o">=</span> <span class="n">walker</span><span class="p">.</span><span class="n">gfn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">KVM_PAGES_PER_HPAGE</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mmu_seq</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">mmu_notifier_seq</span><span class="p">;</span>
	<span class="n">smp_rmb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">try_async_pf</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">prefault</span><span class="p">,</span> <span class="n">walker</span><span class="p">.</span><span class="n">gfn</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfn</span><span class="p">,</span> <span class="n">write_fault</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">map_writable</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handle_abnormal_pfn</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">mmu_is_nested</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">addr</span><span class="p">,</span>
				<span class="n">walker</span><span class="p">.</span><span class="n">gfn</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">walker</span><span class="p">.</span><span class="n">pte_access</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">mmu_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmu_notifier_retry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">mmu_seq</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">kvm_mmu_audit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">AUDIT_PRE_PAGE_FAULT</span><span class="p">);</span>
	<span class="n">kvm_mmu_free_some_pages</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_pt_level</span><span class="p">)</span>
		<span class="n">transparent_hugepage_adjust</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">walker</span><span class="p">.</span><span class="n">gfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
	<span class="n">sptep</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">fetch</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">walker</span><span class="p">,</span> <span class="n">user_fault</span><span class="p">,</span> <span class="n">write_fault</span><span class="p">,</span>
			     <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emulate</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">map_writable</span><span class="p">,</span> <span class="n">prefault</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">sptep</span><span class="p">;</span>
	<span class="n">pgprintk</span><span class="p">(</span><span class="s">&quot;%s: shadow pte %p %llx emulate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">sptep</span><span class="p">,</span> <span class="o">*</span><span class="n">sptep</span><span class="p">,</span> <span class="n">emulate</span><span class="p">);</span>

	<span class="o">++</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">pf_fixed</span><span class="p">;</span>
	<span class="n">kvm_mmu_audit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">AUDIT_POST_PAGE_FAULT</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">mmu_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">emulate</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">mmu_lock</span><span class="p">);</span>
	<span class="n">kvm_release_pfn_clean</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">gpa_t</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">get_level1_sp_gpa</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PTTYPE</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">quadrant</span> <span class="o">&lt;&lt;</span> <span class="n">PT64_LEVEL_BITS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gfn_to_gpa</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">gfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pt_element_t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">invlpg</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">gva</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_shadow_walk_iterator</span> <span class="n">iterator</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">sptep</span><span class="p">;</span>

	<span class="n">vcpu_clear_mmio_info</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No need to check return value here, rmap_can_add() can</span>
<span class="cm">	 * help us to skip pte prefetch later.</span>
<span class="cm">	 */</span>
	<span class="n">mmu_topup_memory_caches</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">mmu_lock</span><span class="p">);</span>
	<span class="n">for_each_shadow_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva</span><span class="p">,</span> <span class="n">iterator</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">iterator</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
		<span class="n">sptep</span> <span class="o">=</span> <span class="n">iterator</span><span class="p">.</span><span class="n">sptep</span><span class="p">;</span>

		<span class="n">sp</span> <span class="o">=</span> <span class="n">page_header</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">sptep</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_last_spte</span><span class="p">(</span><span class="o">*</span><span class="n">sptep</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pt_element_t</span> <span class="n">gpte</span><span class="p">;</span>
			<span class="n">gpa_t</span> <span class="n">pte_gpa</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">unsync</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">pte_gpa</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">get_level1_sp_gpa</span><span class="p">)(</span><span class="n">sp</span><span class="p">);</span>
			<span class="n">pte_gpa</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sptep</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pt_element_t</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mmu_page_zap_pte</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sptep</span><span class="p">))</span>
				<span class="n">kvm_flush_remote_tlbs</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmap_can_add</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">kvm_read_guest_atomic</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">pte_gpa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpte</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">pt_element_t</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">FNAME</span><span class="p">(</span><span class="n">update_pte</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sptep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpte</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_shadow_present_pte</span><span class="p">(</span><span class="o">*</span><span class="n">sptep</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">unsync_children</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">mmu_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">gpa_t</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">gva_to_gpa</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">access</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">x86_exception</span> <span class="o">*</span><span class="n">exception</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">guest_walker</span> <span class="n">walker</span><span class="p">;</span>
	<span class="n">gpa_t</span> <span class="n">gpa</span> <span class="o">=</span> <span class="n">UNMAPPED_GVA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">walk_addr</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">walker</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">access</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpa</span> <span class="o">=</span> <span class="n">gfn_to_gpa</span><span class="p">(</span><span class="n">walker</span><span class="p">.</span><span class="n">gfn</span><span class="p">);</span>
		<span class="n">gpa</span> <span class="o">|=</span> <span class="n">vaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span><span class="p">)</span>
		<span class="o">*</span><span class="n">exception</span> <span class="o">=</span> <span class="n">walker</span><span class="p">.</span><span class="n">fault</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gpa</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">gpa_t</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">gva_to_gpa_nested</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">vaddr</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">access</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">x86_exception</span> <span class="o">*</span><span class="n">exception</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">guest_walker</span> <span class="n">walker</span><span class="p">;</span>
	<span class="n">gpa_t</span> <span class="n">gpa</span> <span class="o">=</span> <span class="n">UNMAPPED_GVA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">walk_addr_nested</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">walker</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">access</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpa</span> <span class="o">=</span> <span class="n">gfn_to_gpa</span><span class="p">(</span><span class="n">walker</span><span class="p">.</span><span class="n">gfn</span><span class="p">);</span>
		<span class="n">gpa</span> <span class="o">|=</span> <span class="n">vaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span><span class="p">)</span>
		<span class="o">*</span><span class="n">exception</span> <span class="o">=</span> <span class="n">walker</span><span class="p">.</span><span class="n">fault</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gpa</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Using the cached information from sp-&gt;gfns is safe because:</span>
<span class="cm"> * - The spte has a reference to the struct page, so the pfn for a given gfn</span>
<span class="cm"> *   can&#39;t change unless all sptes pointing to it are nuked first.</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *   We should flush all tlbs if spte is dropped even though guest is</span>
<span class="cm"> *   responsible for it. Since if we don&#39;t, kvm_mmu_notifier_invalidate_page</span>
<span class="cm"> *   and kvm_mmu_notifier_invalidate_range_start detect the mapping page isn&#39;t</span>
<span class="cm"> *   used by guest then tlbs are not flushed, so guest is allowed to access the</span>
<span class="cm"> *   freed pages.</span>
<span class="cm"> *   And we increase kvm-&gt;tlbs_dirty to delay tlbs flush in this case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">FNAME</span><span class="p">(</span><span class="n">sync_page</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">host_writable</span><span class="p">;</span>
	<span class="n">gpa_t</span> <span class="n">first_pte_gpa</span><span class="p">;</span>

	<span class="cm">/* direct kvm_mmu_page can not be unsync. */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">direct</span><span class="p">);</span>

	<span class="n">first_pte_gpa</span> <span class="o">=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">get_level1_sp_gpa</span><span class="p">)(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PT64_ENT_PER_PAGE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">pte_access</span><span class="p">;</span>
		<span class="n">pt_element_t</span> <span class="n">gpte</span><span class="p">;</span>
		<span class="n">gpa_t</span> <span class="n">pte_gpa</span><span class="p">;</span>
		<span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pte_gpa</span> <span class="o">=</span> <span class="n">first_pte_gpa</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pt_element_t</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kvm_read_guest_atomic</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">pte_gpa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpte</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="n">pt_element_t</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">FNAME</span><span class="p">(</span><span class="n">prefetch_invalid_gpte</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gpte</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">tlbs_dirty</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gfn</span> <span class="o">=</span> <span class="n">gpte_to_gfn</span><span class="p">(</span><span class="n">gpte</span><span class="p">);</span>
		<span class="n">pte_access</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">access</span><span class="p">;</span>
		<span class="n">pte_access</span> <span class="o">&amp;=</span> <span class="n">FNAME</span><span class="p">(</span><span class="n">gpte_access</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gpte</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sync_mmio_spte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gfn</span><span class="p">,</span> <span class="n">pte_access</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_present</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gfn</span> <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">gfns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">drop_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">tlbs_dirty</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nr_present</span><span class="o">++</span><span class="p">;</span>

		<span class="n">host_writable</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SPTE_HOST_WRITEABLE</span><span class="p">;</span>

		<span class="n">set_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pte_access</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="n">PT_PAGE_TABLE_LEVEL</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span>
			 <span class="n">spte_to_pfn</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
			 <span class="n">host_writable</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">nr_present</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef pt_element_t</span>
<span class="cp">#undef guest_walker</span>
<span class="cp">#undef FNAME</span>
<span class="cp">#undef PT_BASE_ADDR_MASK</span>
<span class="cp">#undef PT_INDEX</span>
<span class="cp">#undef PT_LVL_ADDR_MASK</span>
<span class="cp">#undef PT_LVL_OFFSET_MASK</span>
<span class="cp">#undef PT_LEVEL_BITS</span>
<span class="cp">#undef PT_MAX_FULL_LEVELS</span>
<span class="cp">#undef gpte_to_gfn</span>
<span class="cp">#undef gpte_to_gfn_lvl</span>
<span class="cp">#undef CMPXCHG</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
