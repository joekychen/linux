<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kvm › lapic.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lapic.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Local APIC virtualization</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Qumranet, Inc.</span>
<span class="cm"> * Copyright (C) 2007 Novell</span>
<span class="cm"> * Copyright (C) 2007 Intel</span>
<span class="cm"> * Copyright 2009 Red Hat, Inc. and/or its affiliates.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Dor Laor &lt;dor.laor@qumranet.com&gt;</span>
<span class="cm"> *   Gregory Haskins &lt;ghaskins@novell.com&gt;</span>
<span class="cm"> *   Yaozu (Eddie) Dong &lt;eddie.dong@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on Xen 3.1 code, Copyright (c) 2004, Intel Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This work is licensed under the terms of the GNU GPL, version 2.  See</span>
<span class="cm"> * the COPYING file in the top-level directory.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/kvm.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/math64.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/msr.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/current.h&gt;</span>
<span class="cp">#include &lt;asm/apicdef.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &quot;kvm_cache_regs.h&quot;</span>
<span class="cp">#include &quot;irq.h&quot;</span>
<span class="cp">#include &quot;trace.h&quot;</span>
<span class="cp">#include &quot;x86.h&quot;</span>
<span class="cp">#include &quot;cpuid.h&quot;</span>

<span class="cp">#ifndef CONFIG_X86_64</span>
<span class="cp">#define mod_64(x, y) ((x) - (y) * div64_u64(x, y))</span>
<span class="cp">#else</span>
<span class="cp">#define mod_64(x, y) ((x) % (y))</span>
<span class="cp">#endif</span>

<span class="cp">#define PRId64 &quot;d&quot;</span>
<span class="cp">#define PRIx64 &quot;llx&quot;</span>
<span class="cp">#define PRIu64 &quot;u&quot;</span>
<span class="cp">#define PRIo64 &quot;o&quot;</span>

<span class="cp">#define APIC_BUS_CYCLE_NS 1</span>

<span class="cm">/* #define apic_debug(fmt,arg...) printk(KERN_WARNING fmt,##arg) */</span>
<span class="cp">#define apic_debug(fmt, arg...)</span>

<span class="cp">#define APIC_LVT_NUM			6</span>
<span class="cm">/* 14 is the version for Xeon and Pentium 8.4.8*/</span>
<span class="cp">#define APIC_VERSION			(0x14UL | ((APIC_LVT_NUM - 1) &lt;&lt; 16))</span>
<span class="cp">#define LAPIC_MMIO_LENGTH		(1 &lt;&lt; 12)</span>
<span class="cm">/* followed define is not in apicdef.h */</span>
<span class="cp">#define APIC_SHORT_MASK			0xc0000</span>
<span class="cp">#define APIC_DEST_NOSHORT		0x0</span>
<span class="cp">#define APIC_DEST_MASK			0x800</span>
<span class="cp">#define MAX_APIC_VECTOR			256</span>

<span class="cp">#define VEC_POS(v) ((v) &amp; (32 - 1))</span>
<span class="cp">#define REG_POS(v) (((v) &gt;&gt; 5) &lt;&lt; 4)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_timer_period_us</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">min_timer_period_us</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">apic_get_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg_off</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">apic_set_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg_off</span><span class="p">))</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_test_and_set_vector</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">VEC_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">REG_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_test_and_clear_vector</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">VEC_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">REG_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_test_vector</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">VEC_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">REG_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">apic_set_vector</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">VEC_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">REG_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">apic_clear_vector</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">VEC_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">REG_POS</span><span class="p">(</span><span class="n">vec</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_hw_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">apic</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">&amp;</span> <span class="n">MSR_IA32_APICBASE_ENABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>  <span class="nf">apic_sw_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_SPIV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">APIC_SPIV_APIC_ENABLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">apic_sw_enabled</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>	<span class="n">apic_hw_enabled</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define LVT_MASK	\</span>
<span class="cp">	(APIC_LVT_MASKED | APIC_SEND_PENDING | APIC_VECTOR_MASK)</span>

<span class="cp">#define LINT_MASK	\</span>
<span class="cp">	(LVT_MASK | APIC_MODE_MASK | APIC_INPUT_POLARITY | \</span>
<span class="cp">	 APIC_LVT_REMOTE_IRR | APIC_LVT_LEVEL_TRIGGER)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">kvm_apic_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_lvt_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lvt_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">lvt_type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">APIC_LVT_MASKED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_lvt_vector</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lvt_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">lvt_type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">APIC_VECTOR_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_lvtt_oneshot</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVTT</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer_mode_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">APIC_LVT_TIMER_ONESHOT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_lvtt_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVTT</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer_mode_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">APIC_LVT_TIMER_PERIODIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_lvtt_tscdeadline</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVTT</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer_mode_mask</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">APIC_LVT_TIMER_TSCDEADLINE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_lvt_nmi_mode</span><span class="p">(</span><span class="n">u32</span> <span class="n">lvt_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">lvt_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">APIC_MODE_MASK</span> <span class="o">|</span> <span class="n">APIC_LVT_MASKED</span><span class="p">))</span> <span class="o">==</span> <span class="n">APIC_DM_NMI</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_apic_set_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_cpuid_entry2</span> <span class="o">*</span><span class="n">feat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">APIC_VERSION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">feat</span> <span class="o">=</span> <span class="n">kvm_find_cpuid_entry</span><span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">feat</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">feat</span><span class="o">-&gt;</span><span class="n">ecx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">X86_FEATURE_X2APIC</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">))))</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">APIC_LVR_DIRECTED_EOI</span><span class="p">;</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVR</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_x2apic_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">&amp;</span> <span class="n">X2APIC_ENABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">apic_lvt_mask</span><span class="p">[</span><span class="n">APIC_LVT_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">LVT_MASK</span> <span class="p">,</span>      <span class="cm">/* part LVTT mask, timer mode mask added at runtime */</span>
	<span class="n">LVT_MASK</span> <span class="o">|</span> <span class="n">APIC_MODE_MASK</span><span class="p">,</span>	<span class="cm">/* LVTTHMR */</span>
	<span class="n">LVT_MASK</span> <span class="o">|</span> <span class="n">APIC_MODE_MASK</span><span class="p">,</span>	<span class="cm">/* LVTPC */</span>
	<span class="n">LINT_MASK</span><span class="p">,</span> <span class="n">LINT_MASK</span><span class="p">,</span>	<span class="cm">/* LVT0-1 */</span>
	<span class="n">LVT_MASK</span>		<span class="cm">/* LVTERR */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_highest_vector</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">word</span> <span class="o">=</span> <span class="n">bitmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">word_offset</span> <span class="o">=</span> <span class="n">MAX_APIC_VECTOR</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">word_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">word</span><span class="p">[(</span><span class="o">--</span><span class="n">word_offset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">word_offset</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">fls</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">word_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">word_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_test_and_set_irr</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">irr_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">apic_test_and_set_vector</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_IRR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_search_irr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">find_highest_vector</span><span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_IRR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_find_highest_irr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">irr_pending</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">apic_search_irr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">apic_clear_irr</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">irr_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">apic_clear_vector</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_IRR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apic_search_irr</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">apic</span><span class="o">-&gt;</span><span class="n">irr_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_lapic_find_highest_irr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">highest_irr</span><span class="p">;</span>

	<span class="cm">/* This may race with setting of irr in __apic_accept_irq() and</span>
<span class="cm">	 * value returned may be wrong, but kvm_vcpu_kick() in __apic_accept_irq</span>
<span class="cm">	 * will cause vmexit immediately and the value will be recalculated</span>
<span class="cm">	 * on the next vmentry.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">highest_irr</span> <span class="o">=</span> <span class="n">apic_find_highest_irr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">highest_irr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__apic_accept_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delivery_mode</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trig_mode</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">kvm_apic_set_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_lapic_irq</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__apic_accept_irq</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">delivery_mode</span><span class="p">,</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span>
			<span class="n">irq</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">trig_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">apic_find_highest_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">find_highest_vector</span><span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_ISR</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">apic_update_ppr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">isrv</span><span class="p">,</span> <span class="n">ppr</span><span class="p">,</span> <span class="n">old_ppr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isr</span><span class="p">;</span>

	<span class="n">old_ppr</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_PROCPRI</span><span class="p">);</span>
	<span class="n">tpr</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TASKPRI</span><span class="p">);</span>
	<span class="n">isr</span> <span class="o">=</span> <span class="n">apic_find_highest_isr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="n">isrv</span> <span class="o">=</span> <span class="p">(</span><span class="n">isr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">isr</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tpr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">isrv</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">))</span>
		<span class="n">ppr</span> <span class="o">=</span> <span class="n">tpr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ppr</span> <span class="o">=</span> <span class="n">isrv</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>

	<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;vlapic %p, ppr 0x%x, isr 0x%x, isrv 0x%x&quot;</span><span class="p">,</span>
		   <span class="n">apic</span><span class="p">,</span> <span class="n">ppr</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="n">isrv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_ppr</span> <span class="o">!=</span> <span class="n">ppr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_PROCPRI</span><span class="p">,</span> <span class="n">ppr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppr</span> <span class="o">&lt;</span> <span class="n">old_ppr</span><span class="p">)</span>
			<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">apic_set_tpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tpr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TASKPRI</span><span class="p">,</span> <span class="n">tpr</span><span class="p">);</span>
	<span class="n">apic_update_ppr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_apic_match_physical_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dest</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">kvm_apic_id</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">==</span> <span class="n">dest</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_apic_match_logical_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mda</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">logical_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">logical_id</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LDR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">logical_id</span> <span class="o">&amp;</span> <span class="n">mda</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">logical_id</span> <span class="o">=</span> <span class="n">GET_APIC_LOGICAL_ID</span><span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LDR</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_DFR</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APIC_DFR_FLAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">logical_id</span> <span class="o">&amp;</span> <span class="n">mda</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">APIC_DFR_CLUSTER</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">logical_id</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">mda</span> <span class="o">&gt;&gt;</span> <span class="mh">0x4</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">logical_id</span> <span class="o">&amp;</span> <span class="n">mda</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;Bad DFR vcpu %d: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">,</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_DFR</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_apic_match_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">short_hand</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dest_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;target %p, source %p, dest 0x%x, &quot;</span>
		   <span class="s">&quot;dest_mode 0x%x, short_hand 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dest_mode</span><span class="p">,</span> <span class="n">short_hand</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">short_hand</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APIC_DEST_NOSHORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dest_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* Physical mode. */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">kvm_apic_match_physical_addr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* Logical mode. */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">kvm_apic_match_logical_addr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">APIC_DEST_SELF</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">source</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">APIC_DEST_ALLINC</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">APIC_DEST_ALLBUT</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="n">source</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;kvm: apic: Bad dest shorthand value %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">short_hand</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add a pending IRQ into lapic.</span>
<span class="cm"> * Return 1 if successfully added and 0 if discarded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__apic_accept_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delivery_mode</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trig_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">delivery_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APIC_DM_LOWEST</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_arb_prio</span><span class="o">++</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">APIC_DM_FIXED</span>:
		<span class="cm">/* FIXME add logic for vcpu on reset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">apic_enabled</span><span class="p">(</span><span class="n">apic</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">trig_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;level trig mode for vector %d&quot;</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
			<span class="n">apic_set_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_TMR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">apic_clear_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_TMR</span><span class="p">);</span>

		<span class="n">result</span> <span class="o">=</span> <span class="o">!</span><span class="n">apic_test_and_set_irr</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">apic</span><span class="p">);</span>
		<span class="n">trace_kvm_apic_accept_irq</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">,</span> <span class="n">delivery_mode</span><span class="p">,</span>
					  <span class="n">trig_mode</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="o">!</span><span class="n">result</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">trig_mode</span><span class="p">)</span>
				<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;level trig mode repeatedly for &quot;</span>
						<span class="s">&quot;vector %d&quot;</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
		<span class="n">kvm_vcpu_kick</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_DM_REMRD</span>:
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;Ignoring delivery mode 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_DM_SMI</span>:
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;Ignoring guest SMI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_DM_NMI</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">kvm_inject_nmi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">kvm_vcpu_kick</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_DM_INIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trig_mode</span> <span class="o">||</span> <span class="n">level</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mp_state</span> <span class="o">=</span> <span class="n">KVM_MP_STATE_INIT_RECEIVED</span><span class="p">;</span>
			<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
			<span class="n">kvm_vcpu_kick</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;Ignoring de-assert INIT to vcpu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_DM_STARTUP</span>:
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;SIPI to vcpu %d vector 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mp_state</span> <span class="o">==</span> <span class="n">KVM_MP_STATE_INIT_RECEIVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">sipi_vector</span> <span class="o">=</span> <span class="n">vector</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mp_state</span> <span class="o">=</span> <span class="n">KVM_MP_STATE_SIPI_RECEIVED</span><span class="p">;</span>
			<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
			<span class="n">kvm_vcpu_kick</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_DM_EXTINT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Should only be called by kvm_apic_local_deliver() with LVT0,</span>
<span class="cm">		 * before NMI watchdog was enabled. Already handled by</span>
<span class="cm">		 * kvm_apic_accept_pic_intr().</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;TODO: unsupported delivery mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">delivery_mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_apic_compare_prio</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu1</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_arb_prio</span> <span class="o">-</span> <span class="n">vcpu2</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_arb_prio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">apic_set_eoi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">apic_find_highest_isr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Not every write EOI will has corresponding ISR,</span>
<span class="cm">	 * one example is when Kernel check timer on setup_IO_APIC</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">apic_clear_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_ISR</span><span class="p">);</span>
	<span class="n">apic_update_ppr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_SPIV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">APIC_SPIV_DIRECTED_EOI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">kvm_ioapic_handles_vector</span><span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">vector</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">trigger_mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apic_test_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_TMR</span><span class="p">))</span>
			<span class="n">trigger_mode</span> <span class="o">=</span> <span class="n">IOAPIC_LEVEL_TRIG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">trigger_mode</span> <span class="o">=</span> <span class="n">IOAPIC_EDGE_TRIG</span><span class="p">;</span>
		<span class="n">kvm_ioapic_update_eoi</span><span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">trigger_mode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">apic_send_ipi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">icr_low</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">icr_high</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR2</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvm_lapic_irq</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span><span class="p">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">icr_low</span> <span class="o">&amp;</span> <span class="n">APIC_VECTOR_MASK</span><span class="p">;</span>
	<span class="n">irq</span><span class="p">.</span><span class="n">delivery_mode</span> <span class="o">=</span> <span class="n">icr_low</span> <span class="o">&amp;</span> <span class="n">APIC_MODE_MASK</span><span class="p">;</span>
	<span class="n">irq</span><span class="p">.</span><span class="n">dest_mode</span> <span class="o">=</span> <span class="n">icr_low</span> <span class="o">&amp;</span> <span class="n">APIC_DEST_MASK</span><span class="p">;</span>
	<span class="n">irq</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">icr_low</span> <span class="o">&amp;</span> <span class="n">APIC_INT_ASSERT</span><span class="p">;</span>
	<span class="n">irq</span><span class="p">.</span><span class="n">trig_mode</span> <span class="o">=</span> <span class="n">icr_low</span> <span class="o">&amp;</span> <span class="n">APIC_INT_LEVELTRIG</span><span class="p">;</span>
	<span class="n">irq</span><span class="p">.</span><span class="n">shorthand</span> <span class="o">=</span> <span class="n">icr_low</span> <span class="o">&amp;</span> <span class="n">APIC_SHORT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
		<span class="n">irq</span><span class="p">.</span><span class="n">dest_id</span> <span class="o">=</span> <span class="n">icr_high</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">irq</span><span class="p">.</span><span class="n">dest_id</span> <span class="o">=</span> <span class="n">GET_APIC_DEST_FIELD</span><span class="p">(</span><span class="n">icr_high</span><span class="p">);</span>

	<span class="n">trace_kvm_apic_ipi</span><span class="p">(</span><span class="n">icr_low</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">dest_id</span><span class="p">);</span>

	<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;icr_high 0x%x, icr_low 0x%x, &quot;</span>
		   <span class="s">&quot;short_hand 0x%x, dest 0x%x, trig_mode 0x%x, level 0x%x, &quot;</span>
		   <span class="s">&quot;dest_mode 0x%x, delivery_mode 0x%x, vector 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">icr_high</span><span class="p">,</span> <span class="n">icr_low</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">shorthand</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">dest_id</span><span class="p">,</span>
		   <span class="n">irq</span><span class="p">.</span><span class="n">trig_mode</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">level</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">dest_mode</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">delivery_mode</span><span class="p">,</span>
		   <span class="n">irq</span><span class="p">.</span><span class="n">vector</span><span class="p">);</span>

	<span class="n">kvm_irq_delivery_to_apic</span><span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">apic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">apic_get_tmcct</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmcct</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">apic</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* if initial count is 0, current count should also be 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TMICT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">remaining</span> <span class="o">=</span> <span class="n">hrtimer_get_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">remaining</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">mod_64</span><span class="p">(</span><span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">remaining</span><span class="p">),</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span><span class="p">);</span>
	<span class="n">tmcct</span> <span class="o">=</span> <span class="n">div64_u64</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">APIC_BUS_CYCLE_NS</span> <span class="o">*</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">divide_count</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">tmcct</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__report_tpr_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">;</span>

	<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_REPORT_TPR_ACCESS</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
	<span class="n">run</span><span class="o">-&gt;</span><span class="n">tpr_access</span><span class="p">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">kvm_rip_read</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">run</span><span class="o">-&gt;</span><span class="n">tpr_access</span><span class="p">.</span><span class="n">is_write</span> <span class="o">=</span> <span class="n">write</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">report_tpr_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tpr_access_reporting</span><span class="p">)</span>
		<span class="n">__report_tpr_access</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__apic_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">LAPIC_MMIO_LENGTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APIC_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">kvm_apic_id</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">kvm_apic_id</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">APIC_ARBPRI</span>:
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;Access APIC ARBPRI register which is for P6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_TMCCT</span>:	<span class="cm">/* Timer CCR */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apic_lvtt_tscdeadline</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">apic_get_tmcct</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_TASKPRI</span>:
		<span class="n">report_tpr_access</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="cm">/* fall thru */</span>
	<span class="nl">default:</span>
		<span class="n">apic_update_ppr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="nf">to_lapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_io_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_lapic</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">apic_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">alignment</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>
	<span class="cm">/* this bitmask has a bit cleared for each reserver register */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">rmask</span> <span class="o">=</span> <span class="mh">0x43ff01ffffffe70cULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">alignment</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;KVM_APIC_READ: alignment error %x %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mh">0x3f0</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">rmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;KVM_APIC_READ: read reserved register %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">__apic_read</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">);</span>

	<span class="n">trace_kvm_apic_read</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">result</span> <span class="o">+</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Local APIC read with len = %x, &quot;</span>
		       <span class="s">&quot;should be 1,2, or 4 instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">apic_mmio_in_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">gpa_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">apic_hw_enabled</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span> <span class="o">&amp;&amp;</span>
	    <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span> <span class="o">+</span> <span class="n">LAPIC_MMIO_LENGTH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">apic_mmio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_io_device</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			   <span class="n">gpa_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">to_lapic</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">address</span> <span class="o">-</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_mmio_in_range</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">apic_reg_read</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_divide_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">tdcr</span><span class="p">;</span>

	<span class="n">tdcr</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TDCR</span><span class="p">);</span>
	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">tdcr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">divide_count</span> <span class="o">=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;timer divide count is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">apic</span><span class="o">-&gt;</span><span class="n">divide_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_apic_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">now</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic_lvtt_period</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">||</span> <span class="n">apic_lvtt_oneshot</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* lapic timer in oneshot or peroidic mode */</span>
		<span class="n">now</span> <span class="o">=</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">get_time</span><span class="p">();</span>
		<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TMICT</span><span class="p">)</span>
			    <span class="o">*</span> <span class="n">APIC_BUS_CYCLE_NS</span> <span class="o">*</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">divide_count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do not allow the guest to program periodic timers with small</span>
<span class="cm">		 * interval, since the hrtimers are not throttled by the host</span>
<span class="cm">		 * scheduler.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apic_lvtt_period</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s64</span> <span class="n">min_period</span> <span class="o">=</span> <span class="n">min_timer_period_us</span> <span class="o">*</span> <span class="mi">1000LL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span> <span class="o">&lt;</span> <span class="n">min_period</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info_ratelimited</span><span class="p">(</span>
				    <span class="s">&quot;kvm: vcpu %i: requested %lld ns &quot;</span>
				    <span class="s">&quot;lapic timer period limited to %lld ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">,</span>
				    <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span><span class="p">,</span> <span class="n">min_period</span><span class="p">);</span>
				<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">min_period</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
			      <span class="n">ktime_add_ns</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span><span class="p">),</span>
			      <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>

		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;%s: bus cycle is %&quot;</span> <span class="n">PRId64</span> <span class="s">&quot;ns, now 0x%016&quot;</span>
			   <span class="n">PRIx64</span> <span class="s">&quot;, &quot;</span>
			   <span class="s">&quot;timer initial count 0x%x, period %lldns, &quot;</span>
			   <span class="s">&quot;expire @ 0x%016&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">APIC_BUS_CYCLE_NS</span><span class="p">,</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
			   <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TMICT</span><span class="p">),</span>
			   <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span><span class="p">,</span>
			   <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_add_ns</span><span class="p">(</span><span class="n">now</span><span class="p">,</span>
					<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">period</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">apic_lvtt_tscdeadline</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* lapic timer in tsc deadline mode */</span>
		<span class="n">u64</span> <span class="n">guest_tsc</span><span class="p">,</span> <span class="n">tscdeadline</span> <span class="o">=</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">tscdeadline</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">this_tsc_khz</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">virtual_tsc_khz</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">tscdeadline</span> <span class="o">||</span> <span class="o">!</span><span class="n">this_tsc_khz</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">now</span> <span class="o">=</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">get_time</span><span class="p">();</span>
		<span class="n">guest_tsc</span> <span class="o">=</span> <span class="n">kvm_x86_ops</span><span class="o">-&gt;</span><span class="n">read_l1_tsc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tscdeadline</span> <span class="o">&gt;</span> <span class="n">guest_tsc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">tscdeadline</span> <span class="o">-</span> <span class="n">guest_tsc</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000ULL</span><span class="p">;</span>
			<span class="n">do_div</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">this_tsc_khz</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
			<span class="n">ktime_add_ns</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">ns</span><span class="p">),</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>

		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">apic_manage_nmi_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lvt0_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nmi_wd_enabled</span> <span class="o">=</span> <span class="n">apic_lvt_nmi_mode</span><span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVT0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic_lvt_nmi_mode</span><span class="p">(</span><span class="n">lvt0_val</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nmi_wd_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;Receive NMI setting on APIC_LVT0 &quot;</span>
				   <span class="s">&quot;for cpu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">);</span>
			<span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vapics_in_nmi_mode</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nmi_wd_enabled</span><span class="p">)</span>
		<span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vapics_in_nmi_mode</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">apic_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_kvm_apic_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APIC_ID</span>:		<span class="cm">/* Local APIC ID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ID</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_TASKPRI</span>:
		<span class="n">report_tpr_access</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">apic_set_tpr</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_EOI</span>:
		<span class="n">apic_set_eoi</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_LDR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LDR</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">APIC_LDR_MASK</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_DFR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_DFR</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x0FFFFFFF</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_SPIV</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">APIC_LVR_DIRECTED_EOI</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">APIC_SPIV_DIRECTED_EOI</span><span class="p">;</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_SPIV</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">APIC_SPIV_APIC_ENABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">lvt_val</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">APIC_LVT_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lvt_val</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span>
						       <span class="n">APIC_LVTT</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVTT</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
					     <span class="n">lvt_val</span> <span class="o">|</span> <span class="n">APIC_LVT_MASKED</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">APIC_ICR</span>:
		<span class="cm">/* No delay here, so we always clear the pending bit */</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
		<span class="n">apic_send_ipi</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_ICR2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xff000000</span><span class="p">;</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_LVT0</span>:
		<span class="n">apic_manage_nmi_watchdog</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">APIC_LVTTHMR</span>:
	<span class="k">case</span> <span class="n">APIC_LVTPC</span>:
	<span class="k">case</span> <span class="n">APIC_LVT1</span>:
	<span class="k">case</span> <span class="n">APIC_LVTERR</span>:
		<span class="cm">/* TODO: Check vector */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_sw_enabled</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">APIC_LVT_MASKED</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">apic_lvt_mask</span><span class="p">[(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">APIC_LVTT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_LVTT</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVTT</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer_mode_mask</span><span class="p">)</span> <span class="o">!=</span>
		   <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer_mode_mask</span><span class="p">))</span>
			<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_sw_enabled</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">APIC_LVT_MASKED</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">apic_lvt_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer_mode_mask</span><span class="p">);</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVTT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_TMICT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">apic_lvtt_tscdeadline</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TMICT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">start_apic_timer</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_TDCR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;KVM_WRITE:TDCR %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TDCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">update_divide_count</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_ESR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;KVM_WRITE:ESR not zero %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">APIC_SELF_IPI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">apic_reg_write</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR</span><span class="p">,</span> <span class="mh">0x40000</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;Local APIC Write to read-only register %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">apic_mmio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_io_device</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			    <span class="n">gpa_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">to_lapic</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">address</span> <span class="o">-</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_mmio_in_range</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * APIC register must be aligned on 128-bits boundary.</span>
<span class="cm">	 * 32/64/128 bits registers must be accessed thru 32 bits.</span>
<span class="cm">	 * Refer SDM 8.4.1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t shout loud, $infamous_os would cause only noise. */</span>
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;apic write: bad size=%d %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">address</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* too common printing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">APIC_EOI</span><span class="p">)</span>
		<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;%s: offset 0x%x with length 0x%x, and value is &quot;</span>
			   <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">apic_reg_write</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xff0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_lapic_set_eoi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic</span><span class="p">)</span>
		<span class="n">apic_reg_write</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_EOI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">kvm_lapic_set_eoi</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">kvm_free_lapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *----------------------------------------------------------------------</span>
<span class="cm"> * LAPIC interface</span>
<span class="cm"> *----------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="n">u64</span> <span class="nf">kvm_get_lapic_tscdeadline_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic_lvtt_oneshot</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">||</span> <span class="n">apic_lvtt_period</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">tscdeadline</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_set_lapic_tscdeadline_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic_lvtt_oneshot</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">||</span> <span class="n">apic_lvtt_period</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">tscdeadline</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">start_apic_timer</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_lapic_set_tpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr8</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">apic_set_tpr</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="p">((</span><span class="n">cr8</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		     <span class="o">|</span> <span class="p">(</span><span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TASKPRI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">kvm_lapic_get_cr8</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tpr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TASKPRI</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">tpr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_lapic_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">MSR_IA32_APICBASE_BSP</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvm_vcpu_is_bsp</span><span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_IA32_APICBASE_BSP</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="n">kvm_apic_id</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">ldr</span> <span class="o">=</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LDR</span><span class="p">,</span> <span class="n">ldr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span> <span class="o">=</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">&amp;</span>
			     <span class="n">MSR_IA32_APICBASE_BASE</span><span class="p">;</span>

	<span class="cm">/* with FSB delivery interrupt, we can restart APIC functionality */</span>
	<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;apic base msr is 0x%016&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;, and base address is &quot;</span>
		   <span class="s">&quot;0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_lapic_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">apic</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Stop the timer in case it&#39;s a reset to an active apic */</span>
	<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ID</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">kvm_apic_set_version</span><span class="p">(</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">APIC_LVT_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVTT</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">APIC_LVT_MASKED</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVT0</span><span class="p">,</span>
		     <span class="n">SET_APIC_DELIVERY_MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">APIC_MODE_EXTINT</span><span class="p">));</span>

	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_DFR</span><span class="p">,</span> <span class="mh">0xffffffffU</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_SPIV</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TASKPRI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ESR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TDCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TMICT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_IRR</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ISR</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">apic_set_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TMR</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">irr_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">update_divide_count</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kvm_vcpu_is_bsp</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">|=</span> <span class="n">MSR_IA32_APICBASE_BSP</span><span class="p">;</span>
	<span class="n">apic_update_ppr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_arb_prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_attention</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">apic_debug</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: vcpu=%p, id=%d, base_msr=&quot;</span>
		   <span class="s">&quot;0x%016&quot;</span> <span class="n">PRIx64</span> <span class="s">&quot;, base_address=0x%0lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">vcpu</span><span class="p">,</span> <span class="n">kvm_apic_id</span><span class="p">(</span><span class="n">apic</span><span class="p">),</span>
		   <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">kvm_apic_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span> <span class="o">&amp;&amp;</span> <span class="n">apic_hw_enabled</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_lapic_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kvm_apic_present</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">apic_sw_enabled</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *----------------------------------------------------------------------</span>
<span class="cm"> * timer interface</span>
<span class="cm"> *----------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">lapic_is_periodic</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_timer</span> <span class="o">*</span><span class="n">ktimer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ktimer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_lapic</span><span class="p">,</span>
					      <span class="n">lapic_timer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">apic_lvtt_period</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">apic_has_pending_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">lapic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lapic</span> <span class="o">&amp;&amp;</span> <span class="n">apic_enabled</span><span class="p">(</span><span class="n">lapic</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">apic_lvt_enabled</span><span class="p">(</span><span class="n">lapic</span><span class="p">,</span> <span class="n">APIC_LVTT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lapic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_apic_local_deliver</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lvt_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">lvt_type</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vector</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">trig_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic_hw_enabled</span><span class="p">(</span><span class="n">apic</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">APIC_LVT_MASKED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vector</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">APIC_VECTOR_MASK</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">APIC_MODE_MASK</span><span class="p">;</span>
		<span class="n">trig_mode</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">APIC_LVT_LEVEL_TRIGGER</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">__apic_accept_irq</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trig_mode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_apic_nmi_wd_deliver</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic</span><span class="p">)</span>
		<span class="n">kvm_apic_local_deliver</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVT0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kvm_timer_ops</span> <span class="n">lapic_timer_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">is_periodic</span> <span class="o">=</span> <span class="n">lapic_is_periodic</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kvm_io_device_ops</span> <span class="n">apic_mmio_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>     <span class="o">=</span> <span class="n">apic_mmio_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>    <span class="o">=</span> <span class="n">apic_mmio_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">kvm_create_lapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">vcpu</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">apic_debug</span><span class="p">(</span><span class="s">&quot;apic_init %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">);</span>

	<span class="n">apic</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">apic</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span> <span class="o">=</span> <span class="n">apic</span><span class="p">;</span>

	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;malloc apic regs error for vcpu %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">nomem_free_apic</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">vcpu</span><span class="p">;</span>

	<span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">,</span>
		     <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">kvm_timer_fn</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">t_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lapic_timer_ops</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">kvm</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">vcpu</span><span class="p">;</span>

	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span> <span class="o">=</span> <span class="n">APIC_DEFAULT_PHYS_BASE</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">=</span> <span class="n">APIC_DEFAULT_PHYS_BASE</span><span class="p">;</span>

	<span class="n">kvm_lapic_reset</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_iodevice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apic_mmio_ops</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">nomem_free_apic:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
<span class="nl">nomem:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_apic_has_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">highest_irr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span> <span class="o">||</span> <span class="o">!</span><span class="n">apic_enabled</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">apic_update_ppr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="n">highest_irr</span> <span class="o">=</span> <span class="n">apic_find_highest_irr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">highest_irr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">highest_irr</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_PROCPRI</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">highest_irr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_apic_accept_pic_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lvt0</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVT0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic_hw_enabled</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lvt0</span> <span class="o">&amp;</span> <span class="n">APIC_LVT_MASKED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_APIC_DELIVERY_MODE</span><span class="p">(</span><span class="n">lvt0</span><span class="p">)</span> <span class="o">==</span> <span class="n">APIC_MODE_EXTINT</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_inject_apic_timer_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">pending</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kvm_apic_local_deliver</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_LVTT</span><span class="p">))</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">pending</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_get_apic_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">kvm_apic_has_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">apic_set_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">apic</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APIC_ISR</span><span class="p">);</span>
	<span class="n">apic_update_ppr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="n">apic_clear_irr</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">apic</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vector</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_apic_post_state_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">base_address</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_base</span> <span class="o">&amp;</span>
			     <span class="n">MSR_IA32_APICBASE_BASE</span><span class="p">;</span>
	<span class="n">kvm_apic_set_version</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">apic_update_ppr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">update_divide_count</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="n">start_apic_timer</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">irr_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_EVENT</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__kvm_migrate_apic_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">lapic_timer</span><span class="p">.</span><span class="n">timer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hrtimer_cancel</span><span class="p">(</span><span class="n">timer</span><span class="p">))</span>
		<span class="n">hrtimer_start_expires</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_lapic_sync_from_vapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vapic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">KVM_APIC_CHECK_VAPIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_attention</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vapic</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vapic_page</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">vapic</span> <span class="o">+</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vapic_addr</span><span class="p">));</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">vapic</span><span class="p">);</span>

	<span class="n">apic_set_tpr</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_lapic_sync_to_vapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">tpr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_irr</span><span class="p">,</span> <span class="n">max_isr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vapic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">KVM_APIC_CHECK_VAPIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_attention</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="n">tpr</span> <span class="o">=</span> <span class="n">apic_get_reg</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_TASKPRI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">max_irr</span> <span class="o">=</span> <span class="n">apic_find_highest_irr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_irr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">max_irr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">max_isr</span> <span class="o">=</span> <span class="n">apic_find_highest_isr</span><span class="p">(</span><span class="n">apic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_isr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">max_isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tpr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">max_isr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">max_irr</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">vapic</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vapic_page</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">vapic</span> <span class="o">+</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vapic_addr</span><span class="p">))</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">vapic</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_lapic_set_vapic_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gpa_t</span> <span class="n">vapic_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">vapic_addr</span> <span class="o">=</span> <span class="n">vapic_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vapic_addr</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">KVM_APIC_CHECK_VAPIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_attention</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">KVM_APIC_CHECK_VAPIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic_attention</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_x2apic_msr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">msr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">msr</span> <span class="o">-</span> <span class="n">APIC_BASE_MSR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if this is ICR write vector before command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">==</span> <span class="mh">0x830</span><span class="p">)</span>
		<span class="n">apic_reg_write</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR2</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">apic_reg_write</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_x2apic_msr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">msr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">msr</span> <span class="o">-</span> <span class="n">APIC_BASE_MSR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">apic_x2apic_mode</span><span class="p">(</span><span class="n">apic</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic_reg_read</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">low</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">==</span> <span class="mh">0x830</span><span class="p">)</span>
		<span class="n">apic_reg_read</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">high</span><span class="p">);</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">high</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_hv_vapic_msr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if this is ICR write vector before command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">APIC_ICR</span><span class="p">)</span>
		<span class="n">apic_reg_write</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR2</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">apic_reg_write</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_hv_vapic_msr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_lapic</span> <span class="o">*</span><span class="n">apic</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">apic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqchip_in_kernel</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic_reg_read</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">low</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">APIC_ICR</span><span class="p">)</span>
		<span class="n">apic_reg_read</span><span class="p">(</span><span class="n">apic</span><span class="p">,</span> <span class="n">APIC_ICR2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">high</span><span class="p">);</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">high</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
