<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › cpu › perf_event_p4.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>perf_event_p4.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Netburst Performance Events (P4, old Xeon)</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2010 Parallels, Inc., Cyrill Gorcunov &lt;gorcunov@openvz.org&gt;</span>
<span class="cm"> *  Copyright (C) 2010 Intel Corporation, Lin Ming &lt;ming.m.lin@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  For licencing details see kernel-base/COPYING</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/perf_event.h&gt;</span>

<span class="cp">#include &lt;asm/perf_event_p4.h&gt;</span>
<span class="cp">#include &lt;asm/hardirq.h&gt;</span>
<span class="cp">#include &lt;asm/apic.h&gt;</span>

<span class="cp">#include &quot;perf_event.h&quot;</span>

<span class="cp">#define P4_CNTR_LIMIT 3</span>
<span class="cm">/*</span>
<span class="cm"> * array indices: 0,1 - HT threads, used with HT enabled cpu</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">;</span>			<span class="cm">/* Event code and ESCR selector */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">escr_msr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>		<span class="cm">/* ESCR MSR for this event */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">escr_emask</span><span class="p">;</span>		<span class="cm">/* valid ESCR EventMask bits */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shared</span><span class="p">;</span>			<span class="cm">/* event is shared across threads */</span>
	<span class="kt">char</span> <span class="n">cntr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">P4_CNTR_LIMIT</span><span class="p">];</span>		<span class="cm">/* counter index (offset), -1 on abscence */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">p4_pebs_bind</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">metric_pebs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">metric_vert</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* it sets P4_PEBS_ENABLE_UOP_TAG as well */</span>
<span class="cp">#define P4_GEN_PEBS_BIND(name, pebs, vert)			\</span>
<span class="cp">	[P4_PEBS_METRIC__##name] = {				\</span>
<span class="cp">		.metric_pebs = pebs | P4_PEBS_ENABLE_UOP_TAG,	\</span>
<span class="cp">		.metric_vert = vert,				\</span>
<span class="cp">	}</span>

<span class="cm">/*</span>
<span class="cm"> * note we have P4_PEBS_ENABLE_UOP_TAG always set here</span>
<span class="cm"> *</span>
<span class="cm"> * it&#39;s needed for mapping P4_PEBS_CONFIG_METRIC_MASK bits of</span>
<span class="cm"> * event configuration to find out which values are to be</span>
<span class="cm"> * written into MSR_IA32_PEBS_ENABLE and MSR_P4_PEBS_MATRIX_VERT</span>
<span class="cm"> * resgisters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">p4_pebs_bind</span> <span class="n">p4_pebs_bind_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="mi">1</span><span class="n">stl_cache_load_miss_retired</span><span class="p">,</span>	<span class="mh">0x0000001</span><span class="p">,</span> <span class="mh">0x0000001</span><span class="p">),</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="mi">2</span><span class="n">ndl_cache_load_miss_retired</span><span class="p">,</span>	<span class="mh">0x0000002</span><span class="p">,</span> <span class="mh">0x0000001</span><span class="p">),</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="n">dtlb_load_miss_retired</span><span class="p">,</span>	<span class="mh">0x0000004</span><span class="p">,</span> <span class="mh">0x0000001</span><span class="p">),</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="n">dtlb_store_miss_retired</span><span class="p">,</span>	<span class="mh">0x0000004</span><span class="p">,</span> <span class="mh">0x0000002</span><span class="p">),</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="n">dtlb_all_miss_retired</span><span class="p">,</span>		<span class="mh">0x0000004</span><span class="p">,</span> <span class="mh">0x0000003</span><span class="p">),</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="n">tagged_mispred_branch</span><span class="p">,</span>		<span class="mh">0x0018000</span><span class="p">,</span> <span class="mh">0x0000010</span><span class="p">),</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="n">mob_load_replay_retired</span><span class="p">,</span>	<span class="mh">0x0000200</span><span class="p">,</span> <span class="mh">0x0000001</span><span class="p">),</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="n">split_load_retired</span><span class="p">,</span>		<span class="mh">0x0000400</span><span class="p">,</span> <span class="mh">0x0000001</span><span class="p">),</span>
	<span class="n">P4_GEN_PEBS_BIND</span><span class="p">(</span><span class="n">split_store_retired</span><span class="p">,</span>		<span class="mh">0x0000400</span><span class="p">,</span> <span class="mh">0x0000002</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Note that we don&#39;t use CCCR1 here, there is an</span>
<span class="cm"> * exception for P4_BSQ_ALLOCATION but we just have</span>
<span class="cm"> * no workaround</span>
<span class="cm"> *</span>
<span class="cm"> * consider this binding as resources which particular</span>
<span class="cm"> * event may borrow, it doesn&#39;t contain EventMask,</span>
<span class="cm"> * Tags and friends -- they are left to a caller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="n">p4_event_bind_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_TC_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_TC_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">,</span> <span class="n">DD</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">,</span> <span class="n">DB</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">,</span> <span class="n">DI</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">,</span> <span class="n">BD</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">,</span> <span class="n">BB</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">,</span> <span class="n">BI</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_DELIVER_MODE</span><span class="p">,</span> <span class="n">ID</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_BPU_FETCH_REQUEST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_BPU_FETCH_REQUEST</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_BPU_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_BPU_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BPU_FETCH_REQUEST</span><span class="p">,</span> <span class="n">TCMISS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_ITLB_REFERENCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_ITLB_REFERENCE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_ITLB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_ITLB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_ITLB_REFERENCE</span><span class="p">,</span> <span class="n">HIT</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_ITLB_REFERENCE</span><span class="p">,</span> <span class="n">MISS</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_ITLB_REFERENCE</span><span class="p">,</span> <span class="n">HIT_UK</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_MEMORY_CANCEL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_MEMORY_CANCEL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_DAC_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_DAC_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MEMORY_CANCEL</span><span class="p">,</span> <span class="n">ST_RB_FULL</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MEMORY_CANCEL</span><span class="p">,</span> <span class="mi">64</span><span class="n">K_CONF</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_MEMORY_COMPLETE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_MEMORY_COMPLETE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_SAAT_ESCR0</span> <span class="p">,</span> <span class="n">MSR_P4_SAAT_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MEMORY_COMPLETE</span><span class="p">,</span> <span class="n">LSC</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MEMORY_COMPLETE</span><span class="p">,</span> <span class="n">SSC</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_LOAD_PORT_REPLAY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_LOAD_PORT_REPLAY</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_SAAT_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_SAAT_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_LOAD_PORT_REPLAY</span><span class="p">,</span> <span class="n">SPLIT_LD</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_STORE_PORT_REPLAY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_STORE_PORT_REPLAY</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_SAAT_ESCR0</span> <span class="p">,</span>  <span class="n">MSR_P4_SAAT_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_STORE_PORT_REPLAY</span><span class="p">,</span> <span class="n">SPLIT_ST</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_MOB_LOAD_REPLAY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_MOB_LOAD_REPLAY</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_MOB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_MOB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MOB_LOAD_REPLAY</span><span class="p">,</span> <span class="n">NO_STA</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MOB_LOAD_REPLAY</span><span class="p">,</span> <span class="n">NO_STD</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MOB_LOAD_REPLAY</span><span class="p">,</span> <span class="n">PARTIAL_DATA</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MOB_LOAD_REPLAY</span><span class="p">,</span> <span class="n">UNALGN_ADDR</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_PAGE_WALK_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_PAGE_WALK_TYPE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_PMH_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_PMH_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_PAGE_WALK_TYPE</span><span class="p">,</span> <span class="n">DTMISS</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_PAGE_WALK_TYPE</span><span class="p">,</span> <span class="n">ITMISS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_BSU_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_BSU_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_2ndL_HITS</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_2ndL_HITE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_2ndL_HITM</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_3rdL_HITS</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_3rdL_HITE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_3rdL_HITM</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_2ndL_MISS</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_3rdL_MISS</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">WR_2ndL_MISS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FSB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FSB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">DEFAULT</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">ALL_READ</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">ALL_WRITE</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">MEM_UC</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">MEM_WC</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">MEM_WT</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">MEM_WP</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">MEM_WB</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">OWN</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">OTHER</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ALLOCATION</span><span class="p">,</span> <span class="n">PREFETCH</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* shared ESCR */</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FSB_ESCR1</span><span class="p">,</span>  <span class="n">MSR_P4_FSB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">DEFAULT</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">ALL_READ</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">ALL_WRITE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">MEM_UC</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">MEM_WC</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">MEM_WT</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">MEM_WP</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">MEM_WB</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">OWN</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">OTHER</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_IOQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">PREFETCH</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FSB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FSB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">,</span> <span class="n">DRDY_DRV</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">,</span> <span class="n">DRDY_OWN</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">,</span> <span class="n">DRDY_OTHER</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">,</span> <span class="n">DBSY_DRV</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">,</span> <span class="n">DBSY_OWN</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">,</span> <span class="n">DBSY_OTHER</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>		<span class="cm">/* shared ESCR, broken CCCR1 */</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_BSU_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_BSU_ESCR0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_TYPE0</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_TYPE1</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_LEN0</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_LEN1</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_IO_TYPE</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_LOCK_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_CACHE_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_SPLIT_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_DEM_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">REQ_ORD_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">MEM_TYPE0</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">MEM_TYPE1</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ALLOCATION</span><span class="p">,</span> <span class="n">MEM_TYPE2</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* shared ESCR */</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_BSU_ESCR1</span> <span class="p">,</span> <span class="n">MSR_P4_BSU_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_TYPE0</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_TYPE1</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_LEN0</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_LEN1</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_IO_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_LOCK_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_CACHE_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_SPLIT_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_DEM_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">REQ_ORD_TYPE</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">MEM_TYPE0</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">MEM_TYPE1</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_ACTIVE_ENTRIES</span><span class="p">,</span> <span class="n">MEM_TYPE2</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_SSE_INPUT_ASSIST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_SSE_INPUT_ASSIST</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FIRM_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_SSE_INPUT_ASSIST</span><span class="p">,</span> <span class="n">ALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_PACKED_SP_UOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_PACKED_SP_UOP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FIRM_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_PACKED_SP_UOP</span><span class="p">,</span> <span class="n">ALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_PACKED_DP_UOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_PACKED_DP_UOP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FIRM_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_PACKED_DP_UOP</span><span class="p">,</span> <span class="n">ALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_SCALAR_SP_UOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_SCALAR_SP_UOP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FIRM_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_SCALAR_SP_UOP</span><span class="p">,</span> <span class="n">ALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_SCALAR_DP_UOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_SCALAR_DP_UOP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FIRM_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_SCALAR_DP_UOP</span><span class="p">,</span> <span class="n">ALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_64BIT_MMX_UOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_64BIT_MMX_UOP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FIRM_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_64BIT_MMX_UOP</span><span class="p">,</span> <span class="n">ALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_128BIT_MMX_UOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_128BIT_MMX_UOP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FIRM_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_128BIT_MMX_UOP</span><span class="p">,</span> <span class="n">ALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_X87_FP_UOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_X87_FP_UOP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FIRM_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_X87_FP_UOP</span><span class="p">,</span> <span class="n">ALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_TC_MISC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_TC_MISC</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_TC_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_TC_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_MISC</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_GLOBAL_POWER_EVENTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_GLOBAL_POWER_EVENTS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FSB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FSB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_GLOBAL_POWER_EVENTS</span><span class="p">,</span> <span class="n">RUNNING</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_TC_MS_XFER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_TC_MS_XFER</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_MS_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_MS_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_TC_MS_XFER</span><span class="p">,</span> <span class="n">CISC</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_UOP_QUEUE_WRITES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_UOP_QUEUE_WRITES</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_MS_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_MS_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_UOP_QUEUE_WRITES</span><span class="p">,</span> <span class="n">FROM_TC_BUILD</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_UOP_QUEUE_WRITES</span><span class="p">,</span> <span class="n">FROM_TC_DELIVER</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_UOP_QUEUE_WRITES</span><span class="p">,</span> <span class="n">FROM_ROM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_TBPU_ESCR0</span> <span class="p">,</span> <span class="n">MSR_P4_TBPU_ESCR0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">CONDITIONAL</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">CALL</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">RETURN</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">INDIRECT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_TBPU_ESCR0</span> <span class="p">,</span> <span class="n">MSR_P4_TBPU_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">CONDITIONAL</span><span class="p">)</span>	<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">CALL</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">RETURN</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">INDIRECT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_RESOURCE_STALL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_RESOURCE_STALL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_ALF_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_ALF_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RESOURCE_STALL</span><span class="p">,</span> <span class="n">SBFULL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_WC_BUFFER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_WC_BUFFER</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_DAC_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_DAC_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_WC_BUFFER</span><span class="p">,</span> <span class="n">WCB_EVICTS</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_WC_BUFFER</span><span class="p">,</span> <span class="n">WCB_FULL_EVICTS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">shared</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_B2B_CYCLES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_B2B_CYCLES</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FSB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FSB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_BNR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_BNR</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FSB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FSB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_SNOOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_SNOOP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FSB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FSB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_RESPONSE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_FSB_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_FSB_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_FRONT_END_EVENT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_FRONT_END_EVENT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR2</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR3</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FRONT_END_EVENT</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FRONT_END_EVENT</span><span class="p">,</span> <span class="n">BOGUS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR2</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR3</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">NBOGUS0</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">NBOGUS1</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">NBOGUS2</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">NBOGUS3</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">BOGUS0</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">BOGUS1</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">BOGUS2</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">BOGUS3</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_REPLAY_EVENT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_REPLAY_EVENT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR2</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR3</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_REPLAY_EVENT</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_REPLAY_EVENT</span><span class="p">,</span> <span class="n">BOGUS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">,</span> <span class="n">NBOGUSNTAG</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">,</span> <span class="n">NBOGUSTAG</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">,</span> <span class="n">BOGUSNTAG</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">,</span> <span class="n">BOGUSTAG</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_UOPS_RETIRED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_UOPS_RETIRED</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_UOPS_RETIRED</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_UOPS_RETIRED</span><span class="p">,</span> <span class="n">BOGUS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_UOP_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_UOP_TYPE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_RAT_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_RAT_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_UOP_TYPE</span><span class="p">,</span> <span class="n">TAGLOADS</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_UOP_TYPE</span><span class="p">,</span> <span class="n">TAGSTORES</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_BRANCH_RETIRED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_BRANCH_RETIRED</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR2</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR3</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BRANCH_RETIRED</span><span class="p">,</span> <span class="n">MMNP</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BRANCH_RETIRED</span><span class="p">,</span> <span class="n">MMNM</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BRANCH_RETIRED</span><span class="p">,</span> <span class="n">MMTP</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BRANCH_RETIRED</span><span class="p">,</span> <span class="n">MMTM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_MISPRED_BRANCH_RETIRED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_MISPRED_BRANCH_RETIRED</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MISPRED_BRANCH_RETIRED</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_X87_ASSIST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_X87_ASSIST</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR2</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR3</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_X87_ASSIST</span><span class="p">,</span> <span class="n">FPSU</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_X87_ASSIST</span><span class="p">,</span> <span class="n">FPSO</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_X87_ASSIST</span><span class="p">,</span> <span class="n">POAO</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_X87_ASSIST</span><span class="p">,</span> <span class="n">POAU</span><span class="p">)</span>			<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_X87_ASSIST</span><span class="p">,</span> <span class="n">PREA</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_MACHINE_CLEAR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_MACHINE_CLEAR</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR2</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR3</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MACHINE_CLEAR</span><span class="p">,</span> <span class="n">CLEAR</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MACHINE_CLEAR</span><span class="p">,</span> <span class="n">MOCLEAR</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MACHINE_CLEAR</span><span class="p">,</span> <span class="n">SMCLEAR</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">P4_EVENT_INSTR_COMPLETED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">opcode</span>		<span class="o">=</span> <span class="n">P4_OPCODE</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_COMPLETED</span><span class="p">),</span>
		<span class="p">.</span><span class="n">escr_msr</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">MSR_P4_CRU_ESCR0</span><span class="p">,</span> <span class="n">MSR_P4_CRU_ESCR1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">escr_emask</span>	<span class="o">=</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_COMPLETED</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">)</span>		<span class="o">|</span>
			<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_COMPLETED</span><span class="p">,</span> <span class="n">BOGUS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cntr</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span> <span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define P4_GEN_CACHE_EVENT(event, bit, metric)				  \</span>
<span class="cp">	p4_config_pack_escr(P4_ESCR_EVENT(event)			| \</span>
<span class="cp">			    P4_ESCR_EMASK_BIT(event, bit))		| \</span>
<span class="cp">	p4_config_pack_cccr(metric					| \</span>
<span class="cp">			    P4_CCCR_ESEL(P4_OPCODE_ESEL(P4_OPCODE(event))))</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">p4_hw_cache_event_ids</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1D</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">P4_GEN_CACHE_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_REPLAY_EVENT</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">,</span>
						<span class="n">P4_PEBS_METRIC__1stl_cache_load_miss_retired</span><span class="p">),</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">LL</span>  <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">P4_GEN_CACHE_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_REPLAY_EVENT</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">,</span>
						<span class="n">P4_PEBS_METRIC__2ndl_cache_load_miss_retired</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">P4_GEN_CACHE_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_REPLAY_EVENT</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">,</span>
						<span class="n">P4_PEBS_METRIC__dtlb_load_miss_retired</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">P4_GEN_CACHE_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_REPLAY_EVENT</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">,</span>
						<span class="n">P4_PEBS_METRIC__dtlb_store_miss_retired</span><span class="p">),</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">P4_GEN_CACHE_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_ITLB_REFERENCE</span><span class="p">,</span> <span class="n">HIT</span><span class="p">,</span>
						<span class="n">P4_PEBS_METRIC__none</span><span class="p">),</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">P4_GEN_CACHE_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_ITLB_REFERENCE</span><span class="p">,</span> <span class="n">MISS</span><span class="p">,</span>
						<span class="n">P4_PEBS_METRIC__none</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Because of Netburst being quite restricted in how many</span>
<span class="cm"> * identical events may run simultaneously, we introduce event aliases,</span>
<span class="cm"> * ie the different events which have the same functionality but</span>
<span class="cm"> * utilize non-intersected resources (ESCR/CCCR/counter registers).</span>
<span class="cm"> *</span>
<span class="cm"> * This allow us to relax restrictions a bit and run two or more</span>
<span class="cm"> * identical events together.</span>
<span class="cm"> *</span>
<span class="cm"> * Never set any custom internal bits such as P4_CONFIG_HT,</span>
<span class="cm"> * P4_CONFIG_ALIASABLE or bits for P4_PEBS_METRIC, they are</span>
<span class="cm"> * either up to date automatically or not applicable at all.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">p4_event_alias</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">original</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">alternative</span><span class="p">;</span>
<span class="p">}</span> <span class="n">p4_event_aliases</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Non-halted cycles can be substituted with non-sleeping cycles (see</span>
<span class="cm">		 * Intel SDM Vol3b for details). We need this alias to be able</span>
<span class="cm">		 * to run nmi-watchdog and &#39;perf top&#39; (or any other user space tool</span>
<span class="cm">		 * which is interested in running PERF_COUNT_HW_CPU_CYCLES)</span>
<span class="cm">		 * simultaneously.</span>
<span class="cm">		 */</span>
	<span class="p">.</span><span class="n">original</span>	<span class="o">=</span>
		<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_GLOBAL_POWER_EVENTS</span><span class="p">)</span>		<span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_GLOBAL_POWER_EVENTS</span><span class="p">,</span> <span class="n">RUNNING</span><span class="p">)),</span>
	<span class="p">.</span><span class="n">alternative</span>	<span class="o">=</span>
		<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">)</span>		<span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">NBOGUS0</span><span class="p">)</span><span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">NBOGUS1</span><span class="p">)</span><span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">NBOGUS2</span><span class="p">)</span><span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">NBOGUS3</span><span class="p">)</span><span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">BOGUS0</span><span class="p">)</span>	<span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">BOGUS1</span><span class="p">)</span>	<span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">BOGUS2</span><span class="p">)</span>	<span class="o">|</span>
				    <span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_EXECUTION_EVENT</span><span class="p">,</span> <span class="n">BOGUS3</span><span class="p">))</span><span class="o">|</span>
		<span class="n">p4_config_pack_cccr</span><span class="p">(</span><span class="n">P4_CCCR_THRESHOLD</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">P4_CCCR_COMPLEMENT</span>		<span class="o">|</span>
				    <span class="n">P4_CCCR_COMPARE</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">p4_get_alias_event</span><span class="p">(</span><span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">config_match</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only event with special mark is allowed,</span>
<span class="cm">	 * we&#39;re to be sure it didn&#39;t come as malformed</span>
<span class="cm">	 * RAW event.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">P4_CONFIG_ALIASABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">config_match</span> <span class="o">=</span> <span class="n">config</span> <span class="o">&amp;</span> <span class="n">P4_CONFIG_EVENT_ALIAS_MASK</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p4_event_aliases</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config_match</span> <span class="o">==</span> <span class="n">p4_event_aliases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">original</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config_match</span> <span class="o">=</span> <span class="n">p4_event_aliases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">alternative</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">config_match</span> <span class="o">==</span> <span class="n">p4_event_aliases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">alternative</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config_match</span> <span class="o">=</span> <span class="n">p4_event_aliases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">original</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p4_event_aliases</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">config_match</span> <span class="o">|</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">P4_CONFIG_EVENT_ALIAS_IMMUTABLE_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">p4_general_events</span><span class="p">[</span><span class="n">PERF_COUNT_HW_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="cm">/* non-halted CPU clocks */</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_GLOBAL_POWER_EVENTS</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_GLOBAL_POWER_EVENTS</span><span class="p">,</span> <span class="n">RUNNING</span><span class="p">))</span>	<span class="o">|</span>
		<span class="n">P4_CONFIG_ALIASABLE</span><span class="p">,</span>

  <span class="cm">/*</span>
<span class="cm">   * retired instructions</span>
<span class="cm">   * in a sake of simplicity we don&#39;t use the FSB tagging</span>
<span class="cm">   */</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">,</span> <span class="n">NBOGUSNTAG</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_INSTR_RETIRED</span><span class="p">,</span> <span class="n">BOGUSNTAG</span><span class="p">)),</span>

  <span class="cm">/* cache hits */</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_2ndL_HITS</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_2ndL_HITE</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_2ndL_HITM</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_3rdL_HITS</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_3rdL_HITE</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_3rdL_HITM</span><span class="p">)),</span>

  <span class="cm">/* cache misses */</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_2ndL_MISS</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">RD_3rdL_MISS</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_BSQ_CACHE_REFERENCE</span><span class="p">,</span> <span class="n">WR_2ndL_MISS</span><span class="p">)),</span>

  <span class="cm">/* branch instructions retired */</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">CONDITIONAL</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">CALL</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">RETURN</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_RETIRED_BRANCH_TYPE</span><span class="p">,</span> <span class="n">INDIRECT</span><span class="p">)),</span>

  <span class="cm">/* mispredicted branches retired */</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">]</span>	<span class="o">=</span>
	<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_MISPRED_BRANCH_RETIRED</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_MISPRED_BRANCH_RETIRED</span><span class="p">,</span> <span class="n">NBOGUS</span><span class="p">)),</span>

  <span class="cm">/* bus ready clocks (cpu is driving #DRDY_DRV\#DRDY_OWN):  */</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BUS_CYCLES</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">,</span> <span class="n">DRDY_DRV</span><span class="p">)</span>		<span class="o">|</span>
		<span class="n">P4_ESCR_EMASK_BIT</span><span class="p">(</span><span class="n">P4_EVENT_FSB_DATA_ACTIVITY</span><span class="p">,</span> <span class="n">DRDY_OWN</span><span class="p">))</span>	<span class="o">|</span>
	<span class="n">p4_config_pack_cccr</span><span class="p">(</span><span class="n">P4_CCCR_EDGE</span> <span class="o">|</span> <span class="n">P4_CCCR_COMPARE</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="o">*</span><span class="nf">p4_config_get_bind</span><span class="p">(</span><span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">evnt</span> <span class="o">=</span> <span class="n">p4_config_unpack_event</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="o">*</span><span class="n">bind</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evnt</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p4_event_bind_map</span><span class="p">))</span>
		<span class="n">bind</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p4_event_bind_map</span><span class="p">[</span><span class="n">evnt</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">bind</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">p4_pmu_event_map</span><span class="p">(</span><span class="kt">int</span> <span class="n">hw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="o">*</span><span class="n">bind</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">esel</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">config</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">p4_general_events</span><span class="p">[</span><span class="n">hw_event</span><span class="p">];</span>
	<span class="n">bind</span> <span class="o">=</span> <span class="n">p4_config_get_bind</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="n">esel</span> <span class="o">=</span> <span class="n">P4_OPCODE_ESEL</span><span class="p">(</span><span class="n">bind</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
	<span class="n">config</span> <span class="o">|=</span> <span class="n">p4_config_pack_cccr</span><span class="p">(</span><span class="n">P4_CCCR_ESEL</span><span class="p">(</span><span class="n">esel</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">config</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check cpu model specifics */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">p4_event_match_cpu_model</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* INSTR_COMPLETED event only exist for model 3, 4, 6 (Prescott) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_idx</span> <span class="o">==</span> <span class="n">P4_EVENT_INSTR_COMPLETED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
			<span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
			<span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For info</span>
<span class="cm">	 * - IQ_ESCR0, IQ_ESCR1 only for models 1 and 2</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p4_validate_raw_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">emask</span><span class="p">;</span>

	<span class="cm">/* User data may have out-of-bound event index */</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">p4_config_unpack_event</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p4_event_bind_map</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* It may be unsupported: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p4_event_match_cpu_model</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: P4_CCCR_THREAD_ANY has not the same meaning as</span>
<span class="cm">	 * in Architectural Performance Monitoring, it means not</span>
<span class="cm">	 * on _which_ logical cpu to count but rather _when_, ie it</span>
<span class="cm">	 * depends on logical cpu state -- count event if one cpu active,</span>
<span class="cm">	 * none, both or any, so we just allow user to pass any value</span>
<span class="cm">	 * desired.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In turn we always set Tx_OS/Tx_USR bits bound to logical</span>
<span class="cm">	 * cpu without their propagation to another cpu</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * if an event is shared across the logical threads</span>
<span class="cm">	 * the user needs special permissions to be able to use it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p4_ht_active</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">p4_event_bind_map</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">shared</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_paranoid_cpu</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ESCR EventMask bits may be invalid */</span>
	<span class="n">emask</span> <span class="o">=</span> <span class="n">p4_config_unpack_escr</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">P4_ESCR_EVENTMASK_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">p4_event_bind_map</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">escr_emask</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * it may have some invalid PEBS bits</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p4_config_pebs_has</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="n">P4_PEBS_CONFIG_ENABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">p4_config_unpack_metric</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p4_pebs_bind_map</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p4_hw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">escr</span><span class="p">,</span> <span class="n">cccr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * the reason we use cpu that early is that: if we get scheduled</span>
<span class="cm">	 * first time on the same cpu -- we will not need swap thread</span>
<span class="cm">	 * specific flags in config (and will save some cpu cycles)</span>
<span class="cm">	 */</span>

	<span class="n">cccr</span> <span class="o">=</span> <span class="n">p4_default_cccr_conf</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">escr</span> <span class="o">=</span> <span class="n">p4_default_escr_conf</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_kernel</span><span class="p">,</span>
					 <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_user</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">escr</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">p4_config_pack_cccr</span><span class="p">(</span><span class="n">cccr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p4_ht_active</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">p4_ht_thread</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">p4_set_ht_bit</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PERF_TYPE_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="o">*</span><span class="n">bind</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">esel</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clear bits we reserve to be managed by kernel itself</span>
<span class="cm">		 * and never allowed from a user space</span>
<span class="cm">		 */</span>
		 <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="n">P4_CONFIG_MASK</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">p4_validate_raw_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Note that for RAW events we allow user to use P4_CCCR_RESERVED</span>
<span class="cm">		 * bits since we keep additional info here (for cache events and etc)</span>
<span class="cm">		 */</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
		<span class="n">bind</span> <span class="o">=</span> <span class="n">p4_config_get_bind</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bind</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">esel</span> <span class="o">=</span> <span class="n">P4_OPCODE_ESEL</span><span class="p">(</span><span class="n">bind</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="n">p4_config_pack_cccr</span><span class="p">(</span><span class="n">P4_CCCR_ESEL</span><span class="p">(</span><span class="n">esel</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">x86_setup_perfctr</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">put_cpu</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">p4_pmu_clear_cccr_ovf</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">v</span><span class="p">;</span>

	<span class="cm">/* an official way for overflow indication */</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">P4_CCCR_OVF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">P4_CCCR_OVF</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In some circumstances the overflow might issue an NMI but did</span>
<span class="cm">	 * not set P4_CCCR_OVF bit. Because a counter holds a negative value</span>
<span class="cm">	 * we simply check for high bit being set, if it&#39;s cleared it means</span>
<span class="cm">	 * the counter has reached zero value and continued counting before</span>
<span class="cm">	 * real NMI signal was received:</span>
<span class="cm">	 */</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">event_base</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">ARCH_P4_UNFLAGGED_BIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p4_pmu_disable_pebs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * It&#39;s still allowed that two threads setup same cache</span>
<span class="cm">	 * events so we can&#39;t simply clear metrics until we knew</span>
<span class="cm">	 * no one is depending on us, so we need kind of counter</span>
<span class="cm">	 * for &quot;ReplayEvent&quot; users.</span>
<span class="cm">	 *</span>
<span class="cm">	 * What is more complex -- RAW events, if user (for some</span>
<span class="cm">	 * reason) will pass some cache event metric with improper</span>
<span class="cm">	 * event opcode -- it&#39;s fine from hardware point of view</span>
<span class="cm">	 * but completely nonsense from &quot;meaning&quot; of such action.</span>
<span class="cm">	 *</span>
<span class="cm">	 * So at moment let leave metrics turned on forever -- it&#39;s</span>
<span class="cm">	 * ok for now but need to be revisited!</span>
<span class="cm">	 *</span>
<span class="cm">	 * (void)checking_wrmsrl(MSR_IA32_PEBS_ENABLE, (u64)0);</span>
<span class="cm">	 * (void)checking_wrmsrl(MSR_P4_PEBS_MATRIX_VERT, (u64)0);</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">p4_pmu_disable_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If event gets disabled while counter is in overflowed</span>
<span class="cm">	 * state we need to clear P4_CCCR_OVF, otherwise interrupt get</span>
<span class="cm">	 * asserted again and again</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">p4_config_unpack_cccr</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">P4_CCCR_ENABLE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">P4_CCCR_OVF</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">P4_CCCR_RESERVED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p4_pmu_disable_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">active_mask</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">p4_pmu_disable_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p4_pmu_disable_pebs</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* configuration must be valid */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">p4_pmu_enable_pebs</span><span class="p">(</span><span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p4_pebs_bind</span> <span class="o">*</span><span class="n">bind</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">P4_PEBS_METRIC__max</span> <span class="o">&gt;</span> <span class="n">P4_PEBS_CONFIG_METRIC_MASK</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">p4_config_unpack_metric</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">P4_PEBS_METRIC__none</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bind</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p4_pebs_bind_map</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">MSR_IA32_PEBS_ENABLE</span><span class="p">,</span>	<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bind</span><span class="o">-&gt;</span><span class="n">metric_pebs</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">MSR_P4_PEBS_MATRIX_VERT</span><span class="p">,</span>	<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bind</span><span class="o">-&gt;</span><span class="n">metric_vert</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p4_pmu_enable_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">p4_ht_config_thread</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">escr_conf</span> <span class="o">=</span> <span class="n">p4_config_unpack_escr</span><span class="p">(</span><span class="n">p4_clear_ht_bit</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">p4_config_unpack_event</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="o">*</span><span class="n">bind</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">escr_addr</span><span class="p">,</span> <span class="n">cccr</span><span class="p">;</span>

	<span class="n">bind</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p4_event_bind_map</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">escr_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bind</span><span class="o">-&gt;</span><span class="n">escr_msr</span><span class="p">[</span><span class="kr">thread</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * - we dont support cascaded counters yet</span>
<span class="cm">	 * - and counter 1 is broken (erratum)</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">p4_is_event_cascaded</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">));</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* we need a real Event value */</span>
	<span class="n">escr_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">P4_ESCR_EVENT_MASK</span><span class="p">;</span>
	<span class="n">escr_conf</span> <span class="o">|=</span> <span class="n">P4_ESCR_EVENT</span><span class="p">(</span><span class="n">P4_OPCODE_EVNT</span><span class="p">(</span><span class="n">bind</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">));</span>

	<span class="n">cccr</span> <span class="o">=</span> <span class="n">p4_config_unpack_cccr</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * it could be Cache event so we need to write metrics</span>
<span class="cm">	 * into additional MSRs</span>
<span class="cm">	 */</span>
	<span class="n">p4_pmu_enable_pebs</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">escr_addr</span><span class="p">,</span> <span class="n">escr_conf</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span>
				<span class="p">(</span><span class="n">cccr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">P4_CCCR_RESERVED</span><span class="p">)</span> <span class="o">|</span> <span class="n">P4_CCCR_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p4_pmu_enable_all</span><span class="p">(</span><span class="kt">int</span> <span class="n">added</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">active_mask</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">p4_pmu_enable_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p4_pmu_handle_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_sample_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">overflow</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">active_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* catch in-flight IRQs */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_clear_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span>
				<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">event</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">);</span>

		<span class="cm">/* it might be unflagged overflow */</span>
		<span class="n">overflow</span> <span class="o">=</span> <span class="n">p4_pmu_clear_cccr_ovf</span><span class="p">(</span><span class="n">hwc</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">x86_perf_event_update</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overflow</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">cntval_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">+=</span> <span class="n">overflow</span><span class="p">;</span>

		<span class="cm">/* event overflow for sure */</span>
		<span class="n">perf_sample_data_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">last_period</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x86_perf_event_set_period</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">perf_event_overflow</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span><span class="p">))</span>
			<span class="n">x86_pmu_stop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handled</span><span class="p">)</span>
		<span class="n">inc_irq_stat</span><span class="p">(</span><span class="n">apic_perf_irqs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * When dealing with the unmasking of the LVTPC on P4 perf hw, it has</span>
<span class="cm">	 * been observed that the OVF bit flag has to be cleared first _before_</span>
<span class="cm">	 * the LVTPC can be unmasked.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The reason is the NMI line will continue to be asserted while the OVF</span>
<span class="cm">	 * bit is set.  This causes a second NMI to generate if the LVTPC is</span>
<span class="cm">	 * unmasked before the OVF bit is cleared, leading to unknown NMI</span>
<span class="cm">	 * messages.</span>
<span class="cm">	 */</span>
	<span class="n">apic_write</span><span class="p">(</span><span class="n">APIC_LVTPC</span><span class="p">,</span> <span class="n">APIC_DM_NMI</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * swap thread specific fields according to a thread</span>
<span class="cm"> * we are going to run on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">p4_pmu_swap_config_ts</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">escr</span><span class="p">,</span> <span class="n">cccr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we either lucky and continue on same cpu or no HT support</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p4_should_swap_ts</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">cpu</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * the event is migrated from an another logical</span>
<span class="cm">	 * cpu, so we need to swap thread specific flags</span>
<span class="cm">	 */</span>

	<span class="n">escr</span> <span class="o">=</span> <span class="n">p4_config_unpack_escr</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">cccr</span> <span class="o">=</span> <span class="n">p4_config_unpack_cccr</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p4_ht_thread</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">P4_CCCR_OVF_PMI_T0</span><span class="p">;</span>
		<span class="n">cccr</span> <span class="o">|=</span> <span class="n">P4_CCCR_OVF_PMI_T1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">escr</span> <span class="o">&amp;</span> <span class="n">P4_ESCR_T0_OS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">escr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">P4_ESCR_T0_OS</span><span class="p">;</span>
			<span class="n">escr</span> <span class="o">|=</span> <span class="n">P4_ESCR_T1_OS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">escr</span> <span class="o">&amp;</span> <span class="n">P4_ESCR_T0_USR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">escr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">P4_ESCR_T0_USR</span><span class="p">;</span>
			<span class="n">escr</span> <span class="o">|=</span> <span class="n">P4_ESCR_T1_USR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span>  <span class="o">=</span> <span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">escr</span><span class="p">);</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">p4_config_pack_cccr</span><span class="p">(</span><span class="n">cccr</span><span class="p">);</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">P4_CONFIG_HT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">P4_CCCR_OVF_PMI_T1</span><span class="p">;</span>
		<span class="n">cccr</span> <span class="o">|=</span> <span class="n">P4_CCCR_OVF_PMI_T0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">escr</span> <span class="o">&amp;</span> <span class="n">P4_ESCR_T1_OS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">escr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">P4_ESCR_T1_OS</span><span class="p">;</span>
			<span class="n">escr</span> <span class="o">|=</span> <span class="n">P4_ESCR_T0_OS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">escr</span> <span class="o">&amp;</span> <span class="n">P4_ESCR_T1_USR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">escr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">P4_ESCR_T1_USR</span><span class="p">;</span>
			<span class="n">escr</span> <span class="o">|=</span> <span class="n">P4_ESCR_T0_USR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span>  <span class="o">=</span> <span class="n">p4_config_pack_escr</span><span class="p">(</span><span class="n">escr</span><span class="p">);</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">p4_config_pack_cccr</span><span class="p">(</span><span class="n">cccr</span><span class="p">);</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">P4_CONFIG_HT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ESCR address hashing is tricky, ESCRs are not sequential</span>
<span class="cm"> * in memory but all starts from MSR_P4_BSU_ESCR0 (0x03a0) and</span>
<span class="cm"> * the metric between any ESCRs is laid in range [0xa0,0xe1]</span>
<span class="cm"> *</span>
<span class="cm"> * so we make ~70% filled hashtable</span>
<span class="cm"> */</span>

<span class="cp">#define P4_ESCR_MSR_BASE		0x000003a0</span>
<span class="cp">#define P4_ESCR_MSR_MAX			0x000003e1</span>
<span class="cp">#define P4_ESCR_MSR_TABLE_SIZE		(P4_ESCR_MSR_MAX - P4_ESCR_MSR_BASE + 1)</span>
<span class="cp">#define P4_ESCR_MSR_IDX(msr)		(msr - P4_ESCR_MSR_BASE)</span>
<span class="cp">#define P4_ESCR_MSR_TABLE_ENTRY(msr)	[P4_ESCR_MSR_IDX(msr)] = msr</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p4_escr_table</span><span class="p">[</span><span class="n">P4_ESCR_MSR_TABLE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_ALF_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_ALF_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_BPU_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_BPU_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_BSU_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_BSU_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_CRU_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_CRU_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_CRU_ESCR2</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_CRU_ESCR3</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_CRU_ESCR4</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_CRU_ESCR5</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_DAC_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_DAC_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_FIRM_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_FIRM_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_FLAME_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_FLAME_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_FSB_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_FSB_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_IQ_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_IQ_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_IS_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_IS_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_ITLB_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_ITLB_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_IX_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_IX_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_MOB_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_MOB_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_MS_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_MS_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_PMH_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_PMH_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_RAT_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_RAT_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_SAAT_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_SAAT_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_SSU_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_SSU_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_TBPU_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_TBPU_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_TC_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_TC_ESCR1</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_U2L_ESCR0</span><span class="p">),</span>
	<span class="n">P4_ESCR_MSR_TABLE_ENTRY</span><span class="p">(</span><span class="n">MSR_P4_U2L_ESCR1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p4_get_escr_idx</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">P4_ESCR_MSR_IDX</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">P4_ESCR_MSR_TABLE_SIZE</span>	<span class="o">||</span>
			<span class="o">!</span><span class="n">p4_escr_table</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>		<span class="o">||</span>
			<span class="n">p4_escr_table</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;P4 PMU: Wrong address passed: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p4_next_cntr</span><span class="p">(</span><span class="kt">int</span> <span class="kr">thread</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">used_mask</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="o">*</span><span class="n">bind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">P4_CNTR_LIMIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">bind</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">[</span><span class="kr">thread</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">used_mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p4_pmu_schedule_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">assign</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">used_mask</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">X86_PMC_IDX_MAX</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">escr_mask</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">P4_ESCR_MSR_TABLE_SIZE</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p4_event_bind</span> <span class="o">*</span><span class="n">bind</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cntr_idx</span><span class="p">,</span> <span class="n">escr_idx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">config_alias</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pass</span><span class="p">;</span>

	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">used_mask</span><span class="p">,</span> <span class="n">X86_PMC_IDX_MAX</span><span class="p">);</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">escr_mask</span><span class="p">,</span> <span class="n">P4_ESCR_MSR_TABLE_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
		<span class="kr">thread</span> <span class="o">=</span> <span class="n">p4_ht_thread</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">pass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">again:</span>
		<span class="cm">/*</span>
<span class="cm">		 * It&#39;s possible to hit a circular lock</span>
<span class="cm">		 * between original and alternative events</span>
<span class="cm">		 * if both are scheduled already.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">bind</span> <span class="o">=</span> <span class="n">p4_config_get_bind</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
		<span class="n">escr_idx</span> <span class="o">=</span> <span class="n">p4_get_escr_idx</span><span class="p">(</span><span class="n">bind</span><span class="o">-&gt;</span><span class="n">escr_msr</span><span class="p">[</span><span class="kr">thread</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">escr_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">p4_should_swap_ts</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cntr_idx</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">assign</span><span class="p">)</span>
				<span class="n">assign</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reserve</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cntr_idx</span> <span class="o">=</span> <span class="n">p4_next_cntr</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">used_mask</span><span class="p">,</span> <span class="n">bind</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cntr_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">escr_idx</span><span class="p">,</span> <span class="n">escr_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Check whether an event alias is still available.</span>
<span class="cm">			 */</span>
			<span class="n">config_alias</span> <span class="o">=</span> <span class="n">p4_get_alias_event</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config_alias</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config_alias</span><span class="p">;</span>
			<span class="n">pass</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p4_pmu_swap_config_ts</span><span class="p">(</span><span class="n">hwc</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">assign</span><span class="p">)</span>
			<span class="n">assign</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cntr_idx</span><span class="p">;</span>
<span class="nl">reserve:</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">cntr_idx</span><span class="p">,</span> <span class="n">used_mask</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">escr_idx</span><span class="p">,</span> <span class="n">escr_mask</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">num</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">cccr</span><span class="p">,</span> <span class="s">&quot;config:0-31&quot;</span> <span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">escr</span><span class="p">,</span> <span class="s">&quot;config:32-62&quot;</span><span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span>   <span class="s">&quot;config:63&quot;</span>   <span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">intel_p4_formats_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">format_attr_cccr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_escr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_ht</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_pmu</span> <span class="n">p4_pmu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Netburst P4/Xeon&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>		<span class="o">=</span> <span class="n">p4_pmu_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_all</span>		<span class="o">=</span> <span class="n">p4_pmu_disable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_all</span>		<span class="o">=</span> <span class="n">p4_pmu_enable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>			<span class="o">=</span> <span class="n">p4_pmu_enable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>		<span class="o">=</span> <span class="n">p4_pmu_disable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eventsel</span>		<span class="o">=</span> <span class="n">MSR_P4_BPU_CCCR0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">perfctr</span>		<span class="o">=</span> <span class="n">MSR_P4_BPU_PERFCTR0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_map</span>		<span class="o">=</span> <span class="n">p4_pmu_event_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_events</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p4_general_events</span><span class="p">),</span>
	<span class="p">.</span><span class="n">get_event_constraints</span>	<span class="o">=</span> <span class="n">x86_get_event_constraints</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * IF HT disabled we may need to use all</span>
<span class="cm">	 * ARCH_P4_MAX_CCCR counters simulaneously</span>
<span class="cm">	 * though leave it restricted at moment assuming</span>
<span class="cm">	 * HT is on</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">num_counters</span>		<span class="o">=</span> <span class="n">ARCH_P4_MAX_CCCR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">apic</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cntval_bits</span>		<span class="o">=</span> <span class="n">ARCH_P4_CNTRVAL_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cntval_mask</span>		<span class="o">=</span> <span class="n">ARCH_P4_CNTRVAL_MASK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_period</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ARCH_P4_CNTRVAL_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_config</span>		<span class="o">=</span> <span class="n">p4_hw_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">schedule_events</span>	<span class="o">=</span> <span class="n">p4_pmu_schedule_events</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * This handles erratum N15 in intel doc 249199-029,</span>
<span class="cm">	 * the counter may not be updated correctly on write</span>
<span class="cm">	 * so we need a second write operation to do the trick</span>
<span class="cm">	 * (the official workaround didn&#39;t work)</span>
<span class="cm">	 *</span>
<span class="cm">	 * the former idea is taken from OProfile code</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">perfctr_second_write</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">format_attrs</span>		<span class="o">=</span> <span class="n">intel_p4_formats_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">__init</span> <span class="kt">int</span> <span class="nf">p4_pmu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>

	<span class="cm">/* If we get stripped -- indexing fails */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARCH_P4_MAX_CCCR</span> <span class="o">&gt;</span> <span class="n">X86_PMC_MAX_GENERIC</span><span class="p">);</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IA32_MISC_ENABLE</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">low</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;unsupported Netburst CPU model %d &quot;</span><span class="p">,</span>
			<span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">,</span> <span class="n">p4_hw_cache_event_ids</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">));</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Netburst events, &quot;</span><span class="p">);</span>

	<span class="n">x86_pmu</span> <span class="o">=</span> <span class="n">p4_pmu</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
