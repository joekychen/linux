<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › cpu › perf_event_p6.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>perf_event_p6.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/perf_event.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &quot;perf_event.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Not sure about some of these</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">p6_perfmon_event_map</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0079</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x00c0</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x0f2e</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x012e</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x00c4</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x00c5</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BUS_CYCLES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0062</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">p6_pmu_event_map</span><span class="p">(</span><span class="kt">int</span> <span class="n">hw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">p6_perfmon_event_map</span><span class="p">[</span><span class="n">hw_event</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Event setting that is specified not to count anything.</span>
<span class="cm"> * We use this to effectively disable a counter.</span>
<span class="cm"> *</span>
<span class="cm"> * L2_RQSTS with 0 MESI unit mask.</span>
<span class="cm"> */</span>
<span class="cp">#define P6_NOP_EVENT			0x0000002EULL</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">p6_event_constraints</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span>	<span class="cm">/* FLOPS */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span>	<span class="cm">/* FP_COMP_OPS_EXE */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span>	<span class="cm">/* FP_ASSIST */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span>	<span class="cm">/* MUL */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span>	<span class="cm">/* DIV */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span>	<span class="cm">/* CYCLES_DIV_BUSY */</span>
	<span class="n">EVENT_CONSTRAINT_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p6_pmu_disable_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* p6 only has one enable register */</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_P6_EVNTSEL0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_P6_EVNTSEL0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p6_pmu_enable_all</span><span class="p">(</span><span class="kt">int</span> <span class="n">added</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* p6 only has one enable register */</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_P6_EVNTSEL0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_P6_EVNTSEL0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">p6_pmu_disable_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">P6_NOP_EVENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p6_pmu_enable_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">event</span><span class="p">,</span>	<span class="s">&quot;config:0-7&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">umask</span><span class="p">,</span>	<span class="s">&quot;config:8-15&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span>	<span class="s">&quot;config:18&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span>	<span class="s">&quot;config:19&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span>	<span class="s">&quot;config:23&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">cmask</span><span class="p">,</span>	<span class="s">&quot;config:24-31&quot;</span>	<span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">intel_p6_formats_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">format_attr_event</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_umask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_edge</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_pc</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_inv</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_cmask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_pmu</span> <span class="n">p6_pmu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;p6&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>		<span class="o">=</span> <span class="n">x86_pmu_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_all</span>		<span class="o">=</span> <span class="n">p6_pmu_disable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_all</span>		<span class="o">=</span> <span class="n">p6_pmu_enable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>			<span class="o">=</span> <span class="n">p6_pmu_enable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>		<span class="o">=</span> <span class="n">p6_pmu_disable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_config</span>		<span class="o">=</span> <span class="n">x86_pmu_hw_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">schedule_events</span>	<span class="o">=</span> <span class="n">x86_schedule_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eventsel</span>		<span class="o">=</span> <span class="n">MSR_P6_EVNTSEL0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">perfctr</span>		<span class="o">=</span> <span class="n">MSR_P6_PERFCTR0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_map</span>		<span class="o">=</span> <span class="n">p6_pmu_event_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_events</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p6_perfmon_event_map</span><span class="p">),</span>
	<span class="p">.</span><span class="n">apic</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_period</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_counters</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * Events have 40 bits implemented. However they are designed such</span>
<span class="cm">	 * that bits [32-39] are sign extensions of bit 31. As such the</span>
<span class="cm">	 * effective width of a event for P6-like PMU is 32 bits only.</span>
<span class="cm">	 *</span>
<span class="cm">	 * See IA-32 Intel Architecture Software developer manual Vol 3B</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">cntval_bits</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cntval_mask</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_event_constraints</span>	<span class="o">=</span> <span class="n">x86_get_event_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_constraints</span>	<span class="o">=</span> <span class="n">p6_event_constraints</span><span class="p">,</span>

	<span class="p">.</span><span class="n">format_attrs</span>		<span class="o">=</span> <span class="n">intel_p6_formats_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">__init</span> <span class="kt">int</span> <span class="nf">p6_pmu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">3</span>:  <span class="cm">/* Pentium Pro */</span>
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">6</span>:  <span class="cm">/* Pentium II */</span>
	<span class="k">case</span> <span class="mi">7</span>:
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* Pentium III */</span>
	<span class="k">case</span> <span class="mi">9</span>:
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="cm">/* Pentium M */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;unsupported p6 CPU model %d &quot;</span><span class="p">,</span>
			<span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x86_pmu</span> <span class="o">=</span> <span class="n">p6_pmu</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
