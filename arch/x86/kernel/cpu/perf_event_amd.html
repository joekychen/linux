<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › cpu › perf_event_amd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>perf_event_amd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/perf_event.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/apicdef.h&gt;</span>

<span class="cp">#include &quot;perf_event.h&quot;</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">amd_hw_cache_event_ids</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="cm">/* Data Cache Accesses        */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0141</span><span class="p">,</span> <span class="cm">/* Data Cache Misses          */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0142</span><span class="p">,</span> <span class="cm">/* Data Cache Refills :system */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0267</span><span class="p">,</span> <span class="cm">/* Data Prefetcher :attempts  */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0167</span><span class="p">,</span> <span class="cm">/* Data Prefetcher :cancelled */</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1I</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span> <span class="cm">/* Instruction cache fetches  */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0081</span><span class="p">,</span> <span class="cm">/* Instruction cache misses   */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x014B</span><span class="p">,</span> <span class="cm">/* Prefetch Instructions :Load */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">LL</span>  <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x037D</span><span class="p">,</span> <span class="cm">/* Requests to L2 Cache :IC+DC */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x037E</span><span class="p">,</span> <span class="cm">/* L2 Cache Misses : IC+DC     */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x017F</span><span class="p">,</span> <span class="cm">/* L2 Fill/Writeback           */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="cm">/* Data Cache Accesses        */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0746</span><span class="p">,</span> <span class="cm">/* L1_DTLB_AND_L2_DLTB_MISS.ALL */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span> <span class="cm">/* Instruction fecthes        */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0385</span><span class="p">,</span> <span class="cm">/* L1_ITLB_AND_L2_ITLB_MISS.ALL */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">BPU</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c2</span><span class="p">,</span> <span class="cm">/* Retired Branch Instr.      */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c3</span><span class="p">,</span> <span class="cm">/* Retired Mispredicted BI    */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0xb8e9</span><span class="p">,</span> <span class="cm">/* CPU Request to Memory, l+r */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x98e9</span><span class="p">,</span> <span class="cm">/* CPU Request to Memory, r   */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * AMD Performance Monitor K7 and later.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">amd_perfmon_event_map</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span>			<span class="o">=</span> <span class="mh">0x0076</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span>			<span class="o">=</span> <span class="mh">0x00c0</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">]</span>			<span class="o">=</span> <span class="mh">0x0081</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x00c2</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">]</span>			<span class="o">=</span> <span class="mh">0x00c3</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_STALLED_CYCLES_FRONTEND</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x00d0</span><span class="p">,</span> <span class="cm">/* &quot;Decoder empty&quot; event */</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_STALLED_CYCLES_BACKEND</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x00d1</span><span class="p">,</span> <span class="cm">/* &quot;Dispatch stalls&quot; event */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">amd_pmu_event_map</span><span class="p">(</span><span class="kt">int</span> <span class="n">hw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">amd_perfmon_event_map</span><span class="p">[</span><span class="n">hw_event</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd_pmu_hw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* pass precise event sampling to ibs: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">precise_ip</span> <span class="o">&amp;&amp;</span> <span class="n">get_ibs_caps</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">x86_pmu_hw_config</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_branch_stack</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_guest</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * When HO == GO == 1 the hardware treats that as GO == HO == 0</span>
<span class="cm">		 * and will count in both modes. We don&#39;t want to count in that</span>
<span class="cm">		 * case so we emulate no-counting by setting US = OS = 0.</span>
<span class="cm">		 */</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ARCH_PERFMON_EVENTSEL_USR</span> <span class="o">|</span>
				      <span class="n">ARCH_PERFMON_EVENTSEL_OS</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span><span class="p">)</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="n">AMD_PERFMON_EVENTSEL_GUESTONLY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_guest</span><span class="p">)</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="n">AMD_PERFMON_EVENTSEL_HOSTONLY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PERF_TYPE_RAW</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">AMD64_RAW_EVENT_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AMD64 events are detected based on their event codes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">amd_get_event_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">amd_is_nb_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xe0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">amd_has_nb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd_nb</span> <span class="o">*</span><span class="n">nb</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nb</span> <span class="o">&amp;&amp;</span> <span class="n">nb</span><span class="o">-&gt;</span><span class="n">nb_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd_put_event_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amd_nb</span> <span class="o">*</span><span class="n">nb</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * only care about NB events</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">amd_has_nb</span><span class="p">(</span><span class="n">cpuc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">amd_is_nb_event</span><span class="p">(</span><span class="n">hwc</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * need to scan whole list because event may not have</span>
<span class="cm">	 * been assigned during scheduling</span>
<span class="cm">	 *</span>
<span class="cm">	 * no race condition possible because event can only</span>
<span class="cm">	 * be removed on one CPU at a time AND PMU is disabled</span>
<span class="cm">	 * when we come here</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg</span><span class="p">(</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">owners</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">event</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

 <span class="cm">/*</span>
<span class="cm">  * AMD64 NorthBridge events need special treatment because</span>
<span class="cm">  * counter access needs to be synchronized across all cores</span>
<span class="cm">  * of a package. Refer to BKDG section 3.12</span>
<span class="cm">  *</span>
<span class="cm">  * NB events are events measuring L3 cache, Hypertransport</span>
<span class="cm">  * traffic. They are identified by an event code &gt;= 0xe00.</span>
<span class="cm">  * They measure events on the NorthBride which is shared</span>
<span class="cm">  * by all cores on a package. NB events are counted on a</span>
<span class="cm">  * shared set of counters. When a NB event is programmed</span>
<span class="cm">  * in a counter, the data actually comes from a shared</span>
<span class="cm">  * counter. Thus, access to those counters needs to be</span>
<span class="cm">  * synchronized.</span>
<span class="cm">  *</span>
<span class="cm">  * We implement the synchronization such that no two cores</span>
<span class="cm">  * can be measuring NB events using the same counters. Thus,</span>
<span class="cm">  * we maintain a per-NB allocation table. The available slot</span>
<span class="cm">  * is propagated using the event_constraint structure.</span>
<span class="cm">  *</span>
<span class="cm">  * We provide only one choice for each NB event based on</span>
<span class="cm">  * the fact that only NB events have restrictions. Consequently,</span>
<span class="cm">  * if a counter is available, there is a guarantee the NB event</span>
<span class="cm">  * will be assigned to it. If no slot is available, an empty</span>
<span class="cm">  * constraint is returned and scheduling will eventually fail</span>
<span class="cm">  * for this event.</span>
<span class="cm">  *</span>
<span class="cm">  * Note that all cores attached the same NB compete for the same</span>
<span class="cm">  * counters to host NB events, this is why we use atomic ops. Some</span>
<span class="cm">  * multi-chip CPUs may have more than one NB.</span>
<span class="cm">  *</span>
<span class="cm">  * Given that resources are allocated (cmpxchg), they must be</span>
<span class="cm">  * eventually freed for others to use. This is accomplished by</span>
<span class="cm">  * calling amd_put_event_constraints().</span>
<span class="cm">  *</span>
<span class="cm">  * Non NB events are not impacted by this restriction.</span>
<span class="cm">  */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span>
<span class="nf">amd_get_event_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amd_nb</span> <span class="o">*</span><span class="n">nb</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if not NB event or no NB, then no constraints</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">amd_has_nb</span><span class="p">(</span><span class="n">cpuc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">amd_is_nb_event</span><span class="p">(</span><span class="n">hwc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">unconstrained</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * detect if already present, if so reuse</span>
<span class="cm">	 *</span>
<span class="cm">	 * cannot merge with actual allocation</span>
<span class="cm">	 * because of possible holes</span>
<span class="cm">	 *</span>
<span class="cm">	 * event can already be present yet not assigned (in hwc-&gt;idx)</span>
<span class="cm">	 * because of successive calls to x86_schedule_events() from</span>
<span class="cm">	 * hw_perf_group_sched_in() without hw_perf_enable()</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * keep track of first free slot</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">owners</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* already present, reuse */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">owners</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">event</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * not present, so grab a new slot</span>
<span class="cm">	 * starting either at:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* previous assignment */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start from free slot found */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * event not found, no slot found in</span>
<span class="cm">		 * first pass, try again from the</span>
<span class="cm">		 * beginning</span>
<span class="cm">		 */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">owners</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">max</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">event_constraints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">emptyconstraint</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amd_nb</span> <span class="o">*</span><span class="nf">amd_alloc_nb</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd_nb</span> <span class="o">*</span><span class="n">nb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nb</span> <span class="o">=</span> <span class="n">kmalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd_nb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span>
			  <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">nb</span><span class="o">-&gt;</span><span class="n">nb_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize all possible NB constraints</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nb</span><span class="o">-&gt;</span><span class="n">event_constraints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idxmsk</span><span class="p">);</span>
		<span class="n">nb</span><span class="o">-&gt;</span><span class="n">event_constraints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd_pmu_cpu_prepare</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_max_cores</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>

	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span> <span class="o">=</span> <span class="n">amd_alloc_nb</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_BAD</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd_pmu_cpu_starting</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">amd_nb</span> <span class="o">*</span><span class="n">nb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nb_id</span><span class="p">;</span>

	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">perf_ctr_virt_mask</span> <span class="o">=</span> <span class="n">AMD_PERFMON_EVENTSEL_HOSTONLY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_max_cores</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">nb_id</span> <span class="o">=</span> <span class="n">amd_get_nb_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">nb_id</span> <span class="o">==</span> <span class="n">BAD_APICID</span><span class="p">);</span>

	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nb</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">i</span><span class="p">).</span><span class="n">amd_nb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">nb</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">nb_id</span> <span class="o">==</span> <span class="n">nb_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">kfree_on_online</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="p">;</span>
			<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span> <span class="o">=</span> <span class="n">nb</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="o">-&gt;</span><span class="n">nb_id</span> <span class="o">=</span> <span class="n">nb_id</span><span class="p">;</span>
	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd_pmu_cpu_dead</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuhw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_max_cores</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cpuhw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpuhw</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">amd_nb</span> <span class="o">*</span><span class="n">nb</span> <span class="o">=</span> <span class="n">cpuhw</span><span class="o">-&gt;</span><span class="n">amd_nb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">nb_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="o">--</span><span class="n">nb</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>

		<span class="n">cpuhw</span><span class="o">-&gt;</span><span class="n">amd_nb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">event</span><span class="p">,</span>	<span class="s">&quot;config:0-7,32-35&quot;</span><span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">umask</span><span class="p">,</span>	<span class="s">&quot;config:8-15&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span>	<span class="s">&quot;config:18&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span>	<span class="s">&quot;config:23&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">cmask</span><span class="p">,</span>	<span class="s">&quot;config:24-31&quot;</span>	<span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">amd_format_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">format_attr_event</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_umask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_edge</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_inv</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_cmask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_pmu</span> <span class="n">amd_pmu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;AMD&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>		<span class="o">=</span> <span class="n">x86_pmu_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_all</span>		<span class="o">=</span> <span class="n">x86_pmu_disable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_all</span>		<span class="o">=</span> <span class="n">x86_pmu_enable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>			<span class="o">=</span> <span class="n">x86_pmu_enable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>		<span class="o">=</span> <span class="n">x86_pmu_disable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_config</span>		<span class="o">=</span> <span class="n">amd_pmu_hw_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">schedule_events</span>	<span class="o">=</span> <span class="n">x86_schedule_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eventsel</span>		<span class="o">=</span> <span class="n">MSR_K7_EVNTSEL0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">perfctr</span>		<span class="o">=</span> <span class="n">MSR_K7_PERFCTR0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_map</span>		<span class="o">=</span> <span class="n">amd_pmu_event_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_events</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">amd_perfmon_event_map</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_counters</span>		<span class="o">=</span> <span class="n">AMD64_NUM_COUNTERS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cntval_bits</span>		<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cntval_mask</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">apic</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="cm">/* use highest bit to detect overflow */</span>
	<span class="p">.</span><span class="n">max_period</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">47</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_event_constraints</span>	<span class="o">=</span> <span class="n">amd_get_event_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_event_constraints</span>	<span class="o">=</span> <span class="n">amd_put_event_constraints</span><span class="p">,</span>

	<span class="p">.</span><span class="n">format_attrs</span>		<span class="o">=</span> <span class="n">amd_format_attr</span><span class="p">,</span>

	<span class="p">.</span><span class="n">cpu_prepare</span>		<span class="o">=</span> <span class="n">amd_pmu_cpu_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_starting</span>		<span class="o">=</span> <span class="n">amd_pmu_cpu_starting</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_dead</span>		<span class="o">=</span> <span class="n">amd_pmu_cpu_dead</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* AMD Family 15h */</span>

<span class="cp">#define AMD_EVENT_TYPE_MASK	0x000000F0ULL</span>

<span class="cp">#define AMD_EVENT_FP		0x00000000ULL ... 0x00000010ULL</span>
<span class="cp">#define AMD_EVENT_LS		0x00000020ULL ... 0x00000030ULL</span>
<span class="cp">#define AMD_EVENT_DC		0x00000040ULL ... 0x00000050ULL</span>
<span class="cp">#define AMD_EVENT_CU		0x00000060ULL ... 0x00000070ULL</span>
<span class="cp">#define AMD_EVENT_IC_DE		0x00000080ULL ... 0x00000090ULL</span>
<span class="cp">#define AMD_EVENT_EX_LS		0x000000C0ULL</span>
<span class="cp">#define AMD_EVENT_DE		0x000000D0ULL</span>
<span class="cp">#define AMD_EVENT_NB		0x000000E0ULL ... 0x000000F0ULL</span>

<span class="cm">/*</span>
<span class="cm"> * AMD family 15h event code/PMC mappings:</span>
<span class="cm"> *</span>
<span class="cm"> * type = event_code &amp; 0x0F0:</span>
<span class="cm"> *</span>
<span class="cm"> * 0x000	FP	PERF_CTL[5:3]</span>
<span class="cm"> * 0x010	FP	PERF_CTL[5:3]</span>
<span class="cm"> * 0x020	LS	PERF_CTL[5:0]</span>
<span class="cm"> * 0x030	LS	PERF_CTL[5:0]</span>
<span class="cm"> * 0x040	DC	PERF_CTL[5:0]</span>
<span class="cm"> * 0x050	DC	PERF_CTL[5:0]</span>
<span class="cm"> * 0x060	CU	PERF_CTL[2:0]</span>
<span class="cm"> * 0x070	CU	PERF_CTL[2:0]</span>
<span class="cm"> * 0x080	IC/DE	PERF_CTL[2:0]</span>
<span class="cm"> * 0x090	IC/DE	PERF_CTL[2:0]</span>
<span class="cm"> * 0x0A0	---</span>
<span class="cm"> * 0x0B0	---</span>
<span class="cm"> * 0x0C0	EX/LS	PERF_CTL[5:0]</span>
<span class="cm"> * 0x0D0	DE	PERF_CTL[2:0]</span>
<span class="cm"> * 0x0E0	NB	NB_PERF_CTL[3:0]</span>
<span class="cm"> * 0x0F0	NB	NB_PERF_CTL[3:0]</span>
<span class="cm"> *</span>
<span class="cm"> * Exceptions:</span>
<span class="cm"> *</span>
<span class="cm"> * 0x000	FP	PERF_CTL[3], PERF_CTL[5:3] (*)</span>
<span class="cm"> * 0x003	FP	PERF_CTL[3]</span>
<span class="cm"> * 0x004	FP	PERF_CTL[3], PERF_CTL[5:3] (*)</span>
<span class="cm"> * 0x00B	FP	PERF_CTL[3]</span>
<span class="cm"> * 0x00D	FP	PERF_CTL[3]</span>
<span class="cm"> * 0x023	DE	PERF_CTL[2:0]</span>
<span class="cm"> * 0x02D	LS	PERF_CTL[3]</span>
<span class="cm"> * 0x02E	LS	PERF_CTL[3,0]</span>
<span class="cm"> * 0x031	LS	PERF_CTL[2:0] (**)</span>
<span class="cm"> * 0x043	CU	PERF_CTL[2:0]</span>
<span class="cm"> * 0x045	CU	PERF_CTL[2:0]</span>
<span class="cm"> * 0x046	CU	PERF_CTL[2:0]</span>
<span class="cm"> * 0x054	CU	PERF_CTL[2:0]</span>
<span class="cm"> * 0x055	CU	PERF_CTL[2:0]</span>
<span class="cm"> * 0x08F	IC	PERF_CTL[0]</span>
<span class="cm"> * 0x187	DE	PERF_CTL[0]</span>
<span class="cm"> * 0x188	DE	PERF_CTL[0]</span>
<span class="cm"> * 0x0DB	EX	PERF_CTL[5:0]</span>
<span class="cm"> * 0x0DC	LS	PERF_CTL[5:0]</span>
<span class="cm"> * 0x0DD	LS	PERF_CTL[5:0]</span>
<span class="cm"> * 0x0DE	LS	PERF_CTL[5:0]</span>
<span class="cm"> * 0x0DF	LS	PERF_CTL[5:0]</span>
<span class="cm"> * 0x1C0	EX	PERF_CTL[5:3]</span>
<span class="cm"> * 0x1D6	EX	PERF_CTL[5:0]</span>
<span class="cm"> * 0x1D8	EX	PERF_CTL[5:0]</span>
<span class="cm"> *</span>
<span class="cm"> * (*)  depending on the umask all FPU counters may be used</span>
<span class="cm"> * (**) only one unitmask enabled at a time</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">amd_f15_PMC0</span>  <span class="o">=</span> <span class="n">EVENT_CONSTRAINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">amd_f15_PMC20</span> <span class="o">=</span> <span class="n">EVENT_CONSTRAINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">amd_f15_PMC3</span>  <span class="o">=</span> <span class="n">EVENT_CONSTRAINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">amd_f15_PMC30</span> <span class="o">=</span> <span class="n">EVENT_CONSTRAINT_OVERLAP</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">amd_f15_PMC50</span> <span class="o">=</span> <span class="n">EVENT_CONSTRAINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">amd_f15_PMC53</span> <span class="o">=</span> <span class="n">EVENT_CONSTRAINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span>
<span class="nf">amd_get_event_constraints_f15h</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_code</span> <span class="o">=</span> <span class="n">amd_get_event_code</span><span class="p">(</span><span class="n">hwc</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event_code</span> <span class="o">&amp;</span> <span class="n">AMD_EVENT_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AMD_EVENT_FP</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">event_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x000</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x0000F000ULL</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x00000F00ULL</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC3</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x004</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hweight_long</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">ARCH_PERFMON_EVENTSEL_UMASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC3</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x003</span>:
		<span class="k">case</span> <span class="mh">0x00B</span>:
		<span class="k">case</span> <span class="mh">0x00D</span>:
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC53</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AMD_EVENT_LS</span>:
	<span class="k">case</span> <span class="n">AMD_EVENT_DC</span>:
	<span class="k">case</span> <span class="n">AMD_EVENT_EX_LS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">event_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x023</span>:
		<span class="k">case</span> <span class="mh">0x043</span>:
		<span class="k">case</span> <span class="mh">0x045</span>:
		<span class="k">case</span> <span class="mh">0x046</span>:
		<span class="k">case</span> <span class="mh">0x054</span>:
		<span class="k">case</span> <span class="mh">0x055</span>:
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC20</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02D</span>:
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC3</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02E</span>:
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC30</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x031</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hweight_long</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">ARCH_PERFMON_EVENTSEL_UMASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC20</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">emptyconstraint</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1C0</span>:
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC53</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC50</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">AMD_EVENT_CU</span>:
	<span class="k">case</span> <span class="n">AMD_EVENT_IC_DE</span>:
	<span class="k">case</span> <span class="n">AMD_EVENT_DE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">event_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x08F</span>:
		<span class="k">case</span> <span class="mh">0x187</span>:
		<span class="k">case</span> <span class="mh">0x188</span>:
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC0</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0DB</span> <span class="p">...</span> <span class="mh">0x0DF</span>:
		<span class="k">case</span> <span class="mh">0x1D6</span>:
		<span class="k">case</span> <span class="mh">0x1D8</span>:
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC50</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">amd_f15_PMC20</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">AMD_EVENT_NB</span>:
		<span class="cm">/* not yet implemented */</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">emptyconstraint</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">emptyconstraint</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_pmu</span> <span class="n">amd_pmu_f15h</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;AMD Family 15h&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>		<span class="o">=</span> <span class="n">x86_pmu_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_all</span>		<span class="o">=</span> <span class="n">x86_pmu_disable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_all</span>		<span class="o">=</span> <span class="n">x86_pmu_enable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>			<span class="o">=</span> <span class="n">x86_pmu_enable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>		<span class="o">=</span> <span class="n">x86_pmu_disable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_config</span>		<span class="o">=</span> <span class="n">amd_pmu_hw_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">schedule_events</span>	<span class="o">=</span> <span class="n">x86_schedule_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eventsel</span>		<span class="o">=</span> <span class="n">MSR_F15H_PERF_CTL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">perfctr</span>		<span class="o">=</span> <span class="n">MSR_F15H_PERF_CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_map</span>		<span class="o">=</span> <span class="n">amd_pmu_event_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_events</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">amd_perfmon_event_map</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_counters</span>		<span class="o">=</span> <span class="n">AMD64_NUM_COUNTERS_F15H</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cntval_bits</span>		<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cntval_mask</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">apic</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="cm">/* use highest bit to detect overflow */</span>
	<span class="p">.</span><span class="n">max_period</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">47</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_event_constraints</span>	<span class="o">=</span> <span class="n">amd_get_event_constraints_f15h</span><span class="p">,</span>
	<span class="cm">/* nortbridge counters not yet implemented: */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	.put_event_constraints	= amd_put_event_constraints,</span>

<span class="c">	.cpu_prepare		= amd_pmu_cpu_prepare,</span>
<span class="c">	.cpu_dead		= amd_pmu_cpu_dead,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">cpu_starting</span>		<span class="o">=</span> <span class="n">amd_pmu_cpu_starting</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_attrs</span>		<span class="o">=</span> <span class="n">amd_format_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">__init</span> <span class="kt">int</span> <span class="nf">amd_pmu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Performance-monitoring supported from K7 and later: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If core performance counter extensions exists, it must be</span>
<span class="cm">	 * family 15h, otherwise fail. See x86_pmu_addr_offset().</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x15</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_perfctr_core</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">x86_pmu</span> <span class="o">=</span> <span class="n">amd_pmu_f15h</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_perfctr_core</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">x86_pmu</span> <span class="o">=</span> <span class="n">amd_pmu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Events are common for all AMDs */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">,</span> <span class="n">amd_hw_cache_event_ids</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">amd_pmu_enable_virt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">perf_ctr_virt_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reload all events */</span>
	<span class="n">x86_pmu_disable_all</span><span class="p">();</span>
	<span class="n">x86_pmu_enable_all</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">amd_pmu_enable_virt</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">amd_pmu_disable_virt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only mask out the Host-only bit so that host-only counting works</span>
<span class="cm">	 * when SVM is disabled. If someone sets up a guest-only counter when</span>
<span class="cm">	 * SVM is disabled the Guest-only bits still gets set and the counter</span>
<span class="cm">	 * will not count anything.</span>
<span class="cm">	 */</span>
	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">perf_ctr_virt_mask</span> <span class="o">=</span> <span class="n">AMD_PERFMON_EVENTSEL_HOSTONLY</span><span class="p">;</span>

	<span class="cm">/* Reload all events */</span>
	<span class="n">x86_pmu_disable_all</span><span class="p">();</span>
	<span class="n">x86_pmu_enable_all</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">amd_pmu_disable_virt</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
