<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › cpu › amd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>amd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/elf.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/apic.h&gt;</span>
<span class="cp">#include &lt;asm/cpu.h&gt;</span>
<span class="cp">#include &lt;asm/pci-direct.h&gt;</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="cp"># include &lt;asm/numa_64.h&gt;</span>
<span class="cp"># include &lt;asm/mmconfig.h&gt;</span>
<span class="cp"># include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;cpu.h&quot;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cm">/*</span>
<span class="cm"> *	B step AMD K6 before B 9730xxxx have hardware bugs that can cause</span>
<span class="cm"> *	misexecution of code under Linux. Owners of such processors should</span>
<span class="cm"> *	contact AMD for precise details and a CPU swap.</span>
<span class="cm"> *</span>
<span class="cm"> *	See	http://www.multimania.com/poulot/k6bug.html</span>
<span class="cm"> *	and	section 2.6.2 of &quot;AMD-K6 Processor Revision Guide - Model 6&quot;</span>
<span class="cm"> *		(Publication # 21266  Issue Date: August 1998)</span>
<span class="cm"> *</span>
<span class="cm"> *	The following test is erm.. interesting. AMD neglected to up</span>
<span class="cm"> *	the chip setting when fixing the bug but they also tweaked some</span>
<span class="cm"> *	performance at the same time..</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">vide</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;.align 4</span><span class="se">\n</span><span class="s">vide: ret&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">init_amd_k5</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * General Systems BIOSen alias the cpu frequency registers</span>
<span class="cm"> * of the Elan at 0x000df000. Unfortuantly, one of the Linux</span>
<span class="cm"> * drivers subsequently pokes it, and changes the CPU speed.</span>
<span class="cm"> * Workaround : Remove the unneeded alias.</span>
<span class="cm"> */</span>
<span class="cp">#define CBAR		(0xfffc) </span><span class="cm">/* Configuration Base Address  (32-bit) */</span><span class="cp"></span>
<span class="cp">#define CBAR_ENB	(0x80000000)</span>
<span class="cp">#define CBAR_KEY	(0X000000CB)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">9</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">CBAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CBAR_ENB</span><span class="p">)</span>
			<span class="n">outl</span><span class="p">(</span><span class="mi">0</span> <span class="o">|</span> <span class="n">CBAR_KEY</span><span class="p">,</span> <span class="n">CBAR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">init_amd_k6</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbytes</span> <span class="o">=</span> <span class="n">num_physpages</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">20</span><span class="o">-</span><span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Based on AMD doc 20734R - June 2000 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_APIC</span><span class="p">);</span>
			<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_PGE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">K6_BUG_LOOP</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">f_vide</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d</span><span class="p">,</span> <span class="n">d2</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AMD K6 stepping B detected - &quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * It looks like AMD fixed the 2.6.2 bug and improved indirect</span>
<span class="cm">		 * calls at the same time.</span>
<span class="cm">		 */</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">K6_BUG_LOOP</span><span class="p">;</span>
		<span class="n">f_vide</span> <span class="o">=</span> <span class="n">vide</span><span class="p">;</span>
		<span class="n">rdtscl</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
			<span class="n">f_vide</span><span class="p">();</span>
		<span class="n">rdtscl</span><span class="p">(</span><span class="n">d2</span><span class="p">);</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">d2</span><span class="o">-</span><span class="n">d</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="o">*</span><span class="n">K6_BUG_LOOP</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span>
				<span class="s">&quot;system stability may be impaired when more than 32 MB are used.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;probably OK (after B9730xxxx).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* K6 with old style WHCR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We can only write allocate on the low 508Mb */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbytes</span> <span class="o">&gt;</span> <span class="mi">508</span><span class="p">)</span>
			<span class="n">mbytes</span> <span class="o">=</span> <span class="mi">508</span><span class="p">;</span>

		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_K6_WHCR</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">l</span><span class="o">&amp;</span><span class="mh">0x0000FFFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">|</span><span class="p">((</span><span class="n">mbytes</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">wbinvd</span><span class="p">();</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_K6_WHCR</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Enabling old style K6 write allocation for %d Mb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mbytes</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">9</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The more serious chips .. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mbytes</span> <span class="o">&gt;</span> <span class="mi">4092</span><span class="p">)</span>
			<span class="n">mbytes</span> <span class="o">=</span> <span class="mi">4092</span><span class="p">;</span>

		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_K6_WHCR</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">l</span><span class="o">&amp;</span><span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">=</span> <span class="p">((</span><span class="n">mbytes</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">22</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
			<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">wbinvd</span><span class="p">();</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_K6_WHCR</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Enabling new style K6 write allocation for %d Mb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mbytes</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* AMD Geode LX is model 10 */</span>
		<span class="cm">/* placeholder for any needed mods */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">amd_k7_smp_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* calling is from identify_secondary_cpu() ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cpu_index</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Certain Athlons might work (for various values of &#39;work&#39;) in SMP</span>
<span class="cm">	 * but they are not certified as MP capable.</span>
<span class="cm">	 */</span>
	<span class="cm">/* Athlon 660/661 is valid. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">valid_k7</span><span class="p">;</span>

	<span class="cm">/* Duron 670 is valid */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">valid_k7</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Athlon 662, Duron 671, and Athlon &gt;model 7 have capability</span>
<span class="cm">	 * bit. It&#39;s worth noting that the A5 stepping (662) of some</span>
<span class="cm">	 * Athlon XP&#39;s have the MP bit set.</span>
<span class="cm">	 * See http://www.heise.de/newsticker/data/jow-18.10.01-000 for</span>
<span class="cm">	 * more.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_mp</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">valid_k7</span><span class="p">;</span>

	<span class="cm">/* If we get here, not a certified SMP capable AMD system. */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t taint if we are running SMP kernel on a single non-MP</span>
<span class="cm">	 * approved Athlon</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;WARNING: This combination of AMD&quot;</span>
		<span class="s">&quot; processors is not suitable for SMP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_taint</span><span class="p">(</span><span class="n">TAINT_UNSAFE_SMP</span><span class="p">))</span>
		<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_UNSAFE_SMP</span><span class="p">);</span>

<span class="nl">valid_k7:</span>
	<span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">init_amd_k7</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bit 15 of Athlon specific MSR 15, needs to be 0</span>
<span class="cm">	 * to enable SSE on Palomino/Morgan/Barton CPU&#39;s.</span>
<span class="cm">	 * If the BIOS didn&#39;t enable it already, enable it here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_XMM</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Enabling disabled K7/SSE Support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
			<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00008000</span><span class="p">;</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
			<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_XMM</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s been determined by AMD that Athlons since model 8 stepping 1</span>
<span class="cm">	 * are more robust with CLK_CTL set to 200xxxxx instead of 600xxxxx</span>
<span class="cm">	 * As per AMD technical note 27212 0.2</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_K7_CLK_CTL</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">l</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			    <span class="s">&quot;CPU: CLK_CTL MSR was %x. Reprogramming to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">l</span><span class="p">,</span> <span class="p">((</span><span class="n">l</span> <span class="o">&amp;</span> <span class="mh">0x000fffff</span><span class="p">)</span><span class="o">|</span><span class="mh">0x20000000</span><span class="p">));</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_K7_CLK_CTL</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="mh">0x000fffff</span><span class="p">)</span><span class="o">|</span><span class="mh">0x20000000</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_K7</span><span class="p">);</span>

	<span class="n">amd_k7_smp_check</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
<span class="cm">/*</span>
<span class="cm"> * To workaround broken NUMA config.  Read the comment in</span>
<span class="cm"> * srat_detect_node().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">nearby_node</span><span class="p">(</span><span class="kt">int</span> <span class="n">apicid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">apicid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">__apicid_to_node</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">!=</span> <span class="n">NUMA_NO_NODE</span> <span class="o">&amp;&amp;</span> <span class="n">node_online</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">apicid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LOCAL_APIC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">__apicid_to_node</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">!=</span> <span class="n">NUMA_NO_NODE</span> <span class="o">&amp;&amp;</span> <span class="n">node_online</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">first_node</span><span class="p">(</span><span class="n">node_online_map</span><span class="p">);</span> <span class="cm">/* Shouldn&#39;t happen */</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Fixup core topology information for</span>
<span class="cm"> * (1) AMD multi-node processors</span>
<span class="cm"> *     Assumption: Number of cores in each internal node is the same.</span>
<span class="cm"> * (2) AMD processors supporting compute units</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_X86_HT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">amd_get_topology</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">cores_per_cu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">node_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>

	<span class="cm">/* get information required for multi-node processors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_TOPOEXT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span><span class="p">;</span>

		<span class="n">cpuid</span><span class="p">(</span><span class="mh">0x8000001e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">);</span>
		<span class="n">nodes</span> <span class="o">=</span> <span class="p">((</span><span class="n">ecx</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">node_id</span> <span class="o">=</span> <span class="n">ecx</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>

		<span class="cm">/* get compute unit information */</span>
		<span class="n">smp_num_siblings</span> <span class="o">=</span> <span class="p">((</span><span class="n">ebx</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">compute_unit_id</span> <span class="o">=</span> <span class="n">ebx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cores_per_cu</span> <span class="o">+=</span> <span class="p">((</span><span class="n">ebx</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_NODEID_MSR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">value</span><span class="p">;</span>

		<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_FAM10H_NODE_ID</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">nodes</span> <span class="o">=</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">node_id</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* fixup multi-node processor information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cores_per_node</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">cus_per_node</span><span class="p">;</span>

		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_AMD_DCM</span><span class="p">);</span>
		<span class="n">cores_per_node</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_max_cores</span> <span class="o">/</span> <span class="n">nodes</span><span class="p">;</span>
		<span class="n">cus_per_node</span> <span class="o">=</span> <span class="n">cores_per_node</span> <span class="o">/</span> <span class="n">cores_per_cu</span><span class="p">;</span>

		<span class="cm">/* store NodeID, use llc_shared_map to store sibling info */</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_llc_id</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">node_id</span><span class="p">;</span>

		<span class="cm">/* core id has to be in the [0 .. cores_per_node - 1] range */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cpu_core_id</span> <span class="o">%=</span> <span class="n">cores_per_node</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">compute_unit_id</span> <span class="o">%=</span> <span class="n">cus_per_node</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * On a AMD dual core setup the lower bits of the APIC id distingush the cores.</span>
<span class="cm"> * Assumes number of cores is a power of two.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">amd_detect_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_HT</span>
	<span class="kt">unsigned</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_coreid_bits</span><span class="p">;</span>
	<span class="cm">/* Low order bits define the core id (index of core in socket) */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cpu_core_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">initial_apicid</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Convert the initial APIC ID into the socket ID */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">phys_proc_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">initial_apicid</span> <span class="o">&gt;&gt;</span> <span class="n">bits</span><span class="p">;</span>
	<span class="cm">/* use socket ID also for last level cache */</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_llc_id</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">phys_proc_id</span><span class="p">;</span>
	<span class="n">amd_get_topology</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">amd_get_nb_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_llc_id</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">amd_get_nb_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">srat_detect_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_NUMA</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">apicid</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">apicid</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">numa_cpu_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">NUMA_NO_NODE</span><span class="p">)</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_llc_id</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * On multi-fabric platform (e.g. Numascale NumaChip) a</span>
<span class="cm">	 * platform-specific handler needs to be called to fixup some</span>
<span class="cm">	 * IDs of the CPU.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x86_cpuinit</span><span class="p">.</span><span class="n">fixup_cpu_id</span><span class="p">)</span>
		<span class="n">x86_cpuinit</span><span class="p">.</span><span class="n">fixup_cpu_id</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_online</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Two possibilities here:</span>
<span class="cm">		 *</span>
<span class="cm">		 * - The CPU is missing memory and no node was created.  In</span>
<span class="cm">		 *   that case try picking one from a nearby CPU.</span>
<span class="cm">		 *</span>
<span class="cm">		 * - The APIC IDs differ from the HyperTransport node IDs</span>
<span class="cm">		 *   which the K8 northbridge parsing fills in.  Assume</span>
<span class="cm">		 *   they are all increased by a constant offset, but in</span>
<span class="cm">		 *   the same order as the HT nodeids.  If that doesn&#39;t</span>
<span class="cm">		 *   result in a usable node fall back to the path for the</span>
<span class="cm">		 *   previous case.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This workaround operates directly on the mapping between</span>
<span class="cm">		 * APIC ID and NUMA node, assuming certain relationship</span>
<span class="cm">		 * between APIC ID, HT node ID and NUMA topology.  As going</span>
<span class="cm">		 * through CPU mapping may alter the outcome, directly</span>
<span class="cm">		 * access __apicid_to_node[].</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">ht_nodeid</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">initial_apicid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ht_nodeid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">__apicid_to_node</span><span class="p">[</span><span class="n">ht_nodeid</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NUMA_NO_NODE</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">__apicid_to_node</span><span class="p">[</span><span class="n">ht_nodeid</span><span class="p">];</span>
		<span class="cm">/* Pick a nearby node */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_online</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">nearby_node</span><span class="p">(</span><span class="n">apicid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">numa_set_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">early_init_amd_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_HT</span>
	<span class="kt">unsigned</span> <span class="n">bits</span><span class="p">,</span> <span class="n">ecx</span><span class="p">;</span>

	<span class="cm">/* Multi core CPU? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">extended_cpuid_level</span> <span class="o">&lt;</span> <span class="mh">0x80000008</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ecx</span> <span class="o">=</span> <span class="n">cpuid_ecx</span><span class="p">(</span><span class="mh">0x80000008</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_max_cores</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* CPU telling us the core id bits shift? */</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecx</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>

	<span class="cm">/* Otherwise recompute */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_max_cores</span><span class="p">)</span>
			<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_coreid_bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">bsp_init_amd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_CONSTANT_TSC</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">&gt;</span> <span class="mh">0x10</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;=</span> <span class="mh">0x2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">24</span><span class="p">)))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">FW_BUG</span> <span class="s">&quot;TSC doesn&#39;t count &quot;</span>
					<span class="s">&quot;with P0 frequency!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">upperbit</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">cpuid</span><span class="p">,</span> <span class="n">assoc</span><span class="p">;</span>

		<span class="n">cpuid</span>	 <span class="o">=</span> <span class="n">cpuid_edx</span><span class="p">(</span><span class="mh">0x80000005</span><span class="p">);</span>
		<span class="n">assoc</span>	 <span class="o">=</span> <span class="n">cpuid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">upperbit</span> <span class="o">=</span> <span class="p">((</span><span class="n">cpuid</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">assoc</span><span class="p">;</span>

		<span class="n">va_align</span><span class="p">.</span><span class="n">mask</span>	  <span class="o">=</span> <span class="p">(</span><span class="n">upperbit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">va_align</span><span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">ALIGN_VA_32</span> <span class="o">|</span> <span class="n">ALIGN_VA_64</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">early_init_amd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">early_init_amd_mc</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * c-&gt;x86_power is 8000_0007 edx. Bit 8 is TSC runs at constant rate</span>
<span class="cm">	 * with P/T states and does not stop in deep C-states</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_power</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_CONSTANT_TSC</span><span class="p">);</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_NONSTOP_TSC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_tsc_unstable</span><span class="p">())</span>
			<span class="n">sched_clock_stable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_SYSCALL32</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cm">/*  Set MTRR capability flag if appropriate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">13</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">9</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_K6_MTRR</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_X86_LOCAL_APIC) &amp;&amp; defined(CONFIG_PCI)</span>
	<span class="cm">/* check CPU config space for extended APIC ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_apic</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">&gt;=</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">read_pci_config</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)))</span> <span class="o">==</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)))</span>
			<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_EXTD_APICID</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">init_amd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dummy</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable TLB flush filter by setting HWCR.FFDIS on K8</span>
<span class="cm">	 * bit 6 of msr C001_0015</span>
<span class="cm">	 *</span>
<span class="cm">	 * Errata 63 for SH-B3 steppings</span>
<span class="cm">	 * Errata 122 for all steppings (F+ have it disabled by default)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">early_init_amd</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bit 31 in normal CPUID used for nonstandard 3DNow ID;</span>
<span class="cm">	 * 3DNow is IDd by bit 31 in extended CPUID (1*32+31) anyway</span>
<span class="cm">	 */</span>
	<span class="n">clear_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="mi">32</span><span class="o">+</span><span class="mi">31</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="cm">/* On C+ stepping K8 rep microcode works well for copy/memset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>

		<span class="n">level</span> <span class="o">=</span> <span class="n">cpuid_eax</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mh">0x0f48</span> <span class="o">&amp;&amp;</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mh">0x0f50</span><span class="p">)</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mh">0x0f58</span><span class="p">)</span>
			<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_REP_GOOD</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Some BIOSes incorrectly force this feature, but only K8</span>
<span class="cm">		 * revision D (model = 0x14) and later actually support it.</span>
<span class="cm">		 * (AMD Erratum #110, docId: 25759).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&lt;</span> <span class="mh">0x14</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_has</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_LAHF_LM</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">clear_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_LAHF_LM</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdmsrl_amd_safe</span><span class="p">(</span><span class="mh">0xc001100d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
				<span class="n">wrmsrl_amd_safe</span><span class="p">(</span><span class="mh">0xc001100d</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_REP_GOOD</span><span class="p">);</span>

	<span class="cm">/* get apicid instead of initial apic id from cpuid */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">apicid</span> <span class="o">=</span> <span class="n">hard_smp_processor_id</span><span class="p">();</span>
<span class="cp">#else</span>

	<span class="cm">/*</span>
<span class="cm">	 *	FIXME: We should handle the K5 here. Set up the write</span>
<span class="cm">	 *	range and also turn on MSR 83 bits 4 and 31 (write alloc,</span>
<span class="cm">	 *	no bus pipeline)</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">init_amd_k5</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">init_amd_k6</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* An Athlon/Duron */</span>
		<span class="n">init_amd_k7</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* K6s reports MCEs but don&#39;t actually have all the MSRs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">clear_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_MCE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Enable workaround for FXSAVE leak */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_FXSAVE_LEAK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xf</span>:
			<span class="cm">/* Should distinguish Models here, but this is only</span>
<span class="cm">			   a fallback anyways. */</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model_id</span><span class="p">,</span> <span class="s">&quot;Hammer&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* re-enable TopologyExtensions if switched off by BIOS */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&lt;=</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_TOPOEXT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdmsrl_amd_safe</span><span class="p">(</span><span class="mh">0xc0011005</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">54</span><span class="p">;</span>
			<span class="n">wrmsrl_amd_safe</span><span class="p">(</span><span class="mh">0xc0011005</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rdmsrl</span><span class="p">(</span><span class="mh">0xc0011005</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">54</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_TOPOEXT</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">FW_INFO</span> <span class="s">&quot;CPU: Re-enabling &quot;</span>
				  <span class="s">&quot;disabled Topology Extensions Support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cpu_detect_cache_sizes</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="cm">/* Multi core CPU? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">extended_cpuid_level</span> <span class="o">&gt;=</span> <span class="mh">0x80000008</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amd_detect_cmp</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">srat_detect_node</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">detect_ht</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">extended_cpuid_level</span> <span class="o">&gt;=</span> <span class="mh">0x80000006</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpuid_edx</span><span class="p">(</span><span class="mh">0x80000006</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span>
			<span class="n">num_cache_leaves</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">num_cache_leaves</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">&gt;=</span> <span class="mh">0xf</span><span class="p">)</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_K8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_xmm2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MFENCE stops RDTSC speculation */</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_MFENCE_RDTSC</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* do this for boot cpu */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">boot_cpu_data</span><span class="p">)</span>
			<span class="n">check_enable_amd_mmconf_dmi</span><span class="p">();</span>

		<span class="n">fam10h_check_enable_mmcfg</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">boot_cpu_data</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">&gt;=</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tseg</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Split up direct mapping around the TSEG SMM area.</span>
<span class="cm">		 * Don&#39;t do it for gbpages because there seems very little</span>
<span class="cm">		 * benefit in doing so.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdmsrl_safe</span><span class="p">(</span><span class="n">MSR_K8_TSEG_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tseg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tseg: %010llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tseg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tseg</span><span class="o">&gt;&gt;</span><span class="n">PMD_SHIFT</span><span class="p">)</span> <span class="o">&lt;</span>
				<span class="p">(</span><span class="n">max_low_pfn_mapped</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">PMD_SHIFT</span><span class="o">-</span><span class="n">PAGE_SHIFT</span><span class="p">))</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">tseg</span><span class="o">&gt;&gt;</span><span class="n">PMD_SHIFT</span><span class="p">)</span> <span class="o">&lt;</span>
				<span class="p">(</span><span class="n">max_pfn_mapped</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">PMD_SHIFT</span><span class="o">-</span><span class="n">PAGE_SHIFT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">tseg</span><span class="o">&gt;&gt;</span><span class="n">PMD_SHIFT</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1ULL</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">PMD_SHIFT</span><span class="p">))))</span>
				<span class="n">set_memory_4k</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">tseg</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Family 0x12 and above processors have APIC timer</span>
<span class="cm">	 * running in deep C states.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">&gt;</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_ARAT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable GART TLB Walk Errors on Fam10h. We do this here</span>
<span class="cm">	 * because this is always needed when GART is enabled, even in a</span>
<span class="cm">	 * kernel which has no MCE support built in.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * BIOS should disable GartTlbWlk Errors themself. If</span>
<span class="cm">		 * it doesn&#39;t do it here as suggested by the BKDG.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Fixes: https://bugzilla.kernel.org/show_bug.cgi?id=33012</span>
<span class="cm">		 */</span>
		<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">rdmsrl_safe</span><span class="p">(</span><span class="n">MSR_AMD64_MCx_MASK</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">MSR_AMD64_MCx_MASK</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rdmsr_safe</span><span class="p">(</span><span class="n">MSR_AMD64_PATCH_LEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">microcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">amd_size_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* AMD errata T13 (order #21922) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Duron Rev A0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="cm">/* Tbird rev A1/A2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cpu_dev</span> <span class="n">__cpuinitconst</span> <span class="n">amd_cpu_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">c_vendor</span>	<span class="o">=</span> <span class="s">&quot;AMD&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_ident</span>	<span class="o">=</span> <span class="p">{</span> <span class="s">&quot;AuthenticAMD&quot;</span> <span class="p">},</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="p">.</span><span class="n">c_models</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">X86_VENDOR_AMD</span><span class="p">,</span> <span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">model_names</span> <span class="o">=</span>
		  <span class="p">{</span>
			  <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;486 DX/2&quot;</span><span class="p">,</span>
			  <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;486 DX/2-WB&quot;</span><span class="p">,</span>
			  <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;486 DX/4&quot;</span><span class="p">,</span>
			  <span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;486 DX/4-WB&quot;</span><span class="p">,</span>
			  <span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Am5x86-WT&quot;</span><span class="p">,</span>
			  <span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Am5x86-WB&quot;</span>
		  <span class="p">}</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">c_size_cache</span>	<span class="o">=</span> <span class="n">amd_size_cache</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">c_early_init</span>   <span class="o">=</span> <span class="n">early_init_amd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_bsp_init</span>	<span class="o">=</span> <span class="n">bsp_init_amd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_init</span>		<span class="o">=</span> <span class="n">init_amd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_x86_vendor</span>	<span class="o">=</span> <span class="n">X86_VENDOR_AMD</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">cpu_dev_register</span><span class="p">(</span><span class="n">amd_cpu_dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * AMD errata checking</span>
<span class="cm"> *</span>
<span class="cm"> * Errata are defined as arrays of ints using the AMD_LEGACY_ERRATUM() or</span>
<span class="cm"> * AMD_OSVW_ERRATUM() macros. The latter is intended for newer errata that</span>
<span class="cm"> * have an OSVW id assigned, which it takes as first argument. Both take a</span>
<span class="cm"> * variable number of family-specific model-stepping ranges created by</span>
<span class="cm"> * AMD_MODEL_RANGE(). Each erratum also has to be declared as extern const</span>
<span class="cm"> * int[] in arch/x86/include/asm/processor.h.</span>
<span class="cm"> *</span>
<span class="cm"> * Example:</span>
<span class="cm"> *</span>
<span class="cm"> * const int amd_erratum_319[] =</span>
<span class="cm"> *	AMD_LEGACY_ERRATUM(AMD_MODEL_RANGE(0x10, 0x2, 0x1, 0x4, 0x2),</span>
<span class="cm"> *			   AMD_MODEL_RANGE(0x10, 0x8, 0x0, 0x8, 0x0),</span>
<span class="cm"> *			   AMD_MODEL_RANGE(0x10, 0x9, 0x0, 0x9, 0x0));</span>
<span class="cm"> */</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">amd_erratum_400</span><span class="p">[]</span> <span class="o">=</span>
	<span class="n">AMD_OSVW_ERRATUM</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">AMD_MODEL_RANGE</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">),</span>
			    <span class="n">AMD_MODEL_RANGE</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">));</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">amd_erratum_400</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">amd_erratum_383</span><span class="p">[]</span> <span class="o">=</span>
	<span class="n">AMD_OSVW_ERRATUM</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">AMD_MODEL_RANGE</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">));</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">amd_erratum_383</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">cpu_has_amd_erratum</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">erratum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">__this_cpu_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_info</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">osvw_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">erratum</span><span class="o">++</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">range</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ms</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If called early enough that current_cpu_data hasn&#39;t been initialized</span>
<span class="cm">	 * yet, fall back to boot_cpu_data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">boot_cpu_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86_vendor</span> <span class="o">!=</span> <span class="n">X86_VENDOR_AMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osvw_id</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">osvw_id</span> <span class="o">&lt;</span> <span class="mi">65536</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cpu_has</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">X86_FEATURE_OSVW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">osvw_len</span><span class="p">;</span>

		<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_AMD64_OSVW_ID_LENGTH</span><span class="p">,</span> <span class="n">osvw_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osvw_id</span> <span class="o">&lt;</span> <span class="n">osvw_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">osvw_bits</span><span class="p">;</span>

			<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_AMD64_OSVW_STATUS</span> <span class="o">+</span> <span class="p">(</span><span class="n">osvw_id</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">),</span>
			    <span class="n">osvw_bits</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">osvw_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">osvw_id</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* OSVW unavailable or ID unknown, match family-model-stepping range */</span>
	<span class="n">ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86_mask</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">range</span> <span class="o">=</span> <span class="o">*</span><span class="n">erratum</span><span class="o">++</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="n">AMD_MODEL_RANGE_FAMILY</span><span class="p">(</span><span class="n">range</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ms</span> <span class="o">&gt;=</span> <span class="n">AMD_MODEL_RANGE_START</span><span class="p">(</span><span class="n">range</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ms</span> <span class="o">&lt;=</span> <span class="n">AMD_MODEL_RANGE_END</span><span class="p">(</span><span class="n">range</span><span class="p">)))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpu_has_amd_erratum</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
