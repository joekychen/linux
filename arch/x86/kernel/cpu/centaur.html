<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › cpu › centaur.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>centaur.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/e820.h&gt;</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#include &lt;asm/msr.h&gt;</span>

<span class="cp">#include &quot;cpu.h&quot;</span>

<span class="cp">#ifdef CONFIG_X86_OOSTORE</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">__cpuinit</span> <span class="nf">power2</span><span class="p">(</span><span class="n">u32</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">s</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Set up an actual MCR</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">centaur_mcr_insert</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="n">hi</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFF</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* Size is a power of 2 so this makes a mask */</span>
	<span class="n">lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xFFF</span><span class="p">;</span>		<span class="cm">/* Remove the ctrl value bits */</span>
	<span class="n">lo</span> <span class="o">|=</span> <span class="n">key</span><span class="p">;</span>		<span class="cm">/* Attribute we wish to set */</span>
	<span class="n">wrmsr</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="n">MSR_IDT_MCR0</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">mtrr_centaur_report_mcr</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>	<span class="cm">/* Tell the mtrr driver */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Figure what we can cover with MCR&#39;s</span>
<span class="cm"> *</span>
<span class="cm"> * Shortcut: We know you can&#39;t put 4Gig of RAM on a winchip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">__cpuinit</span> <span class="nf">ramtop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clip</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e820</span><span class="p">.</span><span class="n">nr_map</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t MCR over reserved space. Ignore the ISA hole</span>
<span class="cm">		 * we frob around that catastrophe already</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">E820_RESERVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0x100000UL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">clip</span><span class="p">)</span>
				<span class="n">clip</span> <span class="o">=</span> <span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">top</span><span class="p">)</span>
			<span class="n">top</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Everything below &#39;top&#39; should be RAM except for the ISA hole.</span>
<span class="cm">	 * Because of the limited MCR&#39;s we want to map NV/ACPI into our</span>
<span class="cm">	 * MCR range for gunk in RAM</span>
<span class="cm">	 *</span>
<span class="cm">	 * Clip might cause us to MCR insufficient RAM but that is an</span>
<span class="cm">	 * acceptable failure mode and should only bite obscure boxes with</span>
<span class="cm">	 * a VESA hole at 15Mb</span>
<span class="cm">	 *</span>
<span class="cm">	 * The second case Clip sometimes kicks in is when the EBDA is marked</span>
<span class="cm">	 * as reserved. Again we fail safe with reasonable results</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">&gt;</span> <span class="n">clip</span><span class="p">)</span>
		<span class="n">top</span> <span class="o">=</span> <span class="n">clip</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">top</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute a set of MCR&#39;s to give maximum coverage</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">centaur_mcr_compute</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">ramtop</span><span class="p">();</span>
	<span class="n">u32</span> <span class="n">root</span> <span class="o">=</span> <span class="n">power2</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">base</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">top</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">floor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ct</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">high</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">low</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Find the largest block we will fill going upwards</span>
<span class="cm">		 */</span>
		<span class="n">high</span> <span class="o">=</span> <span class="n">power2</span><span class="p">(</span><span class="n">mem</span><span class="o">-</span><span class="n">top</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Find the largest block we will fill going downwards</span>
<span class="cm">		 */</span>
		<span class="n">low</span> <span class="o">=</span> <span class="n">base</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t fill below 1Mb going downwards as there</span>
<span class="cm">		 * is an ISA hole in the way.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
			<span class="n">low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * See how much space we could cover by filling below</span>
<span class="cm">		 * the ISA hole</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">floor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fspace</span> <span class="o">=</span> <span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">floor</span> <span class="o">==</span> <span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
			<span class="n">fspace</span> <span class="o">=</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>

		<span class="cm">/* And forget ROM space */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now install the largest coverage we get</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fspace</span> <span class="o">&gt;</span> <span class="n">high</span> <span class="o">&amp;&amp;</span> <span class="n">fspace</span> <span class="o">&gt;</span> <span class="n">low</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">centaur_mcr_insert</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">floor</span><span class="p">,</span> <span class="n">fspace</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
			<span class="n">floor</span> <span class="o">+=</span> <span class="n">fspace</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">&gt;</span> <span class="n">low</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">centaur_mcr_insert</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
			<span class="n">top</span> <span class="o">+=</span> <span class="n">high</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">base</span> <span class="o">-=</span> <span class="n">low</span><span class="p">;</span>
			<span class="n">centaur_mcr_insert</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ct</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We loaded ct values. We now need to set the mask. The caller</span>
<span class="cm">	 * must do this bit.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">ct</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">centaur_create_optimal_mcr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate up to 6 mcrs to mark as much of ram as possible</span>
<span class="cm">	 * as write combining and weak write ordered.</span>
<span class="cm">	 *</span>
<span class="cm">	 * To experiment with: Linux never uses stack operations for</span>
<span class="cm">	 * mmio spaces so we could globally enable stack operation wc</span>
<span class="cm">	 *</span>
<span class="cm">	 * Load the registers with type 31 - full write combining, all</span>
<span class="cm">	 * writes weakly ordered.</span>
<span class="cm">	 */</span>
	<span class="n">used</span> <span class="o">=</span> <span class="n">centaur_mcr_compute</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wipe unused MCRs</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">used</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">winchip2_create_optimal_mcr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate up to 6 mcrs to mark as much of ram as possible</span>
<span class="cm">	 * as write combining, weak store ordered.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Load the registers with type 25</span>
<span class="cm">	 *	8	-	weak write ordering</span>
<span class="cm">	 *	16	-	weak read ordering</span>
<span class="cm">	 *	1	-	write combining</span>
<span class="cm">	 */</span>
	<span class="n">used</span> <span class="o">=</span> <span class="n">centaur_mcr_compute</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mark the registers we are using.</span>
<span class="cm">	 */</span>
	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lo</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">9</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
	<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wipe unused MCRs</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">used</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the MCR key on the Winchip 2.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">winchip2_unprotect_mcr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1C0</span><span class="p">;</span>	<span class="cm">/* blank bits 8-6 */</span>
	<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span><span class="o">&gt;&gt;</span><span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">|=</span> <span class="n">key</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">;</span>	<span class="cm">/* replace with unlock key */</span>
	<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">winchip2_protect_mcr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1C0</span><span class="p">;</span>	<span class="cm">/* blank bits 8-6 */</span>
	<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_OOSTORE */</span><span class="cp"></span>

<span class="cp">#define ACE_PRESENT	(1 &lt;&lt; 6)</span>
<span class="cp">#define ACE_ENABLED	(1 &lt;&lt; 7)</span>
<span class="cp">#define ACE_FCR		(1 &lt;&lt; 28)	</span><span class="cm">/* MSR_VIA_FCR */</span><span class="cp"></span>

<span class="cp">#define RNG_PRESENT	(1 &lt;&lt; 2)</span>
<span class="cp">#define RNG_ENABLED	(1 &lt;&lt; 3)</span>
<span class="cp">#define RNG_ENABLE	(1 &lt;&lt; 6)	</span><span class="cm">/* MSR_VIA_RNG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">init_c3</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>  <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="cm">/* Test for Centaur Extended Feature Flags presence */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpuid_eax</span><span class="p">(</span><span class="mh">0xC0000000</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0xC0000001</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">cpuid_edx</span><span class="p">(</span><span class="mh">0xC0000001</span><span class="p">);</span>

		<span class="cm">/* enable ACE unit, if present and disabled */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACE_PRESENT</span> <span class="o">|</span> <span class="n">ACE_ENABLED</span><span class="p">))</span> <span class="o">==</span> <span class="n">ACE_PRESENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_VIA_FCR</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="n">lo</span> <span class="o">|=</span> <span class="n">ACE_FCR</span><span class="p">;</span>		<span class="cm">/* enable ACE unit */</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_VIA_FCR</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CPU: Enabled ACE h/w crypto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* enable RNG unit, if present and disabled */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RNG_PRESENT</span> <span class="o">|</span> <span class="n">RNG_ENABLED</span><span class="p">))</span> <span class="o">==</span> <span class="n">RNG_PRESENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_VIA_RNG</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="n">lo</span> <span class="o">|=</span> <span class="n">RNG_ENABLE</span><span class="p">;</span>	<span class="cm">/* enable RNG unit */</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_VIA_RNG</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CPU: Enabled h/w RNG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* store Centaur Extended Feature Flags as</span>
<span class="cm">		 * word 5 of the CPU capability bit array</span>
<span class="cm">		 */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_capability</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpuid_edx</span><span class="p">(</span><span class="mh">0xC0000001</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="cm">/* Cyrix III family needs CX8 &amp; PGE explicitly enabled. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&lt;=</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_VIA_FCR</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="n">lo</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_VIA_FCR</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_CX8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Before Nehemiah, the C3&#39;s had 3dNOW! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_3DNOW</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x6</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;=</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_cache_alignment</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_clflush_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_REP_GOOD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cpu_detect_cache_sizes</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
		<span class="n">ECX8</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">EIERRINT</span>	<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span>
		<span class="n">DPM</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">,</span>
		<span class="n">DMCE</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">DSTPCLK</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">,</span>
		<span class="n">ELINEAR</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">,</span>
		<span class="n">DSMC</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">,</span>
		<span class="n">DTLOCK</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">EDCTLB</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">EMMX</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">,</span>
		<span class="n">DPDC</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">,</span>
		<span class="n">EBRPRED</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">,</span>
		<span class="n">DIC</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">,</span>
		<span class="n">DDC</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">,</span>
		<span class="n">DNA</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">,</span>
		<span class="n">ERETSTK</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">,</span>
		<span class="n">E2MMX</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">19</span><span class="p">,</span>
		<span class="n">EAMD3D</span>		<span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">early_init_centaur</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* Emulate MTRRs using Centaur&#39;s MCR. */</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_CENTAUR_MCR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;=</span> <span class="mh">0xf</span><span class="p">)</span>
			<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_CONSTANT_TSC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_SYSENTER32</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">init_centaur</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">fcr_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">fcr_clr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">newlo</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">dd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bit 31 in normal CPUID used for nonstandard 3DNow ID;</span>
<span class="cm">	 * 3DNow is IDd by bit 31 in extended CPUID (1*32+31) anyway</span>
<span class="cm">	 */</span>
	<span class="n">clear_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="mi">32</span><span class="o">+</span><span class="mi">31</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">early_init_centaur</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;C6&quot;</span><span class="p">;</span>
			<span class="n">fcr_set</span> <span class="o">=</span> <span class="n">ECX8</span><span class="o">|</span><span class="n">DSMC</span><span class="o">|</span><span class="n">EDCTLB</span><span class="o">|</span><span class="n">EMMX</span><span class="o">|</span><span class="n">ERETSTK</span><span class="p">;</span>
			<span class="n">fcr_clr</span> <span class="o">=</span> <span class="n">DPDC</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Disabling bugged TSC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clear_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_TSC</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86_OOSTORE</span>
			<span class="n">centaur_create_optimal_mcr</span><span class="p">();</span>
			<span class="cm">/*</span>
<span class="cm">			 * Enable:</span>
<span class="cm">			 *	write combining on non-stack, non-string</span>
<span class="cm">			 *	write combining on string, all types</span>
<span class="cm">			 *	weak write ordering</span>
<span class="cm">			 *</span>
<span class="cm">			 * The C6 original lacks weak read order</span>
<span class="cm">			 *</span>
<span class="cm">			 * Note 0x120 is write only on Winchip 1</span>
<span class="cm">			 */</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="mh">0x01F0001F</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="nl">default:</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;2&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7</span> <span class="p">...</span> <span class="mi">9</span>:
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;2A&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">10</span> <span class="p">...</span> <span class="mi">15</span>:
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;2B&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fcr_set</span> <span class="o">=</span> <span class="n">ECX8</span><span class="o">|</span><span class="n">DSMC</span><span class="o">|</span><span class="n">DTLOCK</span><span class="o">|</span><span class="n">EMMX</span><span class="o">|</span><span class="n">EBRPRED</span><span class="o">|</span><span class="n">ERETSTK</span><span class="o">|</span>
				  <span class="n">E2MMX</span><span class="o">|</span><span class="n">EAMD3D</span><span class="p">;</span>
			<span class="n">fcr_clr</span> <span class="o">=</span> <span class="n">DPDC</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_OOSTORE</span>
			<span class="n">winchip2_unprotect_mcr</span><span class="p">();</span>
			<span class="n">winchip2_create_optimal_mcr</span><span class="p">();</span>
			<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Enable:</span>
<span class="cm">			 *	write combining on non-stack, non-string</span>
<span class="cm">			 *	write combining on string, all types</span>
<span class="cm">			 *	weak write ordering</span>
<span class="cm">			 */</span>
			<span class="n">lo</span> <span class="o">|=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="n">winchip2_protect_mcr</span><span class="p">();</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;3&quot;</span><span class="p">;</span>
			<span class="n">fcr_set</span> <span class="o">=</span> <span class="n">ECX8</span><span class="o">|</span><span class="n">DSMC</span><span class="o">|</span><span class="n">DTLOCK</span><span class="o">|</span><span class="n">EMMX</span><span class="o">|</span><span class="n">EBRPRED</span><span class="o">|</span><span class="n">ERETSTK</span><span class="o">|</span>
				  <span class="n">E2MMX</span><span class="o">|</span><span class="n">EAMD3D</span><span class="p">;</span>
			<span class="n">fcr_clr</span> <span class="o">=</span> <span class="n">DPDC</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_OOSTORE</span>
			<span class="n">winchip2_unprotect_mcr</span><span class="p">();</span>
			<span class="n">winchip2_create_optimal_mcr</span><span class="p">();</span>
			<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Enable:</span>
<span class="cm">			 *	write combining on non-stack, non-string</span>
<span class="cm">			 *	write combining on string, all types</span>
<span class="cm">			 *	weak write ordering</span>
<span class="cm">			 */</span>
			<span class="n">lo</span> <span class="o">|=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_MCR_CTRL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="n">winchip2_protect_mcr</span><span class="p">();</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;??&quot;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IDT_FCR1</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="n">newlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span><span class="o">|</span><span class="n">fcr_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">fcr_clr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">newlo</span> <span class="o">!=</span> <span class="n">lo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Centaur FCR was 0x%X now 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">lo</span><span class="p">,</span> <span class="n">newlo</span><span class="p">);</span>
			<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IDT_FCR1</span><span class="p">,</span> <span class="n">newlo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Centaur FCR is 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Emulate MTRRs using Centaur&#39;s MCR. */</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_CENTAUR_MCR</span><span class="p">);</span>
		<span class="cm">/* Report CX8 */</span>
		<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_CX8</span><span class="p">);</span>
		<span class="cm">/* Set 3DNow! on Winchip 2 and above. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_3DNOW</span><span class="p">);</span>
		<span class="cm">/* See if we can find out some more. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpuid_eax</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x80000005</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Yes, we can. */</span>
			<span class="n">cpuid</span><span class="p">(</span><span class="mh">0x80000005</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="p">);</span>
			<span class="cm">/* Add L1 data and code cache sizes. */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_cache_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">dd</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model_id</span><span class="p">,</span> <span class="s">&quot;WinChip %s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">init_c3</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">set_cpu_cap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_LFENCE_RDTSC</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__cpuinit</span>
<span class="nf">centaur_size_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="cm">/* VIA C3 CPUs (670-68F) need further shifting. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)))</span>
		<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * There&#39;s also an erratum in Nehemiah stepping 1, which</span>
<span class="cm">	 * returns &#39;65KB&#39; instead of &#39;64KB&#39;</span>
<span class="cm">	 *  - Note, it seems this may only be in engineering samples.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">65</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cpu_dev</span> <span class="n">__cpuinitconst</span> <span class="n">centaur_cpu_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">c_vendor</span>	<span class="o">=</span> <span class="s">&quot;Centaur&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_ident</span>	<span class="o">=</span> <span class="p">{</span> <span class="s">&quot;CentaurHauls&quot;</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">c_early_init</span>	<span class="o">=</span> <span class="n">early_init_centaur</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_init</span>		<span class="o">=</span> <span class="n">init_centaur</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_size_cache</span>	<span class="o">=</span> <span class="n">centaur_size_cache</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_x86_vendor</span>	<span class="o">=</span> <span class="n">X86_VENDOR_CENTAUR</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">cpu_dev_register</span><span class="p">(</span><span class="n">centaur_cpu_dev</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
