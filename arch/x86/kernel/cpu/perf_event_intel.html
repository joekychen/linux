<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › cpu › perf_event_intel.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>perf_event_intel.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Per core/cpu state</span>
<span class="cm"> *</span>
<span class="cm"> * Used to coordinate shared registers between HT threads or</span>
<span class="cm"> * among events on a single PMU.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &lt;asm/hardirq.h&gt;</span>
<span class="cp">#include &lt;asm/apic.h&gt;</span>

<span class="cp">#include &quot;perf_event.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Intel PerfMon, used on Core and later.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_MAX</span><span class="p">]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x003c</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x00c0</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x4f2e</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x412e</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x00c4</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x00c5</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_BUS_CYCLES</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x013c</span><span class="p">,</span>
  <span class="p">[</span><span class="n">PERF_COUNT_HW_REF_CPU_CYCLES</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x0300</span><span class="p">,</span> <span class="cm">/* pseudo-encoding */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">intel_core_event_constraints</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* FP_ASSIST */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* MUL */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* DIV */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* CYCLES_DIV_BUSY */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* DELAYED_BYPASS */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* FP_COMP_INSTR_RET */</span>
	<span class="n">EVENT_CONSTRAINT_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">intel_core2_event_constraints</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x00c0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* INST_RETIRED.ANY */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x003c</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.CORE */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x0300</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.REF */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* FP_COMP_OPS_EXE */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* FP_ASSIST */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* MUL */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* DIV */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* CYCLES_DIV_BUSY */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* IDLE_DURING_DIV */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* DELAYED_BYPASS */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* RS_UOPS_DISPATCH_CYCLES */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* ITLB_MISS_RETIRED (T30-9) */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* MEM_LOAD_RETIRED */</span>
	<span class="n">EVENT_CONSTRAINT_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">intel_nehalem_event_constraints</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x00c0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* INST_RETIRED.ANY */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x003c</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.CORE */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x0300</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.REF */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* L1D_CACHE_LD */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* L1D_CACHE_ST */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* L1D_CACHE_LOCK */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* L1D_ALL_REF */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* L1D_PEND_MISS */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* L1D_PREFETCH */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* L1D */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* CACHE_LOCK_CYCLES */</span>
	<span class="n">EVENT_CONSTRAINT_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">extra_reg</span> <span class="n">intel_nehalem_extra_regs</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">INTEL_EVENT_EXTRA_REG</span><span class="p">(</span><span class="mh">0xb7</span><span class="p">,</span> <span class="n">MSR_OFFCORE_RSP_0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">RSP_0</span><span class="p">),</span>
	<span class="n">EVENT_EXTRA_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">intel_westmere_event_constraints</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x00c0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* INST_RETIRED.ANY */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x003c</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.CORE */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x0300</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.REF */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* L1D */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* OFFCORE_REQUESTS_OUTSTANDING */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* CACHE_LOCK_CYCLES */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span> <span class="cm">/* SNOOPQ_REQUEST_OUTSTANDING */</span>
	<span class="n">EVENT_CONSTRAINT_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">intel_snb_event_constraints</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x00c0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* INST_RETIRED.ANY */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x003c</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.CORE */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x0300</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.REF */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">),</span> <span class="cm">/* L1D_PEND_MISS.PENDING */</span>
	<span class="n">INTEL_UEVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x01c0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span> <span class="cm">/* INST_RETIRED.PREC_DIST */</span>
	<span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">),</span> <span class="cm">/* MEM_TRANS_RETIRED.LOAD_LATENCY */</span>
	<span class="n">EVENT_CONSTRAINT_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">extra_reg</span> <span class="n">intel_westmere_extra_regs</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">INTEL_EVENT_EXTRA_REG</span><span class="p">(</span><span class="mh">0xb7</span><span class="p">,</span> <span class="n">MSR_OFFCORE_RSP_0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">RSP_0</span><span class="p">),</span>
	<span class="n">INTEL_EVENT_EXTRA_REG</span><span class="p">(</span><span class="mh">0xbb</span><span class="p">,</span> <span class="n">MSR_OFFCORE_RSP_1</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">RSP_1</span><span class="p">),</span>
	<span class="n">EVENT_EXTRA_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">intel_v1_event_constraints</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">EVENT_CONSTRAINT_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="n">intel_gen_event_constraints</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x00c0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* INST_RETIRED.ANY */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x003c</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.CORE */</span>
	<span class="n">FIXED_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x0300</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* CPU_CLK_UNHALTED.REF */</span>
	<span class="n">EVENT_CONSTRAINT_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">extra_reg</span> <span class="n">intel_snb_extra_regs</span><span class="p">[]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTEL_EVENT_EXTRA_REG</span><span class="p">(</span><span class="mh">0xb7</span><span class="p">,</span> <span class="n">MSR_OFFCORE_RSP_0</span><span class="p">,</span> <span class="mh">0x3fffffffffull</span><span class="p">,</span> <span class="n">RSP_0</span><span class="p">),</span>
	<span class="n">INTEL_EVENT_EXTRA_REG</span><span class="p">(</span><span class="mh">0xbb</span><span class="p">,</span> <span class="n">MSR_OFFCORE_RSP_1</span><span class="p">,</span> <span class="mh">0x3fffffffffull</span><span class="p">,</span> <span class="n">RSP_1</span><span class="p">),</span>
	<span class="n">EVENT_EXTRA_END</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">intel_pmu_event_map</span><span class="p">(</span><span class="kt">int</span> <span class="n">hw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">hw_event</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">snb_hw_cache_event_ids</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0xf1d0</span><span class="p">,</span> <span class="cm">/* MEM_UOP_RETIRED.LOADS        */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0151</span><span class="p">,</span> <span class="cm">/* L1D.REPLACEMENT              */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0xf2d0</span><span class="p">,</span> <span class="cm">/* MEM_UOP_RETIRED.STORES       */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0851</span><span class="p">,</span> <span class="cm">/* L1D.ALL_M_REPLACEMENT        */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x024e</span><span class="p">,</span> <span class="cm">/* HW_PRE_REQ.DL1_MISS          */</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1I</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0280</span><span class="p">,</span> <span class="cm">/* ICACHE.MISSES */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">LL</span>  <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_DATA.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_DATA.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_RFO.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_RFO.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.PREFETCH.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.PREFETCH.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x81d0</span><span class="p">,</span> <span class="cm">/* MEM_UOP_RETIRED.ALL_LOADS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0108</span><span class="p">,</span> <span class="cm">/* DTLB_LOAD_MISSES.CAUSES_A_WALK */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x82d0</span><span class="p">,</span> <span class="cm">/* MEM_UOP_RETIRED.ALL_STORES */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0149</span><span class="p">,</span> <span class="cm">/* DTLB_STORE_MISSES.MISS_CAUSES_A_WALK */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x1085</span><span class="p">,</span> <span class="cm">/* ITLB_MISSES.STLB_HIT         */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0185</span><span class="p">,</span> <span class="cm">/* ITLB_MISSES.CAUSES_A_WALK    */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">BPU</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c4</span><span class="p">,</span> <span class="cm">/* BR_INST_RETIRED.ALL_BRANCHES */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c5</span><span class="p">,</span> <span class="cm">/* BR_MISP_RETIRED.ALL_BRANCHES */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>

<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">westmere_hw_cache_event_ids</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x010b</span><span class="p">,</span> <span class="cm">/* MEM_INST_RETIRED.LOADS       */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0151</span><span class="p">,</span> <span class="cm">/* L1D.REPL                     */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x020b</span><span class="p">,</span> <span class="cm">/* MEM_INST_RETURED.STORES      */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0251</span><span class="p">,</span> <span class="cm">/* L1D.M_REPL                   */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x014e</span><span class="p">,</span> <span class="cm">/* L1D_PREFETCH.REQUESTS        */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x024e</span><span class="p">,</span> <span class="cm">/* L1D_PREFETCH.MISS            */</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1I</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0380</span><span class="p">,</span> <span class="cm">/* L1I.READS                    */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0280</span><span class="p">,</span> <span class="cm">/* L1I.MISSES                   */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">LL</span>  <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_DATA.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_DATA.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * Use RFO, not WRITEBACK, because a write miss would typically occur</span>
<span class="cm">	 * on RFO.</span>
<span class="cm">	 */</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_RFO.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_RFO.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.PREFETCH.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.PREFETCH.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x010b</span><span class="p">,</span> <span class="cm">/* MEM_INST_RETIRED.LOADS       */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0108</span><span class="p">,</span> <span class="cm">/* DTLB_LOAD_MISSES.ANY         */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x020b</span><span class="p">,</span> <span class="cm">/* MEM_INST_RETURED.STORES      */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x010c</span><span class="p">,</span> <span class="cm">/* MEM_STORE_RETIRED.DTLB_MISS  */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01c0</span><span class="p">,</span> <span class="cm">/* INST_RETIRED.ANY_P           */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0185</span><span class="p">,</span> <span class="cm">/* ITLB_MISSES.ANY              */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">BPU</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c4</span><span class="p">,</span> <span class="cm">/* BR_INST_RETIRED.ALL_BRANCHES */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x03e8</span><span class="p">,</span> <span class="cm">/* BPU_CLEARS.ANY               */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Nehalem/Westmere MSR_OFFCORE_RESPONSE bits;</span>
<span class="cm"> * See IA32 SDM Vol 3B 30.6.1.3</span>
<span class="cm"> */</span>

<span class="cp">#define NHM_DMND_DATA_RD	(1 &lt;&lt; 0)</span>
<span class="cp">#define NHM_DMND_RFO		(1 &lt;&lt; 1)</span>
<span class="cp">#define NHM_DMND_IFETCH		(1 &lt;&lt; 2)</span>
<span class="cp">#define NHM_DMND_WB		(1 &lt;&lt; 3)</span>
<span class="cp">#define NHM_PF_DATA_RD		(1 &lt;&lt; 4)</span>
<span class="cp">#define NHM_PF_DATA_RFO		(1 &lt;&lt; 5)</span>
<span class="cp">#define NHM_PF_IFETCH		(1 &lt;&lt; 6)</span>
<span class="cp">#define NHM_OFFCORE_OTHER	(1 &lt;&lt; 7)</span>
<span class="cp">#define NHM_UNCORE_HIT		(1 &lt;&lt; 8)</span>
<span class="cp">#define NHM_OTHER_CORE_HIT_SNP	(1 &lt;&lt; 9)</span>
<span class="cp">#define NHM_OTHER_CORE_HITM	(1 &lt;&lt; 10)</span>
        			<span class="cm">/* reserved */</span>
<span class="cp">#define NHM_REMOTE_CACHE_FWD	(1 &lt;&lt; 12)</span>
<span class="cp">#define NHM_REMOTE_DRAM		(1 &lt;&lt; 13)</span>
<span class="cp">#define NHM_LOCAL_DRAM		(1 &lt;&lt; 14)</span>
<span class="cp">#define NHM_NON_DRAM		(1 &lt;&lt; 15)</span>

<span class="cp">#define NHM_LOCAL		(NHM_LOCAL_DRAM|NHM_REMOTE_CACHE_FWD)</span>
<span class="cp">#define NHM_REMOTE		(NHM_REMOTE_DRAM)</span>

<span class="cp">#define NHM_DMND_READ		(NHM_DMND_DATA_RD)</span>
<span class="cp">#define NHM_DMND_WRITE		(NHM_DMND_RFO|NHM_DMND_WB)</span>
<span class="cp">#define NHM_DMND_PREFETCH	(NHM_PF_DATA_RD|NHM_PF_DATA_RFO)</span>

<span class="cp">#define NHM_L3_HIT	(NHM_UNCORE_HIT|NHM_OTHER_CORE_HIT_SNP|NHM_OTHER_CORE_HITM)</span>
<span class="cp">#define NHM_L3_MISS	(NHM_NON_DRAM|NHM_LOCAL_DRAM|NHM_REMOTE_DRAM|NHM_REMOTE_CACHE_FWD)</span>
<span class="cp">#define NHM_L3_ACCESS	(NHM_L3_HIT|NHM_L3_MISS)</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">nehalem_hw_cache_extra_regs</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">LL</span>  <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_READ</span><span class="o">|</span><span class="n">NHM_L3_ACCESS</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_READ</span><span class="o">|</span><span class="n">NHM_L3_MISS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_WRITE</span><span class="o">|</span><span class="n">NHM_L3_ACCESS</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_WRITE</span><span class="o">|</span><span class="n">NHM_L3_MISS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_PREFETCH</span><span class="o">|</span><span class="n">NHM_L3_ACCESS</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_PREFETCH</span><span class="o">|</span><span class="n">NHM_L3_MISS</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_READ</span><span class="o">|</span><span class="n">NHM_LOCAL</span><span class="o">|</span><span class="n">NHM_REMOTE</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_READ</span><span class="o">|</span><span class="n">NHM_REMOTE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_WRITE</span><span class="o">|</span><span class="n">NHM_LOCAL</span><span class="o">|</span><span class="n">NHM_REMOTE</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_WRITE</span><span class="o">|</span><span class="n">NHM_REMOTE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_PREFETCH</span><span class="o">|</span><span class="n">NHM_LOCAL</span><span class="o">|</span><span class="n">NHM_REMOTE</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NHM_DMND_PREFETCH</span><span class="o">|</span><span class="n">NHM_REMOTE</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">nehalem_hw_cache_event_ids</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x010b</span><span class="p">,</span> <span class="cm">/* MEM_INST_RETIRED.LOADS       */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0151</span><span class="p">,</span> <span class="cm">/* L1D.REPL                     */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x020b</span><span class="p">,</span> <span class="cm">/* MEM_INST_RETURED.STORES      */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0251</span><span class="p">,</span> <span class="cm">/* L1D.M_REPL                   */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x014e</span><span class="p">,</span> <span class="cm">/* L1D_PREFETCH.REQUESTS        */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x024e</span><span class="p">,</span> <span class="cm">/* L1D_PREFETCH.MISS            */</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1I</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0380</span><span class="p">,</span> <span class="cm">/* L1I.READS                    */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0280</span><span class="p">,</span> <span class="cm">/* L1I.MISSES                   */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">LL</span>  <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_DATA.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_DATA.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * Use RFO, not WRITEBACK, because a write miss would typically occur</span>
<span class="cm">	 * on RFO.</span>
<span class="cm">	 */</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_RFO.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.ANY_RFO.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* OFFCORE_RESPONSE.PREFETCH.LOCAL_CACHE */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="cm">/* OFFCORE_RESPONSE.PREFETCH.ANY_LLC_MISS */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f40</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_LD.MESI   (alias)  */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0108</span><span class="p">,</span> <span class="cm">/* DTLB_LOAD_MISSES.ANY         */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f41</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_ST.MESI   (alias)  */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x010c</span><span class="p">,</span> <span class="cm">/* MEM_STORE_RETIRED.DTLB_MISS  */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01c0</span><span class="p">,</span> <span class="cm">/* INST_RETIRED.ANY_P           */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x20c8</span><span class="p">,</span> <span class="cm">/* ITLB_MISS_RETIRED            */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">BPU</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c4</span><span class="p">,</span> <span class="cm">/* BR_INST_RETIRED.ALL_BRANCHES */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x03e8</span><span class="p">,</span> <span class="cm">/* BPU_CLEARS.ANY               */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01b7</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">core2_hw_cache_event_ids</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f40</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_LD.MESI          */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0140</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_LD.I_STATE       */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f41</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_ST.MESI          */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0141</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_ST.I_STATE       */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x104e</span><span class="p">,</span> <span class="cm">/* L1D_PREFETCH.REQUESTS      */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1I</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span> <span class="cm">/* L1I.READS                  */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0081</span><span class="p">,</span> <span class="cm">/* L1I.MISSES                 */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">LL</span>  <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x4f29</span><span class="p">,</span> <span class="cm">/* L2_LD.MESI                 */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x4129</span><span class="p">,</span> <span class="cm">/* L2_LD.ISTATE               */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x4f2A</span><span class="p">,</span> <span class="cm">/* L2_ST.MESI                 */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x412A</span><span class="p">,</span> <span class="cm">/* L2_ST.ISTATE               */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f40</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_LD.MESI  (alias) */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0208</span><span class="p">,</span> <span class="cm">/* DTLB_MISSES.MISS_LD        */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f41</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_ST.MESI  (alias) */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0808</span><span class="p">,</span> <span class="cm">/* DTLB_MISSES.MISS_ST        */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c0</span><span class="p">,</span> <span class="cm">/* INST_RETIRED.ANY_P         */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x1282</span><span class="p">,</span> <span class="cm">/* ITLBMISSES                 */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">BPU</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c4</span><span class="p">,</span> <span class="cm">/* BR_INST_RETIRED.ANY        */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c5</span><span class="p">,</span> <span class="cm">/* BP_INST_RETIRED.MISPRED    */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">atom_hw_cache_event_ids</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x2140</span><span class="p">,</span> <span class="cm">/* L1D_CACHE.LD               */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x2240</span><span class="p">,</span> <span class="cm">/* L1D_CACHE.ST               */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">L1I</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0380</span><span class="p">,</span> <span class="cm">/* L1I.READS                  */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0280</span><span class="p">,</span> <span class="cm">/* L1I.MISSES                 */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">LL</span>  <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x4f29</span><span class="p">,</span> <span class="cm">/* L2_LD.MESI                 */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x4129</span><span class="p">,</span> <span class="cm">/* L2_LD.ISTATE               */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x4f2A</span><span class="p">,</span> <span class="cm">/* L2_ST.MESI                 */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x412A</span><span class="p">,</span> <span class="cm">/* L2_ST.ISTATE               */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x2140</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_LD.MESI  (alias) */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0508</span><span class="p">,</span> <span class="cm">/* DTLB_MISSES.MISS_LD        */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x2240</span><span class="p">,</span> <span class="cm">/* L1D_CACHE_ST.MESI  (alias) */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0608</span><span class="p">,</span> <span class="cm">/* DTLB_MISSES.MISS_ST        */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c0</span><span class="p">,</span> <span class="cm">/* INST_RETIRED.ANY_P         */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x0282</span><span class="p">,</span> <span class="cm">/* ITLB.MISSES                */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
 <span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">BPU</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c4</span><span class="p">,</span> <span class="cm">/* BR_INST_RETIRED.ANY        */</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00c5</span><span class="p">,</span> <span class="cm">/* BP_INST_RETIRED.MISPRED    */</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)</span>   <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
 <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">intel_pmu_needs_lbr_smpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* user explicitly requested branch sampling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_branch_stack</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* implicit branch sampling to correct PEBS skid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">intel_cap</span><span class="p">.</span><span class="n">pebs_trap</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">precise_ip</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_disable_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_CORE_PERF_GLOBAL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">X86_PMC_IDX_FIXED_BTS</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">active_mask</span><span class="p">))</span>
		<span class="n">intel_pmu_disable_bts</span><span class="p">();</span>

	<span class="n">intel_pmu_pebs_disable_all</span><span class="p">();</span>
	<span class="n">intel_pmu_lbr_disable_all</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_enable_all</span><span class="p">(</span><span class="kt">int</span> <span class="n">added</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="n">intel_pmu_pebs_enable_all</span><span class="p">();</span>
	<span class="n">intel_pmu_lbr_enable_all</span><span class="p">();</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_CORE_PERF_GLOBAL_CTRL</span><span class="p">,</span>
			<span class="n">x86_pmu</span><span class="p">.</span><span class="n">intel_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">intel_ctrl_guest_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">X86_PMC_IDX_FIXED_BTS</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">active_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span>
			<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">X86_PMC_IDX_FIXED_BTS</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">intel_pmu_enable_bts</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Workaround for:</span>
<span class="cm"> *   Intel Errata AAK100 (model 26)</span>
<span class="cm"> *   Intel Errata AAP53  (model 30)</span>
<span class="cm"> *   Intel Errata BD53   (model 44)</span>
<span class="cm"> *</span>
<span class="cm"> * The official story:</span>
<span class="cm"> *   These chips need to be &#39;reset&#39; when adding counters by programming the</span>
<span class="cm"> *   magic three (non-counting) events 0x4300B5, 0x4300D2, and 0x4300B1 either</span>
<span class="cm"> *   in sequence on the same PMC or on different PMCs.</span>
<span class="cm"> *</span>
<span class="cm"> * In practise it appears some of these events do in fact count, and</span>
<span class="cm"> * we need to programm all 4 events.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_nhm_workaround</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nhm_magic</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x4300B5</span><span class="p">,</span>
		<span class="mh">0x4300D2</span><span class="p">,</span>
		<span class="mh">0x4300B1</span><span class="p">,</span>
		<span class="mh">0x4300B1</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Errata requires below steps:</span>
<span class="cm">	 * 1) Clear MSR_IA32_PEBS_ENABLE and MSR_CORE_PERF_GLOBAL_CTRL;</span>
<span class="cm">	 * 2) Configure 4 PERFEVTSELx with the magic events and clear</span>
<span class="cm">	 *    the corresponding PMCx;</span>
<span class="cm">	 * 3) set bit0~bit3 of MSR_CORE_PERF_GLOBAL_CTRL;</span>
<span class="cm">	 * 4) Clear MSR_CORE_PERF_GLOBAL_CTRL;</span>
<span class="cm">	 * 5) Clear 4 pairs of ERFEVTSELx and PMCx;</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * The real steps we choose are a little different from above.</span>
<span class="cm">	 * A) To reduce MSR operations, we don&#39;t run step 1) as they</span>
<span class="cm">	 *    are already cleared before this function is called;</span>
<span class="cm">	 * B) Call x86_perf_event_update to save PMCx before configuring</span>
<span class="cm">	 *    PERFEVTSELx with magic number;</span>
<span class="cm">	 * C) With step 5), we do clear only when the PERFEVTSELx is</span>
<span class="cm">	 *    not used currently.</span>
<span class="cm">	 * D) Call x86_perf_event_set_period to restore PMCx;</span>
<span class="cm">	 */</span>

	<span class="cm">/* We always operate 4 pairs of PERF Counters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span>
			<span class="n">x86_perf_event_update</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_ARCH_PERFMON_EVENTSEL0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">nhm_magic</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_ARCH_PERFMON_PERFCTR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_CORE_PERF_GLOBAL_CTRL</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_CORE_PERF_GLOBAL_CTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">x86_perf_event_set_period</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
			<span class="n">__x86_pmu_enable_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_ARCH_PERFMON_EVENTSEL0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_nhm_enable_all</span><span class="p">(</span><span class="kt">int</span> <span class="n">added</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">added</span><span class="p">)</span>
		<span class="n">intel_pmu_nhm_workaround</span><span class="p">();</span>
	<span class="n">intel_pmu_enable_all</span><span class="p">(</span><span class="n">added</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">intel_pmu_get_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_CORE_PERF_GLOBAL_STATUS</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">intel_pmu_ack_status</span><span class="p">(</span><span class="n">u64</span> <span class="n">ack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_CORE_PERF_GLOBAL_OVF_CTRL</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_disable_fixed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="n">X86_PMC_IDX_FIXED</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ctrl_val</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span> <span class="n">ctrl_val</span><span class="p">);</span>
	<span class="n">ctrl_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span> <span class="n">ctrl_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_disable_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">==</span> <span class="n">X86_PMC_IDX_FIXED_BTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_pmu_disable_bts</span><span class="p">();</span>
		<span class="n">intel_pmu_drain_bts_buffer</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">intel_ctrl_guest_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">intel_ctrl_host_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * must disable before any actual event</span>
<span class="cm">	 * because any event may be combined with LBR</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pmu_needs_lbr_smpl</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		<span class="n">intel_pmu_lbr_disable</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">==</span> <span class="n">MSR_ARCH_PERFMON_FIXED_CTR_CTRL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_pmu_disable_fixed</span><span class="p">(</span><span class="n">hwc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x86_pmu_disable_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">precise_ip</span><span class="p">))</span>
		<span class="n">intel_pmu_pebs_disable</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_enable_fixed</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="n">X86_PMC_IDX_FIXED</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ctrl_val</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable IRQ generation (0x8),</span>
<span class="cm">	 * and enable ring-3 counting (0x2) and ring-0 counting (0x1)</span>
<span class="cm">	 * if requested:</span>
<span class="cm">	 */</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x8ULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">ARCH_PERFMON_EVENTSEL_USR</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">ARCH_PERFMON_EVENTSEL_OS</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ANY bit is supported in v3 and up</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">ARCH_PERFMON_EVENTSEL_ANY</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span> <span class="n">ctrl_val</span><span class="p">);</span>
	<span class="n">ctrl_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">ctrl_val</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span> <span class="n">ctrl_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_enable_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">==</span> <span class="n">X86_PMC_IDX_FIXED_BTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__this_cpu_read</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">.</span><span class="n">enabled</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">intel_pmu_enable_bts</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * must enabled before any actual event</span>
<span class="cm">	 * because any event may be combined with LBR</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pmu_needs_lbr_smpl</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		<span class="n">intel_pmu_lbr_enable</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span><span class="p">)</span>
		<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">intel_ctrl_guest_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_guest</span><span class="p">)</span>
		<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">intel_ctrl_host_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">==</span> <span class="n">MSR_ARCH_PERFMON_FIXED_CTR_CTRL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_pmu_enable_fixed</span><span class="p">(</span><span class="n">hwc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">precise_ip</span><span class="p">))</span>
		<span class="n">intel_pmu_pebs_enable</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="n">__x86_pmu_enable_event</span><span class="p">(</span><span class="n">hwc</span><span class="p">,</span> <span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Save and restart an expired event. Called by NMI contexts,</span>
<span class="cm"> * so it has to be careful about preempting normal event ops:</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">intel_pmu_save_and_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">x86_perf_event_update</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">x86_perf_event_set_period</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">debug_store</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="n">__this_cpu_read</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">.</span><span class="n">ds</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;clearing PMU state on CPU#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">x86_pmu_config_addr</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="mi">0ull</span><span class="p">);</span>
		<span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">x86_pmu_event_addr</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>  <span class="mi">0ull</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters_fixed</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">checking_wrmsrl</span><span class="p">(</span><span class="n">MSR_ARCH_PERFMON_FIXED_CTR0</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0ull</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="p">)</span>
		<span class="n">ds</span><span class="o">-&gt;</span><span class="n">bts_index</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">bts_buffer_base</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This handler is triggered by the local APIC, so the APIC IRQ handling</span>
<span class="cm"> * rules apply:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_pmu_handle_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_sample_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">loops</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span><span class="p">;</span>

	<span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some chipsets need to unmask the LVTPC in a particular spot</span>
<span class="cm">	 * inside the nmi handler.  As a result, the unmasking was pushed</span>
<span class="cm">	 * into all the nmi handlers.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This handler doesn&#39;t seem to have any issues with the unmasking</span>
<span class="cm">	 * so it was left at the top.</span>
<span class="cm">	 */</span>
	<span class="n">apic_write</span><span class="p">(</span><span class="n">APIC_LVTPC</span><span class="p">,</span> <span class="n">APIC_DM_NMI</span><span class="p">);</span>

	<span class="n">intel_pmu_disable_all</span><span class="p">();</span>
	<span class="n">handled</span> <span class="o">=</span> <span class="n">intel_pmu_drain_bts_buffer</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">intel_pmu_get_status</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_pmu_enable_all</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">again:</span>
	<span class="n">intel_pmu_ack_status</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">loops</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;perfevents: irq loop stuck!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">perf_event_print_debug</span><span class="p">();</span>
		<span class="n">intel_pmu_reset</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inc_irq_stat</span><span class="p">(</span><span class="n">apic_perf_irqs</span><span class="p">);</span>

	<span class="n">intel_pmu_lbr_read</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * PEBS overflow sets bit 62 in the global status register</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_clear_bit</span><span class="p">(</span><span class="mi">62</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">drain_pebs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">X86_PMC_IDX_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">bit</span><span class="p">];</span>

		<span class="n">handled</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">active_mask</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_pmu_save_and_restart</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">perf_sample_data_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_period</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">has_branch_stack</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
			<span class="n">data</span><span class="p">.</span><span class="n">br_stack</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">lbr_stack</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">perf_event_overflow</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">regs</span><span class="p">))</span>
			<span class="n">x86_pmu_stop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Repeat if there is more work to be done:</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">intel_pmu_get_status</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">intel_pmu_enable_all</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span>
<span class="nf">intel_bts_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hw_event</span><span class="p">,</span> <span class="n">bts_event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">freq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hw_event</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">INTEL_ARCH_EVENT_MASK</span><span class="p">;</span>
	<span class="n">bts_event</span> <span class="o">=</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_map</span><span class="p">(</span><span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hw_event</span> <span class="o">==</span> <span class="n">bts_event</span> <span class="o">&amp;&amp;</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">sample_period</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">bts_constraint</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_alt_er</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">er_flags</span> <span class="o">&amp;</span> <span class="n">ERF_HAS_RSP_1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">EXTRA_REG_RSP_0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EXTRA_REG_RSP_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">EXTRA_REG_RSP_1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EXTRA_REG_RSP_0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_fixup_er</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_reg</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">EXTRA_REG_RSP_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INTEL_ARCH_EVENT_MASK</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="mh">0x01b7</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_reg</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">MSR_OFFCORE_RSP_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">EXTRA_REG_RSP_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INTEL_ARCH_EVENT_MASK</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="mh">0x01bb</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_reg</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">MSR_OFFCORE_RSP_1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * manage allocation of shared extra msr for certain events</span>
<span class="cm"> *</span>
<span class="cm"> * sharing can be:</span>
<span class="cm"> * per-cpu: to be shared between the various events on a single PMU</span>
<span class="cm"> * per-core: per-cpu + shared by HT threads</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span>
<span class="nf">__intel_shared_reg_get_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hw_perf_event_extra</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">emptyconstraint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">er_account</span> <span class="o">*</span><span class="n">era</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * reg-&gt;alloc can be set due to existing state, so for fake cpuc we</span>
<span class="cm">	 * need to ignore this, otherwise we might fail to allocate proper fake</span>
<span class="cm">	 * state for this extra reg constraint. Also see the comment below.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">is_fake</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* call x86_get_event_constraint() */</span>

<span class="nl">again:</span>
	<span class="n">era</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * we use spin_lock_irqsave() to avoid lockdep issues when</span>
<span class="cm">	 * passing a fake cpuc</span>
<span class="cm">	 */</span>
	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">)</span> <span class="o">||</span> <span class="n">era</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">==</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * If its a fake cpuc -- as per validate_{group,event}() we</span>
<span class="cm">		 * shouldn&#39;t touch event state and we can avoid doing so</span>
<span class="cm">		 * since both will only call get_event_constraints() once</span>
<span class="cm">		 * on each event, this avoids the need for reg-&gt;alloc.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Not doing the ER fixup will only result in era-&gt;reg being</span>
<span class="cm">		 * wrong, but since we won&#39;t actually try and program hardware</span>
<span class="cm">		 * this isn&#39;t a problem either.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">is_fake</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span>
				<span class="n">intel_fixup_er</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * x86_schedule_events() can call get_event_constraints()</span>
<span class="cm">			 * multiple times on events in the case of incremental</span>
<span class="cm">			 * scheduling(). reg-&gt;alloc ensures we only do the ER</span>
<span class="cm">			 * allocation once.</span>
<span class="cm">			 */</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* lock in msr value */</span>
		<span class="n">era</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
		<span class="n">era</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

		<span class="cm">/* one more user */</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * need to call x86_get_event_constraint()</span>
<span class="cm">		 * to check if associated event has constraints</span>
<span class="cm">		 */</span>
		<span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">intel_alt_er</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__intel_shared_reg_put_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hw_perf_event_extra</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">er_account</span> <span class="o">*</span><span class="n">era</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only put constraint if extra reg was actually allocated. Also takes</span>
<span class="cm">	 * care of event which do not use an extra shared reg.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also, if this is a fake cpuc we shouldn&#39;t touch any event state</span>
<span class="cm">	 * (reg-&gt;alloc) and we don&#39;t care about leaving inconsistent cpuc state</span>
<span class="cm">	 * either since it&#39;ll be thrown out.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">||</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">is_fake</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">era</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>

	<span class="cm">/* one fewer user */</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>

	<span class="cm">/* allocate again next time */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span>
<span class="nf">intel_shared_regs_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_perf_event_extra</span> <span class="o">*</span><span class="n">xreg</span><span class="p">,</span> <span class="o">*</span><span class="n">breg</span><span class="p">;</span>

	<span class="n">xreg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_reg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xreg</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">EXTRA_REG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">__intel_shared_reg_get_constraints</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">xreg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">emptyconstraint</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">breg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">branch_reg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">breg</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">EXTRA_REG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">__intel_shared_reg_get_constraints</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">breg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">emptyconstraint</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__intel_shared_reg_put_constraints</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">xreg</span><span class="p">);</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span>
<span class="nf">x86_get_event_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_event_constraint</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cmask</span><span class="p">)</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">unconstrained</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span>
<span class="nf">intel_get_event_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_constraint</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">intel_bts_constraints</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">intel_pebs_constraints</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">intel_shared_regs_constraints</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">x86_get_event_constraints</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_put_shared_regs_event_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event_extra</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">extra_reg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">EXTRA_REG_NONE</span><span class="p">)</span>
		<span class="n">__intel_shared_reg_put_constraints</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">branch_reg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">EXTRA_REG_NONE</span><span class="p">)</span>
		<span class="n">__intel_shared_reg_put_constraints</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_put_event_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">intel_put_shared_regs_event_constraints</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pebs_aliases_core2</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">X86_RAW_EVENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x003c</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Use an alternative encoding for CPU_CLK_UNHALTED.THREAD_P</span>
<span class="cm">		 * (0x003c) so that we can use it with PEBS.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The regular CPU_CLK_UNHALTED.THREAD_P event (0x003c) isn&#39;t</span>
<span class="cm">		 * PEBS capable. However we can use INST_RETIRED.ANY_P</span>
<span class="cm">		 * (0x00c0), which is a PEBS capable event, to get the same</span>
<span class="cm">		 * count.</span>
<span class="cm">		 *</span>
<span class="cm">		 * INST_RETIRED.ANY_P counts the number of cycles that retires</span>
<span class="cm">		 * CNTMASK instructions. By setting CNTMASK to a value (16)</span>
<span class="cm">		 * larger than the maximum number of instructions that can be</span>
<span class="cm">		 * retired per cycle (4) and then inverting the condition, we</span>
<span class="cm">		 * count all cycles that retire 16 or less instructions, which</span>
<span class="cm">		 * is every cycle.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Thereby we gain a PEBS capable cycle counter.</span>
<span class="cm">		 */</span>
		<span class="n">u64</span> <span class="n">alt_config</span> <span class="o">=</span> <span class="n">X86_CONFIG</span><span class="p">(.</span><span class="n">event</span><span class="o">=</span><span class="mh">0xc0</span><span class="p">,</span> <span class="p">.</span><span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">cmask</span><span class="o">=</span><span class="mi">16</span><span class="p">);</span>

		<span class="n">alt_config</span> <span class="o">|=</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">X86_RAW_EVENT_MASK</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">alt_config</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pebs_aliases_snb</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">X86_RAW_EVENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x003c</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Use an alternative encoding for CPU_CLK_UNHALTED.THREAD_P</span>
<span class="cm">		 * (0x003c) so that we can use it with PEBS.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The regular CPU_CLK_UNHALTED.THREAD_P event (0x003c) isn&#39;t</span>
<span class="cm">		 * PEBS capable. However we can use UOPS_RETIRED.ALL</span>
<span class="cm">		 * (0x01c2), which is a PEBS capable event, to get the same</span>
<span class="cm">		 * count.</span>
<span class="cm">		 *</span>
<span class="cm">		 * UOPS_RETIRED.ALL counts the number of cycles that retires</span>
<span class="cm">		 * CNTMASK micro-ops. By setting CNTMASK to a value (16)</span>
<span class="cm">		 * larger than the maximum number of micro-ops that can be</span>
<span class="cm">		 * retired per cycle (4) and then inverting the condition, we</span>
<span class="cm">		 * count all cycles that retire 16 or less micro-ops, which</span>
<span class="cm">		 * is every cycle.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Thereby we gain a PEBS capable cycle counter.</span>
<span class="cm">		 */</span>
		<span class="n">u64</span> <span class="n">alt_config</span> <span class="o">=</span> <span class="n">X86_CONFIG</span><span class="p">(.</span><span class="n">event</span><span class="o">=</span><span class="mh">0xc2</span><span class="p">,</span> <span class="p">.</span><span class="n">umask</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">.</span><span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">cmask</span><span class="o">=</span><span class="mi">16</span><span class="p">);</span>

		<span class="n">alt_config</span> <span class="o">|=</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">X86_RAW_EVENT_MASK</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">alt_config</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_pmu_hw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">x86_pmu_hw_config</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">precise_ip</span> <span class="o">&amp;&amp;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_aliases</span><span class="p">)</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_aliases</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pmu_needs_lbr_smpl</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pmu_setup_lbr_filter</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PERF_TYPE_RAW</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">ARCH_PERFMON_EVENTSEL_ANY</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_paranoid_cpu</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="n">ARCH_PERFMON_EVENTSEL_ANY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">perf_guest_switch_msr</span> <span class="o">*</span><span class="nf">perf_guest_get_msrs</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">guest_get_msrs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">guest_get_msrs</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>
	<span class="o">*</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">perf_guest_get_msrs</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_guest_switch_msr</span> <span class="o">*</span><span class="nf">intel_guest_get_msrs</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">perf_guest_switch_msr</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">guest_switch_msrs</span><span class="p">;</span>

	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">msr</span> <span class="o">=</span> <span class="n">MSR_CORE_PERF_GLOBAL_CTRL</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">host</span> <span class="o">=</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">intel_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">intel_ctrl_guest_mask</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">guest</span> <span class="o">=</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">intel_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">intel_ctrl_host_mask</span><span class="p">;</span>

	<span class="o">*</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">arr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">perf_guest_switch_msr</span> <span class="o">*</span><span class="nf">core_guest_get_msrs</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">perf_guest_switch_msr</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">guest_switch_msrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>  <span class="p">{</span>
		<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

		<span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">msr</span> <span class="o">=</span> <span class="n">x86_pmu_config_addr</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">host</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">guest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">active_mask</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">host</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">guest</span> <span class="o">=</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">config</span> <span class="o">|</span> <span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span><span class="p">)</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">host</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_guest</span><span class="p">)</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">guest</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">nr</span> <span class="o">=</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">arr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_pmu_enable_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span><span class="p">)</span>
		<span class="n">x86_pmu_enable_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_pmu_enable_all</span><span class="p">(</span><span class="kt">int</span> <span class="n">added</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">active_mask</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">exclude_host</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">__x86_pmu_enable_event</span><span class="p">(</span><span class="n">hwc</span><span class="p">,</span> <span class="n">ARCH_PERFMON_EVENTSEL_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">event</span><span class="p">,</span>	<span class="s">&quot;config:0-7&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">umask</span><span class="p">,</span>	<span class="s">&quot;config:8-15&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span>	<span class="s">&quot;config:18&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span>	<span class="s">&quot;config:19&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">any</span><span class="p">,</span>	<span class="s">&quot;config:21&quot;</span>	<span class="p">);</span> <span class="cm">/* v3 + */</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span>	<span class="s">&quot;config:23&quot;</span>	<span class="p">);</span>
<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">cmask</span><span class="p">,</span>	<span class="s">&quot;config:24-31&quot;</span>	<span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">intel_arch_formats_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">format_attr_event</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_umask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_edge</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_pc</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_inv</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_cmask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_pmu</span> <span class="n">core_pmu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;core&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>		<span class="o">=</span> <span class="n">x86_pmu_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_all</span>		<span class="o">=</span> <span class="n">x86_pmu_disable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_all</span>		<span class="o">=</span> <span class="n">core_pmu_enable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>			<span class="o">=</span> <span class="n">core_pmu_enable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>		<span class="o">=</span> <span class="n">x86_pmu_disable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_config</span>		<span class="o">=</span> <span class="n">x86_pmu_hw_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">schedule_events</span>	<span class="o">=</span> <span class="n">x86_schedule_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eventsel</span>		<span class="o">=</span> <span class="n">MSR_ARCH_PERFMON_EVENTSEL0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">perfctr</span>		<span class="o">=</span> <span class="n">MSR_ARCH_PERFMON_PERFCTR0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_map</span>		<span class="o">=</span> <span class="n">intel_pmu_event_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_events</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intel_perfmon_event_map</span><span class="p">),</span>
	<span class="p">.</span><span class="n">apic</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * Intel PMCs cannot be accessed sanely above 32 bit width,</span>
<span class="cm">	 * so we install an artificial 1&lt;&lt;31 period regardless of</span>
<span class="cm">	 * the generic event period:</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">max_period</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_event_constraints</span>	<span class="o">=</span> <span class="n">intel_get_event_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_event_constraints</span>	<span class="o">=</span> <span class="n">intel_put_event_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_constraints</span>	<span class="o">=</span> <span class="n">intel_core_event_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">guest_get_msrs</span>		<span class="o">=</span> <span class="n">core_guest_get_msrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_attrs</span>		<span class="o">=</span> <span class="n">intel_arch_formats_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">intel_shared_regs</span> <span class="o">*</span><span class="nf">allocate_shared_regs</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_shared_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_shared_regs</span><span class="p">),</span>
			    <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * initialize the locks to keep lockdep happy</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EXTRA_REG_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">raw_spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">core_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">regs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_pmu_cpu_prepare</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">extra_regs</span> <span class="o">||</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">lbr_sel_map</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>

	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span> <span class="o">=</span> <span class="n">allocate_shared_regs</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_BAD</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_cpu_starting</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">core_id</span> <span class="o">=</span> <span class="n">topology_core_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">init_debug_store_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Deal with CPUs that don&#39;t clear their LBRs on power-up.</span>
<span class="cm">	 */</span>
	<span class="n">intel_pmu_lbr_reset</span><span class="p">();</span>

	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">lbr_sel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">er_flags</span> <span class="o">&amp;</span> <span class="n">ERF_NO_HT_SHARING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">topology_thread_cpumask</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">intel_shared_regs</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span>

			<span class="n">pc</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">i</span><span class="p">).</span><span class="n">shared_regs</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">&amp;&amp;</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">core_id</span> <span class="o">==</span> <span class="n">core_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">kfree_on_online</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="p">;</span>
				<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">core_id</span> <span class="o">=</span> <span class="n">core_id</span><span class="p">;</span>
		<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">lbr_sel_map</span><span class="p">)</span>
		<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">lbr_sel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">EXTRA_REG_LBR</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_cpu_dying</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_shared_regs</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span>

	<span class="n">pc</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">core_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="o">--</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
		<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">shared_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fini_debug_store_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pmu_flush_branch_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Intel LBR does not tag entries with the</span>
<span class="cm">	 * PID of the current task, then we need to</span>
<span class="cm">	 * flush it on ctxsw</span>
<span class="cm">	 * For now, we simply reset it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">lbr_nr</span><span class="p">)</span>
		<span class="n">intel_pmu_lbr_reset</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">PMU_FORMAT_ATTR</span><span class="p">(</span><span class="n">offcore_rsp</span><span class="p">,</span> <span class="s">&quot;config1:0-63&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">intel_arch3_formats_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">format_attr_event</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_umask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_edge</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_pc</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_any</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_inv</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">format_attr_cmask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">format_attr_offcore_rsp</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="cm">/* XXX do NHM/WSM + SNB breakout */</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initconst</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_pmu</span> <span class="n">intel_pmu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Intel&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>		<span class="o">=</span> <span class="n">intel_pmu_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_all</span>		<span class="o">=</span> <span class="n">intel_pmu_disable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_all</span>		<span class="o">=</span> <span class="n">intel_pmu_enable_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>			<span class="o">=</span> <span class="n">intel_pmu_enable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>		<span class="o">=</span> <span class="n">intel_pmu_disable_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_config</span>		<span class="o">=</span> <span class="n">intel_pmu_hw_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">schedule_events</span>	<span class="o">=</span> <span class="n">x86_schedule_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eventsel</span>		<span class="o">=</span> <span class="n">MSR_ARCH_PERFMON_EVENTSEL0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">perfctr</span>		<span class="o">=</span> <span class="n">MSR_ARCH_PERFMON_PERFCTR0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_map</span>		<span class="o">=</span> <span class="n">intel_pmu_event_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_events</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intel_perfmon_event_map</span><span class="p">),</span>
	<span class="p">.</span><span class="n">apic</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * Intel PMCs cannot be accessed sanely above 32 bit width,</span>
<span class="cm">	 * so we install an artificial 1&lt;&lt;31 period regardless of</span>
<span class="cm">	 * the generic event period:</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">max_period</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_event_constraints</span>	<span class="o">=</span> <span class="n">intel_get_event_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_event_constraints</span>	<span class="o">=</span> <span class="n">intel_put_event_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pebs_aliases</span>		<span class="o">=</span> <span class="n">intel_pebs_aliases_core2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">format_attrs</span>		<span class="o">=</span> <span class="n">intel_arch3_formats_attr</span><span class="p">,</span>

	<span class="p">.</span><span class="n">cpu_prepare</span>		<span class="o">=</span> <span class="n">intel_pmu_cpu_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_starting</span>		<span class="o">=</span> <span class="n">intel_pmu_cpu_starting</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_dying</span>		<span class="o">=</span> <span class="n">intel_pmu_cpu_dying</span><span class="p">,</span>
	<span class="p">.</span><span class="n">guest_get_msrs</span>		<span class="o">=</span> <span class="n">intel_guest_get_msrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_branch_stack</span>	<span class="o">=</span> <span class="n">intel_pmu_flush_branch_stack</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">intel_clovertown_quirk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * PEBS is unreliable due to:</span>
<span class="cm">	 *</span>
<span class="cm">	 *   AJ67  - PEBS may experience CPL leaks</span>
<span class="cm">	 *   AJ68  - PEBS PMI may be delayed by one event</span>
<span class="cm">	 *   AJ69  - GLOBAL_STATUS[62] will only be set when DEBUGCTL[12]</span>
<span class="cm">	 *   AJ106 - FREEZE_LBRS_ON_PMI doesn&#39;t work in combination with PEBS</span>
<span class="cm">	 *</span>
<span class="cm">	 * AJ67 could be worked around by restricting the OS/USR flags.</span>
<span class="cm">	 * AJ69 could be worked around by setting PMU_FREEZE_ON_PMI.</span>
<span class="cm">	 *</span>
<span class="cm">	 * AJ106 could possibly be worked around by not allowing LBR</span>
<span class="cm">	 *       usage from PEBS, including the fixup.</span>
<span class="cm">	 * AJ68  could possibly be worked around by always programming</span>
<span class="cm">	 *	 a pebs_event_reset[0] value and coping with the lost events.</span>
<span class="cm">	 *</span>
<span class="cm">	 * But taken together it might just make sense to not enable PEBS on</span>
<span class="cm">	 * these chips.</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PEBS disabled due to CPU errata.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_constraints</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">intel_sandybridge_quirk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PEBS disabled due to CPU errata.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_constraints</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> <span class="p">}</span> <span class="n">intel_arch_events_map</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">,</span> <span class="s">&quot;cpu cycles&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">,</span> <span class="s">&quot;instructions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PERF_COUNT_HW_BUS_CYCLES</span><span class="p">,</span> <span class="s">&quot;bus cycles&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">,</span> <span class="s">&quot;cache references&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">,</span> <span class="s">&quot;cache misses&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">,</span> <span class="s">&quot;branch instructions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">,</span> <span class="s">&quot;branch misses&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">intel_arch_events_quirk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

	<span class="cm">/* disable event that reported as not presend by cpuid */</span>
	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">events_mask</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intel_arch_events_map</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">intel_arch_events_map</span><span class="p">[</span><span class="n">bit</span><span class="p">].</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CPUID marked event: </span><span class="se">\&#39;</span><span class="s">%s</span><span class="se">\&#39;</span><span class="s"> unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">intel_arch_events_map</span><span class="p">[</span><span class="n">bit</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">intel_nehalem_quirk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">cpuid10_ebx</span> <span class="n">ebx</span><span class="p">;</span>

	<span class="n">ebx</span><span class="p">.</span><span class="n">full</span> <span class="o">=</span> <span class="n">x86_pmu</span><span class="p">.</span><span class="n">events_maskl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ebx</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">no_branch_misses_retired</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Erratum AAJ80 detected, we work it around by using</span>
<span class="cm">		 * the BR_MISP_EXEC.ANY event. This will over-count</span>
<span class="cm">		 * branch-misses, but it&#39;s still much better than the</span>
<span class="cm">		 * architectural event which is often completely bogus:</span>
<span class="cm">		 */</span>
		<span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7f89</span><span class="p">;</span>
		<span class="n">ebx</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">no_branch_misses_retired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">events_maskl</span> <span class="o">=</span> <span class="n">ebx</span><span class="p">.</span><span class="n">full</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CPU erratum AAJ80 worked around</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">__init</span> <span class="kt">int</span> <span class="nf">intel_pmu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">cpuid10_edx</span> <span class="n">edx</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cpuid10_eax</span> <span class="n">eax</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cpuid10_ebx</span> <span class="n">ebx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_cpu_data</span><span class="p">,</span> <span class="n">X86_FEATURE_ARCH_PERFMON</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x6</span>:
			<span class="k">return</span> <span class="n">p6_pmu_init</span><span class="p">();</span>
		<span class="k">case</span> <span class="mh">0xf</span>:
			<span class="k">return</span> <span class="n">p4_pmu_init</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether the Architectural PerfMon supports</span>
<span class="cm">	 * Branch Misses Retired hw_event or not.</span>
<span class="cm">	 */</span>
	<span class="n">cpuid</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eax</span><span class="p">.</span><span class="n">full</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebx</span><span class="p">.</span><span class="n">full</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unused</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">.</span><span class="n">full</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">mask_length</span> <span class="o">&lt;</span> <span class="n">ARCH_PERFMON_EVENTS_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">version</span> <span class="o">=</span> <span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">version_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">x86_pmu</span> <span class="o">=</span> <span class="n">core_pmu</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">x86_pmu</span> <span class="o">=</span> <span class="n">intel_pmu</span><span class="p">;</span>

	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">version</span>			<span class="o">=</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters</span>		<span class="o">=</span> <span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span>
	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">cntval_bits</span>		<span class="o">=</span> <span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">bit_width</span><span class="p">;</span>
	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">cntval_mask</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">bit_width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">events_maskl</span>		<span class="o">=</span> <span class="n">ebx</span><span class="p">.</span><span class="n">full</span><span class="p">;</span>
	<span class="n">x86_pmu</span><span class="p">.</span><span class="n">events_mask_len</span>		<span class="o">=</span> <span class="n">eax</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">mask_length</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Quirk: v2 perfmon does not report fixed-purpose events, so</span>
<span class="cm">	 * assume at least 3 events:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">num_counters_fixed</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">edx</span><span class="p">.</span><span class="n">split</span><span class="p">.</span><span class="n">num_counters_fixed</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * v2 and above have a perf capabilities MSR</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">capabilities</span><span class="p">;</span>

		<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_IA32_PERF_CAPABILITIES</span><span class="p">,</span> <span class="n">capabilities</span><span class="p">);</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">intel_cap</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_ds_init</span><span class="p">();</span>

	<span class="n">x86_add_quirk</span><span class="p">(</span><span class="n">intel_arch_events_quirk</span><span class="p">);</span> <span class="cm">/* Install first, so it runs last */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Install the hw-cache-events table:</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">14</span>: <span class="cm">/* 65 nm core solo/duo, &quot;Yonah&quot; */</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Core events, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">15</span>: <span class="cm">/* original 65 nm celeron/pentium/core2/xeon, &quot;Merom&quot;/&quot;Conroe&quot; */</span>
		<span class="n">x86_add_quirk</span><span class="p">(</span><span class="n">intel_clovertown_quirk</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">22</span>: <span class="cm">/* single-core 65 nm celeron/core2solo &quot;Merom-L&quot;/&quot;Conroe-L&quot; */</span>
	<span class="k">case</span> <span class="mi">23</span>: <span class="cm">/* current 45 nm celeron/core2/xeon &quot;Penryn&quot;/&quot;Wolfdale&quot; */</span>
	<span class="k">case</span> <span class="mi">29</span>: <span class="cm">/* six-core 45 nm xeon &quot;Dunnington&quot; */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">,</span> <span class="n">core2_hw_cache_event_ids</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">));</span>

		<span class="n">intel_pmu_lbr_init_core</span><span class="p">();</span>

		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span> <span class="o">=</span> <span class="n">intel_core2_event_constraints</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_constraints</span> <span class="o">=</span> <span class="n">intel_core2_pebs_event_constraints</span><span class="p">;</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Core2 events, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">26</span>: <span class="cm">/* 45 nm nehalem, &quot;Bloomfield&quot; */</span>
	<span class="k">case</span> <span class="mi">30</span>: <span class="cm">/* 45 nm nehalem, &quot;Lynnfield&quot; */</span>
	<span class="k">case</span> <span class="mi">46</span>: <span class="cm">/* 45 nm nehalem-ex, &quot;Beckton&quot; */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">,</span> <span class="n">nehalem_hw_cache_event_ids</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_extra_regs</span><span class="p">,</span> <span class="n">nehalem_hw_cache_extra_regs</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_extra_regs</span><span class="p">));</span>

		<span class="n">intel_pmu_lbr_init_nhm</span><span class="p">();</span>

		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span> <span class="o">=</span> <span class="n">intel_nehalem_event_constraints</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_constraints</span> <span class="o">=</span> <span class="n">intel_nehalem_pebs_event_constraints</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">enable_all</span> <span class="o">=</span> <span class="n">intel_pmu_nhm_enable_all</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">extra_regs</span> <span class="o">=</span> <span class="n">intel_nehalem_extra_regs</span><span class="p">;</span>

		<span class="cm">/* UOPS_ISSUED.STALLED_CYCLES */</span>
		<span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_STALLED_CYCLES_FRONTEND</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">X86_CONFIG</span><span class="p">(.</span><span class="n">event</span><span class="o">=</span><span class="mh">0x0e</span><span class="p">,</span> <span class="p">.</span><span class="n">umask</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">.</span><span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">cmask</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* UOPS_EXECUTED.CORE_ACTIVE_CYCLES,c=1,i=1 */</span>
		<span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_STALLED_CYCLES_BACKEND</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">X86_CONFIG</span><span class="p">(.</span><span class="n">event</span><span class="o">=</span><span class="mh">0xb1</span><span class="p">,</span> <span class="p">.</span><span class="n">umask</span><span class="o">=</span><span class="mh">0x3f</span><span class="p">,</span> <span class="p">.</span><span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">cmask</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">x86_add_quirk</span><span class="p">(</span><span class="n">intel_nehalem_quirk</span><span class="p">);</span>

		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Nehalem events, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">28</span>: <span class="cm">/* Atom */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">,</span> <span class="n">atom_hw_cache_event_ids</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">));</span>

		<span class="n">intel_pmu_lbr_init_atom</span><span class="p">();</span>

		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span> <span class="o">=</span> <span class="n">intel_gen_event_constraints</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_constraints</span> <span class="o">=</span> <span class="n">intel_atom_pebs_event_constraints</span><span class="p">;</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Atom events, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">37</span>: <span class="cm">/* 32 nm nehalem, &quot;Clarkdale&quot; */</span>
	<span class="k">case</span> <span class="mi">44</span>: <span class="cm">/* 32 nm nehalem, &quot;Gulftown&quot; */</span>
	<span class="k">case</span> <span class="mi">47</span>: <span class="cm">/* 32 nm Xeon E7 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">,</span> <span class="n">westmere_hw_cache_event_ids</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_extra_regs</span><span class="p">,</span> <span class="n">nehalem_hw_cache_extra_regs</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_extra_regs</span><span class="p">));</span>

		<span class="n">intel_pmu_lbr_init_nhm</span><span class="p">();</span>

		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span> <span class="o">=</span> <span class="n">intel_westmere_event_constraints</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">enable_all</span> <span class="o">=</span> <span class="n">intel_pmu_nhm_enable_all</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_constraints</span> <span class="o">=</span> <span class="n">intel_westmere_pebs_event_constraints</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">extra_regs</span> <span class="o">=</span> <span class="n">intel_westmere_extra_regs</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">er_flags</span> <span class="o">|=</span> <span class="n">ERF_HAS_RSP_1</span><span class="p">;</span>

		<span class="cm">/* UOPS_ISSUED.STALLED_CYCLES */</span>
		<span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_STALLED_CYCLES_FRONTEND</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">X86_CONFIG</span><span class="p">(.</span><span class="n">event</span><span class="o">=</span><span class="mh">0x0e</span><span class="p">,</span> <span class="p">.</span><span class="n">umask</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">.</span><span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">cmask</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* UOPS_EXECUTED.CORE_ACTIVE_CYCLES,c=1,i=1 */</span>
		<span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_STALLED_CYCLES_BACKEND</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">X86_CONFIG</span><span class="p">(.</span><span class="n">event</span><span class="o">=</span><span class="mh">0xb1</span><span class="p">,</span> <span class="p">.</span><span class="n">umask</span><span class="o">=</span><span class="mh">0x3f</span><span class="p">,</span> <span class="p">.</span><span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">cmask</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Westmere events, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">42</span>: <span class="cm">/* SandyBridge */</span>
	<span class="k">case</span> <span class="mi">45</span>: <span class="cm">/* SandyBridge, &quot;Romely-EP&quot; */</span>
		<span class="n">x86_add_quirk</span><span class="p">(</span><span class="n">intel_sandybridge_quirk</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">58</span>: <span class="cm">/* IvyBridge */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">,</span> <span class="n">snb_hw_cache_event_ids</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_cache_event_ids</span><span class="p">));</span>

		<span class="n">intel_pmu_lbr_init_snb</span><span class="p">();</span>

		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span> <span class="o">=</span> <span class="n">intel_snb_event_constraints</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_constraints</span> <span class="o">=</span> <span class="n">intel_snb_pebs_event_constraints</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">pebs_aliases</span> <span class="o">=</span> <span class="n">intel_pebs_aliases_snb</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">extra_regs</span> <span class="o">=</span> <span class="n">intel_snb_extra_regs</span><span class="p">;</span>
		<span class="cm">/* all extra regs are per-cpu when HT is on */</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">er_flags</span> <span class="o">|=</span> <span class="n">ERF_HAS_RSP_1</span><span class="p">;</span>
		<span class="n">x86_pmu</span><span class="p">.</span><span class="n">er_flags</span> <span class="o">|=</span> <span class="n">ERF_NO_HT_SHARING</span><span class="p">;</span>

		<span class="cm">/* UOPS_ISSUED.ANY,c=1,i=1 to count stall cycles */</span>
		<span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_STALLED_CYCLES_FRONTEND</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">X86_CONFIG</span><span class="p">(.</span><span class="n">event</span><span class="o">=</span><span class="mh">0x0e</span><span class="p">,</span> <span class="p">.</span><span class="n">umask</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">.</span><span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">cmask</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* UOPS_DISPATCHED.THREAD,c=1,i=1 to count stall cycles*/</span>
		<span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_STALLED_CYCLES_BACKEND</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">X86_CONFIG</span><span class="p">(.</span><span class="n">event</span><span class="o">=</span><span class="mh">0xb1</span><span class="p">,</span> <span class="p">.</span><span class="n">umask</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">.</span><span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">cmask</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;SandyBridge events, &quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">x86_pmu</span><span class="p">.</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span> <span class="o">=</span> <span class="n">intel_v1_event_constraints</span><span class="p">;</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;generic architected perfmon v1, &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * default constraints for v2 and up</span>
<span class="cm">			 */</span>
			<span class="n">x86_pmu</span><span class="p">.</span><span class="n">event_constraints</span> <span class="o">=</span> <span class="n">intel_gen_event_constraints</span><span class="p">;</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;generic architected perfmon, &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
