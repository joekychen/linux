<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › cpu › mcheck › mce_amd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>mce_amd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  (c) 2005, 2006 Advanced Micro Devices, Inc.</span>
<span class="cm"> *  Your use of this code is subject to the terms and conditions of the</span>
<span class="cm"> *  GNU general public license version 2. See &quot;COPYING&quot; or</span>
<span class="cm"> *  http://www.gnu.org/licenses/gpl.html</span>
<span class="cm"> *</span>
<span class="cm"> *  Written by Jacob Shin - AMD, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *  Support : jacob.shin@amd.com</span>
<span class="cm"> *</span>
<span class="cm"> *  April 2006</span>
<span class="cm"> *     - added support for AMD Family 0x10 processors</span>
<span class="cm"> *</span>
<span class="cm"> *  All MC4_MISCi registers are shared between multi-cores</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>

<span class="cp">#include &lt;asm/apic.h&gt;</span>
<span class="cp">#include &lt;asm/idle.h&gt;</span>
<span class="cp">#include &lt;asm/mce.h&gt;</span>
<span class="cp">#include &lt;asm/msr.h&gt;</span>

<span class="cp">#define NR_BANKS          6</span>
<span class="cp">#define NR_BLOCKS         9</span>
<span class="cp">#define THRESHOLD_MAX     0xFFF</span>
<span class="cp">#define INT_TYPE_APIC     0x00020000</span>
<span class="cp">#define MASK_VALID_HI     0x80000000</span>
<span class="cp">#define MASK_CNTP_HI      0x40000000</span>
<span class="cp">#define MASK_LOCKED_HI    0x20000000</span>
<span class="cp">#define MASK_LVTOFF_HI    0x00F00000</span>
<span class="cp">#define MASK_COUNT_EN_HI  0x00080000</span>
<span class="cp">#define MASK_INT_TYPE_HI  0x00060000</span>
<span class="cp">#define MASK_OVERFLOW_HI  0x00010000</span>
<span class="cp">#define MASK_ERR_COUNT_HI 0x00000FFF</span>
<span class="cp">#define MASK_BLKPTR_LO    0xFF000000</span>
<span class="cp">#define MCG_XBLK_ADDR     0xC0000400</span>

<span class="k">struct</span> <span class="n">threshold_block</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">block</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">bank</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cpu</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">address</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">interrupt_enable</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">interrupt_capable</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">threshold_limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span>		<span class="n">kobj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">miscj</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">threshold_bank</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kobject</span>		<span class="o">*</span><span class="n">kobj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">threshold_block</span>	<span class="o">*</span><span class="n">blocks</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span>		<span class="n">cpus</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_bank</span> <span class="o">*</span> <span class="p">[</span><span class="n">NR_BANKS</span><span class="p">],</span> <span class="n">threshold_banks</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shared_bank</span><span class="p">[</span><span class="n">NR_BANKS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="n">bank_map</span><span class="p">);</span>	<span class="cm">/* see which banks are on */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">amd_threshold_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * CPU Initialization</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">thresh_restart</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block</span>	<span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">reset</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">set_lvt_off</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">lvt_off</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">old_limit</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">lvt_interrupt_supported</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="n">u32</span> <span class="n">msr_high_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * bank 4 supports APIC LVT interrupts implicitly since forever.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bank</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * IntP: interrupt present; if this bit is set, the thresholding</span>
<span class="cm">	 * bank can generate APIC LVT interrupts</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">msr_high_bits</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">28</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lvt_off_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">apic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">hi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">msr</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="n">MASK_LVTOFF_HI</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">FW_BUG</span> <span class="s">&quot;cpu %d, failed to setup threshold interrupt &quot;</span>
		       <span class="s">&quot;for bank %d, block %d (MSR%08X=0x%x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
		       <span class="n">b</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apic</span> <span class="o">!=</span> <span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">FW_BUG</span> <span class="s">&quot;cpu %d, invalid threshold interrupt offset %d &quot;</span>
		       <span class="s">&quot;for bank %d, block %d (MSR%08X=0x%x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">b</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">apic</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Called via smp_call_function_single(), must be called with correct</span>
<span class="cm"> * cpu affinity.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">threshold_restart_bank</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thresh_restart</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span> <span class="n">_tr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">threshold_limit</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="n">THRESHOLD_MAX</span><span class="p">))</span>
		<span class="n">tr</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* limit cannot be lower than err count */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* reset err count and overflow bit */</span>
		<span class="n">hi</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MASK_ERR_COUNT_HI</span> <span class="o">|</span> <span class="n">MASK_OVERFLOW_HI</span><span class="p">))</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">THRESHOLD_MAX</span> <span class="o">-</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">threshold_limit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">old_limit</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* change limit w/o reset */</span>
		<span class="kt">int</span> <span class="n">new_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="n">THRESHOLD_MAX</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">old_limit</span> <span class="o">-</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">threshold_limit</span><span class="p">);</span>

		<span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MASK_ERR_COUNT_HI</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">new_count</span> <span class="o">&amp;</span> <span class="n">THRESHOLD_MAX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear IntType */</span>
	<span class="n">hi</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_INT_TYPE_HI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">interrupt_capable</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">set_lvt_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lvt_off_valid</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">lvt_off</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* set new lvt offset */</span>
			<span class="n">hi</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_LVTOFF_HI</span><span class="p">;</span>
			<span class="n">hi</span> <span class="o">|=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">lvt_off</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">interrupt_enable</span><span class="p">)</span>
		<span class="n">hi</span> <span class="o">|=</span> <span class="n">INT_TYPE_APIC</span><span class="p">;</span>

 <span class="nl">done:</span>

	<span class="n">hi</span> <span class="o">|=</span> <span class="n">MASK_COUNT_EN_HI</span><span class="p">;</span>
	<span class="n">wrmsr</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mce_threshold_block_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thresh_restart</span> <span class="n">tr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">b</span>			<span class="o">=</span> <span class="n">b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_lvt_off</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lvt_off</span>		<span class="o">=</span> <span class="n">offset</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">threshold_limit</span>		<span class="o">=</span> <span class="n">THRESHOLD_MAX</span><span class="p">;</span>
	<span class="n">threshold_restart_bank</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_APIC_mce</span><span class="p">(</span><span class="kt">int</span> <span class="n">reserved</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reserved</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">setup_APIC_eilvt</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">THRESHOLD_APIC_VECTOR</span><span class="p">,</span>
					      <span class="n">APIC_EILVT_MSG_FIX</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cpu init entry point, called from mce.c with preempt off */</span>
<span class="kt">void</span> <span class="nf">mce_amd_feature_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="n">u32</span> <span class="n">low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="n">block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">NR_BANKS</span><span class="p">;</span> <span class="o">++</span><span class="n">bank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">NR_BLOCKS</span><span class="p">;</span> <span class="o">++</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">address</span> <span class="o">=</span> <span class="n">MSR_IA32_MC0_MISC</span> <span class="o">+</span> <span class="n">bank</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">&amp;</span> <span class="n">MASK_BLKPTR_LO</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">address</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">address</span> <span class="o">+=</span> <span class="n">MCG_XBLK_ADDR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">++</span><span class="n">address</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rdmsr_safe</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">high</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_VALID_HI</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_CNTP_HI</span><span class="p">)</span>  <span class="o">||</span>
			     <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_LOCKED_HI</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="p">)</span>
				<span class="n">per_cpu</span><span class="p">(</span><span class="n">bank_map</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bank</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shared_bank</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cpu_core_id</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
			<span class="n">b</span><span class="p">.</span><span class="n">cpu</span>			<span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
			<span class="n">b</span><span class="p">.</span><span class="n">bank</span>			<span class="o">=</span> <span class="n">bank</span><span class="p">;</span>
			<span class="n">b</span><span class="p">.</span><span class="n">block</span>			<span class="o">=</span> <span class="n">block</span><span class="p">;</span>
			<span class="n">b</span><span class="p">.</span><span class="n">address</span>		<span class="o">=</span> <span class="n">address</span><span class="p">;</span>
			<span class="n">b</span><span class="p">.</span><span class="n">interrupt_capable</span>	<span class="o">=</span> <span class="n">lvt_interrupt_supported</span><span class="p">(</span><span class="n">bank</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">interrupt_capable</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_LVTOFF_HI</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>
				<span class="n">offset</span>  <span class="o">=</span> <span class="n">setup_APIC_mce</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">mce_threshold_block_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">mce_threshold_vector</span> <span class="o">=</span> <span class="n">amd_threshold_interrupt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * APIC Interrupt Handler</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * threshold interrupt handler will service THRESHOLD_APIC_VECTOR.</span>
<span class="cm"> * the interrupt goes off when error_count reaches threshold_limit.</span>
<span class="cm"> * the handler will simply log mcelog w/ software defined bank number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd_threshold_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mce</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">mce_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="cm">/* assume first bank caused it */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">NR_BANKS</span><span class="p">;</span> <span class="o">++</span><span class="n">bank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bank_map</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bank</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">NR_BLOCKS</span><span class="p">;</span> <span class="o">++</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">address</span> <span class="o">=</span> <span class="n">MSR_IA32_MC0_MISC</span> <span class="o">+</span> <span class="n">bank</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">&amp;</span> <span class="n">MASK_BLKPTR_LO</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">address</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">address</span> <span class="o">+=</span> <span class="n">MCG_XBLK_ADDR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">address</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rdmsr_safe</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">high</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_VALID_HI</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_CNTP_HI</span><span class="p">)</span>  <span class="o">||</span>
			     <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_LOCKED_HI</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Log the machine check that caused the threshold</span>
<span class="cm">			 * event.</span>
<span class="cm">			 */</span>
			<span class="n">machine_check_poll</span><span class="p">(</span><span class="n">MCP_TIMESTAMP</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">mce_poll_banks</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_OVERFLOW_HI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdmsrl</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">misc</span><span class="p">);</span>
				<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_IA32_MC0_STATUS</span> <span class="o">+</span> <span class="n">bank</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				       <span class="n">m</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
				<span class="n">m</span><span class="p">.</span><span class="n">bank</span> <span class="o">=</span> <span class="n">K8_MCE_THRESHOLD_BASE</span>
				       <span class="o">+</span> <span class="n">bank</span> <span class="o">*</span> <span class="n">NR_BLOCKS</span>
				       <span class="o">+</span> <span class="n">block</span><span class="p">;</span>
				<span class="n">mce_log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sysfs Interface</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">threshold_attr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define SHOW_FIELDS(name)						\</span>
<span class="cp">static ssize_t show_ ## name(struct threshold_block *b, char *buf)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return sprintf(buf, &quot;%lx\n&quot;, (unsigned long) b-&gt;name);		\</span>
<span class="cp">}</span>
<span class="n">SHOW_FIELDS</span><span class="p">(</span><span class="n">interrupt_enable</span><span class="p">)</span>
<span class="n">SHOW_FIELDS</span><span class="p">(</span><span class="n">threshold_limit</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="n">store_interrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thresh_restart</span> <span class="n">tr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">interrupt_capable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">interrupt_enable</span> <span class="o">=</span> <span class="o">!!</span><span class="n">new</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="p">));</span>
	<span class="n">tr</span><span class="p">.</span><span class="n">b</span>		<span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">threshold_restart_bank</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="n">store_threshold_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thresh_restart</span> <span class="n">tr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&gt;</span> <span class="n">THRESHOLD_MAX</span><span class="p">)</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">THRESHOLD_MAX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="p">));</span>
	<span class="n">tr</span><span class="p">.</span><span class="n">old_limit</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">threshold_limit</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">threshold_limit</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">tr</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">threshold_restart_bank</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">threshold_block_cross_cpu</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block</span>	<span class="o">*</span><span class="n">tb</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">retval</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">local_error_count_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_tbcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block_cross_cpu</span> <span class="o">*</span><span class="n">tbcc</span> <span class="o">=</span> <span class="n">_tbcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">tbcc</span><span class="o">-&gt;</span><span class="n">tb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="n">tbcc</span><span class="o">-&gt;</span><span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">THRESHOLD_MAX</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">threshold_limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_error_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block_cross_cpu</span> <span class="n">tbcc</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">tb</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">local_error_count_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbcc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbcc</span><span class="p">.</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_error_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thresh_restart</span> <span class="n">tr</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">old_limit</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">threshold_restart_bank</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RW_ATTR(val)							\</span>
<span class="cp">static struct threshold_attr val = {					\</span>
<span class="cp">	.attr	= {.name = __stringify(val), .mode = 0644 },		\</span>
<span class="cp">	.show	= show_## val,						\</span>
<span class="cp">	.store	= store_## val,						\</span>
<span class="cp">};</span>

<span class="n">RW_ATTR</span><span class="p">(</span><span class="n">interrupt_enable</span><span class="p">);</span>
<span class="n">RW_ATTR</span><span class="p">(</span><span class="n">threshold_limit</span><span class="p">);</span>
<span class="n">RW_ATTR</span><span class="p">(</span><span class="n">error_count</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">threshold_limit</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">error_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* possibly interrupt_enable if supported, see below */</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define to_block(k)	container_of(k, struct threshold_block, kobj)</span>
<span class="cp">#define to_attr(a)	container_of(a, struct threshold_attr, attr)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">to_block</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">threshold_attr</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">to_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">show</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">to_block</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">threshold_attr</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">to_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">store</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">threshold_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span>			<span class="o">=</span> <span class="n">show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>			<span class="o">=</span> <span class="n">store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">threshold_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sysfs_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">threshold_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span>		<span class="o">=</span> <span class="n">default_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__cpuinit</span> <span class="kt">int</span> <span class="nf">allocate_threshold_blocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bank</span> <span class="o">&gt;=</span> <span class="n">NR_BANKS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;=</span> <span class="n">NR_BLOCKS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdmsr_safe_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">high</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_VALID_HI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">recurse</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_CNTP_HI</span><span class="p">)</span>  <span class="o">||</span>
	     <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="n">MASK_LOCKED_HI</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">recurse</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_block</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">block</span>		<span class="o">=</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">bank</span>			<span class="o">=</span> <span class="n">bank</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">cpu</span>			<span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">address</span>		<span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">interrupt_enable</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">interrupt_capable</span>	<span class="o">=</span> <span class="n">lvt_interrupt_supported</span><span class="p">(</span><span class="n">bank</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">threshold_limit</span>	<span class="o">=</span> <span class="n">THRESHOLD_MAX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">interrupt_capable</span><span class="p">)</span>
		<span class="n">threshold_ktype</span><span class="p">.</span><span class="n">default_attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interrupt_enable</span><span class="p">.</span><span class="n">attr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">threshold_ktype</span><span class="p">.</span><span class="n">default_attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">miscj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">miscj</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="o">-&gt;</span><span class="n">miscj</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">threshold_ktype</span><span class="p">,</span>
				   <span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
				   <span class="s">&quot;misc%i&quot;</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<span class="nl">recurse:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">&amp;</span> <span class="n">MASK_BLKPTR_LO</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">address</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">address</span> <span class="o">+=</span> <span class="n">MCG_XBLK_ADDR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">address</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">allocate_threshold_blocks</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="o">++</span><span class="n">block</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
		<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">miscj</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__cpuinit</span> <span class="kt">long</span>
<span class="nf">local_allocate_threshold_blocks</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">allocate_threshold_blocks</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">MSR_IA32_MC0_MISC</span> <span class="o">+</span> <span class="n">bank</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* symlinks sibling shared banks to first core.  first core owns dir/files. */</span>
<span class="k">static</span> <span class="n">__cpuinit</span> <span class="kt">int</span> <span class="nf">threshold_create_bank</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">threshold_bank</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">mce_device</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;threshold_bank%i&quot;</span><span class="p">,</span> <span class="n">bank</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_data</span><span class="p">(</span><span class="n">cpu</span><span class="p">).</span><span class="n">cpu_core_id</span> <span class="o">&amp;&amp;</span> <span class="n">shared_bank</span><span class="p">[</span><span class="n">bank</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/* symlink */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">cpumask_first</span><span class="p">(</span><span class="n">cpu_llc_shared_mask</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>

		<span class="cm">/* first core not up yet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_data</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">cpu_core_id</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* already linked */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">b</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">i</span><span class="p">)[</span><span class="n">bank</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">cpu_llc_shared_mask</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">threshold_bank</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_SMP</span>
	<span class="n">cpumask_setall</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">local_allocate_threshold_blocks</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">bank</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">mce_device</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">i</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create dir/files for all valid threshold banks */</span>
<span class="k">static</span> <span class="n">__cpuinit</span> <span class="kt">int</span> <span class="nf">threshold_create_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">NR_BANKS</span><span class="p">;</span> <span class="o">++</span><span class="n">bank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bank_map</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bank</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">threshold_create_bank</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">bank</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * let&#39;s be hotplug friendly.</span>
<span class="cm"> * in case of multiple core processors, the first core always takes ownership</span>
<span class="cm"> *   of shared sysfs dir/files, and rest of the cores will be symlinked to it.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">deallocate_threshold_block</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span>
						 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">threshold_block</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">threshold_bank</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="o">-&gt;</span><span class="n">miscj</span><span class="p">,</span> <span class="n">miscj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">miscj</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">);</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">threshold_remove_bank</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">threshold_bank</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;threshold_bank%i&quot;</span><span class="p">,</span> <span class="n">bank</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="cm">/* sibling symlink */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shared_bank</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">mce_device</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* remove all sibling symlinks before unregistering */</span>
	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">mce_device</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">i</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deallocate_threshold_block</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">bank</span><span class="p">);</span>

<span class="nl">free_out:</span>
	<span class="n">kobject_del</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">threshold_banks</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)[</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">threshold_remove_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">NR_BANKS</span><span class="p">;</span> <span class="o">++</span><span class="n">bank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bank_map</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bank</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">threshold_remove_bank</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">bank</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* get notified when a cpu comes on/off */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span>
<span class="nf">amd_64_threshold_cpu_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_ONLINE</span>:
	<span class="k">case</span> <span class="n">CPU_ONLINE_FROZEN</span>:
		<span class="n">threshold_create_device</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_DEAD</span>:
	<span class="k">case</span> <span class="n">CPU_DEAD_FROZEN</span>:
		<span class="n">threshold_remove_device</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">threshold_init_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">lcpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* to hit CPUs online before the notifier is up */</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">lcpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">threshold_create_device</span><span class="p">(</span><span class="n">lcpu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">threshold_cpu_callback</span> <span class="o">=</span> <span class="n">amd_64_threshold_cpu_callback</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">device_initcall</span><span class="p">(</span><span class="n">threshold_init_device</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
