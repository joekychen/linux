<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › hpet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hpet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/clocksource.h&gt;</span>
<span class="cp">#include &lt;linux/clockchips.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/i8253.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/hpet.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/fixmap.h&gt;</span>
<span class="cp">#include &lt;asm/hpet.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt;</span>

<span class="cp">#define HPET_MASK			CLOCKSOURCE_MASK(32)</span>

<span class="cm">/* FSEC = 10^-15</span>
<span class="cm">   NSEC = 10^-9 */</span>
<span class="cp">#define FSEC_PER_NSEC			1000000L</span>

<span class="cp">#define HPET_DEV_USED_BIT		2</span>
<span class="cp">#define HPET_DEV_USED			(1 &lt;&lt; HPET_DEV_USED_BIT)</span>
<span class="cp">#define HPET_DEV_VALID			0x8</span>
<span class="cp">#define HPET_DEV_FSB_CAP		0x1000</span>
<span class="cp">#define HPET_DEV_PERI_CAP		0x2000</span>

<span class="cp">#define HPET_MIN_CYCLES			128</span>
<span class="cp">#define HPET_MIN_PROG_DELTA		(HPET_MIN_CYCLES + (HPET_MIN_CYCLES &gt;&gt; 1))</span>

<span class="cm">/*</span>
<span class="cm"> * HPET address is set in acpi/boot.c, when an ACPI entry exists</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span>				<span class="n">hpet_address</span><span class="p">;</span>
<span class="n">u8</span>					<span class="n">hpet_blockid</span><span class="p">;</span> <span class="cm">/* OS timer block num */</span>
<span class="n">u8</span>					<span class="n">hpet_msi_disable</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">hpet_num_timers</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">hpet_virt_address</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">clock_event_device</span>	<span class="n">evt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">cpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="p">};</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="nf">EVT_TO_HPET_DEV</span><span class="p">(</span><span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evtdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">evtdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpet_dev</span><span class="p">,</span> <span class="n">evt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hpet_readl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">hpet_virt_address</span> <span class="o">+</span> <span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hpet_writel</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">hpet_virt_address</span> <span class="o">+</span> <span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hpet_set_mapping</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpet_virt_address</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">hpet_address</span><span class="p">,</span> <span class="n">HPET_MMAP_SIZE</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">__set_fixmap</span><span class="p">(</span><span class="n">VSYSCALL_HPET</span><span class="p">,</span> <span class="n">hpet_address</span><span class="p">,</span> <span class="n">PAGE_KERNEL_VVAR_NOCACHE</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hpet_clear_mapping</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hpet_virt_address</span><span class="p">);</span>
	<span class="n">hpet_virt_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HPET command line enable / disable</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">boot_hpet_disable</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">hpet_force_user</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hpet_verbose</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hpet_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span>
			<span class="o">*</span><span class="n">next</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;disable&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">boot_hpet_disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;force&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">hpet_force_user</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">hpet_verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;hpet=&quot;</span><span class="p">,</span> <span class="n">hpet_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">disable_hpet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">boot_hpet_disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;nohpet&quot;</span><span class="p">,</span> <span class="n">disable_hpet</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_hpet_capable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">boot_hpet_disable</span> <span class="o">&amp;&amp;</span> <span class="n">hpet_address</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HPET timer interrupt enable / disable</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hpet_legacy_int_enabled</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * is_hpet_enabled - check whether the hpet timer interrupt is enabled</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">is_hpet_enabled</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">is_hpet_capable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hpet_legacy_int_enabled</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">is_hpet_enabled</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_hpet_print_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">timers</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hpet: %s(%d):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_ID</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_PERIOD</span><span class="p">);</span>
	<span class="n">timers</span> <span class="o">=</span> <span class="p">((</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">HPET_ID_NUMBER</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">HPET_ID_NUMBER_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hpet: ID: 0x%x, PERIOD: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_CFG</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_STATUS</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hpet: CFG: 0x%x, STATUS: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hpet: COUNTER_l: 0x%x, COUNTER_h: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hpet: T%d: CFG_l: 0x%x, CFG_h: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CMP</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CMP</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hpet: T%d: CMP_l: 0x%x, CMP_h: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_ROUTE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_ROUTE</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hpet: T%d ROUTE_l: 0x%x, ROUTE_h: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define hpet_print_config()					\</span>
<span class="cp">do {								\</span>
<span class="cp">	if (hpet_verbose)					\</span>
<span class="cp">		_hpet_print_config(__FUNCTION__, __LINE__);	\</span>
<span class="cp">} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * When the hpet driver (/dev/hpet) is enabled, we need to reserve</span>
<span class="cm"> * timer 0 and timer 1 in case of RTC emulation.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_HPET</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hpet_reserve_msi_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_data</span> <span class="o">*</span><span class="n">hd</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_reserve_platform_timers</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpet</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hpet</span> <span class="o">=</span> <span class="n">hpet_virt_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpet_timer</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpet</span><span class="o">-&gt;</span><span class="n">hpet_timers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nrtimers</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpet_data</span> <span class="n">hd</span><span class="p">;</span>

	<span class="n">nrtimers</span> <span class="o">=</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">HPET_ID_NUMBER</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">HPET_ID_NUMBER_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hd</span><span class="p">));</span>
	<span class="n">hd</span><span class="p">.</span><span class="n">hd_phys_address</span>	<span class="o">=</span> <span class="n">hpet_address</span><span class="p">;</span>
	<span class="n">hd</span><span class="p">.</span><span class="n">hd_address</span>		<span class="o">=</span> <span class="n">hpet</span><span class="p">;</span>
	<span class="n">hd</span><span class="p">.</span><span class="n">hd_nirqs</span>		<span class="o">=</span> <span class="n">nrtimers</span><span class="p">;</span>
	<span class="n">hpet_reserve_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HPET_EMULATE_RTC</span>
	<span class="n">hpet_reserve_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE that hd_irq[] reflects IOAPIC input pins (LEGACY_8254</span>
<span class="cm">	 * is wrong for i8259!) not the output IRQ.  Many BIOS writers</span>
<span class="cm">	 * don&#39;t bother configuring *any* comparator interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">hd</span><span class="p">.</span><span class="n">hd_irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPET_LEGACY_8254</span><span class="p">;</span>
	<span class="n">hd</span><span class="p">.</span><span class="n">hd_irq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HPET_LEGACY_RTC</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrtimers</span><span class="p">;</span> <span class="n">timer</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hd</span><span class="p">.</span><span class="n">hd_irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">hpet_config</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">Tn_INT_ROUTE_CNF_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">Tn_INT_ROUTE_CNF_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hpet_reserve_msi_timers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="p">);</span>

	<span class="n">hpet_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="p">);</span>

<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_reserve_platform_timers</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Common hpet info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hpet_freq</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hpet_legacy_set_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">clock_event_mode</span> <span class="n">mode</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hpet_legacy_next_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The hpet clock event device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clock_event_device</span> <span class="n">hpet_clockevent</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hpet&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">features</span>	<span class="o">=</span> <span class="n">CLOCK_EVT_FEAT_PERIODIC</span> <span class="o">|</span> <span class="n">CLOCK_EVT_FEAT_ONESHOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mode</span>	<span class="o">=</span> <span class="n">hpet_legacy_set_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_next_event</span> <span class="o">=</span> <span class="n">hpet_legacy_next_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rating</span>		<span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_stop_counter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_CFG</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_CFG_ENABLE</span><span class="p">;</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_CFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_reset_counter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">HPET_COUNTER</span><span class="p">);</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">HPET_COUNTER</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_start_counter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_CFG</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">HPET_CFG_ENABLE</span><span class="p">;</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_CFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_restart_counter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpet_stop_counter</span><span class="p">();</span>
	<span class="n">hpet_reset_counter</span><span class="p">();</span>
	<span class="n">hpet_start_counter</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_resume_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">force_hpet_resume</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_resume_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">clocksource</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpet_resume_device</span><span class="p">();</span>
	<span class="n">hpet_restart_counter</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_enable_legacy_int</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_CFG</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">HPET_CFG_LEGACY</span><span class="p">;</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_CFG</span><span class="p">);</span>
	<span class="n">hpet_legacy_int_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_legacy_clockevent_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Start HPET legacy interrupts */</span>
	<span class="n">hpet_enable_legacy_int</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start hpet with the boot cpu mask and make it</span>
<span class="cm">	 * global after the IO_APIC has been initialized.</span>
<span class="cm">	 */</span>
	<span class="n">hpet_clockevent</span><span class="p">.</span><span class="n">cpumask</span> <span class="o">=</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">());</span>
	<span class="n">clockevents_config_and_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hpet_clockevent</span><span class="p">,</span> <span class="n">hpet_freq</span><span class="p">,</span>
					<span class="n">HPET_MIN_PROG_DELTA</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span><span class="p">);</span>
	<span class="n">global_clock_event</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpet_clockevent</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hpet clockevent registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hpet_setup_msi_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_set_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">clock_event_mode</span> <span class="n">mode</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cmp</span><span class="p">,</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">delta</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_PERIODIC</span>:
		<span class="n">hpet_stop_counter</span><span class="p">();</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="n">NSEC_PER_SEC</span><span class="o">/</span><span class="n">HZ</span><span class="p">))</span> <span class="o">*</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">mult</span><span class="p">;</span>
		<span class="n">delta</span> <span class="o">&gt;&gt;=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">now</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">);</span>
		<span class="n">cmp</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">delta</span><span class="p">;</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">HPET_TN_ENABLE</span> <span class="o">|</span> <span class="n">HPET_TN_PERIODIC</span> <span class="o">|</span>
		       <span class="n">HPET_TN_SETVAL</span> <span class="o">|</span> <span class="n">HPET_TN_32BIT</span><span class="p">;</span>
		<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
		<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="n">HPET_Tn_CMP</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * HPET on AMD 81xx needs a second write (with HPET_TN_SETVAL</span>
<span class="cm">		 * cleared) to T0_CMP to set the period. The HPET_TN_SETVAL</span>
<span class="cm">		 * bit is automatically cleared after the first write.</span>
<span class="cm">		 * (See AMD-8111 HyperTransport I/O Hub Data Sheet,</span>
<span class="cm">		 * Publication # 24674)</span>
<span class="cm">		 */</span>
		<span class="n">hpet_writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">delta</span><span class="p">,</span> <span class="n">HPET_Tn_CMP</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
		<span class="n">hpet_start_counter</span><span class="p">();</span>
		<span class="n">hpet_print_config</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_ONESHOT</span>:
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_TN_PERIODIC</span><span class="p">;</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">HPET_TN_ENABLE</span> <span class="o">|</span> <span class="n">HPET_TN_32BIT</span><span class="p">;</span>
		<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_UNUSED</span>:
	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_SHUTDOWN</span>:
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_TN_ENABLE</span><span class="p">;</span>
		<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_RESUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpet_enable_legacy_int</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">EVT_TO_HPET_DEV</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="n">hpet_setup_msi_irq</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">disable_irq</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">irq_set_affinity</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">));</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hpet_print_config</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_next_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">);</span>
	<span class="n">cnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="n">HPET_Tn_CMP</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * HPETs are a complete disaster. The compare register is</span>
<span class="cm">	 * based on a equal comparison and neither provides a less</span>
<span class="cm">	 * than or equal functionality (which would require to take</span>
<span class="cm">	 * the wraparound into account) nor a simple count down event</span>
<span class="cm">	 * mode. Further the write to the comparator register is</span>
<span class="cm">	 * delayed internally up to two HPET clock cycles in certain</span>
<span class="cm">	 * chipsets (ATI, ICH9,10). Some newer AMD chipsets have even</span>
<span class="cm">	 * longer delays. We worked around that by reading back the</span>
<span class="cm">	 * compare register, but that required another workaround for</span>
<span class="cm">	 * ICH9,10 chips where the first readout after write can</span>
<span class="cm">	 * return the old stale value. We already had a minimum</span>
<span class="cm">	 * programming delta of 5us enforced, but a NMI or SMI hitting</span>
<span class="cm">	 * between the counter readout and the comparator write can</span>
<span class="cm">	 * move us behind that point easily. Now instead of reading</span>
<span class="cm">	 * the compare register back several times, we make the ETIME</span>
<span class="cm">	 * decision based on the following: Return ETIME if the</span>
<span class="cm">	 * counter value after the write is less than HPET_MIN_CYCLES</span>
<span class="cm">	 * away from the event or if the counter is already ahead of</span>
<span class="cm">	 * the event. The minimum programming delta for the generic</span>
<span class="cm">	 * clockevents code is set to 1.5 * HPET_MIN_CYCLES.</span>
<span class="cm">	 */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">res</span> <span class="o">&lt;</span> <span class="n">HPET_MIN_CYCLES</span> <span class="o">?</span> <span class="o">-</span><span class="n">ETIME</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_legacy_set_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">clock_event_mode</span> <span class="n">mode</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpet_set_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_legacy_next_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hpet_next_event</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HPET MSI Support</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PCI_MSI</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="p">,</span> <span class="n">cpu_hpet_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hpet_dev</span>	<span class="o">*</span><span class="n">hpet_devs</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">hpet_msi_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">handler_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="cm">/* unmask it */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">HPET_TN_FSB</span><span class="p">;</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hpet_msi_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">handler_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="cm">/* mask it */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_TN_FSB</span><span class="p">;</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hpet_msi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">HPET_Tn_ROUTE</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span><span class="p">,</span> <span class="n">HPET_Tn_ROUTE</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hpet_msi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_ROUTE</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_ROUTE</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_msi_set_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">clock_event_mode</span> <span class="n">mode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">EVT_TO_HPET_DEV</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
	<span class="n">hpet_set_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_msi_next_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">EVT_TO_HPET_DEV</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hpet_next_event</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_setup_msi_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arch_setup_hpet_msi</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">hpet_blockid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">destroy_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_assign_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">create_irq_nr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">irq_set_handler_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_setup_msi_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">hpet_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">hevt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">evt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hevt</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Spurious HPET timer interrupt on HPET timer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hevt</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">hevt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_setup_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hpet_interrupt_handler</span><span class="p">,</span>
			<span class="n">IRQF_TIMER</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_NOBALANCING</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">irq_set_affinity</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">));</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hpet: %s irq %d for MSI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This should be called in specific @cpu */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_one_hpet_msi_clockevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">evt</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">smp_processor_id</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HPET_DEV_VALID</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_setup_msi_irq</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hpet_dev</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">hdev</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">hpet_setup_irq</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">rating</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">CLOCK_EVT_FEAT_ONESHOT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HPET_DEV_PERI_CAP</span><span class="p">)</span>
		<span class="n">evt</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">CLOCK_EVT_FEAT_PERIODIC</span><span class="p">;</span>

	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">set_mode</span> <span class="o">=</span> <span class="n">hpet_msi_set_mode</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">set_next_event</span> <span class="o">=</span> <span class="n">hpet_msi_next_event</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">cpumask</span> <span class="o">=</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">clockevents_config_and_register</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">hpet_freq</span><span class="p">,</span> <span class="n">HPET_MIN_PROG_DELTA</span><span class="p">,</span>
					<span class="mh">0x7FFFFFFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HPET</span>
<span class="cm">/* Reserve at least one timer for userspace (/dev/hpet) */</span>
<span class="cp">#define RESERVE_TIMERS 1</span>
<span class="cp">#else</span>
<span class="cp">#define RESERVE_TIMERS 0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_msi_capability_lookup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_timers</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_timers_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_msi_disable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_ARAT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_ID</span><span class="p">);</span>

	<span class="n">num_timers</span> <span class="o">=</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">HPET_ID_NUMBER</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">HPET_ID_NUMBER_SHIFT</span><span class="p">);</span>
	<span class="n">num_timers</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Value read out starts from 0 */</span>
	<span class="n">hpet_print_config</span><span class="p">();</span>

	<span class="n">hpet_devs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_dev</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_timers</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_devs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hpet_num_timers</span> <span class="o">=</span> <span class="n">num_timers</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start_timer</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_timers</span> <span class="o">-</span> <span class="n">RESERVE_TIMERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpet_devs</span><span class="p">[</span><span class="n">num_timers_used</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="cm">/* Only consider HPET timer with MSI support */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">HPET_TN_FSB_CAP</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">HPET_TN_PERIODIC_CAP</span><span class="p">)</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HPET_DEV_PERI_CAP</span><span class="p">;</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;hpet%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpet_assign_irq</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HPET_DEV_FSB_CAP</span><span class="p">;</span>
		<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HPET_DEV_VALID</span><span class="p">;</span>
		<span class="n">num_timers_used</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_timers_used</span> <span class="o">==</span> <span class="n">num_possible_cpus</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HPET: %d timers in total, %d timers will be used for per-cpu timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">num_timers</span><span class="p">,</span> <span class="n">num_timers_used</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HPET</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_reserve_msi_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_data</span> <span class="o">*</span><span class="n">hd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_devs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hpet_num_timers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpet_devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HPET_DEV_VALID</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hd</span><span class="o">-&gt;</span><span class="n">hd_irq</span><span class="p">[</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">hpet_reserve_timer</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="nf">hpet_get_unused_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_devs</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hpet_num_timers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpet_devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HPET_DEV_VALID</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HPET_DEV_USED_BIT</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">hdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">hpet_work_struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">complete</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">hpet_work_struct</span> <span class="o">*</span><span class="n">hpet_work</span><span class="p">;</span>

	<span class="n">hpet_work</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpet_work_struct</span><span class="p">,</span> <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">hdev</span> <span class="o">=</span> <span class="n">hpet_get_unused_timer</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="p">)</span>
		<span class="n">init_one_hpet_msi_clockevent</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hpet_work</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_cpuhp_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpet_work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpet_dev</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hpet_dev</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_ONLINE</span>:
		<span class="n">INIT_DELAYED_WORK_ONSTACK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="n">hpet_work</span><span class="p">);</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="p">.</span><span class="n">complete</span><span class="p">);</span>
		<span class="cm">/* FIXME: add schedule_work_on() */</span>
		<span class="n">schedule_delayed_work_on</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="p">.</span><span class="n">complete</span><span class="p">);</span>
		<span class="n">destroy_timer_on_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_DEAD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_DEV_USED</span><span class="p">;</span>
			<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_hpet_dev</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_setup_msi_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_msi_capability_lookup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HPET</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_reserve_msi_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpet_data</span> <span class="o">*</span><span class="n">hd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_cpuhp_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Clock source related code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">cycle_t</span> <span class="nf">read_hpet</span><span class="p">(</span><span class="k">struct</span> <span class="n">clocksource</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cycle_t</span><span class="p">)</span><span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clocksource</span> <span class="n">clocksource_hpet</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hpet&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rating</span>		<span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">read_hpet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span>		<span class="o">=</span> <span class="n">HPET_MASK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">CLOCK_SOURCE_IS_CONTINUOUS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">hpet_resume_counter</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="p">.</span><span class="n">archdata</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">vclock_mode</span> <span class="o">=</span> <span class="n">VCLOCK_HPET</span> <span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpet_clocksource_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">now</span><span class="p">;</span>
	<span class="n">cycle_t</span> <span class="n">t1</span><span class="p">;</span>

	<span class="cm">/* Start the counter */</span>
	<span class="n">hpet_restart_counter</span><span class="p">();</span>

	<span class="cm">/* Verify whether hpet counter works */</span>
	<span class="n">t1</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">);</span>
	<span class="n">rdtscll</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t know the TSC frequency yet, but waiting for</span>
<span class="cm">	 * 200000 TSC cycles is safe:</span>
<span class="cm">	 * 4 GHz == 50us</span>
<span class="cm">	 * 1 GHz == 200us</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rep_nop</span><span class="p">();</span>
		<span class="n">rdtscll</span><span class="p">(</span><span class="n">now</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">200000UL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">==</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HPET counter not counting. HPET disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clocksource_register_hz</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocksource_hpet</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">hpet_freq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hpet_boot_cfg</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * hpet_enable - Try to setup the HPET timer. Returns 1 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">hpet_enable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hpet_period</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hpet_capable</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hpet_set_mapping</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the period and check for a sane value:</span>
<span class="cm">	 */</span>
	<span class="n">hpet_period</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_PERIOD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * AMD SB700 based systems with spread spectrum enabled use a</span>
<span class="cm">	 * SMM based HPET emulation to provide proper frequency</span>
<span class="cm">	 * setting. The SMM code is initialized with the first HPET</span>
<span class="cm">	 * register access and takes some time to complete. During</span>
<span class="cm">	 * this time the config register reads 0xffffffff. We check</span>
<span class="cm">	 * for max. 1000 loops whether the config register reads a non</span>
<span class="cm">	 * 0xffffffff value to make sure that HPET is up and running</span>
<span class="cm">	 * before we go further. A counting loop is safe, as the HPET</span>
<span class="cm">	 * access takes thousands of CPU cycles. On non SB700 based</span>
<span class="cm">	 * machines this check is only done once and has no side</span>
<span class="cm">	 * effects.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_CFG</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HPET config register value = 0xFFFFFFFF. &quot;</span>
			       <span class="s">&quot;Disabling HPET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_nohpet</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_period</span> <span class="o">&lt;</span> <span class="n">HPET_MIN_PERIOD</span> <span class="o">||</span> <span class="n">hpet_period</span> <span class="o">&gt;</span> <span class="n">HPET_MAX_PERIOD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nohpet</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The period is a femto seconds value. Convert it to a</span>
<span class="cm">	 * frequency.</span>
<span class="cm">	 */</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">FSEC_PER_SEC</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">hpet_period</span><span class="p">);</span>
	<span class="n">hpet_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the HPET ID register to retrieve the IRQ routing</span>
<span class="cm">	 * information and the number of channels</span>
<span class="cm">	 */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_ID</span><span class="p">);</span>
	<span class="n">hpet_print_config</span><span class="p">();</span>

	<span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">HPET_ID_NUMBER</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">HPET_ID_NUMBER_SHIFT</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_HPET_EMULATE_RTC</span>
	<span class="cm">/*</span>
<span class="cm">	 * The legacy routing mode needs at least two channels, tick timer</span>
<span class="cm">	 * and the rtc emulation channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nohpet</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_CFG</span><span class="p">);</span>
	<span class="n">hpet_boot_cfg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">last</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hpet_boot_cfg</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_boot_cfg</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hpet_boot_cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;HPET initial state will not be saved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HPET_CFG_ENABLE</span> <span class="o">|</span> <span class="n">HPET_CFG_LEGACY</span><span class="p">);</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_CFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;HPET: Unrecognized bits %#x set in global cfg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cfg</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpet_boot_cfg</span><span class="p">)</span>
			<span class="n">hpet_boot_cfg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HPET_TN_ENABLE</span> <span class="o">|</span> <span class="n">HPET_TN_LEVEL</span> <span class="o">|</span> <span class="n">HPET_TN_FSB</span><span class="p">);</span>
		<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HPET_TN_PERIODIC</span> <span class="o">|</span> <span class="n">HPET_TN_PERIODIC_CAP</span>
			 <span class="o">|</span> <span class="n">HPET_TN_64BIT_CAP</span> <span class="o">|</span> <span class="n">HPET_TN_32BIT</span> <span class="o">|</span> <span class="n">HPET_TN_ROUTE</span>
			 <span class="o">|</span> <span class="n">HPET_TN_FSB</span> <span class="o">|</span> <span class="n">HPET_TN_FSB_CAP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;HPET: Unrecognized bits %#x set in cfg#%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hpet_print_config</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_clocksource_register</span><span class="p">())</span>
		<span class="k">goto</span> <span class="n">out_nohpet</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">HPET_ID_LEGSUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hpet_legacy_clockevent_register</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_nohpet:</span>
	<span class="n">hpet_clear_mapping</span><span class="p">();</span>
	<span class="n">hpet_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Needs to be late, as the reserve_timer code calls kalloc !</span>
<span class="cm"> *</span>
<span class="cm"> * Not a problem on i386 as hpet_enable is called from late_time_init,</span>
<span class="cm"> * but on x86_64 it is necessary !</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">hpet_late_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_hpet_disable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_hpet_address</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">hpet_address</span> <span class="o">=</span> <span class="n">force_hpet_address</span><span class="p">;</span>
		<span class="n">hpet_enable</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_virt_address</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_ID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HPET_ID_LEGSUP</span><span class="p">)</span>
		<span class="n">hpet_msi_capability_lookup</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hpet_msi_capability_lookup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">hpet_reserve_platform_timers</span><span class="p">(</span><span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_ID</span><span class="p">));</span>
	<span class="n">hpet_print_config</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_msi_disable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_ARAT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hpet_cpuhp_notify</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">CPU_ONLINE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This notifier should be called after workqueue is ready */</span>
	<span class="n">hotcpu_notifier</span><span class="p">(</span><span class="n">hpet_cpuhp_notify</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">fs_initcall</span><span class="p">(</span><span class="n">hpet_late_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">hpet_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_hpet_capable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hpet_virt_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_CFG</span><span class="p">),</span> <span class="n">id</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpet_boot_cfg</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">hpet_boot_cfg</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hpet_legacy_int_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_CFG_LEGACY</span><span class="p">;</span>
			<span class="n">hpet_legacy_int_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_CFG_ENABLE</span><span class="p">;</span>
		<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_CFG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_boot_cfg</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">id</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_ID</span><span class="p">);</span>
		<span class="n">last</span> <span class="o">=</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">HPET_ID_NUMBER</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">HPET_ID_NUMBER_SHIFT</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="o">++</span><span class="n">id</span><span class="p">)</span>
			<span class="n">hpet_writel</span><span class="p">(</span><span class="n">hpet_boot_cfg</span><span class="p">[</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">HPET_Tn_CFG</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hpet_boot_cfg</span> <span class="o">&amp;</span> <span class="n">HPET_CFG_ENABLE</span><span class="p">)</span>
			<span class="n">hpet_writel</span><span class="p">(</span><span class="o">*</span><span class="n">hpet_boot_cfg</span><span class="p">,</span> <span class="n">HPET_CFG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HPET_EMULATE_RTC</span>

<span class="cm">/* HPET in LegacyReplacement Mode eats up RTC interrupt line. When, HPET</span>
<span class="cm"> * is enabled, we support RTC interrupt functionality in software.</span>
<span class="cm"> * RTC has 3 kinds of interrupts:</span>
<span class="cm"> * 1) Update Interrupt - generate an interrupt, every sec, when RTC clock</span>
<span class="cm"> *    is updated</span>
<span class="cm"> * 2) Alarm Interrupt - generate an interrupt at a specific time of day</span>
<span class="cm"> * 3) Periodic Interrupt - generate periodic interrupt, with frequencies</span>
<span class="cm"> *    2Hz-8192Hz (2Hz-64Hz for non-root user) (all freqs in powers of 2)</span>
<span class="cm"> * (1) and (2) above are implemented using polling at a frequency of</span>
<span class="cm"> * 64 Hz. The exact frequency is a tradeoff between accuracy and interrupt</span>
<span class="cm"> * overhead. (DEFAULT_RTC_INT_FREQ)</span>
<span class="cm"> * For (3), we use interrupts at 64Hz or user specified periodic</span>
<span class="cm"> * frequency, whichever is higher.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;asm/rtc.h&gt;</span>

<span class="cp">#define DEFAULT_RTC_INT_FREQ	64</span>
<span class="cp">#define DEFAULT_RTC_SHIFT	6</span>
<span class="cp">#define RTC_NUM_INTS		1</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hpet_rtc_flags</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hpet_prev_update_sec</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">hpet_alarm_time</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hpet_pie_count</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hpet_t1_cmp</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hpet_default_delta</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hpet_pie_delta</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hpet_pie_limit</span><span class="p">;</span>

<span class="k">static</span> <span class="n">rtc_irq_handler</span> <span class="n">irq_handler</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Check that the hpet counter c1 is ahead of the c2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hpet_cnt_ahead</span><span class="p">(</span><span class="n">u32</span> <span class="n">c1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">s32</span><span class="p">)(</span><span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Registers a IRQ handler.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">hpet_register_irq_handler</span><span class="p">(</span><span class="n">rtc_irq_handler</span> <span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hpet_enabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_handler</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">irq_handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_register_irq_handler</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Deregisters the IRQ handler registered with hpet_register_irq_handler()</span>
<span class="cm"> * and does cleanup.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">hpet_unregister_irq_handler</span><span class="p">(</span><span class="n">rtc_irq_handler</span> <span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hpet_enabled</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">irq_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hpet_rtc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_unregister_irq_handler</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Timer 1 for RTC emulation. We use one shot mode, as periodic mode</span>
<span class="cm"> * is not supported by all HPET implementations for timer 1.</span>
<span class="cm"> *</span>
<span class="cm"> * hpet_rtc_timer_init() is called when the rtc is initialized.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">hpet_rtc_timer_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hpet_enabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_default_delta</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">clc</span><span class="p">;</span>

		<span class="n">clc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">hpet_clockevent</span><span class="p">.</span><span class="n">mult</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">;</span>
		<span class="n">clc</span> <span class="o">&gt;&gt;=</span> <span class="n">hpet_clockevent</span><span class="p">.</span><span class="n">shift</span> <span class="o">+</span> <span class="n">DEFAULT_RTC_SHIFT</span><span class="p">;</span>
		<span class="n">hpet_default_delta</span> <span class="o">=</span> <span class="n">clc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hpet_rtc_flags</span> <span class="o">&amp;</span> <span class="n">RTC_PIE</span><span class="p">)</span> <span class="o">||</span> <span class="n">hpet_pie_limit</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">hpet_default_delta</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">hpet_pie_delta</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">);</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="n">HPET_T1_CMP</span><span class="p">);</span>
	<span class="n">hpet_t1_cmp</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_T1_CFG</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_TN_PERIODIC</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">HPET_TN_ENABLE</span> <span class="o">|</span> <span class="n">HPET_TN_32BIT</span><span class="p">;</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_T1_CFG</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_rtc_timer_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_disable_rtc_channel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_T1_CFG</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPET_TN_ENABLE</span><span class="p">;</span>
	<span class="n">hpet_writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">HPET_T1_CFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The functions below are called from rtc driver.</span>
<span class="cm"> * Return 0 if HPET is not being used.</span>
<span class="cm"> * Otherwise do the necessary changes and return 1.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">hpet_mask_rtc_irq_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hpet_enabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hpet_rtc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">hpet_rtc_flags</span><span class="p">))</span>
		<span class="n">hpet_disable_rtc_channel</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_mask_rtc_irq_bit</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hpet_set_rtc_irq_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oldbits</span> <span class="o">=</span> <span class="n">hpet_rtc_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hpet_enabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hpet_rtc_flags</span> <span class="o">|=</span> <span class="n">bit_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bit_mask</span> <span class="o">&amp;</span> <span class="n">RTC_UIE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">oldbits</span> <span class="o">&amp;</span> <span class="n">RTC_UIE</span><span class="p">))</span>
		<span class="n">hpet_prev_update_sec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldbits</span><span class="p">)</span>
		<span class="n">hpet_rtc_timer_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_set_rtc_irq_bit</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hpet_set_alarm_time</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hrs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">min</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hpet_enabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hpet_alarm_time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">hrs</span><span class="p">;</span>
	<span class="n">hpet_alarm_time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">hpet_alarm_time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_set_alarm_time</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hpet_set_periodic_freq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">clc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_hpet_enabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="n">DEFAULT_RTC_INT_FREQ</span><span class="p">)</span>
		<span class="n">hpet_pie_limit</span> <span class="o">=</span> <span class="n">DEFAULT_RTC_INT_FREQ</span> <span class="o">/</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">clc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">hpet_clockevent</span><span class="p">.</span><span class="n">mult</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">clc</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="n">clc</span> <span class="o">&gt;&gt;=</span> <span class="n">hpet_clockevent</span><span class="p">.</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">hpet_pie_delta</span> <span class="o">=</span> <span class="n">clc</span><span class="p">;</span>
		<span class="n">hpet_pie_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_set_periodic_freq</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hpet_rtc_dropped_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">is_hpet_enabled</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_rtc_dropped_irq</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hpet_rtc_timer_reinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lost_ints</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">hpet_rtc_flags</span><span class="p">))</span>
		<span class="n">hpet_disable_rtc_channel</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hpet_rtc_flags</span> <span class="o">&amp;</span> <span class="n">RTC_PIE</span><span class="p">)</span> <span class="o">||</span> <span class="n">hpet_pie_limit</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">hpet_default_delta</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">hpet_pie_delta</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Increment the comparator value until we are ahead of the</span>
<span class="cm">	 * current count.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">hpet_t1_cmp</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="n">hpet_writel</span><span class="p">(</span><span class="n">hpet_t1_cmp</span><span class="p">,</span> <span class="n">HPET_T1_CMP</span><span class="p">);</span>
		<span class="n">lost_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_cnt_ahead</span><span class="p">(</span><span class="n">hpet_t1_cmp</span><span class="p">,</span> <span class="n">hpet_readl</span><span class="p">(</span><span class="n">HPET_COUNTER</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lost_ints</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpet_rtc_flags</span> <span class="o">&amp;</span> <span class="n">RTC_PIE</span><span class="p">)</span>
			<span class="n">hpet_pie_count</span> <span class="o">+=</span> <span class="n">lost_ints</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hpet1: lost %d rtc interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">lost_ints</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">hpet_rtc_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">curr_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtc_int_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hpet_rtc_timer_reinit</span><span class="p">();</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">curr_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_time</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_rtc_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTC_UIE</span> <span class="o">|</span> <span class="n">RTC_AIE</span><span class="p">))</span>
		<span class="n">get_rtc_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">curr_time</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_rtc_flags</span> <span class="o">&amp;</span> <span class="n">RTC_UIE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">curr_time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">!=</span> <span class="n">hpet_prev_update_sec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpet_prev_update_sec</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rtc_int_flag</span> <span class="o">=</span> <span class="n">RTC_UF</span><span class="p">;</span>
		<span class="n">hpet_prev_update_sec</span> <span class="o">=</span> <span class="n">curr_time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_rtc_flags</span> <span class="o">&amp;</span> <span class="n">RTC_PIE</span> <span class="o">&amp;&amp;</span>
	    <span class="o">++</span><span class="n">hpet_pie_count</span> <span class="o">&gt;=</span> <span class="n">hpet_pie_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_int_flag</span> <span class="o">|=</span> <span class="n">RTC_PF</span><span class="p">;</span>
		<span class="n">hpet_pie_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_rtc_flags</span> <span class="o">&amp;</span> <span class="n">RTC_AIE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">curr_time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">==</span> <span class="n">hpet_alarm_time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">curr_time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">==</span> <span class="n">hpet_alarm_time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">curr_time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">==</span> <span class="n">hpet_alarm_time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">))</span>
			<span class="n">rtc_int_flag</span> <span class="o">|=</span> <span class="n">RTC_AF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_int_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_int_flag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RTC_IRQF</span> <span class="o">|</span> <span class="p">(</span><span class="n">RTC_NUM_INTS</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_handler</span><span class="p">)</span>
			<span class="n">irq_handler</span><span class="p">(</span><span class="n">rtc_int_flag</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hpet_rtc_interrupt</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
