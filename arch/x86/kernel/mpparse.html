<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › mpparse.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mpparse.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Intel Multiprocessor Specification 1.1 and 1.4</span>
<span class="cm"> *	compliant MP-table parsing routines.</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) 1995 Alan Cox, Building #3 &lt;alan@lxorguk.ukuu.org.uk&gt;</span>
<span class="cm"> *	(c) 1998, 1999, 2000, 2009 Ingo Molnar &lt;mingo@redhat.com&gt;</span>
<span class="cm"> *      (c) 2008 Alexey Starikovskiy &lt;astarikovskiy@suse.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#include &lt;asm/mpspec.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/io_apic.h&gt;</span>
<span class="cp">#include &lt;asm/proto.h&gt;</span>
<span class="cp">#include &lt;asm/bios_ebda.h&gt;</span>
<span class="cp">#include &lt;asm/e820.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>

<span class="cp">#include &lt;asm/apic.h&gt;</span>
<span class="cm">/*</span>
<span class="cm"> * Checksum an MP configuration block.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mpf_checksum</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">mp</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">default_mpc_apic_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_cpu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">apicid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">MP_processor_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_cpu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">apicid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bootup_cpu</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">cpuflag</span> <span class="o">&amp;</span> <span class="n">CPU_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">disabled_cpus</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">apicid</span> <span class="o">=</span> <span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">mpc_apic_id</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">cpuflag</span> <span class="o">&amp;</span> <span class="n">CPU_BOOTPROCESSOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bootup_cpu</span> <span class="o">=</span> <span class="s">&quot; (Bootup-CPU)&quot;</span><span class="p">;</span>
		<span class="n">boot_cpu_physical_apicid</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">apicid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Processor #%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">apicid</span><span class="p">,</span> <span class="n">bootup_cpu</span><span class="p">);</span>
	<span class="n">generic_processor_info</span><span class="p">(</span><span class="n">apicid</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">apicver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">default_mpc_oem_bus_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_bus</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">bustype</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">str</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">apic_printk</span><span class="p">(</span><span class="n">APIC_VERBOSE</span><span class="p">,</span> <span class="s">&quot;Bus #%d is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">busid</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">MP_bus_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_bus</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">mpc_oem_bus_info</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

<span class="cp">#if MAX_MP_BUSSES &lt; 256</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">busid</span> <span class="o">&gt;=</span> <span class="n">MAX_MP_BUSSES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;MP table busid value (%d) for bustype %s &quot;</span>
		       <span class="s">&quot; is too large, max. supported is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">m</span><span class="o">-&gt;</span><span class="n">busid</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">MAX_MP_BUSSES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">busid</span><span class="p">,</span> <span class="n">mp_bus_not_pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">BUSTYPE_ISA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BUSTYPE_ISA</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_EISA</span>
		<span class="n">mp_bus_id_to_type</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">busid</span><span class="p">]</span> <span class="o">=</span> <span class="n">MP_BUS_ISA</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">BUSTYPE_PCI</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BUSTYPE_PCI</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">mpc_oem_pci_bus</span><span class="p">)</span>
			<span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">mpc_oem_pci_bus</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">busid</span><span class="p">,</span> <span class="n">mp_bus_not_pci</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_EISA</span>
		<span class="n">mp_bus_id_to_type</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">busid</span><span class="p">]</span> <span class="o">=</span> <span class="n">MP_BUS_PCI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">BUSTYPE_EISA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BUSTYPE_EISA</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp_bus_id_to_type</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">busid</span><span class="p">]</span> <span class="o">=</span> <span class="n">MP_BUS_EISA</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unknown bustype %s - ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">MP_ioapic_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_ioapic</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPC_APIC_USABLE</span><span class="p">)</span>
		<span class="n">mp_register_ioapic</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">apicid</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">apicaddr</span><span class="p">,</span> <span class="n">gsi_top</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">print_mp_irq_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="n">mp_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">apic_printk</span><span class="p">(</span><span class="n">APIC_VERBOSE</span><span class="p">,</span> <span class="s">&quot;Int: type %d, pol %d, trig %d, bus %02x,&quot;</span>
		<span class="s">&quot; IRQ %02x, APIC ID %x, APIC INT %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mp_irq</span><span class="o">-&gt;</span><span class="n">irqtype</span><span class="p">,</span> <span class="n">mp_irq</span><span class="o">-&gt;</span><span class="n">irqflag</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mp_irq</span><span class="o">-&gt;</span><span class="n">irqflag</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mp_irq</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">,</span>
		<span class="n">mp_irq</span><span class="o">-&gt;</span><span class="n">srcbusirq</span><span class="p">,</span> <span class="n">mp_irq</span><span class="o">-&gt;</span><span class="n">dstapic</span><span class="p">,</span> <span class="n">mp_irq</span><span class="o">-&gt;</span><span class="n">dstirq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_X86_IO_APIC */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">MP_bus_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_bus</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">MP_ioapic_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_ioapic</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_IO_APIC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">MP_lintsrc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_lintsrc</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">apic_printk</span><span class="p">(</span><span class="n">APIC_VERBOSE</span><span class="p">,</span> <span class="s">&quot;Lint: type %d, pol %d, trig %d, bus %02x,&quot;</span>
		<span class="s">&quot; IRQ %02x, APIC ID %x, APIC LINT %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">irqtype</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">irqflag</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">irqflag</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">srcbusid</span><span class="p">,</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">srcbusirq</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">destapic</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">destapiclint</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read/parse the MPC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">smp_check_mpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_table</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oem</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">,</span> <span class="n">MPC_SIGNATURE</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPTABLE: bad signature [%c%c%c%c]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		       <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpf_checksum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPTABLE: checksum error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">!=</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">!=</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPTABLE: bad table version (%d)!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">lapic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPTABLE: null local APIC address!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">oem</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">oem</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">oem</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MPTABLE: OEM ID: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oem</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">productid</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">str</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MPTABLE: Product ID: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MPTABLE: APIC at: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">lapic</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">skip_entry</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">count</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">smp_dump_mptable</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_table</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mpt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Your mptable is wrong, contact your HW vendor!</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">mpt</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span> <span class="n">mpc</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">default_smp_read_mpc_oem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_table</span> <span class="o">*</span><span class="n">mpc</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">smp_read_mpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_table</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">early</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">oem</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mpt</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpc</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smp_check_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">oem</span><span class="p">,</span> <span class="n">str</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">generic_mps_oem_check</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">oem</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Initialize the lapic mapping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_lapic</span><span class="p">)</span>
		<span class="n">register_lapic_address</span><span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">lapic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">early</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc</span><span class="o">-&gt;</span><span class="n">oemptr</span><span class="p">)</span>
		<span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">smp_read_mpc_oem</span><span class="p">(</span><span class="n">mpc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *      Now process the configuration blocks.</span>
<span class="cm">	 */</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">mpc_record</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">mpt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MP_PROCESSOR</span>:
			<span class="cm">/* ACPI may have already provided this data */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_lapic</span><span class="p">)</span>
				<span class="n">MP_processor_info</span><span class="p">((</span><span class="k">struct</span> <span class="n">mpc_cpu</span> <span class="o">*</span><span class="p">)</span><span class="n">mpt</span><span class="p">);</span>
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_cpu</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP_BUS</span>:
			<span class="n">MP_bus_info</span><span class="p">((</span><span class="k">struct</span> <span class="n">mpc_bus</span> <span class="o">*</span><span class="p">)</span><span class="n">mpt</span><span class="p">);</span>
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_bus</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP_IOAPIC</span>:
			<span class="n">MP_ioapic_info</span><span class="p">((</span><span class="k">struct</span> <span class="n">mpc_ioapic</span> <span class="o">*</span><span class="p">)</span><span class="n">mpt</span><span class="p">);</span>
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_ioapic</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP_INTSRC</span>:
			<span class="n">mp_save_irq</span><span class="p">((</span><span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="p">)</span><span class="n">mpt</span><span class="p">);</span>
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP_LINTSRC</span>:
			<span class="n">MP_lintsrc_info</span><span class="p">((</span><span class="k">struct</span> <span class="n">mpc_lintsrc</span> <span class="o">*</span><span class="p">)</span><span class="n">mpt</span><span class="p">);</span>
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_lintsrc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* wrong mptable */</span>
			<span class="n">smp_dump_mptable</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mpt</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">mpc_record</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_processors</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPTABLE: no processors registered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num_processors</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ELCR_trigger</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="mh">0x4d0</span> <span class="o">+</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">construct_default_ioirq_mptable</span><span class="p">(</span><span class="kt">int</span> <span class="n">mpc_default_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="n">intsrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ELCR_fallback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">intsrc</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_INTSRC</span><span class="p">;</span>
	<span class="n">intsrc</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* conforming */</span>
	<span class="n">intsrc</span><span class="p">.</span><span class="n">srcbus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">intsrc</span><span class="p">.</span><span class="n">dstapic</span> <span class="o">=</span> <span class="n">mpc_ioapic_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">intsrc</span><span class="p">.</span><span class="n">irqtype</span> <span class="o">=</span> <span class="n">mp_INT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If true, we have an ISA/PCI system with no IRQ entries</span>
<span class="cm">	 *  in the MP table. To prevent the PCI interrupts from being set up</span>
<span class="cm">	 *  incorrectly, we try to use the ELCR. The sanity check to see if</span>
<span class="cm">	 *  there is good ELCR data is very simple - IRQ0, 1, 2 and 13 can</span>
<span class="cm">	 *  never be level sensitive, so we simply see if the ELCR agrees.</span>
<span class="cm">	 *  If it does, we assume it&#39;s valid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc_default_type</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ISA/PCI bus type with no IRQ information... &quot;</span>
		       <span class="s">&quot;falling back to ELCR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ELCR_trigger</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">ELCR_trigger</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">ELCR_trigger</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ELCR_trigger</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ELCR contains invalid data... &quot;</span>
			       <span class="s">&quot;not using ELCR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;Using ELCR to identify PCI interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ELCR_fallback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mpc_default_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* IRQ0 &amp; IRQ13 not connected */</span>
			<span class="cm">/* fall through */</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* IRQ2 is never connected */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ELCR_fallback</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *  If the ELCR indicates a level-sensitive interrupt, we</span>
<span class="cm">			 *  copy that information over to the MP table in the</span>
<span class="cm">			 *  irqflag field (level sensitive, active high polarity).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ELCR_trigger</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
				<span class="n">intsrc</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">intsrc</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">intsrc</span><span class="p">.</span><span class="n">srcbusirq</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">intsrc</span><span class="p">.</span><span class="n">dstirq</span> <span class="o">=</span> <span class="n">i</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* IRQ0 to INTIN2 */</span>
		<span class="n">mp_save_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intsrc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intsrc</span><span class="p">.</span><span class="n">irqtype</span> <span class="o">=</span> <span class="n">mp_ExtINT</span><span class="p">;</span>
	<span class="n">intsrc</span><span class="p">.</span><span class="n">srcbusirq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">intsrc</span><span class="p">.</span><span class="n">dstirq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 8259A to INTIN0 */</span>
	<span class="n">mp_save_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intsrc</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">construct_ioapic_table</span><span class="p">(</span><span class="kt">int</span> <span class="n">mpc_default_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_ioapic</span> <span class="n">ioapic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_bus</span> <span class="n">bus</span><span class="p">;</span>

	<span class="n">bus</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_BUS</span><span class="p">;</span>
	<span class="n">bus</span><span class="p">.</span><span class="n">busid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mpc_default_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;???</span><span class="se">\n</span><span class="s">Unknown standard configuration %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mpc_default_type</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">bustype</span><span class="p">,</span> <span class="s">&quot;ISA   &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">6</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">bustype</span><span class="p">,</span> <span class="s">&quot;EISA  &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">MP_bus_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc_default_type</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span><span class="p">.</span><span class="n">busid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">bustype</span><span class="p">,</span> <span class="s">&quot;PCI   &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">MP_bus_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ioapic</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">MP_IOAPIC</span><span class="p">;</span>
	<span class="n">ioapic</span><span class="p">.</span><span class="n">apicid</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ioapic</span><span class="p">.</span><span class="n">apicver</span>	<span class="o">=</span> <span class="n">mpc_default_type</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ioapic</span><span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">MPC_APIC_USABLE</span><span class="p">;</span>
	<span class="n">ioapic</span><span class="p">.</span><span class="n">apicaddr</span>	<span class="o">=</span> <span class="n">IO_APIC_DEFAULT_PHYS_BASE</span><span class="p">;</span>
	<span class="n">MP_ioapic_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioapic</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We set up most of the low 16 IO-APIC pins according to MPS rules.</span>
<span class="cm">	 */</span>
	<span class="n">construct_default_ioirq_mptable</span><span class="p">(</span><span class="n">mpc_default_type</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">construct_ioapic_table</span><span class="p">(</span><span class="kt">int</span> <span class="n">mpc_default_type</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">construct_default_ISA_mptable</span><span class="p">(</span><span class="kt">int</span> <span class="n">mpc_default_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_cpu</span> <span class="n">processor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_lintsrc</span> <span class="n">lintsrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linttypes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">mp_ExtINT</span><span class="p">,</span> <span class="n">mp_NMI</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * local APIC has default address</span>
<span class="cm">	 */</span>
	<span class="n">mp_lapic_addr</span> <span class="o">=</span> <span class="n">APIC_DEFAULT_PHYS_BASE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 2 CPUs, numbered 0 &amp; 1.</span>
<span class="cm">	 */</span>
	<span class="n">processor</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_PROCESSOR</span><span class="p">;</span>
	<span class="cm">/* Either an integrated APIC or a discrete 82489DX. */</span>
	<span class="n">processor</span><span class="p">.</span><span class="n">apicver</span> <span class="o">=</span> <span class="n">mpc_default_type</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">processor</span><span class="p">.</span><span class="n">cpuflag</span> <span class="o">=</span> <span class="n">CPU_ENABLED</span><span class="p">;</span>
	<span class="n">processor</span><span class="p">.</span><span class="n">cpufeature</span> <span class="o">=</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_mask</span><span class="p">;</span>
	<span class="n">processor</span><span class="p">.</span><span class="n">featureflag</span> <span class="o">=</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_capability</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">processor</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">processor</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">processor</span><span class="p">.</span><span class="n">apicid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">MP_processor_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processor</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">construct_ioapic_table</span><span class="p">(</span><span class="n">mpc_default_type</span><span class="p">);</span>

	<span class="n">lintsrc</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_LINTSRC</span><span class="p">;</span>
	<span class="n">lintsrc</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* conforming */</span>
	<span class="n">lintsrc</span><span class="p">.</span><span class="n">srcbusid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lintsrc</span><span class="p">.</span><span class="n">srcbusirq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lintsrc</span><span class="p">.</span><span class="n">destapic</span> <span class="o">=</span> <span class="n">MP_APIC_ALL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lintsrc</span><span class="p">.</span><span class="n">irqtype</span> <span class="o">=</span> <span class="n">linttypes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">lintsrc</span><span class="p">.</span><span class="n">destapiclint</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">MP_lintsrc_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lintsrc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpf_intel</span> <span class="o">*</span><span class="n">mpf_found</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">get_mpc_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_table</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">early_ioremap</span><span class="p">(</span><span class="n">physptr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">early_iounmap</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">apic_printk</span><span class="p">(</span><span class="n">APIC_VERBOSE</span><span class="p">,</span> <span class="s">&quot;  mpc: %lx-%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">physptr</span><span class="p">,</span> <span class="n">physptr</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">check_physptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpf_intel</span> <span class="o">*</span><span class="n">mpf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">early</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc_table</span> <span class="o">*</span><span class="n">mpc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">get_mpc_size</span><span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">);</span>
	<span class="n">mpc</span> <span class="o">=</span> <span class="n">early_ioremap</span><span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Read the physical hardware table.  Anything here will</span>
<span class="cm">	 * override the defaults.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smp_read_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">early</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
		<span class="n">smp_found_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;BIOS bug, MP table errors detected!...</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;... disabling SMP support. (tell your hw vendor)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">early_iounmap</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">early_iounmap</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">early</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
	<span class="cm">/*</span>
<span class="cm">	 * If there are no explicit MP IRQ entries, then we are</span>
<span class="cm">	 * broken.  We set up most of the low 16 IO-APIC pins to</span>
<span class="cm">	 * ISA defaults and hope it will work.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp_irq_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mpc_bus</span> <span class="n">bus</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;BIOS bug, no explicit IRQ entries, &quot;</span>
		       <span class="s">&quot;using default mptable. (tell your hw vendor)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">bus</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_BUS</span><span class="p">;</span>
		<span class="n">bus</span><span class="p">.</span><span class="n">busid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bus</span><span class="p">.</span><span class="n">bustype</span><span class="p">,</span> <span class="s">&quot;ISA   &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">MP_bus_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="p">);</span>

		<span class="n">construct_default_ioirq_mptable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scan the memory blocks for an SMP configuration block.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">default_get_smp_config</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">early</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpf_intel</span> <span class="o">*</span><span class="n">mpf</span> <span class="o">=</span> <span class="n">mpf_found</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_lapic</span> <span class="o">&amp;&amp;</span> <span class="n">early</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * MPS doesn&#39;t support hyperthreading, aka only have</span>
<span class="cm">	 * thread 0 apic id in MPS table</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_lapic</span> <span class="o">&amp;&amp;</span> <span class="n">acpi_ioapic</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Intel MultiProcessor Specification v1.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mpf</span><span class="o">-&gt;</span><span class="n">specification</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_X86_LOCAL_APIC) &amp;&amp; defined(CONFIG_X86_32)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">feature2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    IMCR and PIC compatibility mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pic_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    Virtual Wire compatibility mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pic_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now see if we need to read further.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">feature1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">early</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * local APIC has default address</span>
<span class="cm">			 */</span>
			<span class="n">mp_lapic_addr</span> <span class="o">=</span> <span class="n">APIC_DEFAULT_PHYS_BASE</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Default MP configuration #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mpf</span><span class="o">-&gt;</span><span class="n">feature1</span><span class="p">);</span>
		<span class="n">construct_default_ISA_mptable</span><span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">feature1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_physptr</span><span class="p">(</span><span class="n">mpf</span><span class="p">,</span> <span class="n">early</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">early</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Processors: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_processors</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Only use the first configuration found.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">smp_reserve_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpf_intel</span> <span class="o">*</span><span class="n">mpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">,</span> <span class="n">get_mpc_size</span><span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">smp_scan_config</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpf_intel</span> <span class="o">*</span><span class="n">mpf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem</span><span class="p">;</span>

	<span class="n">apic_printk</span><span class="p">(</span><span class="n">APIC_VERBOSE</span><span class="p">,</span> <span class="s">&quot;Scan for SMP in [mem %#010lx-%#010lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">base</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpf_intel</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">bp</span> <span class="o">==</span> <span class="n">SMP_MAGIC_IDENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">mpf_checksum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">specification</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		     <span class="o">||</span> <span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">specification</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
			<span class="n">smp_found_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">mpf_found</span> <span class="o">=</span> <span class="n">mpf</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;found SMP MP-table at [mem %#010llx-%#010llx] mapped at [%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">mpf</span><span class="p">),</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">mpf</span><span class="p">)</span> <span class="o">+</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mpf</span><span class="p">);</span>

			<span class="n">mem</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">mpf</span><span class="p">);</span>
			<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpf</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">)</span>
				<span class="n">smp_reserve_memory</span><span class="p">(</span><span class="n">mpf</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">default_find_smp_config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: Linux assumes you have 640K of base ram..</span>
<span class="cm">	 * this continues the error...</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1) Scan the bottom 1K for a signature</span>
<span class="cm">	 * 2) Scan the top 1K of base RAM</span>
<span class="cm">	 * 3) Scan the 64K of bios</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smp_scan_config</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">smp_scan_config</span><span class="p">(</span><span class="mi">639</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">smp_scan_config</span><span class="p">(</span><span class="mh">0xF0000</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If it is an SMP machine we should know now, unless the</span>
<span class="cm">	 * configuration is in an EISA bus machine with an</span>
<span class="cm">	 * extended bios data area.</span>
<span class="cm">	 *</span>
<span class="cm">	 * there is a real-mode segmented pointer pointing to the</span>
<span class="cm">	 * 4K EBDA area at 0x40E, calculate and scan it here.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE! There are Linux loaders that will corrupt the EBDA</span>
<span class="cm">	 * area, and as such this kind of SMP config may be less</span>
<span class="cm">	 * trustworthy, simply because the SMP table may have been</span>
<span class="cm">	 * stomped on during early boot. These loaders are buggy and</span>
<span class="cm">	 * should be fixed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * MP1.4 SPEC states to only scan first 1K of 4K EBDA.</span>
<span class="cm">	 */</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">get_bios_ebda</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span>
		<span class="n">smp_scan_config</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">__initdata</span> <span class="n">irq_used</span><span class="p">[</span><span class="n">MAX_IRQ_SOURCES</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">__init</span> <span class="nf">get_MP_intsrc_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">irqtype</span> <span class="o">!=</span> <span class="n">mp_INT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">irqflag</span> <span class="o">!=</span> <span class="mh">0x0f</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* not legacy */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp_irq_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqtype</span> <span class="o">!=</span> <span class="n">mp_INT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqflag</span> <span class="o">!=</span> <span class="mh">0x0f</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">srcbus</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">srcbusirq</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">srcbusirq</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_used</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* already claimed */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">irq_used</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* not found */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SPARE_SLOT_NUM 20</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="n">__initdata</span> <span class="o">*</span><span class="n">m_spare</span><span class="p">[</span><span class="n">SPARE_SLOT_NUM</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">check_irq_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nr_m_spare</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">apic_printk</span><span class="p">(</span><span class="n">APIC_VERBOSE</span><span class="p">,</span> <span class="s">&quot;OLD &quot;</span><span class="p">);</span>
	<span class="n">print_mp_irq_info</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">get_MP_intsrc_index</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">));</span>
		<span class="n">apic_printk</span><span class="p">(</span><span class="n">APIC_VERBOSE</span><span class="p">,</span> <span class="s">&quot;NEW &quot;</span><span class="p">);</span>
		<span class="n">print_mp_irq_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* legacy, do nothing */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nr_m_spare</span> <span class="o">&lt;</span> <span class="n">SPARE_SLOT_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * not found (-1), or duplicated (-2) are invalid entries,</span>
<span class="cm">		 * we need to use the slot later</span>
<span class="cm">		 */</span>
		<span class="n">m_spare</span><span class="p">[</span><span class="o">*</span><span class="n">nr_m_spare</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
		<span class="o">*</span><span class="n">nr_m_spare</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">check_slot</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mpc_new_phys</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mpc_new_length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpc_new_phys</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">mpc_new_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;update_mptable: No spare slots (length: %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_X86_IO_APIC */</span><span class="cp"></span>
<span class="k">static</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">check_irq_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nr_m_spare</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_IO_APIC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">__init</span> <span class="nf">replace_intsrc_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_table</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mpc_new_phys</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mpc_new_length</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr_m_spare</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mpt</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpc</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpc_length %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">mpt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MP_PROCESSOR</span>:
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_cpu</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP_BUS</span>:
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_bus</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP_IOAPIC</span>:
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_ioapic</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP_INTSRC</span>:
			<span class="n">check_irq_src</span><span class="p">((</span><span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="p">)</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_m_spare</span><span class="p">);</span>
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP_LINTSRC</span>:
			<span class="n">skip_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_lintsrc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* wrong mptable */</span>
			<span class="n">smp_dump_mptable</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mpt</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mp_irq_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_used</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqtype</span> <span class="o">!=</span> <span class="n">mp_INT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqflag</span> <span class="o">!=</span> <span class="mh">0x0f</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nr_m_spare</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">apic_printk</span><span class="p">(</span><span class="n">APIC_VERBOSE</span><span class="p">,</span> <span class="s">&quot;*NEW* found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">nr_m_spare</span><span class="o">--</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">m_spare</span><span class="p">[</span><span class="n">nr_m_spare</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">m_spare</span><span class="p">[</span><span class="n">nr_m_spare</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="p">)</span><span class="n">mpt</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_slot</span><span class="p">(</span><span class="n">mpc_new_phys</span><span class="p">,</span> <span class="n">mpc_new_length</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">));</span>
			<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">mpt</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc_intsrc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">print_mp_irq_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="nl">out:</span>
	<span class="cm">/* update checksum */</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">-=</span> <span class="n">mpf_checksum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">enable_update_mptable</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">update_mptable_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enable_update_mptable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_routeirq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;update_mptable&quot;</span><span class="p">,</span> <span class="n">update_mptable_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">mpc_new_phys</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mpc_new_length</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>

<span class="cm">/* alloc_mptable or alloc_mptable=4k */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">alloc_mptable</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_alloc_mptable_opt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enable_update_mptable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_routeirq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">alloc_mptable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpc_new_length</span> <span class="o">=</span> <span class="n">memparse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;alloc_mptable&quot;</span><span class="p">,</span> <span class="n">parse_alloc_mptable_opt</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">early_reserve_e820_mpc_new</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_update_mptable</span> <span class="o">&amp;&amp;</span> <span class="n">alloc_mptable</span><span class="p">)</span>
		<span class="n">mpc_new_phys</span> <span class="o">=</span> <span class="n">early_reserve_e820</span><span class="p">(</span><span class="n">mpc_new_length</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">update_mp_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">oem</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mpf_intel</span> <span class="o">*</span><span class="n">mpf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_table</span> <span class="o">*</span><span class="n">mpc</span><span class="p">,</span> <span class="o">*</span><span class="n">mpc_new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_update_mptable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mpf</span> <span class="o">=</span> <span class="n">mpf_found</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now see if we need to go further.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">feature1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mpc</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smp_check_mpc</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">oem</span><span class="p">,</span> <span class="n">str</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpf: %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">mpf</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;physptr: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpc_new_phys</span> <span class="o">&amp;&amp;</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">mpc_new_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpc_new_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpc_new_length is %ld, please use alloc_mptable=8k</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mpc_new_length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpc_new_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
		<span class="cm">/* check if we can change the position */</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">mpf_checksum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">mpc</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">mpf_checksum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="n">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpc is readonly, please try alloc_mptable instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;use in-position replacing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span> <span class="o">=</span> <span class="n">mpc_new_phys</span><span class="p">;</span>
		<span class="n">mpc_new</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">mpc_new_phys</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpc_new</span><span class="p">,</span> <span class="n">mpc</span><span class="p">,</span> <span class="n">mpc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc_new</span><span class="p">;</span>
		<span class="cm">/* check if we can modify that */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpc_new_phys</span> <span class="o">-</span> <span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mpf_intel</span> <span class="o">*</span><span class="n">mpf_new</span><span class="p">;</span>
			<span class="cm">/* steal 16 bytes from [0, 1k) */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpf new: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x400</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">mpf_new</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="mh">0x400</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mpf_new</span><span class="p">,</span> <span class="n">mpf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">mpf</span> <span class="o">=</span> <span class="n">mpf_new</span><span class="p">;</span>
			<span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span> <span class="o">=</span> <span class="n">mpc_new_phys</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mpf</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mpf</span><span class="o">-&gt;</span><span class="n">checksum</span> <span class="o">-=</span> <span class="n">mpf_checksum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;physptr new: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpf</span><span class="o">-&gt;</span><span class="n">physptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * only replace the one with mp_INT and</span>
<span class="cm">	 *	 MP_IRQ_TRIGGER_LEVEL|MP_IRQ_POLARITY_LOW,</span>
<span class="cm">	 * already in mp_irqs , stored by ... and mp_config_acpi_gsi,</span>
<span class="cm">	 * may need pci=routeirq for all coverage</span>
<span class="cm">	 */</span>
	<span class="n">replace_intsrc_all</span><span class="p">(</span><span class="n">mpc</span><span class="p">,</span> <span class="n">mpc_new_phys</span><span class="p">,</span> <span class="n">mpc_new_length</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">update_mp_table</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
