<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › pci-calgary_64.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci-calgary_64.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Derived from arch/powerpc/kernel/iommu.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corporation, 2006-2007</span>
<span class="cm"> * Copyright (C) 2006  Jon Mason &lt;jdmason@kudzu.us&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Jon Mason &lt;jdmason@kudzu.us&gt;</span>
<span class="cm"> * Author: Muli Ben-Yehuda &lt;muli@il.ibm.com&gt;</span>

<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/crash_dump.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/iommu-helper.h&gt;</span>

<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/calgary.h&gt;</span>
<span class="cp">#include &lt;asm/tce.h&gt;</span>
<span class="cp">#include &lt;asm/pci-direct.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/rio.h&gt;</span>
<span class="cp">#include &lt;asm/bios_ebda.h&gt;</span>
<span class="cp">#include &lt;asm/x86_init.h&gt;</span>
<span class="cp">#include &lt;asm/iommu_table.h&gt;</span>

<span class="cp">#ifdef CONFIG_CALGARY_IOMMU_ENABLED_BY_DEFAULT</span>
<span class="kt">int</span> <span class="n">use_calgary</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="n">use_calgary</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CALGARY_DEFAULT_ENABLED */</span><span class="cp"></span>

<span class="cp">#define PCI_DEVICE_ID_IBM_CALGARY 0x02a1</span>
<span class="cp">#define PCI_DEVICE_ID_IBM_CALIOC2 0x0308</span>

<span class="cm">/* register offsets inside the host bridge space */</span>
<span class="cp">#define CALGARY_CONFIG_REG	0x0108</span>
<span class="cp">#define PHB_CSR_OFFSET		0x0110 </span><span class="cm">/* Channel Status */</span><span class="cp"></span>
<span class="cp">#define PHB_PLSSR_OFFSET	0x0120</span>
<span class="cp">#define PHB_CONFIG_RW_OFFSET	0x0160</span>
<span class="cp">#define PHB_IOBASE_BAR_LOW	0x0170</span>
<span class="cp">#define PHB_IOBASE_BAR_HIGH	0x0180</span>
<span class="cp">#define PHB_MEM_1_LOW		0x0190</span>
<span class="cp">#define PHB_MEM_1_HIGH		0x01A0</span>
<span class="cp">#define PHB_IO_ADDR_SIZE	0x01B0</span>
<span class="cp">#define PHB_MEM_1_SIZE		0x01C0</span>
<span class="cp">#define PHB_MEM_ST_OFFSET	0x01D0</span>
<span class="cp">#define PHB_AER_OFFSET		0x0200</span>
<span class="cp">#define PHB_CONFIG_0_HIGH	0x0220</span>
<span class="cp">#define PHB_CONFIG_0_LOW	0x0230</span>
<span class="cp">#define PHB_CONFIG_0_END	0x0240</span>
<span class="cp">#define PHB_MEM_2_LOW		0x02B0</span>
<span class="cp">#define PHB_MEM_2_HIGH		0x02C0</span>
<span class="cp">#define PHB_MEM_2_SIZE_HIGH	0x02D0</span>
<span class="cp">#define PHB_MEM_2_SIZE_LOW	0x02E0</span>
<span class="cp">#define PHB_DOSHOLE_OFFSET	0x08E0</span>

<span class="cm">/* CalIOC2 specific */</span>
<span class="cp">#define PHB_SAVIOR_L2		0x0DB0</span>
<span class="cp">#define PHB_PAGE_MIG_CTRL	0x0DA8</span>
<span class="cp">#define PHB_PAGE_MIG_DEBUG	0x0DA0</span>
<span class="cp">#define PHB_ROOT_COMPLEX_STATUS 0x0CB0</span>

<span class="cm">/* PHB_CONFIG_RW */</span>
<span class="cp">#define PHB_TCE_ENABLE		0x20000000</span>
<span class="cp">#define PHB_SLOT_DISABLE	0x1C000000</span>
<span class="cp">#define PHB_DAC_DISABLE		0x01000000</span>
<span class="cp">#define PHB_MEM2_ENABLE		0x00400000</span>
<span class="cp">#define PHB_MCSR_ENABLE		0x00100000</span>
<span class="cm">/* TAR (Table Address Register) */</span>
<span class="cp">#define TAR_SW_BITS		0x0000ffffffff800fUL</span>
<span class="cp">#define TAR_VALID		0x0000000000000008UL</span>
<span class="cm">/* CSR (Channel/DMA Status Register) */</span>
<span class="cp">#define CSR_AGENT_MASK		0xffe0ffff</span>
<span class="cm">/* CCR (Calgary Configuration Register) */</span>
<span class="cp">#define CCR_2SEC_TIMEOUT	0x000000000000000EUL</span>
<span class="cm">/* PMCR/PMDR (Page Migration Control/Debug Registers */</span>
<span class="cp">#define PMR_SOFTSTOP		0x80000000</span>
<span class="cp">#define PMR_SOFTSTOPFAULT	0x40000000</span>
<span class="cp">#define PMR_HARDSTOP		0x20000000</span>

<span class="cm">/*</span>
<span class="cm"> * The maximum PHB bus number.</span>
<span class="cm"> * x3950M2 (rare): 8 chassis, 48 PHBs per chassis = 384</span>
<span class="cm"> * x3950M2: 4 chassis, 48 PHBs per chassis        = 192</span>
<span class="cm"> * x3950 (PCIE): 8 chassis, 32 PHBs per chassis   = 256</span>
<span class="cm"> * x3950 (PCIX): 8 chassis, 16 PHBs per chassis   = 128</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_PHB_BUS_NUM		256</span>

<span class="cp">#define PHBS_PER_CALGARY	  4</span>

<span class="cm">/* register offsets in Calgary&#39;s internal register space */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tar_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0580</span> <span class="cm">/* TAR0 */</span><span class="p">,</span>
	<span class="mh">0x0588</span> <span class="cm">/* TAR1 */</span><span class="p">,</span>
	<span class="mh">0x0590</span> <span class="cm">/* TAR2 */</span><span class="p">,</span>
	<span class="mh">0x0598</span> <span class="cm">/* TAR3 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">split_queue_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x4870</span> <span class="cm">/* SPLIT QUEUE 0 */</span><span class="p">,</span>
	<span class="mh">0x5870</span> <span class="cm">/* SPLIT QUEUE 1 */</span><span class="p">,</span>
	<span class="mh">0x6870</span> <span class="cm">/* SPLIT QUEUE 2 */</span><span class="p">,</span>
	<span class="mh">0x7870</span> <span class="cm">/* SPLIT QUEUE 3 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phb_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x8000</span> <span class="cm">/* PHB0 */</span><span class="p">,</span>
	<span class="mh">0x9000</span> <span class="cm">/* PHB1 */</span><span class="p">,</span>
	<span class="mh">0xA000</span> <span class="cm">/* PHB2 */</span><span class="p">,</span>
	<span class="mh">0xB000</span> <span class="cm">/* PHB3 */</span>
<span class="p">};</span>

<span class="cm">/* PHB debug registers */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phb_debug_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x4000</span>	<span class="cm">/* PHB 0 DEBUG */</span><span class="p">,</span>
	<span class="mh">0x5000</span>	<span class="cm">/* PHB 1 DEBUG */</span><span class="p">,</span>
	<span class="mh">0x6000</span>	<span class="cm">/* PHB 2 DEBUG */</span><span class="p">,</span>
	<span class="mh">0x7000</span>	<span class="cm">/* PHB 3 DEBUG */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * STUFF register for each debug PHB,</span>
<span class="cm"> * byte 1 = start bus number, byte 2 = end bus number</span>
<span class="cm"> */</span>

<span class="cp">#define PHB_DEBUG_STUFF_OFFSET	0x0020</span>

<span class="cp">#define EMERGENCY_PAGES 32 </span><span class="cm">/* = 128KB */</span><span class="cp"></span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_UNSPECIFIED</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">translate_empty_slots</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">calgary_detected</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rio_table_hdr</span>	<span class="o">*</span><span class="n">rio_table_hdr</span> <span class="n">__initdata</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scal_detail</span>	<span class="o">*</span><span class="n">scal_devs</span><span class="p">[</span><span class="n">MAX_NUMNODES</span><span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rio_detail</span>	<span class="o">*</span><span class="n">rio_devs</span><span class="p">[</span><span class="n">MAX_NUMNODES</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">calgary_bus_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tce_space</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">translation_disabled</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="n">phbid</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">calgary_handle_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">calgary_tce_cache_blast</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">calgary_dump_error_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">calioc2_handle_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">calioc2_tce_cache_blast</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">calioc2_dump_error_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">calgary_init_bitmap_from_tce_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">get_tce_space_from_tar</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cal_chipset_ops</span> <span class="n">calgary_chip_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handle_quirks</span> <span class="o">=</span> <span class="n">calgary_handle_quirks</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tce_cache_blast</span> <span class="o">=</span> <span class="n">calgary_tce_cache_blast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_error_regs</span> <span class="o">=</span> <span class="n">calgary_dump_error_regs</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cal_chipset_ops</span> <span class="n">calioc2_chip_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handle_quirks</span> <span class="o">=</span> <span class="n">calioc2_handle_quirks</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tce_cache_blast</span> <span class="o">=</span> <span class="n">calioc2_tce_cache_blast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_error_regs</span> <span class="o">=</span> <span class="n">calioc2_dump_error_regs</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">calgary_bus_info</span> <span class="n">bus_info</span><span class="p">[</span><span class="n">MAX_PHB_BUS_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">translation_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* only PHBs with translation enabled have an IOMMU table */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_range_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">start_addr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="cm">/* bail out if we&#39;re asked to reserve a region we don&#39;t cover */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">npages</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">)</span> <span class="cm">/* don&#39;t go off the table */</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">bitmap_set</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_map</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">iommu_range_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">boundary_size</span><span class="p">;</span>

	<span class="n">boundary_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">dma_get_seg_boundary</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">npages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">iommu_area_alloc</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_map</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_hint</span><span class="p">,</span>
				  <span class="n">npages</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">boundary_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">chip_ops</span><span class="o">-&gt;</span><span class="n">tce_cache_blast</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">iommu_area_alloc</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_map</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">npages</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">boundary_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Calgary: IOMMU full.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">panic_on_overflow</span><span class="p">)</span>
				<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Calgary: fix the allocator.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="n">DMA_ERROR_CODE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_hint</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">npages</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_hint</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">iommu_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">iommu_range_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">DMA_ERROR_CODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Calgary: failed to allocate %u pages in &quot;</span>
		       <span class="s">&quot;iommu %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DMA_ERROR_CODE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set the return dma address */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>

	<span class="cm">/* put the TCEs in the HW table */</span>
	<span class="n">tce_build</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vaddr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">,</span>
		  <span class="n">direction</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iommu_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">badend</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* were we called with bad_dma_address? */</span>
	<span class="n">badend</span> <span class="o">=</span> <span class="n">DMA_ERROR_CODE</span> <span class="o">+</span> <span class="p">(</span><span class="n">EMERGENCY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">dma_addr</span> <span class="o">&gt;=</span> <span class="n">DMA_ERROR_CODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma_addr</span> <span class="o">&lt;</span> <span class="n">badend</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;Calgary: driver tried unmapping bad DMA &quot;</span>
		       <span class="s">&quot;address 0x%Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="n">npages</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">);</span>

	<span class="n">tce_free</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">bitmap_clear</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_map</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="nf">find_iommu_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* search up the device tree for an iommu */</span>
	<span class="n">pbus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">pbus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">&amp;&amp;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span> <span class="o">==</span> <span class="n">pbus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pbus</span> <span class="o">=</span> <span class="n">pbus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pbus</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tbl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span> <span class="o">!=</span> <span class="n">pbus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">tbl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calgary_unmap_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">nelems</span><span class="p">,</span><span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">find_iommu_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">translation_enabled</span><span class="p">(</span><span class="n">tbl</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sglist</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">nelems</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmalen</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dmalen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">npages</span> <span class="o">=</span> <span class="n">iommu_num_pages</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">dmalen</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">iommu_free</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calgary_map_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">nelems</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">find_iommu_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">nelems</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sg_page</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>

		<span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="n">iommu_num_pages</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="n">iommu_range_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">DMA_ERROR_CODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* makes sure unmap knows to stop */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

		<span class="cm">/* insert into HW table */</span>
		<span class="n">tce_build</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">vaddr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nelems</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">calgary_unmap_sg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nelems</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">nelems</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">=</span> <span class="n">DMA_ERROR_CODE</span><span class="p">;</span>
		<span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">calgary_map_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">find_iommu_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">uaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="n">npages</span> <span class="o">=</span> <span class="n">iommu_num_pages</span><span class="p">(</span><span class="n">uaddr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">iommu_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calgary_unmap_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">find_iommu_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>

	<span class="n">npages</span> <span class="o">=</span> <span class="n">iommu_num_pages</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">iommu_free</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">calgary_alloc_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
	<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dma_handle</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">,</span> <span class="n">order</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">find_iommu_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="cm">/* size rounded up to full pages */</span>
	<span class="n">npages</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">__GFP_DMA</span> <span class="o">|</span> <span class="n">__GFP_HIGHMEM</span> <span class="o">|</span> <span class="n">__GFP_DMA32</span><span class="p">);</span>

	<span class="cm">/* alloc enough pages (and possibly more) */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* set up tces to cover the allocated range */</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="n">iommu_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span> <span class="o">==</span> <span class="n">DMA_ERROR_CODE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ret</span><span class="p">,</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calgary_free_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">find_iommu_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">npages</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">iommu_free</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_map_ops</span> <span class="n">calgary_dma_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">calgary_alloc_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">calgary_free_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_sg</span> <span class="o">=</span> <span class="n">calgary_map_sg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_sg</span> <span class="o">=</span> <span class="n">calgary_unmap_sg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_page</span> <span class="o">=</span> <span class="n">calgary_map_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_page</span> <span class="o">=</span> <span class="n">calgary_unmap_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="nf">busno_to_bbar</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bus_info</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bbar</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">busno_to_phbid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bus_info</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">phbid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">split_queue_offset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">busno_to_phbid</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">split_queue_offsets</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">tar_offset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">busno_to_phbid</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tar_offsets</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">phb_offset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">busno_to_phbid</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">phb_offsets</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span><span class="o">*</span> <span class="nf">calgary_reg</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bar</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span><span class="o">*</span><span class="p">)</span><span class="n">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_calioc2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_IBM_CALIOC2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_calgary</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_IBM_CALGARY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_cal_pci_dev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_calgary</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_calioc2</span><span class="p">(</span><span class="n">device</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calgary_tce_cache_blast</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>

	<span class="cm">/* disable arbitration on the bus */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_AER_OFFSET</span><span class="p">);</span>
	<span class="n">aer</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="cm">/* read plssr to ensure it got there */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_PLSSR_OFFSET</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="cm">/* poll split queues until all DMA activity is done */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">split_queue_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Calgary: PCI bus not quiesced, &quot;</span>
		       <span class="s">&quot;continuing anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* invalidate TCE cache */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">tar_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">));</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">tar_val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="cm">/* enable arbitration */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_AER_OFFSET</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">aer</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">);</span> <span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calioc2_tce_cache_blast</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">;</span>

<span class="nl">begin:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Calgary: CalIOC2 bus 0x%x entering tce cache blast &quot;</span>
	       <span class="s">&quot;sequence - count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* 1. using the Page Migration Control reg set SoftStop */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_PAGE_MIG_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;1a. read 0x%x [LE] from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">PMR_SOFTSTOP</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;1b. writing 0x%x [LE] to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">target</span><span class="p">);</span>

	<span class="cm">/* 2. poll split queues until all DMA activity is done */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;2a. starting to poll split queues</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">split_queue_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CalIOC2: PCI bus not quiesced, &quot;</span>
		       <span class="s">&quot;continuing anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* 3. poll Page Migration DEBUG for SoftStopFault */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_PAGE_MIG_DEBUG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;3. read 0x%x [LE] from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="cm">/* 4. if SoftStopFault - goto (1) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PMR_SOFTSTOPFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">begin</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CalIOC2: too many SoftStopFaults, &quot;</span>
			       <span class="s">&quot;aborting TCE cache flush sequence!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* pray for the best */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* 5. Slam into HardStop by reading PHB_PAGE_MIG_CTRL */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_PAGE_MIG_CTRL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;5a. slamming into HardStop by reading %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;5b. read 0x%x [LE] from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_PAGE_MIG_DEBUG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;5c. read 0x%x [LE] from %p (debug)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="cm">/* 6. invalidate TCE cache */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;6. invalidating TCE cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">tar_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">));</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">tar_val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="cm">/* 7. Re-read PMCR */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;7a. Re-reading PMCR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_PAGE_MIG_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;7b. read 0x%x [LE] from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="cm">/* 8. Remove HardStop */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;8a. removing HardStop from PMCR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_PAGE_MIG_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;8b. writing 0x%x [LE] to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;8c. read 0x%x [LE] from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_reserve_mem_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">start</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numpages</span><span class="p">;</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">|</span> <span class="mh">0xfffff</span><span class="p">;</span>
	<span class="n">limit</span><span class="o">++</span><span class="p">;</span>

	<span class="n">numpages</span> <span class="o">=</span> <span class="p">((</span><span class="n">limit</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="n">iommu_range_reserve</span><span class="p">(</span><span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span> <span class="n">start</span><span class="p">,</span> <span class="n">numpages</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_reserve_peripheral_mem_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">sizelow</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">busnum</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>

	<span class="cm">/* peripheral MEM_1 region */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_MEM_1_LOW</span><span class="p">);</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_MEM_1_HIGH</span><span class="p">);</span>
	<span class="n">high</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_MEM_1_SIZE</span><span class="p">);</span>
	<span class="n">sizelow</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="n">sizelow</span><span class="p">;</span>

	<span class="n">calgary_reserve_mem_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_reserve_peripheral_mem_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val32</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">sizelow</span><span class="p">,</span> <span class="n">sizehigh</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">busnum</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>

	<span class="cm">/* is it enabled? */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_CONFIG_RW_OFFSET</span><span class="p">);</span>
	<span class="n">val32</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val32</span> <span class="o">&amp;</span> <span class="n">PHB_MEM2_ENABLE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_MEM_2_LOW</span><span class="p">);</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_MEM_2_HIGH</span><span class="p">);</span>
	<span class="n">high</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_MEM_2_SIZE_LOW</span><span class="p">);</span>
	<span class="n">sizelow</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_MEM_2_SIZE_HIGH</span><span class="p">);</span>
	<span class="n">sizehigh</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizehigh</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">sizelow</span><span class="p">;</span>

	<span class="n">calgary_reserve_mem_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * some regions of the IO address space do not get translated, so we</span>
<span class="cm"> * must not give devices IO addresses in those regions. The regions</span>
<span class="cm"> * are the 640KB-1MB region and the two PCI peripheral memory holes.</span>
<span class="cm"> * Reserve all of them in the IOMMU bitmap to avoid giving them out</span>
<span class="cm"> * later.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_reserve_regions</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* reserve EMERGENCY_PAGES from bad_dma_address and up */</span>
	<span class="n">iommu_range_reserve</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">DMA_ERROR_CODE</span><span class="p">,</span> <span class="n">EMERGENCY_PAGES</span><span class="p">);</span>

	<span class="cm">/* avoid the BIOS/VGA first 640KB-1MB region */</span>
	<span class="cm">/* for CalIOC2 - avoid the entire first MB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_calgary</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="mi">640</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">640</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* calioc2 */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iommu_range_reserve</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

	<span class="cm">/* reserve the two PCI peripheral memory regions in IO space */</span>
	<span class="n">calgary_reserve_peripheral_mem_1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">calgary_reserve_peripheral_mem_2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">calgary_setup_tar</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">table_phys</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="cm">/* build TCE tables for each PHB */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">build_tce_table</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bbar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bus_info</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">tce_space</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_kdump_kernel</span><span class="p">())</span>
		<span class="n">calgary_init_bitmap_from_tce_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tce_free</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_calgary</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">chip_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calgary_chip_ops</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_calioc2</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">chip_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calioc2_chip_ops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">calgary_reserve_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* set TARs for each PHB */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">tar_offset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">));</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

	<span class="cm">/* zero out all TAR bits under sw control */</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_SW_BITS</span><span class="p">;</span>
	<span class="n">table_phys</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_base</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">|=</span> <span class="n">table_phys</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">specified_table_size</span> <span class="o">&gt;</span> <span class="n">TCE_TABLE_SIZE_8M</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">specified_table_size</span><span class="p">;</span>

	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">tar_val</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">val64</span><span class="p">);</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">tar_val</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">);</span> <span class="cm">/* flush */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_free_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitmapsz</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">,</span> <span class="n">tar_offset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">));</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_SW_BITS</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">val64</span><span class="p">),</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">);</span> <span class="cm">/* flush */</span>

	<span class="n">bitmapsz</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span> <span class="o">/</span> <span class="n">BITS_PER_BYTE</span><span class="p">;</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_map</span><span class="p">,</span> <span class="n">get_order</span><span class="p">(</span><span class="n">bitmapsz</span><span class="p">));</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
	
	<span class="n">set_pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Can&#39;t free bootmem allocated memory after system is up :-( */</span>
	<span class="n">bus_info</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">tce_space</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calgary_dump_error_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">,</span> <span class="n">plssr</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_CSR_OFFSET</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_PLSSR_OFFSET</span><span class="p">);</span>
	<span class="n">plssr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

	<span class="cm">/* If no error, the agent ID in the CSR is not valid */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Calgary: DMA error on Calgary PHB 0x%x, &quot;</span>
	       <span class="s">&quot;0x%08x@CSR 0x%08x@PLSSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">,</span> <span class="n">csr</span><span class="p">,</span> <span class="n">plssr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calioc2_dump_error_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">,</span> <span class="n">csmr</span><span class="p">,</span> <span class="n">plssr</span><span class="p">,</span> <span class="n">mck</span><span class="p">,</span> <span class="n">rcstat</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phboff</span> <span class="o">=</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">erroff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">errregs</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* dump CSR */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phboff</span> <span class="o">|</span> <span class="n">PHB_CSR_OFFSET</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="cm">/* dump PLSSR */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phboff</span> <span class="o">|</span> <span class="n">PHB_PLSSR_OFFSET</span><span class="p">);</span>
	<span class="n">plssr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="cm">/* dump CSMR */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phboff</span> <span class="o">|</span> <span class="mh">0x290</span><span class="p">);</span>
	<span class="n">csmr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="cm">/* dump mck */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phboff</span> <span class="o">|</span> <span class="mh">0x800</span><span class="p">);</span>
	<span class="n">mck</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Calgary: DMA error on CalIOC2 PHB 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Calgary: 0x%08x@CSR 0x%08x@PLSSR 0x%08x@CSMR 0x%08x@MCK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">csr</span><span class="p">,</span> <span class="n">plssr</span><span class="p">,</span> <span class="n">csmr</span><span class="p">,</span> <span class="n">mck</span><span class="p">);</span>

	<span class="cm">/* dump rest of error regs */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Calgary: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">errregs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* err regs are at 0x810 - 0x870 */</span>
		<span class="n">erroff</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x810</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">));</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phboff</span> <span class="o">|</span> <span class="n">erroff</span><span class="p">);</span>
		<span class="n">errregs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x@0x%lx &quot;</span><span class="p">,</span> <span class="n">errregs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">erroff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* root complex status */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phboff</span> <span class="o">|</span> <span class="n">PHB_ROOT_COMPLEX_STATUS</span><span class="p">);</span>
	<span class="n">rcstat</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Calgary: 0x%08x@0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcstat</span><span class="p">,</span>
	       <span class="n">PHB_ROOT_COMPLEX_STATUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calgary_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val32</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_CSR_OFFSET</span><span class="p">);</span>
	<span class="n">val32</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

	<span class="cm">/* If no error, the agent ID in the CSR is not valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val32</span> <span class="o">&amp;</span> <span class="n">CSR_AGENT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">chip_ops</span><span class="o">-&gt;</span><span class="n">dump_error_regs</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>

		<span class="cm">/* reset error */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

		<span class="cm">/* Disable bus that caused the error */</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">PHB_CONFIG_RW_OFFSET</span><span class="p">);</span>
		<span class="n">val32</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
		<span class="n">val32</span> <span class="o">|=</span> <span class="n">PHB_SLOT_DISABLE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val32</span><span class="p">),</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Reset the timer */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_set_split_completion_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">busnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phb_shift</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span> <span class="cm">/* silence gcc */</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">busno_to_phbid</span><span class="p">(</span><span class="n">busnum</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">phb_shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">19</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">phb_shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">23</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">phb_shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">27</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">phb_shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">35</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">busno_to_phbid</span><span class="p">(</span><span class="n">busnum</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">CALGARY_CONFIG_REG</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

	<span class="cm">/* zero out this PHB&#39;s timer bits */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFUL</span> <span class="o">&lt;&lt;</span> <span class="n">phb_shift</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;&lt;</span> <span class="n">phb_shift</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">val64</span><span class="p">),</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">);</span> <span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calioc2_handle_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">busnum</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * CalIOC2 designers recommend setting bit 8 in 0xnDB0 to 1</span>
<span class="cm">	 */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_SAVIOR_L2</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x00800000</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_handle_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">busnum</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Give split completion a longer timeout on bus 1 for aic94xx</span>
<span class="cm">	 * http://bugzilla.kernel.org/show_bug.cgi?id=7180</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_calgary</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">busnum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">calgary_set_split_completion_timeout</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">,</span> <span class="n">busnum</span><span class="p">,</span>
						     <span class="n">CCR_2SEC_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_enable_translation</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val32</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">busnum</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="n">busnum</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>

	<span class="cm">/* enable TCE in PHB Config Register */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_CONFIG_RW_OFFSET</span><span class="p">);</span>
	<span class="n">val32</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">val32</span> <span class="o">|=</span> <span class="n">PHB_TCE_ENABLE</span> <span class="o">|</span> <span class="n">PHB_DAC_DISABLE</span> <span class="o">|</span> <span class="n">PHB_MCSR_ENABLE</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Calgary: enabling translation on %s PHB %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_IBM_CALGARY</span><span class="p">)</span> <span class="o">?</span>
	       <span class="s">&quot;Calgary&quot;</span> <span class="o">:</span> <span class="s">&quot;CalIOC2&quot;</span><span class="p">,</span> <span class="n">busnum</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Calgary: errant DMAs will now be prevented on this &quot;</span>
	       <span class="s">&quot;bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val32</span><span class="p">),</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">);</span> <span class="cm">/* flush */</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calgary_watchdog</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_disable_translation</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val32</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">busnum</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="n">busnum</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">bbar</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">bbar</span><span class="p">;</span>

	<span class="cm">/* disable TCE in PHB Config Register */</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">phb_offset</span><span class="p">(</span><span class="n">busnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">PHB_CONFIG_RW_OFFSET</span><span class="p">);</span>
	<span class="n">val32</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
	<span class="n">val32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PHB_TCE_ENABLE</span> <span class="o">|</span> <span class="n">PHB_DAC_DISABLE</span> <span class="o">|</span> <span class="n">PHB_MCSR_ENABLE</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Calgary: disabling translation on PHB %#x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">busnum</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val32</span><span class="p">),</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">);</span> <span class="cm">/* flush */</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_init_one_nontraslated</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">set_pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* is the device behind a bridge? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">calgary_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">bbar</span> <span class="o">=</span> <span class="n">busno_to_bbar</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">calgary_setup_tar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bbar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Calgary: IEEEE, dev %p has &quot;</span>
			       <span class="s">&quot;bus-&gt;parent-&gt;self!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">chip_ops</span><span class="o">-&gt;</span><span class="n">handle_quirks</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">calgary_enable_translation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">calgary_locate_bbars</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rioidx</span><span class="p">,</span> <span class="n">phb</span><span class="p">,</span> <span class="n">bus</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bbar</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">start_bus</span><span class="p">,</span> <span class="n">end_bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rioidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rioidx</span> <span class="o">&lt;</span> <span class="n">rio_table_hdr</span><span class="o">-&gt;</span><span class="n">num_rio_dev</span><span class="p">;</span> <span class="n">rioidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rio_detail</span> <span class="o">*</span><span class="n">rio</span> <span class="o">=</span> <span class="n">rio_devs</span><span class="p">[</span><span class="n">rioidx</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">COMPAT_CALGARY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ALT_CALGARY</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* map entire 1MB of Calgary config space */</span>
		<span class="n">bbar</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">rio</span><span class="o">-&gt;</span><span class="n">BBAR</span><span class="p">,</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bbar</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">phb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phb</span> <span class="o">&lt;</span> <span class="n">PHBS_PER_CALGARY</span><span class="p">;</span> <span class="n">phb</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">phb_debug_offsets</span><span class="p">[</span><span class="n">phb</span><span class="p">]</span> <span class="o">|</span> <span class="n">PHB_DEBUG_STUFF_OFFSET</span><span class="p">;</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bbar</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>

			<span class="n">start_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">end_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">end_bus</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="n">start_bus</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;=</span> <span class="n">end_bus</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bus_info</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">bbar</span><span class="p">;</span>
					<span class="n">bus_info</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">phbid</span> <span class="o">=</span> <span class="n">phb</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bus_info</span><span class="p">[</span><span class="n">start_bus</span><span class="p">].</span><span class="n">bbar</span> <span class="o">=</span> <span class="n">bbar</span><span class="p">;</span>
				<span class="n">bus_info</span><span class="p">[</span><span class="n">start_bus</span><span class="p">].</span><span class="n">phbid</span> <span class="o">=</span> <span class="n">phb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="cm">/* scan bus_info and iounmap any bbars we previously ioremap&#39;d */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bus_info</span><span class="p">);</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_info</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bbar</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">bus_info</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bbar</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">calgary_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">calgary_bus_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">calgary_locate_bbars</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Purely for kdump kernel case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_kdump_kernel</span><span class="p">())</span>
		<span class="n">get_tce_space_from_tar</span><span class="p">();</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cal_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus_info</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">translation_disabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">calgary_init_one_nontraslated</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tce_space</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">translate_empty_slots</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">calgary_init_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

		<span class="n">tbl</span> <span class="o">=</span> <span class="n">find_iommu_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">translation_enabled</span><span class="p">(</span><span class="n">tbl</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">dma_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calgary_dma_ops</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cal_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus_info</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">translation_disabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tce_space</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">translate_empty_slots</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">calgary_disable_translation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">calgary_free_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* Undo calgary_init_one()&#39;s pci_dev_get() */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">dma_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">determine_tce_table_size</span><span class="p">(</span><span class="n">u64</span> <span class="n">ram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">specified_table_size</span> <span class="o">!=</span> <span class="n">TCE_TABLE_SIZE_UNSPECIFIED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">specified_table_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Table sizes are from 0 to 7 (TCE_TABLE_SIZE_64K to</span>
<span class="cm">	 * TCE_TABLE_SIZE_8M). Table size 0 has 8K entries and each</span>
<span class="cm">	 * larger table size has twice as many entries, so shift the</span>
<span class="cm">	 * max ram address by 13 to divide by 8K and then look at the</span>
<span class="cm">	 * order of the result to choose between 0-7.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">ram</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">TCE_TABLE_SIZE_8M</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_8M</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">build_detail_arrays</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">numnodes</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scal_detail_size</span><span class="p">,</span> <span class="n">rio_detail_size</span><span class="p">;</span>

	<span class="n">numnodes</span> <span class="o">=</span> <span class="n">rio_table_hdr</span><span class="o">-&gt;</span><span class="n">num_scal_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numnodes</span> <span class="o">&gt;</span> <span class="n">MAX_NUMNODES</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;Calgary: MAX_NUMNODES too low! Defined as %d, &quot;</span>
			<span class="s">&quot;but system has %d nodes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">MAX_NUMNODES</span><span class="p">,</span> <span class="n">numnodes</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rio_table_hdr</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">){</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">scal_detail_size</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">rio_detail_size</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">scal_detail_size</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">rio_detail_size</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Calgary: Invalid Rio Grande Table Version: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rio_table_hdr</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rio_table_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numnodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="n">scal_detail_size</span><span class="p">)</span>
		<span class="n">scal_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scal_detail</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rio_table_hdr</span><span class="o">-&gt;</span><span class="n">num_rio_dev</span><span class="p">;</span>
		    <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="n">rio_detail_size</span><span class="p">)</span>
		<span class="n">rio_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_detail</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">calgary_bus_has_devices</span><span class="p">(</span><span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_IBM_CALIOC2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: properly scan for devices across the</span>
<span class="cm">		 * PCI-to-PCI bridge on every CalIOC2 port.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">dev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">read_pci_config</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * calgary_init_bitmap_from_tce_table():</span>
<span class="cm"> * Function for kdump case. In the second/kdump kernel initialize</span>
<span class="cm"> * the bitmap based on the tce table entries obtained from first kernel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">calgary_init_bitmap_from_tce_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_base</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tp</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_map</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get_tce_space_from_tar():</span>
<span class="cm"> * Function for kdump case. Get the tce tables from first kernel</span>
<span class="cm"> * by reading the contents of the base address register of calgary iommu</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">get_tce_space_from_tar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tce_space</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">MAX_PHB_BUS_NUM</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">calgary_bus_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus_info</span><span class="p">[</span><span class="n">bus</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_device</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">read_pci_config</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_device</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cal_pci_dev</span><span class="p">(</span><span class="n">pci_device</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">translation_disabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">calgary_bus_has_devices</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pci_device</span><span class="p">)</span> <span class="o">||</span>
						<span class="n">translate_empty_slots</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">calgary_reg</span><span class="p">(</span><span class="n">bus_info</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bbar</span><span class="p">,</span>
						<span class="n">tar_offset</span><span class="p">(</span><span class="n">bus</span><span class="p">));</span>
			<span class="n">tce_space</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">readq</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>
			<span class="n">tce_space</span> <span class="o">=</span> <span class="n">tce_space</span> <span class="o">&amp;</span> <span class="n">TAR_SW_BITS</span><span class="p">;</span>

			<span class="n">tce_space</span> <span class="o">=</span> <span class="n">tce_space</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">specified_table_size</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tce_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">tce_space</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">calgary_iommu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* ok, we&#39;re trying to use Calgary - let&#39;s roll */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI-DMA: Using Calgary IOMMU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">calgary_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PCI-DMA: Calgary init failed %d, &quot;</span>
		       <span class="s">&quot;falling back to no_iommu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">detect_calgary</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">calgary_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">prev_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if the user specified iommu=off or iommu=soft or we found</span>
<span class="cm">	 * another HW IOMMU already, bail out.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_iommu</span> <span class="o">||</span> <span class="n">iommu_detected</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_calgary</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">early_pci_allowed</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Calgary: detecting Calgary via BIOS EBDA area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="n">get_bios_ebda</span><span class="p">());</span>

	<span class="n">rio_table_hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">prev_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x180</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The next offset is stored in the 1st word.</span>
<span class="cm">	 * Only parse up until the offset increases:</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">prev_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The block id is stored in the 2nd word */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x4752</span><span class="p">){</span>
			<span class="cm">/* set the pointer past the offset &amp; block id */</span>
			<span class="n">rio_table_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_table_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rio_table_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Calgary: Unable to locate Rio Grande table &quot;</span>
		       <span class="s">&quot;in EBDA - bailing!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">build_detail_arrays</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Calgary: build_detail_arrays ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">determine_tce_table_size</span><span class="p">((</span><span class="n">is_kdump_kernel</span><span class="p">()</span> <span class="o">?</span>
					<span class="n">saved_max_pfn</span> <span class="o">:</span> <span class="n">max_pfn</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">MAX_PHB_BUS_NUM</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">calgary_bus_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus_info</span><span class="p">[</span><span class="n">bus</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_device</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">read_pci_config</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_device</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cal_pci_dev</span><span class="p">(</span><span class="n">pci_device</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">translation_disabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">calgary_bus_has_devices</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pci_device</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">translate_empty_slots</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If it is kdump kernel, find and use tce tables</span>
<span class="cm">			 * from first kernel, else allocate tce tables here</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_kdump_kernel</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">tbl</span> <span class="o">=</span> <span class="n">alloc_tce_table</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tce_space</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">calgary_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Calgary: finished detection, Calgary %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">calgary_found</span> <span class="o">?</span> <span class="s">&quot;found&quot;</span> <span class="o">:</span> <span class="s">&quot;not found&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">calgary_found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iommu_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">calgary_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI-DMA: Calgary IOMMU detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI-DMA: Calgary TCE table spec is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">specified_table_size</span><span class="p">);</span>

		<span class="n">x86_init</span><span class="p">.</span><span class="n">iommu</span><span class="p">.</span><span class="n">iommu_init</span> <span class="o">=</span> <span class="n">calgary_iommu_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">calgary_found</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">bus</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">calgary_bus_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus_info</span><span class="p">[</span><span class="n">bus</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tce_space</span><span class="p">)</span>
			<span class="n">free_tce_table</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tce_space</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">calgary_parse_options</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bridge</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;64k&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_64K</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;128k&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_128K</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;256k&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_256K</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;512k&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_512K</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;1M&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_1M</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;2M&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_2M</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;4M&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_4M</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;8M&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">specified_table_size</span> <span class="o">=</span> <span class="n">TCE_TABLE_SIZE_8M</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;translate_empty_slots&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;translate_empty_slots&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">translate_empty_slots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;disable&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span>
				<span class="o">++</span><span class="n">p</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">bridge</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span> <span class="o">&lt;</span> <span class="n">MAX_PHB_BUS_NUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Calgary: disabling &quot;</span>
				       <span class="s">&quot;translation for PHB %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bridge</span><span class="p">);</span>
				<span class="n">bus_info</span><span class="p">[</span><span class="n">bridge</span><span class="p">].</span><span class="n">translation_disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">strpbrk</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">p</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* skip &#39;,&#39; */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;calgary=&quot;</span><span class="p">,</span> <span class="n">calgary_parse_options</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">calgary_fixup_one_tce_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">pci_iommu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_BRIDGE_RESOURCES</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Don&#39;t give out TCEs that map MEM resources */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* 0-based? we reserve the whole 1st MB anyway */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* cover the whole region */</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">npages</span><span class="o">++</span><span class="p">;</span>

		<span class="n">iommu_range_reserve</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">calgary_fixup_tce_spaces</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">calgary_bus_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_iommu</span> <span class="o">||</span> <span class="n">swiotlb</span> <span class="o">||</span> <span class="o">!</span><span class="n">calgary_detected</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Calgary: fixing up tce spaces</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cal_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus_info</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">translation_disabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tce_space</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">calgary_fixup_one_tce_space</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We need to be call after pcibios_assign_resources (fs_initcall level)</span>
<span class="cm"> * and before device_initcall.</span>
<span class="cm"> */</span>
<span class="n">rootfs_initcall</span><span class="p">(</span><span class="n">calgary_fixup_tce_spaces</span><span class="p">);</span>

<span class="n">IOMMU_INIT_POST</span><span class="p">(</span><span class="n">detect_calgary</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
