<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › acpi › boot.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>boot.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  boot.c - Architecture-Specific Low-Level ACPI Boot Support</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2001, 2002 Paul Diefenbaugh &lt;paul.s.diefenbaugh@intel.com&gt;</span>
<span class="cm"> *  Copyright (C) 2001 Jun Nakajima &lt;jun.nakajima@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/acpi_pmtmr.h&gt;</span>
<span class="cp">#include &lt;linux/efi.h&gt;</span>
<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &lt;asm/pci_x86.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/io_apic.h&gt;</span>
<span class="cp">#include &lt;asm/apic.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/mpspec.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">acpi_force</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">acpi_rsdt_forced</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">acpi_disabled</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_disabled</span><span class="p">);</span>

<span class="cp">#ifdef	CONFIG_X86_64</span>
<span class="cp"># include &lt;asm/proto.h&gt;</span>
<span class="cp"># include &lt;asm/numa_64.h&gt;</span>
<span class="cp">#endif				</span><span class="cm">/* X86 */</span><span class="cp"></span>

<span class="cp">#define BAD_MADT_ENTRY(entry, end) (					    \</span>
<span class="cp">		(!entry) || (unsigned long)entry + sizeof(*entry) &gt; end ||  \</span>
<span class="cp">		((struct acpi_subtable_header *)entry)-&gt;length &lt; sizeof(*entry))</span>

<span class="cp">#define PREFIX			&quot;ACPI: &quot;</span>

<span class="kt">int</span> <span class="n">acpi_noirq</span><span class="p">;</span>				<span class="cm">/* skip ACPI IRQ initialization */</span>
<span class="kt">int</span> <span class="n">acpi_pci_disabled</span><span class="p">;</span>		<span class="cm">/* skip ACPI PCI scan and IRQ initialization */</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_pci_disabled</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">acpi_lapic</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">acpi_ioapic</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">acpi_strict</span><span class="p">;</span>

<span class="n">u8</span> <span class="n">acpi_sci_flags</span> <span class="n">__initdata</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">acpi_sci_override_gsi</span> <span class="n">__initdata</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">acpi_skip_timer_override</span> <span class="n">__initdata</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">acpi_use_timer_override</span> <span class="n">__initdata</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">acpi_fix_pin2_polarity</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">acpi_lapic_addr</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">APIC_DEFAULT_PHYS_BASE</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef __HAVE_ARCH_CMPXCHG</span>
<span class="cp">#warning ACPI uses CMPXCHG, i486 and later hardware</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">                              Boot-time Configuration</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * The default interrupt routing model is PIC (8259).  This gets</span>
<span class="cm"> * overridden if IOAPICs are enumerated (below).</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">acpi_irq_model_id</span> <span class="n">acpi_irq_model</span> <span class="o">=</span> <span class="n">ACPI_IRQ_MODEL_PIC</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * ISA irqs by default are the first 16 gsis but can be</span>
<span class="cm"> * any gsi as specified by an interrupt source override.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">isa_irq_to_gsi</span><span class="p">[</span><span class="n">NR_IRQS_LEGACY</span><span class="p">]</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gsi_to_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">gsi</span> <span class="o">+</span> <span class="n">NR_IRQS_LEGACY</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_IRQS_LEGACY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isa_irq_to_gsi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">gsi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Provide an identity mapping of gsi == irq</span>
<span class="cm">	 * except on truly weird platforms that have</span>
<span class="cm">	 * non isa irqs in the first 16 gsis.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gsi</span> <span class="o">&gt;=</span> <span class="n">NR_IRQS_LEGACY</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">gsi</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">gsi_top</span> <span class="o">+</span> <span class="n">gsi</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">irq_to_gsi</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gsi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="n">NR_IRQS_LEGACY</span><span class="p">)</span>
		<span class="n">gsi</span> <span class="o">=</span> <span class="n">isa_irq_to_gsi</span><span class="p">[</span><span class="n">irq</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="n">gsi_top</span><span class="p">)</span>
		<span class="n">gsi</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">gsi_top</span> <span class="o">+</span> <span class="n">NR_IRQS_LEGACY</span><span class="p">))</span>
		<span class="n">gsi</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">-</span> <span class="n">gsi_top</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gsi</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gsi</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Temporarily use the virtual area starting from FIX_IO_APIC_BASE_END,</span>
<span class="cm"> * to map the target physical address. The problem is that set_fixmap()</span>
<span class="cm"> * provides a single page, and it is possible that the page is not</span>
<span class="cm"> * sufficient.</span>
<span class="cm"> * By using this area, we can map up to MAX_IO_APICS pages temporarily,</span>
<span class="cm"> * i.e. until the next __va_range() call.</span>
<span class="cm"> *</span>
<span class="cm"> * Important Safety Note:  The fixed I/O APIC page numbers are *subtracted*</span>
<span class="cm"> * from the fixed base.  That&#39;s why we start at FIX_IO_APIC_BASE_END and</span>
<span class="cm"> * count idx down while incrementing the phys address.</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">__init</span> <span class="nf">__acpi_map_table</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys</span> <span class="o">||</span> <span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">early_ioremap</span><span class="p">(</span><span class="n">phys</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">__acpi_unmap_table</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span> <span class="o">||</span> <span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">early_iounmap</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_parse_madt</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_table_madt</span> <span class="o">*</span><span class="n">madt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_apic</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">madt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_madt</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">madt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Unable to map MADT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">madt</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_lapic_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">madt</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PREFIX</span> <span class="s">&quot;Local APIC address 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">madt</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">default_acpi_madt_oem_check</span><span class="p">(</span><span class="n">madt</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">oem_id</span><span class="p">,</span>
				    <span class="n">madt</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">oem_table_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">acpi_register_lapic</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">MAX_LOCAL_APIC</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;skipped apicid that is too big</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">disabled_cpus</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_physical_apicid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1U</span><span class="p">)</span>
		<span class="n">ver</span> <span class="o">=</span> <span class="n">apic_version</span><span class="p">[</span><span class="n">boot_cpu_physical_apicid</span><span class="p">];</span>

	<span class="n">generic_processor_info</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_x2apic</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_local_x2apic</span> <span class="o">*</span><span class="n">processor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">apic_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">processor</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_local_x2apic</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_table_print_madt_entry</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="n">apic_id</span> <span class="o">=</span> <span class="n">processor</span><span class="o">-&gt;</span><span class="n">local_apic_id</span><span class="p">;</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="n">processor</span><span class="o">-&gt;</span><span class="n">lapic_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_ENABLED</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_X2APIC</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to register disabled CPU as well to permit</span>
<span class="cm">	 * counting disabled CPUs. This allows us to size</span>
<span class="cm">	 * cpus_possible_map more accurately, to permit</span>
<span class="cm">	 * to not preallocating memory for all NR_CPUS</span>
<span class="cm">	 * when we use CPU hotplug.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">apic_id_valid</span><span class="p">(</span><span class="n">apic_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">enabled</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;x2apic entry ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">acpi_register_lapic</span><span class="p">(</span><span class="n">apic_id</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;x2apic entry ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_lapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span> <span class="n">header</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_local_apic</span> <span class="o">*</span><span class="n">processor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">processor</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_local_apic</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_table_print_madt_entry</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to register disabled CPU as well to permit</span>
<span class="cm">	 * counting disabled CPUs. This allows us to size</span>
<span class="cm">	 * cpus_possible_map more accurately, to permit</span>
<span class="cm">	 * to not preallocating memory for all NR_CPUS</span>
<span class="cm">	 * when we use CPU hotplug.</span>
<span class="cm">	 */</span>
	<span class="n">acpi_register_lapic</span><span class="p">(</span><span class="n">processor</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>	<span class="cm">/* APIC ID */</span>
			    <span class="n">processor</span><span class="o">-&gt;</span><span class="n">lapic_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_ENABLED</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_sapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_local_sapic</span> <span class="o">*</span><span class="n">processor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">processor</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_local_sapic</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_table_print_madt_entry</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="n">acpi_register_lapic</span><span class="p">((</span><span class="n">processor</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">processor</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span><span class="cm">/* APIC ID */</span>
			    <span class="n">processor</span><span class="o">-&gt;</span><span class="n">lapic_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_ENABLED</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_lapic_addr_ovr</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span> <span class="n">header</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_local_apic_override</span> <span class="o">*</span><span class="n">lapic_addr_ovr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lapic_addr_ovr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_local_apic_override</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">lapic_addr_ovr</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_lapic_addr</span> <span class="o">=</span> <span class="n">lapic_addr_ovr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_x2apic_nmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_local_x2apic_nmi</span> <span class="o">*</span><span class="n">x2apic_nmi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">x2apic_nmi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_local_x2apic_nmi</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">x2apic_nmi</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_table_print_madt_entry</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x2apic_nmi</span><span class="o">-&gt;</span><span class="n">lint</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;NMI not connected to LINT 1!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_lapic_nmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span> <span class="n">header</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_local_apic_nmi</span> <span class="o">*</span><span class="n">lapic_nmi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lapic_nmi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_local_apic_nmi</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">lapic_nmi</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_table_print_madt_entry</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lapic_nmi</span><span class="o">-&gt;</span><span class="n">lint</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;NMI not connected to LINT 1!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/*CONFIG_X86_LOCAL_APIC */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_ioapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span> <span class="n">header</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_io_apic</span> <span class="o">*</span><span class="n">ioapic</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ioapic</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_io_apic</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">ioapic</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_table_print_madt_entry</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="n">mp_register_ioapic</span><span class="p">(</span><span class="n">ioapic</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			   <span class="n">ioapic</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">ioapic</span><span class="o">-&gt;</span><span class="n">global_irq_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse Interrupt Source Override for the ACPI SCI</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">acpi_sci_ioapic_setup</span><span class="p">(</span><span class="n">u8</span> <span class="n">bus_irq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">u16</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* compatible SCI trigger is level */</span>
		<span class="n">trigger</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">polarity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* compatible SCI polarity is low */</span>
		<span class="n">polarity</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* Command-line over-ride via acpi_sci= */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_sci_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_TRIGGER_MASK</span><span class="p">)</span>
		<span class="n">trigger</span> <span class="o">=</span> <span class="p">(</span><span class="n">acpi_sci_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_TRIGGER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_sci_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_POLARITY_MASK</span><span class="p">)</span>
		<span class="n">polarity</span> <span class="o">=</span> <span class="n">acpi_sci_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_POLARITY_MASK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mp_config_acpi_legacy_irqs() already setup IRQs &lt; 16</span>
<span class="cm">	 * If GSI is &lt; 16, this will update its flags,</span>
<span class="cm">	 * else it will create a new mp_irqs[] entry.</span>
<span class="cm">	 */</span>
	<span class="n">mp_override_legacy_irq</span><span class="p">(</span><span class="n">bus_irq</span><span class="p">,</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * stash over-ride to indicate we&#39;ve been here</span>
<span class="cm">	 * and for later update of acpi_gbl_FADT</span>
<span class="cm">	 */</span>
	<span class="n">acpi_sci_override_gsi</span> <span class="o">=</span> <span class="n">gsi</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_int_src_ovr</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span> <span class="n">header</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_interrupt_override</span> <span class="o">*</span><span class="n">intsrc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">intsrc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_interrupt_override</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">intsrc</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_table_print_madt_entry</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">source_irq</span> <span class="o">==</span> <span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">sci_interrupt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_sci_ioapic_setup</span><span class="p">(</span><span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">source_irq</span><span class="p">,</span>
				      <span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">inti_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_POLARITY_MASK</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">inti_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_TRIGGER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span>
				      <span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">global_irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">source_irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_skip_timer_override</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">PREFIX</span> <span class="s">&quot;BIOS IRQ0 override ignored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">global_irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">acpi_fix_pin2_polarity</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">inti_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_POLARITY_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">inti_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACPI_MADT_POLARITY_MASK</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">PREFIX</span> <span class="s">&quot;BIOS IRQ0 pin2 override: forcing polarity to high active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mp_override_legacy_irq</span><span class="p">(</span><span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">source_irq</span><span class="p">,</span>
				<span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">inti_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_POLARITY_MASK</span><span class="p">,</span>
				<span class="p">(</span><span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">inti_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_TRIGGER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">intsrc</span><span class="o">-&gt;</span><span class="n">global_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">acpi_parse_nmi_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_subtable_header</span> <span class="o">*</span> <span class="n">header</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_madt_nmi_source</span> <span class="o">*</span><span class="n">nmi_src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">nmi_src</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_nmi_source</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BAD_MADT_ENTRY</span><span class="p">(</span><span class="n">nmi_src</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acpi_table_print_madt_entry</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="cm">/* TBD: Support nimsrc entries? */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_X86_IO_APIC */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * acpi_pic_sci_set_trigger()</span>
<span class="cm"> *</span>
<span class="cm"> * use ELCR to set PIC-mode trigger type for SCI</span>
<span class="cm"> *</span>
<span class="cm"> * If a PIC-mode SCI is not recognized or gives spurious IRQ7&#39;s</span>
<span class="cm"> * it may require Edge Trigger -- use &quot;acpi_sci=edge&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * Port 0x4d0-4d1 are ECLR1 and ECLR2, the Edge/Level Control Registers</span>
<span class="cm"> * for the 8259 PIC.  bit[n] = 1 means irq[n] is Level, otherwise Edge.</span>
<span class="cm"> * ECLR1 is IRQs 0-7 (IRQ 0, 1, 2 must be 0)</span>
<span class="cm"> * ECLR2 is IRQs 8-15 (IRQ 8, 13 must be 0)</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">acpi_pic_sci_set_trigger</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">trigger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>

	<span class="cm">/* Real old ELCR mask */</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x4d0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x4d1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we use ACPI to set PCI IRQs, then we should clear ELCR</span>
<span class="cm">	 * since we will set it correctly as we enable the PCI irq</span>
<span class="cm">	 * routing.</span>
<span class="cm">	 */</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">acpi_noirq</span> <span class="o">?</span> <span class="n">old</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update SCI information in the ELCR, it isn&#39;t in the PCI</span>
<span class="cm">	 * routing tables..</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* Edge - clear */</span>
		<span class="n">new</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:		<span class="cm">/* Level - set */</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="n">new</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">PREFIX</span> <span class="s">&quot;setting ELCR to %04x (from %04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="mh">0x4d0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">new</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x4d1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">acpi_gsi_to_irq</span><span class="p">(</span><span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="n">gsi_to_irq</span><span class="p">(</span><span class="n">gsi</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_irq_model</span> <span class="o">==</span> <span class="n">ACPI_IRQ_MODEL_IOAPIC</span><span class="p">)</span>
		<span class="n">setup_IO_APIC_irq_extra</span><span class="p">(</span><span class="n">gsi</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">acpi_gsi_to_irq</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">acpi_isa_irq_to_gsi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">isa_irq</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">gsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isa_irq</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">gsi</span> <span class="o">=</span> <span class="n">irq_to_gsi</span><span class="p">(</span><span class="n">isa_irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_register_gsi_pic</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="cm">/*</span>
<span class="cm">	 * Make sure all (legacy) PCI IRQs are set as level-triggered.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">ACPI_LEVEL_SENSITIVE</span><span class="p">)</span>
		<span class="n">eisa_set_level_irq</span><span class="p">(</span><span class="n">gsi</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">gsi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_register_gsi_ioapic</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
	<span class="n">gsi</span> <span class="o">=</span> <span class="n">mp_register_gsi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gsi</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">gsi</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__acpi_register_gsi</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span> <span class="o">=</span> <span class="n">acpi_register_gsi_pic</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * success: return IRQ number (&gt;=0)</span>
<span class="cm"> * failure: return &lt; 0</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">acpi_register_gsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plat_gsi</span> <span class="o">=</span> <span class="n">gsi</span><span class="p">;</span>

	<span class="n">plat_gsi</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">__acpi_register_gsi</span><span class="p">)(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gsi</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">gsi_to_irq</span><span class="p">(</span><span class="n">plat_gsi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">acpi_set_irq_model_pic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_irq_model</span> <span class="o">=</span> <span class="n">ACPI_IRQ_MODEL_PIC</span><span class="p">;</span>
	<span class="n">__acpi_register_gsi</span> <span class="o">=</span> <span class="n">acpi_register_gsi_pic</span><span class="p">;</span>
	<span class="n">acpi_ioapic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">acpi_set_irq_model_ioapic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_irq_model</span> <span class="o">=</span> <span class="n">ACPI_IRQ_MODEL_IOAPIC</span><span class="p">;</span>
	<span class="n">__acpi_register_gsi</span> <span class="o">=</span> <span class="n">acpi_register_gsi_ioapic</span><span class="p">;</span>
	<span class="n">acpi_ioapic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ACPI based hotplug support for CPU</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_ACPI_HOTPLUG_CPU</span>
<span class="cp">#include &lt;acpi/processor.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">acpi_map_cpu2node</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">physid</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ACPI_NUMA</span>
	<span class="kt">int</span> <span class="n">nid</span><span class="p">;</span>

	<span class="n">nid</span> <span class="o">=</span> <span class="n">acpi_get_node</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="n">node_online</span><span class="p">(</span><span class="n">nid</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">set_apicid_to_node</span><span class="p">(</span><span class="n">physid</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
	<span class="n">numa_set_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">_acpi_map_lsapic</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_madt_local_apic</span> <span class="o">*</span><span class="n">lapic</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span> <span class="n">tmp_map</span><span class="p">,</span> <span class="n">new_map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">physid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_MAT&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">||</span> <span class="o">!</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span> <span class="o">||</span>
	    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lapic</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lapic</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_madt_local_apic</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lapic</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_MADT_TYPE_LOCAL_APIC</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">lapic</span><span class="o">-&gt;</span><span class="n">lapic_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_MADT_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">physid</span> <span class="o">=</span> <span class="n">lapic</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lapic</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_map</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_map</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_tmp_map</span><span class="p">;</span>

	<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">tmp_map</span><span class="p">,</span> <span class="n">cpu_present_mask</span><span class="p">);</span>
	<span class="n">acpi_register_lapic</span><span class="p">(</span><span class="n">physid</span><span class="p">,</span> <span class="n">ACPI_MADT_ENABLED</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If mp_register_lapic successfully generates a new logical cpu</span>
<span class="cm">	 * number, then the following will get us exactly what was mapped</span>
<span class="cm">	 */</span>
	<span class="n">cpumask_andnot</span><span class="p">(</span><span class="n">new_map</span><span class="p">,</span> <span class="n">cpu_present_mask</span><span class="p">,</span> <span class="n">tmp_map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_empty</span><span class="p">(</span><span class="n">new_map</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Unable to map lapic to logical cpu number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_new_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acpi_processor_set_pdc</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">cpumask_first</span><span class="p">(</span><span class="n">new_map</span><span class="p">);</span>
	<span class="n">acpi_map_cpu2node</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">physid</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pcpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_new_map:</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">new_map</span><span class="p">);</span>
<span class="nl">free_tmp_map:</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">tmp_map</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* wrapper to silence section mismatch warning */</span>
<span class="kt">int</span> <span class="n">__ref</span> <span class="nf">acpi_map_lsapic</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_acpi_map_lsapic</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">pcpu</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_map_lsapic</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">acpi_unmap_lsapic</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">x86_cpu_to_apicid</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">set_cpu_present</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">num_processors</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_unmap_lsapic</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_ACPI_HOTPLUG_CPU */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">acpi_register_ioapic</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u64</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TBD */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_register_ioapic</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">acpi_unregister_ioapic</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TBD */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">acpi_unregister_ioapic</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_parse_sbf</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_table_boot</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_boot</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Unable to map SBF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbf_port</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">cmos_index</span><span class="p">;</span>	<span class="cm">/* Save CMOS port */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HPET_TIMER</span>
<span class="cp">#include &lt;asm/hpet.h&gt;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">__initdata</span> <span class="n">resource</span> <span class="o">*</span><span class="n">hpet_res</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_parse_hpet</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_table_hpet</span> <span class="o">*</span><span class="n">hpet_tbl</span><span class="p">;</span>

	<span class="n">hpet_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_hpet</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Unable to map HPET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_tbl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">space_id</span> <span class="o">!=</span> <span class="n">ACPI_SPACE_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;HPET timers must be located in &quot;</span>
		       <span class="s">&quot;memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hpet_address</span> <span class="o">=</span> <span class="n">hpet_tbl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
	<span class="n">hpet_blockid</span> <span class="o">=</span> <span class="n">hpet_tbl</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some broken BIOSes advertise HPET at 0x0. We really do not</span>
<span class="cm">	 * want to allocate a resource there.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span>
		       <span class="s">&quot;HPET id: %#x base: %#lx is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hpet_tbl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">hpet_address</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="cm">/*</span>
<span class="cm">	 * Some even more broken BIOSes advertise HPET at</span>
<span class="cm">	 * 0xfed0000000000000 instead of 0xfed00000. Fix it up and add</span>
<span class="cm">	 * some noise:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpet_address</span> <span class="o">==</span> <span class="mh">0xfed0000000000000UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_force_user</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;HPET id: %#x &quot;</span>
			       <span class="s">&quot;base: 0xfed0000000000000 is bogus</span><span class="se">\n</span><span class="s"> &quot;</span>
			       <span class="s">&quot;try hpet=force on the kernel command line to &quot;</span>
			       <span class="s">&quot;fix it up to 0xfed00000.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hpet_tbl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">hpet_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span>
		       <span class="s">&quot;HPET id: %#x base: 0xfed0000000000000 fixed up &quot;</span>
		       <span class="s">&quot;to 0xfed00000.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hpet_tbl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">hpet_address</span> <span class="o">&gt;&gt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;HPET id: %#x base: %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hpet_tbl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">hpet_address</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate and initialize the HPET firmware resource for adding into</span>
<span class="cm">	 * the resource tree during the lateinit timeframe.</span>
<span class="cm">	 */</span>
<span class="cp">#define HPET_RESOURCE_NAME_SIZE 9</span>
	<span class="n">hpet_res</span> <span class="o">=</span> <span class="n">alloc_bootmem</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hpet_res</span><span class="p">)</span> <span class="o">+</span> <span class="n">HPET_RESOURCE_NAME_SIZE</span><span class="p">);</span>

	<span class="n">hpet_res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hpet_res</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">hpet_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hpet_res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">HPET_RESOURCE_NAME_SIZE</span><span class="p">,</span> <span class="s">&quot;HPET %u&quot;</span><span class="p">,</span>
		 <span class="n">hpet_tbl</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>

	<span class="n">hpet_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">hpet_address</span><span class="p">;</span>
	<span class="n">hpet_res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">hpet_address</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * hpet_insert_resource inserts the HPET resources used into the resource</span>
<span class="cm"> * tree.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">hpet_insert_resource</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpet_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">insert_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="n">hpet_res</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">hpet_insert_resource</span><span class="p">);</span>

<span class="cp">#else</span>
<span class="cp">#define	acpi_parse_hpet	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_parse_fadt</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#ifdef CONFIG_X86_PM_TIMER</span>
	<span class="cm">/* detect the location of the ACPI PM Timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="n">FADT2_REVISION_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FADT rev. 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">xpm_timer_block</span><span class="p">.</span><span class="n">space_id</span> <span class="o">!=</span>
		    <span class="n">ACPI_ADR_SPACE_SYSTEM_IO</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pmtmr_ioport</span> <span class="o">=</span> <span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">xpm_timer_block</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * &quot;X&quot; fields are optional extensions to the original V1.0</span>
<span class="cm">		 * fields, so we must selectively expand V1.0 fields if the</span>
<span class="cm">		 * corresponding X field is zero.</span>
<span class="cm">	 	 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmtmr_ioport</span><span class="p">)</span>
			<span class="n">pmtmr_ioport</span> <span class="o">=</span> <span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">pm_timer_block</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* FADT rev. 1 */</span>
		<span class="n">pmtmr_ioport</span> <span class="o">=</span> <span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">pm_timer_block</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmtmr_ioport</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;PM-Timer IO Port: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pmtmr_ioport</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_X86_LOCAL_APIC</span>
<span class="cm">/*</span>
<span class="cm"> * Parse LAPIC entries in MADT</span>
<span class="cm"> * returns 0 on success, &lt; 0 on error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_acpi_parse_madt_lapic_addr_ovr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_apic</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note that the LAPIC address is obtained from the MADT (32-bit value)</span>
<span class="cm">	 * and (optionally) overriden by a LAPIC_ADDR_OVR entry (64-bit value).</span>
<span class="cm">	 */</span>

	<span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE</span><span class="p">,</span>
				  <span class="n">acpi_parse_lapic_addr_ovr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span>
		       <span class="s">&quot;Error parsing LAPIC address override entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">register_lapic_address</span><span class="p">(</span><span class="n">acpi_lapic_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_parse_madt_lapic_entries</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x2count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_apic</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note that the LAPIC address is obtained from the MADT (32-bit value)</span>
<span class="cm">	 * and (optionally) overriden by a LAPIC_ADDR_OVR entry (64-bit value).</span>
<span class="cm">	 */</span>

	<span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE</span><span class="p">,</span>
				  <span class="n">acpi_parse_lapic_addr_ovr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span>
		       <span class="s">&quot;Error parsing LAPIC address override entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">register_lapic_address</span><span class="p">(</span><span class="n">acpi_lapic_addr</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_LOCAL_SAPIC</span><span class="p">,</span>
				      <span class="n">acpi_parse_sapic</span><span class="p">,</span> <span class="n">MAX_LOCAL_APIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x2count</span> <span class="o">=</span> <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_LOCAL_X2APIC</span><span class="p">,</span>
					<span class="n">acpi_parse_x2apic</span><span class="p">,</span> <span class="n">MAX_LOCAL_APIC</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_LOCAL_APIC</span><span class="p">,</span>
					<span class="n">acpi_parse_lapic</span><span class="p">,</span> <span class="n">MAX_LOCAL_APIC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">x2count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;No LAPIC entries present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* TBD: Cleanup to allow fallback to MPS */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">x2count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Error parsing LAPIC entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* TBD: Cleanup to allow fallback to MPS */</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x2count</span> <span class="o">=</span>
	    <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_LOCAL_X2APIC_NMI</span><span class="p">,</span>
				  <span class="n">acpi_parse_x2apic_nmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_LOCAL_APIC_NMI</span><span class="p">,</span> <span class="n">acpi_parse_lapic_nmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">x2count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Error parsing LAPIC NMI entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* TBD: Cleanup to allow fallback to MPS */</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_X86_LOCAL_APIC */</span><span class="cp"></span>

<span class="cp">#ifdef	CONFIG_X86_IO_APIC</span>
<span class="cp">#define MP_ISA_BUS		0</span>

<span class="cp">#ifdef CONFIG_X86_ES7000</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">es7000_plat</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mp_override_legacy_irq</span><span class="p">(</span><span class="n">u8</span> <span class="n">bus_irq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">u8</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioapic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="n">mp_irq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert &#39;gsi&#39; to &#39;ioapic.pin&#39;.</span>
<span class="cm">	 */</span>
	<span class="n">ioapic</span> <span class="o">=</span> <span class="n">mp_find_ioapic</span><span class="p">(</span><span class="n">gsi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioapic</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="n">mp_find_ioapic_pin</span><span class="p">(</span><span class="n">ioapic</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TBD: This check is for faulty timer entries, where the override</span>
<span class="cm">	 *      erroneously sets the trigger to level, resulting in a HUGE</span>
<span class="cm">	 *      increase of timer interrupts!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus_irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">trigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mp_irq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_INTSRC</span><span class="p">;</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqtype</span> <span class="o">=</span> <span class="n">mp_INT</span><span class="p">;</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">polarity</span><span class="p">;</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbus</span> <span class="o">=</span> <span class="n">MP_ISA_BUS</span><span class="p">;</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbusirq</span> <span class="o">=</span> <span class="n">bus_irq</span><span class="p">;</span>	<span class="cm">/* IRQ */</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstapic</span> <span class="o">=</span> <span class="n">mpc_ioapic_id</span><span class="p">(</span><span class="n">ioapic</span><span class="p">);</span> <span class="cm">/* APIC ID */</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstirq</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>	<span class="cm">/* INTIN# */</span>

	<span class="n">mp_save_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_irq</span><span class="p">);</span>

	<span class="n">isa_irq_to_gsi</span><span class="p">[</span><span class="n">bus_irq</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsi</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mp_config_acpi_legacy_irqs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="n">mp_irq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="cm">/*</span>
<span class="cm">	 * Fabricate the legacy ISA bus (bus #31).</span>
<span class="cm">	 */</span>
	<span class="n">mp_bus_id_to_type</span><span class="p">[</span><span class="n">MP_ISA_BUS</span><span class="p">]</span> <span class="o">=</span> <span class="n">MP_BUS_ISA</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MP_ISA_BUS</span><span class="p">,</span> <span class="n">mp_bus_not_pci</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Bus #%d is ISA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MP_ISA_BUS</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_X86_ES7000</span>
	<span class="cm">/*</span>
<span class="cm">	 * Older generations of ES7000 have no legacy identity mappings</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">es7000_plat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the default configuration for the IRQs 0-15.  Unless</span>
<span class="cm">	 * overridden by (MADT) interrupt source override entries.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ioapic</span><span class="p">,</span> <span class="n">pin</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dstapic</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">gsi</span><span class="p">;</span>

		<span class="cm">/* Locate the gsi that irq i maps to. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_isa_irq_to_gsi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gsi</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Locate the IOAPIC that manages the ISA IRQ.</span>
<span class="cm">		 */</span>
		<span class="n">ioapic</span> <span class="o">=</span> <span class="n">mp_find_ioapic</span><span class="p">(</span><span class="n">gsi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioapic</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pin</span> <span class="o">=</span> <span class="n">mp_find_ioapic_pin</span><span class="p">(</span><span class="n">ioapic</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>
		<span class="n">dstapic</span> <span class="o">=</span> <span class="n">mpc_ioapic_id</span><span class="p">(</span><span class="n">ioapic</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">mp_irq_entries</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="n">mp_irqs</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>

			<span class="cm">/* Do we already have a mapping for this ISA IRQ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">srcbus</span> <span class="o">==</span> <span class="n">MP_ISA_BUS</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">srcbusirq</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Do we already have a mapping for this IOAPIC pin */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">dstapic</span> <span class="o">==</span> <span class="n">dstapic</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">dstirq</span> <span class="o">==</span> <span class="n">pin</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">mp_irq_entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ACPI: IRQ%d used by override.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* IRQ already used */</span>
		<span class="p">}</span>

		<span class="n">mp_irq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_INTSRC</span><span class="p">;</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Conforming */</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbus</span> <span class="o">=</span> <span class="n">MP_ISA_BUS</span><span class="p">;</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstapic</span> <span class="o">=</span> <span class="n">dstapic</span><span class="p">;</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqtype</span> <span class="o">=</span> <span class="n">mp_INT</span><span class="p">;</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbusirq</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* Identity mapped */</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstirq</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>

		<span class="n">mp_save_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mp_config_acpi_gsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_MPPARSE</span>
	<span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="n">mp_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">number</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioapic</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ioapic</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">number</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">devfn</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">;</span>
	<span class="cm">/* print the entry should happen on mptable identically */</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_INTSRC</span><span class="p">;</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqtype</span> <span class="o">=</span> <span class="n">mp_INT</span><span class="p">;</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">ACPI_EDGE_SENSITIVE</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">polarity</span> <span class="o">==</span> <span class="n">ACPI_ACTIVE_HIGH</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbus</span> <span class="o">=</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbusirq</span> <span class="o">=</span> <span class="p">(((</span><span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">ioapic</span> <span class="o">=</span> <span class="n">mp_find_ioapic</span><span class="p">(</span><span class="n">gsi</span><span class="p">);</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstapic</span> <span class="o">=</span> <span class="n">mpc_ioapic_id</span><span class="p">(</span><span class="n">ioapic</span><span class="p">);</span>
	<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstirq</span> <span class="o">=</span> <span class="n">mp_find_ioapic_pin</span><span class="p">(</span><span class="n">ioapic</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>

	<span class="n">mp_save_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_irq</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mp_register_gsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioapic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioapic_pin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_apic_irq_attr</span> <span class="n">irq_attr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_irq_model</span> <span class="o">!=</span> <span class="n">ACPI_IRQ_MODEL_IOAPIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">gsi</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t set up the ACPI SCI because it&#39;s already set up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">sci_interrupt</span> <span class="o">==</span> <span class="n">gsi</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">gsi</span><span class="p">;</span>

	<span class="n">ioapic</span> <span class="o">=</span> <span class="n">mp_find_ioapic</span><span class="p">(</span><span class="n">gsi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioapic</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;No IOAPIC for GSI %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">gsi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioapic_pin</span> <span class="o">=</span> <span class="n">mp_find_ioapic_pin</span><span class="p">(</span><span class="n">ioapic</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioapic_pin</span> <span class="o">&gt;</span> <span class="n">MP_MAX_IOAPIC_PIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid reference to IOAPIC pin &quot;</span>
		       <span class="s">&quot;%d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpc_ioapic_id</span><span class="p">(</span><span class="n">ioapic</span><span class="p">),</span>
		       <span class="n">ioapic_pin</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">gsi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_update_mptable</span><span class="p">)</span>
		<span class="n">mp_config_acpi_gsi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gsi</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>

	<span class="n">set_io_apic_irq_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_attr</span><span class="p">,</span> <span class="n">ioapic</span><span class="p">,</span> <span class="n">ioapic_pin</span><span class="p">,</span>
			     <span class="n">trigger</span> <span class="o">==</span> <span class="n">ACPI_EDGE_SENSITIVE</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">polarity</span> <span class="o">==</span> <span class="n">ACPI_ACTIVE_HIGH</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">io_apic_set_pci_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gsi_to_irq</span><span class="p">(</span><span class="n">gsi</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">irq_attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">gsi</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse IOAPIC related entries in MADT</span>
<span class="cm"> * returns 0 on success, &lt; 0 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_parse_madt_ioapic_entries</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ACPI interpreter is required to complete interrupt setup,</span>
<span class="cm">	 * so if it is off, don&#39;t enumerate the io-apics with ACPI.</span>
<span class="cm">	 * If MPS is present, it will handle them,</span>
<span class="cm">	 * otherwise the system will stay in PIC mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span> <span class="o">||</span> <span class="n">acpi_noirq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_apic</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if &quot;noapic&quot; boot option, don&#39;t look for IO-APICs</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skip_ioapic_setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;Skipping IOAPIC probe &quot;</span>
		       <span class="s">&quot;due to &#39;noapic&#39; option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_IO_APIC</span><span class="p">,</span> <span class="n">acpi_parse_ioapic</span><span class="p">,</span>
				  <span class="n">MAX_IO_APICS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;No IOAPIC entries present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Error parsing IOAPIC entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_INTERRUPT_OVERRIDE</span><span class="p">,</span> <span class="n">acpi_parse_int_src_ovr</span><span class="p">,</span>
				  <span class="n">nr_irqs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span>
		       <span class="s">&quot;Error parsing interrupt source overrides entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* TBD: Cleanup to allow fallback to MPS */</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If BIOS did not supply an INT_SRC_OVR for the SCI</span>
<span class="cm">	 * pretend we got one so we can set the SCI flags.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_sci_override_gsi</span><span class="p">)</span>
		<span class="n">acpi_sci_ioapic_setup</span><span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">sci_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">sci_interrupt</span><span class="p">);</span>

	<span class="cm">/* Fill in identity legacy mappings where no override */</span>
	<span class="n">mp_config_acpi_legacy_irqs</span><span class="p">();</span>

	<span class="n">count</span> <span class="o">=</span>
	    <span class="n">acpi_table_parse_madt</span><span class="p">(</span><span class="n">ACPI_MADT_TYPE_NMI_SOURCE</span><span class="p">,</span> <span class="n">acpi_parse_nmi_src</span><span class="p">,</span>
				  <span class="n">nr_irqs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Error parsing NMI SRC entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* TBD: Cleanup to allow fallback to MPS */</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">acpi_parse_madt_ioapic_entries</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* !CONFIG_X86_IO_APIC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">early_acpi_process_madt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_table_parse</span><span class="p">(</span><span class="n">ACPI_SIG_MADT</span><span class="p">,</span> <span class="n">acpi_parse_madt</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Parse MADT LAPIC entries</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">early_acpi_parse_madt_lapic_addr_ovr</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acpi_lapic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">smp_found_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Dell Precision Workstation 410, 610 come here.</span>
<span class="cm">			 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span>
			       <span class="s">&quot;Invalid BIOS MADT, disabling ACPI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">disable_acpi</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">acpi_process_madt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_table_parse</span><span class="p">(</span><span class="n">ACPI_SIG_MADT</span><span class="p">,</span> <span class="n">acpi_parse_madt</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Parse MADT LAPIC entries</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">acpi_parse_madt_lapic_entries</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acpi_lapic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Parse MADT IO-APIC entries</span>
<span class="cm">			 */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">acpi_parse_madt_ioapic_entries</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">acpi_set_irq_model_ioapic</span><span class="p">();</span>

				<span class="n">smp_found_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Dell Precision Workstation 410, 610 come here.</span>
<span class="cm">			 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span>
			       <span class="s">&quot;Invalid BIOS MADT, disabling ACPI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">disable_acpi</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm"> 		 * ACPI found no MADT, and so ACPI wants UP PIC mode.</span>
<span class="cm"> 		 * In the event an MPS table was found, forget it.</span>
<span class="cm"> 		 * Boot with &quot;acpi=off&quot; to use MPS on such a system.</span>
<span class="cm"> 		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smp_found_config</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span>
				<span class="s">&quot;No APIC-table, disabling MPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">smp_found_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ACPI supports both logical (e.g. Hyper-Threading) and physical</span>
<span class="cm">	 * processors, where MPS only supports physical.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_lapic</span> <span class="o">&amp;&amp;</span> <span class="n">acpi_ioapic</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Using ACPI (MADT) for SMP configuration &quot;</span>
		       <span class="s">&quot;information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acpi_lapic</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Using ACPI for processor (LAPIC) &quot;</span>
		       <span class="s">&quot;configuration information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">disable_acpi_irq</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s detected: force use of acpi=noirq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
		<span class="n">acpi_noirq_set</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">disable_acpi_pci</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s detected: force use of pci=noacpi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
		<span class="n">acpi_disable_pci</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dmi_disable_acpi</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s detected: acpi off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
		<span class="n">disable_acpi</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;Warning: DMI blacklist says broken, but acpi forced</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Force ignoring BIOS IRQ0 override</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dmi_ignore_irq0_timer_override</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_skip_timer_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s detected: Ignoring BIOS IRQ0 override</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
		<span class="n">acpi_skip_timer_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If your system is blacklisted here, but you find that acpi=force</span>
<span class="cm"> * works for you, please contact linux-acpi@vger.kernel.org</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">acpi_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Boxes that need ACPI disabled</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_disable_acpi</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;IBM Thinkpad&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;IBM&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;2629H1G&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * Boxes that need ACPI PCI IRQ routing disabled</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">disable_acpi_irq</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;ASUS A7V&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;ASUSTeK Computer INC&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;&lt;A7V&gt;&quot;</span><span class="p">),</span>
		     <span class="cm">/* newer BIOS, Revision 1011, does work */</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">,</span>
			       <span class="s">&quot;ASUS A7V ACPI BIOS Revision 1007&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Latest BIOS for IBM 600E (1.16) has bad pcinum</span>
<span class="cm">		 * for LPC bridge, which is needed for the PCI</span>
<span class="cm">		 * interrupt links to work. DSDT fix is in bug 5966.</span>
<span class="cm">		 * 2645, 2646 model numbers are shared with 600/600E/600X</span>
<span class="cm">		 */</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">disable_acpi_irq</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;IBM Thinkpad 600 Series 2645&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;IBM&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;2645&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">disable_acpi_irq</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;IBM Thinkpad 600 Series 2646&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;IBM&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;2646&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * Boxes that need ACPI PCI IRQ routing and PCI scan disabled</span>
<span class="cm">	 */</span>
	<span class="p">{</span>			<span class="cm">/* _BBN 0 bug */</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">disable_acpi_pci</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;ASUS PR-DLS&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;ASUSTeK Computer INC.&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;PR-DLS&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">,</span>
			       <span class="s">&quot;ASUS PR-DLS ACPI BIOS Revision 1010&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BIOS_DATE</span><span class="p">,</span> <span class="s">&quot;03/21/2003&quot;</span><span class="p">)</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">disable_acpi_pci</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer TravelMate 36x Laptop&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TravelMate 360&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/* second table for DMI checks that should run after early-quirks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">acpi_dmi_table_late</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * HP laptops which use a DSDT reporting as HP/SB400/10000,</span>
<span class="cm">	 * which includes some code which overrides all temperature</span>
<span class="cm">	 * trip points to 16C if the INTIN2 input of the I/O APIC</span>
<span class="cm">	 * is enabled.  This input is incorrectly designated the</span>
<span class="cm">	 * ISA IRQ 0 via an interrupt source override even though</span>
<span class="cm">	 * it is wired to the output of the master 8259A and INTIN0</span>
<span class="cm">	 * is not connected at all.  Force ignoring BIOS IRQ0</span>
<span class="cm">	 * override in that cases.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_ignore_irq0_timer_override</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP nx6115 laptop&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq nx6115&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_ignore_irq0_timer_override</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP NX6125 laptop&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq nx6125&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_ignore_irq0_timer_override</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP NX6325 laptop&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq nx6325&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_ignore_irq0_timer_override</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP 6715b laptop&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq 6715b&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_ignore_irq0_timer_override</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;FUJITSU SIEMENS&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;FUJITSU SIEMENS&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;AMILO PRO V2030&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * acpi_boot_table_init() and acpi_boot_init()</span>
<span class="cm"> *  called from setup_arch(), always.</span>
<span class="cm"> *	1. checksums all tables</span>
<span class="cm"> *	2. enumerates lapics</span>
<span class="cm"> *	3. enumerates io-apics</span>
<span class="cm"> *</span>
<span class="cm"> * acpi_table_init() is separate to allow reading SRAT without</span>
<span class="cm"> * other side effects.</span>
<span class="cm"> *</span>
<span class="cm"> * side effects of acpi_boot_init:</span>
<span class="cm"> *	acpi_lapic = 1 if LAPIC found</span>
<span class="cm"> *	acpi_ioapic = 1 if IOAPIC found</span>
<span class="cm"> *	if (acpi_lapic &amp;&amp; acpi_ioapic) smp_found_config = 1;</span>
<span class="cm"> *	if acpi_blacklisted() acpi_disabled = 1;</span>
<span class="cm"> *	acpi_irq_model=...</span>
<span class="cm"> *	...</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">acpi_boot_table_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmi_check_system</span><span class="p">(</span><span class="n">acpi_dmi_table</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If acpi_disabled, bail out</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> 

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the ACPI boot-time table parser.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_table_init</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">disable_acpi</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acpi_table_parse</span><span class="p">(</span><span class="n">ACPI_SIG_BOOT</span><span class="p">,</span> <span class="n">acpi_parse_sbf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * blacklist may disable ACPI entirely</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_blacklisted</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_force</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;acpi=force override</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Disabling ACPI support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">disable_acpi</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_acpi_boot_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If acpi_disabled, bail out</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process the Multiple APIC Description Table (MADT), if present</span>
<span class="cm">	 */</span>
	<span class="n">early_acpi_process_madt</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_boot_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* those are executed after early-quirks are executed */</span>
	<span class="n">dmi_check_system</span><span class="p">(</span><span class="n">acpi_dmi_table_late</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If acpi_disabled, bail out</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">acpi_table_parse</span><span class="p">(</span><span class="n">ACPI_SIG_BOOT</span><span class="p">,</span> <span class="n">acpi_parse_sbf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set sci_int and PM timer address</span>
<span class="cm">	 */</span>
	<span class="n">acpi_table_parse</span><span class="p">(</span><span class="n">ACPI_SIG_FADT</span><span class="p">,</span> <span class="n">acpi_parse_fadt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process the Multiple APIC Description Table (MADT), if present</span>
<span class="cm">	 */</span>
	<span class="n">acpi_process_madt</span><span class="p">();</span>

	<span class="n">acpi_table_parse</span><span class="p">(</span><span class="n">ACPI_SIG_HPET</span><span class="p">,</span> <span class="n">acpi_parse_hpet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_noirq</span><span class="p">)</span>
		<span class="n">x86_init</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pci_acpi_init</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_acpi</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* &quot;acpi=off&quot; disables both ACPI table parsing and interpreter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disable_acpi</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* acpi=force to over-ride black-list */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;force&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_force</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">acpi_disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* acpi=strict disables out-of-spec workarounds */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;strict&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_strict</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* acpi=rsdt use RSDT instead of XSDT */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;rsdt&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_rsdt_forced</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* &quot;acpi=noirq&quot; disables ACPI interrupt routing */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;noirq&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_noirq_set</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* &quot;acpi=copy_dsdt&quot; copys DSDT */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;copy_dsdt&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_gbl_copy_dsdt_locally</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Core will printk when we return error. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;acpi&quot;</span><span class="p">,</span> <span class="n">parse_acpi</span><span class="p">);</span>

<span class="cm">/* FIXME: Using pci= for an ACPI parameter is a travesty. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_pci</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;noacpi&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">acpi_disable_pci</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;pci&quot;</span><span class="p">,</span> <span class="n">parse_pci</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_mps_check</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_X86_LOCAL_APIC) &amp;&amp; !defined(CONFIG_X86_MPPARSE)</span>
<span class="cm">/* mptable code is not built-in*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span> <span class="o">||</span> <span class="n">acpi_noirq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;MPS support code is not built-in.</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Using acpi=off or acpi=noirq or pci=noacpi &quot;</span>
		       <span class="s">&quot;may have problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_acpi_skip_timer_override</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_skip_timer_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;acpi_skip_timer_override&quot;</span><span class="p">,</span> <span class="n">parse_acpi_skip_timer_override</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_acpi_use_timer_override</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_use_timer_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;acpi_use_timer_override&quot;</span><span class="p">,</span> <span class="n">parse_acpi_use_timer_override</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_IO_APIC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_acpi_sci</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;edge&quot;</span><span class="p">))</span>
		<span class="n">acpi_sci_flags</span> <span class="o">=</span>  <span class="n">ACPI_MADT_TRIGGER_EDGE</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">acpi_sci_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ACPI_MADT_TRIGGER_MASK</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;level&quot;</span><span class="p">))</span>
		<span class="n">acpi_sci_flags</span> <span class="o">=</span> <span class="n">ACPI_MADT_TRIGGER_LEVEL</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">acpi_sci_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ACPI_MADT_TRIGGER_MASK</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;high&quot;</span><span class="p">))</span>
		<span class="n">acpi_sci_flags</span> <span class="o">=</span> <span class="n">ACPI_MADT_POLARITY_ACTIVE_HIGH</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">acpi_sci_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ACPI_MADT_POLARITY_MASK</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;low&quot;</span><span class="p">))</span>
		<span class="n">acpi_sci_flags</span> <span class="o">=</span> <span class="n">ACPI_MADT_POLARITY_ACTIVE_LOW</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">acpi_sci_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ACPI_MADT_POLARITY_MASK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;acpi_sci&quot;</span><span class="p">,</span> <span class="n">setup_acpi_sci</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">__acpi_acquire_global_lock</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">old</span> <span class="o">=</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="p">(((</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">old</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">old</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">new</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__acpi_release_global_lock</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">old</span> <span class="o">=</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">old</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
