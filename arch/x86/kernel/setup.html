<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1995  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> *  Support of BIGMEM added by Gerhard Wichert, Siemens AG, July 1999</span>
<span class="cm"> *</span>
<span class="cm"> *  Memory region support</span>
<span class="cm"> *	David Parsons &lt;orc@pell.chi.il.us&gt;, July-August 1999</span>
<span class="cm"> *</span>
<span class="cm"> *  Added E820 sanitization routine (removes overlapping memory regions);</span>
<span class="cm"> *  Brian Moyle &lt;bmoyle@mvista.com&gt;, February 2001</span>
<span class="cm"> *</span>
<span class="cm"> * Moved CPU detection code to cpu/${cpu}.c</span>
<span class="cm"> *    Patrick Mochel &lt;mochel@osdl.org&gt;, March 2002</span>
<span class="cm"> *</span>
<span class="cm"> *  Provisions for empty E820 memory regions (reported by certain BIOSes).</span>
<span class="cm"> *  Alex Achenbach &lt;xela@slit.de&gt;, December 2002.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This file handles the architecture-dependent parts of initialization</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/mmzone.h&gt;</span>
<span class="cp">#include &lt;linux/screen_info.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/sfi.h&gt;</span>
<span class="cp">#include &lt;linux/apm_bios.h&gt;</span>
<span class="cp">#include &lt;linux/initrd.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/root_dev.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/efi.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/edd.h&gt;</span>
<span class="cp">#include &lt;linux/iscsi_ibft.h&gt;</span>
<span class="cp">#include &lt;linux/nodemask.h&gt;</span>
<span class="cp">#include &lt;linux/kexec.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/pfn.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;asm/pci-direct.h&gt;</span>
<span class="cp">#include &lt;linux/init_ohci1394_dma.h&gt;</span>
<span class="cp">#include &lt;linux/kvm_para.h&gt;</span>
<span class="cp">#include &lt;linux/dma-contiguous.h&gt;</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/crash_dump.h&gt;</span>
<span class="cp">#include &lt;linux/tboot.h&gt;</span>

<span class="cp">#include &lt;video/edid.h&gt;</span>

<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#include &lt;asm/apic.h&gt;</span>
<span class="cp">#include &lt;asm/realmode.h&gt;</span>
<span class="cp">#include &lt;asm/e820.h&gt;</span>
<span class="cp">#include &lt;asm/mpspec.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/efi.h&gt;</span>
<span class="cp">#include &lt;asm/timer.h&gt;</span>
<span class="cp">#include &lt;asm/i8259.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/dmi.h&gt;</span>
<span class="cp">#include &lt;asm/io_apic.h&gt;</span>
<span class="cp">#include &lt;asm/ist.h&gt;</span>
<span class="cp">#include &lt;asm/setup_arch.h&gt;</span>
<span class="cp">#include &lt;asm/bios_ebda.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/bugs.h&gt;</span>

<span class="cp">#include &lt;asm/vsyscall.h&gt;</span>
<span class="cp">#include &lt;asm/cpu.h&gt;</span>
<span class="cp">#include &lt;asm/desc.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/gart.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;asm/proto.h&gt;</span>

<span class="cp">#include &lt;asm/paravirt.h&gt;</span>
<span class="cp">#include &lt;asm/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/olpc_ofw.h&gt;</span>

<span class="cp">#include &lt;asm/percpu.h&gt;</span>
<span class="cp">#include &lt;asm/topology.h&gt;</span>
<span class="cp">#include &lt;asm/apicdef.h&gt;</span>
<span class="cp">#include &lt;asm/amd_nb.h&gt;</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="cp">#include &lt;asm/numa_64.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;asm/mce.h&gt;</span>
<span class="cp">#include &lt;asm/alternative.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * end_pfn only includes RAM, while max_pfn_mapped includes all e820 entries.</span>
<span class="cm"> * The direct mapping extends to max_pfn_mapped, so that we can directly access</span>
<span class="cm"> * apertures, ACPI and other tables without having to play with fixmaps.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_low_pfn_mapped</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_pfn_mapped</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_DMI</span>
<span class="n">RESERVE_BRK</span><span class="p">(</span><span class="n">dmi_alloc</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="n">__initdata</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_brk_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__brk_base</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_brk_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__brk_base</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="kt">int</span> <span class="nf">default_cpu_present_to_apicid</span><span class="p">(</span><span class="kt">int</span> <span class="n">mps_cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__default_cpu_present_to_apicid</span><span class="p">(</span><span class="n">mps_cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">default_check_phys_apicid_present</span><span class="p">(</span><span class="kt">int</span> <span class="n">phys_apicid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__default_check_phys_apicid_present</span><span class="p">(</span><span class="n">phys_apicid</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_DEBUG_BOOT_PARAMS</span>
<span class="k">struct</span> <span class="n">boot_params</span> <span class="n">__initdata</span> <span class="n">boot_params</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">struct</span> <span class="n">boot_params</span> <span class="n">boot_params</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Machine setup..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">data_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Kernel data&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">code_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Kernel code&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">bss_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Kernel bss&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span>
<span class="p">};</span>


<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cm">/* cpu data as detected by the assembly code in head.S */</span>
<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="n">new_cpu_data</span> <span class="n">__cpuinitdata</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="cm">/* common cpu data for all cpus */</span>
<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="n">boot_cpu_data</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def_to_bigsmp</span><span class="p">;</span>

<span class="cm">/* for MCA, but anyone else can use it if they want */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">machine_id</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">machine_submodel_id</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BIOS_revision</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">apm_info</span> <span class="n">apm_info</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">apm_info</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_X86_SPEEDSTEP_SMI) || \</span>
<span class="cp">	defined(CONFIG_X86_SPEEDSTEP_SMI_MODULE)</span>
<span class="k">struct</span> <span class="n">ist_info</span> <span class="n">ist_info</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ist_info</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">struct</span> <span class="n">ist_info</span> <span class="n">ist_info</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#else</span>
<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="n">boot_cpu_data</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">x86_phys_bits</span> <span class="o">=</span> <span class="n">MAX_PHYSMEM_BITS</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="cp">#if !defined(CONFIG_X86_PAE) || defined(CONFIG_X86_64)</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmu_cr4_features</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmu_cr4_features</span> <span class="o">=</span> <span class="n">X86_CR4_PAE</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* Boot loader ID and version as integers, for the benefit of proc_dointvec */</span>
<span class="kt">int</span> <span class="n">bootloader_type</span><span class="p">,</span> <span class="n">bootloader_version</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Setup options</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">screen_info</span> <span class="n">screen_info</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">screen_info</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">edid_info</span> <span class="n">edid_info</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">edid_info</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">root_mountflags</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saved_video_mode</span><span class="p">;</span>

<span class="cp">#define RAMDISK_IMAGE_START_MASK	0x07FF</span>
<span class="cp">#define RAMDISK_PROMPT_FLAG		0x8000</span>
<span class="cp">#define RAMDISK_LOAD_FLAG		0x4000</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">__initdata</span> <span class="n">command_line</span><span class="p">[</span><span class="n">COMMAND_LINE_SIZE</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_CMDLINE_BOOL</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">__initdata</span> <span class="n">builtin_cmdline</span><span class="p">[</span><span class="n">COMMAND_LINE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONFIG_CMDLINE</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_EDD) || defined(CONFIG_EDD_MODULE)</span>
<span class="k">struct</span> <span class="n">edd</span> <span class="n">edd</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_EDD_MODULE</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">edd</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cm">/**</span>
<span class="cm"> * copy_edd() - Copy the BIOS EDD information</span>
<span class="cm"> *              from boot_params into a safe place.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">copy_edd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
     <span class="n">memcpy</span><span class="p">(</span><span class="n">edd</span><span class="p">.</span><span class="n">mbr_signature</span><span class="p">,</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">edd_mbr_sig_buffer</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">edd</span><span class="p">.</span><span class="n">mbr_signature</span><span class="p">));</span>
     <span class="n">memcpy</span><span class="p">(</span><span class="n">edd</span><span class="p">.</span><span class="n">edd_info</span><span class="p">,</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">eddbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">edd</span><span class="p">.</span><span class="n">edd_info</span><span class="p">));</span>
     <span class="n">edd</span><span class="p">.</span><span class="n">mbr_signature_nr</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">edd_mbr_sig_buf_entries</span><span class="p">;</span>
     <span class="n">edd</span><span class="p">.</span><span class="n">edd_info_nr</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">eddbuf_entries</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">copy_edd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">extend_brk</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">_brk_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">align</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">_brk_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">_brk_end</span> <span class="o">+</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">_brk_end</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">__brk_limit</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_brk_end</span><span class="p">;</span>
	<span class="n">_brk_end</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_gbpages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direct_gbpages</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_has_gbpages</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Using GB pages for direct mapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">direct_gbpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">init_gbpages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">cleanup_highmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_brk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_brk_end</span> <span class="o">&gt;</span> <span class="n">_brk_start</span><span class="p">)</span>
		<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">_brk_start</span><span class="p">),</span>
				 <span class="n">__pa</span><span class="p">(</span><span class="n">_brk_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">__pa</span><span class="p">(</span><span class="n">_brk_start</span><span class="p">));</span>

	<span class="cm">/* Mark brk area as locked down and no longer taking any</span>
<span class="cm">	   new allocations */</span>
	<span class="n">_brk_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>

<span class="cp">#define MAX_MAP_CHUNK	(NR_FIX_BTMAPS &lt;&lt; PAGE_SHIFT)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">relocate_initrd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Assume only end is not page aligned */</span>
	<span class="n">u64</span> <span class="n">ramdisk_image</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ramdisk_image</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ramdisk_size</span>  <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ramdisk_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">area_size</span>     <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">ramdisk_size</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">end_of_lowmem</span> <span class="o">=</span> <span class="n">max_low_pfn_mapped</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ramdisk_here</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">slop</span><span class="p">,</span> <span class="n">clen</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="cm">/* We need to move the initrd down into lowmem */</span>
	<span class="n">ramdisk_here</span> <span class="o">=</span> <span class="n">memblock_find_in_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_of_lowmem</span><span class="p">,</span> <span class="n">area_size</span><span class="p">,</span>
					 <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ramdisk_here</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Cannot find place for new RAMDISK of size %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ramdisk_size</span><span class="p">);</span>

	<span class="cm">/* Note: this includes all the lowmem currently occupied by</span>
<span class="cm">	   the initrd, we rely on that fact to keep the data intact. */</span>
	<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">ramdisk_here</span><span class="p">,</span> <span class="n">area_size</span><span class="p">);</span>
	<span class="n">initrd_start</span> <span class="o">=</span> <span class="n">ramdisk_here</span> <span class="o">+</span> <span class="n">PAGE_OFFSET</span><span class="p">;</span>
	<span class="n">initrd_end</span>   <span class="o">=</span> <span class="n">initrd_start</span> <span class="o">+</span> <span class="n">ramdisk_size</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Allocated new RAMDISK: [mem %#010llx-%#010llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ramdisk_here</span><span class="p">,</span> <span class="n">ramdisk_here</span> <span class="o">+</span> <span class="n">ramdisk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">;</span>

	<span class="cm">/* Copy any lowmem portion of the initrd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ramdisk_image</span> <span class="o">&lt;</span> <span class="n">end_of_lowmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">end_of_lowmem</span> <span class="o">-</span> <span class="n">ramdisk_image</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">ramdisk_image</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">clen</span><span class="p">);</span>
		<span class="n">q</span> <span class="o">+=</span> <span class="n">clen</span><span class="p">;</span>
		<span class="n">ramdisk_image</span> <span class="o">+=</span> <span class="n">clen</span><span class="p">;</span>
		<span class="n">ramdisk_size</span>  <span class="o">-=</span> <span class="n">clen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the highmem portion of the initrd */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ramdisk_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slop</span> <span class="o">=</span> <span class="n">ramdisk_image</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">ramdisk_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clen</span> <span class="o">&gt;</span> <span class="n">MAX_MAP_CHUNK</span><span class="o">-</span><span class="n">slop</span><span class="p">)</span>
			<span class="n">clen</span> <span class="o">=</span> <span class="n">MAX_MAP_CHUNK</span><span class="o">-</span><span class="n">slop</span><span class="p">;</span>
		<span class="n">mapaddr</span> <span class="o">=</span> <span class="n">ramdisk_image</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">early_memremap</span><span class="p">(</span><span class="n">mapaddr</span><span class="p">,</span> <span class="n">clen</span><span class="o">+</span><span class="n">slop</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">slop</span><span class="p">,</span> <span class="n">clen</span><span class="p">);</span>
		<span class="n">early_iounmap</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">clen</span><span class="o">+</span><span class="n">slop</span><span class="p">);</span>
		<span class="n">q</span> <span class="o">+=</span> <span class="n">clen</span><span class="p">;</span>
		<span class="n">ramdisk_image</span> <span class="o">+=</span> <span class="n">clen</span><span class="p">;</span>
		<span class="n">ramdisk_size</span>  <span class="o">-=</span> <span class="n">clen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* high pages is not converted by early_res_to_bootmem */</span>
	<span class="n">ramdisk_image</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ramdisk_image</span><span class="p">;</span>
	<span class="n">ramdisk_size</span>  <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ramdisk_size</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Move RAMDISK from [mem %#010llx-%#010llx] to&quot;</span>
		<span class="s">&quot; [mem %#010llx-%#010llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ramdisk_image</span><span class="p">,</span> <span class="n">ramdisk_image</span> <span class="o">+</span> <span class="n">ramdisk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">ramdisk_here</span><span class="p">,</span> <span class="n">ramdisk_here</span> <span class="o">+</span> <span class="n">ramdisk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_initrd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Assume only end is not page aligned */</span>
	<span class="n">u64</span> <span class="n">ramdisk_image</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ramdisk_image</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ramdisk_size</span>  <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ramdisk_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ramdisk_end</span>   <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">ramdisk_image</span> <span class="o">+</span> <span class="n">ramdisk_size</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">end_of_lowmem</span> <span class="o">=</span> <span class="n">max_low_pfn_mapped</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type_of_loader</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ramdisk_image</span> <span class="o">||</span> <span class="o">!</span><span class="n">ramdisk_size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* No initrd provided by bootloader */</span>

	<span class="n">initrd_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ramdisk_size</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">end_of_lowmem</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;initrd too large to handle, &quot;</span>
		       <span class="s">&quot;disabling initrd (%lld needed, %lld available)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ramdisk_size</span><span class="p">,</span> <span class="n">end_of_lowmem</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RAMDISK: [mem %#010llx-%#010llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ramdisk_image</span><span class="p">,</span>
			<span class="n">ramdisk_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ramdisk_end</span> <span class="o">&lt;=</span> <span class="n">end_of_lowmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All in lowmem, easy case */</span>
		<span class="cm">/*</span>
<span class="cm">		 * don&#39;t need to reserve again, already reserved early</span>
<span class="cm">		 * in i386_start_kernel</span>
<span class="cm">		 */</span>
		<span class="n">initrd_start</span> <span class="o">=</span> <span class="n">ramdisk_image</span> <span class="o">+</span> <span class="n">PAGE_OFFSET</span><span class="p">;</span>
		<span class="n">initrd_end</span> <span class="o">=</span> <span class="n">initrd_start</span> <span class="o">+</span> <span class="n">ramdisk_size</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">relocate_initrd</span><span class="p">();</span>

	<span class="n">memblock_free</span><span class="p">(</span><span class="n">ramdisk_image</span><span class="p">,</span> <span class="n">ramdisk_end</span> <span class="o">-</span> <span class="n">ramdisk_image</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_initrd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BLK_DEV_INITRD */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">parse_setup_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">setup_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pa_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mh">0x0209</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pa_data</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">setup_data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pa_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">map_len</span><span class="p">;</span>

		<span class="n">map_len</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="n">pa_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">),</span>
			      <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">setup_data</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">early_memremap</span><span class="p">(</span><span class="n">pa_data</span><span class="p">,</span> <span class="n">map_len</span><span class="p">);</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">setup_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">map_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">early_iounmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">map_len</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">early_memremap</span><span class="p">(</span><span class="n">pa_data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
			<span class="n">map_len</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SETUP_E820_EXT</span>:
			<span class="n">parse_e820_ext</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SETUP_DTB</span>:
			<span class="n">add_dtb</span><span class="p">(</span><span class="n">pa_data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pa_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">early_iounmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">map_len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">e820_reserve_setup_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">setup_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pa_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mh">0x0209</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pa_data</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">setup_data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pa_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">early_memremap</span><span class="p">(</span><span class="n">pa_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
		<span class="n">e820_update_range</span><span class="p">(</span><span class="n">pa_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="o">+</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			 <span class="n">E820_RAM</span><span class="p">,</span> <span class="n">E820_RESERVED_KERN</span><span class="p">);</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pa_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">early_iounmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sanitize_e820_map</span><span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">e820</span><span class="p">.</span><span class="n">nr_map</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e820_saved</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e820</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">e820map</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;extended physical RAM map:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">e820_print_map</span><span class="p">(</span><span class="s">&quot;reserve setup_data&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">memblock_x86_reserve_range_setup_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">setup_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pa_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mh">0x0209</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pa_data</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">setup_data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pa_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">early_memremap</span><span class="p">(</span><span class="n">pa_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
		<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">pa_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">pa_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">early_iounmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * --------- Crashkernel reservation ------------------------------</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_KEXEC</span>

<span class="cm">/*</span>
<span class="cm"> * Keep the crash kernel below this limit.  On 32 bits earlier kernels</span>
<span class="cm"> * would limit the kernel to the low 512 MiB due to mapping restrictions.</span>
<span class="cm"> * On 64 bits, kexec-tools currently limits us to 896 MiB; increase this</span>
<span class="cm"> * limit once kexec-tools are fixed.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cp"># define CRASH_KERNEL_ADDR_MAX	(512 &lt;&lt; 20)</span>
<span class="cp">#else</span>
<span class="cp"># define CRASH_KERNEL_ADDR_MAX	(896 &lt;&lt; 20)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_crashkernel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">total_mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">crash_size</span><span class="p">,</span> <span class="n">crash_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">total_mem</span> <span class="o">=</span> <span class="n">memblock_phys_mem_size</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_crashkernel</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">total_mem</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">crash_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crash_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">crash_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* 0 means: find the address automatically */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crash_base</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">alignment</span> <span class="o">=</span> <span class="mi">16</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">;</span>	<span class="cm">/* 16M */</span>

		<span class="cm">/*</span>
<span class="cm">		 *  kexec want bzImage is below CRASH_KERNEL_ADDR_MAX</span>
<span class="cm">		 */</span>
		<span class="n">crash_base</span> <span class="o">=</span> <span class="n">memblock_find_in_range</span><span class="p">(</span><span class="n">alignment</span><span class="p">,</span>
			       <span class="n">CRASH_KERNEL_ADDR_MAX</span><span class="p">,</span> <span class="n">crash_size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crash_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;crashkernel reservation failed - No suitable area found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">memblock_find_in_range</span><span class="p">(</span><span class="n">crash_base</span><span class="p">,</span>
				 <span class="n">crash_base</span> <span class="o">+</span> <span class="n">crash_size</span><span class="p">,</span> <span class="n">crash_size</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">crash_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;crashkernel reservation failed - memory is in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">crash_base</span><span class="p">,</span> <span class="n">crash_size</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Reserving %ldMB of memory at %ldMB &quot;</span>
			<span class="s">&quot;for crashkernel (System RAM: %ldMB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">crash_size</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">crash_base</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">total_mem</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">));</span>

	<span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">crash_base</span><span class="p">;</span>
	<span class="n">crashk_res</span><span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">crash_base</span> <span class="o">+</span> <span class="n">crash_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">insert_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crashk_res</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_crashkernel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">standard_io_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dma1&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pic1&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timer0&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timer1&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x53</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;keyboard&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;keyboard&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dma page reg&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x8f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pic2&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0xa1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dma2&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0xdf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fpu&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_standard_io_resources</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* request I/O space for devices used on all i[345]86 PCs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">standard_io_resources</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">standard_io_resources</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">reserve_ibft_region</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">find_ibft_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
		<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">reserve_low</span> <span class="o">=</span> <span class="n">CONFIG_X86_RESERVE_LOW</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">trim_bios_range</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * A special case is the first 4Kb of memory;</span>
<span class="cm">	 * This is a BIOS owned area, not kernel ram, but generally</span>
<span class="cm">	 * not listed as such in the E820 table.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This typically reserves additional memory (64KiB by default)</span>
<span class="cm">	 * since some BIOSes are known to corrupt low memory.  See the</span>
<span class="cm">	 * Kconfig help text for X86_RESERVE_LOW.</span>
<span class="cm">	 */</span>
	<span class="n">e820_update_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">reserve_low</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">),</span>
			  <span class="n">E820_RAM</span><span class="p">,</span> <span class="n">E820_RESERVED</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * special case: Some BIOSen report the PC BIOS</span>
<span class="cm">	 * area (640-&gt;1Mb) as ram even though it is not.</span>
<span class="cm">	 * take them out.</span>
<span class="cm">	 */</span>
	<span class="n">e820_remove_range</span><span class="p">(</span><span class="n">BIOS_BEGIN</span><span class="p">,</span> <span class="n">BIOS_END</span> <span class="o">-</span> <span class="n">BIOS_BEGIN</span><span class="p">,</span> <span class="n">E820_RAM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sanitize_e820_map</span><span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">e820</span><span class="p">.</span><span class="n">nr_map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_reservelow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">memparse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">640</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">640</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>

	<span class="n">reserve_low</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;reservelow&quot;</span><span class="p">,</span> <span class="n">parse_reservelow</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Determine if we were loaded by an EFI loader.  If so, then we have also been</span>
<span class="cm"> * passed the efi memmap, systab, etc., so we should use these data structures</span>
<span class="cm"> * for initialization.  Note, the efi init code path is determined by the</span>
<span class="cm"> * global efi_enabled. This allows the same kernel image to be used on existing</span>
<span class="cm"> * systems (with a traditional BIOS) as well as on EFI systems.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * setup_arch - architecture-specific boot-time initializations</span>
<span class="cm"> *</span>
<span class="cm"> * Note: On x86_64, fixmaps are ready for use even before this is called.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_arch</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">cmdline_p</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_cpu_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_cpu_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_cpu_data</span><span class="p">));</span>
	<span class="n">visws_early_detect</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * copy kernel address range established so far and switch</span>
<span class="cm">	 * to the proper swapper page table</span>
<span class="cm">	 */</span>
	<span class="n">clone_pgd_range</span><span class="p">(</span><span class="n">swapper_pg_dir</span>     <span class="o">+</span> <span class="n">KERNEL_PGD_BOUNDARY</span><span class="p">,</span>
			<span class="n">initial_page_table</span> <span class="o">+</span> <span class="n">KERNEL_PGD_BOUNDARY</span><span class="p">,</span>
			<span class="n">KERNEL_PGD_PTRS</span><span class="p">);</span>

	<span class="n">load_cr3</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">);</span>
	<span class="n">__flush_tlb_all</span><span class="p">();</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Command line: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boot_command_line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have OLPC OFW, we might end up relocating the fixmap due to</span>
<span class="cm">	 * reserve_top(), so do this before touching the ioremap area.</span>
<span class="cm">	 */</span>
	<span class="n">olpc_ofw_detect</span><span class="p">();</span>

	<span class="n">early_trap_init</span><span class="p">();</span>
	<span class="n">early_cpu_init</span><span class="p">();</span>
	<span class="n">early_ioremap_init</span><span class="p">();</span>

	<span class="n">setup_olpc_ofw_pgd</span><span class="p">();</span>

	<span class="n">ROOT_DEV</span> <span class="o">=</span> <span class="n">old_decode_dev</span><span class="p">(</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">root_dev</span><span class="p">);</span>
	<span class="n">screen_info</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">screen_info</span><span class="p">;</span>
	<span class="n">edid_info</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">edid_info</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">apm_info</span><span class="p">.</span><span class="n">bios</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">apm_bios_info</span><span class="p">;</span>
	<span class="n">ist_info</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">ist_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_params</span><span class="p">.</span><span class="n">sys_desc_table</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">machine_id</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">sys_desc_table</span><span class="p">.</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">machine_submodel_id</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">sys_desc_table</span><span class="p">.</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">BIOS_revision</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">sys_desc_table</span><span class="p">.</span><span class="n">table</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">saved_video_mode</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">vid_mode</span><span class="p">;</span>
	<span class="n">bootloader_type</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type_of_loader</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bootloader_type</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bootloader_type</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">bootloader_type</span> <span class="o">|=</span> <span class="p">(</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ext_loader_type</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bootloader_version</span>  <span class="o">=</span> <span class="n">bootloader_type</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">bootloader_version</span> <span class="o">|=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ext_loader_ver</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_RAM</span>
	<span class="n">rd_image_start</span> <span class="o">=</span> <span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ram_size</span> <span class="o">&amp;</span> <span class="n">RAMDISK_IMAGE_START_MASK</span><span class="p">;</span>
	<span class="n">rd_prompt</span> <span class="o">=</span> <span class="p">((</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ram_size</span> <span class="o">&amp;</span> <span class="n">RAMDISK_PROMPT_FLAG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rd_doload</span> <span class="o">=</span> <span class="p">((</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ram_size</span> <span class="o">&amp;</span> <span class="n">RAMDISK_LOAD_FLAG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EFI</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_params</span><span class="p">.</span><span class="n">efi_info</span><span class="p">.</span><span class="n">efi_loader_signature</span><span class="p">,</span>
		     <span class="s">&quot;EL32&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">efi_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">efi_64bit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_params</span><span class="p">.</span><span class="n">efi_info</span><span class="p">.</span><span class="n">efi_loader_signature</span><span class="p">,</span>
		     <span class="s">&quot;EL64&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">efi_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">efi_64bit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">efi_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">efi_memblock_x86_reserve_range</span><span class="p">())</span>
		<span class="n">efi_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">oem</span><span class="p">.</span><span class="n">arch_setup</span><span class="p">();</span>

	<span class="n">iomem_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_phys_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">setup_memory_map</span><span class="p">();</span>
	<span class="n">parse_setup_data</span><span class="p">();</span>
	<span class="cm">/* update the e820_saved too */</span>
	<span class="n">e820_reserve_setup_data</span><span class="p">();</span>

	<span class="n">copy_edd</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">root_flags</span><span class="p">)</span>
		<span class="n">root_mountflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">start_code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_text</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">end_code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_etext</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">end_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_edata</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">brk</span> <span class="o">=</span> <span class="n">_brk_end</span><span class="p">;</span>

	<span class="n">code_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">_text</span><span class="p">);</span>
	<span class="n">code_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">_etext</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">data_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">_etext</span><span class="p">);</span>
	<span class="n">data_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">_edata</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">bss_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__bss_start</span><span class="p">);</span>
	<span class="n">bss_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__bss_stop</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CMDLINE_BOOL</span>
<span class="cp">#ifdef CONFIG_CMDLINE_OVERRIDE</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">builtin_cmdline</span><span class="p">,</span> <span class="n">COMMAND_LINE_SIZE</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">builtin_cmdline</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* append boot loader cmdline to builtin */</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">builtin_cmdline</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">COMMAND_LINE_SIZE</span><span class="p">);</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">builtin_cmdline</span><span class="p">,</span> <span class="n">boot_command_line</span><span class="p">,</span> <span class="n">COMMAND_LINE_SIZE</span><span class="p">);</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">builtin_cmdline</span><span class="p">,</span> <span class="n">COMMAND_LINE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="n">boot_command_line</span><span class="p">,</span> <span class="n">COMMAND_LINE_SIZE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cmdline_p</span> <span class="o">=</span> <span class="n">command_line</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * x86_configure_nx() is called before parse_early_param() to detect</span>
<span class="cm">	 * whether hardware doesn&#39;t support NX (so that the early EHCI debug</span>
<span class="cm">	 * console setup can safely call set_fixmap()). It may then be called</span>
<span class="cm">	 * again from within noexec_setup() during parsing early parameters</span>
<span class="cm">	 * to honor the respective command line option.</span>
<span class="cm">	 */</span>
	<span class="n">x86_configure_nx</span><span class="p">();</span>

	<span class="n">parse_early_param</span><span class="p">();</span>

	<span class="n">x86_report_nx</span><span class="p">();</span>

	<span class="cm">/* after early param, so could get panic from serial */</span>
	<span class="n">memblock_x86_reserve_range_setup_data</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_mps_check</span><span class="p">())</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
		<span class="n">disable_apic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">setup_clear_cpu_cap</span><span class="p">(</span><span class="n">X86_FEATURE_APIC</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_early_dump_regs</span><span class="p">)</span>
		<span class="n">early_dump_pci_devices</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">finish_e820_parsing</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">efi_enabled</span><span class="p">)</span>
		<span class="n">efi_init</span><span class="p">();</span>

	<span class="n">dmi_scan_machine</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * VMware detection requires dmi to be available, so this</span>
<span class="cm">	 * needs to be done after dmi_scan_machine, for the BP.</span>
<span class="cm">	 */</span>
	<span class="n">init_hypervisor_platform</span><span class="p">();</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">probe_roms</span><span class="p">();</span>

	<span class="cm">/* after parse_early_param, so could debug it */</span>
	<span class="n">insert_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code_resource</span><span class="p">);</span>
	<span class="n">insert_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_resource</span><span class="p">);</span>
	<span class="n">insert_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bss_resource</span><span class="p">);</span>

	<span class="n">trim_bios_range</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppro_with_ram_bug</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">e820_update_range</span><span class="p">(</span><span class="mh">0x70000000ULL</span><span class="p">,</span> <span class="mh">0x40000ULL</span><span class="p">,</span> <span class="n">E820_RAM</span><span class="p">,</span>
				  <span class="n">E820_RESERVED</span><span class="p">);</span>
		<span class="n">sanitize_e820_map</span><span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">e820</span><span class="p">.</span><span class="n">nr_map</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fixed physical RAM map:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">e820_print_map</span><span class="p">(</span><span class="s">&quot;bad_ppro&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">early_gart_iommu_check</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * partially used pages are not usable - thus</span>
<span class="cm">	 * we are rounding upwards:</span>
<span class="cm">	 */</span>
	<span class="n">max_pfn</span> <span class="o">=</span> <span class="n">e820_end_of_ram_pfn</span><span class="p">();</span>

	<span class="cm">/* update e820 for memory not covered by WB MTRRs */</span>
	<span class="n">mtrr_bp_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtrr_trim_uncached_memory</span><span class="p">(</span><span class="n">max_pfn</span><span class="p">))</span>
		<span class="n">max_pfn</span> <span class="o">=</span> <span class="n">e820_end_of_ram_pfn</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="cm">/* max_low_pfn get updated here */</span>
	<span class="n">find_low_pfn_range</span><span class="p">();</span>
<span class="cp">#else</span>
	<span class="n">num_physpages</span> <span class="o">=</span> <span class="n">max_pfn</span><span class="p">;</span>

	<span class="n">check_x2apic</span><span class="p">();</span>

	<span class="cm">/* How many end-of-memory variables you have, grandma! */</span>
	<span class="cm">/* need this before calling reserve_initrd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_pfn</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">)))</span>
		<span class="n">max_low_pfn</span> <span class="o">=</span> <span class="n">e820_end_of_low_ram_pfn</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">max_low_pfn</span> <span class="o">=</span> <span class="n">max_pfn</span><span class="p">;</span>

	<span class="n">high_memory</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">max_pfn</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find and reserve possible boot-time SMP configuration:</span>
<span class="cm">	 */</span>
	<span class="n">find_smp_config</span><span class="p">();</span>

	<span class="n">reserve_ibft_region</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need to conclude brk, before memblock_x86_fill()</span>
<span class="cm">	 *  it could use memblock_find_in_range, could overlap with</span>
<span class="cm">	 *  brk area.</span>
<span class="cm">	 */</span>
	<span class="n">reserve_brk</span><span class="p">();</span>

	<span class="n">cleanup_highmap</span><span class="p">();</span>

	<span class="n">memblock</span><span class="p">.</span><span class="n">current_limit</span> <span class="o">=</span> <span class="n">get_max_mapped</span><span class="p">();</span>
	<span class="n">memblock_x86_fill</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * The EFI specification says that boot service code won&#39;t be called</span>
<span class="cm">	 * after ExitBootServices(). This is, in fact, a lie.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">efi_enabled</span><span class="p">)</span>
		<span class="n">efi_reserve_boot_services</span><span class="p">();</span>

	<span class="cm">/* preallocate 4k for mptable mpc */</span>
	<span class="n">early_reserve_e820_mpc_new</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_X86_CHECK_BIOS_CORRUPTION</span>
	<span class="n">setup_bios_corruption_check</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;initial memory mapped: [mem 0x00000000-%#010lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">max_pfn_mapped</span><span class="o">&lt;&lt;</span><span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">setup_real_mode</span><span class="p">();</span>

	<span class="n">init_gbpages</span><span class="p">();</span>

	<span class="cm">/* max_pfn_mapped is updated here */</span>
	<span class="n">max_low_pfn_mapped</span> <span class="o">=</span> <span class="n">init_memory_mapping</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_low_pfn</span><span class="o">&lt;&lt;</span><span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="n">max_pfn_mapped</span> <span class="o">=</span> <span class="n">max_low_pfn_mapped</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_pfn</span> <span class="o">&gt;</span> <span class="n">max_low_pfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_pfn_mapped</span> <span class="o">=</span> <span class="n">init_memory_mapping</span><span class="p">(</span><span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">,</span>
						     <span class="n">max_pfn</span><span class="o">&lt;&lt;</span><span class="n">PAGE_SHIFT</span><span class="p">);</span>
		<span class="cm">/* can we preseve max_low_pfn ?*/</span>
		<span class="n">max_low_pfn</span> <span class="o">=</span> <span class="n">max_pfn</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">memblock</span><span class="p">.</span><span class="n">current_limit</span> <span class="o">=</span> <span class="n">get_max_mapped</span><span class="p">();</span>
	<span class="n">dma_contiguous_reserve</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: On x86-32, only from this point on, fixmaps are ready for use.</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_PROVIDE_OHCI1394_DMA_INIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_ohci1394_dma_early</span><span class="p">)</span>
		<span class="n">init_ohci1394_dma_on_all_controllers</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="cm">/* Allocate bigger log buffer */</span>
	<span class="n">setup_log_buf</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">reserve_initrd</span><span class="p">();</span>

	<span class="n">reserve_crashkernel</span><span class="p">();</span>

	<span class="n">vsmp_init</span><span class="p">();</span>

	<span class="n">io_delay_init</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Parse the ACPI tables for possible boot-time SMP configuration.</span>
<span class="cm">	 */</span>
	<span class="n">acpi_boot_table_init</span><span class="p">();</span>

	<span class="n">early_acpi_boot_init</span><span class="p">();</span>

	<span class="n">initmem_init</span><span class="p">();</span>
	<span class="n">memblock_find_dma_reserve</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_KVM_CLOCK</span>
	<span class="n">kvmclock_init</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">paging</span><span class="p">.</span><span class="n">pagetable_setup_start</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">);</span>
	<span class="n">paging_init</span><span class="p">();</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">paging</span><span class="p">.</span><span class="n">pagetable_setup_done</span><span class="p">(</span><span class="n">swapper_pg_dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpuid_level</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* A CPU has %cr4 if and only if it has CPUID */</span>
		<span class="n">mmu_cr4_features</span> <span class="o">=</span> <span class="n">read_cr4</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trampoline_cr4_features</span><span class="p">)</span>
			<span class="o">*</span><span class="n">trampoline_cr4_features</span> <span class="o">=</span> <span class="n">mmu_cr4_features</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="cm">/* sync back kernel address range */</span>
	<span class="n">clone_pgd_range</span><span class="p">(</span><span class="n">initial_page_table</span> <span class="o">+</span> <span class="n">KERNEL_PGD_BOUNDARY</span><span class="p">,</span>
			<span class="n">swapper_pg_dir</span>     <span class="o">+</span> <span class="n">KERNEL_PGD_BOUNDARY</span><span class="p">,</span>
			<span class="n">KERNEL_PGD_PTRS</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">tboot_probe</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">map_vsyscall</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">generic_apic_probe</span><span class="p">();</span>

	<span class="n">early_quirks</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read APIC and some other early information from ACPI tables.</span>
<span class="cm">	 */</span>
	<span class="n">acpi_boot_init</span><span class="p">();</span>
	<span class="n">sfi_init</span><span class="p">();</span>
	<span class="n">x86_dtb_init</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * get boot-time SMP configuration:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smp_found_config</span><span class="p">)</span>
		<span class="n">get_smp_config</span><span class="p">();</span>

	<span class="n">prefill_possible_map</span><span class="p">();</span>

	<span class="n">init_cpu_to_node</span><span class="p">();</span>

	<span class="n">init_apic_mappings</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x86_io_apic_ops</span><span class="p">.</span><span class="n">init</span><span class="p">)</span>
		<span class="n">x86_io_apic_ops</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

	<span class="n">kvm_guest_init</span><span class="p">();</span>

	<span class="n">e820_reserve_resources</span><span class="p">();</span>
	<span class="n">e820_mark_nosave_regions</span><span class="p">(</span><span class="n">max_low_pfn</span><span class="p">);</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">reserve_resources</span><span class="p">();</span>

	<span class="n">e820_setup_gap</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_VT</span>
<span class="cp">#if defined(CONFIG_VGA_CONSOLE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">efi_enabled</span> <span class="o">||</span> <span class="p">(</span><span class="n">efi_mem_type</span><span class="p">(</span><span class="mh">0xa0000</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EFI_CONVENTIONAL_MEMORY</span><span class="p">))</span>
		<span class="n">conswitchp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vga_con</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_DUMMY_CONSOLE)</span>
	<span class="n">conswitchp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_con</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">oem</span><span class="p">.</span><span class="n">banner</span><span class="p">();</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">timers</span><span class="p">.</span><span class="n">wallclock_init</span><span class="p">();</span>

	<span class="n">x86_platform</span><span class="p">.</span><span class="n">wallclock_init</span><span class="p">();</span>

	<span class="n">mcheck_init</span><span class="p">();</span>

	<span class="n">arch_init_ideal_nops</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_32</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">video_ram_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Video RAM area&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xa0000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xbffff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">i386_reserve_resources</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_ram_resource</span><span class="p">);</span>
	<span class="n">reserve_standard_io_resources</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_32 */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
