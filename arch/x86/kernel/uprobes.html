<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › uprobes.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>uprobes.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * User-space Probes (UProbes) for x86</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) IBM Corporation, 2008-2011</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Srikar Dronamraju</span>
<span class="cm"> *	Jim Keniston</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/uprobes.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/kdebug.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/insn.h&gt;</span>

<span class="cm">/* Post-execution fixups. */</span>

<span class="cm">/* No fixup needed */</span>
<span class="cp">#define UPROBE_FIX_NONE		0x0</span>

<span class="cm">/* Adjust IP back to vicinity of actual insn */</span>
<span class="cp">#define UPROBE_FIX_IP		0x1</span>

<span class="cm">/* Adjust the return address of a call insn */</span>
<span class="cp">#define UPROBE_FIX_CALL	0x2</span>

<span class="cp">#define UPROBE_FIX_RIP_AX	0x8000</span>
<span class="cp">#define UPROBE_FIX_RIP_CX	0x4000</span>

<span class="cp">#define	UPROBE_TRAP_NR		UINT_MAX</span>

<span class="cm">/* Adaptations for mhiramat x86 decoder v14. */</span>
<span class="cp">#define OPCODE1(insn)		((insn)-&gt;opcode.bytes[0])</span>
<span class="cp">#define OPCODE2(insn)		((insn)-&gt;opcode.bytes[1])</span>
<span class="cp">#define OPCODE3(insn)		((insn)-&gt;opcode.bytes[2])</span>
<span class="cp">#define MODRM_REG(insn)		X86_MODRM_REG(insn-&gt;modrm.value)</span>

<span class="cp">#define W(row, b0, b1, b2, b3, b4, b5, b6, b7, b8, b9, ba, bb, bc, bd, be, bf)\</span>
<span class="cp">	(((b0##UL &lt;&lt; 0x0)|(b1##UL &lt;&lt; 0x1)|(b2##UL &lt;&lt; 0x2)|(b3##UL &lt;&lt; 0x3) |   \</span>
<span class="cp">	  (b4##UL &lt;&lt; 0x4)|(b5##UL &lt;&lt; 0x5)|(b6##UL &lt;&lt; 0x6)|(b7##UL &lt;&lt; 0x7) |   \</span>
<span class="cp">	  (b8##UL &lt;&lt; 0x8)|(b9##UL &lt;&lt; 0x9)|(ba##UL &lt;&lt; 0xa)|(bb##UL &lt;&lt; 0xb) |   \</span>
<span class="cp">	  (bc##UL &lt;&lt; 0xc)|(bd##UL &lt;&lt; 0xd)|(be##UL &lt;&lt; 0xe)|(bf##UL &lt;&lt; 0xf))    \</span>
<span class="cp">	 &lt;&lt; (row % 32))</span>

<span class="cm">/*</span>
<span class="cm"> * Good-instruction tables for 32-bit apps.  This is non-const and volatile</span>
<span class="cm"> * to keep gcc from statically optimizing it out, as variable_test_bit makes</span>
<span class="cm"> * some versions of gcc to think only *(unsigned long*) is used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="n">u32</span> <span class="n">good_insns_32</span><span class="p">[</span><span class="mi">256</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*      0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f         */</span>
	<span class="cm">/*      ----------------------------------------------         */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 00 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 10 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 20 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 30 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 40 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 50 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 60 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 70 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 80 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 90 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* a0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* b0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* c0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* d0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* e0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="cm">/* f0 */</span>
	<span class="cm">/*      ----------------------------------------------         */</span>
	<span class="cm">/*      0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f         */</span>
<span class="p">};</span>

<span class="cm">/* Using this for both 64-bit and 32-bit apps */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="n">u32</span> <span class="n">good_2byte_insns</span><span class="p">[</span><span class="mi">256</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*      0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f         */</span>
	<span class="cm">/*      ----------------------------------------------         */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 00 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 10 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 20 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 30 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 40 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 50 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 60 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 70 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 80 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 90 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* a0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* b0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* c0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* d0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* e0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* f0 */</span>
	<span class="cm">/*      ----------------------------------------------         */</span>
	<span class="cm">/*      0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f         */</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="cm">/* Good-instruction tables for 64-bit apps */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="n">u32</span> <span class="n">good_insns_64</span><span class="p">[</span><span class="mi">256</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*      0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f         */</span>
	<span class="cm">/*      ----------------------------------------------         */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 00 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 10 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 20 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 30 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 40 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 50 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 60 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 70 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 80 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* 90 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* a0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* b0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* c0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="cm">/* d0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* e0 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="cm">/* f0 */</span>
	<span class="cm">/*      ----------------------------------------------         */</span>
	<span class="cm">/*      0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f         */</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="cp">#undef W</span>

<span class="cm">/*</span>
<span class="cm"> * opcodes we&#39;ll probably never support:</span>
<span class="cm"> *</span>
<span class="cm"> *  6c-6d, e4-e5, ec-ed - in</span>
<span class="cm"> *  6e-6f, e6-e7, ee-ef - out</span>
<span class="cm"> *  cc, cd - int3, int</span>
<span class="cm"> *  cf - iret</span>
<span class="cm"> *  d6 - illegal instruction</span>
<span class="cm"> *  f1 - int1/icebp</span>
<span class="cm"> *  f4 - hlt</span>
<span class="cm"> *  fa, fb - cli, sti</span>
<span class="cm"> *  0f - lar, lsl, syscall, clts, sysret, sysenter, sysexit, invd, wbinvd, ud2</span>
<span class="cm"> *</span>
<span class="cm"> * invalid opcodes in 64-bit mode:</span>
<span class="cm"> *</span>
<span class="cm"> *  06, 0e, 16, 1e, 27, 2f, 37, 3f, 60-62, 82, c4-c5, d4-d5</span>
<span class="cm"> *  63 - we support this opcode in x86_64 but not in i386.</span>
<span class="cm"> *</span>
<span class="cm"> * opcodes we may need to refine support for:</span>
<span class="cm"> *</span>
<span class="cm"> *  0f - 2-byte instructions: For many of these instructions, the validity</span>
<span class="cm"> *  depends on the prefix and/or the reg field.  On such instructions, we</span>
<span class="cm"> *  just consider the opcode combination valid if it corresponds to any</span>
<span class="cm"> *  valid instruction.</span>
<span class="cm"> *</span>
<span class="cm"> *  8f - Group 1 - only reg = 0 is OK</span>
<span class="cm"> *  c6-c7 - Group 11 - only reg = 0 is OK</span>
<span class="cm"> *  d9-df - fpu insns with some illegal encodings</span>
<span class="cm"> *  f2, f3 - repnz, repz prefixes.  These are also the first byte for</span>
<span class="cm"> *  certain floating-point instructions, such as addsd.</span>
<span class="cm"> *</span>
<span class="cm"> *  fe - Group 4 - only reg = 0 or 1 is OK</span>
<span class="cm"> *  ff - Group 5 - only reg = 0-6 is OK</span>
<span class="cm"> *</span>
<span class="cm"> * others -- Do we need to support these?</span>
<span class="cm"> *</span>
<span class="cm"> *  0f - (floating-point?) prefetch instructions</span>
<span class="cm"> *  07, 17, 1f - pop es, pop ss, pop ds</span>
<span class="cm"> *  26, 2e, 36, 3e - es:, cs:, ss:, ds: segment prefixes --</span>
<span class="cm"> *	but 64 and 65 (fs: and gs:) seem to be used, so we support them</span>
<span class="cm"> *  67 - addr16 prefix</span>
<span class="cm"> *  ce - into</span>
<span class="cm"> *  f0 - lock prefix</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * - Where necessary, examine the modrm byte and allow only valid instructions</span>
<span class="cm"> * in the different Groups and fpu instructions.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_prefix_bad</span><span class="p">(</span><span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">prefixes</span><span class="p">.</span><span class="n">nbytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">prefixes</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x26</span>:	<span class="cm">/* INAT_PFX_ES   */</span>
		<span class="k">case</span> <span class="mh">0x2E</span>:	<span class="cm">/* INAT_PFX_CS   */</span>
		<span class="k">case</span> <span class="mh">0x36</span>:	<span class="cm">/* INAT_PFX_DS   */</span>
		<span class="k">case</span> <span class="mh">0x3E</span>:	<span class="cm">/* INAT_PFX_SS   */</span>
		<span class="k">case</span> <span class="mh">0xF0</span>:	<span class="cm">/* INAT_PFX_LOCK */</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_insn_32bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">insn_init</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Skip good instruction prefixes; reject &quot;bad&quot; ones. */</span>
	<span class="n">insn_get_opcode</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_prefix_bad</span><span class="p">(</span><span class="n">insn</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">OPCODE1</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">good_insns_32</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">.</span><span class="n">nbytes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">OPCODE2</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">good_2byte_insns</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Figure out which fixups arch_uprobe_post_xol() will need to perform, and</span>
<span class="cm"> * annotate arch_uprobe-&gt;fixups accordingly.  To start with,</span>
<span class="cm"> * arch_uprobe-&gt;fixups is either zero or it reflects rip-related fixups.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_fixups</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">fix_ip</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span> <span class="n">fix_call</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* defaults */</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">insn_get_opcode</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>	<span class="cm">/* should be a nop */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">OPCODE1</span><span class="p">(</span><span class="n">insn</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0xc3</span>:		<span class="cm">/* ret/lret */</span>
	<span class="k">case</span> <span class="mh">0xcb</span>:
	<span class="k">case</span> <span class="mh">0xc2</span>:
	<span class="k">case</span> <span class="mh">0xca</span>:
		<span class="cm">/* ip is correct */</span>
		<span class="n">fix_ip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xe8</span>:		<span class="cm">/* call relative - Fix return addr */</span>
		<span class="n">fix_call</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x9a</span>:		<span class="cm">/* call absolute - Fix return addr, not ip */</span>
		<span class="n">fix_call</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">fix_ip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xff</span>:
		<span class="n">insn_get_modrm</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">MODRM_REG</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* call or lcall, indirect */</span>
			<span class="cm">/* Fix return addr; ip is correct. */</span>
			<span class="n">fix_call</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">fix_ip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* jmp or ljmp, indirect */</span>
			<span class="cm">/* ip is correct. */</span>
			<span class="n">fix_ip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xea</span>:		<span class="cm">/* jmp absolute -- ip is correct */</span>
		<span class="n">fix_ip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fix_ip</span><span class="p">)</span>
		<span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">|=</span> <span class="n">UPROBE_FIX_IP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fix_call</span><span class="p">)</span>
		<span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">|=</span> <span class="n">UPROBE_FIX_CALL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="cm">/*</span>
<span class="cm"> * If arch_uprobe-&gt;insn doesn&#39;t use rip-relative addressing, return</span>
<span class="cm"> * immediately.  Otherwise, rewrite the instruction so that it accesses</span>
<span class="cm"> * its memory operand indirectly through a scratch register.  Set</span>
<span class="cm"> * arch_uprobe-&gt;fixups and arch_uprobe-&gt;rip_rela_target_address</span>
<span class="cm"> * accordingly.  (The contents of the scratch register will be saved</span>
<span class="cm"> * before we single-step the modified instruction, and restored</span>
<span class="cm"> * afterward.)</span>
<span class="cm"> *</span>
<span class="cm"> * We do this because a rip-relative instruction can access only a</span>
<span class="cm"> * relatively small area (+/- 2 GB from the instruction), and the XOL</span>
<span class="cm"> * area typically lies beyond that area.  At least for instructions</span>
<span class="cm"> * that store to memory, we can&#39;t execute the original instruction</span>
<span class="cm"> * and &quot;fix things up&quot; later, because the misdirected store could be</span>
<span class="cm"> * disastrous.</span>
<span class="cm"> *</span>
<span class="cm"> * Some useful facts about rip-relative instructions:</span>
<span class="cm"> *</span>
<span class="cm"> *  - There&#39;s always a modrm byte.</span>
<span class="cm"> *  - There&#39;s never a SIB byte.</span>
<span class="cm"> *  - The displacement is always 4 bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_riprel_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cursor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">ia32_compat</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">rip_rela_target_address</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">insn_rip_relative</span><span class="p">(</span><span class="n">insn</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * insn_rip_relative() would have decoded rex_prefix, modrm.</span>
<span class="cm">	 * Clear REX.b bit (extension of MODRM.rm field):</span>
<span class="cm">	 * we want to encode rax/rcx, not r8/r9.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">rex_prefix</span><span class="p">.</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span> <span class="o">+</span> <span class="n">insn_offset_rex_prefix</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cursor</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>	<span class="cm">/* Clearing REX.B bit */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Point cursor at the modrm byte.  The next 4 bytes are the</span>
<span class="cm">	 * displacement.  Beyond the displacement, for some instructions,</span>
<span class="cm">	 * is the immediate operand.</span>
<span class="cm">	 */</span>
	<span class="n">cursor</span> <span class="o">=</span> <span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span> <span class="o">+</span> <span class="n">insn_offset_modrm</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="n">insn_get_length</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert from rip-relative addressing to indirect addressing</span>
<span class="cm">	 * via a scratch register.  Change the r/m field from 0x5 (%rip)</span>
<span class="cm">	 * to 0x0 (%rax) or 0x1 (%rcx), and squeeze out the offset field.</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">MODRM_REG</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The register operand (if any) is either the A register</span>
<span class="cm">		 * (%rax, %eax, etc.) or (if the 0x4 bit is set in the</span>
<span class="cm">		 * REX prefix) %r8.  In any case, we know the C register</span>
<span class="cm">		 * is NOT the register operand, so we use %rcx (register</span>
<span class="cm">		 * #1) for the scratch register.</span>
<span class="cm">		 */</span>
		<span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">=</span> <span class="n">UPROBE_FIX_RIP_CX</span><span class="p">;</span>
		<span class="cm">/* Change modrm from 00 000 101 to 00 000 001. */</span>
		<span class="o">*</span><span class="n">cursor</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Use %rax (register #0) for the scratch register. */</span>
		<span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">=</span> <span class="n">UPROBE_FIX_RIP_AX</span><span class="p">;</span>
		<span class="cm">/* Change modrm from 00 xxx 101 to 00 xxx 000 */</span>
		<span class="o">*</span><span class="n">cursor</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Target address = address of next instruction + (signed) offset */</span>
	<span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">rip_rela_target_address</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">displacement</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="cm">/* Displacement field is gone; slide immediate field (if any) over. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">.</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cursor</span><span class="o">++</span><span class="p">;</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">cursor</span> <span class="o">+</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">displacement</span><span class="p">.</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">insn</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">.</span><span class="n">nbytes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_insn_64bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">insn_init</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Skip good instruction prefixes; reject &quot;bad&quot; ones. */</span>
	<span class="n">insn_get_opcode</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_prefix_bad</span><span class="p">(</span><span class="n">insn</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">OPCODE1</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">good_insns_64</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">.</span><span class="n">nbytes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">OPCODE2</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">good_2byte_insns</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">ia32_compat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">validate_insn_32bits</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">validate_insn_64bits</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* 32-bit: */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_riprel_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No RIP-relative addressing on 32-bit */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_insn_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">validate_insn_32bits</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_64 */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * arch_uprobe_analyze_insn - instruction analysis including validity and fixups.</span>
<span class="cm"> * @mm: the probed address space.</span>
<span class="cm"> * @arch_uprobe: the probepoint information.</span>
<span class="cm"> * Return 0 on success or a -ve number on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">arch_uprobe_analyze_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">insn</span> <span class="n">insn</span><span class="p">;</span>

	<span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">validate_insn_bits</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">handle_riprel_insn</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="p">);</span>
	<span class="n">prepare_fixups</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="cm">/*</span>
<span class="cm"> * If we&#39;re emulating a rip-relative instruction, save the contents</span>
<span class="cm"> * of the scratch register and store the target address in that register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pre_xol_rip_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">arch_uprobe_task</span> <span class="o">*</span><span class="n">autask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">&amp;</span> <span class="n">UPROBE_FIX_RIP_AX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">autask</span><span class="o">-&gt;</span><span class="n">saved_scratch_register</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ax</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ax</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">utask</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ax</span> <span class="o">+=</span> <span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">rip_rela_target_address</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">&amp;</span> <span class="n">UPROBE_FIX_RIP_CX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">autask</span><span class="o">-&gt;</span><span class="n">saved_scratch_register</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">utask</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+=</span> <span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">rip_rela_target_address</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pre_xol_rip_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">arch_uprobe_task</span> <span class="o">*</span><span class="n">autask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No RIP-relative addressing on 32-bit */</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * arch_uprobe_pre_xol - prepare to execute out of line.</span>
<span class="cm"> * @auprobe: the probepoint information.</span>
<span class="cm"> * @regs: reflects the saved user state of current task.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">arch_uprobe_pre_xol</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arch_uprobe_task</span> <span class="o">*</span><span class="n">autask</span><span class="p">;</span>

	<span class="n">autask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">utask</span><span class="o">-&gt;</span><span class="n">autask</span><span class="p">;</span>
	<span class="n">autask</span><span class="o">-&gt;</span><span class="n">saved_trap_nr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">trap_nr</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">trap_nr</span> <span class="o">=</span> <span class="n">UPROBE_TRAP_NR</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">utask</span><span class="o">-&gt;</span><span class="n">xol_vaddr</span><span class="p">;</span>
	<span class="n">pre_xol_rip_insn</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">autask</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called by arch_uprobe_post_xol() to adjust the return</span>
<span class="cm"> * address pushed by a call instruction executed out of line.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adjust_ret_addr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">,</span> <span class="kt">long</span> <span class="n">correction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rasize</span><span class="p">,</span> <span class="n">ncopied</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ia32_task</span><span class="p">())</span>
		<span class="n">rasize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rasize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ncopied</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ra</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="p">,</span> <span class="n">rasize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ncopied</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ra</span> <span class="o">+=</span> <span class="n">correction</span><span class="p">;</span>
	<span class="n">ncopied</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ra</span><span class="p">,</span> <span class="n">rasize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ncopied</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_riprel_insn</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UPROBE_FIX_RIP_AX</span> <span class="o">|</span> <span class="n">UPROBE_FIX_RIP_CX</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_riprel_post_xol</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">correction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_riprel_insn</span><span class="p">(</span><span class="n">auprobe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">arch_uprobe_task</span> <span class="o">*</span><span class="n">autask</span><span class="p">;</span>

		<span class="n">autask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">utask</span><span class="o">-&gt;</span><span class="n">autask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">&amp;</span> <span class="n">UPROBE_FIX_RIP_AX</span><span class="p">)</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ax</span> <span class="o">=</span> <span class="n">autask</span><span class="o">-&gt;</span><span class="n">saved_scratch_register</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="n">autask</span><span class="o">-&gt;</span><span class="n">saved_scratch_register</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The original instruction includes a displacement, and so</span>
<span class="cm">		 * is 4 bytes longer than what we&#39;ve just single-stepped.</span>
<span class="cm">		 * Fall through to handle stuff like &quot;jmpq *...(%rip)&quot; and</span>
<span class="cm">		 * &quot;callq *...(%rip)&quot;.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">correction</span><span class="p">)</span>
			<span class="o">*</span><span class="n">correction</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_riprel_post_xol</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">correction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No RIP-relative addressing on 32-bit */</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * If xol insn itself traps and generates a signal(Say,</span>
<span class="cm"> * SIGILL/SIGSEGV/etc), then detect the case where a singlestepped</span>
<span class="cm"> * instruction jumps back to its own address. It is assumed that anything</span>
<span class="cm"> * like do_page_fault/do_trap/etc sets thread.trap_nr != -1.</span>
<span class="cm"> *</span>
<span class="cm"> * arch_uprobe_pre_xol/arch_uprobe_post_xol save/restore thread.trap_nr,</span>
<span class="cm"> * arch_uprobe_xol_was_trapped() simply checks that -&gt;trap_nr is not equal to</span>
<span class="cm"> * UPROBE_TRAP_NR == -1 set by arch_uprobe_pre_xol().</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">arch_uprobe_xol_was_trapped</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">trap_nr</span> <span class="o">!=</span> <span class="n">UPROBE_TRAP_NR</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called after single-stepping. To avoid the SMP problems that can</span>
<span class="cm"> * occur when we temporarily put back the original opcode to</span>
<span class="cm"> * single-step, we single-stepped a copy of the instruction.</span>
<span class="cm"> *</span>
<span class="cm"> * This function prepares to resume execution after the single-step.</span>
<span class="cm"> * We have to fix things up as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * Typically, the new ip is relative to the copied instruction.  We need</span>
<span class="cm"> * to make it relative to the original instruction (FIX_IP).  Exceptions</span>
<span class="cm"> * are return instructions and absolute or indirect jump or call instructions.</span>
<span class="cm"> *</span>
<span class="cm"> * If the single-stepped instruction was a call, the return address that</span>
<span class="cm"> * is atop the stack is the address following the copied instruction.  We</span>
<span class="cm"> * need to make it the address following the original instruction (FIX_CALL).</span>
<span class="cm"> *</span>
<span class="cm"> * If the original instruction was a rip-relative instruction such as</span>
<span class="cm"> * &quot;movl %edx,0xnnnn(%rip)&quot;, we have instead executed an equivalent</span>
<span class="cm"> * instruction using a scratch register -- e.g., &quot;movl %edx,(%rax)&quot;.</span>
<span class="cm"> * We need to restore the contents of the scratch register and adjust</span>
<span class="cm"> * the ip, keeping in mind that the instruction we executed is 4 bytes</span>
<span class="cm"> * shorter than the original instruction (since we squeezed out the offset</span>
<span class="cm"> * field).  (FIX_RIP_AX or FIX_RIP_CX)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">arch_uprobe_post_xol</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uprobe_task</span> <span class="o">*</span><span class="n">utask</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">correction</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">trap_nr</span> <span class="o">!=</span> <span class="n">UPROBE_TRAP_NR</span><span class="p">);</span>

	<span class="n">utask</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">utask</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">trap_nr</span> <span class="o">=</span> <span class="n">utask</span><span class="o">-&gt;</span><span class="n">autask</span><span class="p">.</span><span class="n">saved_trap_nr</span><span class="p">;</span>
	<span class="n">correction</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">utask</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">-</span> <span class="n">utask</span><span class="o">-&gt;</span><span class="n">xol_vaddr</span><span class="p">);</span>
	<span class="n">handle_riprel_post_xol</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">correction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">&amp;</span> <span class="n">UPROBE_FIX_IP</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">+=</span> <span class="n">correction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">&amp;</span> <span class="n">UPROBE_FIX_CALL</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">adjust_ret_addr</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">,</span> <span class="n">correction</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* callback routine for handling exceptions. */</span>
<span class="kt">int</span> <span class="nf">arch_uprobe_exception_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">die_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="cm">/* We are only interested in userspace traps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user_mode_vm</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DIE_INT3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uprobe_pre_sstep_notifier</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_STOP</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIE_DEBUG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uprobe_post_sstep_notifier</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_STOP</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function gets called when XOL instruction either gets trapped or</span>
<span class="cm"> * the thread has a fatal signal, so reset the instruction pointer to its</span>
<span class="cm"> * probed address.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">arch_uprobe_abort_xol</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uprobe_task</span> <span class="o">*</span><span class="n">utask</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">utask</span><span class="p">;</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">trap_nr</span> <span class="o">=</span> <span class="n">utask</span><span class="o">-&gt;</span><span class="n">autask</span><span class="p">.</span><span class="n">saved_trap_nr</span><span class="p">;</span>
	<span class="n">handle_riprel_post_xol</span><span class="p">(</span><span class="n">auprobe</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">instruction_pointer_set</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">utask</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Skip these instructions as per the currently known x86 ISA.</span>
<span class="cm"> * 0x66* { 0x90 | 0x0f 0x1f | 0x0f 0x19 | 0x87 0xc0 }</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">arch_uprobe_skip_sstep</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_uprobe</span> <span class="o">*</span><span class="n">auprobe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_UINSN_BYTES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x66</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x90</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAX_UINSN_BYTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1f</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x19</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x87</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">auprobe</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xc0</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
