<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › head.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>head.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>

<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/bios_ebda.h&gt;</span>

<span class="cp">#define BIOS_LOWMEM_KILOBYTES 0x413</span>

<span class="cm">/*</span>
<span class="cm"> * The BIOS places the EBDA/XBDA at the top of conventional</span>
<span class="cm"> * memory, and usually decreases the reported amount of</span>
<span class="cm"> * conventional memory (int 0x12) too. This also contains a</span>
<span class="cm"> * workaround for Dell systems that neglect to reserve EBDA.</span>
<span class="cm"> * The same workaround also avoids a problem with the AMD768MPX</span>
<span class="cm"> * chipset: reserve a page before VGA to prevent PCI prefetch</span>
<span class="cm"> * into it (errata #56). Usually the page is reserved anyways,</span>
<span class="cm"> * unless you have no PS/2 mouse plugged in.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_ebda_region</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lowmem</span><span class="p">,</span> <span class="n">ebda_addr</span><span class="p">;</span>

	<span class="cm">/* To determine the position of the EBDA and the */</span>
	<span class="cm">/* end of conventional memory, we need to look at */</span>
	<span class="cm">/* the BIOS data area. In a paravirtual environment */</span>
	<span class="cm">/* that area is absent. We&#39;ll just have to assume */</span>
	<span class="cm">/* that the paravirt case can handle memory setup */</span>
	<span class="cm">/* correctly, without our help. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paravirt_enabled</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* end of low (conventional) memory */</span>
	<span class="n">lowmem</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">BIOS_LOWMEM_KILOBYTES</span><span class="p">);</span>
	<span class="n">lowmem</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* start of EBDA area */</span>
	<span class="n">ebda_addr</span> <span class="o">=</span> <span class="n">get_bios_ebda</span><span class="p">();</span>

	<span class="cm">/* Fixup: bios puts an EBDA in the top 64K segment */</span>
	<span class="cm">/* of conventional memory, but does not adjust lowmem. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lowmem</span> <span class="o">-</span> <span class="n">ebda_addr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="n">lowmem</span> <span class="o">=</span> <span class="n">ebda_addr</span><span class="p">;</span>

	<span class="cm">/* Fixup: bios does not report an EBDA at all. */</span>
	<span class="cm">/* Some old Dells seem to need 4k anyhow (bugzilla 2990) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ebda_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lowmem</span> <span class="o">&gt;=</span> <span class="mh">0x9f000</span><span class="p">))</span>
		<span class="n">lowmem</span> <span class="o">=</span> <span class="mh">0x9f000</span><span class="p">;</span>

	<span class="cm">/* Paranoia: should never happen, but... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lowmem</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lowmem</span> <span class="o">&gt;=</span> <span class="mh">0x100000</span><span class="p">))</span>
		<span class="n">lowmem</span> <span class="o">=</span> <span class="mh">0x9f000</span><span class="p">;</span>

	<span class="cm">/* reserve all memory between lowmem and the 1MB mark */</span>
	<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">lowmem</span><span class="p">,</span> <span class="mh">0x100000</span> <span class="o">-</span> <span class="n">lowmem</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
