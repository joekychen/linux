<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › kernel › reboot.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>reboot.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/efi.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/tboot.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;acpi/reboot.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/apic.h&gt;</span>
<span class="cp">#include &lt;asm/desc.h&gt;</span>
<span class="cp">#include &lt;asm/hpet.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/proto.h&gt;</span>
<span class="cp">#include &lt;asm/reboot_fixups.h&gt;</span>
<span class="cp">#include &lt;asm/reboot.h&gt;</span>
<span class="cp">#include &lt;asm/pci_x86.h&gt;</span>
<span class="cp">#include &lt;asm/virtext.h&gt;</span>
<span class="cp">#include &lt;asm/cpu.h&gt;</span>
<span class="cp">#include &lt;asm/nmi.h&gt;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cp"># include &lt;linux/ctype.h&gt;</span>
<span class="cp"># include &lt;linux/mc146818rtc.h&gt;</span>
<span class="cp"># include &lt;asm/realmode.h&gt;</span>
<span class="cp">#else</span>
<span class="cp"># include &lt;asm/x86_init.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Power off function, if any</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pm_power_off</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pm_power_off</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="n">no_idt</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reboot_mode</span><span class="p">;</span>
<span class="k">enum</span> <span class="n">reboot_type</span> <span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_ACPI</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">reboot_force</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This variable is used privately to keep track of whether or not</span>
<span class="cm"> * reboot_type is still set to its default value (i.e., reboot= hasn&#39;t</span>
<span class="cm"> * been set on the command line).  This is needed so that we can</span>
<span class="cm"> * suppress DMI scanning for reboot quirks.  Without it, it&#39;s</span>
<span class="cm"> * impossible to override a faulty reboot quirk without recompiling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reboot_default</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_X86_32) &amp;&amp; defined(CONFIG_SMP)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reboot_cpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * This is set if we need to go through the &#39;emergency&#39; path.</span>
<span class="cm"> * When machine_emergency_restart() is called, we may be on</span>
<span class="cm"> * an inconsistent state and won&#39;t be able to do a clean cleanup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reboot_emergency</span><span class="p">;</span>

<span class="cm">/* This is set by the PCI code if either type 1 or type 2 PCI is detected */</span>
<span class="n">bool</span> <span class="n">port_cf9_safe</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * reboot=b[ios] | s[mp] | t[riple] | k[bd] | e[fi] [, [w]arm | [c]old] | p[ci]</span>
<span class="cm"> * warm   Don&#39;t set the cold reboot flag</span>
<span class="cm"> * cold   Set the cold reboot flag</span>
<span class="cm"> * bios   Reboot by jumping through the BIOS (only for X86_32)</span>
<span class="cm"> * smp    Reboot by executing reset on BSP or other CPU (only for X86_32)</span>
<span class="cm"> * triple Force a triple fault (init)</span>
<span class="cm"> * kbd    Use the keyboard controller. cold reset (default)</span>
<span class="cm"> * acpi   Use the RESET_REG in the FADT</span>
<span class="cm"> * efi    Use efi reset_system runtime service</span>
<span class="cm"> * pci    Use the so-called &quot;PCI reset register&quot;, CF9</span>
<span class="cm"> * force  Avoid anything that could hang.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">reboot_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Having anything passed on the command line via</span>
<span class="cm">		 * reboot= will cause us to disable DMI checking</span>
<span class="cm">		 * below.</span>
<span class="cm">		 */</span>
		<span class="n">reboot_default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
			<span class="n">reboot_mode</span> <span class="o">=</span> <span class="mh">0x1234</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="n">reboot_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cp">#ifdef CONFIG_SMP</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">str</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">reboot_cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">str</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">str</span><span class="o">+</span><span class="mi">2</span><span class="p">)))</span>
					<span class="n">reboot_cpu</span> <span class="o">=</span> <span class="n">reboot_cpu</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">str</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * We will leave sorting out the final value</span>
<span class="cm">			 * when we are ready to reboot, since we might not</span>
<span class="cm">			 * have detected BSP APIC ID or smp_num_cpu</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="sc">&#39;a&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;t&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
			<span class="n">reboot_type</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
			<span class="n">reboot_force</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">str</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span>
			<span class="n">str</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;reboot=&quot;</span><span class="p">,</span> <span class="n">reboot_setup</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cm">/*</span>
<span class="cm"> * Reboot options and system auto-detection code provided by</span>
<span class="cm"> * Dell Inc. so their systems &quot;just work&quot;. :-)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Some machines require the &quot;reboot=b&quot; or &quot;reboot=k&quot;  commandline options,</span>
<span class="cm"> * this quirk makes that automatic.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">set_bios_reboot</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reboot_type</span> <span class="o">!=</span> <span class="n">BOOT_BIOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_BIOS</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s series board detected. Selecting BIOS-method for reboots.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_real_restart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">restart_lowmem</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span>
		<span class="n">real_mode_header</span><span class="o">-&gt;</span><span class="n">machine_real_restart_asm</span><span class="p">;</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write zero to CMOS register number 0x0f, which the BIOS POST</span>
<span class="cm">	 * routine will recognize as telling it to do a proper reboot.  (Well</span>
<span class="cm">	 * that&#39;s what this book in front of me says -- it may only apply to</span>
<span class="cm">	 * the Phoenix BIOS though, it&#39;s not clear).  At the same time,</span>
<span class="cm">	 * disable NMIs by setting the top bit in the CMOS address register,</span>
<span class="cm">	 * as we&#39;re about to do peculiar things to the CPU.  I&#39;m not sure if</span>
<span class="cm">	 * `outb_p&#39; is needed instead of just `outb&#39;.  Use it to be on the</span>
<span class="cm">	 * safe side.  (Yes, CMOS_WRITE does outb_p&#39;s. -  Paul G.)</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_lock</span><span class="p">);</span>
	<span class="n">CMOS_WRITE</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Switch back to the initial page table.</span>
<span class="cm">	 */</span>
	<span class="n">load_cr3</span><span class="p">(</span><span class="n">initial_page_table</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write 0x1234 to absolute memory location 0x472.  The BIOS reads</span>
<span class="cm">	 * this on booting to tell it to &quot;Bypass memory test (also warm</span>
<span class="cm">	 * boot)&quot;.  This seems like a fairly standard thing that gets set by</span>
<span class="cm">	 * REBOOT.COM programs, and the previous reset routine did this</span>
<span class="cm">	 * too. */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x472</span><span class="p">)</span> <span class="o">=</span> <span class="n">reboot_mode</span><span class="p">;</span>

	<span class="cm">/* Jump to the identity-mapped low memory code */</span>
	<span class="n">restart_lowmem</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#ifdef CONFIG_APM_MODULE</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">machine_real_restart</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_32 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Some Apple MacBook and MacBookPro&#39;s needs reboot=p to be able to reboot</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">set_pci_reboot</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reboot_type</span> <span class="o">!=</span> <span class="n">BOOT_CF9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_CF9</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s series board detected. &quot;</span>
		       <span class="s">&quot;Selecting PCI-method for reboots.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">set_kbd_reboot</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reboot_type</span> <span class="o">!=</span> <span class="n">BOOT_KBD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_KBD</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s series board detected. Selecting KBD-method for reboot.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a single dmi_table handling all reboot quirks.  Note that</span>
<span class="cm"> * REBOOT_BIOS is only available for 32bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">reboot_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell E520&#39;s */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell E520&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Dell DM061&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell 1300&#39;s */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell PowerEdge 1300&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Computer Corporation&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;PowerEdge 1300/&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell 300&#39;s */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell PowerEdge 300&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Computer Corporation&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;PowerEdge 300/&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell Optiplex 745&#39;s SFF */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell OptiPlex 745&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;OptiPlex 745&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell Optiplex 745&#39;s DFF */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell OptiPlex 745&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;OptiPlex 745&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;0MM599&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell Optiplex 745 with 0KW626 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell OptiPlex 745&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;OptiPlex 745&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;0KW626&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell Optiplex 330 with 0KP561 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell OptiPlex 330&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;OptiPlex 330&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;0KP561&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell Optiplex 360 with 0T656F */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell OptiPlex 360&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;OptiPlex 360&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;0T656F&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell OptiPlex 760 with 0G919G */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell OptiPlex 760&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;OptiPlex 760&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;0G919G&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell 2400&#39;s */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell PowerEdge 2400&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Computer Corporation&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;PowerEdge 2400&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell T5400&#39;s */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Precision T5400&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Precision WorkStation T5400&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell T7400&#39;s */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Precision T7400&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Precision WorkStation T7400&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on HP laptops */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP Compaq Laptop&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell XPS710 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell XPS710&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Dell XPS710&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Dell DXP061 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell DXP061&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Dell DXP061&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Sony VGN-Z540N */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Sony VGN-Z540N&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Sony Corporation&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;VGN-Z540N&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on CompuLab SBC-FITPC2 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;CompuLab SBC-FITPC2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;CompuLab&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;SBC-FITPC2&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on ASUS P4S800 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_bios_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;ASUS P4S800&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;ASUSTeK Computer INC.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;P4S800&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_32 */</span><span class="cp"></span>

	<span class="p">{</span>	<span class="cm">/* Handle reboot issue on Acer Aspire one */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_kbd_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire One A110&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;AOA110&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Apple MacBook5 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Apple MacBook5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MacBook5&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Apple MacBookPro5 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Apple MacBookPro5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MacBookPro5&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on Apple Macmini3,1 */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Apple Macmini3,1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Macmini3,1&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on the iMac9,1. */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Apple iMac9,1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;iMac9,1&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on the Latitude E6320. */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Latitude E6320&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Latitude E6320&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on the Latitude E5420. */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Latitude E5420&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Latitude E5420&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on the Latitude E6420. */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Latitude E6420&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Latitude E6420&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on the OptiPlex 990. */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell OptiPlex 990&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;OptiPlex 990&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Handle problems with rebooting on the Precision M6600. */</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">set_pci_reboot</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell OptiPlex 990&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Precision M6600&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">reboot_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Only do the DMI check if reboot_type hasn&#39;t been overridden</span>
<span class="cm">	 * on the command line</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reboot_default</span><span class="p">)</span>
		<span class="n">dmi_check_system</span><span class="p">(</span><span class="n">reboot_dmi_table</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">reboot_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kb_wait</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vmxoff_nmi</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpu_emergency_vmxoff</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Use NMIs as IPIs to tell all CPUs to disable virtualization */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emergency_vmx_disable_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Just make sure we won&#39;t change CPUs while doing this */</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to disable VMX on all CPUs before rebooting, otherwise</span>
<span class="cm">	 * we risk hanging up the machine, because the CPU ignore INIT</span>
<span class="cm">	 * signals when VMX is enabled.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We can&#39;t take any locks and we may be on an inconsistent</span>
<span class="cm">	 * state, so we use NMIs as IPIs to tell the other CPUs to disable</span>
<span class="cm">	 * VMX and halt.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For safety, we will avoid running the nmi_shootdown_cpus()</span>
<span class="cm">	 * stuff unnecessarily, but we don&#39;t have a way to check</span>
<span class="cm">	 * if other CPUs have VMX enabled. So we will call it only if the</span>
<span class="cm">	 * CPU we are running on has VMX enabled.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We will miss cases where VMX is not enabled on all CPUs. This</span>
<span class="cm">	 * shouldn&#39;t do much harm because KVM always enable VMX on all</span>
<span class="cm">	 * CPUs anyway. But we can miss it on the small window where KVM</span>
<span class="cm">	 * is still enabling VMX.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_vmx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_vmx_enabled</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* Disable VMX on this CPU. */</span>
		<span class="n">cpu_vmxoff</span><span class="p">();</span>

		<span class="cm">/* Halt and disable VMX on the other CPUs */</span>
		<span class="n">nmi_shootdown_cpus</span><span class="p">(</span><span class="n">vmxoff_nmi</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">weak</span><span class="p">))</span> <span class="n">mach_reboot_fixups</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Windows compatible x86 hardware expects the following on reboot:</span>
<span class="cm"> *</span>
<span class="cm"> * 1) If the FADT has the ACPI reboot register flag set, try it</span>
<span class="cm"> * 2) If still alive, write to the keyboard controller</span>
<span class="cm"> * 3) If still alive, write to the ACPI reboot register again</span>
<span class="cm"> * 4) If still alive, write to the keyboard controller again</span>
<span class="cm"> *</span>
<span class="cm"> * If the machine is still alive at this stage, it gives up. We default to</span>
<span class="cm"> * following the same pattern, except that if we&#39;re still alive after (4) we&#39;ll</span>
<span class="cm"> * try to force a triple fault and then cycle between hitting the keyboard</span>
<span class="cm"> * controller and doing that</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">native_machine_emergency_restart</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_reboot_type</span> <span class="o">=</span> <span class="n">reboot_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reboot_emergency</span><span class="p">)</span>
		<span class="n">emergency_vmx_disable_all</span><span class="p">();</span>

	<span class="n">tboot_shutdown</span><span class="p">(</span><span class="n">TB_SHUTDOWN_REBOOT</span><span class="p">);</span>

	<span class="cm">/* Tell the BIOS if we want cold or warm reboot */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="mh">0x472</span><span class="p">))</span> <span class="o">=</span> <span class="n">reboot_mode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* Could also try the reset bit in the Hammer NB */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reboot_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BOOT_KBD</span>:
			<span class="n">mach_reboot_fixups</span><span class="p">();</span> <span class="cm">/* For board specific fixups */</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kb_wait</span><span class="p">();</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">);</span> <span class="cm">/* Pulse reset low */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">orig_reboot_type</span> <span class="o">==</span> <span class="n">BOOT_ACPI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">attempt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_ACPI</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_TRIPLE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BOOT_TRIPLE</span>:
			<span class="n">load_idt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">no_idt</span><span class="p">);</span>
			<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;int3&quot;</span><span class="p">);</span>

			<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_KBD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
		<span class="k">case</span> <span class="n">BOOT_BIOS</span>:
			<span class="n">machine_real_restart</span><span class="p">(</span><span class="n">MRR_BIOS</span><span class="p">);</span>

			<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_KBD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">case</span> <span class="n">BOOT_ACPI</span>:
			<span class="n">acpi_reboot</span><span class="p">();</span>
			<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_KBD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BOOT_EFI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">efi_enabled</span><span class="p">)</span>
				<span class="n">efi</span><span class="p">.</span><span class="n">reset_system</span><span class="p">(</span><span class="n">reboot_mode</span> <span class="o">?</span>
						 <span class="n">EFI_RESET_WARM</span> <span class="o">:</span>
						 <span class="n">EFI_RESET_COLD</span><span class="p">,</span>
						 <span class="n">EFI_SUCCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_KBD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BOOT_CF9</span>:
			<span class="n">port_cf9_safe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Fall through */</span>

		<span class="k">case</span> <span class="n">BOOT_CF9_COND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">port_cf9_safe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">cf9</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xcf9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">6</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">cf9</span><span class="o">|</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0xcf9</span><span class="p">);</span> <span class="cm">/* Request hard reset */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">cf9</span><span class="o">|</span><span class="mi">6</span><span class="p">,</span> <span class="mh">0xcf9</span><span class="p">);</span> <span class="cm">/* Actually do the reset */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">reboot_type</span> <span class="o">=</span> <span class="n">BOOT_KBD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">native_machine_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Stop the cpus and apics */</span>
<span class="cp">#ifdef CONFIG_SMP</span>

	<span class="cm">/* The boot cpu is always logical cpu 0 */</span>
	<span class="kt">int</span> <span class="n">reboot_cpu_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="cm">/* See if there has been given a command line override */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reboot_cpu</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reboot_cpu</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">cpu_online</span><span class="p">(</span><span class="n">reboot_cpu</span><span class="p">))</span>
		<span class="n">reboot_cpu_id</span> <span class="o">=</span> <span class="n">reboot_cpu</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Make certain the cpu I&#39;m about to reboot on is online */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">reboot_cpu_id</span><span class="p">))</span>
		<span class="n">reboot_cpu_id</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>

	<span class="cm">/* Make certain I only run on the appropriate processor */</span>
	<span class="n">set_cpus_allowed_ptr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">reboot_cpu_id</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * O.K Now that I&#39;m on the appropriate processor, stop all of the</span>
<span class="cm">	 * others. Also disable the local irq to not receive the per-cpu</span>
<span class="cm">	 * timer interrupt which may trigger scheduler&#39;s load balance.</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">stop_other_cpus</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">lapic_shutdown</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
	<span class="n">disable_IO_APIC</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HPET_TIMER</span>
	<span class="n">hpet_disable</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">x86_platform</span><span class="p">.</span><span class="n">iommu_shutdown</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__machine_emergency_restart</span><span class="p">(</span><span class="kt">int</span> <span class="n">emergency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reboot_emergency</span> <span class="o">=</span> <span class="n">emergency</span><span class="p">;</span>
	<span class="n">machine_ops</span><span class="p">.</span><span class="n">emergency_restart</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">native_machine_restart</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;machine restart</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reboot_force</span><span class="p">)</span>
		<span class="n">machine_shutdown</span><span class="p">();</span>
	<span class="n">__machine_emergency_restart</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">native_machine_halt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Stop other cpus and apics */</span>
	<span class="n">machine_shutdown</span><span class="p">();</span>

	<span class="n">tboot_shutdown</span><span class="p">(</span><span class="n">TB_SHUTDOWN_HALT</span><span class="p">);</span>

	<span class="n">stop_this_cpu</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">native_machine_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_power_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reboot_force</span><span class="p">)</span>
			<span class="n">machine_shutdown</span><span class="p">();</span>
		<span class="n">pm_power_off</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* A fallback in case there is no PM info available */</span>
	<span class="n">tboot_shutdown</span><span class="p">(</span><span class="n">TB_SHUTDOWN_HALT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">machine_ops</span> <span class="n">machine_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">native_machine_power_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">native_machine_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">emergency_restart</span> <span class="o">=</span> <span class="n">native_machine_emergency_restart</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="n">native_machine_restart</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt</span> <span class="o">=</span> <span class="n">native_machine_halt</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_KEXEC</span>
	<span class="p">.</span><span class="n">crash_shutdown</span> <span class="o">=</span> <span class="n">native_machine_crash_shutdown</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">machine_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">machine_ops</span><span class="p">.</span><span class="n">power_off</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">machine_ops</span><span class="p">.</span><span class="n">shutdown</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_emergency_restart</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__machine_emergency_restart</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_restart</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">machine_ops</span><span class="p">.</span><span class="n">restart</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_halt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">machine_ops</span><span class="p">.</span><span class="n">halt</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_KEXEC</span>
<span class="kt">void</span> <span class="nf">machine_crash_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">machine_ops</span><span class="p">.</span><span class="n">crash_shutdown</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cp">#if defined(CONFIG_SMP)</span>

<span class="cm">/* This keeps a track of which one is crashing cpu. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">crashing_cpu</span><span class="p">;</span>
<span class="k">static</span> <span class="n">nmi_shootdown_cb</span> <span class="n">shootdown_callback</span><span class="p">;</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">waiting_for_crash_ipi</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">crash_nmi_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t do anything if this handler is invoked on crashing cpu.</span>
<span class="cm">	 * Otherwise, system will completely hang. Crashing cpu can get</span>
<span class="cm">	 * an NMI if system was initially booted with nmi_watchdog parameter.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">crashing_cpu</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NMI_HANDLED</span><span class="p">;</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="n">shootdown_callback</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waiting_for_crash_ipi</span><span class="p">);</span>
	<span class="cm">/* Assume hlt works */</span>
	<span class="n">halt</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;;)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">NMI_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smp_send_nmi_allbutself</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">send_IPI_allbutself</span><span class="p">(</span><span class="n">NMI_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Halt all other CPUs, calling the specified function on each of them</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to halt all other CPUs on crash</span>
<span class="cm"> * or emergency reboot time. The function passed as parameter</span>
<span class="cm"> * will be called inside a NMI handler on all CPUs.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nmi_shootdown_cpus</span><span class="p">(</span><span class="n">nmi_shootdown_cb</span> <span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msecs</span><span class="p">;</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="cm">/* Make a note of crashing cpu. Will be used in NMI callback. */</span>
	<span class="n">crashing_cpu</span> <span class="o">=</span> <span class="n">safe_smp_processor_id</span><span class="p">();</span>

	<span class="n">shootdown_callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waiting_for_crash_ipi</span><span class="p">,</span> <span class="n">num_online_cpus</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Would it be better to replace the trap vector here? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_nmi_handler</span><span class="p">(</span><span class="n">NMI_LOCAL</span><span class="p">,</span> <span class="n">crash_nmi_callback</span><span class="p">,</span>
				 <span class="n">NMI_FLAG_FIRST</span><span class="p">,</span> <span class="s">&quot;crash&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Return what? */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Ensure the new callback function is set before sending</span>
<span class="cm">	 * out the NMI</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">smp_send_nmi_allbutself</span><span class="p">();</span>

	<span class="n">msecs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="cm">/* Wait at most a second for the other cpus to stop */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waiting_for_crash_ipi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">msecs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">msecs</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Leave the nmi callback set */</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_SMP */</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">nmi_shootdown_cpus</span><span class="p">(</span><span class="n">nmi_shootdown_cb</span> <span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No other CPUs to shoot down */</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
