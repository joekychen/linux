<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › um › signal.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>signal.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2003 PathScale, Inc.</span>
<span class="cm"> * Copyright (C) 2003 - 2007 Jeff Dike (jdike@{addtoit,linux.intel}.com)</span>
<span class="cm"> * Licensed under the GPL</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/personality.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;asm/unistd.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/ucontext.h&gt;</span>
<span class="cp">#include &quot;frame_kern.h&quot;</span>
<span class="cp">#include &quot;skas.h&quot;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>

<span class="cm">/*</span>
<span class="cm"> * FPU tag word conversions.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">twd_i387_to_fxsr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">twd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span> <span class="cm">/* to avoid 16 bit prefixes in the code */</span>

	<span class="cm">/* Transform each pair of bits into 01 (valid) or 00 (empty) */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="o">~</span><span class="n">twd</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x5555</span><span class="p">;</span> <span class="cm">/* 0V0V0V0V0V0V0V0V */</span>
	<span class="cm">/* and move the valid bits to the lower byte. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3333</span><span class="p">;</span> <span class="cm">/* 00VV00VV00VV00VV */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0f0f</span><span class="p">;</span> <span class="cm">/* 0000VVVV0000VVVV */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span> <span class="cm">/* 00000000VVVVVVVV */</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">twd_fxsr_to_i387</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_fxsr_struct</span> <span class="o">*</span><span class="n">fxsave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_fpxreg</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">twd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">twd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#define FPREG_ADDR(f, n)	((char *)&amp;(f)-&gt;st_space + (n) * 16)</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twd</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_fpxreg</span> <span class="o">*</span><span class="p">)</span> <span class="n">FPREG_ADDR</span><span class="p">(</span><span class="n">fxsave</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">exponent</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x7fff</span>:
				<span class="n">tag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* Special */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x0000</span>:
				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">significand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				     <span class="o">!</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">significand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				     <span class="o">!</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">significand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				     <span class="o">!</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">significand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">tag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Zero */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Special */</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">significand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Valid */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Special */</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>			<span class="cm">/* Empty */</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">twd</span> <span class="o">=</span> <span class="n">twd</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">convert_fxsr_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">_fpstate</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">user_fxsr_struct</span> <span class="o">*</span><span class="n">fxsave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">env</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">_fpreg</span> <span class="n">__user</span> <span class="o">*</span><span class="n">to</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_fpxreg</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">cwd</span> <span class="o">|</span> <span class="mh">0xffff0000ul</span><span class="p">;</span>
	<span class="n">env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">swd</span> <span class="o">|</span> <span class="mh">0xffff0000ul</span><span class="p">;</span>
	<span class="n">env</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">twd_fxsr_to_i387</span><span class="p">(</span><span class="n">fxsave</span><span class="p">);</span>
	<span class="n">env</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">;</span>
	<span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">fop</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">env</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">;</span>
	<span class="n">env</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">fos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="mi">7</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">to</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">_st</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_fpxreg</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">st_space</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">to</span><span class="o">++</span><span class="p">,</span> <span class="n">from</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">to</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">from</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">__put_user</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">exponent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">exponent</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">convert_fxsr_from_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_fxsr_struct</span> <span class="o">*</span><span class="n">fxsave</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">_fpstate</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">env</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">_fpxreg</span> <span class="o">*</span><span class="n">to</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_fpreg</span> <span class="n">__user</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">7</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">cwd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">swd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">twd</span> <span class="o">=</span> <span class="n">twd_i387_to_fxsr</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">env</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">fip</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">fop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000ul</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">foo</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">fos</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">to</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_fpxreg</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fxsave</span><span class="o">-&gt;</span><span class="n">st_space</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">from</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">_st</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">to</span><span class="o">++</span><span class="p">,</span> <span class="n">from</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">to</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">from</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">__get_user</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">__get_user</span><span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">exponent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">exponent</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">have_fpx_regs</span><span class="p">;</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_sc_from_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">__user</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>

	<span class="cm">/* Always make any pending restarted system calls return -EINTR */</span>
	<span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">restart_block</span><span class="p">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">do_no_restart_syscall</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#define GETREG(regno, regname) regs-&gt;regs.gp[HOST_##regno] = sc.regname</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">GS</span><span class="p">,</span> <span class="n">gs</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span> <span class="n">ds</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">DI</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="n">si</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">BP</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">SP</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">BX</span><span class="p">,</span> <span class="n">bx</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">DX</span><span class="p">,</span> <span class="n">dx</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">CX</span><span class="p">,</span> <span class="n">cx</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">AX</span><span class="p">,</span> <span class="n">ax</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">R8</span><span class="p">,</span> <span class="n">r8</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">R9</span><span class="p">,</span> <span class="n">r9</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">R10</span><span class="p">,</span> <span class="n">r10</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">R11</span><span class="p">,</span> <span class="n">r11</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">R12</span><span class="p">,</span> <span class="n">r12</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">R13</span><span class="p">,</span> <span class="n">r13</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">R14</span><span class="p">,</span> <span class="n">r14</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">R15</span><span class="p">,</span> <span class="n">r15</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">GETREG</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">EFLAGS</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#undef GETREG</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">userspace_pid</span><span class="p">[</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">have_fpx_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">user_fxsr_struct</span> <span class="n">fpx</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpx</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">_fpstate</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">sc</span><span class="p">.</span><span class="n">fpstate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_fxsr_env</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_fxsr_struct</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">convert_fxsr_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpx</span><span class="p">,</span> <span class="n">sc</span><span class="p">.</span><span class="n">fpstate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">restore_fpx_registers</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fpx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;copy_sc_from_user - &quot;</span>
			       <span class="s">&quot;restore_fpx_registers failed, errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">-</span><span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">user_i387_struct</span> <span class="n">fp</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="p">,</span> <span class="n">sc</span><span class="p">.</span><span class="n">fpstate</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_i387_struct</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">restore_fp_registers</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;copy_sc_from_user - &quot;</span>
			       <span class="s">&quot;restore_fp_registers failed, errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">-</span><span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_sc_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">__user</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">_fpstate</span> <span class="n">__user</span> <span class="o">*</span><span class="n">to_fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">faultinfo</span> <span class="o">*</span> <span class="n">fi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">arch</span><span class="p">.</span><span class="n">faultinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sigcontext</span><span class="p">));</span>

<span class="cp">#define PUTREG(regno, regname) sc.regname = regs-&gt;regs.gp[HOST_##regno]</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">GS</span><span class="p">,</span> <span class="n">gs</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span> <span class="n">ds</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">DI</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="n">si</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">BP</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">SP</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">BX</span><span class="p">,</span> <span class="n">bx</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">DX</span><span class="p">,</span> <span class="n">dx</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">CX</span><span class="p">,</span> <span class="n">cx</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">AX</span><span class="p">,</span> <span class="n">ax</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">R8</span><span class="p">,</span> <span class="n">r8</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">R9</span><span class="p">,</span> <span class="n">r9</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">R10</span><span class="p">,</span> <span class="n">r10</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">R11</span><span class="p">,</span> <span class="n">r11</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">R12</span><span class="p">,</span> <span class="n">r12</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">R13</span><span class="p">,</span> <span class="n">r13</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">R14</span><span class="p">,</span> <span class="n">r14</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">R15</span><span class="p">,</span> <span class="n">r15</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">sc</span><span class="p">.</span><span class="n">cr2</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">cr2</span><span class="p">;</span>
	<span class="n">sc</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">;</span>
	<span class="n">sc</span><span class="p">.</span><span class="n">trapno</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">trap_no</span><span class="p">;</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">EFLAGS</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">SP</span><span class="p">,</span> <span class="n">sp_at_signal</span><span class="p">);</span>
	<span class="n">PUTREG</span><span class="p">(</span><span class="n">SS</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#undef PUTREG</span>
	<span class="n">sc</span><span class="p">.</span><span class="n">oldmask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">sc</span><span class="p">.</span><span class="n">fpstate</span> <span class="o">=</span> <span class="n">to_fp</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sigcontext</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">userspace_pid</span><span class="p">[</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">have_fpx_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">user_fxsr_struct</span> <span class="n">fpx</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">save_fpx_registers</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fpx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;copy_sc_to_user - save_fpx_registers &quot;</span>
			       <span class="s">&quot;failed, errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">convert_fxsr_to_user</span><span class="p">(</span><span class="n">to_fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">fpx</span><span class="p">.</span><span class="n">swd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_fp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">X86_FXSR_MAGIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_fp</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_fp</span><span class="o">-&gt;</span><span class="n">_fxsr_env</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpx</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_fxsr_struct</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">user_i387_struct</span> <span class="n">fp</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">save_fp_registers</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">to_fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_i387_struct</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_ucontext_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">ucontext</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">_fpstate</span> <span class="n">__user</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">sigset_t</span> <span class="o">*</span><span class="n">set</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_sp</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">sas_ss_flags</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_sc_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uc_mcontext</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uc_sigmask</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sigframe</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pretcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_fpstate</span> <span class="n">fpstate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">extramask</span><span class="p">[</span><span class="n">_NSIG_WORDS</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">retcode</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rt_sigframe</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pretcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pinfo</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">puc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucontext</span> <span class="n">uc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_fpstate</span> <span class="n">fpstate</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">retcode</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">setup_signal_stack_sc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">k_sigaction</span> <span class="o">*</span><span class="n">ka</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			  <span class="n">sigset_t</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">restorer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is the same calculation as i386 - ((sp + 4) &amp; 15) == 0 */</span>
	<span class="n">stack_top</span> <span class="o">=</span> <span class="p">((</span><span class="n">stack_top</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">16UL</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">stack_top</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">restorer</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">&amp;</span> <span class="n">SA_RESTORER</span><span class="p">)</span>
		<span class="n">restorer</span> <span class="o">=</span> <span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_restorer</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">restorer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">pretcode</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_sc_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fpstate</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_NSIG_WORDS</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">extramask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">extramask</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is popl %eax ; movl $,%eax ; int $0x80</span>
<span class="cm">	 *</span>
<span class="cm">	 * WE DO NOT USE IT ANY MORE! It&#39;s only left here for historical</span>
<span class="cm">	 * reasons and because gdb uses it as a signature to notice</span>
<span class="cm">	 * signal handler stack frames.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="mh">0xb858</span><span class="p">,</span> <span class="p">(</span><span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="o">+</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">__NR_sigreturn</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="mh">0x80cd</span><span class="p">,</span> <span class="p">(</span><span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="o">+</span><span class="mi">6</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">PT_REGS_SP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">PT_REGS_IP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span><span class="p">;</span>
	<span class="n">PT_REGS_AX</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sig</span><span class="p">;</span>
	<span class="n">PT_REGS_DX</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PT_REGS_CX</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ptrace</span> <span class="o">&amp;</span> <span class="n">PT_DTRACE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ptrace</span> <span class="o">&amp;</span> <span class="n">PT_PTRACED</span><span class="p">))</span>
		<span class="n">ptrace_notify</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">setup_signal_stack_si</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">k_sigaction</span> <span class="o">*</span><span class="n">ka</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			  <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">sigset_t</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">restorer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">stack_top</span> <span class="o">&amp;=</span> <span class="o">-</span><span class="mi">8UL</span><span class="p">;</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">stack_top</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">restorer</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">&amp;</span> <span class="n">SA_RESTORER</span><span class="p">)</span>
		<span class="n">restorer</span> <span class="o">=</span> <span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_restorer</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">restorer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">pretcode</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">pinfo</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">puc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_siginfo_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_ucontext_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fpstate</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
					<span class="n">PT_REGS_SP</span><span class="p">(</span><span class="n">regs</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is movl $,%eax ; int $0x80</span>
<span class="cm">	 *</span>
<span class="cm">	 * WE DO NOT USE IT ANY MORE! It&#39;s only left here for historical</span>
<span class="cm">	 * reasons and because gdb uses it as a signature to notice</span>
<span class="cm">	 * signal handler stack frames.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="mh">0xb8</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="o">+</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">__NR_rt_sigreturn</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="mh">0x80cd</span><span class="p">,</span> <span class="p">(</span><span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="o">+</span><span class="mi">5</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">PT_REGS_SP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">PT_REGS_IP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span><span class="p">;</span>
	<span class="n">PT_REGS_AX</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sig</span><span class="p">;</span>
	<span class="n">PT_REGS_DX</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="n">PT_REGS_CX</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ptrace</span> <span class="o">&amp;</span> <span class="n">PT_DTRACE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ptrace</span> <span class="o">&amp;</span> <span class="n">PT_PTRACED</span><span class="p">))</span>
		<span class="n">ptrace_notify</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">sys_sigreturn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">PT_REGS_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">sp</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sigset_t</span> <span class="n">set</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">oldmask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">oldmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">extramask</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">extramask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">_NSIG_WORDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oldmask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">set</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">||</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extramask</span><span class="p">,</span> <span class="n">sig_size</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">segfault</span><span class="p">;</span>

	<span class="n">set_current_blocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_sc_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">,</span> <span class="n">sc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">segfault</span><span class="p">;</span>

	<span class="cm">/* Avoid ERESTART handling */</span>
	<span class="n">PT_REGS_SYSCALL_NR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PT_REGS_SYSCALL_RET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">);</span>

 <span class="nl">segfault:</span>
	<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">struct</span> <span class="n">rt_sigframe</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pretcode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucontext</span> <span class="n">uc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_fpstate</span> <span class="n">fpstate</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">setup_signal_stack_si</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">k_sigaction</span> <span class="o">*</span><span class="n">ka</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">,</span>
			  <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">sigset_t</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">me</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">round_down</span><span class="p">(</span><span class="n">stack_top</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_sigframe</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
	<span class="cm">/* Subtract 128 for a red zone and 8 for proper alignment */</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">&amp;</span> <span class="n">SA_SIGINFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_siginfo_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create the ucontext.  */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_link</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_sp</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">sas_ss_flags</span><span class="p">(</span><span class="n">PT_REGS_SP</span><span class="p">(</span><span class="n">regs</span><span class="p">)),</span>
			  <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">sas_ss_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_sc_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_mcontext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fpstate</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
			       <span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fpstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_mcontext</span><span class="p">.</span><span class="n">fpstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_sigmask</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_sigmask</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">.</span><span class="n">uc_sigmask</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up to return from userspace.  If provided, use a stub</span>
<span class="cm">	 * already in userspace.</span>
<span class="cm">	 */</span>
	<span class="cm">/* x86-64 should always use SA_RESTORER. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">&amp;</span> <span class="n">SA_RESTORER</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_restorer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">pretcode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* could use a vstub here */</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set up registers for signal handler */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">exec_domain</span> <span class="o">*</span><span class="n">ed</span> <span class="o">=</span> <span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">exec_domain</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ed</span> <span class="o">&amp;&amp;</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">signal_invmap</span> <span class="o">&amp;&amp;</span> <span class="n">sig</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">))</span>
			<span class="n">sig</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">signal_invmap</span><span class="p">[</span><span class="n">sig</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">PT_REGS_SP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">PT_REGS_DI</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
	<span class="cm">/* In case the signal handler was declared without prototypes */</span>
	<span class="n">PT_REGS_AX</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This also works for non SA_SIGINFO handlers because they expect the</span>
<span class="cm">	 * next argument after the signal number on the stack.</span>
<span class="cm">	 */</span>
	<span class="n">PT_REGS_SI</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="n">PT_REGS_DX</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">;</span>
	<span class="n">PT_REGS_IP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">long</span> <span class="nf">sys_rt_sigreturn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">PT_REGS_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rt_sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">rt_sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">sp</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">ucontext</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">;</span>
	<span class="n">sigset_t</span> <span class="n">set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uc_sigmask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">set</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">segfault</span><span class="p">;</span>

	<span class="n">set_current_blocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_sc_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uc_mcontext</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">segfault</span><span class="p">;</span>

	<span class="cm">/* Avoid ERESTART handling */</span>
	<span class="n">PT_REGS_SYSCALL_NR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PT_REGS_SYSCALL_RET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="p">);</span>

 <span class="nl">segfault:</span>
	<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="kt">long</span> <span class="nf">ptregs_sigreturn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sys_sigreturn</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">long</span> <span class="nf">ptregs_rt_sigreturn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sys_rt_sigreturn</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
