<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › pci › xen.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xen.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Xen PCI - handle PCI (INTx) and MSI infrastructure calls for PV, HVM and</span>
<span class="cm"> * initial domain support. We also handle the DSDT _PRT callbacks for GSI&#39;s</span>
<span class="cm"> * used in HVM and initial domain mode (PV does not parse ACPI, so it has no</span>
<span class="cm"> * concept of GSIs). Under PV we hook under the pnbbios API for IRQs and</span>
<span class="cm"> * 0xcf8 PCI configuration read/write.</span>
<span class="cm"> *</span>
<span class="cm"> *   Author: Ryan Wilson &lt;hap9@epoch.ncsc.mil&gt;</span>
<span class="cm"> *           Konrad Rzeszutek Wilk &lt;konrad.wilk@oracle.com&gt;</span>
<span class="cm"> *           Stefano Stabellini &lt;stefano.stabellini@eu.citrix.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/io_apic.h&gt;</span>
<span class="cp">#include &lt;asm/pci_x86.h&gt;</span>

<span class="cp">#include &lt;asm/xen/hypervisor.h&gt;</span>

<span class="cp">#include &lt;xen/features.h&gt;</span>
<span class="cp">#include &lt;xen/events.h&gt;</span>
<span class="cp">#include &lt;asm/xen/pci.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_pcifront_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">share</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pirq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gsi</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gsi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Xen PCI: failed to read interrupt line: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* In PV DomU the Xen PCI backend puts the PIRQ in the interrupt line.*/</span>
	<span class="n">pirq</span> <span class="o">=</span> <span class="n">gsi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gsi</span> <span class="o">&lt;</span> <span class="n">NR_IRQS_LEGACY</span><span class="p">)</span>
		<span class="n">share</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">xen_bind_pirq_gsi_to_irq</span><span class="p">(</span><span class="n">gsi</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">share</span><span class="p">,</span> <span class="s">&quot;pcifront&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Xen PCI: failed to bind GSI%d (PIRQ%d) to IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">gsi</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Xen PCI mapped GSI%d to IRQ%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gsi</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ACPI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_register_pirq</span><span class="p">(</span><span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gsi_override</span><span class="p">,</span> <span class="kt">int</span> <span class="n">triggering</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">set_pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">pirq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">physdev_map_pirq</span> <span class="n">map_irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shareable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">xen_irq_from_gsi</span><span class="p">(</span><span class="n">gsi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_pirq</span><span class="p">)</span>
		<span class="n">pirq</span> <span class="o">=</span> <span class="n">gsi</span><span class="p">;</span>

	<span class="n">map_irq</span><span class="p">.</span><span class="n">domid</span> <span class="o">=</span> <span class="n">DOMID_SELF</span><span class="p">;</span>
	<span class="n">map_irq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MAP_PIRQ_TYPE_GSI</span><span class="p">;</span>
	<span class="n">map_irq</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">gsi</span><span class="p">;</span>
	<span class="n">map_irq</span><span class="p">.</span><span class="n">pirq</span> <span class="o">=</span> <span class="n">pirq</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_map_pirq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;xen map irq failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">triggering</span> <span class="o">==</span> <span class="n">ACPI_EDGE_SENSITIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shareable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ioapic-edge&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shareable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ioapic-level&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gsi_override</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gsi</span> <span class="o">=</span> <span class="n">gsi_override</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">xen_bind_pirq_gsi_to_irq</span><span class="p">(</span><span class="n">gsi</span><span class="p">,</span> <span class="n">map_irq</span><span class="p">.</span><span class="n">pirq</span><span class="p">,</span> <span class="n">shareable</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;xen: --&gt; pirq=%d -&gt; irq=%d (gsi=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">map_irq</span><span class="p">.</span><span class="n">pirq</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_register_gsi_xen_hvm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_hvm_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xen_register_pirq</span><span class="p">(</span><span class="n">gsi</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* no GSI override */</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span>
				 <span class="nb">false</span> <span class="cm">/* no mapping of GSI to PIRQ */</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_XEN_DOM0</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_register_gsi</span><span class="p">(</span><span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gsi_override</span><span class="p">,</span> <span class="kt">int</span> <span class="n">triggering</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">physdev_setup_gsi</span> <span class="n">setup_gsi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_pv_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;xen: registering gsi %u triggering %d polarity %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">gsi</span><span class="p">,</span> <span class="n">triggering</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">xen_register_pirq</span><span class="p">(</span><span class="n">gsi</span><span class="p">,</span> <span class="n">gsi_override</span><span class="p">,</span> <span class="n">triggering</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">setup_gsi</span><span class="p">.</span><span class="n">gsi</span> <span class="o">=</span> <span class="n">gsi</span><span class="p">;</span>
	<span class="n">setup_gsi</span><span class="p">.</span><span class="n">triggering</span> <span class="o">=</span> <span class="p">(</span><span class="n">triggering</span> <span class="o">==</span> <span class="n">ACPI_EDGE_SENSITIVE</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">setup_gsi</span><span class="p">.</span><span class="n">polarity</span> <span class="o">=</span> <span class="p">(</span><span class="n">polarity</span> <span class="o">==</span> <span class="n">ACPI_ACTIVE_HIGH</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_setup_gsi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup_gsi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Already setup the GSI :%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to setup GSI :%d, err_code:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">gsi</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_register_gsi_xen</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gsi</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xen_register_gsi</span><span class="p">(</span><span class="n">gsi</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* no GSI override */</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_PCI_MSI)</span>
<span class="cp">#include &lt;linux/msi.h&gt;</span>
<span class="cp">#include &lt;asm/msidef.h&gt;</span>

<span class="k">struct</span> <span class="n">xen_pci_frontend_ops</span> <span class="o">*</span><span class="n">xen_pci_frontend</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xen_pci_frontend</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_setup_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">msidesc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nvec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xen_pci_frontend_enable_msix</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xen_pci_frontend_enable_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">msidesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">xen_bind_pirq_msi_to_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msidesc</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">)</span> <span class="o">?</span>
					       <span class="s">&quot;pcifront-msi-x&quot;</span> <span class="o">:</span>
					       <span class="s">&quot;pcifront-msi&quot;</span><span class="p">,</span>
						<span class="n">DOMID_SELF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Xen PCI frontend has not registered MSI/MSI-X support!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define XEN_PIRQ_MSI_DATA  (MSI_DATA_TRIGGER_EDGE | \</span>
<span class="cp">		MSI_DATA_LEVEL_ASSERT | (3 &lt;&lt; 8) | MSI_DATA_VECTOR(0))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_msi_compose_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We set vector == 0 to tell the hypervisor we don&#39;t care about it,</span>
<span class="cm">	 * but we want a pirq setup instead.</span>
<span class="cm">	 * We use the dest_id field to pass the pirq that we want. */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span> <span class="o">=</span> <span class="n">MSI_ADDR_BASE_HI</span> <span class="o">|</span> <span class="n">MSI_ADDR_EXT_DEST_ID</span><span class="p">(</span><span class="n">pirq</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span> <span class="o">=</span>
		<span class="n">MSI_ADDR_BASE_LO</span> <span class="o">|</span>
		<span class="n">MSI_ADDR_DEST_MODE_PHYSICAL</span> <span class="o">|</span>
		<span class="n">MSI_ADDR_REDIRECTION_CPU</span> <span class="o">|</span>
		<span class="n">MSI_ADDR_DEST_ID</span><span class="p">(</span><span class="n">pirq</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">XEN_PIRQ_MSI_DATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_hvm_setup_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">pirq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">msidesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_msg</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">msidesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__read_msi_msg</span><span class="p">(</span><span class="n">msidesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">pirq</span> <span class="o">=</span> <span class="n">MSI_ADDR_EXT_DEST_ID</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">address_hi</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">msg</span><span class="p">.</span><span class="n">address_lo</span> <span class="o">&gt;&gt;</span> <span class="n">MSI_ADDR_DEST_ID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span> <span class="o">!=</span> <span class="n">XEN_PIRQ_MSI_DATA</span> <span class="o">||</span>
		    <span class="n">xen_irq_from_pirq</span><span class="p">(</span><span class="n">pirq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pirq</span> <span class="o">=</span> <span class="n">xen_allocate_pirq_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msidesc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pirq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">xen_msi_compose_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
			<span class="n">__write_msi_msg</span><span class="p">(</span><span class="n">msidesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xen: msi bound to pirq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pirq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;xen: msi already bound to pirq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pirq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">xen_bind_pirq_msi_to_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msidesc</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">)</span> <span class="o">?</span>
					       <span class="s">&quot;msi-x&quot;</span> <span class="o">:</span> <span class="s">&quot;msi&quot;</span><span class="p">,</span>
					       <span class="n">DOMID_SELF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;xen: msi --&gt; pirq=%d --&gt; irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Xen PCI frontend has not registered MSI/MSI-X support!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_XEN_DOM0</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">__read_mostly</span> <span class="n">pci_seg_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_initdom_setup_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">msidesc</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">msidesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">physdev_map_pirq</span> <span class="n">map_irq</span><span class="p">;</span>
		<span class="n">domid_t</span> <span class="n">domid</span><span class="p">;</span>

		<span class="n">domid</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">xen_find_device_domain_owner</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* N.B. Casting int&#39;s -ENODEV to uint16_t results in 0xFFED,</span>
<span class="cm">		 * hence check ret value for &lt; 0. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">domid</span> <span class="o">=</span> <span class="n">DOMID_SELF</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">map_irq</span><span class="p">));</span>
		<span class="n">map_irq</span><span class="p">.</span><span class="n">domid</span> <span class="o">=</span> <span class="n">domid</span><span class="p">;</span>
		<span class="n">map_irq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MAP_PIRQ_TYPE_MSI_SEG</span><span class="p">;</span>
		<span class="n">map_irq</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">map_irq</span><span class="p">.</span><span class="n">pirq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">map_irq</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">map_irq</span><span class="p">.</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">table_offset</span><span class="p">,</span> <span class="n">bir</span><span class="p">;</span>

			<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>

			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_TABLE</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">table_offset</span><span class="p">);</span>
			<span class="n">bir</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">table_offset</span> <span class="o">&amp;</span> <span class="n">PCI_MSIX_FLAGS_BIRMASK</span><span class="p">);</span>

			<span class="n">map_irq</span><span class="p">.</span><span class="n">table_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bir</span><span class="p">);</span>
			<span class="n">map_irq</span><span class="p">.</span><span class="n">entry_nr</span> <span class="o">=</span> <span class="n">msidesc</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">entry_nr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_seg_supported</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_map_pirq</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">map_irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">map_irq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MAP_PIRQ_TYPE_MSI</span><span class="p">;</span>
			<span class="n">map_irq</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">map_irq</span><span class="p">.</span><span class="n">pirq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">map_irq</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_map_pirq</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">map_irq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
				<span class="n">pci_seg_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xen map irq failed %d for %d domain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ret</span><span class="p">,</span> <span class="n">domid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xen_bind_pirq_msi_to_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msidesc</span><span class="p">,</span>
					       <span class="n">map_irq</span><span class="p">.</span><span class="n">pirq</span><span class="p">,</span> <span class="n">map_irq</span><span class="p">.</span><span class="n">index</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">)</span> <span class="o">?</span>
					       <span class="s">&quot;msi-x&quot;</span> <span class="o">:</span> <span class="s">&quot;msi&quot;</span><span class="p">,</span>
						<span class="n">domid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_initdom_restore_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_seg_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">physdev_pci_device</span> <span class="n">restore_ext</span><span class="p">;</span>

		<span class="n">restore_ext</span><span class="p">.</span><span class="n">seg</span> <span class="o">=</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">restore_ext</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">restore_ext</span><span class="p">.</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_restore_msi_ext</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">restore_ext</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">)</span>
			<span class="n">pci_seg_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">WARN</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">,</span> <span class="s">&quot;restore_msi_ext -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_seg_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">physdev_restore_msi</span> <span class="n">restore</span><span class="p">;</span>

		<span class="n">restore</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">restore</span><span class="p">.</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_restore_msi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">restore</span><span class="p">);</span>
		<span class="n">WARN</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">,</span> <span class="s">&quot;restore_msi -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_teardown_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">msidesc</span><span class="p">;</span>

	<span class="n">msidesc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_desc</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msidesc</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_msix</span><span class="p">)</span>
		<span class="n">xen_pci_frontend_disable_msix</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">xen_pci_frontend_disable_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Free the IRQ&#39;s and the msidesc using the generic code. */</span>
	<span class="n">default_teardown_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_teardown_msi_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_destroy_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_xen_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_pv_domain</span><span class="p">()</span> <span class="o">||</span> <span class="n">xen_initial_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: setting up Xen PCI frontend stub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pcibios_set_cache_line_size</span><span class="p">();</span>

	<span class="n">pcibios_enable_irq</span> <span class="o">=</span> <span class="n">xen_pcifront_enable_irq</span><span class="p">;</span>
	<span class="n">pcibios_disable_irq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ACPI</span>
	<span class="cm">/* Keep ACPI out of the picture */</span>
	<span class="n">acpi_noirq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="n">x86_msi</span><span class="p">.</span><span class="n">setup_msi_irqs</span> <span class="o">=</span> <span class="n">xen_setup_msi_irqs</span><span class="p">;</span>
	<span class="n">x86_msi</span><span class="p">.</span><span class="n">teardown_msi_irq</span> <span class="o">=</span> <span class="n">xen_teardown_msi_irq</span><span class="p">;</span>
	<span class="n">x86_msi</span><span class="p">.</span><span class="n">teardown_msi_irqs</span> <span class="o">=</span> <span class="n">xen_teardown_msi_irqs</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_xen_hvm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_have_vector_callback</span> <span class="o">||</span> <span class="o">!</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_hvm_pirqs</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ACPI</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want to change the actual ACPI delivery model,</span>
<span class="cm">	 * just how GSIs get registered.</span>
<span class="cm">	 */</span>
	<span class="n">__acpi_register_gsi</span> <span class="o">=</span> <span class="n">acpi_register_gsi_xen_hvm</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="n">x86_msi</span><span class="p">.</span><span class="n">setup_msi_irqs</span> <span class="o">=</span> <span class="n">xen_hvm_setup_msi_irqs</span><span class="p">;</span>
	<span class="n">x86_msi</span><span class="p">.</span><span class="n">teardown_msi_irq</span> <span class="o">=</span> <span class="n">xen_teardown_msi_irq</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_XEN_DOM0</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">xen_setup_acpi_sci</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">polarity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gsi</span> <span class="o">=</span> <span class="n">acpi_sci_override_gsi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gsi_override</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gsi</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">acpi_get_override_irq</span><span class="p">(</span><span class="n">gsi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trigger</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">polarity</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;xen: acpi_get_override_irq failed for acpi&quot;</span>
				<span class="s">&quot; sci, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">?</span> <span class="n">ACPI_LEVEL_SENSITIVE</span> <span class="o">:</span> <span class="n">ACPI_EDGE_SENSITIVE</span><span class="p">;</span>
	<span class="n">polarity</span> <span class="o">=</span> <span class="n">polarity</span> <span class="o">?</span> <span class="n">ACPI_ACTIVE_LOW</span> <span class="o">:</span> <span class="n">ACPI_ACTIVE_HIGH</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;xen: sci override: global_irq=%d trigger=%d &quot;</span>
			<span class="s">&quot;polarity=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gsi</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>

	<span class="cm">/* Before we bind the GSI to a Linux IRQ, check whether</span>
<span class="cm">	 * we need to override it with bus_irq (IRQ) value. Usually for</span>
<span class="cm">	 * IRQs below IRQ_LEGACY_IRQ this holds IRQ == GSI, as so:</span>
<span class="cm">	 *  ACPI: INT_SRC_OVR (bus 0 bus_irq 9 global_irq 9 low level)</span>
<span class="cm">	 * but there are oddballs where the IRQ != GSI:</span>
<span class="cm">	 *  ACPI: INT_SRC_OVR (bus 0 bus_irq 9 global_irq 20 low level)</span>
<span class="cm">	 * which ends up being: gsi_to_irq[9] == 20</span>
<span class="cm">	 * (which is what acpi_gsi_to_irq ends up calling when starting the</span>
<span class="cm">	 * the ACPI interpreter and keels over since IRQ 9 has not been</span>
<span class="cm">	 * setup as we had setup IRQ 20 for it).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_gsi_to_irq</span><span class="p">(</span><span class="n">gsi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use the provided value if it&#39;s valid. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gsi_override</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gsi</span> <span class="o">=</span> <span class="n">xen_register_gsi</span><span class="p">(</span><span class="n">gsi</span><span class="p">,</span> <span class="n">gsi_override</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;xen: acpi sci %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gsi</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_xen_initial_domain</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="n">x86_msi</span><span class="p">.</span><span class="n">setup_msi_irqs</span> <span class="o">=</span> <span class="n">xen_initdom_setup_msi_irqs</span><span class="p">;</span>
	<span class="n">x86_msi</span><span class="p">.</span><span class="n">teardown_msi_irq</span> <span class="o">=</span> <span class="n">xen_teardown_msi_irq</span><span class="p">;</span>
	<span class="n">x86_msi</span><span class="p">.</span><span class="n">restore_msi_irqs</span> <span class="o">=</span> <span class="n">xen_initdom_restore_msi_irqs</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">xen_setup_acpi_sci</span><span class="p">();</span>
	<span class="n">__acpi_register_gsi</span> <span class="o">=</span> <span class="n">acpi_register_gsi_xen</span><span class="p">;</span>
	<span class="cm">/* Pre-allocate legacy irqs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="n">NR_IRQS_LEGACY</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">polarity</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">acpi_get_override_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trigger</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">polarity</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">xen_register_pirq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* no GSI override */</span><span class="p">,</span>
			<span class="n">trigger</span> <span class="o">?</span> <span class="n">ACPI_LEVEL_SENSITIVE</span> <span class="o">:</span> <span class="n">ACPI_EDGE_SENSITIVE</span><span class="p">,</span>
			<span class="nb">true</span> <span class="cm">/* Map GSI to PIRQ */</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">nr_ioapics</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="n">NR_IRQS_LEGACY</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span>
			<span class="n">xen_bind_pirq_gsi_to_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;xt-pic&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">xen_device_domain_owner</span> <span class="p">{</span>
	<span class="n">domid_t</span> <span class="n">domain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">dev_domain_list</span> <span class="o">=</span> <span class="n">LIST_HEAD_INIT</span><span class="p">(</span><span class="n">dev_domain_list</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xen_device_domain_owner</span> <span class="o">*</span><span class="nf">find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_device_domain_owner</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_domain_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">owner</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">xen_find_device_domain_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_device_domain_owner</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">domain</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
	<span class="n">owner</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">)</span>
		<span class="n">domain</span> <span class="o">=</span> <span class="n">owner</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">domain</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xen_find_device_domain_owner</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">xen_register_device_domain_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_device_domain_owner</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>

	<span class="n">owner</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_device_domain_owner</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">owner</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">owner</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
	<span class="n">owner</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_domain_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xen_register_device_domain_owner</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">xen_unregister_device_domain_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_device_domain_owner</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
	<span class="n">owner</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">owner</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_domain_list_spinlock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xen_unregister_device_domain_owner</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
