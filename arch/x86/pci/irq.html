<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › pci › irq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>irq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Low-Level PCI Support for PC -- Routing of Interrupts</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) 1999--2000 Martin Mares &lt;mj@ucw.cz&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;asm/io_apic.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;asm/pci_x86.h&gt;</span>

<span class="cp">#define PIRQ_SIGNATURE	((&#39;$&#39; &lt;&lt; 0) + (&#39;P&#39; &lt;&lt; 8) + (&#39;I&#39; &lt;&lt; 16) + (&#39;R&#39; &lt;&lt; 24))</span>
<span class="cp">#define PIRQ_VERSION 0x0100</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">broken_hp_bios_irq9</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">acer_tm360_irqrouting</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="n">pirq_table</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pirq_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Never use: 0, 1, 2 (timer, keyboard, and cascade)</span>
<span class="cm"> * Avoid using: 13, 14 and 15 (FP error and IDE).</span>
<span class="cm"> * Penalize: 3, 4, 6, 7, 12 (known ISA uses: serial, floppy, parallel and mouse)</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pcibios_irq_mask</span> <span class="o">=</span> <span class="mh">0xfff8</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pirq_penalty</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1000000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">100000</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">irq_router</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">new</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">irq_router_handler</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">vendor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pcibios_enable_irq</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">pirq_enable_irq</span><span class="p">;</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pcibios_disable_irq</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  Check passed address for the PCI IRQ Routing Table signature</span>
<span class="cm"> *  and perform checksum verification.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="nf">pirq_check_routing_table</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sum</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">PIRQ_SIGNATURE</span> <span class="o">||</span>
	    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">PIRQ_VERSION</span> <span class="o">||</span>
	    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">||</span>
	    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_routing_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: Interrupt Routing Table found at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  Search 0xf0000 -- 0xfffff for the PCI IRQ Routing Table.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">pirq_find_routing_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pirq_table_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="n">pirq_check_routing_table</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">__va</span><span class="p">(</span><span class="n">pirq_table_addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PCI: PIRQ table NOT found at pirqaddr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">__va</span><span class="p">(</span><span class="mh">0xf0000</span><span class="p">);</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">__va</span><span class="p">(</span><span class="mh">0x100000</span><span class="p">);</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt</span> <span class="o">=</span> <span class="n">pirq_check_routing_table</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  If we have a IRQ routing table, use it to search for peer host</span>
<span class="cm"> *  bridges.  It&#39;s a gross hack, but since there are no other known</span>
<span class="cm"> *  ways how to get a list of buses, we have to go this way.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">pirq_peer_trick</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">pirq_table</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">busmap</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_info</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">busmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">busmap</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_routing_table</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_info</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%02x:%02x slot=%02x&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; %d:%02x/%04x&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">link</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bitmap</span><span class="p">);</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">busmap</span><span class="p">[</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">node</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">busmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="n">pci_find_bus</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">get_mp_bus_to_node</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_scan_bus_on_node</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_root_ops</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Discovered primary peer &quot;</span>
			       <span class="s">&quot;bus %02x [IRQ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pcibios_last_bus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Code for querying and setting of IRQ routes on various interrupt routers.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">eisa_set_level_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mh">0x4d0</span> <span class="o">+</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u16</span> <span class="n">eisa_irq_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">16</span> <span class="o">||</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">eisa_irq_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">eisa_irq_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: setting IRQ %u as level-triggered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; -&gt; edge&quot;</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Common IRQ routing practice: nibbles in config space,</span>
<span class="cm"> * offset by some magic constant.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">read_config_nybble</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_config_nybble</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">:</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALI pirq entries are damn ugly, and completely undocumented.</span>
<span class="cm"> * This has been figured out from pirq tables, and it&#39;s not a pretty</span>
<span class="cm"> * picture.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_ali_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irqmap</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">irqmap</span><span class="p">[</span><span class="n">read_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">)];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_ali_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irqmap</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">irqmap</span><span class="p">[</span><span class="n">irq</span><span class="p">];</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The Intel PIIX4 pirq rules are fairly simple: &quot;pirq&quot; is</span>
<span class="cm"> * just a pointer to the config space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_piix_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_piix_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The VIA pirq rules are nibble-based, like ALI,</span>
<span class="cm"> * but without the ugly irq number munging.</span>
<span class="cm"> * However, PIRQD is in the upper instead of lower 4 bits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_via_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">pirq</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="n">pirq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_via_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">pirq</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The VIA pirq rules are nibble-based, like ALI,</span>
<span class="cm"> * but without the ugly irq number munging.</span>
<span class="cm"> * However, for 82C586, nibble map is different .</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_via586_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pirqmap</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">read_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">pirqmap</span><span class="p">[</span><span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_via586_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pirqmap</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">write_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">pirqmap</span><span class="p">[</span><span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ITE 8330G pirq rules are nibble-based</span>
<span class="cm"> * FIXME: pirqmap may be { 1, 0, 3, 2 },</span>
<span class="cm"> * 	  2+3 are both mapped to irq 9 on my system</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_ite_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pirqmap</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">read_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">pirqmap</span><span class="p">[</span><span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_ite_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pirqmap</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">write_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">pirqmap</span><span class="p">[</span><span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * OPTI: high four bits are nibble pointer..</span>
<span class="cm"> * I wonder what the low bits do?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_opti_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="n">pirq</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_opti_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="n">pirq</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cyrix: nibble offset 0x5C</span>
<span class="cm"> * 0x5C bits 7:4 is INTB bits 3:0 is INTA</span>
<span class="cm"> * 0x5D bits 7:4 is INTD bits 3:0 is INTC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_cyrix_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="p">(</span><span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_cyrix_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="p">(</span><span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="mi">1</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	PIRQ routing for SiS 85C503 router used in several SiS chipsets.</span>
<span class="cm"> *	We have to deal with the following issues here:</span>
<span class="cm"> *	- vendors have different ideas about the meaning of link values</span>
<span class="cm"> *	- some onboard devices (integrated in the chipset) have special</span>
<span class="cm"> *	  links and are thus routed differently (i.e. not via PCI INTA-INTD)</span>
<span class="cm"> *	- different revision of the router have a different layout for</span>
<span class="cm"> *	  the routing registers, particularly for the onchip devices</span>
<span class="cm"> *</span>
<span class="cm"> *	For all routing registers the common thing is we have one byte</span>
<span class="cm"> *	per routeable link which is defined as:</span>
<span class="cm"> *		 bit 7      IRQ mapping enabled (0) or disabled (1)</span>
<span class="cm"> *		 bits [6:4] reserved (sometimes used for onchip devices)</span>
<span class="cm"> *		 bits [3:0] IRQ to map to</span>
<span class="cm"> *		     allowed: 3-7, 9-12, 14-15</span>
<span class="cm"> *		     reserved: 0, 1, 2, 8, 13</span>
<span class="cm"> *</span>
<span class="cm"> *	The config-space registers located at 0x41/0x42/0x43/0x44 are</span>
<span class="cm"> *	always used to route the normal PCI INT A/B/C/D respectively.</span>
<span class="cm"> *	Apparently there are systems implementing PCI routing table using</span>
<span class="cm"> *	link values 0x01-0x04 and others using 0x41-0x44 for PCI INTA..D.</span>
<span class="cm"> *	We try our best to handle both link mappings.</span>
<span class="cm"> *</span>
<span class="cm"> *	Currently (2003-05-21) it appears most SiS chipsets follow the</span>
<span class="cm"> *	definition of routing registers from the SiS-5595 southbridge.</span>
<span class="cm"> *	According to the SiS 5595 datasheets the revision id&#39;s of the</span>
<span class="cm"> *	router (ISA-bridge) should be 0x01 or 0xb0.</span>
<span class="cm"> *</span>
<span class="cm"> *	Furthermore we&#39;ve also seen lspci dumps with revision 0x00 and 0xb1.</span>
<span class="cm"> *	Looks like these are used in a number of SiS 5xx/6xx/7xx chipsets.</span>
<span class="cm"> *	They seem to work with the current routing code. However there is</span>
<span class="cm"> *	some concern because of the two USB-OHCI HCs (original SiS 5595</span>
<span class="cm"> *	had only one). YMMV.</span>
<span class="cm"> *</span>
<span class="cm"> *	Onchip routing for router rev-id 0x01/0xb0 and probably 0x00/0xb1:</span>
<span class="cm"> *</span>
<span class="cm"> *	0x61:	IDEIRQ:</span>
<span class="cm"> *		bits [6:5] must be written 01</span>
<span class="cm"> *		bit 4 channel-select primary (0), secondary (1)</span>
<span class="cm"> *</span>
<span class="cm"> *	0x62:	USBIRQ:</span>
<span class="cm"> *		bit 6 OHCI function disabled (0), enabled (1)</span>
<span class="cm"> *</span>
<span class="cm"> *	0x6a:	ACPI/SCI IRQ: bits 4-6 reserved</span>
<span class="cm"> *</span>
<span class="cm"> *	0x7e:	Data Acq. Module IRQ - bits 4-6 reserved</span>
<span class="cm"> *</span>
<span class="cm"> *	We support USBIRQ (in addition to INTA-INTD) and keep the</span>
<span class="cm"> *	IDE, ACPI and DAQ routing untouched as set by the BIOS.</span>
<span class="cm"> *</span>
<span class="cm"> *	Currently the only reported exception is the new SiS 65x chipset</span>
<span class="cm"> *	which includes the SiS 69x southbridge. Here we have the 85C503</span>
<span class="cm"> *	router revision 0x04 and there are changes in the register layout</span>
<span class="cm"> *	mostly related to the different USB HCs with USB 2.0 support.</span>
<span class="cm"> *</span>
<span class="cm"> *	Onchip routing for router rev-id 0x04 (try-and-error observation)</span>
<span class="cm"> *</span>
<span class="cm"> *	0x60/0x61/0x62/0x63:	1xEHCI and 3xOHCI (companion) USB-HCs</span>
<span class="cm"> *				bit 6-4 are probably unused, not like 5595</span>
<span class="cm"> */</span>

<span class="cp">#define PIRQ_SIS_IRQ_MASK	0x0f</span>
<span class="cp">#define PIRQ_SIS_IRQ_DISABLE	0x80</span>
<span class="cp">#define PIRQ_SIS_USB_ENABLE	0x40</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_sis_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">pirq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x04</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">PIRQ_SIS_IRQ_DISABLE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">PIRQ_SIS_IRQ_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_sis_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">pirq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x04</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PIRQ_SIS_IRQ_MASK</span> <span class="o">|</span> <span class="n">PIRQ_SIS_IRQ_DISABLE</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">|=</span> <span class="n">irq</span> <span class="o">?</span> <span class="n">irq</span><span class="o">:</span> <span class="n">PIRQ_SIS_IRQ_DISABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * VLSI: nibble offset 0x74 - educated guess due to routing table and</span>
<span class="cm"> *       config space of VLSI 82C534 PCI-bridge/router (1004:0102)</span>
<span class="cm"> *       Tested on HP OmniBook 800 covering PIRQ 1, 2, 4, 8 for onboard</span>
<span class="cm"> *       devices, PIRQ 3 for non-pci(!) soundchip and (untested) PIRQ 6</span>
<span class="cm"> *       for the busbridge to the docking station.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_vlsi_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VLSI router PIRQ escape (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pirq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">read_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_vlsi_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pirq</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VLSI router PIRQ escape (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pirq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="n">pirq</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ServerWorks: PCI interrupts mapped to system IRQ lines through Index</span>
<span class="cm"> * and Redirect I/O registers (0x0c00 and 0x0c01).  The Index register</span>
<span class="cm"> * format is (PCIIRQ## | 0x10), e.g.: PCIIRQ10=0x1a.  The Redirect</span>
<span class="cm"> * register is a straight binary coding of desired PIC IRQ (low nibble).</span>
<span class="cm"> *</span>
<span class="cm"> * The &#39;link&#39; value in the PIRQ table is already in the correct format</span>
<span class="cm"> * for the Index register.  There are some special index values:</span>
<span class="cm"> * 0x00 for ACPI (SCI), 0x01 for USB, 0x02 for IDE0, 0x04 for IDE1,</span>
<span class="cm"> * and 0x03 for SMBus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_serverworks_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">pirq</span><span class="p">,</span> <span class="mh">0xc00</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_serverworks_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">pirq</span><span class="p">,</span> <span class="mh">0xc00</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="mh">0xc01</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Support for AMD756 PCI IRQ Routing</span>
<span class="cm"> * Jhon H. Caicedo &lt;jhcaiced@osso.org.co&gt;</span>
<span class="cm"> * Jun/21/2001 0.2.0 Release, fixed to use &quot;nybble&quot; functions... (jhcaiced)</span>
<span class="cm"> * Jun/19/2001 Alpha Release 0.1.0 (jhcaiced)</span>
<span class="cm"> * The AMD756 pirq rules are nibble-based</span>
<span class="cm"> * offset 0x56 0-3 PIRQA  4-7  PIRQB</span>
<span class="cm"> * offset 0x57 0-3 PIRQC  4-7  PIRQD</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_amd756_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pirq</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">read_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="n">pirq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;AMD756: dev [%04x:%04x], router PIRQ %d get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_amd756_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;AMD756: dev [%04x:%04x], router PIRQ %d set IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pirq</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">write_config_nybble</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="n">pirq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PicoPower PT86C523</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_pico_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">+</span> <span class="p">((</span><span class="n">pirq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="mh">0x24</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">pirq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x26</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_pico_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">+</span> <span class="p">((</span><span class="n">pirq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="mh">0x24</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x26</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pirq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">:</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI_BIOS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_bios_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">pci_get_interrupt_pin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bridge</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pcibios_set_irq_routing</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">intel_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">__initdata</span> <span class="n">pirq_440gx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82443GX_0</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82443GX_2</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="cm">/* 440GX has a proprietary PIRQ router -- don&#39;t use it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev_present</span><span class="p">(</span><span class="n">pirq_440gx</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82371FB_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82371SB_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82371AB_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82371MX</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82443MX_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AA_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AB_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_10</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801CA_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801CA_12</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801DB_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801E_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_82801EB_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ESB_1</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH6_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH6_1</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH7_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH7_1</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH7_30</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH7_31</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_TGP_LPC</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ESB2_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH8_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH8_1</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH8_2</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH8_3</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH8_4</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH9_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH9_1</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH9_2</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH9_3</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH9_4</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH9_5</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_EP80579_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH10_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH10_1</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH10_2</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH10_3</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_PATSBURG_LPC_0</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_INTEL_PATSBURG_LPC_1</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PIIX/ICH&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_piix_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_piix_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="n">PCI_DEVICE_ID_INTEL_5_3400_SERIES_LPC_MIN</span> <span class="o">&amp;&amp;</span> 
	     <span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_INTEL_5_3400_SERIES_LPC_MAX</span><span class="p">)</span> 
	<span class="o">||</span>  <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="n">PCI_DEVICE_ID_INTEL_COUGARPOINT_LPC_MIN</span> <span class="o">&amp;&amp;</span> 
	     <span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_INTEL_COUGARPOINT_LPC_MAX</span><span class="p">)</span>
	<span class="o">||</span>  <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="n">PCI_DEVICE_ID_INTEL_DH89XXCC_LPC_MIN</span> <span class="o">&amp;&amp;</span>
	     <span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_INTEL_DH89XXCC_LPC_MAX</span><span class="p">)</span>
	<span class="o">||</span>  <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="n">PCI_DEVICE_ID_INTEL_PANTHERPOINT_LPC_MIN</span> <span class="o">&amp;&amp;</span>
	     <span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_INTEL_PANTHERPOINT_LPC_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PIIX/ICH&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_piix_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_piix_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">via_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: We should move some of the quirk fixup stuff here */</span>

	<span class="cm">/*</span>
<span class="cm">	 * workarounds for some buggy BIOSes</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_VIA_82C586_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">router</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_82C686</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Asus k7m bios wrongly reports 82C686A</span>
<span class="cm">			 * as 586-compatible</span>
<span class="cm">			 */</span>
			<span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_VIA_82C686</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_8235</span>:
			<span class="cm">/**</span>
<span class="cm">			 * Asus a7v-x bios wrongly reports 8235</span>
<span class="cm">			 * as 586-compatible</span>
<span class="cm">			 */</span>
			<span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_VIA_8235</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_8237</span>:
			<span class="cm">/**</span>
<span class="cm">			 * Asus a7v600 bios wrongly reports 8237</span>
<span class="cm">			 * as 586-compatible</span>
<span class="cm">			 */</span>
			<span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_VIA_8237</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_82C586_0</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VIA&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_via586_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_via586_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_82C596</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_82C686</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_8231</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_8233A</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_8235</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VIA_8237</span>:
		<span class="cm">/* FIXME: add new ones for 8233/5 */</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VIA&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_via_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_via_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">vlsi_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_VLSI_82C534</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VLSI 82C534&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_vlsi_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_vlsi_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">serverworks_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SERVERWORKS_OSB4</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_SERVERWORKS_CSB5</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ServerWorks&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_serverworks_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_serverworks_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">sis_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_SI_503</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SIS&quot;</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_sis_get</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_sis_set</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">cyrix_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_CYRIX_5520</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;NatSemi&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_cyrix_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_cyrix_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">opti_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_OPTI_82C700</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;OPTI&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_opti_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_opti_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">ite_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ITE_IT8330G_0</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ITE&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_ite_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_ite_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">ali_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_AL_M1533</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_AL_M1563</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ALI&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_ali_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_ali_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">amd_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_AMD_VIPER_740B</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AMD756&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_AMD_VIPER_7413</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AMD766&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_AMD_VIPER_7443</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AMD768&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_amd756_get</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_amd756_set</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">pico_router_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">router</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PICOPOWER_PT86C523</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PicoPower PT86C523&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_pico_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_pico_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PICOPOWER_PT86C523BBP</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PicoPower PT86C523 rev. BB+&quot;</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">pirq_pico_get</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_pico_set</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__initdata</span> <span class="k">struct</span> <span class="n">irq_router_handler</span> <span class="n">pirq_routers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">intel_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_AL</span><span class="p">,</span> <span class="n">ali_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ITE</span><span class="p">,</span> <span class="n">ite_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="n">via_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OPTI</span><span class="p">,</span> <span class="n">opti_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SI</span><span class="p">,</span> <span class="n">sis_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CYRIX</span><span class="p">,</span> <span class="n">cyrix_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_VLSI</span><span class="p">,</span> <span class="n">vlsi_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SERVERWORKS</span><span class="p">,</span> <span class="n">serverworks_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_AMD</span><span class="p">,</span> <span class="n">amd_router_probe</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_PICOPOWER</span><span class="p">,</span> <span class="n">pico_router_probe</span> <span class="p">},</span>
	<span class="cm">/* Someone with docs needs to add the ATI Radeon IGP */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_router</span> <span class="n">pirq_router</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pirq_router_dev</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> *	FIXME: should we have an option to say &quot;generic for</span>
<span class="cm"> *	chipset&quot; ?</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">pirq_find_router</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">pirq_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_router_handler</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_BIOS</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Using BIOS for IRQ routing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">pirq_bios_set</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BIOS&quot;</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Default unless a driver reloads it */</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: Attempting to find IRQ router for [%04x:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rtr_vendor</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rtr_device</span><span class="p">);</span>

	<span class="n">pirq_router_dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rtr_bus</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rtr_devfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pirq_router_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: Interrupt router not found at &quot;</span>
			<span class="s">&quot;%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rtr_bus</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rtr_devfn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">pirq_routers</span><span class="p">;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First look for a router match */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rtr_vendor</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&amp;&amp;</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">pirq_router_dev</span><span class="p">,</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rtr_device</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Fall back to a device match */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pirq_router_dev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&amp;&amp;</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">pirq_router_dev</span><span class="p">,</span> <span class="n">pirq_router_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pirq_router_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s IRQ router [%04x:%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pirq_router</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">pirq_router_dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pirq_router_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="cm">/* The device remains referenced for the kernel lifetime */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_info</span> <span class="o">*</span><span class="nf">pirq_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="n">pirq_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_routing_table</span><span class="p">))</span> <span class="o">/</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_info</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">irq_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">info</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">;</span> <span class="n">entries</span><span class="o">--</span><span class="p">;</span> <span class="n">info</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;&amp;</span>
			<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcibios_lookup_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">assign</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">newirq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_router</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pirq_router</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Find IRQ pin */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no interrupt pin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io_apic_assign_pci_irqs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Find IRQ routing entry */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pirq_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">pirq_get_info</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI INT %c not found in routing table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pirq</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">link</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pirq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI INT %c not routed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI INT %c -&gt; PIRQ %02x, mask %04x, excl %04x&quot;</span><span class="p">,</span>
		<span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pirq_table</span><span class="o">-&gt;</span><span class="n">exclusive_irqs</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">pcibios_irq_mask</span><span class="p">;</span>

	<span class="cm">/* Work around broken HP Pavilion Notebooks which assign USB to</span>
<span class="cm">	   IRQ 9 even though it is actually wired to IRQ 11 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">broken_hp_bios_irq9</span> <span class="o">&amp;&amp;</span> <span class="n">pirq</span> <span class="o">==</span> <span class="mh">0x59</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">pirq_router_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* same for Acer Travelmate 360, but with CB and irq 11 -&gt; 10 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acer_tm360_irqrouting</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_O2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pirq</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">pirq_router_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pirq</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the best IRQ to assign: use the one</span>
<span class="cm">	 * reported by the device if possible.</span>
<span class="cm">	 */</span>
	<span class="n">newirq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newirq</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">newirq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_probe</span> <span class="o">&amp;</span> <span class="n">PCI_USE_PIRQ_MASK</span><span class="p">)</span>
			<span class="n">newirq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ %d doesn&#39;t match PIRQ mask &quot;</span>
				 <span class="s">&quot;%#x; try pci=usepirqmask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newirq</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newirq</span> <span class="o">&amp;&amp;</span> <span class="n">assign</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pirq_penalty</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pirq_penalty</span><span class="p">[</span><span class="n">newirq</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="n">can_request_irq</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">))</span>
				<span class="n">newirq</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI INT %c -&gt; newirq %d&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">newirq</span><span class="p">);</span>

	<span class="cm">/* Check if it is hardcoded */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pirq</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">pirq</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;hardcoded&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">pirq_router_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pirq</span><span class="p">))</span> <span class="o">&amp;&amp;</span> \
	<span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">pci_probe</span> <span class="o">&amp;</span> <span class="n">PCI_USE_PIRQ_MASK</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;found&quot;</span><span class="p">;</span>
		<span class="n">eisa_set_level_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newirq</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_CLASS_DISPLAY_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">pirq_router_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pirq</span><span class="p">,</span> <span class="n">newirq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">eisa_set_level_irq</span><span class="p">(</span><span class="n">newirq</span><span class="p">);</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;assigned&quot;</span><span class="p">;</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">newirq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newirq</span> <span class="o">&amp;&amp;</span> <span class="n">mask</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">newirq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;guessed&quot;</span><span class="p">;</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">newirq</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t route interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s PCI INT %c -&gt; IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Update IRQ for all devices with the same pirq value */</span>
	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">dev2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">pirq_get_info</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">link</span> <span class="o">==</span> <span class="n">pirq</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We refuse to override the dev-&gt;irq</span>
<span class="cm">			 * information. Give a warning!</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev2</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&amp;&amp;</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">irq</span> <span class="o">&amp;&amp;</span> \
			<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_probe</span> <span class="o">&amp;</span> <span class="n">PCI_USE_PIRQ_MASK</span><span class="p">)</span> <span class="o">||</span> \
			<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_PCI_MSI</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ routing conflict: &quot;</span>
					 <span class="s">&quot;have IRQ %d, want IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="n">pirq_penalty</span><span class="p">[</span><span class="n">irq</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev2</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sharing IRQ %d with %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">irq</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev2</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">pcibios_fixup_irqs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pin</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: IRQ fixup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the BIOS has set an out of range IRQ number, just</span>
<span class="cm">		 * ignore it.  Also keep track of which IRQ&#39;s are</span>
<span class="cm">		 * already in use.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ignoring bogus IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the IRQ is already assigned to a PCI device,</span>
<span class="cm">		 * ignore its ISA use penalty</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pirq_penalty</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span>
				<span class="n">pirq_penalty</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span>
			<span class="n">pirq_penalty</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pirq_penalty</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io_apic_assign_pci_irqs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Still no IRQ? Try to lookup one...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">pcibios_lookup_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Work around broken HP Pavilion Notebooks which assign USB to</span>
<span class="cm"> * IRQ 9 even though it is actually wired to IRQ 11</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fix_broken_hp_bios_irq9</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">broken_hp_bios_irq9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">broken_hp_bios_irq9</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s detected - fixing broken IRQ routing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Work around broken Acer TravelMate 360 Notebooks which assign</span>
<span class="cm"> * Cardbus to IRQ 11 even though it is actually wired to IRQ 10</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fix_acer_tm360_irqrouting</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acer_tm360_irqrouting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acer_tm360_irqrouting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s detected - fixing broken IRQ routing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">pciirq_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">fix_broken_hp_bios_irq9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP Pavilion N5400 Series Laptop&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">,</span> <span class="s">&quot;GE.M1.03&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_VERSION</span><span class="p">,</span>
				<span class="s">&quot;HP Pavilion Notebook Model GE&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;OmniBook N32N-736&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">fix_acer_tm360_irqrouting</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer TravelMate 36x Laptop&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TravelMate 360&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">pcibios_irq_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: IRQ init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raw_pci_ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dmi_check_system</span><span class="p">(</span><span class="n">pciirq_dmi_table</span><span class="p">);</span>

	<span class="n">pirq_table</span> <span class="o">=</span> <span class="n">pirq_find_routing_table</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_PCI_BIOS</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pirq_table</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pci_probe</span> <span class="o">&amp;</span> <span class="n">PCI_BIOS_IRQ_SCAN</span><span class="p">))</span>
		<span class="n">pirq_table</span> <span class="o">=</span> <span class="n">pcibios_get_irq_routing_table</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pirq_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pirq_peer_trick</span><span class="p">();</span>
		<span class="n">pirq_find_router</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pirq_router</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pirq_table</span><span class="o">-&gt;</span><span class="n">exclusive_irqs</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pirq_table</span><span class="o">-&gt;</span><span class="n">exclusive_irqs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
					<span class="n">pirq_penalty</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re using the I/O APIC, avoid using the PCI IRQ</span>
<span class="cm">		 * routing table</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_apic_assign_pci_irqs</span><span class="p">)</span>
			<span class="n">pirq_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">fixup_irqs</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io_apic_assign_pci_irqs</span> <span class="o">&amp;&amp;</span> <span class="n">pci_routeirq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * PCI IRQ routing is set up by pci_enable_device(), but we</span>
<span class="cm">		 * also do it here in case there are still broken drivers that</span>
<span class="cm">		 * don&#39;t use pci_enable_device().</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Routing PCI interrupts for all devices because </span><span class="se">\&quot;</span><span class="s">pci=routeirq</span><span class="se">\&quot;</span><span class="s"> specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">pirq_enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pirq_penalize_isa_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  If any ISAPnP device reports an IRQ in its list of possible</span>
<span class="cm">	 *  IRQ&#39;s, we try to avoid assigning it to PCI devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span>
			<span class="n">pirq_penalty</span><span class="p">[</span><span class="n">irq</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pirq_penalty</span><span class="p">[</span><span class="n">irq</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pcibios_penalize_isa_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ACPI</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_noirq</span><span class="p">)</span>
		<span class="n">acpi_penalize_isa_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">pirq_penalize_isa_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pirq_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pin</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pcibios_lookup_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_apic_assign_pci_irqs</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io_apic_assign_pci_irqs</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
			<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">temp_dev</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">io_apic_irq_attr</span> <span class="n">irq_attr</span><span class="p">;</span>

			<span class="n">irq</span> <span class="o">=</span> <span class="n">IO_APIC_get_PCI_irq_vector</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
						<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
						<span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_attr</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Busses behind bridges are typically not listed in the MP-table.</span>
<span class="cm">			 * In this case we have to look up the IRQ based on the parent bus,</span>
<span class="cm">			 * parent slot, and pin number. The SMP code detects such bridged</span>
<span class="cm">			 * busses itself so we should get into this branch reliably.</span>
<span class="cm">			 */</span>
			<span class="n">temp_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* go back to the bridge */</span>
				<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>

				<span class="n">pin</span> <span class="o">=</span> <span class="n">pci_swizzle_interrupt_pin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
				<span class="n">irq</span> <span class="o">=</span> <span class="n">IO_APIC_get_PCI_irq_vector</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
						<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
						<span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_attr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using bridge %s &quot;</span>
						 <span class="s">&quot;INT %c to get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">pci_name</span><span class="p">(</span><span class="n">bridge</span><span class="p">),</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
						 <span class="n">irq</span><span class="p">);</span>
				<span class="n">dev</span> <span class="o">=</span> <span class="n">bridge</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">temp_dev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">io_apic_set_pci_routing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">irq_attr</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI-&gt;APIC IRQ transform: &quot;</span>
					 <span class="s">&quot;INT %c -&gt; IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;; probably buggy MP table&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_probe</span> <span class="o">&amp;</span> <span class="n">PCI_BIOS_IRQ_SCAN</span><span class="p">)</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;; please try using pci=biosirq&quot;</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * With IDE legacy devices the IRQ lookup failure is not</span>
<span class="cm">		 * a problem..</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">==</span> <span class="n">PCI_CLASS_STORAGE_IDE</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;</span> <span class="mh">0x5</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t find IRQ for PCI INT %c%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
