<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › pci › olpc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>olpc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Low-level PCI config space access for OLPC systems who lack the VSA</span>
<span class="cm"> * PCI virtualization software.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2006  Advanced Micro Devices, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * The AMD Geode chipset (ie: GX2 processor, cs5536 I/O companion device)</span>
<span class="cm"> * has some I/O functions (display, southbridge, sound, USB HCIs, etc)</span>
<span class="cm"> * that more or less behave like PCI devices, but the hardware doesn&#39;t</span>
<span class="cm"> * directly implement the PCI configuration space headers.  AMD provides</span>
<span class="cm"> * &quot;VSA&quot; (Virtual System Architecture) software that emulates PCI config</span>
<span class="cm"> * space for these devices, by trapping I/O accesses to PCI config register</span>
<span class="cm"> * (CF8/CFC) and running some code in System Management Mode interrupt state.</span>
<span class="cm"> * On the OLPC platform, we don&#39;t want to use that VSA code because</span>
<span class="cm"> * (a) it slows down suspend/resume, and (b) recompiling it requires special</span>
<span class="cm"> * compilers that are hard to get.  So instead of letting the complex VSA</span>
<span class="cm"> * code simulate the PCI config registers for the on-chip devices, we</span>
<span class="cm"> * just simulate them the easy way, by inserting the code into the</span>
<span class="cm"> * pci_write_config and pci_read_config path.  Most of the config registers</span>
<span class="cm"> * are read-only anyway, so the bulk of the simulation is just table lookup.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;asm/olpc.h&gt;</span>
<span class="cp">#include &lt;asm/geode.h&gt;</span>
<span class="cp">#include &lt;asm/pci_x86.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * In the tables below, the first two line (8 longwords) are the</span>
<span class="cm"> * size masks that are used when the higher level PCI code determines</span>
<span class="cm"> * the size of the region by writing ~0 to a base address register</span>
<span class="cm"> * and reading back the result.</span>
<span class="cm"> *</span>
<span class="cm"> * The following lines are the values that are read during normal</span>
<span class="cm"> * PCI config access cycles, i.e. not after just having written</span>
<span class="cm"> * ~0 to a base address register.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">lxnb_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* dev 1 function 0 - devfn = 8 */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x281022</span><span class="p">,</span> <span class="mh">0x2200005</span><span class="p">,</span> <span class="mh">0x6000021</span><span class="p">,</span> <span class="mh">0x80f808</span><span class="p">,</span>	<span class="cm">/* AMD Vendor ID */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>   <span class="cm">/* No virtual registers, hence no BAR */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x28100b</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">gxnb_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* dev 1 function 0 - devfn = 8 */</span>
	<span class="mh">0xfffffffd</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x28100b</span><span class="p">,</span> <span class="mh">0x2200005</span><span class="p">,</span> <span class="mh">0x6000021</span><span class="p">,</span> <span class="mh">0x80f808</span><span class="p">,</span>	<span class="cm">/* NSC Vendor ID */</span>
	<span class="mh">0xac1d</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>  <span class="cm">/* I/O BAR - base of virtual registers */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x28100b</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">lxfb_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* dev 1 function 1 - devfn = 9 */</span>
	<span class="mh">0xff000008</span><span class="p">,</span> <span class="mh">0xffffc000</span><span class="p">,</span> <span class="mh">0xffffc000</span><span class="p">,</span> <span class="mh">0xffffc000</span><span class="p">,</span>
	<span class="mh">0xffffc000</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x20811022</span><span class="p">,</span> <span class="mh">0x2200003</span><span class="p">,</span> <span class="mh">0x3000000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>		<span class="cm">/* AMD Vendor ID */</span>
	<span class="mh">0xfd000000</span><span class="p">,</span> <span class="mh">0xfe000000</span><span class="p">,</span> <span class="mh">0xfe004000</span><span class="p">,</span> <span class="mh">0xfe008000</span><span class="p">,</span> <span class="cm">/* FB, GP, VG, DF */</span>
	<span class="mh">0xfe00c000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x30100b</span><span class="p">,</span>		<span class="cm">/* VIP */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x10e</span><span class="p">,</span>	   <span class="cm">/* INTA, IRQ14 for graphics accel */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x3d0</span><span class="p">,</span>	<span class="mh">0x3c0</span><span class="p">,</span>	<span class="mh">0xa0000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	    <span class="cm">/* VG IO, VG IO, EGA FB, MONO FB */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">gxfb_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* dev 1 function 1 - devfn = 9 */</span>
	<span class="mh">0xff800008</span><span class="p">,</span> <span class="mh">0xffffc000</span><span class="p">,</span> <span class="mh">0xffffc000</span><span class="p">,</span> <span class="mh">0xffffc000</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x30100b</span><span class="p">,</span> <span class="mh">0x2200003</span><span class="p">,</span> <span class="mh">0x3000000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>		<span class="cm">/* NSC Vendor ID */</span>
	<span class="mh">0xfd000000</span><span class="p">,</span> <span class="mh">0xfe000000</span><span class="p">,</span> <span class="mh">0xfe004000</span><span class="p">,</span> <span class="mh">0xfe008000</span><span class="p">,</span>	<span class="cm">/* FB, GP, VG, DF */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x30100b</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x3d0</span><span class="p">,</span>	<span class="mh">0x3c0</span><span class="p">,</span>	<span class="mh">0xa0000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>  	    <span class="cm">/* VG IO, VG IO, EGA FB, MONO FB */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">aes_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* dev 1 function 2 - devfn = 0xa */</span>
	<span class="mh">0xffffc000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x20821022</span><span class="p">,</span> <span class="mh">0x2a00006</span><span class="p">,</span> <span class="mh">0x10100000</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span>		<span class="cm">/* NSC Vendor ID */</span>
	<span class="mh">0xfe010000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* AES registers */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x20821022</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">isa_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* dev f function 0 - devfn = 78 */</span>
	<span class="mh">0xfffffff9</span><span class="p">,</span> <span class="mh">0xffffff01</span><span class="p">,</span> <span class="mh">0xffffffc1</span><span class="p">,</span> <span class="mh">0xffffffe1</span><span class="p">,</span>
	<span class="mh">0xffffff81</span><span class="p">,</span> <span class="mh">0xffffffc1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x20901022</span><span class="p">,</span> <span class="mh">0x2a00049</span><span class="p">,</span> <span class="mh">0x6010003</span><span class="p">,</span> <span class="mh">0x802000</span><span class="p">,</span>
	<span class="mh">0x18b1</span><span class="p">,</span>	<span class="mh">0x1001</span><span class="p">,</span>	<span class="mh">0x1801</span><span class="p">,</span>	<span class="mh">0x1881</span><span class="p">,</span>	<span class="cm">/* SMB-8   GPIO-256 MFGPT-64  IRQ-32 */</span>
	<span class="mh">0x1401</span><span class="p">,</span>	<span class="mh">0x1841</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x20901022</span><span class="p">,</span>		<span class="cm">/* PMS-128 ACPI-64 */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0xaa5b</span><span class="p">,</span>			<span class="cm">/* IRQ steering */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">ac97_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* dev f function 3 - devfn = 7b */</span>
	<span class="mh">0xffffff81</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x20931022</span><span class="p">,</span> <span class="mh">0x2a00041</span><span class="p">,</span> <span class="mh">0x4010001</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x1481</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* I/O BAR-128 */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x20931022</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x205</span><span class="p">,</span>			<span class="cm">/* IntB, IRQ5 */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">ohci_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* dev f function 4 - devfn = 7c */</span>
	<span class="mh">0xfffff000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x20941022</span><span class="p">,</span> <span class="mh">0x2300006</span><span class="p">,</span> <span class="mh">0xc031002</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0xfe01a000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* MEMBAR-1000 */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x20941022</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x40a</span><span class="p">,</span>			<span class="cm">/* CapPtr INT-D, IRQA */</span>
	<span class="mh">0xc8020001</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="cm">/* Capabilities - 40 is R/O,</span>
<span class="cm">					   44 is mask 8103 (power control) */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">ehci_hdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* dev f function 4 - devfn = 7d */</span>
	<span class="mh">0xfffff000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>

	<span class="mh">0x20951022</span><span class="p">,</span> <span class="mh">0x2300006</span><span class="p">,</span> <span class="mh">0xc032002</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="mh">0xfe01b000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* MEMBAR-1000 */</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x20951022</span><span class="p">,</span>
	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x40</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x40a</span><span class="p">,</span>			<span class="cm">/* CapPtr INT-D, IRQA */</span>
	<span class="mh">0xc8020001</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="cm">/* Capabilities - 40 is R/O, 44 is</span>
<span class="cm">					   mask 8103 (power control) */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	0x1,	0x40080000, 0x0, 0x0,	/* EECP - see EHCI spec section 2.1.7 */</span>
<span class="cp">#endif</span>
	<span class="mh">0x01000001</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="cm">/* EECP - see EHCI spec section 2.1.7 */</span>
	<span class="mh">0x2020</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="mh">0x0</span><span class="p">,</span>	<span class="cm">/* (EHCI page 8) 60 SBRN (R/O),</span>
<span class="cm">					   61 FLADJ (R/W), PORTWAKECAP  */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">ff_loc</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">zero_loc</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bar_probing</span><span class="p">;</span>		<span class="cm">/* Set after a write of ~0 to a BAR */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">is_lx</span><span class="p">;</span>

<span class="cp">#define NB_SLOT 0x1	</span><span class="cm">/* Northbridge - GX chip - Device 1 */</span><span class="cp"></span>
<span class="cp">#define SB_SLOT 0xf	</span><span class="cm">/* Southbridge - CS5536 chip - Device F */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_simulated</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">NB_SLOT</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">SB_SLOT</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="nf">hdr_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is a little bit tricky.  The header maps consist of</span>
<span class="cm">	 * 0x20 bytes of size masks, followed by 0x70 bytes of header data.</span>
<span class="cm">	 * In the normal case, when not probing a BAR&#39;s size, we want</span>
<span class="cm">	 * to access the header data, so we add 0x20 to the reg offset,</span>
<span class="cm">	 * thus skipping the size mask area.</span>
<span class="cm">	 * In the BAR probing case, we want to access the size mask for</span>
<span class="cm">	 * the BAR, so we subtract 0x10 (the config header offset for</span>
<span class="cm">	 * BAR0), and don&#39;t skip the size mask area.</span>
<span class="cm">	 */</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">bar_probing</span> <span class="o">?</span> <span class="o">-</span><span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">bar_probing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_olpc_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">seg</span><span class="p">);</span>

	<span class="cm">/* Use the hardware mechanism for non-simulated devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_simulated</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">pci_direct_conf1</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No device has config registers past 0x70, so we save table space</span>
<span class="cm">	 * by not storing entries for the nonexistent registers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x70</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zero_loc</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span>  <span class="mh">0x8</span>:
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hdr_addr</span><span class="p">(</span><span class="n">is_lx</span> <span class="o">?</span> <span class="n">lxnb_hdr</span> <span class="o">:</span> <span class="n">gxnb_hdr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span>  <span class="mh">0x9</span>:
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hdr_addr</span><span class="p">(</span><span class="n">is_lx</span> <span class="o">?</span> <span class="n">lxfb_hdr</span> <span class="o">:</span> <span class="n">gxfb_hdr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span>  <span class="mh">0xa</span>:
			<span class="n">addr</span> <span class="o">=</span> <span class="n">is_lx</span> <span class="o">?</span> <span class="n">hdr_addr</span><span class="p">(</span><span class="n">aes_hdr</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">ff_loc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x78</span>:
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hdr_addr</span><span class="p">(</span><span class="n">isa_hdr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x7b</span>:
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hdr_addr</span><span class="p">(</span><span class="n">ac97_hdr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x7c</span>:
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hdr_addr</span><span class="p">(</span><span class="n">ohci_hdr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x7d</span>:
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hdr_addr</span><span class="p">(</span><span class="n">ehci_hdr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ff_loc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_olpc_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">seg</span><span class="p">);</span>

	<span class="cm">/* Use the hardware mechanism for non-simulated devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_simulated</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">pci_direct_conf1</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* XXX we may want to extend this to simulate EHCI power management */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mostly we just discard writes, but if the write is a size probe</span>
<span class="cm">	 * (i.e. writing ~0 to a BAR), we remember it and arrange to return</span>
<span class="cm">	 * the appropriate size mask on the next read.  This is cheating</span>
<span class="cm">	 * to some extent, because it depends on the fact that the next</span>
<span class="cm">	 * access after such a write will always be a read to the same BAR.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x2c</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* write is to a BAR */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">bar_probing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No warning on writes to ROM BAR, CMD, LATENCY_TIMER,</span>
<span class="cm">		 * CACHE_LINE_SIZE, or PM registers.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">PCI_ROM_ADDRESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x44</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;OLPC PCI: Config write to devfn&quot;</span>
				<span class="s">&quot; %x reg %x value %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_raw_ops</span> <span class="n">pci_olpc_conf</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>	<span class="n">pci_olpc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pci_olpc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_olpc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Using configuration type OLPC XO-1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">raw_pci_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_olpc_conf</span><span class="p">;</span>
	<span class="n">is_lx</span> <span class="o">=</span> <span class="n">is_geode_lx</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
