<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › math-emu › fpu_entry.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fpu_entry.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------------------------------------------------------------+</span>
<span class="cm"> |  fpu_entry.c                                                              |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> | The entry functions for wm-FPU-emu                                        |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> | Copyright (C) 1992,1993,1994,1996,1997                                    |</span>
<span class="cm"> |                  W. Metzenthen, 22 Parker St, Ormond, Vic 3163, Australia |</span>
<span class="cm"> |                  E-mail   billm@suburbia.net                              |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> | See the files &quot;README&quot; and &quot;COPYING&quot; for further copyright and warranty   |</span>
<span class="cm"> | information.                                                              |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> +---------------------------------------------------------------------------*/</span>

<span class="cm">/*---------------------------------------------------------------------------+</span>
<span class="cm"> | Note:                                                                     |</span>
<span class="cm"> |    The file contains code which accesses user memory.                     |</span>
<span class="cm"> |    Emulator static data may change when user memory is accessed, due to   |</span>
<span class="cm"> |    other processes using the emulator while swapping is in progress.      |</span>
<span class="cm"> +---------------------------------------------------------------------------*/</span>

<span class="cm">/*---------------------------------------------------------------------------+</span>
<span class="cm"> | math_emulate(), restore_i387_soft() and save_i387_soft() are the only     |</span>
<span class="cm"> | entry points for wm-FPU-emu.                                              |</span>
<span class="cm"> +---------------------------------------------------------------------------*/</span>

<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/regset.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>
<span class="cp">#include &lt;asm/desc.h&gt;</span>
<span class="cp">#include &lt;asm/user.h&gt;</span>
<span class="cp">#include &lt;asm/i387.h&gt;</span>

<span class="cp">#include &quot;fpu_system.h&quot;</span>
<span class="cp">#include &quot;fpu_emu.h&quot;</span>
<span class="cp">#include &quot;exception.h&quot;</span>
<span class="cp">#include &quot;control_w.h&quot;</span>
<span class="cp">#include &quot;status_w.h&quot;</span>

<span class="cp">#define __BAD__ FPU_illegal	</span><span class="cm">/* Illegal on an 80486, causes SIGILL */</span><span class="cp"></span>

<span class="cp">#ifndef NO_UNDOC_CODE		</span><span class="cm">/* Un-documented FPU op-codes supported by default. */</span><span class="cp"></span>

<span class="cm">/* WARNING: These codes are not documented by Intel in their 80486 manual</span>
<span class="cm">   and may not work on FPU clones or later Intel FPUs. */</span>

<span class="cm">/* Changes to support the un-doc codes provided by Linus Torvalds. */</span>

<span class="cp">#define _d9_d8_ fstp_i		</span><span class="cm">/* unofficial code (19) */</span><span class="cp"></span>
<span class="cp">#define _dc_d0_ fcom_st		</span><span class="cm">/* unofficial code (14) */</span><span class="cp"></span>
<span class="cp">#define _dc_d8_ fcompst		</span><span class="cm">/* unofficial code (1c) */</span><span class="cp"></span>
<span class="cp">#define _dd_c8_ fxch_i		</span><span class="cm">/* unofficial code (0d) */</span><span class="cp"></span>
<span class="cp">#define _de_d0_ fcompst		</span><span class="cm">/* unofficial code (16) */</span><span class="cp"></span>
<span class="cp">#define _df_c0_ ffreep		</span><span class="cm">/* unofficial code (07) ffree + pop */</span><span class="cp"></span>
<span class="cp">#define _df_c8_ fxch_i		</span><span class="cm">/* unofficial code (0f) */</span><span class="cp"></span>
<span class="cp">#define _df_d0_ fstp_i		</span><span class="cm">/* unofficial code (17) */</span><span class="cp"></span>
<span class="cp">#define _df_d8_ fstp_i		</span><span class="cm">/* unofficial code (1f) */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">FUNC</span> <span class="k">const</span> <span class="n">st_instr_table</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">fadd__</span><span class="p">,</span> <span class="n">fld_i_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fadd_i</span><span class="p">,</span> <span class="n">ffree_</span><span class="p">,</span> <span class="n">faddp_</span><span class="p">,</span> <span class="n">_df_c0_</span><span class="p">,</span>
	<span class="n">fmul__</span><span class="p">,</span> <span class="n">fxch_i</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fmul_i</span><span class="p">,</span> <span class="n">_dd_c8_</span><span class="p">,</span> <span class="n">fmulp_</span><span class="p">,</span> <span class="n">_df_c8_</span><span class="p">,</span>
	<span class="n">fcom_st</span><span class="p">,</span> <span class="n">fp_nop</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">_dc_d0_</span><span class="p">,</span> <span class="n">fst_i_</span><span class="p">,</span> <span class="n">_de_d0_</span><span class="p">,</span> <span class="n">_df_d0_</span><span class="p">,</span>
	<span class="n">fcompst</span><span class="p">,</span> <span class="n">_d9_d8_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">_dc_d8_</span><span class="p">,</span> <span class="n">fstp_i</span><span class="p">,</span> <span class="n">fcompp</span><span class="p">,</span> <span class="n">_df_d8_</span><span class="p">,</span>
	<span class="n">fsub__</span><span class="p">,</span> <span class="n">FPU_etc</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">finit_</span><span class="p">,</span> <span class="n">fsubri</span><span class="p">,</span> <span class="n">fucom_</span><span class="p">,</span> <span class="n">fsubrp</span><span class="p">,</span> <span class="n">fstsw_</span><span class="p">,</span>
	<span class="n">fsubr_</span><span class="p">,</span> <span class="n">fconst</span><span class="p">,</span> <span class="n">fucompp</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fsub_i</span><span class="p">,</span> <span class="n">fucomp</span><span class="p">,</span> <span class="n">fsubp_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
	<span class="n">fdiv__</span><span class="p">,</span> <span class="n">FPU_triga</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fdivri</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fdivrp</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
	<span class="n">fdivr_</span><span class="p">,</span> <span class="n">FPU_trigb</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fdiv_i</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fdivp_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#else </span><span class="cm">/* Support only documented FPU op-codes */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">FUNC</span> <span class="k">const</span> <span class="n">st_instr_table</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">fadd__</span><span class="p">,</span> <span class="n">fld_i_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fadd_i</span><span class="p">,</span> <span class="n">ffree_</span><span class="p">,</span> <span class="n">faddp_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
	<span class="n">fmul__</span><span class="p">,</span> <span class="n">fxch_i</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fmul_i</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fmulp_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
	<span class="n">fcom_st</span><span class="p">,</span> <span class="n">fp_nop</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fst_i_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
	<span class="n">fcompst</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fstp_i</span><span class="p">,</span> <span class="n">fcompp</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
	<span class="n">fsub__</span><span class="p">,</span> <span class="n">FPU_etc</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">finit_</span><span class="p">,</span> <span class="n">fsubri</span><span class="p">,</span> <span class="n">fucom_</span><span class="p">,</span> <span class="n">fsubrp</span><span class="p">,</span> <span class="n">fstsw_</span><span class="p">,</span>
	<span class="n">fsubr_</span><span class="p">,</span> <span class="n">fconst</span><span class="p">,</span> <span class="n">fucompp</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fsub_i</span><span class="p">,</span> <span class="n">fucomp</span><span class="p">,</span> <span class="n">fsubp_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
	<span class="n">fdiv__</span><span class="p">,</span> <span class="n">FPU_triga</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fdivri</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fdivrp</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
	<span class="n">fdivr_</span><span class="p">,</span> <span class="n">FPU_trigb</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fdiv_i</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span> <span class="n">fdivp_</span><span class="p">,</span> <span class="n">__BAD__</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* NO_UNDOC_CODE */</span><span class="cp"></span>

<span class="cp">#define _NONE_ 0		</span><span class="cm">/* Take no special action */</span><span class="cp"></span>
<span class="cp">#define _REG0_ 1		</span><span class="cm">/* Need to check for not empty st(0) */</span><span class="cp"></span>
<span class="cp">#define _REGI_ 2		</span><span class="cm">/* Need to check for not empty st(0) and st(rm) */</span><span class="cp"></span>
<span class="cp">#define _REGi_ 0		</span><span class="cm">/* Uses st(rm) */</span><span class="cp"></span>
<span class="cp">#define _PUSH_ 3		</span><span class="cm">/* Need to check for space to push onto stack */</span><span class="cp"></span>
<span class="cp">#define _null_ 4		</span><span class="cm">/* Function illegal or not implemented */</span><span class="cp"></span>
<span class="cp">#define _REGIi 5		</span><span class="cm">/* Uses st(0) and st(rm), result to st(rm) */</span><span class="cp"></span>
<span class="cp">#define _REGIp 6		</span><span class="cm">/* Uses st(0) and st(rm), result to st(rm) then pop */</span><span class="cp"></span>
<span class="cp">#define _REGIc 0		</span><span class="cm">/* Compare st(0) and st(rm) */</span><span class="cp"></span>
<span class="cp">#define _REGIn 0		</span><span class="cm">/* Uses st(0) and st(rm), but handle checks later */</span><span class="cp"></span>

<span class="cp">#ifndef NO_UNDOC_CODE</span>

<span class="cm">/* Un-documented FPU op-codes supported by default. (see above) */</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="k">const</span> <span class="n">type_table</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_REGi_</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_REGi_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_REGIn</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_REGI_</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_REGI_</span><span class="p">,</span>
	<span class="n">_REGIc</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REG0_</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REG0_</span><span class="p">,</span>
	<span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REG0_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REG0_</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REG0_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_null_</span>
<span class="p">};</span>

<span class="cp">#else </span><span class="cm">/* Support only documented FPU op-codes */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">u_char</span> <span class="k">const</span> <span class="n">type_table</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_REGi_</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_REGIn</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span>
	<span class="n">_REGIc</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REG0_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span>
	<span class="n">_REGIc</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REG0_</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_REGIc</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span>
	<span class="n">_REGI_</span><span class="p">,</span> <span class="n">_NONE_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIi</span><span class="p">,</span> <span class="n">_null_</span><span class="p">,</span> <span class="n">_REGIp</span><span class="p">,</span> <span class="n">_null_</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* NO_UNDOC_CODE */</span><span class="cp"></span>

<span class="cp">#ifdef RE_ENTRANT_CHECKING</span>
<span class="n">u_char</span> <span class="n">emulating</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* RE_ENTRANT_CHECKING */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">valid_prefix</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">Byte</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">**</span> <span class="n">fpu_eip</span><span class="p">,</span>
			<span class="n">overrides</span> <span class="o">*</span> <span class="n">override</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">math_emulate</span><span class="p">(</span><span class="k">struct</span> <span class="n">math_emu_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">FPU_modrm</span><span class="p">,</span> <span class="n">byte1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">fpu_addr_modes</span> <span class="n">addr_modes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unmasked</span><span class="p">;</span>
	<span class="n">FPU_REG</span> <span class="n">loaded_data</span><span class="p">;</span>
	<span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">loaded_tag</span><span class="p">,</span> <span class="n">st0_tag</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address</span> <span class="n">data_sel_off</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address</span> <span class="n">entry_sel_off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Initialized to stop compiler warnings */</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">code_descriptor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">used_math</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_fpu</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">do_group_exit</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef RE_ENTRANT_CHECKING</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emulating</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ERROR: wm-FPU-emu is not RE-ENTRANT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* RE_ENTRANT_CHECKING */</span><span class="cp"></span>

	<span class="n">FPU_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">FPU_ORIG_EIP</span> <span class="o">=</span> <span class="n">FPU_EIP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">FPU_EFLAGS</span> <span class="o">&amp;</span> <span class="mh">0x00020000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Virtual 8086 mode */</span>
		<span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">=</span> <span class="n">VM86</span><span class="p">;</span>
		<span class="n">FPU_EIP</span> <span class="o">+=</span> <span class="n">code_base</span> <span class="o">=</span> <span class="n">FPU_CS</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">code_limit</span> <span class="o">=</span> <span class="n">code_base</span> <span class="o">+</span> <span class="mh">0xffff</span><span class="p">;</span>	<span class="cm">/* Assumes code_base &lt;= 0xffff0000 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">FPU_CS</span> <span class="o">==</span> <span class="n">__USER_CS</span> <span class="o">&amp;&amp;</span> <span class="n">FPU_DS</span> <span class="o">==</span> <span class="n">__USER_DS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">FPU_CS</span> <span class="o">==</span> <span class="n">__KERNEL_CS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;math_emulate: %04x:%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FPU_CS</span><span class="p">,</span> <span class="n">FPU_EIP</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Math emulation needed in kernel&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">FPU_CS</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Must be in the LDT */</span>
			<span class="cm">/* Can only handle segmented addressing via the LDT</span>
<span class="cm">			   for now, and it must be 16 bit */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FPU emulator: Unsupported addressing mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">math_abort</span><span class="p">(</span><span class="n">FPU_info</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">code_descriptor</span> <span class="o">=</span> <span class="n">LDT_DESCRIPTOR</span><span class="p">(</span><span class="n">FPU_CS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SEG_D_SIZE</span><span class="p">(</span><span class="n">code_descriptor</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* The above test may be wrong, the book is not clear */</span>
			<span class="cm">/* Segmented 32 bit protected mode */</span>
			<span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">=</span> <span class="n">SEG32</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* 16 bit protected mode */</span>
			<span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">=</span> <span class="n">PM16</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">FPU_EIP</span> <span class="o">+=</span> <span class="n">code_base</span> <span class="o">=</span> <span class="n">SEG_BASE_ADDR</span><span class="p">(</span><span class="n">code_descriptor</span><span class="p">);</span>
		<span class="n">code_limit</span> <span class="o">=</span> <span class="n">code_base</span>
		    <span class="o">+</span> <span class="p">(</span><span class="n">SEG_LIMIT</span><span class="p">(</span><span class="n">code_descriptor</span><span class="p">)</span> <span class="o">+</span>
		       <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SEG_GRANULARITY</span><span class="p">(</span><span class="n">code_descriptor</span><span class="p">)</span>
		    <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code_limit</span> <span class="o">&lt;</span> <span class="n">code_base</span><span class="p">)</span>
			<span class="n">code_limit</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FPU_lookahead</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">FPU_EFLAGS</span> <span class="o">&amp;</span> <span class="n">X86_EFLAGS_TF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_prefix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">byte1</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FPU_EIP</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">override</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;FPU emulator: Unknown prefix byte 0x%02x, probably due to</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;FPU emulator: self-modifying code! (emulation impossible)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">byte1</span><span class="p">);</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_INTERNAL</span> <span class="o">|</span> <span class="mh">0x126</span><span class="p">);</span>
		<span class="n">math_abort</span><span class="p">(</span><span class="n">FPU_info</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">do_another_FPU_instruction:</span>

	<span class="n">no_ip_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">FPU_EIP</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* We have fetched the prefix and first code bytes. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This checks for the minimum instruction bytes.</span>
<span class="cm">		   We also need to check any extra (address mode) code access. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FPU_EIP</span> <span class="o">&gt;</span> <span class="n">code_limit</span><span class="p">)</span>
			<span class="n">math_abort</span><span class="p">(</span><span class="n">FPU_info</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">byte1</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xd8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte1</span> <span class="o">==</span> <span class="n">FWAIT_OPCODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">partial_status</span> <span class="o">&amp;</span> <span class="n">SW_Summary</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_the_FPU_interrupt</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">FPU_fwait_done</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef PARANOID</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_INTERNAL</span> <span class="o">|</span> <span class="mh">0x128</span><span class="p">);</span>
		<span class="n">math_abort</span><span class="p">(</span><span class="n">FPU_info</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PARANOID */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_code_access_ok</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">FPU_modrm</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">FPU_EIP</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
	<span class="n">FPU_EIP</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">partial_status</span> <span class="o">&amp;</span> <span class="n">SW_Summary</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ignore the error for now if the current instruction is a no-wait</span>
<span class="cm">		   control instruction */</span>
		<span class="cm">/* The 80486 manual contradicts itself on this topic,</span>
<span class="cm">		   but a real 80486 uses the following instructions:</span>
<span class="cm">		   fninit, fnstenv, fnsave, fnstsw, fnstenv, fnclex.</span>
<span class="cm">		 */</span>
		<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">FPU_modrm</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">byte1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((((</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0xf803</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xe003</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* fnclex, fninit, fnstsw */</span>
		       <span class="p">(((</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x3003</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3001</span><span class="p">)</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* fnsave, fnstcw, fnstenv,</span>
<span class="cm">							   fnstsw */</span>
			<span class="p">((</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xc000</span><span class="p">)))))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *  We need to simulate the action of the kernel to FPU</span>
<span class="cm">			 *  interrupts here.</span>
<span class="cm">			 */</span>
		      <span class="nl">do_the_FPU_interrupt:</span>

			<span class="n">FPU_EIP</span> <span class="o">=</span> <span class="n">FPU_ORIG_EIP</span><span class="p">;</span>	<span class="cm">/* Point to current FPU instruction. */</span>

			<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">trap_nr</span> <span class="o">=</span> <span class="n">X86_TRAP_MF</span><span class="p">;</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">entry_sel_off</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">FPU_ORIG_EIP</span><span class="p">;</span>
	<span class="n">entry_sel_off</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">FPU_CS</span><span class="p">;</span>
	<span class="n">entry_sel_off</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">FPU_modrm</span><span class="p">;</span>
	<span class="n">entry_sel_off</span><span class="p">.</span><span class="n">empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">FPU_rm</span> <span class="o">=</span> <span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FPU_modrm</span> <span class="o">&lt;</span> <span class="mo">0300</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All of these instructions use the mod/rm byte to get a data address */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">&amp;</span> <span class="n">SIXTEEN</span><span class="p">)</span>
		    <span class="o">^</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">override</span><span class="p">.</span><span class="n">address_size</span> <span class="o">==</span> <span class="n">ADDR_SIZE_PREFIX</span><span class="p">))</span>
			<span class="n">data_address</span> <span class="o">=</span>
			    <span class="n">FPU_get_address_16</span><span class="p">(</span><span class="n">FPU_modrm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FPU_EIP</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">data_sel_off</span><span class="p">,</span> <span class="n">addr_modes</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">data_address</span> <span class="o">=</span>
			    <span class="n">FPU_get_address</span><span class="p">(</span><span class="n">FPU_modrm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FPU_EIP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_sel_off</span><span class="p">,</span>
					    <span class="n">addr_modes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FPU_EIP</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">code_limit</span><span class="p">)</span>
				<span class="n">math_abort</span><span class="p">(</span><span class="n">FPU_info</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">byte1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status1</span> <span class="o">=</span> <span class="n">partial_status</span><span class="p">;</span>

			<span class="n">st0_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">st0_tag</span> <span class="o">=</span> <span class="n">FPU_gettag0</span><span class="p">();</span>

			<span class="cm">/* Stack underflow has priority */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NOT_EMPTY_ST0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">&amp;</span> <span class="n">PROTECTED</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* This table works for 16 and 32 bit protected mode */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">access_limit</span> <span class="o">&lt;</span>
					    <span class="n">data_sizes_16</span><span class="p">[(</span><span class="n">byte1</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">])</span>
						<span class="n">math_abort</span><span class="p">(</span><span class="n">FPU_info</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">unmasked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Do this here to stop compiler warnings. */</span>
				<span class="k">switch</span> <span class="p">((</span><span class="n">byte1</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">unmasked</span> <span class="o">=</span>
					    <span class="n">FPU_load_single</span><span class="p">((</span><span class="kt">float</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
							    <span class="n">data_address</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">);</span>
					<span class="n">loaded_tag</span> <span class="o">=</span> <span class="n">unmasked</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
					<span class="n">unmasked</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">loaded_tag</span> <span class="o">=</span>
					    <span class="n">FPU_load_int32</span><span class="p">((</span><span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
							   <span class="n">data_address</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">unmasked</span> <span class="o">=</span>
					    <span class="n">FPU_load_double</span><span class="p">((</span><span class="kt">double</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
							    <span class="n">data_address</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">);</span>
					<span class="n">loaded_tag</span> <span class="o">=</span> <span class="n">unmasked</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
					<span class="n">unmasked</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">3</span>:
				<span class="nl">default:</span>	<span class="cm">/* Used here to suppress gcc warnings. */</span>
					<span class="n">loaded_tag</span> <span class="o">=</span>
					    <span class="n">FPU_load_int16</span><span class="p">((</span><span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
							   <span class="n">data_address</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* No more access to user memory, it is safe</span>
<span class="cm">				   to use static data now */</span>

				<span class="cm">/* NaN operands have the next priority. */</span>
				<span class="cm">/* We have to delay looking at st(0) until after</span>
<span class="cm">				   loading the data, because that data might contain an SNaN */</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isNaN</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">))</span>
				    <span class="o">||</span> <span class="p">((</span><span class="n">loaded_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">isNaN</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">)))</span> <span class="p">{</span>
					<span class="cm">/* Restore the status word; we might have loaded a</span>
<span class="cm">					   denormal. */</span>
					<span class="n">partial_status</span> <span class="o">=</span> <span class="n">status1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* fcom or fcomp */</span>
						<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
						<span class="n">setcc</span><span class="p">(</span><span class="n">SW_C3</span> <span class="o">|</span> <span class="n">SW_C2</span> <span class="o">|</span> <span class="n">SW_C0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span>
							<span class="n">CW_Invalid</span><span class="p">))</span>
							<span class="n">FPU_pop</span><span class="p">();</span>	<span class="cm">/* fcomp, masked, so we pop. */</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">loaded_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span>
							<span class="n">loaded_tag</span> <span class="o">=</span>
							    <span class="n">FPU_Special</span>
							    <span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">);</span>
<span class="cp">#ifdef PECULIAR_486</span>
						<span class="cm">/* This is not really needed, but gives behaviour</span>
<span class="cm">						   identical to an 80486 */</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span>
							<span class="cm">/* fdiv or fsub */</span>
							<span class="n">real_2op_NaN</span>
							    <span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span>
							     <span class="n">loaded_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							     <span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">);</span>
						<span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>
							<span class="cm">/* fadd, fdivr, fmul, or fsubr */</span>
							<span class="n">real_2op_NaN</span>
							    <span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span>
							     <span class="n">loaded_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							     <span class="n">st0_ptr</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">goto</span> <span class="n">reg_mem_instr_done</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">unmasked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Is not a comparison instruction. */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x38</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* fdivr */</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Zero</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						    <span class="p">((</span><span class="n">loaded_tag</span> <span class="o">==</span> <span class="n">TAG_Valid</span><span class="p">)</span>
						     <span class="o">||</span> <span class="p">(</span><span class="n">loaded_tag</span> <span class="o">==</span>
							 <span class="n">TAG_Special</span>
							 <span class="o">&amp;&amp;</span>
							 <span class="n">isdenormal</span>
							 <span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">))))</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">FPU_divide_by_zero</span>
							    <span class="p">(</span><span class="mi">0</span><span class="p">,</span>
							     <span class="n">getsign</span>
							     <span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">))</span>
							    <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="cm">/* We use the fact here that the unmasked</span>
<span class="cm">								   exception in the loaded data was for a</span>
<span class="cm">								   denormal operand */</span>
								<span class="cm">/* Restore the state of the denormal op bit */</span>
								<span class="n">partial_status</span>
								    <span class="o">&amp;=</span>
								    <span class="o">~</span><span class="n">SW_Denorm_Op</span><span class="p">;</span>
								<span class="n">partial_status</span>
								    <span class="o">|=</span>
								    <span class="n">status1</span> <span class="o">&amp;</span>
								    <span class="n">SW_Denorm_Op</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span>
								<span class="n">setsign</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span>
									<span class="n">getsign</span>
									<span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">));</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">goto</span> <span class="n">reg_mem_instr_done</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">switch</span> <span class="p">((</span><span class="n">FPU_modrm</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* fadd */</span>
					<span class="n">clear_C1</span><span class="p">();</span>
					<span class="n">FPU_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span> <span class="n">loaded_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">control_word</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* fmul */</span>
					<span class="n">clear_C1</span><span class="p">();</span>
					<span class="n">FPU_mul</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span> <span class="n">loaded_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">control_word</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* fcom */</span>
					<span class="n">FPU_compare_st_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span>
							    <span class="n">loaded_tag</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* fcomp */</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FPU_compare_st_data</span>
					    <span class="p">(</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span> <span class="n">loaded_tag</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unmasked</span><span class="p">)</span>
						<span class="n">FPU_pop</span><span class="p">();</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* fsub */</span>
					<span class="n">clear_C1</span><span class="p">();</span>
					<span class="n">FPU_sub</span><span class="p">(</span><span class="n">LOADED</span> <span class="o">|</span> <span class="n">loaded_tag</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span>
						<span class="n">control_word</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* fsubr */</span>
					<span class="n">clear_C1</span><span class="p">();</span>
					<span class="n">FPU_sub</span><span class="p">(</span><span class="n">REV</span> <span class="o">|</span> <span class="n">LOADED</span> <span class="o">|</span> <span class="n">loaded_tag</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span>
						<span class="n">control_word</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">6</span>:	<span class="cm">/* fdiv */</span>
					<span class="n">clear_C1</span><span class="p">();</span>
					<span class="n">FPU_div</span><span class="p">(</span><span class="n">LOADED</span> <span class="o">|</span> <span class="n">loaded_tag</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span>
						<span class="n">control_word</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">7</span>:	<span class="cm">/* fdivr */</span>
					<span class="n">clear_C1</span><span class="p">();</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Zero</span><span class="p">)</span>
						<span class="n">partial_status</span> <span class="o">=</span> <span class="n">status1</span><span class="p">;</span>	<span class="cm">/* Undo any denorm tag,</span>
<span class="cm">										   zero-divide has priority. */</span>
					<span class="n">FPU_div</span><span class="p">(</span><span class="n">REV</span> <span class="o">|</span> <span class="n">LOADED</span> <span class="o">|</span> <span class="n">loaded_tag</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">loaded_data</span><span class="p">,</span>
						<span class="n">control_word</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* The instruction is fcom or fcomp */</span>
					<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_StackUnder</span><span class="p">);</span>
					<span class="n">setcc</span><span class="p">(</span><span class="n">SW_C3</span> <span class="o">|</span> <span class="n">SW_C2</span> <span class="o">|</span> <span class="n">SW_C0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Invalid</span><span class="p">))</span>
						<span class="n">FPU_pop</span><span class="p">();</span>	<span class="cm">/* fcomp */</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">FPU_stack_underflow</span><span class="p">();</span>
			<span class="p">}</span>
		      <span class="nl">reg_mem_instr_done:</span>
			<span class="n">operand_address</span> <span class="o">=</span> <span class="n">data_sel_off</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">no_ip_update</span> <span class="o">=</span>
			      <span class="n">FPU_load_store</span><span class="p">(((</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte1</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">))</span>
					     <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">addr_modes</span><span class="p">,</span> <span class="n">data_address</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">operand_address</span> <span class="o">=</span> <span class="n">data_sel_off</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* None of these instructions access user memory */</span>
		<span class="n">u_char</span> <span class="n">instr_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">FPU_modrm</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte1</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>

<span class="cp">#ifdef PECULIAR_486</span>
		<span class="cm">/* This is supposed to be undefined, but a real 80486 seems</span>
<span class="cm">		   to do this: */</span>
		<span class="n">operand_address</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">operand_address</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">FPU_DS</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>

		<span class="n">st0_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">st0_tag</span> <span class="o">=</span> <span class="n">FPU_gettag0</span><span class="p">();</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type_table</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">instr_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">_NONE_</span>:	<span class="cm">/* also _REGIc: _REGIn */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_REG0_</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NOT_EMPTY_ST0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPU_stack_underflow</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">FPU_instruction_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_REGIi</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NOT_EMPTY_ST0</span> <span class="o">||</span> <span class="o">!</span><span class="n">NOT_EMPTY</span><span class="p">(</span><span class="n">FPU_rm</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">FPU_stack_underflow_i</span><span class="p">(</span><span class="n">FPU_rm</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">FPU_instruction_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_REGIp</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NOT_EMPTY_ST0</span> <span class="o">||</span> <span class="o">!</span><span class="n">NOT_EMPTY</span><span class="p">(</span><span class="n">FPU_rm</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">FPU_stack_underflow_pop</span><span class="p">(</span><span class="n">FPU_rm</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">FPU_instruction_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_REGI_</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NOT_EMPTY_ST0</span> <span class="o">||</span> <span class="o">!</span><span class="n">NOT_EMPTY</span><span class="p">(</span><span class="n">FPU_rm</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">FPU_stack_underflow</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">FPU_instruction_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_PUSH_</span>:	<span class="cm">/* Only used by the fld st(i) instruction */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_null_</span>:
			<span class="n">FPU_illegal</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">FPU_instruction_done</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_INTERNAL</span> <span class="o">|</span> <span class="mh">0x111</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">FPU_instruction_done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">st_instr_table</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">instr_index</span><span class="p">])</span> <span class="p">();</span>

	      <span class="nl">FPU_instruction_done:</span>
		<span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_ip_update</span><span class="p">)</span>
		<span class="n">instruction_address</span> <span class="o">=</span> <span class="n">entry_sel_off</span><span class="p">;</span>

      <span class="nl">FPU_fwait_done:</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_printall</span><span class="p">();</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FPU_lookahead</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">need_resched</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">FPU_ORIG_EIP</span> <span class="o">=</span> <span class="n">FPU_EIP</span> <span class="o">-</span> <span class="n">code_base</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid_prefix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">byte1</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FPU_EIP</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">override</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">do_another_FPU_instruction</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span><span class="p">)</span>
		<span class="n">FPU_EIP</span> <span class="o">-=</span> <span class="n">code_base</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Support for prefix bytes is not yet complete. To properly handle</span>
<span class="cm">   all prefix bytes, further changes are needed in the emulator code</span>
<span class="cm">   which accesses user address space. Access to separate segments is</span>
<span class="cm">   important for msdos emulation. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">valid_prefix</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">Byte</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">**</span><span class="n">fpu_eip</span><span class="p">,</span>
			<span class="n">overrides</span> <span class="o">*</span> <span class="n">override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">byte</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="o">*</span><span class="n">fpu_eip</span><span class="p">;</span>

	<span class="o">*</span><span class="n">override</span> <span class="o">=</span> <span class="p">(</span><span class="n">overrides</span><span class="p">)</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PREFIX_DEFAULT</span><span class="p">};</span>	<span class="cm">/* defaults */</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_code_access_ok</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ADDR_SIZE_PREFIX</span>:
			<span class="n">override</span><span class="o">-&gt;</span><span class="n">address_size</span> <span class="o">=</span> <span class="n">ADDR_SIZE_PREFIX</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_next_byte</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_SIZE_PREFIX</span>:
			<span class="n">override</span><span class="o">-&gt;</span><span class="n">operand_size</span> <span class="o">=</span> <span class="n">OP_SIZE_PREFIX</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_next_byte</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PREFIX_CS</span>:
			<span class="n">override</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">PREFIX_CS_</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_next_byte</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PREFIX_ES</span>:
			<span class="n">override</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">PREFIX_ES_</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_next_byte</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PREFIX_SS</span>:
			<span class="n">override</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">PREFIX_SS_</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_next_byte</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PREFIX_FS</span>:
			<span class="n">override</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">PREFIX_FS_</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_next_byte</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PREFIX_GS</span>:
			<span class="n">override</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">PREFIX_GS_</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_next_byte</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PREFIX_DS</span>:
			<span class="n">override</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">PREFIX_DS_</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_next_byte</span><span class="p">;</span>

<span class="cm">/* lock is not a valid prefix for FPU instructions,</span>
<span class="cm">   let the cpu handle it to generate a SIGILL. */</span>
<span class="cm">/*	case PREFIX_LOCK: */</span>

			<span class="cm">/* rep.. prefixes have no meaning for FPU instructions */</span>
		<span class="k">case</span> <span class="n">PREFIX_REPE</span>:
		<span class="k">case</span> <span class="n">PREFIX_REPNE</span>:

		      <span class="nl">do_next_byte:</span>
			<span class="n">ip</span><span class="o">++</span><span class="p">;</span>
			<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
			<span class="n">FPU_code_access_ok</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FWAIT_OPCODE</span>:
			<span class="o">*</span><span class="n">Byte</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xd8</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">Byte</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
				<span class="o">*</span><span class="n">fpu_eip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Not a valid sequence of prefix bytes followed by</span>
<span class="cm">				   an FPU instruction. */</span>
				<span class="o">*</span><span class="n">Byte</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>	<span class="cm">/* Needed for error message. */</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">math_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">math_emu_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">signal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPU_EIP</span> <span class="o">=</span> <span class="n">FPU_ORIG_EIP</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">trap_nr</span> <span class="o">=</span> <span class="n">X86_TRAP_MF</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">send_sig</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
      <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;movl %0,%%esp ; ret&quot;</span><span class="o">:</span> <span class="o">:</span><span class="s">&quot;g&quot;</span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
<span class="cp">#ifdef PARANOID</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ERROR: wm-FPU-emu math_abort failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PARANOID */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cp">#define S387 ((struct i387_soft_struct *)s387)</span>
<span class="cp">#define sstatus_word() \</span>
<span class="cp">  ((S387-&gt;swd &amp; ~SW_Top &amp; 0xffff) | ((S387-&gt;ftop &lt;&lt; SW_Top_Shift) &amp; SW_Top))</span>

<span class="kt">int</span> <span class="nf">fpregs_soft_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i387_soft_struct</span> <span class="o">*</span><span class="n">s387</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpu</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">soft</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">space</span> <span class="o">=</span> <span class="n">s387</span><span class="o">-&gt;</span><span class="n">st_space</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">regnr</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">newtop</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">s387</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i387_soft_struct</span><span class="p">,</span> <span class="n">st_space</span><span class="p">));</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">S387</span><span class="o">-&gt;</span><span class="n">ftop</span> <span class="o">=</span> <span class="p">(</span><span class="n">S387</span><span class="o">-&gt;</span><span class="n">swd</span> <span class="o">&gt;&gt;</span> <span class="n">SW_Top_Shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">S387</span><span class="o">-&gt;</span><span class="n">ftop</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">other</span> <span class="o">=</span> <span class="mi">80</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>

	<span class="cm">/* Copy all registers in stack order. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubuf</span><span class="p">,</span>
				 <span class="n">space</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubuf</span><span class="p">,</span>
					 <span class="n">space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="cm">/* The tags may need to be corrected now. */</span>
	<span class="n">tags</span> <span class="o">=</span> <span class="n">S387</span><span class="o">-&gt;</span><span class="n">twd</span><span class="p">;</span>
	<span class="n">newtop</span> <span class="o">=</span> <span class="n">S387</span><span class="o">-&gt;</span><span class="n">ftop</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regnr</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">newtop</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">tags</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">regnr</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The loaded data over-rides all other cases. */</span>
			<span class="n">tag</span> <span class="o">=</span>
			    <span class="n">FPU_tagof</span><span class="p">((</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">S387</span><span class="o">-&gt;</span><span class="n">st_space</span> <span class="o">+</span>
						   <span class="mi">10</span> <span class="o">*</span> <span class="n">regnr</span><span class="p">));</span>
			<span class="n">tags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">regnr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">tags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">regnr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">S387</span><span class="o">-&gt;</span><span class="n">twd</span> <span class="o">=</span> <span class="n">tags</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fpregs_soft_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i387_soft_struct</span> <span class="o">*</span><span class="n">s387</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpu</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">soft</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">space</span> <span class="o">=</span> <span class="n">s387</span><span class="o">-&gt;</span><span class="n">st_space</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">S387</span><span class="o">-&gt;</span><span class="n">ftop</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="mi">80</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>

<span class="cp">#ifdef PECULIAR_486</span>
	<span class="n">S387</span><span class="o">-&gt;</span><span class="n">cwd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xe080</span><span class="p">;</span>
	<span class="cm">/* An 80486 sets nearly all of the reserved bits to 1. */</span>
	<span class="n">S387</span><span class="o">-&gt;</span><span class="n">cwd</span> <span class="o">|=</span> <span class="mh">0xffff0040</span><span class="p">;</span>
	<span class="n">S387</span><span class="o">-&gt;</span><span class="n">swd</span> <span class="o">=</span> <span class="n">sstatus_word</span><span class="p">()</span> <span class="o">|</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="n">S387</span><span class="o">-&gt;</span><span class="n">twd</span> <span class="o">|=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
	<span class="n">S387</span><span class="o">-&gt;</span><span class="n">fcs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf8000000</span><span class="p">;</span>
	<span class="n">S387</span><span class="o">-&gt;</span><span class="n">fos</span> <span class="o">|=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">s387</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i387_soft_struct</span><span class="p">,</span> <span class="n">st_space</span><span class="p">));</span>

	<span class="cm">/* Copy all registers in stack order. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubuf</span><span class="p">,</span>
					  <span class="n">space</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubuf</span><span class="p">,</span>
					  <span class="n">space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
