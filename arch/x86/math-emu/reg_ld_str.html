<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › math-emu › reg_ld_str.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>reg_ld_str.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------------------------------------------------------------+</span>
<span class="cm"> |  reg_ld_str.c                                                             |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> | All of the functions which transfer data between user memory and FPU_REGs.|</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> | Copyright (C) 1992,1993,1994,1996,1997                                    |</span>
<span class="cm"> |                  W. Metzenthen, 22 Parker St, Ormond, Vic 3163, Australia |</span>
<span class="cm"> |                  E-mail   billm@suburbia.net                              |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> +---------------------------------------------------------------------------*/</span>

<span class="cm">/*---------------------------------------------------------------------------+</span>
<span class="cm"> | Note:                                                                     |</span>
<span class="cm"> |    The file contains code which accesses user memory.                     |</span>
<span class="cm"> |    Emulator static data may change when user memory is accessed, due to   |</span>
<span class="cm"> |    other processes using the emulator while swapping is in progress.      |</span>
<span class="cm"> +---------------------------------------------------------------------------*/</span>

<span class="cp">#include &quot;fpu_emu.h&quot;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;fpu_system.h&quot;</span>
<span class="cp">#include &quot;exception.h&quot;</span>
<span class="cp">#include &quot;reg_constant.h&quot;</span>
<span class="cp">#include &quot;control_w.h&quot;</span>
<span class="cp">#include &quot;status_w.h&quot;</span>

<span class="cp">#define DOUBLE_Emax 1023	</span><span class="cm">/* largest valid exponent */</span><span class="cp"></span>
<span class="cp">#define DOUBLE_Ebias 1023</span>
<span class="cp">#define DOUBLE_Emin (-1022)	</span><span class="cm">/* smallest valid exponent */</span><span class="cp"></span>

<span class="cp">#define SINGLE_Emax 127		</span><span class="cm">/* largest valid exponent */</span><span class="cp"></span>
<span class="cp">#define SINGLE_Ebias 127</span>
<span class="cp">#define SINGLE_Emin (-126)	</span><span class="cm">/* smallest valid exponent */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">u_char</span> <span class="nf">normalize_no_excep</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sign</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">setexponent16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">FPU_normalize_nuo</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">stdexp</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sign</span><span class="p">)</span>
		<span class="n">setnegative</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">FPU_tagof</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">exp</span><span class="p">;</span>

	<span class="n">exp</span> <span class="o">=</span> <span class="n">exponent16</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">|</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">sigl</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">TAG_Zero</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The number is a de-normal or pseudodenormal. */</span>
		<span class="k">return</span> <span class="n">TAG_Special</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">==</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Is an Infinity, a NaN, or an unsupported data type. */</span>
		<span class="k">return</span> <span class="n">TAG_Special</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Unsupported data type. */</span>
		<span class="cm">/* Valid numbers have the ms bit set to 1. */</span>
		<span class="cm">/* Unnormal. */</span>
		<span class="k">return</span> <span class="n">TAG_Special</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TAG_Valid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get a long double from user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_load_extended</span><span class="p">(</span><span class="kt">long</span> <span class="kt">double</span> <span class="n">__user</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPU_REG</span> <span class="o">*</span><span class="n">sti_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">(</span><span class="n">stnr</span><span class="p">);</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">__copy_from_user</span><span class="p">(</span><span class="n">sti_ptr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">FPU_tagof</span><span class="p">(</span><span class="n">sti_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get a double from user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_load_double</span><span class="p">(</span><span class="kt">double</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dfloat</span><span class="p">,</span> <span class="n">FPU_REG</span> <span class="o">*</span><span class="n">loaded_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">exp</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">negative</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">m64</span><span class="p">,</span> <span class="n">l64</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">dfloat</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">m64</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dfloat</span><span class="p">);</span>
	<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">l64</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dfloat</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="n">negative</span> <span class="o">=</span> <span class="p">(</span><span class="n">m64</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">?</span> <span class="n">SIGN_Negative</span> <span class="o">:</span> <span class="n">SIGN_Positive</span><span class="p">;</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="p">((</span><span class="n">m64</span> <span class="o">&amp;</span> <span class="mh">0x7ff00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="n">DOUBLE_Ebias</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">;</span>
	<span class="n">m64</span> <span class="o">&amp;=</span> <span class="mh">0xfffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;</span> <span class="n">DOUBLE_Emax</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Infinity or NaN */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* +- infinity */</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="n">EXP_Infinity</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">;</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">TAG_Special</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Must be a signaling or quiet NaN */</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="n">EXP_NaN</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="p">(</span><span class="n">m64</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">|=</span> <span class="n">l64</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="n">l64</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">TAG_Special</span><span class="p">;</span>	<span class="cm">/* The calling function must look for NaNs */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;</span> <span class="n">DOUBLE_Emin</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Zero or de-normal */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Zero */</span>
			<span class="n">reg_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONST_Z</span><span class="p">,</span> <span class="n">loaded_data</span><span class="p">);</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">TAG_Zero</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* De-normal */</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="n">m64</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">|=</span> <span class="n">l64</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="n">l64</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">normalize_no_excep</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">,</span> <span class="n">DOUBLE_Emin</span><span class="p">,</span>
						  <span class="n">negative</span><span class="p">)</span>
			    <span class="o">|</span> <span class="p">(</span><span class="n">denormal_operand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">FPU_Exception</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="p">(</span><span class="n">m64</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">|=</span> <span class="n">l64</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>
		<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="n">l64</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>

		<span class="n">tag</span> <span class="o">=</span> <span class="n">TAG_Valid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setexponent16</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">,</span> <span class="n">exp</span> <span class="o">|</span> <span class="n">negative</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get a float from user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_load_single</span><span class="p">(</span><span class="kt">float</span> <span class="n">__user</span> <span class="o">*</span><span class="n">single</span><span class="p">,</span> <span class="n">FPU_REG</span> <span class="o">*</span><span class="n">loaded_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">m32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exp</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">negative</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">single</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">m32</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">single</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="n">negative</span> <span class="o">=</span> <span class="p">(</span><span class="n">m32</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">?</span> <span class="n">SIGN_Negative</span> <span class="o">:</span> <span class="n">SIGN_Positive</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">m32</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Zero */</span>
		<span class="n">reg_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONST_Z</span><span class="p">,</span> <span class="n">loaded_data</span><span class="p">);</span>
		<span class="n">addexponent</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">,</span> <span class="n">negative</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TAG_Zero</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">exp</span> <span class="o">=</span> <span class="p">((</span><span class="n">m32</span> <span class="o">&amp;</span> <span class="mh">0x7f800000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">-</span> <span class="n">SINGLE_Ebias</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">;</span>
	<span class="n">m32</span> <span class="o">=</span> <span class="p">(</span><span class="n">m32</span> <span class="o">&amp;</span> <span class="mh">0x7fffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;</span> <span class="n">SINGLE_Emin</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* De-normals */</span>
		<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="n">m32</span><span class="p">;</span>
		<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">normalize_no_excep</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">,</span> <span class="n">SINGLE_Emin</span><span class="p">,</span> <span class="n">negative</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">denormal_operand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">FPU_Exception</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;</span> <span class="n">SINGLE_Emax</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Infinity or NaN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* +- infinity */</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="n">EXP_Infinity</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">;</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">TAG_Special</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Must be a signaling or quiet NaN */</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="n">EXP_NaN</span> <span class="o">+</span> <span class="n">EXTENDED_Ebias</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="n">m32</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">TAG_Special</span><span class="p">;</span>	<span class="cm">/* The calling function must look for NaNs */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="n">m32</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">TAG_Valid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setexponent16</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">,</span> <span class="n">exp</span> <span class="o">|</span> <span class="n">negative</span><span class="p">);</span>	<span class="cm">/* Set the sign. */</span>

	<span class="k">return</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get a long long from user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_load_int64</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sign</span><span class="p">;</span>
	<span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">FPU_abort</span><span class="p">;</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONST_Z</span><span class="p">,</span> <span class="n">st0_ptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TAG_Zero</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sign</span> <span class="o">=</span> <span class="n">SIGN_Positive</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">s</span><span class="p">;</span>
		<span class="n">sign</span> <span class="o">=</span> <span class="n">SIGN_Negative</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">significand</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">normalize_no_excep</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="n">sign</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get a long from user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_load_int32</span><span class="p">(</span><span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_s</span><span class="p">,</span> <span class="n">FPU_REG</span> <span class="o">*</span><span class="n">loaded_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">negative</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">_s</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONST_Z</span><span class="p">,</span> <span class="n">loaded_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TAG_Zero</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">negative</span> <span class="o">=</span> <span class="n">SIGN_Positive</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">s</span><span class="p">;</span>
		<span class="n">negative</span> <span class="o">=</span> <span class="n">SIGN_Negative</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">normalize_no_excep</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">negative</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get a short from user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_load_int16</span><span class="p">(</span><span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="n">_s</span><span class="p">,</span> <span class="n">FPU_REG</span> <span class="o">*</span><span class="n">loaded_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">negative</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* Cast as short to get the sign extended. */</span>
	<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">_s</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONST_Z</span><span class="p">,</span> <span class="n">loaded_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TAG_Zero</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">negative</span> <span class="o">=</span> <span class="n">SIGN_Positive</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">s</span><span class="p">;</span>
		<span class="n">negative</span> <span class="o">=</span> <span class="n">SIGN_Negative</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">loaded_data</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">normalize_no_excep</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">negative</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get a packed bcd array from user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_load_bcd</span><span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">bcd</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sign</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">bcd</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">bcd</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">+=</span> <span class="n">bcd</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">?</span> <span class="n">SIGN_Negative</span> <span class="o">:</span> <span class="n">SIGN_Positive</span><span class="p">;</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONST_Z</span><span class="p">,</span> <span class="n">st0_ptr</span><span class="p">);</span>
		<span class="n">addexponent</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="n">sign</span><span class="p">);</span>	<span class="cm">/* Set the sign. */</span>
		<span class="k">return</span> <span class="n">TAG_Zero</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">significand</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">normalize_no_excep</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="n">sign</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>

<span class="cm">/* Put a long double into user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_store_extended</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">st0_tag</span><span class="p">,</span>
		       <span class="kt">long</span> <span class="kt">double</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   The only exception raised by an attempt to store to an</span>
<span class="cm">	   extended format is the Invalid Stack exception, i.e.</span>
<span class="cm">	   attempting to store from an empty register.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">!=</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigl</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigh</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)((</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">exponent16</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)((</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span> <span class="o">+</span>
						       <span class="mi">8</span><span class="p">));</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Empty register (stack underflow) */</span>
	<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_StackUnder</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Invalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The masked response */</span>
		<span class="cm">/* Put out the QNaN indefinite */</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="mh">0xc0000000</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Put a double into user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_store_double</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">st0_tag</span><span class="p">,</span> <span class="kt">double</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dfloat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">increment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* avoid gcc warnings */</span>
	<span class="kt">int</span> <span class="n">precision_loss</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exp</span><span class="p">;</span>
	<span class="n">FPU_REG</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_copy</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">exp</span> <span class="o">=</span> <span class="n">exponent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;</span> <span class="n">DOUBLE_Emin</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* It may be a denormal */</span>
			<span class="n">addexponent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">-</span><span class="n">DOUBLE_Emin</span> <span class="o">+</span> <span class="mi">52</span><span class="p">);</span>	<span class="cm">/* largest exp to be 51 */</span>
<span class="nl">denormal_arg:</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">precision_loss</span> <span class="o">=</span> <span class="n">FPU_round_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">st0_tag</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef PECULIAR_486</span>
				<span class="cm">/* Did it round to a non-denormal ? */</span>
				<span class="cm">/* This behaviour might be regarded as peculiar, it appears</span>
<span class="cm">				   that the 80486 rounds to the dest precision, then</span>
<span class="cm">				   converts to decide underflow. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
				    <span class="p">((</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">==</span> <span class="mh">0x00100000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">&amp;</span> <span class="mh">0x000007ff</span><span class="p">)))</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>
				<span class="p">{</span>
					<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Underflow</span><span class="p">);</span>
					<span class="cm">/* This is a special case: see sec 16.2.5.1 of</span>
<span class="cm">					   the 80486 book */</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Underflow</span><span class="p">))</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">precision_loss</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Precision</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span><span class="p">;</span>
			<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&amp;</span> <span class="mh">0x000007ff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">precision_loss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_RC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">RC_RND</span>:
					<span class="cm">/* Rounding can get a little messy.. */</span>
					<span class="n">increment</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* nearest */</span>
					    <span class="p">((</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&amp;</span> <span class="mh">0xc00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc00</span><span class="p">);</span>	<span class="cm">/* odd -&gt; even */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">RC_DOWN</span>:	<span class="cm">/* towards -infinity */</span>
					<span class="n">increment</span> <span class="o">=</span>
					    <span class="n">signpositive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">tmp</span><span class="p">.</span>
					    <span class="n">sigl</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">RC_UP</span>:	<span class="cm">/* towards +infinity */</span>
					<span class="n">increment</span> <span class="o">=</span>
					    <span class="n">signpositive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="n">tmp</span><span class="p">.</span>
					    <span class="n">sigl</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">RC_CHOP</span>:
					<span class="n">increment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Truncate the mantissa */</span>
				<span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&amp;=</span> <span class="mh">0xfffff800</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">increment</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&gt;=</span> <span class="mh">0xfffff800</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* the sigl part overflows */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* The sigh part overflows */</span>
							<span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
							<span class="n">exp</span><span class="o">++</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;=</span> <span class="n">EXP_OVER</span><span class="p">)</span>
								<span class="k">goto</span> <span class="n">overflow</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span><span class="o">++</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* We only need to increment sigl */</span>
						<span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">+=</span> <span class="mh">0x00000800</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">precision_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
			<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;</span> <span class="n">DOUBLE_Emax</span><span class="p">)</span> <span class="p">{</span>
			      <span class="nl">overflow:</span>
				<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Overflow</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Overflow</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">set_precision_flag_up</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Precision</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* This is a special case: see sec 16.2.5.1 of the 80486 book */</span>
				<span class="cm">/* Overflow to infinity */</span>
				<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7ff00000</span><span class="p">;</span>	<span class="cm">/* Set to + INF */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">precision_loss</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">increment</span><span class="p">)</span>
						<span class="n">set_precision_flag_up</span><span class="p">();</span>
					<span class="k">else</span>
						<span class="n">set_precision_flag_down</span><span class="p">();</span>
				<span class="p">}</span>
				<span class="cm">/* Add the exponent */</span>
				<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">exp</span> <span class="o">+</span> <span class="n">DOUBLE_Ebias</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Zero</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Number is zero */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st0_tag</span> <span class="o">=</span> <span class="n">FPU_Special</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_Denormal</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* A denormal will always underflow. */</span>
<span class="cp">#ifndef PECULIAR_486</span>
			<span class="cm">/* An 80486 is supposed to be able to generate</span>
<span class="cm">			   a denormal exception here, but... */</span>
			<span class="cm">/* Underflow has priority. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Underflow</span><span class="p">)</span>
				<span class="n">denormal_operand</span><span class="p">();</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>
			<span class="n">reg_copy</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">denormal_arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_Infinity</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7ff00000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_NaN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Is it really a NaN ? */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">exponent</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXP_OVER</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* See if we can get a valid NaN from the FPU_REG */</span>
				<span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span>
							     <span class="n">sigh</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
				<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* It is a signalling NaN */</span>
					<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Invalid</span><span class="p">))</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x40000000</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x7ff00000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* It is an unsupported data type */</span>
				<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Invalid</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfff80000</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Empty register (stack underflow) */</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_StackUnder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Invalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The masked response */</span>
			<span class="cm">/* Put out the QNaN indefinite */</span>
			<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
			<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">dfloat</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">FPU_put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dfloat</span><span class="p">);</span>
			<span class="n">FPU_put_user</span><span class="p">(</span><span class="mh">0xfff80000</span><span class="p">,</span>
				     <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dfloat</span><span class="p">);</span>
			<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getsign</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">))</span>
		<span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">dfloat</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dfloat</span><span class="p">);</span>
	<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dfloat</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put a float into user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_store_single</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">st0_tag</span><span class="p">,</span> <span class="kt">float</span> <span class="n">__user</span> <span class="o">*</span><span class="n">single</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">templ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">increment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* avoid gcc warnings */</span>
	<span class="kt">int</span> <span class="n">precision_loss</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exp</span><span class="p">;</span>
	<span class="n">FPU_REG</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Valid</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">reg_copy</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">exp</span> <span class="o">=</span> <span class="n">exponent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;</span> <span class="n">SINGLE_Emin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addexponent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">-</span><span class="n">SINGLE_Emin</span> <span class="o">+</span> <span class="mi">23</span><span class="p">);</span>	<span class="cm">/* largest exp to be 22 */</span>

		      <span class="nl">denormal_arg:</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">precision_loss</span> <span class="o">=</span> <span class="n">FPU_round_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">st0_tag</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef PECULIAR_486</span>
				<span class="cm">/* Did it round to a non-denormal ? */</span>
				<span class="cm">/* This behaviour might be regarded as peculiar, it appears</span>
<span class="cm">				   that the 80486 rounds to the dest precision, then</span>
<span class="cm">				   converts to decide underflow. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">==</span> <span class="mh">0x00800000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				      <span class="p">((</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">)</span>
				       <span class="o">||</span> <span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigl</span><span class="p">)))</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>
				<span class="p">{</span>
					<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Underflow</span><span class="p">);</span>
					<span class="cm">/* This is a special case: see sec 16.2.5.1 of</span>
<span class="cm">					   the 80486 book */</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Underflow</span><span class="p">))</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">precision_loss</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Precision</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">templ</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sigh</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sigl</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span><span class="p">;</span>

				<span class="n">precision_loss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_RC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">RC_RND</span>:
					<span class="n">increment</span> <span class="o">=</span> <span class="p">((</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* more than half */</span>
					    <span class="o">||</span><span class="p">(((</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sigl</span><span class="p">)</span>	<span class="cm">/* more than half */</span>
					    <span class="o">||</span><span class="p">((</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x180</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x180</span><span class="p">);</span>	<span class="cm">/* round to even */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">RC_DOWN</span>:	<span class="cm">/* towards -infinity */</span>
					<span class="n">increment</span> <span class="o">=</span> <span class="n">signpositive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span>
					    <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">sigl</span> <span class="o">|</span> <span class="p">(</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">RC_UP</span>:	<span class="cm">/* towards +infinity */</span>
					<span class="n">increment</span> <span class="o">=</span> <span class="n">signpositive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span>
					    <span class="o">?</span> <span class="p">(</span><span class="n">sigl</span> <span class="o">|</span> <span class="p">(</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">RC_CHOP</span>:
					<span class="n">increment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Truncate part of the mantissa */</span>
				<span class="n">tmp</span><span class="p">.</span><span class="n">sigl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">increment</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">sigh</span> <span class="o">&gt;=</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* The sigh part overflows */</span>
						<span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
						<span class="n">exp</span><span class="o">++</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;=</span> <span class="n">EXP_OVER</span><span class="p">)</span>
							<span class="k">goto</span> <span class="n">overflow</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">&amp;=</span> <span class="mh">0xffffff00</span><span class="p">;</span>
						<span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">+=</span> <span class="mh">0x100</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">&amp;=</span> <span class="mh">0xffffff00</span><span class="p">;</span>	<span class="cm">/* Finish the truncation */</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">precision_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">templ</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">sigh</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x007fffff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;</span> <span class="n">SINGLE_Emax</span><span class="p">)</span> <span class="p">{</span>
			      <span class="nl">overflow:</span>
				<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Overflow</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Overflow</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">set_precision_flag_up</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Precision</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* This is a special case: see sec 16.2.5.1 of the 80486 book. */</span>
				<span class="cm">/* Masked response is overflow to infinity. */</span>
				<span class="n">templ</span> <span class="o">=</span> <span class="mh">0x7f800000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">precision_loss</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">increment</span><span class="p">)</span>
						<span class="n">set_precision_flag_up</span><span class="p">();</span>
					<span class="k">else</span>
						<span class="n">set_precision_flag_down</span><span class="p">();</span>
				<span class="p">}</span>
				<span class="cm">/* Add the exponent */</span>
				<span class="n">templ</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exp</span> <span class="o">+</span> <span class="n">SINGLE_Ebias</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Zero</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">templ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st0_tag</span> <span class="o">=</span> <span class="n">FPU_Special</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_Denormal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_copy</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

			<span class="cm">/* A denormal will always underflow. */</span>
<span class="cp">#ifndef PECULIAR_486</span>
			<span class="cm">/* An 80486 is supposed to be able to generate</span>
<span class="cm">			   a denormal exception here, but... */</span>
			<span class="cm">/* Underflow has priority. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Underflow</span><span class="p">)</span>
				<span class="n">denormal_operand</span><span class="p">();</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>
			<span class="k">goto</span> <span class="n">denormal_arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_Infinity</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">templ</span> <span class="o">=</span> <span class="mh">0x7f800000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_NaN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Is it really a NaN ? */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">exponent</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXP_OVER</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* See if we can get a valid NaN from the FPU_REG */</span>
				<span class="n">templ</span> <span class="o">=</span> <span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">st0_ptr</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* It is a signalling NaN */</span>
					<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Invalid</span><span class="p">))</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">templ</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x40000000</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">templ</span> <span class="o">|=</span> <span class="mh">0x7f800000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* It is an unsupported data type */</span>
				<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Invalid</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">templ</span> <span class="o">=</span> <span class="mh">0xffc00000</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef PARANOID</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_INTERNAL</span> <span class="o">|</span> <span class="mh">0x164</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Empty register (stack underflow) */</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_StackUnder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">EX_Invalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The masked response */</span>
			<span class="cm">/* Put out the QNaN indefinite */</span>
			<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
			<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">single</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">FPU_put_user</span><span class="p">(</span><span class="mh">0xffc00000</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">single</span><span class="p">);</span>
			<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef PARANOID</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_INTERNAL</span> <span class="o">|</span> <span class="mh">0x163</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getsign</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">))</span>
		<span class="n">templ</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">single</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">templ</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">single</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put a long long into user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_store_int64</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">st0_tag</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPU_REG</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="n">tll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">precision_loss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Empty register (stack underflow) */</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_StackUnder</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">invalid_operand</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st0_tag</span> <span class="o">=</span> <span class="n">FPU_Special</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_Infinity</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_NaN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">invalid_operand</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reg_copy</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="n">precision_loss</span> <span class="o">=</span> <span class="n">FPU_round_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">st0_tag</span><span class="p">);</span>
	<span class="p">((</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tll</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">sigl</span><span class="p">;</span>
	<span class="p">((</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tll</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">sigh</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">precision_loss</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">sigh</span> <span class="o">==</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">signnegative</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
		<span class="cm">/* This is a special case: see sec 16.2.5.1 of the 80486 book */</span>
	      <span class="nl">invalid_operand:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">EX_Invalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Produce something like QNaN &quot;indefinite&quot; */</span>
			<span class="n">tll</span> <span class="o">=</span> <span class="mh">0x8000000000000000LL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">precision_loss</span><span class="p">)</span>
			<span class="n">set_precision_flag</span><span class="p">(</span><span class="n">precision_loss</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signnegative</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
			<span class="n">tll</span> <span class="o">=</span> <span class="o">-</span><span class="n">tll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tll</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">FPU_abort</span><span class="p">;</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put a long into user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_store_int32</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">st0_tag</span><span class="p">,</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPU_REG</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">precision_loss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Empty register (stack underflow) */</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_StackUnder</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">invalid_operand</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st0_tag</span> <span class="o">=</span> <span class="n">FPU_Special</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_Infinity</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_NaN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">invalid_operand</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reg_copy</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="n">precision_loss</span> <span class="o">=</span> <span class="n">FPU_round_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">st0_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">sigh</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">==</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">signnegative</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
		<span class="cm">/* This is a special case: see sec 16.2.5.1 of the 80486 book */</span>
	      <span class="nl">invalid_operand:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">EX_Invalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Produce something like QNaN &quot;indefinite&quot; */</span>
			<span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">precision_loss</span><span class="p">)</span>
			<span class="n">set_precision_flag</span><span class="p">(</span><span class="n">precision_loss</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signnegative</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
			<span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put a short into user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_store_int16</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">st0_tag</span><span class="p">,</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPU_REG</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">precision_loss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Empty register (stack underflow) */</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_StackUnder</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">invalid_operand</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st0_tag</span> <span class="o">=</span> <span class="n">FPU_Special</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_Infinity</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_NaN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">invalid_operand</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reg_copy</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="n">precision_loss</span> <span class="o">=</span> <span class="n">FPU_round_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">st0_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">sigh</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&amp;</span> <span class="mh">0xffff8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">==</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">signnegative</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
		<span class="cm">/* This is a special case: see sec 16.2.5.1 of the 80486 book */</span>
	      <span class="nl">invalid_operand:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">EX_Invalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Produce something like QNaN &quot;indefinite&quot; */</span>
			<span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">precision_loss</span><span class="p">)</span>
			<span class="n">set_precision_flag</span><span class="p">(</span><span class="n">precision_loss</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signnegative</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
			<span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">=</span> <span class="o">-</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">FPU_put_user</span><span class="p">((</span><span class="kt">short</span><span class="p">)</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put a packed bcd array into user memory */</span>
<span class="kt">int</span> <span class="nf">FPU_store_bcd</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">st0_tag</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPU_REG</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">precision_loss</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">sign</span> <span class="o">=</span> <span class="p">(</span><span class="n">getsign</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">SIGN_NEG</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Empty register (stack underflow) */</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_StackUnder</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">invalid_operand</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TAG_Special</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st0_tag</span> <span class="o">=</span> <span class="n">FPU_Special</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_Infinity</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">st0_tag</span> <span class="o">==</span> <span class="n">TW_NaN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">invalid_operand</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reg_copy</span><span class="p">(</span><span class="n">st0_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="n">precision_loss</span> <span class="o">=</span> <span class="n">FPU_round_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">st0_tag</span><span class="p">);</span>
	<span class="n">ll</span> <span class="o">=</span> <span class="n">significand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>

	<span class="cm">/* Check for overflow, by comparing with 999999999999999999 decimal. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">sigh</span> <span class="o">&gt;</span> <span class="mh">0x0de0b6b3</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">sigh</span> <span class="o">==</span> <span class="mh">0x0de0b6b3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">sigl</span> <span class="o">&gt;</span> <span class="mh">0xa763ffff</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">EXCEPTION</span><span class="p">(</span><span class="n">EX_Invalid</span><span class="p">);</span>
		<span class="cm">/* This is a special case: see sec 16.2.5.1 of the 80486 book */</span>
	      <span class="nl">invalid_operand:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Invalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Produce the QNaN &quot;indefinite&quot; */</span>
			<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
			<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">FPU_put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>	<span class="cm">/* These bytes &quot;undefined&quot; */</span>
			<span class="n">FPU_put_user</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* This byte &quot;undefined&quot; */</span>
			<span class="n">FPU_put_user</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">FPU_put_user</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
			<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">precision_loss</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Precision loss doesn&#39;t stop the data transfer */</span>
		<span class="n">set_precision_flag</span><span class="p">(</span><span class="n">precision_loss</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">FPU_div_small</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FPU_div_small</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>

<span class="cm">/* r gets mangled such that sig is int, sign: </span>
<span class="cm">   it is NOT normalized */</span>
<span class="cm">/* The return value (in eax) is zero if the result is exact,</span>
<span class="cm">   if bits are changed due to rounding, truncation, etc, then</span>
<span class="cm">   a non-zero value is returned */</span>
<span class="cm">/* Overflow is signalled by a non-zero return value (in eax).</span>
<span class="cm">   In the case of overflow, the returned significand always has the</span>
<span class="cm">   largest possible value */</span>
<span class="kt">int</span> <span class="nf">FPU_round_to_int</span><span class="p">(</span><span class="n">FPU_REG</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">very_big</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">eax</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_Zero</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure that zero is returned */</span>
		<span class="n">significand</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* o.k. */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exponent</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">sigh</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* The largest representable number */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* overflow */</span>
	<span class="p">}</span>

	<span class="n">eax</span> <span class="o">=</span> <span class="n">FPU_shrxs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">sigl</span><span class="p">,</span> <span class="mi">63</span> <span class="o">-</span> <span class="n">exponent</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
	<span class="n">very_big</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">sigh</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">sigl</span><span class="p">));</span>	<span class="cm">/* test for 0xfff...fff */</span>
<span class="cp">#define	half_or_more	(eax &amp; 0x80000000)</span>
<span class="cp">#define	frac_part	(eax)</span>
<span class="cp">#define more_than_half  ((eax &amp; 0x80000001) == 0x80000001)</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_RC</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RC_RND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">more_than_half</span>	<span class="cm">/* nearest */</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">half_or_more</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">sigl</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>	<span class="cm">/* odd -&gt; even */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">very_big</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* overflow */</span>
			<span class="n">significand</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">PRECISION_LOST_UP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RC_DOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">frac_part</span> <span class="o">&amp;&amp;</span> <span class="n">getsign</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">very_big</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* overflow */</span>
			<span class="n">significand</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">PRECISION_LOST_UP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RC_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">frac_part</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">getsign</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">very_big</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* overflow */</span>
			<span class="n">significand</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">PRECISION_LOST_UP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RC_CHOP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">eax</span> <span class="o">?</span> <span class="n">PRECISION_LOST_DOWN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>

<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="nf">fldenv</span><span class="p">(</span><span class="n">fpu_addr_modes</span> <span class="n">addr_modes</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tag_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">==</span> <span class="n">VM86</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">==</span> <span class="n">PM16</span><span class="p">)</span>
	     <span class="o">^</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">override</span><span class="p">.</span><span class="n">operand_size</span> <span class="o">==</span> <span class="n">OP_SIZE_PREFIX</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">control_word</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">);</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">partial_status</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">tag_word</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">instruction_address</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">instruction_address</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">operand_address</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mh">0x0a</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">operand_address</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">));</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="mh">0x0e</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">==</span> <span class="n">VM86</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">instruction_address</span><span class="p">.</span><span class="n">offset</span>
			    <span class="o">+=</span> <span class="p">(</span><span class="n">instruction_address</span><span class="p">.</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">operand_address</span><span class="p">.</span><span class="n">offset</span> <span class="o">+=</span>
			    <span class="p">(</span><span class="n">operand_address</span><span class="p">.</span><span class="n">selector</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">control_word</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">);</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">partial_status</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">tag_word</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">instruction_address</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">instruction_address</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">instruction_address</span><span class="p">.</span><span class="n">opcode</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">operand_address</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">));</span>
		<span class="n">FPU_get_user</span><span class="p">(</span><span class="n">operand_address</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">));</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="mh">0x1c</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef PECULIAR_486</span>
	<span class="n">control_word</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xe080</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>

	<span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">partial_status</span> <span class="o">&gt;&gt;</span> <span class="n">SW_Top_Shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">partial_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="n">CW_Exceptions</span><span class="p">)</span>
		<span class="n">partial_status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SW_Summary</span> <span class="o">|</span> <span class="n">SW_Backward</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">partial_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SW_Summary</span> <span class="o">|</span> <span class="n">SW_Backward</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">tag_word</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">tag_word</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_Empty</span><span class="p">)</span>
			<span class="cm">/* New tag is empty.  Accept it */</span>
			<span class="n">FPU_settag</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TAG_Empty</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">FPU_gettag</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">TAG_Empty</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Old tag is empty and new tag is not empty.  New tag is determined</span>
<span class="cm">			   by old reg contents */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exponent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpu_register</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="n">EXTENDED_Ebias</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
				    <span class="p">(</span><span class="n">fpu_register</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">sigl</span> <span class="o">|</span> <span class="n">fpu_register</span><span class="p">(</span><span class="n">i</span><span class="p">).</span>
				     <span class="n">sigh</span><span class="p">))</span>
					<span class="n">FPU_settag</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TAG_Zero</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">FPU_settag</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TAG_Special</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exponent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpu_register</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">==</span>
				   <span class="mh">0x7fff</span> <span class="o">-</span> <span class="n">EXTENDED_Ebias</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPU_settag</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TAG_Special</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fpu_register</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">sigh</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
				<span class="n">FPU_settag</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TAG_Valid</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">FPU_settag</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">TAG_Special</span><span class="p">);</span>	<span class="cm">/* An Un-normal */</span>
		<span class="p">}</span>
		<span class="cm">/* Else old tag is not empty and new tag is not empty.  Old tag</span>
<span class="cm">		   remains correct */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">frstor</span><span class="p">(</span><span class="n">fpu_addr_modes</span> <span class="n">addr_modes</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">regnr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">fldenv</span><span class="p">(</span><span class="n">addr_modes</span><span class="p">,</span> <span class="n">data_address</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="mi">80</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/* Copy all registers in stack order. */</span>
	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
	<span class="n">__copy_from_user</span><span class="p">(</span><span class="n">register_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">__copy_from_user</span><span class="p">(</span><span class="n">register_base</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">other</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regnr</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">top</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FPU_gettag</span><span class="p">(</span><span class="n">regnr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Empty</span><span class="p">)</span>
			<span class="cm">/* The loaded data over-rides all other cases. */</span>
			<span class="n">FPU_settag</span><span class="p">(</span><span class="n">regnr</span><span class="p">,</span> <span class="n">FPU_tagof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="nf">fstenv</span><span class="p">(</span><span class="n">fpu_addr_modes</span> <span class="n">addr_modes</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">==</span> <span class="n">VM86</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">==</span> <span class="n">PM16</span><span class="p">)</span>
	     <span class="o">^</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">override</span><span class="p">.</span><span class="n">operand_size</span> <span class="o">==</span> <span class="n">OP_SIZE_PREFIX</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
<span class="cp">#ifdef PECULIAR_486</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">control_word</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xe080</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">control_word</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">status_word</span><span class="p">(),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">fpu_tag_word</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">instruction_address</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">operand_address</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span> <span class="o">+</span> <span class="mh">0x0a</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_modes</span><span class="p">.</span><span class="n">default_mode</span> <span class="o">==</span> <span class="n">VM86</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FPU_put_user</span><span class="p">((</span><span class="n">instruction_address</span><span class="p">.</span>
				      <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xf0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">FPU_put_user</span><span class="p">((</span><span class="n">operand_address</span><span class="p">.</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xf0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">instruction_address</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">FPU_put_user</span><span class="p">(</span><span class="n">operand_address</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">+=</span> <span class="mh">0x0e</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
		<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifdef PECULIAR_486</span>
		<span class="n">control_word</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xe080</span><span class="p">;</span>
		<span class="cm">/* An 80486 sets nearly all of the reserved bits to 1. */</span>
		<span class="n">control_word</span> <span class="o">|=</span> <span class="mh">0xffff0040</span><span class="p">;</span>
		<span class="n">partial_status</span> <span class="o">=</span> <span class="n">status_word</span><span class="p">()</span> <span class="o">|</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="n">fpu_tag_word</span> <span class="o">|=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="n">I387</span><span class="o">-&gt;</span><span class="n">soft</span><span class="p">.</span><span class="n">fcs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf8000000</span><span class="p">;</span>
		<span class="n">I387</span><span class="o">-&gt;</span><span class="n">soft</span><span class="p">.</span><span class="n">fos</span> <span class="o">|=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PECULIAR_486 */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control_word</span><span class="p">,</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">FPU_abort</span><span class="p">;</span>
		<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">+=</span> <span class="mh">0x1c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">control_word</span> <span class="o">|=</span> <span class="n">CW_Exceptions</span><span class="p">;</span>
	<span class="n">partial_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SW_Summary</span> <span class="o">|</span> <span class="n">SW_Backward</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fsave</span><span class="p">(</span><span class="n">fpu_addr_modes</span> <span class="n">addr_modes</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="mi">80</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">fstenv</span><span class="p">(</span><span class="n">addr_modes</span><span class="p">,</span> <span class="n">data_address</span><span class="p">);</span>

	<span class="n">RE_ENTRANT_CHECK_OFF</span><span class="p">;</span>
	<span class="n">FPU_access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>

	<span class="cm">/* Copy all registers in stack order. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">register_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
		<span class="n">FPU_abort</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">other</span><span class="p">,</span> <span class="n">register_base</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
			<span class="n">FPU_abort</span><span class="p">;</span>
	<span class="n">RE_ENTRANT_CHECK_ON</span><span class="p">;</span>

	<span class="n">finit</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
