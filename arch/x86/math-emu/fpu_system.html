<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › math-emu › fpu_system.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fpu_system.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*---------------------------------------------------------------------------+</span>
<span class="cm"> |  fpu_system.h                                                             |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> | Copyright (C) 1992,1994,1997                                              |</span>
<span class="cm"> |                       W. Metzenthen, 22 Parker St, Ormond, Vic 3163,      |</span>
<span class="cm"> |                       Australia.  E-mail   billm@suburbia.net             |</span>
<span class="cm"> |                                                                           |</span>
<span class="cm"> +---------------------------------------------------------------------------*/</span>

<span class="cp">#ifndef _FPU_SYSTEM_H</span>
<span class="cp">#define _FPU_SYSTEM_H</span>

<span class="cm">/* system dependent definitions */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>

<span class="cm">/* s is always from a cpu register, and the cpu does bounds checking</span>
<span class="cm"> * during register load --&gt; no further bounds checks needed */</span>
<span class="cp">#define LDT_DESCRIPTOR(s)	(((struct desc_struct *)current-&gt;mm-&gt;context.ldt)[(s) &gt;&gt; 3])</span>
<span class="cp">#define SEG_D_SIZE(x)		((x).b &amp; (3 &lt;&lt; 21))</span>
<span class="cp">#define SEG_G_BIT(x)		((x).b &amp; (1 &lt;&lt; 23))</span>
<span class="cp">#define SEG_GRANULARITY(x)	(((x).b &amp; (1 &lt;&lt; 23)) ? 4096 : 1)</span>
<span class="cp">#define SEG_286_MODE(x)		((x).b &amp; ( 0xff000000 | 0xf0000 | (1 &lt;&lt; 23)))</span>
<span class="cp">#define SEG_BASE_ADDR(s)	(((s).b &amp; 0xff000000) \</span>
<span class="cp">				 | (((s).b &amp; 0xff) &lt;&lt; 16) | ((s).a &gt;&gt; 16))</span>
<span class="cp">#define SEG_LIMIT(s)		(((s).b &amp; 0xff0000) | ((s).a &amp; 0xffff))</span>
<span class="cp">#define SEG_EXECUTE_ONLY(s)	(((s).b &amp; ((1 &lt;&lt; 11) | (1 &lt;&lt; 9))) == (1 &lt;&lt; 11))</span>
<span class="cp">#define SEG_WRITE_PERM(s)	(((s).b &amp; ((1 &lt;&lt; 11) | (1 &lt;&lt; 9))) == (1 &lt;&lt; 9))</span>
<span class="cp">#define SEG_EXPAND_DOWN(s)	(((s).b &amp; ((1 &lt;&lt; 11) | (1 &lt;&lt; 10))) \</span>
<span class="cp">				 == (1 &lt;&lt; 10))</span>

<span class="cp">#define I387			(current-&gt;thread.fpu.state)</span>
<span class="cp">#define FPU_info		(I387-&gt;soft.info)</span>

<span class="cp">#define FPU_CS			(*(unsigned short *) &amp;(FPU_info-&gt;regs-&gt;cs))</span>
<span class="cp">#define FPU_SS			(*(unsigned short *) &amp;(FPU_info-&gt;regs-&gt;ss))</span>
<span class="cp">#define FPU_DS			(*(unsigned short *) &amp;(FPU_info-&gt;regs-&gt;ds))</span>
<span class="cp">#define FPU_EAX			(FPU_info-&gt;regs-&gt;ax)</span>
<span class="cp">#define FPU_EFLAGS		(FPU_info-&gt;regs-&gt;flags)</span>
<span class="cp">#define FPU_EIP			(FPU_info-&gt;regs-&gt;ip)</span>
<span class="cp">#define FPU_ORIG_EIP		(FPU_info-&gt;___orig_eip)</span>

<span class="cp">#define FPU_lookahead           (I387-&gt;soft.lookahead)</span>

<span class="cm">/* nz if ip_offset and cs_selector are not to be set for the current</span>
<span class="cm">   instruction. */</span>
<span class="cp">#define no_ip_update		(*(u_char *)&amp;(I387-&gt;soft.no_update))</span>
<span class="cp">#define FPU_rm			(*(u_char *)&amp;(I387-&gt;soft.rm))</span>

<span class="cm">/* Number of bytes of data which can be legally accessed by the current</span>
<span class="cm">   instruction. This only needs to hold a number &lt;= 108, so a byte will do. */</span>
<span class="cp">#define access_limit		(*(u_char *)&amp;(I387-&gt;soft.alimit))</span>

<span class="cp">#define partial_status		(I387-&gt;soft.swd)</span>
<span class="cp">#define control_word		(I387-&gt;soft.cwd)</span>
<span class="cp">#define fpu_tag_word		(I387-&gt;soft.twd)</span>
<span class="cp">#define registers		(I387-&gt;soft.st_space)</span>
<span class="cp">#define top			(I387-&gt;soft.ftop)</span>

<span class="cp">#define instruction_address	(*(struct address *)&amp;I387-&gt;soft.fip)</span>
<span class="cp">#define operand_address		(*(struct address *)&amp;I387-&gt;soft.foo)</span>

<span class="cp">#define FPU_access_ok(x,y,z)	if ( !access_ok(x,y,z) ) \</span>
<span class="cp">				math_abort(FPU_info,SIGSEGV)</span>
<span class="cp">#define FPU_abort		math_abort(FPU_info, SIGSEGV)</span>

<span class="cp">#undef FPU_IGNORE_CODE_SEGV</span>
<span class="cp">#ifdef FPU_IGNORE_CODE_SEGV</span>
<span class="cm">/* access_ok() is very expensive, and causes the emulator to run</span>
<span class="cm">   about 20% slower if applied to the code. Anyway, errors due to bad</span>
<span class="cm">   code addresses should be much rarer than errors due to bad data</span>
<span class="cm">   addresses. */</span>
<span class="cp">#define	FPU_code_access_ok(z)</span>
<span class="cp">#else</span>
<span class="cm">/* A simpler test than access_ok() can probably be done for</span>
<span class="cm">   FPU_code_access_ok() because the only possible error is to step</span>
<span class="cm">   past the upper boundary of a legal code area. */</span>
<span class="cp">#define	FPU_code_access_ok(z) FPU_access_ok(VERIFY_READ,(void __user *)FPU_EIP,z)</span>
<span class="cp">#endif</span>

<span class="cp">#define FPU_get_user(x,y)       get_user((x),(y))</span>
<span class="cp">#define FPU_put_user(x,y)       put_user((x),(y))</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
