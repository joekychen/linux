<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › xen › enlighten.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>enlighten.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Core of Xen paravirt_ops implementation.</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains the xen_paravirt_ops structure itself, and the</span>
<span class="cm"> * implementations for:</span>
<span class="cm"> * - privileged instructions</span>
<span class="cm"> * - interrupt flags</span>
<span class="cm"> * - segment operations</span>
<span class="cm"> * - booting and setup</span>
<span class="cm"> *</span>
<span class="cm"> * Jeremy Fitzhardinge &lt;jeremy@xensource.com&gt;, XenSource Inc, 2007</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/preempt.h&gt;</span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/start_kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kprobes.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/page-flags.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>

<span class="cp">#include &lt;xen/xen.h&gt;</span>
<span class="cp">#include &lt;xen/interface/xen.h&gt;</span>
<span class="cp">#include &lt;xen/interface/version.h&gt;</span>
<span class="cp">#include &lt;xen/interface/physdev.h&gt;</span>
<span class="cp">#include &lt;xen/interface/vcpu.h&gt;</span>
<span class="cp">#include &lt;xen/interface/memory.h&gt;</span>
<span class="cp">#include &lt;xen/features.h&gt;</span>
<span class="cp">#include &lt;xen/page.h&gt;</span>
<span class="cp">#include &lt;xen/hvm.h&gt;</span>
<span class="cp">#include &lt;xen/hvc-console.h&gt;</span>
<span class="cp">#include &lt;xen/acpi.h&gt;</span>

<span class="cp">#include &lt;asm/paravirt.h&gt;</span>
<span class="cp">#include &lt;asm/apic.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/xen/pci.h&gt;</span>
<span class="cp">#include &lt;asm/xen/hypercall.h&gt;</span>
<span class="cp">#include &lt;asm/xen/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/fixmap.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/proto.h&gt;</span>
<span class="cp">#include &lt;asm/msr-index.h&gt;</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/desc.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/reboot.h&gt;</span>
<span class="cp">#include &lt;asm/stackprotector.h&gt;</span>
<span class="cp">#include &lt;asm/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/mwait.h&gt;</span>
<span class="cp">#include &lt;asm/pci_x86.h&gt;</span>

<span class="cp">#ifdef CONFIG_ACPI</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;asm/acpi.h&gt;</span>
<span class="cp">#include &lt;acpi/pdc_intel.h&gt;</span>
<span class="cp">#include &lt;acpi/processor.h&gt;</span>
<span class="cp">#include &lt;xen/interface/platform.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;xen-ops.h&quot;</span>
<span class="cp">#include &quot;mmu.h&quot;</span>
<span class="cp">#include &quot;smp.h&quot;</span>
<span class="cp">#include &quot;multicalls.h&quot;</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hypercall_page</span><span class="p">);</span>

<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_info</span> <span class="o">*</span><span class="p">,</span> <span class="n">xen_vcpu</span><span class="p">);</span>
<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">vcpu_info</span><span class="p">,</span> <span class="n">xen_vcpu_info</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">xen_domain_type</span> <span class="n">xen_domain_type</span> <span class="o">=</span> <span class="n">XEN_NATIVE</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xen_domain_type</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">machine_to_phys_mapping</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">MACH2PHYS_VIRT_START</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">machine_to_phys_mapping</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">machine_to_phys_nr</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">machine_to_phys_nr</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">start_info</span> <span class="o">*</span><span class="n">xen_start_info</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xen_start_info</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">shared_info</span> <span class="n">xen_dummy_shared_info</span><span class="p">;</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">xen_initial_gdt</span><span class="p">;</span>

<span class="n">RESERVE_BRK</span><span class="p">(</span><span class="n">shared_info_page_brk</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="n">__read_mostly</span> <span class="kt">int</span> <span class="n">xen_have_vector_callback</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xen_have_vector_callback</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Point at some empty memory to start with. We map the real shared_info</span>
<span class="cm"> * page as soon as fixmap is up and running.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">shared_info</span> <span class="o">*</span><span class="n">HYPERVISOR_shared_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">xen_dummy_shared_info</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Flag to determine whether vcpu info placement is available on all</span>
<span class="cm"> * VCPUs.  We assume it is to start with, and then set it to zero on</span>
<span class="cm"> * the first failure.  This is because it can succeed on some VCPUs</span>
<span class="cm"> * and not others, since it can involve hypervisor memory allocation,</span>
<span class="cm"> * or because the guest failed to guarantee all the appropriate</span>
<span class="cm"> * constraints on all VCPUs (ie buffer can&#39;t cross a page boundary).</span>
<span class="cm"> *</span>
<span class="cm"> * Note that any particular CPU may be using a placed vcpu structure,</span>
<span class="cm"> * but we can only optimise if the all are.</span>
<span class="cm"> *</span>
<span class="cm"> * 0: not available, 1: available</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">have_vcpu_info_placement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clamp_max_cpus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_max_cpus</span> <span class="o">&gt;</span> <span class="n">MAX_VIRT_CPUS</span><span class="p">)</span>
		<span class="n">setup_max_cpus</span> <span class="o">=</span> <span class="n">MAX_VIRT_CPUS</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_vcpu_setup</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vcpu_register_vcpu_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vcpu_info</span> <span class="o">*</span><span class="n">vcpup</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">HYPERVISOR_shared_info</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">xen_dummy_shared_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">MAX_VIRT_CPUS</span><span class="p">)</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">xen_vcpu</span><span class="p">,</span><span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HYPERVISOR_shared_info</span><span class="o">-&gt;</span><span class="n">vcpu_info</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_vcpu_info_placement</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">&gt;=</span> <span class="n">MAX_VIRT_CPUS</span><span class="p">)</span>
			<span class="n">clamp_max_cpus</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcpup</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">xen_vcpu_info</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">mfn</span> <span class="o">=</span> <span class="n">arbitrary_virt_to_mfn</span><span class="p">(</span><span class="n">vcpup</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">vcpup</span><span class="p">);</span>

	<span class="cm">/* Check to see if the hypervisor will put the vcpu_info</span>
<span class="cm">	   structure where we want it, which allows direct access via</span>
<span class="cm">	   a percpu-variable. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">HYPERVISOR_vcpu_op</span><span class="p">(</span><span class="n">VCPUOP_register_vcpu_info</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;register_vcpu_info failed: err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">have_vcpu_info_placement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clamp_max_cpus</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* This cpu is using the registered vcpu info, even if</span>
<span class="cm">		   later ones fail to. */</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">xen_vcpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">vcpup</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On restore, set the vcpu placement up again.</span>
<span class="cm"> * If it fails, then we&#39;re in a bad state, since</span>
<span class="cm"> * we can&#39;t back out from using it...</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xen_vcpu_restore</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">other_cpu</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">smp_processor_id</span><span class="p">());</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">other_cpu</span> <span class="o">&amp;&amp;</span>
		    <span class="n">HYPERVISOR_vcpu_op</span><span class="p">(</span><span class="n">VCPUOP_down</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">xen_setup_runstate_info</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">have_vcpu_info_placement</span><span class="p">)</span>
			<span class="n">xen_vcpu_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">other_cpu</span> <span class="o">&amp;&amp;</span>
		    <span class="n">HYPERVISOR_vcpu_op</span><span class="p">(</span><span class="n">VCPUOP_up</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_banner</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">version</span> <span class="o">=</span> <span class="n">HYPERVISOR_xen_version</span><span class="p">(</span><span class="n">XENVER_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xen_extraversion</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">HYPERVISOR_xen_version</span><span class="p">(</span><span class="n">XENVER_extraversion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extra</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Booting paravirtualized kernel on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pv_info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Xen version: %d.%d%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">extra</span><span class="p">.</span><span class="n">extraversion</span><span class="p">,</span>
	       <span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_mmu_pt_update_preserve_ad</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; (preserve-AD)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CPUID_THERM_POWER_LEAF 6</span>
<span class="cp">#define APERFMPERF_PRESENT 0</span>

<span class="k">static</span> <span class="n">__read_mostly</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpuid_leaf1_edx_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">__read_mostly</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpuid_leaf1_ecx_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="n">__read_mostly</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpuid_leaf1_ecx_set_mask</span><span class="p">;</span>
<span class="k">static</span> <span class="n">__read_mostly</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpuid_leaf5_ecx_val</span><span class="p">;</span>
<span class="k">static</span> <span class="n">__read_mostly</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpuid_leaf5_edx_val</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_cpuid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ax</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bx</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">maskebx</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">maskecx</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">maskedx</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">setecx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Mask out inconvenient features, to try and disable as many</span>
<span class="cm">	 * unsupported kernel subsystems as possible.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">maskecx</span> <span class="o">=</span> <span class="n">cpuid_leaf1_ecx_mask</span><span class="p">;</span>
		<span class="n">setecx</span> <span class="o">=</span> <span class="n">cpuid_leaf1_ecx_set_mask</span><span class="p">;</span>
		<span class="n">maskedx</span> <span class="o">=</span> <span class="n">cpuid_leaf1_edx_mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPUID_MWAIT_LEAF</span>:
		<span class="cm">/* Synthesize the values.. */</span>
		<span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">cpuid_leaf5_ecx_val</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dx</span> <span class="o">=</span> <span class="n">cpuid_leaf5_edx_val</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPUID_THERM_POWER_LEAF</span>:
		<span class="cm">/* Disabling APERFMPERF for kernel usage */</span>
		<span class="n">maskecx</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">APERFMPERF_PRESENT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0xb</span>:
		<span class="cm">/* Suppress extended topology stuff */</span>
		<span class="n">maskebx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">asm</span><span class="p">(</span><span class="n">XEN_EMULATE_PREFIX</span> <span class="s">&quot;cpuid&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="p">),</span>
		  <span class="s">&quot;=b&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">bx</span><span class="p">),</span>
		  <span class="s">&quot;=c&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">cx</span><span class="p">),</span>
		  <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="p">),</span> <span class="s">&quot;2&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">cx</span><span class="p">));</span>

	<span class="o">*</span><span class="n">bx</span> <span class="o">&amp;=</span> <span class="n">maskebx</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cx</span> <span class="o">&amp;=</span> <span class="n">maskecx</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cx</span> <span class="o">|=</span> <span class="n">setecx</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dx</span> <span class="o">&amp;=</span> <span class="n">maskedx</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">xen_check_mwait</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_ACPI) &amp;&amp; !defined(CONFIG_ACPI_PROCESSOR_AGGREGATOR) &amp;&amp; \</span>
<span class="cp">	!defined(CONFIG_ACPI_PROCESSOR_AGGREGATOR_MODULE)</span>
	<span class="k">struct</span> <span class="n">xen_platform_op</span> <span class="n">op</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span>			<span class="o">=</span> <span class="n">XENPF_set_processor_pminfo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">XEN_PM_PDC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">uint32_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">dx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mwait_mask</span><span class="p">;</span>

	<span class="cm">/* We need to determine whether it is OK to expose the MWAIT</span>
<span class="cm">	 * capability to the kernel to harvest deeper than C3 states from ACPI</span>
<span class="cm">	 * _CST using the processor_harvest_xen.c module. For this to work, we</span>
<span class="cm">	 * need to gather the MWAIT_LEAF values (which the cstate.c code</span>
<span class="cm">	 * checks against). The hypervisor won&#39;t expose the MWAIT flag because</span>
<span class="cm">	 * it would break backwards compatibility; so we will find out directly</span>
<span class="cm">	 * from the hardware and hypercall.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_initial_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">native_cpuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dx</span><span class="p">);</span>

	<span class="n">mwait_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">X86_FEATURE_EST</span> <span class="o">%</span> <span class="mi">32</span><span class="p">))</span> <span class="o">|</span>
		     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">X86_FEATURE_MWAIT</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cx</span> <span class="o">&amp;</span> <span class="n">mwait_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mwait_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* We need to emulate the MWAIT_LEAF and for that we need both</span>
<span class="cm">	 * ecx and edx. The hypercall provides only partial information.</span>
<span class="cm">	 */</span>

	<span class="n">ax</span> <span class="o">=</span> <span class="n">CPUID_MWAIT_LEAF</span><span class="p">;</span>
	<span class="n">bx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">native_cpuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dx</span><span class="p">);</span>

	<span class="cm">/* Ask the Hypervisor whether to clear ACPI_PDC_C_C2C3_FFH. If so,</span>
<span class="cm">	 * don&#39;t expose MWAIT_LEAF and let ACPI pick the IOPORT version of C3.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ACPI_PDC_REVISION_ID</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ACPI_PDC_C_CAPABILITY_SMP</span> <span class="o">|</span> <span class="n">ACPI_PDC_EST_CAPABILITY_SWSMP</span><span class="p">);</span>

	<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set_pminfo</span><span class="p">.</span><span class="n">pdc</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">HYPERVISOR_dom0_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACPI_PDC_C_C1_FFH</span> <span class="o">|</span> <span class="n">ACPI_PDC_C_C2C3_FFH</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cpuid_leaf5_ecx_val</span> <span class="o">=</span> <span class="n">cx</span><span class="p">;</span>
		<span class="n">cpuid_leaf5_edx_val</span> <span class="o">=</span> <span class="n">dx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_init_cpuid_mask</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">dx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xsave_mask</span><span class="p">;</span>

	<span class="n">cpuid_leaf1_edx_mask</span> <span class="o">=</span>
		<span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">X86_FEATURE_MCE</span><span class="p">)</span>  <span class="o">|</span>  <span class="cm">/* disable MCE */</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">X86_FEATURE_MCA</span><span class="p">)</span>  <span class="o">|</span>  <span class="cm">/* disable MCA */</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">X86_FEATURE_MTRR</span><span class="p">)</span> <span class="o">|</span>  <span class="cm">/* disable MTRR */</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">X86_FEATURE_ACC</span><span class="p">));</span>   <span class="cm">/* thermal monitoring */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_initial_domain</span><span class="p">())</span>
		<span class="n">cpuid_leaf1_edx_mask</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">X86_FEATURE_APIC</span><span class="p">)</span> <span class="o">|</span>  <span class="cm">/* disable local APIC */</span>
			  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">X86_FEATURE_ACPI</span><span class="p">));</span>  <span class="cm">/* disable ACPI */</span>
	<span class="n">ax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xen_cpuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dx</span><span class="p">);</span>

	<span class="n">xsave_mask</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">X86_FEATURE_XSAVE</span> <span class="o">%</span> <span class="mi">32</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">X86_FEATURE_OSXSAVE</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>

	<span class="cm">/* Xen will set CR4.OSXSAVE if supported and not disabled by force */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cx</span> <span class="o">&amp;</span> <span class="n">xsave_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">xsave_mask</span><span class="p">)</span>
		<span class="n">cpuid_leaf1_ecx_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">xsave_mask</span><span class="p">;</span> <span class="cm">/* disable XSAVE &amp; OSXSAVE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xen_check_mwait</span><span class="p">())</span>
		<span class="n">cpuid_leaf1_ecx_set_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">X86_FEATURE_MWAIT</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_set_debugreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HYPERVISOR_set_debugreg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">xen_get_debugreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">HYPERVISOR_get_debugreg</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_end_context_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_mc_flush</span><span class="p">();</span>
	<span class="n">paravirt_end_context_switch</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">xen_store_tr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the page permissions for a particular virtual address.  If the</span>
<span class="cm"> * address is a vmalloc mapping (or other non-linear mapping), then</span>
<span class="cm"> * find the linear mapping of the page and also set its protections to</span>
<span class="cm"> * match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_aliased_prot</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">pgprot_t</span> <span class="n">prot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="n">pte</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">ptep</span> <span class="o">=</span> <span class="n">lookup_address</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ptep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pfn</span> <span class="o">=</span> <span class="n">pte_pfn</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>

	<span class="n">pte</span> <span class="o">=</span> <span class="n">pfn_pte</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_update_va_mapping</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">v</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageHighMem</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">av</span> <span class="o">=</span> <span class="n">__va</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">!=</span> <span class="n">v</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_update_va_mapping</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">av</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">kmap_flush_unused</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_alloc_ldt</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">ldt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">entries_per_page</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">LDT_ENTRY_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">entries_per_page</span><span class="p">)</span>
		<span class="n">set_aliased_prot</span><span class="p">(</span><span class="n">ldt</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">PAGE_KERNEL_RO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_free_ldt</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">ldt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">entries_per_page</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">LDT_ENTRY_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">entries_per_page</span><span class="p">)</span>
		<span class="n">set_aliased_prot</span><span class="p">(</span><span class="n">ldt</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">PAGE_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_set_ldt</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmuext_op</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multicall_space</span> <span class="n">mcs</span> <span class="o">=</span> <span class="n">xen_mc_entry</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">op</span><span class="p">));</span>

	<span class="n">trace_xen_cpu_set_ldt</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">mcs</span><span class="p">.</span><span class="n">args</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">MMUEXT_SET_LDT</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">arg1</span><span class="p">.</span><span class="n">linear_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">arg2</span><span class="p">.</span><span class="n">nr_ents</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>

	<span class="n">MULTI_mmuext_op</span><span class="p">(</span><span class="n">mcs</span><span class="p">.</span><span class="n">mc</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DOMID_SELF</span><span class="p">);</span>

	<span class="n">xen_mc_issue</span><span class="p">(</span><span class="n">PARAVIRT_LAZY_CPU</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_load_gdt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span> <span class="o">=</span> <span class="n">dtr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">dtr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frames</span><span class="p">[</span><span class="n">pages</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A GDT can be up to 64k in size, which corresponds to 8192</span>
<span class="cm">	 * 8-byte entries, or 16 4k pages..</span>
<span class="cm">	 */</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">va</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">va</span> <span class="o">&lt;</span> <span class="n">dtr</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span> <span class="n">va</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
		<span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">mfn</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">virt</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The GDT is per-cpu and is in the percpu data area.</span>
<span class="cm">		 * That can be virtually mapped, so we need to do a</span>
<span class="cm">		 * page-walk to get the underlying MFN for the</span>
<span class="cm">		 * hypercall.  The page can also be in the kernel&#39;s</span>
<span class="cm">		 * linear range, so we need to RO that mapping too.</span>
<span class="cm">		 */</span>
		<span class="n">ptep</span> <span class="o">=</span> <span class="n">lookup_address</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ptep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">pfn</span> <span class="o">=</span> <span class="n">pte_pfn</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
		<span class="n">mfn</span> <span class="o">=</span> <span class="n">pfn_to_mfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
		<span class="n">virt</span> <span class="o">=</span> <span class="n">__va</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>

		<span class="n">frames</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfn</span><span class="p">;</span>

		<span class="n">make_lowmem_page_readonly</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">va</span><span class="p">);</span>
		<span class="n">make_lowmem_page_readonly</span><span class="p">(</span><span class="n">virt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_set_gdt</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span><span class="p">)))</span>
		<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * load_gdt for early boot, when the gdt is only mapped once</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_load_gdt_boot</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span> <span class="o">=</span> <span class="n">dtr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">dtr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frames</span><span class="p">[</span><span class="n">pages</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A GDT can be up to 64k in size, which corresponds to 8192</span>
<span class="cm">	 * 8-byte entries, or 16 4k pages..</span>
<span class="cm">	 */</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">va</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">va</span> <span class="o">&lt;</span> <span class="n">dtr</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span> <span class="n">va</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pte_t</span> <span class="n">pte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">mfn</span><span class="p">;</span>

		<span class="n">pfn</span> <span class="o">=</span> <span class="n">virt_to_pfn</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
		<span class="n">mfn</span> <span class="o">=</span> <span class="n">pfn_to_mfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>

		<span class="n">pte</span> <span class="o">=</span> <span class="n">pfn_pte</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">PAGE_KERNEL_RO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_update_va_mapping</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">frames</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_set_gdt</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span><span class="p">)))</span>
		<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">load_TLS_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">gdt</span> <span class="o">=</span> <span class="n">get_cpu_gdt_table</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">xmaddr_t</span> <span class="n">maddr</span> <span class="o">=</span> <span class="n">arbitrary_virt_to_machine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdt</span><span class="p">[</span><span class="n">GDT_ENTRY_TLS_MIN</span><span class="o">+</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">multicall_space</span> <span class="n">mc</span> <span class="o">=</span> <span class="n">__xen_mc_entry</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">MULTI_update_descriptor</span><span class="p">(</span><span class="n">mc</span><span class="p">.</span><span class="n">mc</span><span class="p">,</span> <span class="n">maddr</span><span class="p">.</span><span class="n">maddr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tls_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_load_tls</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX sleazy hack: If we&#39;re being called in a lazy-cpu zone</span>
<span class="cm">	 * and lazy gs handling is enabled, it means we&#39;re in a</span>
<span class="cm">	 * context switch, and %gs has just been saved.  This means we</span>
<span class="cm">	 * can zero it out to prevent faults on exit from the</span>
<span class="cm">	 * hypervisor if the next process has no %gs.  Either way, it</span>
<span class="cm">	 * has been saved, and the new value will get loaded properly.</span>
<span class="cm">	 * This will go away as soon as Xen has been modified to not</span>
<span class="cm">	 * save/restore %gs for normal hypercalls.</span>
<span class="cm">	 *</span>
<span class="cm">	 * On x86_64, this hack is not used for %gs, because gs points</span>
<span class="cm">	 * to KERNEL_GS_BASE (and uses it for PDA references), so we</span>
<span class="cm">	 * must not zero %gs on x86_64</span>
<span class="cm">	 *</span>
<span class="cm">	 * For x86_64, we need to zero %fs, otherwise we may get an</span>
<span class="cm">	 * exception between the new %fs descriptor being loaded and</span>
<span class="cm">	 * %fs being effectively cleared at __switch_to().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paravirt_get_lazy_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">PARAVIRT_LAZY_CPU</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
		<span class="n">lazy_load_gs</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">loadsegment</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">xen_mc_batch</span><span class="p">();</span>

	<span class="n">load_TLS_descriptor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">load_TLS_descriptor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">load_TLS_descriptor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">xen_mc_issue</span><span class="p">(</span><span class="n">PARAVIRT_LAZY_CPU</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_load_gs_index</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_set_segment_base</span><span class="p">(</span><span class="n">SEGBASE_GS_USER_SEL</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_write_ldt_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entrynum</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xmaddr_t</span> <span class="n">mach_lp</span> <span class="o">=</span> <span class="n">arbitrary_virt_to_machine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dt</span><span class="p">[</span><span class="n">entrynum</span><span class="p">]);</span>
	<span class="n">u64</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">trace_xen_cpu_write_ldt_entry</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">entrynum</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

	<span class="n">preempt_disable</span><span class="p">();</span>

	<span class="n">xen_mc_flush</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_update_descriptor</span><span class="p">(</span><span class="n">mach_lp</span><span class="p">.</span><span class="n">maddr</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cvt_gate_to_trap</span><span class="p">(</span><span class="kt">int</span> <span class="n">vector</span><span class="p">,</span> <span class="k">const</span> <span class="n">gate_desc</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">trap_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">GATE_TRAP</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">GATE_INTERRUPT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">gate_offset</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="cm">/*</span>
<span class="cm">	 * Look for known traps using IST, and substitute them</span>
<span class="cm">	 * appropriately.  The debugger ones are the only ones we care</span>
<span class="cm">	 * about.  Xen will handle faults like double_fault and</span>
<span class="cm">	 * machine_check, so we should never see them.  Warn if</span>
<span class="cm">	 * there&#39;s an unexpected IST-using fault handler.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xen_debug</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">int3</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xen_int3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">stack_segment</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xen_stack_segment</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">double_fault</span> <span class="o">||</span>
		 <span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nmi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t need to handle these */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_X86_MCE</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">machine_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Some other trap using IST? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">ist</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_X86_64 */</span><span class="cp"></span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="n">gate_segment</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">dpl</span><span class="p">;</span>
	<span class="cm">/* interrupt gates clear IF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GATE_INTERRUPT</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Locations of each CPU&#39;s IDT */</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_ptr</span><span class="p">,</span> <span class="n">idt_desc</span><span class="p">);</span>

<span class="cm">/* Set an IDT entry.  If the entry is part of the current IDT, then</span>
<span class="cm">   also update Xen. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_write_idt_entry</span><span class="p">(</span><span class="n">gate_desc</span> <span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entrynum</span><span class="p">,</span> <span class="k">const</span> <span class="n">gate_desc</span> <span class="o">*</span><span class="n">g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dt</span><span class="p">[</span><span class="n">entrynum</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">trace_xen_cpu_write_idt_entry</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">entrynum</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span>

	<span class="n">preempt_disable</span><span class="p">();</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">__this_cpu_read</span><span class="p">(</span><span class="n">idt_desc</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">__this_cpu_read</span><span class="p">(</span><span class="n">idt_desc</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">xen_mc_flush</span><span class="p">();</span>

	<span class="n">native_write_idt_entry</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">entrynum</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">trap_info</span> <span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cvt_gate_to_trap</span><span class="p">(</span><span class="n">entrynum</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_set_trap_table</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
				<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_convert_trap_info</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">trap_info</span> <span class="o">*</span><span class="n">traps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gate_desc</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">in</span> <span class="o">=</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">in</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">in</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gate_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">gate_desc</span><span class="o">*</span><span class="p">)(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span> <span class="n">in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cvt_gate_to_trap</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">traps</span><span class="p">[</span><span class="n">out</span><span class="p">]))</span>
			<span class="n">out</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">traps</span><span class="p">[</span><span class="n">out</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">xen_copy_trap_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_info</span> <span class="o">*</span><span class="n">traps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">idt_desc</span><span class="p">);</span>

	<span class="n">xen_convert_trap_info</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">traps</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Load a new IDT into Xen.  In principle this can be per-CPU, so we</span>
<span class="cm">   hold a spinlock to protect the static traps[] array (static because</span>
<span class="cm">   it avoids allocation, and saves stack space). */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_load_idt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">trap_info</span> <span class="n">traps</span><span class="p">[</span><span class="mi">257</span><span class="p">];</span>

	<span class="n">trace_xen_cpu_load_idt</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">idt_desc</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">xen_convert_trap_info</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">traps</span><span class="p">);</span>

	<span class="n">xen_mc_flush</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_set_trap_table</span><span class="p">(</span><span class="n">traps</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Write a GDT descriptor entry.  Ignore LDT descriptors, since</span>
<span class="cm">   they&#39;re handled differently. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_write_gdt_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">trace_xen_cpu_write_gdt_entry</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="n">preempt_disable</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DESC_LDT</span>:
	<span class="k">case</span> <span class="n">DESC_TSS</span>:
		<span class="cm">/* ignore */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="p">{</span>
		<span class="n">xmaddr_t</span> <span class="n">maddr</span> <span class="o">=</span> <span class="n">arbitrary_virt_to_machine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dt</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>

		<span class="n">xen_mc_flush</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_update_descriptor</span><span class="p">(</span><span class="n">maddr</span><span class="p">.</span><span class="n">maddr</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Version of write_gdt_entry for use at early boot-time needed to</span>
<span class="cm"> * update an entry as simply as possible.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_write_gdt_entry_boot</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">trace_xen_cpu_write_gdt_entry</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DESC_LDT</span>:
	<span class="k">case</span> <span class="n">DESC_TSS</span>:
		<span class="cm">/* ignore */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="p">{</span>
		<span class="n">xmaddr_t</span> <span class="n">maddr</span> <span class="o">=</span> <span class="n">virt_to_machine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dt</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_update_descriptor</span><span class="p">(</span><span class="n">maddr</span><span class="p">.</span><span class="n">maddr</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">))</span>
			<span class="n">dt</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_load_sp0</span><span class="p">(</span><span class="k">struct</span> <span class="n">tss_struct</span> <span class="o">*</span><span class="n">tss</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">thread_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multicall_space</span> <span class="n">mcs</span><span class="p">;</span>

	<span class="n">mcs</span> <span class="o">=</span> <span class="n">xen_mc_entry</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">MULTI_stack_switch</span><span class="p">(</span><span class="n">mcs</span><span class="p">.</span><span class="n">mc</span><span class="p">,</span> <span class="n">__KERNEL_DS</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">sp0</span><span class="p">);</span>
	<span class="n">xen_mc_issue</span><span class="p">(</span><span class="n">PARAVIRT_LAZY_CPU</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_set_iopl_mask</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">physdev_set_iopl</span> <span class="n">set_iopl</span><span class="p">;</span>

	<span class="cm">/* Force the change at ring 0. */</span>
	<span class="n">set_iopl</span><span class="p">.</span><span class="n">iopl</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_set_iopl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set_iopl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_io_delay</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">xen_set_apic_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">xen_get_apic_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFu</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">xen_apic_read</span><span class="p">(</span><span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_platform_op</span> <span class="n">op</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">XENPF_get_cpuinfo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">interface_version</span> <span class="o">=</span> <span class="n">XENPF_INTERFACE_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pcpu_info</span><span class="p">.</span><span class="n">xen_cpuid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Shouldn&#39;t need this as APIC is turned off for PV, and we only</span>
<span class="cm">	 * get called on the bootup processor. But just in case. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_initial_domain</span><span class="p">()</span> <span class="o">||</span> <span class="n">smp_processor_id</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">APIC_LVR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">APIC_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_dom0_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pcpu_info</span><span class="p">.</span><span class="n">apic_id</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_apic_write</span><span class="p">(</span><span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Warn to see if there&#39;s any stray references */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">xen_apic_icr_read</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_apic_icr_write</span><span class="p">(</span><span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Warn to see if there&#39;s any stray references */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_apic_wait_icr_idle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">xen_safe_apic_wait_icr_idle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_xen_basic_apic_ops</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">xen_apic_read</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">xen_apic_write</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">icr_read</span> <span class="o">=</span> <span class="n">xen_apic_icr_read</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">icr_write</span> <span class="o">=</span> <span class="n">xen_apic_icr_write</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">wait_icr_idle</span> <span class="o">=</span> <span class="n">xen_apic_wait_icr_idle</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">safe_wait_icr_idle</span> <span class="o">=</span> <span class="n">xen_safe_apic_wait_icr_idle</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">set_apic_id</span> <span class="o">=</span> <span class="n">xen_set_apic_id</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">get_apic_id</span> <span class="o">=</span> <span class="n">xen_get_apic_id</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">send_IPI_allbutself</span> <span class="o">=</span> <span class="n">xen_send_IPI_allbutself</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">send_IPI_mask_allbutself</span> <span class="o">=</span> <span class="n">xen_send_IPI_mask_allbutself</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">send_IPI_mask</span> <span class="o">=</span> <span class="n">xen_send_IPI_mask</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">send_IPI_all</span> <span class="o">=</span> <span class="n">xen_send_IPI_all</span><span class="p">;</span>
	<span class="n">apic</span><span class="o">-&gt;</span><span class="n">send_IPI_self</span> <span class="o">=</span> <span class="n">xen_send_IPI_self</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_clts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multicall_space</span> <span class="n">mcs</span><span class="p">;</span>

	<span class="n">mcs</span> <span class="o">=</span> <span class="n">xen_mc_entry</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">MULTI_fpu_taskswitch</span><span class="p">(</span><span class="n">mcs</span><span class="p">.</span><span class="n">mc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">xen_mc_issue</span><span class="p">(</span><span class="n">PARAVIRT_LAZY_CPU</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">xen_cr0_value</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">xen_read_cr0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr0</span> <span class="o">=</span> <span class="n">this_cpu_read</span><span class="p">(</span><span class="n">xen_cr0_value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cr0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cr0</span> <span class="o">=</span> <span class="n">native_read_cr0</span><span class="p">();</span>
		<span class="n">this_cpu_write</span><span class="p">(</span><span class="n">xen_cr0_value</span><span class="p">,</span> <span class="n">cr0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cr0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_write_cr0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multicall_space</span> <span class="n">mcs</span><span class="p">;</span>

	<span class="n">this_cpu_write</span><span class="p">(</span><span class="n">xen_cr0_value</span><span class="p">,</span> <span class="n">cr0</span><span class="p">);</span>

	<span class="cm">/* Only pay attention to cr0.TS; everything else is</span>
<span class="cm">	   ignored. */</span>
	<span class="n">mcs</span> <span class="o">=</span> <span class="n">xen_mc_entry</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">MULTI_fpu_taskswitch</span><span class="p">(</span><span class="n">mcs</span><span class="p">.</span><span class="n">mc</span><span class="p">,</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="n">X86_CR0_TS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">xen_mc_issue</span><span class="p">(</span><span class="n">PARAVIRT_LAZY_CPU</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_write_cr4</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cr4</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">X86_CR4_PGE</span><span class="p">;</span>
	<span class="n">cr4</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">X86_CR4_PSE</span><span class="p">;</span>

	<span class="n">native_write_cr4</span><span class="p">(</span><span class="n">cr4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_write_msr_safe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">low</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
		<span class="kt">unsigned</span> <span class="n">which</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSR_FS_BASE</span>:		<span class="n">which</span> <span class="o">=</span> <span class="n">SEGBASE_FS</span><span class="p">;</span> <span class="k">goto</span> <span class="n">set</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_KERNEL_GS_BASE</span>:	<span class="n">which</span> <span class="o">=</span> <span class="n">SEGBASE_GS_USER</span><span class="p">;</span> <span class="k">goto</span> <span class="n">set</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_GS_BASE</span>:		<span class="n">which</span> <span class="o">=</span> <span class="n">SEGBASE_GS_KERNEL</span><span class="p">;</span> <span class="k">goto</span> <span class="n">set</span><span class="p">;</span>

	<span class="nl">set:</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_set_segment_base</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">MSR_STAR</span>:
	<span class="k">case</span> <span class="n">MSR_CSTAR</span>:
	<span class="k">case</span> <span class="n">MSR_LSTAR</span>:
	<span class="k">case</span> <span class="n">MSR_SYSCALL_MASK</span>:
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_CS</span>:
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_ESP</span>:
	<span class="k">case</span> <span class="n">MSR_IA32_SYSENTER_EIP</span>:
		<span class="cm">/* Fast syscall setup is all done in hypercalls, so</span>
<span class="cm">		   these are all ignored.  Stub them out here to stop</span>
<span class="cm">		   Xen console noise. */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSR_IA32_CR_PAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xen_set_pat</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">native_write_msr_safe</span><span class="p">(</span><span class="n">msr</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">xen_setup_shared_info</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_auto_translated_physmap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_fixmap</span><span class="p">(</span><span class="n">FIX_PARAVIRT_BOOTMAP</span><span class="p">,</span>
			   <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">shared_info</span><span class="p">);</span>

		<span class="n">HYPERVISOR_shared_info</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">shared_info</span> <span class="o">*</span><span class="p">)</span><span class="n">fix_to_virt</span><span class="p">(</span><span class="n">FIX_PARAVIRT_BOOTMAP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">HYPERVISOR_shared_info</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">shared_info</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">shared_info</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_SMP</span>
	<span class="cm">/* In UP this is as good a place as any to set up shared info */</span>
	<span class="n">xen_setup_vcpu_info_placement</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">xen_setup_mfn_list_list</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* This is called once we have the cpu_possible_mask */</span>
<span class="kt">void</span> <span class="nf">xen_setup_vcpu_info_placement</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
		<span class="n">xen_vcpu_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/* xen_vcpu_setup managed to place the vcpu_info within the</span>
<span class="cm">	   percpu area for all cpus, so make use of it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">have_vcpu_info_placement</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">save_fl</span> <span class="o">=</span> <span class="n">__PV_IS_CALLEE_SAVE</span><span class="p">(</span><span class="n">xen_save_fl_direct</span><span class="p">);</span>
		<span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">restore_fl</span> <span class="o">=</span> <span class="n">__PV_IS_CALLEE_SAVE</span><span class="p">(</span><span class="n">xen_restore_fl_direct</span><span class="p">);</span>
		<span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">irq_disable</span> <span class="o">=</span> <span class="n">__PV_IS_CALLEE_SAVE</span><span class="p">(</span><span class="n">xen_irq_disable_direct</span><span class="p">);</span>
		<span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">__PV_IS_CALLEE_SAVE</span><span class="p">(</span><span class="n">xen_irq_enable_direct</span><span class="p">);</span>
		<span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">read_cr2</span> <span class="o">=</span> <span class="n">xen_read_cr2_direct</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">xen_patch</span><span class="p">(</span><span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">clobbers</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">insnbuf</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">reloc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="n">reloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#define SITE(op, x)							\</span>
<span class="cp">	case PARAVIRT_PATCH(op.x):					\</span>
<span class="cp">	if (have_vcpu_info_placement) {					\</span>
<span class="cp">		start = (char *)xen_##x##_direct;			\</span>
<span class="cp">		end = xen_##x##_direct_end;				\</span>
<span class="cp">		reloc = xen_##x##_direct_reloc;				\</span>
<span class="cp">	}								\</span>
<span class="cp">	goto patch_site</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SITE</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">,</span> <span class="n">irq_enable</span><span class="p">);</span>
		<span class="n">SITE</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">,</span> <span class="n">irq_disable</span><span class="p">);</span>
		<span class="n">SITE</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">,</span> <span class="n">save_fl</span><span class="p">);</span>
		<span class="n">SITE</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">,</span> <span class="n">restore_fl</span><span class="p">);</span>
<span class="cp">#undef SITE</span>

	<span class="nl">patch_site:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">default_patch</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">paravirt_patch_insns</span><span class="p">(</span><span class="n">insnbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

		<span class="cm">/* Note: because reloc is assigned from something that</span>
<span class="cm">		   appears to be an array, gcc assumes it&#39;s non-null,</span>
<span class="cm">		   but doesn&#39;t know its relationship with start and</span>
<span class="cm">		   end. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">reloc</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">reloc_off</span> <span class="o">=</span> <span class="n">reloc</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
			<span class="kt">long</span> <span class="o">*</span><span class="n">relocp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">insnbuf</span> <span class="o">+</span> <span class="n">reloc_off</span><span class="p">);</span>
			<span class="kt">long</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>

			<span class="o">*</span><span class="n">relocp</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default_patch:</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">paravirt_patch_default</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">clobbers</span><span class="p">,</span> <span class="n">insnbuf</span><span class="p">,</span>
					     <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pv_info</span> <span class="n">xen_info</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">paravirt_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shared_kernel_pmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="p">.</span><span class="n">extra_user_64bit_cs</span> <span class="o">=</span> <span class="n">FLAT_USER_CS64</span><span class="p">,</span>
<span class="cp">#endif</span>

	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Xen&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pv_init_ops</span> <span class="n">xen_init_ops</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">xen_patch</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pv_cpu_ops</span> <span class="n">xen_cpu_ops</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cpuid</span> <span class="o">=</span> <span class="n">xen_cpuid</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_debugreg</span> <span class="o">=</span> <span class="n">xen_set_debugreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_debugreg</span> <span class="o">=</span> <span class="n">xen_get_debugreg</span><span class="p">,</span>

	<span class="p">.</span><span class="n">clts</span> <span class="o">=</span> <span class="n">xen_clts</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_cr0</span> <span class="o">=</span> <span class="n">xen_read_cr0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_cr0</span> <span class="o">=</span> <span class="n">xen_write_cr0</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_cr4</span> <span class="o">=</span> <span class="n">native_read_cr4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_cr4_safe</span> <span class="o">=</span> <span class="n">native_read_cr4_safe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_cr4</span> <span class="o">=</span> <span class="n">xen_write_cr4</span><span class="p">,</span>

	<span class="p">.</span><span class="n">wbinvd</span> <span class="o">=</span> <span class="n">native_wbinvd</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_msr</span> <span class="o">=</span> <span class="n">native_read_msr_safe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rdmsr_regs</span> <span class="o">=</span> <span class="n">native_rdmsr_safe_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_msr</span> <span class="o">=</span> <span class="n">xen_write_msr_safe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wrmsr_regs</span> <span class="o">=</span> <span class="n">native_wrmsr_safe_regs</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_tsc</span> <span class="o">=</span> <span class="n">native_read_tsc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_pmc</span> <span class="o">=</span> <span class="n">native_read_pmc</span><span class="p">,</span>

	<span class="p">.</span><span class="n">iret</span> <span class="o">=</span> <span class="n">xen_iret</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_enable_sysexit</span> <span class="o">=</span> <span class="n">xen_sysexit</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="p">.</span><span class="n">usergs_sysret32</span> <span class="o">=</span> <span class="n">xen_sysret32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">usergs_sysret64</span> <span class="o">=</span> <span class="n">xen_sysret64</span><span class="p">,</span>
<span class="cp">#endif</span>

	<span class="p">.</span><span class="n">load_tr_desc</span> <span class="o">=</span> <span class="n">paravirt_nop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ldt</span> <span class="o">=</span> <span class="n">xen_set_ldt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_gdt</span> <span class="o">=</span> <span class="n">xen_load_gdt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_idt</span> <span class="o">=</span> <span class="n">xen_load_idt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_tls</span> <span class="o">=</span> <span class="n">xen_load_tls</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="p">.</span><span class="n">load_gs_index</span> <span class="o">=</span> <span class="n">xen_load_gs_index</span><span class="p">,</span>
<span class="cp">#endif</span>

	<span class="p">.</span><span class="n">alloc_ldt</span> <span class="o">=</span> <span class="n">xen_alloc_ldt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_ldt</span> <span class="o">=</span> <span class="n">xen_free_ldt</span><span class="p">,</span>

	<span class="p">.</span><span class="n">store_gdt</span> <span class="o">=</span> <span class="n">native_store_gdt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_idt</span> <span class="o">=</span> <span class="n">native_store_idt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store_tr</span> <span class="o">=</span> <span class="n">xen_store_tr</span><span class="p">,</span>

	<span class="p">.</span><span class="n">write_ldt_entry</span> <span class="o">=</span> <span class="n">xen_write_ldt_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_gdt_entry</span> <span class="o">=</span> <span class="n">xen_write_gdt_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_idt_entry</span> <span class="o">=</span> <span class="n">xen_write_idt_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_sp0</span> <span class="o">=</span> <span class="n">xen_load_sp0</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_iopl_mask</span> <span class="o">=</span> <span class="n">xen_set_iopl_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">io_delay</span> <span class="o">=</span> <span class="n">xen_io_delay</span><span class="p">,</span>

	<span class="cm">/* Xen takes care of %gs when switching to usermode for us */</span>
	<span class="p">.</span><span class="n">swapgs</span> <span class="o">=</span> <span class="n">paravirt_nop</span><span class="p">,</span>

	<span class="p">.</span><span class="n">start_context_switch</span> <span class="o">=</span> <span class="n">paravirt_start_context_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end_context_switch</span> <span class="o">=</span> <span class="n">xen_end_context_switch</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pv_apic_ops</span> <span class="n">xen_apic_ops</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
	<span class="p">.</span><span class="n">startup_ipi_hook</span> <span class="o">=</span> <span class="n">paravirt_nop</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_reboot</span><span class="p">(</span><span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sched_shutdown</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_sched_op</span><span class="p">(</span><span class="n">SCHEDOP_shutdown</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_restart</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_reboot</span><span class="p">(</span><span class="n">SHUTDOWN_reboot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_emergency_restart</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_reboot</span><span class="p">(</span><span class="n">SHUTDOWN_reboot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_machine_halt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_reboot</span><span class="p">(</span><span class="n">SHUTDOWN_poweroff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_machine_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_power_off</span><span class="p">)</span>
		<span class="n">pm_power_off</span><span class="p">();</span>
	<span class="n">xen_reboot</span><span class="p">(</span><span class="n">SHUTDOWN_poweroff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_crash_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_reboot</span><span class="p">(</span><span class="n">SHUTDOWN_crash</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xen_panic_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_reboot</span><span class="p">(</span><span class="n">SHUTDOWN_crash</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">xen_panic_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span><span class="o">=</span> <span class="n">xen_panic_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">xen_panic_handler_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">panic_notifier_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xen_panic_block</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">machine_ops</span> <span class="n">xen_machine_ops</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="n">xen_restart</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt</span> <span class="o">=</span> <span class="n">xen_machine_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">xen_machine_power_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">xen_machine_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crash_shutdown</span> <span class="o">=</span> <span class="n">xen_crash_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">emergency_restart</span> <span class="o">=</span> <span class="n">xen_emergency_restart</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Set up the GDT and segment registers for -fstack-protector.  Until</span>
<span class="cm"> * we do this, we have to be careful not to call any stack-protected</span>
<span class="cm"> * function, which is most of the kernel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_setup_stackprotector</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_gdt_entry</span> <span class="o">=</span> <span class="n">xen_write_gdt_entry_boot</span><span class="p">;</span>
	<span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">load_gdt</span> <span class="o">=</span> <span class="n">xen_load_gdt_boot</span><span class="p">;</span>

	<span class="n">setup_stack_canary_segment</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">switch_to_new_gdt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_gdt_entry</span> <span class="o">=</span> <span class="n">xen_write_gdt_entry</span><span class="p">;</span>
	<span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">load_gdt</span> <span class="o">=</span> <span class="n">xen_load_gdt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* First C function to be called on Xen boot */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_start_kernel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">physdev_set_iopl</span> <span class="n">set_iopl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">pgd_t</span> <span class="o">*</span><span class="n">pgd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_start_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">xen_domain_type</span> <span class="o">=</span> <span class="n">XEN_PV_DOMAIN</span><span class="p">;</span>

	<span class="n">xen_setup_machphys_mapping</span><span class="p">();</span>

	<span class="cm">/* Install Xen paravirt ops */</span>
	<span class="n">pv_info</span> <span class="o">=</span> <span class="n">xen_info</span><span class="p">;</span>
	<span class="n">pv_init_ops</span> <span class="o">=</span> <span class="n">xen_init_ops</span><span class="p">;</span>
	<span class="n">pv_cpu_ops</span> <span class="o">=</span> <span class="n">xen_cpu_ops</span><span class="p">;</span>
	<span class="n">pv_apic_ops</span> <span class="o">=</span> <span class="n">xen_apic_ops</span><span class="p">;</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">memory_setup</span> <span class="o">=</span> <span class="n">xen_memory_setup</span><span class="p">;</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">oem</span><span class="p">.</span><span class="n">arch_setup</span> <span class="o">=</span> <span class="n">xen_arch_setup</span><span class="p">;</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">oem</span><span class="p">.</span><span class="n">banner</span> <span class="o">=</span> <span class="n">xen_banner</span><span class="p">;</span>

	<span class="n">xen_init_time_ops</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up some pagetable state before starting to set any ptes.</span>
<span class="cm">	 */</span>

	<span class="n">xen_init_mmu_ops</span><span class="p">();</span>

	<span class="cm">/* Prevent unwanted bits from being set in PTEs. */</span>
	<span class="n">__supported_pte_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_PAGE_GLOBAL</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (!xen_initial_domain())</span>
<span class="cp">#endif</span>
		<span class="n">__supported_pte_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">_PAGE_PWT</span> <span class="o">|</span> <span class="n">_PAGE_PCD</span><span class="p">);</span>

	<span class="n">__supported_pte_mask</span> <span class="o">|=</span> <span class="n">_PAGE_IOMAP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Prevent page tables from being allocated in highmem, even</span>
<span class="cm">	 * if CONFIG_HIGHPTE is enabled.</span>
<span class="cm">	 */</span>
	<span class="n">__userpte_alloc_gfp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__GFP_HIGHMEM</span><span class="p">;</span>

	<span class="cm">/* Work out if we support NX */</span>
	<span class="n">x86_configure_nx</span><span class="p">();</span>

	<span class="n">xen_setup_features</span><span class="p">();</span>

	<span class="cm">/* Get mfn list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_auto_translated_physmap</span><span class="p">))</span>
		<span class="n">xen_build_dynamic_phys_to_machine</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up kernel GDT and segment registers, mainly so that</span>
<span class="cm">	 * -fstack-protector code can be executed.</span>
<span class="cm">	 */</span>
	<span class="n">xen_setup_stackprotector</span><span class="p">();</span>

	<span class="n">xen_init_irq_ops</span><span class="p">();</span>
	<span class="n">xen_init_cpuid_mask</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_X86_LOCAL_APIC</span>
	<span class="cm">/*</span>
<span class="cm">	 * set up the basic apic ops.</span>
<span class="cm">	 */</span>
	<span class="n">set_xen_basic_apic_ops</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_mmu_pt_update_preserve_ad</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">ptep_modify_prot_start</span> <span class="o">=</span> <span class="n">xen_ptep_modify_prot_start</span><span class="p">;</span>
		<span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">ptep_modify_prot_commit</span> <span class="o">=</span> <span class="n">xen_ptep_modify_prot_commit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">machine_ops</span> <span class="o">=</span> <span class="n">xen_machine_ops</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The only reliable way to retain the initial address of the</span>
<span class="cm">	 * percpu gdt_page is to remember it here, so we can go and</span>
<span class="cm">	 * mark it RW later, when the initial percpu area is freed.</span>
<span class="cm">	 */</span>
	<span class="n">xen_initial_gdt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">gdt_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">xen_smp_init</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_ACPI_NUMA</span>
	<span class="cm">/*</span>
<span class="cm">	 * The pages we from Xen are not related to machine pages, so</span>
<span class="cm">	 * any NUMA information the kernel tries to get from ACPI will</span>
<span class="cm">	 * be meaningless.  Prevent it from trying.</span>
<span class="cm">	 */</span>
	<span class="n">acpi_numa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pgd</span> <span class="o">=</span> <span class="p">(</span><span class="n">pgd_t</span> <span class="o">*</span><span class="p">)</span><span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">pt_base</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t do the full vcpu_info placement stuff until we have a</span>
<span class="cm">	   possible map and a non-dummy shared_info. */</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">xen_vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HYPERVISOR_shared_info</span><span class="o">-&gt;</span><span class="n">vcpu_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">early_boot_irqs_disabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">xen_raw_console_write</span><span class="p">(</span><span class="s">&quot;mapping kernel into physical memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pgd</span> <span class="o">=</span> <span class="n">xen_setup_kernel_pagetable</span><span class="p">(</span><span class="n">pgd</span><span class="p">,</span> <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">);</span>

	<span class="cm">/* Allocate and initialize top and mid mfn levels for p2m structure */</span>
	<span class="n">xen_build_mfn_list_list</span><span class="p">();</span>

	<span class="cm">/* keep using Xen gdt for now; no urgent need to change it */</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">pv_info</span><span class="p">.</span><span class="n">kernel_rpl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_supervisor_mode_kernel</span><span class="p">))</span>
		<span class="n">pv_info</span><span class="p">.</span><span class="n">kernel_rpl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">pv_info</span><span class="p">.</span><span class="n">kernel_rpl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* set the limit of our address space */</span>
	<span class="n">xen_reserve_top</span><span class="p">();</span>

	<span class="cm">/* We used to do this in xen_arch_setup, but that is too late on AMD</span>
<span class="cm">	 * were early_cpu_init (run before -&gt;arch_setup()) calls early_amd_init</span>
<span class="cm">	 * which pokes 0xcf8 port.</span>
<span class="cm">	 */</span>
	<span class="n">set_iopl</span><span class="p">.</span><span class="n">iopl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_set_iopl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set_iopl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xen_raw_printk</span><span class="p">(</span><span class="s">&quot;physdev_op failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="cm">/* set up basic CPUID stuff */</span>
	<span class="n">cpu_detect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_cpu_data</span><span class="p">);</span>
	<span class="n">new_cpu_data</span><span class="p">.</span><span class="n">hard_math</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">new_cpu_data</span><span class="p">.</span><span class="n">wp_works_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">new_cpu_data</span><span class="p">.</span><span class="n">x86_capability</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpuid_edx</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Poke various useful things into boot_params */</span>
	<span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type_of_loader</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ramdisk_image</span> <span class="o">=</span> <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">mod_start</span>
		<span class="o">?</span> <span class="n">__pa</span><span class="p">(</span><span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">mod_start</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ramdisk_size</span> <span class="o">=</span> <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">mod_len</span><span class="p">;</span>
	<span class="n">boot_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd_line_ptr</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">cmd_line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_initial_domain</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;xenboot&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;tty&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;hvc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_xen</span><span class="p">)</span>
			<span class="n">x86_init</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">arch_init</span> <span class="o">=</span> <span class="n">pci_xen_init</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dom0_vga_console_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xen_start_info</span> <span class="o">+</span>
				 <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">console</span><span class="p">.</span><span class="n">dom0</span><span class="p">.</span><span class="n">info_off</span><span class="p">);</span>

		<span class="n">xen_init_vga</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">console</span><span class="p">.</span><span class="n">dom0</span><span class="p">.</span><span class="n">info_size</span><span class="p">);</span>
		<span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">console</span><span class="p">.</span><span class="n">domU</span><span class="p">.</span><span class="n">mfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">console</span><span class="p">.</span><span class="n">domU</span><span class="p">.</span><span class="n">evtchn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">xen_init_apic</span><span class="p">();</span>

		<span class="cm">/* Make sure ACS will be enabled */</span>
		<span class="n">pci_request_acs</span><span class="p">();</span>

		<span class="n">xen_acpi_sleep_register</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="cm">/* PCI BIOS service won&#39;t work from a PV guest. */</span>
	<span class="n">pci_probe</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_PROBE_BIOS</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">xen_raw_console_write</span><span class="p">(</span><span class="s">&quot;about to get started...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">xen_setup_runstate_info</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Start the world */</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">i386_start_kernel</span><span class="p">();</span>
<span class="cp">#else</span>
	<span class="n">x86_64_start_reservations</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__pa_symbol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_params</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_hvm_pv_info</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">major</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">msr</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pfn</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">xen_cpuid_base</span><span class="p">();</span>
	<span class="n">cpuid</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">);</span>

	<span class="o">*</span><span class="n">major</span> <span class="o">=</span> <span class="n">eax</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="o">*</span><span class="n">minor</span> <span class="o">=</span> <span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Xen version %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">major</span><span class="p">,</span> <span class="o">*</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">cpuid</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">);</span>

	<span class="n">pfn</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">hypercall_page</span><span class="p">);</span>
	<span class="n">wrmsr_safe</span><span class="p">(</span><span class="n">msr</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pfn</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">pfn</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>

	<span class="n">xen_setup_features</span><span class="p">();</span>

	<span class="n">pv_info</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Xen HVM&quot;</span><span class="p">;</span>

	<span class="n">xen_domain_type</span> <span class="o">=</span> <span class="n">XEN_HVM_DOMAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__ref</span> <span class="nf">xen_hvm_init_shared_info</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_add_to_physmap</span> <span class="n">xatp</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">shared_info</span> <span class="o">*</span><span class="n">shared_info_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shared_info_page</span><span class="p">)</span>
		<span class="n">shared_info_page</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">shared_info</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">extend_brk</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">xatp</span><span class="p">.</span><span class="n">domid</span> <span class="o">=</span> <span class="n">DOMID_SELF</span><span class="p">;</span>
	<span class="n">xatp</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xatp</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">XENMAPSPACE_shared_info</span><span class="p">;</span>
	<span class="n">xatp</span><span class="p">.</span><span class="n">gpfn</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">shared_info_page</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HYPERVISOR_memory_op</span><span class="p">(</span><span class="n">XENMEM_add_to_physmap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xatp</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">HYPERVISOR_shared_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">shared_info</span> <span class="o">*</span><span class="p">)</span><span class="n">shared_info_page</span><span class="p">;</span>

	<span class="cm">/* xen_vcpu is a pointer to the vcpu_info struct in the shared_info</span>
<span class="cm">	 * page, we use it in the event channel upcall and in some pvclock</span>
<span class="cm">	 * related functions. We don&#39;t need the vcpu_info placement</span>
<span class="cm">	 * optimizations because we don&#39;t use any pv_mmu or pv_irq op on</span>
<span class="cm">	 * HVM.</span>
<span class="cm">	 * When xen_hvm_init_shared_info is run at boot time only vcpu 0 is</span>
<span class="cm">	 * online but xen_hvm_init_shared_info is run at resume time too and</span>
<span class="cm">	 * in that case multiple vcpus might be online. */</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">xen_vcpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HYPERVISOR_shared_info</span><span class="o">-&gt;</span><span class="n">vcpu_info</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_XEN_PVHVM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">xen_hvm_cpu_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_UP_PREPARE</span>:
		<span class="n">xen_vcpu_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xen_have_vector_callback</span><span class="p">)</span>
			<span class="n">xen_init_lock_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">xen_hvm_cpu_notifier</span> <span class="n">__cpuinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">xen_hvm_cpu_notify</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_hvm_guest_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">init_hvm_pv_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">major</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">xen_hvm_init_shared_info</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_hvm_callback_vector</span><span class="p">))</span>
		<span class="n">xen_have_vector_callback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xen_hvm_smp_init</span><span class="p">();</span>
	<span class="n">register_cpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_hvm_cpu_notifier</span><span class="p">);</span>
	<span class="n">xen_unplug_emulated_devices</span><span class="p">();</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">irqs</span><span class="p">.</span><span class="n">intr_init</span> <span class="o">=</span> <span class="n">xen_init_IRQ</span><span class="p">;</span>
	<span class="n">xen_hvm_init_time_ops</span><span class="p">();</span>
	<span class="n">xen_hvm_init_mmu_ops</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">xen_hvm_platform</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xen_pv_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_cpuid_base</span><span class="p">())</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">xen_hvm_need_lapic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xen_pv_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_hvm_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_hvm_pirqs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">xen_have_vector_callback</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xen_hvm_need_lapic</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">hypervisor_x86</span> <span class="n">x86_hyper_xen_hvm</span> <span class="n">__refconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Xen HVM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>			<span class="o">=</span> <span class="n">xen_hvm_platform</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_platform</span>		<span class="o">=</span> <span class="n">xen_hvm_guest_init</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">x86_hyper_xen_hvm</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
