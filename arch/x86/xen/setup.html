<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › xen › setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Machine specific setup for xen</span>
<span class="cm"> *</span>
<span class="cm"> * Jeremy Fitzhardinge &lt;jeremy@xensource.com&gt;, XenSource Inc, 2007</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>
<span class="cp">#include &lt;linux/cpuidle.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>

<span class="cp">#include &lt;asm/elf.h&gt;</span>
<span class="cp">#include &lt;asm/vdso.h&gt;</span>
<span class="cp">#include &lt;asm/e820.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/acpi.h&gt;</span>
<span class="cp">#include &lt;asm/xen/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/xen/hypercall.h&gt;</span>

<span class="cp">#include &lt;xen/xen.h&gt;</span>
<span class="cp">#include &lt;xen/page.h&gt;</span>
<span class="cp">#include &lt;xen/interface/callback.h&gt;</span>
<span class="cp">#include &lt;xen/interface/memory.h&gt;</span>
<span class="cp">#include &lt;xen/interface/physdev.h&gt;</span>
<span class="cp">#include &lt;xen/features.h&gt;</span>
<span class="cp">#include &quot;xen-ops.h&quot;</span>
<span class="cp">#include &quot;vdso.h&quot;</span>

<span class="cm">/* These are code, but not functions.  Defined in entry.S */</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">xen_hypervisor_callback</span><span class="p">[];</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">xen_failsafe_callback</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xen_sysenter_target</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xen_syscall_target</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xen_syscall32_target</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Amount of extra memory space we add to the e820 ranges */</span>
<span class="k">struct</span> <span class="n">xen_memory_region</span> <span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">XEN_EXTRA_MEM_MAX_REGIONS</span><span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="cm">/* Number of pages released from the initial allocation. */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xen_released_pages</span><span class="p">;</span>

<span class="cm">/* </span>
<span class="cm"> * The maximum amount of extra memory compared to the base size.  The</span>
<span class="cm"> * main scaling factor is the size of struct page.  At extreme ratios</span>
<span class="cm"> * of base:extra, all the base memory can be filled with page</span>
<span class="cm"> * structures for the extra memory, leaving no space for anything</span>
<span class="cm"> * else.</span>
<span class="cm"> * </span>
<span class="cm"> * 10x seems like a reasonable balance between scaling flexibility and</span>
<span class="cm"> * leaving a practically usable system.</span>
<span class="cm"> */</span>
<span class="cp">#define EXTRA_MEM_RATIO		(10)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_add_extra_mem</span><span class="p">(</span><span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XEN_EXTRA_MEM_MAX_REGIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add new region. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span>  <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Append to existing region. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xen_extra_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">XEN_EXTRA_MEM_MAX_REGIONS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning: not enough extra memory regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">xen_max_p2m_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">start</span><span class="p">);</span> <span class="n">pfn</span> <span class="o">&lt;=</span> <span class="n">xen_max_p2m_pfn</span><span class="p">;</span> <span class="n">pfn</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__set_phys_to_machine</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">INVALID_P2M_ENTRY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">xen_do_chunk</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span> <span class="n">bool</span> <span class="n">release</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xen_memory_reservation</span> <span class="n">reservation</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">address_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extent_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">domid</span>        <span class="o">=</span> <span class="n">DOMID_SELF</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">pfn</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">pfn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frame</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mfn</span> <span class="o">=</span> <span class="n">pfn_to_mfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Make sure pfn exists to start with */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfn</span> <span class="o">==</span> <span class="n">INVALID_P2M_ENTRY</span> <span class="o">||</span> <span class="n">mfn_to_pfn</span><span class="p">(</span><span class="n">mfn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pfn</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">frame</span> <span class="o">=</span> <span class="n">mfn</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfn</span> <span class="o">!=</span> <span class="n">INVALID_P2M_ENTRY</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">frame</span> <span class="o">=</span> <span class="n">pfn</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">reservation</span><span class="p">.</span><span class="n">extent_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
		<span class="n">reservation</span><span class="p">.</span><span class="n">nr_extents</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_memory_op</span><span class="p">(</span><span class="n">release</span> <span class="o">?</span> <span class="n">XENMEM_decrease_reservation</span> <span class="o">:</span> <span class="n">XENMEM_populate_physmap</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">reservation</span><span class="p">);</span>
		<span class="n">WARN</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Failed to %s pfn %lx err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">release</span> <span class="o">?</span> <span class="s">&quot;release&quot;</span> <span class="o">:</span> <span class="s">&quot;populate&quot;</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">early_set_phys_to_machine</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">release</span> <span class="o">?</span> <span class="n">INVALID_P2M_ENTRY</span> <span class="o">:</span> <span class="n">frame</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">reservation</span><span class="p">.</span><span class="n">extent_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
				<span class="n">reservation</span><span class="p">.</span><span class="n">nr_extents</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_memory_op</span><span class="p">(</span><span class="n">XENMEM_decrease_reservation</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">reservation</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %lx-%lx pfn range: %lu pages %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">release</span> <span class="o">?</span> <span class="s">&quot;Freeing&quot;</span> <span class="o">:</span> <span class="s">&quot;Populating&quot;</span><span class="p">,</span>
		       <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		       <span class="n">release</span> <span class="o">?</span> <span class="s">&quot;freed&quot;</span> <span class="o">:</span> <span class="s">&quot;added&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">xen_release_chunk</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xen_do_chunk</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">xen_populate_chunk</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">e820entry</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">map_size</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_pfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">last_pfn</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">credits_left</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">e820entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dest_pfn</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">credits</span> <span class="o">=</span> <span class="n">credits_left</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s_pfn</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">e_pfn</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfns</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">capacity</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">E820_RAM</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">e_pfn</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

		<span class="cm">/* We only care about E820 after the xen_start_info-&gt;nr_pages */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e_pfn</span> <span class="o">&lt;=</span> <span class="n">max_pfn</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">s_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="cm">/* If the E820 falls within the nr_pages, we want to start</span>
<span class="cm">		 * at the nr_pages PFN.</span>
<span class="cm">		 * If that would mean going past the E820 entry, skip it</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s_pfn</span> <span class="o">&lt;=</span> <span class="n">max_pfn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">capacity</span> <span class="o">=</span> <span class="n">e_pfn</span> <span class="o">-</span> <span class="n">max_pfn</span><span class="p">;</span>
			<span class="n">dest_pfn</span> <span class="o">=</span> <span class="n">max_pfn</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* last_pfn MUST be within E820_RAM regions */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_pfn</span> <span class="o">&amp;&amp;</span> <span class="n">e_pfn</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">last_pfn</span><span class="p">)</span>
				<span class="n">s_pfn</span> <span class="o">=</span> <span class="o">*</span><span class="n">last_pfn</span><span class="p">;</span>
			<span class="n">capacity</span> <span class="o">=</span> <span class="n">e_pfn</span> <span class="o">-</span> <span class="n">s_pfn</span><span class="p">;</span>
			<span class="n">dest_pfn</span> <span class="o">=</span> <span class="n">s_pfn</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* If we had filled this E820_RAM entry, go to the next one. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="p">)</span>
			<span class="n">credits</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>

		<span class="n">pfns</span> <span class="o">=</span> <span class="n">xen_do_chunk</span><span class="p">(</span><span class="n">dest_pfn</span><span class="p">,</span> <span class="n">dest_pfn</span> <span class="o">+</span> <span class="n">credits</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">+=</span> <span class="n">pfns</span><span class="p">;</span>
		<span class="n">credits_left</span> <span class="o">-=</span> <span class="n">pfns</span><span class="p">;</span>
		<span class="o">*</span><span class="n">last_pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">dest_pfn</span> <span class="o">+</span> <span class="n">pfns</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_set_identity_and_release_chunk</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_pfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_pfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">released</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">identity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the PFNs are currently mapped, the VA mapping also needs</span>
<span class="cm">	 * to be updated to be 1:1.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">start_pfn</span><span class="p">;</span> <span class="n">pfn</span> <span class="o">&lt;=</span> <span class="n">max_pfn_mapped</span> <span class="o">&amp;&amp;</span> <span class="n">pfn</span> <span class="o">&lt;</span> <span class="n">end_pfn</span><span class="p">;</span> <span class="n">pfn</span><span class="o">++</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">HYPERVISOR_update_va_mapping</span><span class="p">(</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">),</span>
			<span class="n">mfn_pte</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">PAGE_KERNEL_IO</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_pfn</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">)</span>
		<span class="o">*</span><span class="n">released</span> <span class="o">+=</span> <span class="n">xen_release_chunk</span><span class="p">(</span>
			<span class="n">start_pfn</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">end_pfn</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">));</span>

	<span class="o">*</span><span class="n">identity</span> <span class="o">+=</span> <span class="n">set_phys_range_identity</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">xen_set_identity_and_release</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">e820entry</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">map_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phys_addr_t</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">released</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">identity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">e820entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Combine non-RAM regions and gaps until a RAM region (or the</span>
<span class="cm">	 * end of the map) is reached, then set the 1:1 map and</span>
<span class="cm">	 * release the pages (if available) in those non-RAM regions.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The combined non-RAM regions are rounded to a whole number</span>
<span class="cm">	 * of pages so any partial pages are accessible via the 1:1</span>
<span class="cm">	 * mapping.  This is needed for some BIOSes that put (for</span>
<span class="cm">	 * example) the DMI tables in a reserved region that begins on</span>
<span class="cm">	 * a non-page boundary.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_addr_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">E820_RAM</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">map_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_pfn</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">end</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">E820_RAM</span><span class="p">)</span>
				<span class="n">end_pfn</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">start_pfn</span> <span class="o">&lt;</span> <span class="n">end_pfn</span><span class="p">)</span>
				<span class="n">xen_set_identity_and_release_chunk</span><span class="p">(</span>
					<span class="n">start_pfn</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">released</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">identity</span><span class="p">);</span>

			<span class="n">start</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">released</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Released %lu pages of unused memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">released</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">identity</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Set %ld page(s) to 1-1 mapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">identity</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">released</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">xen_get_max_pages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_pages</span> <span class="o">=</span> <span class="n">MAX_DOMAIN_PAGES</span><span class="p">;</span>
	<span class="n">domid_t</span> <span class="n">domid</span> <span class="o">=</span> <span class="n">DOMID_SELF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the initial domain we use the maximum reservation as</span>
<span class="cm">	 * the maximum page.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For guest domains the current maximum reservation reflects</span>
<span class="cm">	 * the current maximum rather than the static maximum. In this</span>
<span class="cm">	 * case the e820 map provided to us will cover the static</span>
<span class="cm">	 * maximum region.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xen_initial_domain</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_memory_op</span><span class="p">(</span><span class="n">XENMEM_maximum_reservation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">domid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">max_pages</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">max_pages</span><span class="p">,</span> <span class="n">MAX_DOMAIN_PAGES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_align_and_add_e820_region</span><span class="p">(</span><span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Align RAM regions to page boundaries. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">E820_RAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
		<span class="n">end</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">e820_add_region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * machine_specific_memory_setup - Hook for machine specific memory setup.</span>
<span class="cm"> **/</span>
<span class="kt">char</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">xen_memory_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">e820entry</span> <span class="n">map</span><span class="p">[</span><span class="n">E820MAX</span><span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_pfn</span> <span class="o">=</span> <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">mem_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xen_memory_map</span> <span class="n">memmap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_pfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">extra_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">populated</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">max_pfn</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">MAX_DOMAIN_PAGES</span><span class="p">,</span> <span class="n">max_pfn</span><span class="p">);</span>
	<span class="n">mem_end</span> <span class="o">=</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">max_pfn</span><span class="p">);</span>

	<span class="n">memmap</span><span class="p">.</span><span class="n">nr_entries</span> <span class="o">=</span> <span class="n">E820MAX</span><span class="p">;</span>
	<span class="n">set_xen_guest_handle</span><span class="p">(</span><span class="n">memmap</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">xen_initial_domain</span><span class="p">()</span> <span class="o">?</span>
		<span class="n">XENMEM_machine_memory_map</span> <span class="o">:</span>
		<span class="n">XENMEM_memory_map</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">HYPERVISOR_memory_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">memmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">xen_initial_domain</span><span class="p">());</span>
		<span class="n">memmap</span><span class="p">.</span><span class="n">nr_entries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
		<span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">mem_end</span><span class="p">;</span>
		<span class="cm">/* 8MB slack (to balance backend allocations). */</span>
		<span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">+=</span> <span class="mi">8ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">E820_RAM</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* Make sure the Xen-supplied memory map is well-ordered. */</span>
	<span class="n">sanitize_e820_map</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">memmap</span><span class="p">.</span><span class="n">nr_entries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">memmap</span><span class="p">.</span><span class="n">nr_entries</span><span class="p">);</span>

	<span class="n">max_pages</span> <span class="o">=</span> <span class="n">xen_get_max_pages</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_pages</span> <span class="o">&gt;</span> <span class="n">max_pfn</span><span class="p">)</span>
		<span class="n">extra_pages</span> <span class="o">+=</span> <span class="n">max_pages</span> <span class="o">-</span> <span class="n">max_pfn</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set P2M for all non-RAM pages and E820 gaps to be identity</span>
<span class="cm">	 * type PFNs.  Any RAM pages that would be made inaccesible by</span>
<span class="cm">	 * this are first released.</span>
<span class="cm">	 */</span>
	<span class="n">xen_released_pages</span> <span class="o">=</span> <span class="n">xen_set_identity_and_release</span><span class="p">(</span>
		<span class="n">map</span><span class="p">,</span> <span class="n">memmap</span><span class="p">.</span><span class="n">nr_entries</span><span class="p">,</span> <span class="n">max_pfn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Populate back the non-RAM pages and E820 gaps that had been</span>
<span class="cm">	 * released. */</span>
	<span class="n">populated</span> <span class="o">=</span> <span class="n">xen_populate_chunk</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">memmap</span><span class="p">.</span><span class="n">nr_entries</span><span class="p">,</span>
			<span class="n">max_pfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_pfn</span><span class="p">,</span> <span class="n">xen_released_pages</span><span class="p">);</span>

	<span class="n">xen_released_pages</span> <span class="o">-=</span> <span class="n">populated</span><span class="p">;</span>
	<span class="n">extra_pages</span> <span class="o">+=</span> <span class="n">xen_released_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last_pfn</span> <span class="o">&gt;</span> <span class="n">max_pfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_pfn</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">MAX_DOMAIN_PAGES</span><span class="p">,</span> <span class="n">last_pfn</span><span class="p">);</span>
		<span class="n">mem_end</span> <span class="o">=</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">max_pfn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clamp the amount of extra memory to a EXTRA_MEM_RATIO</span>
<span class="cm">	 * factor the base size.  On non-highmem systems, the base</span>
<span class="cm">	 * size is the full initial memory allocation; on highmem it</span>
<span class="cm">	 * is limited to the max size of lowmem, so that it doesn&#39;t</span>
<span class="cm">	 * get completely filled.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In principle there could be a problem in lowmem systems if</span>
<span class="cm">	 * the initial memory is also very large with respect to</span>
<span class="cm">	 * lowmem, but we won&#39;t try to deal with that here.</span>
<span class="cm">	 */</span>
	<span class="n">extra_pages</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">EXTRA_MEM_RATIO</span> <span class="o">*</span> <span class="n">min</span><span class="p">(</span><span class="n">max_pfn</span><span class="p">,</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">MAXMEM</span><span class="p">)),</span>
			  <span class="n">extra_pages</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">memmap</span><span class="p">.</span><span class="n">nr_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">size</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">type</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">E820_RAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">mem_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">mem_end</span> <span class="o">-</span> <span class="n">addr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">extra_pages</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">extra_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
				<span class="n">extra_pages</span> <span class="o">-=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
				<span class="n">xen_add_extra_mem</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">type</span> <span class="o">=</span> <span class="n">E820_UNUSABLE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xen_align_and_add_e820_region</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

		<span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In domU, the ISA region is normal, usable memory, but we</span>
<span class="cm">	 * reserve ISA memory anyway because too many things poke</span>
<span class="cm">	 * about in there.</span>
<span class="cm">	 */</span>
	<span class="n">e820_add_region</span><span class="p">(</span><span class="n">ISA_START_ADDRESS</span><span class="p">,</span> <span class="n">ISA_END_ADDRESS</span> <span class="o">-</span> <span class="n">ISA_START_ADDRESS</span><span class="p">,</span>
			<span class="n">E820_RESERVED</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reserve Xen bits:</span>
<span class="cm">	 *  - mfn_list</span>
<span class="cm">	 *  - xen_start_info</span>
<span class="cm">	 * See comment above &quot;struct start_info&quot; in &lt;xen/interface/xen.h&gt;</span>
<span class="cm">	 */</span>
	<span class="n">memblock_reserve</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">mfn_list</span><span class="p">),</span>
			 <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">pt_base</span> <span class="o">-</span> <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">mfn_list</span><span class="p">);</span>

	<span class="n">sanitize_e820_map</span><span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e820</span><span class="p">.</span><span class="n">map</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">e820</span><span class="p">.</span><span class="n">nr_map</span><span class="p">);</span>

	<span class="k">return</span> <span class="s">&quot;Xen&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the bit indicating &quot;nosegneg&quot; library variants should be used.</span>
<span class="cm"> * We only need to bother in pure 32-bit mode; compat 32-bit processes</span>
<span class="cm"> * can have un-truncated segments, so wrapping around is allowed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fiddle_vdso</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">VDSO32_SYMBOL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdso32_int80_start</span><span class="p">,</span> <span class="n">NOTE_MASK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VDSO_NOTE_NONEGSEG_BIT</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">VDSO32_SYMBOL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdso32_sysenter_start</span><span class="p">,</span> <span class="n">NOTE_MASK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VDSO_NOTE_NONEGSEG_BIT</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">register_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">callback_register</span> <span class="n">callback</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">XEN_CALLBACK</span><span class="p">(</span><span class="n">__KERNEL_CS</span><span class="p">,</span> <span class="n">func</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CALLBACKF_mask_events</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">HYPERVISOR_callback_op</span><span class="p">(</span><span class="n">CALLBACKOP_register</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">xen_enable_sysenter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">sysenter_feature</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">sysenter_feature</span> <span class="o">=</span> <span class="n">X86_FEATURE_SEP</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">sysenter_feature</span> <span class="o">=</span> <span class="n">X86_FEATURE_SYSENTER32</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">sysenter_feature</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_callback</span><span class="p">(</span><span class="n">CALLBACKTYPE_sysenter</span><span class="p">,</span> <span class="n">xen_sysenter_target</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">setup_clear_cpu_cap</span><span class="p">(</span><span class="n">sysenter_feature</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">xen_enable_syscall</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_callback</span><span class="p">(</span><span class="n">CALLBACKTYPE_syscall</span><span class="p">,</span> <span class="n">xen_syscall_target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to set syscall callback: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="cm">/* Pretty fatal; 64-bit userspace has no other</span>
<span class="cm">		   mechanism for syscalls. */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_SYSCALL32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">register_callback</span><span class="p">(</span><span class="n">CALLBACKTYPE_syscall32</span><span class="p">,</span>
					<span class="n">xen_syscall32_target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">setup_clear_cpu_cap</span><span class="p">(</span><span class="n">X86_FEATURE_SYSCALL32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_64 */</span><span class="cp"></span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">xen_arch_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_panic_handler_init</span><span class="p">();</span>

	<span class="n">HYPERVISOR_vm_assist</span><span class="p">(</span><span class="n">VMASST_CMD_enable</span><span class="p">,</span> <span class="n">VMASST_TYPE_4gb_segments</span><span class="p">);</span>
	<span class="n">HYPERVISOR_vm_assist</span><span class="p">(</span><span class="n">VMASST_CMD_enable</span><span class="p">,</span> <span class="n">VMASST_TYPE_writable_pagetables</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_feature</span><span class="p">(</span><span class="n">XENFEAT_auto_translated_physmap</span><span class="p">))</span>
		<span class="n">HYPERVISOR_vm_assist</span><span class="p">(</span><span class="n">VMASST_CMD_enable</span><span class="p">,</span>
				     <span class="n">VMASST_TYPE_pae_extended_cr3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_callback</span><span class="p">(</span><span class="n">CALLBACKTYPE_event</span><span class="p">,</span> <span class="n">xen_hypervisor_callback</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">register_callback</span><span class="p">(</span><span class="n">CALLBACKTYPE_failsafe</span><span class="p">,</span> <span class="n">xen_failsafe_callback</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">xen_enable_sysenter</span><span class="p">();</span>
	<span class="n">xen_enable_syscall</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_ACPI</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SIF_INITDOMAIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ACPI in unprivileged domain disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">disable_acpi</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">cmd_line</span><span class="p">,</span>
	       <span class="n">MAX_GUEST_CMDLINE</span> <span class="o">&gt;</span> <span class="n">COMMAND_LINE_SIZE</span> <span class="o">?</span>
	       <span class="n">COMMAND_LINE_SIZE</span> <span class="o">:</span> <span class="n">MAX_GUEST_CMDLINE</span><span class="p">);</span>

	<span class="cm">/* Set up idle, making sure it calls safe_halt() pvop */</span>
<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">hlt_works_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">disable_cpuidle</span><span class="p">();</span>
	<span class="n">disable_cpufreq</span><span class="p">();</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">set_pm_idle_to_default</span><span class="p">());</span>
	<span class="n">fiddle_vdso</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
