f | Makefile | g | 728B |  | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1335898233 |  | xen/x86: Implement x86_apic_ops  Or rather just implement one different function as opposed to the native one : the read function.  We synthesize the values.  Acked-by:  Suresh Siddha <suresh.b.siddha@intel.com> [v1: Rebased on top of tip/x86/urgent] [v2: Return 0xfd instead of 0xff in the default case] Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | grant-table.c | s | 3.9K | 111 | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1324418478 |  | Merge commit 'v3.2-rc3' into stable/for-linus-3.3  * commit 'v3.2-rc3': (412 commits)   Linux 3.2-rc3   virtio-pci: make reset operation safer   virtio-mmio: Correct the name of the guest features selector   virtio: add HAS_IOMEM dependency to MMIO platform bus driver   eCryptfs: Extend array bounds for all filename chars   eCryptfs: Flush file in vma close   eCryptfs: Prevent file create race condition   regulator: TPS65910: Fix VDD1/2 voltage selector count   i2c: Make i2cdev_notifier_call static   i2c: Delete ANY_I2C_BUS   i2c: Fix device name for 10-bit slave address   i2c-algo-bit: Generate correct i2c address sequence for 10-bit target   drm: integer overflow in drm_mode_dirtyfb_ioctl()   Revert "of/irq: of_irq_find_parent: check for parent equal to child"   drivers/gpu/vga/vgaarb.c: add missing kfree   drm/radeon/kms/atom: unify i2c gpio table handling   drm/radeon/kms: fix up gpio i2c mask bits for r4xx for real   ttm: Don't return the bo reserved on error path   mount_subtree() pointless use-after-free   iio: fix a leak due to improper use of anon_inode_getfd()   ...
f | time.c | s | 12K | 413 | Linus Torvalds | torvalds@linux-foundation.org | 1320639305 |  | Merge branch 'upstream/xen-settime' of git://git.kernel.org/pub/scm/linux/kernel/git/jeremy/xen  * 'upstream/xen-settime' of git://git.kernel.org/pub/scm/linux/kernel/git/jeremy/xen:   xen/dom0: set wallclock time in Xen   xen: add dom0_op hypercall   xen/acpi: Domain0 acpi parser related platform hypercall
f | pci-swiotlb-xen.c | s | 1.8K | 57 | Andrzej Pietrasiewicz | andrzej.p@samsung.com | 1332945391 |  | X86 & IA64: adapt for dma_map_ops changes  Adapt core x86 and IA64 architecture code for dma_map_ops changes: replace alloc/free_coherent with generic alloc/free methods.  Signed-off-by: Andrzej Pietrasiewicz <andrzej.p@samsung.com> Acked-by: Kyungmin Park <kyungmin.park@samsung.com> [removed swiotlb related changes and replaced it with wrappers,  merged with IA64 patch to avoid inter-patch dependences in intel-iommu code] Signed-off-by: Marek Szyprowski <m.szyprowski@samsung.com> Reviewed-by: Arnd Bergmann <arnd@arndb.de> Acked-by: Tony Luck <tony.luck@intel.com>
f | debugfs.h | s | 123B | 4 | Srivatsa Vaddagiri | vatsa@linux.vnet.ibm.com | 1334636316 |  | debugfs: Add support to print u32 array in debugfs  Move the code from Xen to debugfs to make the code common for other users as well.  Accked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org> Signed-off-by: Srivatsa Vaddagiri <vatsa@linux.vnet.ibm.com> Signed-off-by: Suzuki Poulose <suzuki@in.ibm.com> [v1: Fixed rebase issues] [v2: Fixed PPC compile issues] Signed-off-by: Raghavendra K T <raghavendra.kt@linux.vnet.ibm.com> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | xen-asm.S | s | 3.6K | 128 | David Vrabel | david.vrabel@citrix.com | 1335557061 |  | xen: correctly check for pending events when restoring irq flags  In xen_restore_fl_direct(), xen_force_evtchn_callback() was being called even if no events were pending.  This resulted in (depending on workload) about a 100 times as many xen_version hypercalls as necessary.  Fix this by correcting the sense of the conditional jump.  This seems to give a significant performance benefit for some workloads.  There is some subtle tricksy "..since the check here is trying to check both pending and masked in a single cmpw, but I think this is correct. It will call check_events now only when the combined mask+pending word is 0x0001 (aka unmasked, pending)." (Ian)  CC: stable@kernel.org Acked-by: Ian Campbell <ian.campbell@citrix.com> Signed-off-by: David Vrabel <david.vrabel@citrix.com> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | xen-head.S | g | 1.6K |  | Stratos Psomadakis | psomas@cslab.ece.ntua.gr | 1298680652 |  | x86, asm: Cleanup unnecssary macros in asm-offsets.c  PAGE_SIZE_asm, PAGE_SHIFT_asm, THREAD_SIZE_asm can be safely removed from asm-offsets.c, and be replaced by their non-'_asm' counterparts in the code that uses them, since the _AC macro defined in include/linux/const.h makes PAGE_SIZE/PAGE_SHIFT/THREAD_SIZE work with as.  Signed-off-by: Stratos Psomadakis <psomas@cslab.ece.ntua.gr> LKML-Reference: <1298666774-17646-2-git-send-email-psomas@cslab.ece.ntua.gr> Signed-off-by: H. Peter Anvin <hpa@zytor.com>
f | vdso.h | s | 211B | 4 | Thomas Gleixner | tglx@linutronix.de | 1192094211 |  | i386: move xen  Signed-off-by: Thomas Gleixner <tglx@linutronix.de> Signed-off-by: Ingo Molnar <mingo@elte.hu>
f | apic.c | s | 659B | 26 | Ingo Molnar | mingo@kernel.org | 1337326485 |  | x86/xen/apic: Add missing #include <xen/xen.h>  This file depends on <xen/xen.h>, but the dependency was hidden due to: <asm/acpi.h> -> <asm/trampoline.h> -> <asm/io.h> -> <xen/xen.h>  With the removal of <asm/trampoline.h>, this exposed the missing  Cc: Len Brown <lenb@kernel.org> Cc: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com> Cc: Jeremy Fitzhardinge <jeremy@goop.org> Cc: Jarkko Sakkinen <jarkko.sakkinen@intel.com> Cc: H. Peter Anvin <hpa@zytor.com> Link: http://lkml.kernel.org/n/tip-7ccybvue6mw6wje3uxzzcglj@git.kernel.org Signed-off-by: Ingo Molnar <mingo@kernel.org>
f | spinlock.c | s | 10K | 359 | Srivatsa Vaddagiri | vatsa@linux.vnet.ibm.com | 1334636316 |  | debugfs: Add support to print u32 array in debugfs  Move the code from Xen to debugfs to make the code common for other users as well.  Accked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org> Signed-off-by: Srivatsa Vaddagiri <vatsa@linux.vnet.ibm.com> Signed-off-by: Suzuki Poulose <suzuki@in.ibm.com> [v1: Fixed rebase issues] [v2: Fixed PPC compile issues] Signed-off-by: Raghavendra K T <raghavendra.kt@linux.vnet.ibm.com> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | suspend.c | s | 1.7K | 65 | Ian Campbell | ian.campbell@citrix.com | 1298652192 |  | xen: suspend: add "arch" to pre/post suspend hooks  xen_pre_device_suspend is unused on ia64.  Signed-off-by: Ian Campbell <ian.campbell@citrix.com> Reviewed-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | smp.h | s | 382B | 10 | Ben Guthro | ben@guthro.net | 1336419195 |  | xen: implement apic ipi interface  Map native ipi vector to xen vector. Implement apic ipi interface with xen_send_IPI_one.  Tested-by: Steven Noonan <steven@uplinklabs.net> Signed-off-by: Ben Guthro <ben@guthro.net> Signed-off-by: Lin Ming <mlin@ss.pku.edu.cn> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | xen-asm_32.S | g | 6.6K |  | H. Peter Anvin | hpa@zytor.com | 1334955099 |  | x86, extable: Remove open-coded exception table entries in arch/x86/xen/xen-asm_32.S  Remove open-coded exception table entries in arch/x86/xen/xen-asm_32.S, and replace them with _ASM_EXTABLE() macros; this will allow us to change the format and type of the exception table entries.  Signed-off-by: H. Peter Anvin <hpa@zytor.com> Cc: David Daney <david.daney@cavium.com> Cc: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com> Cc: Jeremy Fitzhardinge <jeremy@goop.org> Link: http://lkml.kernel.org/r/CA%2B55aFyijf43qSu3N9nWHEBwaGbb7T2Oq9A=9EyR=Jtyqfq_cQ@mail.gmail.com
f | multicalls.c | s | 4.8K | 168 | Jeremy Fitzhardinge | jeremy.fitzhardinge@citrix.com | 1311029026 |  | xen/multicall: move *idx fields to start of mc_buffer  The CPU would prefer small offsets.  Signed-off-by: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com>
f | irq.c | s | 3.3K | 108 | Alex Shi | alex.shi@intel.com | 1327425624 |  | xen: use this_cpu_xxx replace percpu_xxx funcs  percpu_xxx funcs are duplicated with this_cpu_xxx funcs, so replace them for further code clean up.  I don't know much of xen code. But, since the code is in x86 architecture, the percpu_xxx is exactly same as this_cpu_xxx serials functions. So, the change is safe.  Signed-off-by: Alex Shi <alex.shi@intel.com> Acked-by: Christoph Lameter <cl@gentwo.org> Acked-by: Tejun Heo <tj@kernel.org> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | xen-asm.h | s | 283B | 8 | Jeremy Fitzhardinge | jeremy@goop.org | 1233795544 |  | xen: make direct versions of irq_enable/disable/save/restore to common code  Now that x86-64 has directly accessible percpu variables, it can also implement the direct versions of these operations, which operate on a vcpu_info structure directly embedded in the percpu area.  In fact, the 64-bit versions are more or less identical, and so can be shared.  The only two differences are:  1. xen_restore_fl_direct takes its argument in eax on 32-bit, and rdi on 64-bit.     Unfortunately it isn't possible to directly refer to the 2nd lsb of rdi directly     (as you can with %ah), so the code isn't quite as dense.  2. check_events needs to variants to save different registers.  Signed-off-by: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com> Signed-off-by: H. Peter Anvin <hpa@linux.intel.com>
f | setup.c | s | 14K | 464 | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1338387397 |  | xen/balloon: Subtract from xen_released_pages the count that is populated.  We did not take into account that xen_released_pages would be used outside the initial E820 parsing code. As such we would did not subtract from xen_released_pages the count of pages that we had populated back (instead we just did a simple extra_pages = released - populated).  The balloon driver uses xen_released_pages to set the initial current_pages count.  If this is wrong (too low) then when a new (higher) target is set, the balloon driver will request too many pages from Xen."  This fixes errors such as:  (XEN) memory.c:133:d0 Could not allocate order=0 extent: id=0 memflags=0 (51 of 512) during bootup and free_memory            : 0  where the free_memory should be 128.  Acked-by: David Vrabel <david.vrabel@citrix.com> [v1: Per David's review made the git commit better] Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | enlighten.c | s | 36K | 1262 | Linus Torvalds | torvalds@linux-foundation.org | 1339805835 |  | 
f | mmu.c | s | 57K | 1896 | Linus Torvalds | torvalds@linux-foundation.org | 1337900528 |  | 
f | mmu.h | s | 607B | 18 | Jeremy Fitzhardinge | jeremy.fitzhardinge@citrix.com | 1305926724 |  | xen: make a pile of mmu pvop functions static  Signed-off-by: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com>
f | p2m.c | s | 30K | 844 | Stefano Stabellini | stefano.stabellini@eu.citrix.com | 1339697021 |  | xen: mark local pages as FOREIGN in the m2p_override  When the frontend and the backend reside on the same domain, even if we add pages to the m2p_override, these pages will never be returned by mfn_to_pfn because the check "get_phys_to_machine(pfn) != mfn" will always fail, so the pfn of the frontend will be returned instead (resulting in a deadlock because the frontend pages are already locked).  INFO: task qemu-system-i38:1085 blocked for more than 120 seconds. "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message. qemu-system-i38 D ffff8800cfc137c0     0  1085      1 0x00000000  ffff8800c47ed898 0000000000000282 ffff8800be4596b0 00000000000137c0  ffff8800c47edfd8 ffff8800c47ec010 00000000000137c0 00000000000137c0  ffff8800c47edfd8 00000000000137c0 ffffffff82213020 ffff8800be4596b0 Call Trace:  [<ffffffff81101ee0>] ? __lock_page+0x70/0x70  [<ffffffff81a0fdd9>] schedule+0x29/0x70  [<ffffffff81a0fe80>] io_schedule+0x60/0x80  [<ffffffff81101eee>] sleep_on_page+0xe/0x20  [<ffffffff81a0e1ca>] __wait_on_bit_lock+0x5a/0xc0  [<ffffffff81101ed7>] __lock_page+0x67/0x70  [<ffffffff8106f750>] ? autoremove_wake_function+0x40/0x40  [<ffffffff811867e6>] ? bio_add_page+0x36/0x40  [<ffffffff8110b692>] set_page_dirty_lock+0x52/0x60  [<ffffffff81186021>] bio_set_pages_dirty+0x51/0x70  [<ffffffff8118c6b4>] do_blockdev_direct_IO+0xb24/0xeb0  [<ffffffff811e71a0>] ? ext3_get_blocks_handle+0xe00/0xe00  [<ffffffff8118ca95>] __blockdev_direct_IO+0x55/0x60  [<ffffffff811e71a0>] ? ext3_get_blocks_handle+0xe00/0xe00  [<ffffffff811e91c8>] ext3_direct_IO+0xf8/0x390  [<ffffffff811e71a0>] ? ext3_get_blocks_handle+0xe00/0xe00  [<ffffffff81004b60>] ? xen_mc_flush+0xb0/0x1b0  [<ffffffff81104027>] generic_file_aio_read+0x737/0x780  [<ffffffff813bedeb>] ? gnttab_map_refs+0x15b/0x1e0  [<ffffffff811038f0>] ? find_get_pages+0x150/0x150  [<ffffffff8119736c>] aio_rw_vect_retry+0x7c/0x1d0  [<ffffffff811972f0>] ? lookup_ioctx+0x90/0x90  [<ffffffff81198856>] aio_run_iocb+0x66/0x1a0  [<ffffffff811998b8>] do_io_submit+0x708/0xb90  [<ffffffff81199d50>] sys_io_submit+0x10/0x20  [<ffffffff81a18d69>] system_call_fastpath+0x16/0x1b  The explanation is in the comment within the code:  We need to do this because the pages shared by the frontend (xen-blkfront) can be already locked (lock_page, called by do_read_cache_page); when the userspace backend tries to use them with direct_IO, mfn_to_pfn returns the pfn of the frontend, so do_blockdev_direct_IO is going to try to lock the same pages again resulting in a deadlock.  A simplified call graph looks like this:  pygrub                          QEMU ----------------------------------------------- do_read_cache_page              io_submit   ||                              || lock_page                       ext3_direct_IO                                  ||                                 bio_add_page                                  ||                                 lock_page  Internally the xen-blkback uses m2p_add_override to swizzle (temporarily) a 'struct page' to have a different MFN (so that it can point to another guest). It also can easily find out whether another pfn corresponding to the mfn exists in the m2p, and can set the FOREIGN bit in the p2m, making sure that mfn_to_pfn returns the pfn of the backend.  This allows the backend to perform direct_IO on these pages, but as a side effect prevents the frontend from using get_user_pages_fast on them while they are being shared with the backend.  Signed-off-by: Stefano Stabellini <stefano.stabellini@eu.citrix.com> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | smp.c | s | 16K | 554 | Linus Torvalds | torvalds@linux-foundation.org | 1337900528 |  | 
f | Kconfig | g | 1.3K |  | Maxim Uvarov | maxim.uvarov@oracle.com | 1321913686 |  | xen: Make XEN_MAX_DOMAIN_MEMORY have more sensible defaults  Which is that 128GB is not going to happen with 32-bit PV DomU. Lets use something more realistic. Also update the 64-bit to 500GB which is the max a PV guest can do.  Signed-off-by: Maxim Uvarov <maxim.uvarov@oracle.com> [v1: Updated 128GB->500GB for 64-bit] Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | xen-asm_64.S | g | 3.3K |  | Jeremy Fitzhardinge | jeremy.fitzhardinge@citrix.com | 1259867694 |  | xen: use iret for return from 64b kernel to 32b usermode  If Xen wants to return to a 32b usermode with sysret it must use the right form.  When using VCGF_in_syscall to trigger this, it looks at the code segment and does a 32b sysret if it is FLAT_USER_CS32. However, this is different from __USER32_CS, so it fails to return properly if we use the normal Linux segment.  So avoid the whole mess by dropping VCGF_in_syscall and simply use plain iret to return to usermode.  Signed-off-by: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com> Acked-by: Jan Beulich <jbeulich@novell.com> Cc: Stable Kernel <stable@kernel.org>
f | debugfs.c | s | 388B | 15 | Srivatsa Vaddagiri | vatsa@linux.vnet.ibm.com | 1334636316 |  | debugfs: Add support to print u32 array in debugfs  Move the code from Xen to debugfs to make the code common for other users as well.  Accked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org> Signed-off-by: Srivatsa Vaddagiri <vatsa@linux.vnet.ibm.com> Signed-off-by: Suzuki Poulose <suzuki@in.ibm.com> [v1: Fixed rebase issues] [v2: Fixed PPC compile issues] Signed-off-by: Raghavendra K T <raghavendra.kt@linux.vnet.ibm.com> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | trace.c | s | 1.1K | 57 | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1312551782 |  | xen/trace: Fix compile error when CONFIG_XEN_PRIVILEGED_GUEST is not set  with CONFIG_XEN and CONFIG_FTRACE set we get this:  arch/x86/xen/trace.c:22: error: ‘__HYPERVISOR_console_io’ undeclared here (not in a function) arch/x86/xen/trace.c:22: error: array index in initializer not of integer type arch/x86/xen/trace.c:22: error: (near initialization for ‘xen_hypercall_names’) arch/x86/xen/trace.c:23: error: ‘__HYPERVISOR_physdev_op_compat’ undeclared here (not in a function)  Issue was that the definitions of __HYPERVISOR were not pulled if CONFIG_XEN_PRIVILEGED_GUEST was not set.  Reported-by: Randy Dunlap <rdunlap@xenotime.net> Acked-by: Randy Dunlap <rdunlap@xenotime.net> Acked-by: Ingo Molnar <mingo@elte.hu> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | platform-pci-unplug.c | s | 4.4K | 129 | Raghavendra D Prabhu | rprabhu@wnohang.net | 1310405824 |  | xen:pvhvm: Modpost section mismatch fix  Removing __init from check_platform_magic since it is called by xen_unplug_emulated_devices in non-init contexts (It probably gets inlined because of -finline-functions-called-once, removing __init is more to avoid mismatch being reported).  Signed-off-by: Raghavendra D Prabhu <rprabhu@wnohang.net> Acked-by: Stefano Stabellini <stefano.stabellini@eu.citrix.com> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | vga.c | s | 2.4K | 60 | Jeremy Fitzhardinge | jeremy.fitzhardinge@citrix.com | 1307375160 |  | xen: allow enable use of VGA console on dom0  Get the information about the VGA console hardware from Xen, and put it into the form the bootloader normally generates, so that the rest of the kernel can deal with VGA as usual.  [ Impact: make VGA console work in dom0 ]  Signed-off-by: Jeremy Fitzhardinge <jeremy.fitzhardinge@citrix.com> [v1: Rebased on 2.6.39] [v2: Removed incorrect comments and fixed compile warnings] Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | xen-ops.h | s | 3.2K | 101 | Linus Torvalds | torvalds@linux-foundation.org | 1337900528 |  | 
f | multicalls.h | s | 1.7K | 53 | Alex Shi | alex.shi@intel.com | 1327425624 |  | xen: use this_cpu_xxx replace percpu_xxx funcs  percpu_xxx funcs are duplicated with this_cpu_xxx funcs, so replace them for further code clean up.  I don't know much of xen code. But, since the code is in x86 architecture, the percpu_xxx is exactly same as this_cpu_xxx serials functions. So, the change is safe.  Signed-off-by: Alex Shi <alex.shi@intel.com> Acked-by: Christoph Lameter <cl@gentwo.org> Acked-by: Tejun Heo <tj@kernel.org> Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
