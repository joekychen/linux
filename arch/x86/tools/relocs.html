<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › tools › relocs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>relocs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;stdint.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;elf.h&gt;</span>
<span class="cp">#include &lt;byteswap.h&gt;</span>
<span class="cp">#define USE_BSD</span>
<span class="cp">#include &lt;endian.h&gt;</span>
<span class="cp">#include &lt;regex.h&gt;</span>
<span class="cp">#include &lt;tools/le_byteshift.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">die</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>

<span class="cp">#define ARRAY_SIZE(x) (sizeof(x) / sizeof((x)[0]))</span>
<span class="k">static</span> <span class="n">Elf32_Ehdr</span> <span class="n">ehdr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reloc_count</span><span class="p">,</span> <span class="n">reloc_idx</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">relocs</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reloc16_count</span><span class="p">,</span> <span class="n">reloc16_idx</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">relocs16</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">section</span> <span class="p">{</span>
	<span class="n">Elf32_Shdr</span>     <span class="n">shdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="n">Elf32_Sym</span>      <span class="o">*</span><span class="n">symtab</span><span class="p">;</span>
	<span class="n">Elf32_Rel</span>      <span class="o">*</span><span class="n">reltab</span><span class="p">;</span>
	<span class="kt">char</span>           <span class="o">*</span><span class="n">strtab</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">secs</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">symtype</span> <span class="p">{</span>
	<span class="n">S_ABS</span><span class="p">,</span>
	<span class="n">S_REL</span><span class="p">,</span>
	<span class="n">S_SEG</span><span class="p">,</span>
	<span class="n">S_LIN</span><span class="p">,</span>
	<span class="n">S_NSYMTYPES</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">sym_regex_kernel</span><span class="p">[</span><span class="n">S_NSYMTYPES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * Following symbols have been audited. There values are constant and do</span>
<span class="cm"> * not change if bzImage is loaded at a different physical address than</span>
<span class="cm"> * the address for which it has been compiled. Don&#39;t warn user about</span>
<span class="cm"> * absolute relocations present w.r.t these symbols.</span>
<span class="cm"> */</span>
	<span class="p">[</span><span class="n">S_ABS</span><span class="p">]</span> <span class="o">=</span>
	<span class="s">&quot;^(xen_irq_disable_direct_reloc$|&quot;</span>
	<span class="s">&quot;xen_save_fl_direct_reloc$|&quot;</span>
	<span class="s">&quot;VDSO|&quot;</span>
	<span class="s">&quot;__crc_)&quot;</span><span class="p">,</span>

<span class="cm">/*</span>
<span class="cm"> * These symbols are known to be relative, even if the linker marks them</span>
<span class="cm"> * as absolute (typically defined outside any section in the linker script.)</span>
<span class="cm"> */</span>
	<span class="p">[</span><span class="n">S_REL</span><span class="p">]</span> <span class="o">=</span>
	<span class="s">&quot;^(__init_(begin|end)|&quot;</span>
	<span class="s">&quot;__x86_cpu_dev_(start|end)|&quot;</span>
	<span class="s">&quot;(__parainstructions|__alt_instructions)(|_end)|&quot;</span>
	<span class="s">&quot;(__iommu_table|__apicdrivers|__smp_locks)(|_end)|&quot;</span>
	<span class="s">&quot;__(start|end)_pci_.*|&quot;</span>
	<span class="s">&quot;__(start|end)_builtin_fw|&quot;</span>
	<span class="s">&quot;__(start|stop)___ksymtab(|_gpl|_unused|_unused_gpl|_gpl_future)|&quot;</span>
	<span class="s">&quot;__(start|stop)___kcrctab(|_gpl|_unused|_unused_gpl|_gpl_future)|&quot;</span>
	<span class="s">&quot;__(start|stop)___param|&quot;</span>
	<span class="s">&quot;__(start|stop)___modver|&quot;</span>
	<span class="s">&quot;__(start|stop)___bug_table|&quot;</span>
	<span class="s">&quot;__tracedata_(start|end)|&quot;</span>
	<span class="s">&quot;__(start|stop)_notes|&quot;</span>
	<span class="s">&quot;__end_rodata|&quot;</span>
	<span class="s">&quot;__initramfs_start|&quot;</span>
	<span class="s">&quot;(jiffies|jiffies_64)|&quot;</span>
	<span class="s">&quot;_end)$&quot;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">sym_regex_realmode</span><span class="p">[</span><span class="n">S_NSYMTYPES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * These symbols are known to be relative, even if the linker marks them</span>
<span class="cm"> * as absolute (typically defined outside any section in the linker script.)</span>
<span class="cm"> */</span>
	<span class="p">[</span><span class="n">S_REL</span><span class="p">]</span> <span class="o">=</span>
	<span class="s">&quot;^pa_&quot;</span><span class="p">,</span>

<span class="cm">/*</span>
<span class="cm"> * These are 16-bit segment symbols when compiling 16-bit code.</span>
<span class="cm"> */</span>
	<span class="p">[</span><span class="n">S_SEG</span><span class="p">]</span> <span class="o">=</span>
	<span class="s">&quot;^real_mode_seg$&quot;</span><span class="p">,</span>

<span class="cm">/*</span>
<span class="cm"> * These are offsets belonging to segments, as opposed to linear addresses,</span>
<span class="cm"> * when compiling 16-bit code.</span>
<span class="cm"> */</span>
	<span class="p">[</span><span class="n">S_LIN</span><span class="p">]</span> <span class="o">=</span>
	<span class="s">&quot;^pa_&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">sym_regex</span><span class="p">;</span>

<span class="k">static</span> <span class="n">regex_t</span> <span class="n">sym_regex_c</span><span class="p">[</span><span class="n">S_NSYMTYPES</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_reloc</span><span class="p">(</span><span class="k">enum</span> <span class="n">symtype</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sym_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sym_regex</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">regexec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sym_regex_c</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">sym_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">regex_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">use_real_mode</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="n">errbuf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_real_mode</span><span class="p">)</span>
		<span class="n">sym_regex</span> <span class="o">=</span> <span class="n">sym_regex_realmode</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sym_regex</span> <span class="o">=</span> <span class="n">sym_regex_kernel</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">S_NSYMTYPES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym_regex</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">regcomp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sym_regex_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sym_regex</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">REG_EXTENDED</span><span class="o">|</span><span class="n">REG_NOSUB</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regerror</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sym_regex_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">errbuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">errbuf</span><span class="p">);</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">);</span>
		<span class="p">}</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sym_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define SYM_TYPE(X) [X] = #X</span>
		<span class="n">SYM_TYPE</span><span class="p">(</span><span class="n">STT_NOTYPE</span><span class="p">),</span>
		<span class="n">SYM_TYPE</span><span class="p">(</span><span class="n">STT_OBJECT</span><span class="p">),</span>
		<span class="n">SYM_TYPE</span><span class="p">(</span><span class="n">STT_FUNC</span><span class="p">),</span>
		<span class="n">SYM_TYPE</span><span class="p">(</span><span class="n">STT_SECTION</span><span class="p">),</span>
		<span class="n">SYM_TYPE</span><span class="p">(</span><span class="n">STT_FILE</span><span class="p">),</span>
		<span class="n">SYM_TYPE</span><span class="p">(</span><span class="n">STT_COMMON</span><span class="p">),</span>
		<span class="n">SYM_TYPE</span><span class="p">(</span><span class="n">STT_TLS</span><span class="p">),</span>
<span class="cp">#undef SYM_TYPE</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;unknown sym type name&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">type_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">type_name</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sym_bind</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">bind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bind_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define SYM_BIND(X) [X] = #X</span>
		<span class="n">SYM_BIND</span><span class="p">(</span><span class="n">STB_LOCAL</span><span class="p">),</span>
		<span class="n">SYM_BIND</span><span class="p">(</span><span class="n">STB_GLOBAL</span><span class="p">),</span>
		<span class="n">SYM_BIND</span><span class="p">(</span><span class="n">STB_WEAK</span><span class="p">),</span>
<span class="cp">#undef SYM_BIND</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;unknown sym bind name&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bind</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bind_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">bind_name</span><span class="p">[</span><span class="n">bind</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sym_visibility</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">visibility</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">visibility_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define SYM_VISIBILITY(X) [X] = #X</span>
		<span class="n">SYM_VISIBILITY</span><span class="p">(</span><span class="n">STV_DEFAULT</span><span class="p">),</span>
		<span class="n">SYM_VISIBILITY</span><span class="p">(</span><span class="n">STV_INTERNAL</span><span class="p">),</span>
		<span class="n">SYM_VISIBILITY</span><span class="p">(</span><span class="n">STV_HIDDEN</span><span class="p">),</span>
		<span class="n">SYM_VISIBILITY</span><span class="p">(</span><span class="n">STV_PROTECTED</span><span class="p">),</span>
<span class="cp">#undef SYM_VISIBILITY</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;unknown sym visibility name&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">visibility</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">visibility_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">visibility_name</span><span class="p">[</span><span class="n">visibility</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">rel_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define REL_TYPE(X) [X] = #X</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_NONE</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_32</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_PC32</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_GOT32</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_PLT32</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_COPY</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_GLOB_DAT</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_JMP_SLOT</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_RELATIVE</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_GOTOFF</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_GOTPC</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_8</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_PC8</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_16</span><span class="p">),</span>
		<span class="n">REL_TYPE</span><span class="p">(</span><span class="n">R_386_PC16</span><span class="p">),</span>
<span class="cp">#undef REL_TYPE</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;unknown type rel type name&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">type_name</span><span class="p">[</span><span class="n">type</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">type_name</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sec_name</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">shndx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sec_strtab</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">sec_strtab</span> <span class="o">=</span> <span class="n">secs</span><span class="p">[</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_shstrndx</span><span class="p">].</span><span class="n">strtab</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;&lt;noname&gt;&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shndx</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">sec_strtab</span> <span class="o">+</span> <span class="n">secs</span><span class="p">[</span><span class="n">shndx</span><span class="p">].</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_name</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shndx</span> <span class="o">==</span> <span class="n">SHN_ABS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ABSOLUTE&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shndx</span> <span class="o">==</span> <span class="n">SHN_COMMON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;COMMON&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sym_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sym_strtab</span><span class="p">,</span> <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;&lt;noname&gt;&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">sym_strtab</span> <span class="o">+</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_name</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">sec_name</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_shndx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>



<span class="cp">#if BYTE_ORDER == LITTLE_ENDIAN</span>
<span class="cp">#define le16_to_cpu(val) (val)</span>
<span class="cp">#define le32_to_cpu(val) (val)</span>
<span class="cp">#endif</span>
<span class="cp">#if BYTE_ORDER == BIG_ENDIAN</span>
<span class="cp">#define le16_to_cpu(val) bswap_16(val)</span>
<span class="cp">#define le32_to_cpu(val) bswap_32(val)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">elf16_to_cpu</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">elf32_to_cpu</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_ehdr</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ehdr</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Cannot read ELF header: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_ident</span><span class="p">,</span> <span class="n">ELFMAG</span><span class="p">,</span> <span class="n">SELFMAG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;No ELF magic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_CLASS</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ELFCLASS32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Not a 32 bit executable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_DATA</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ELFDATA2LSB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Not a LSB ELF executable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_VERSION</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EV_CURRENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unknown ELF version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Convert the fields to native endian */</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_type</span>      <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_type</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_machine</span>   <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_machine</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_version</span>   <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_version</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_entry</span>     <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_entry</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_phoff</span>     <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_phoff</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_shoff</span>     <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_shoff</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_flags</span>     <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_flags</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_ehsize</span>    <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_ehsize</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_phentsize</span> <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_phentsize</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_phnum</span>     <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_phnum</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_shentsize</span> <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_shentsize</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span>     <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">);</span>
	<span class="n">ehdr</span><span class="p">.</span><span class="n">e_shstrndx</span>  <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_shstrndx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_type</span> <span class="o">!=</span> <span class="n">ET_EXEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_type</span> <span class="o">!=</span> <span class="n">ET_DYN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unsupported ELF header type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_machine</span> <span class="o">!=</span> <span class="n">EM_386</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Not for x86</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_version</span> <span class="o">!=</span> <span class="n">EV_CURRENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unknown ELF version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_ehsize</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Ehdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Bad Elf header size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_phentsize</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Phdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Bad program header entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_shentsize</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Shdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Bad section header entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_shstrndx</span> <span class="o">&gt;=</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;String table index out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_shdrs</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">Elf32_Shdr</span> <span class="n">shdr</span><span class="p">;</span>

	<span class="n">secs</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">section</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">secs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unable to allocate %d section headers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shoff</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Seek to %d failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ehdr</span><span class="p">.</span><span class="n">e_shoff</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shdr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">shdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Cannot read ELF section headers %d/%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">i</span><span class="p">,</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_name</span>      <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_name</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_type</span>      <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_type</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_flags</span>     <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_flags</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_addr</span>      <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_addr</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_offset</span>    <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_offset</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span>      <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_link</span>      <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_link</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_info</span>      <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_info</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_addralign</span> <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_addralign</span><span class="p">);</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_entsize</span>   <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_entsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_link</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">)</span>
			<span class="n">sec</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_link</span><span class="p">];</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_strtabs</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_type</span> <span class="o">!=</span> <span class="n">SHT_STRTAB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc of %d bytes for strtab failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Seek to %d failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_offset</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Cannot read symbol table: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_symtabs</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_type</span> <span class="o">!=</span> <span class="n">SHT_SYMTAB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">symtab</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc of %d bytes for symtab failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Seek to %d failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_offset</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Cannot read symbol table: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Sym</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sym</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_name</span>  <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_name</span><span class="p">);</span>
			<span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_value</span> <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_value</span><span class="p">);</span>
			<span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_size</span>  <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">);</span>
			<span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_shndx</span> <span class="o">=</span> <span class="n">elf16_to_cpu</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_shndx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_relocs</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_type</span> <span class="o">!=</span> <span class="n">SHT_REL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sec</span><span class="o">-&gt;</span><span class="n">reltab</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">reltab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc of %d bytes for relocs failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Seek to %d failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_offset</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">reltab</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">die</span><span class="p">(</span><span class="s">&quot;Cannot read symbol table: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Rel</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">reltab</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_offset</span> <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_offset</span><span class="p">);</span>
			<span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span>   <span class="o">=</span> <span class="n">elf32_to_cpu</span><span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_absolute_symbols</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Absolute symbols</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot; Num:    Value Size  Type       Bind        Visibility  Name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">sym_strtab</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_type</span> <span class="o">!=</span> <span class="n">SHT_SYMTAB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sym_strtab</span> <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Sym</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
			<span class="n">sym</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">sym_name</span><span class="p">(</span><span class="n">sym_strtab</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_shndx</span> <span class="o">!=</span> <span class="n">SHN_ABS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%5d %08x %5d %10s %10s %12s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">j</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_value</span><span class="p">,</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span>
				<span class="n">sym_type</span><span class="p">(</span><span class="n">ELF32_ST_TYPE</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)),</span>
				<span class="n">sym_bind</span><span class="p">(</span><span class="n">ELF32_ST_BIND</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)),</span>
				<span class="n">sym_visibility</span><span class="p">(</span><span class="n">ELF32_ST_VISIBILITY</span><span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_other</span><span class="p">)),</span>
				<span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_absolute_relocs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec_applies</span><span class="p">,</span> <span class="o">*</span><span class="n">sec_symtab</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">sym_strtab</span><span class="p">;</span>
		<span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sh_symtab</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_type</span> <span class="o">!=</span> <span class="n">SHT_REL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sec_symtab</span>  <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
		<span class="n">sec_applies</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_info</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sec_applies</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_flags</span> <span class="o">&amp;</span> <span class="n">SHF_ALLOC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sh_symtab</span>  <span class="o">=</span> <span class="n">sec_symtab</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">;</span>
		<span class="n">sym_strtab</span> <span class="o">=</span> <span class="n">sec_symtab</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Rel</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">;</span>
			<span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
			<span class="n">rel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">reltab</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">sym</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_symtab</span><span class="p">[</span><span class="n">ELF32_R_SYM</span><span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">)];</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">sym_name</span><span class="p">(</span><span class="n">sym_strtab</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_shndx</span> <span class="o">!=</span> <span class="n">SHN_ABS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Absolute symbols are not relocated if bzImage is</span>
<span class="cm">			 * loaded at a non-compiled address. Display a warning</span>
<span class="cm">			 * to user at compile time about the absolute</span>
<span class="cm">			 * relocations present.</span>
<span class="cm">			 *</span>
<span class="cm">			 * User need to audit the code to make sure</span>
<span class="cm">			 * some symbols which should have been section</span>
<span class="cm">			 * relative have not become absolute because of some</span>
<span class="cm">			 * linker optimization or wrong programming usage.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Before warning check if this absolute symbol</span>
<span class="cm">			 * relocation is harmless.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_reloc</span><span class="p">(</span><span class="n">S_ABS</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_reloc</span><span class="p">(</span><span class="n">S_REL</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: Absolute relocations&quot;</span>
					<span class="s">&quot; present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Offset     Info     Type     Sym.Value &quot;</span>
					<span class="s">&quot;Sym.Name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">printed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%08x %08x %10s %08x  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_offset</span><span class="p">,</span>
				<span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">,</span>
				<span class="n">rel_type</span><span class="p">(</span><span class="n">ELF32_R_TYPE</span><span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">)),</span>
				<span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_value</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">printed</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">walk_relocs</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">visit</span><span class="p">)(</span><span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sym</span><span class="p">),</span>
			<span class="kt">int</span> <span class="n">use_real_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* Walk through the relocations */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehdr</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">sym_strtab</span><span class="p">;</span>
		<span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sh_symtab</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec_applies</span><span class="p">,</span> <span class="o">*</span><span class="n">sec_symtab</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">section</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_type</span> <span class="o">!=</span> <span class="n">SHT_REL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sec_symtab</span>  <span class="o">=</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
		<span class="n">sec_applies</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">[</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_info</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sec_applies</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_flags</span> <span class="o">&amp;</span> <span class="n">SHF_ALLOC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sh_symtab</span> <span class="o">=</span> <span class="n">sec_symtab</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">;</span>
		<span class="n">sym_strtab</span> <span class="o">=</span> <span class="n">sec_symtab</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sec</span><span class="o">-&gt;</span><span class="n">shdr</span><span class="p">.</span><span class="n">sh_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Rel</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">;</span>
			<span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="n">r_type</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symname</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">shn_abs</span><span class="p">;</span>

			<span class="n">rel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sec</span><span class="o">-&gt;</span><span class="n">reltab</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">sym</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_symtab</span><span class="p">[</span><span class="n">ELF32_R_SYM</span><span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">)];</span>
			<span class="n">r_type</span> <span class="o">=</span> <span class="n">ELF32_R_TYPE</span><span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">);</span>

			<span class="n">shn_abs</span> <span class="o">=</span> <span class="n">sym</span><span class="o">-&gt;</span><span class="n">st_shndx</span> <span class="o">==</span> <span class="n">SHN_ABS</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">r_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">R_386_NONE</span>:
			<span class="k">case</span> <span class="n">R_386_PC32</span>:
			<span class="k">case</span> <span class="n">R_386_PC16</span>:
			<span class="k">case</span> <span class="n">R_386_PC8</span>:
				<span class="cm">/*</span>
<span class="cm">				 * NONE can be ignored and and PC relative</span>
<span class="cm">				 * relocations don&#39;t need to be adjusted.</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">R_386_16</span>:
				<span class="n">symname</span> <span class="o">=</span> <span class="n">sym_name</span><span class="p">(</span><span class="n">sym_strtab</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_real_mode</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">shn_abs</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">is_reloc</span><span class="p">(</span><span class="n">S_ABS</span><span class="p">,</span> <span class="n">symname</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_reloc</span><span class="p">(</span><span class="n">S_SEG</span><span class="p">,</span> <span class="n">symname</span><span class="p">))</span>
						<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">is_reloc</span><span class="p">(</span><span class="n">S_LIN</span><span class="p">,</span> <span class="n">symname</span><span class="p">))</span>
						<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">visit</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">R_386_32</span>:
				<span class="n">symname</span> <span class="o">=</span> <span class="n">sym_name</span><span class="p">(</span><span class="n">sym_strtab</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">shn_abs</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">is_reloc</span><span class="p">(</span><span class="n">S_ABS</span><span class="p">,</span> <span class="n">symname</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_reloc</span><span class="p">(</span><span class="n">S_REL</span><span class="p">,</span> <span class="n">symname</span><span class="p">))</span>
						<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">use_real_mode</span> <span class="o">&amp;&amp;</span>
					    <span class="o">!</span><span class="n">is_reloc</span><span class="p">(</span><span class="n">S_LIN</span><span class="p">,</span> <span class="n">symname</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">visit</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unsupported relocation type: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">rel_type</span><span class="p">(</span><span class="n">r_type</span><span class="p">),</span> <span class="n">r_type</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">bad:</span>
				<span class="n">symname</span> <span class="o">=</span> <span class="n">sym_name</span><span class="p">(</span><span class="n">sym_strtab</span><span class="p">,</span> <span class="n">sym</span><span class="p">);</span>
				<span class="n">die</span><span class="p">(</span><span class="s">&quot;Invalid %s %s relocation: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">shn_abs</span> <span class="o">?</span> <span class="s">&quot;absolute&quot;</span> <span class="o">:</span> <span class="s">&quot;relative&quot;</span><span class="p">,</span>
				    <span class="n">rel_type</span><span class="p">(</span><span class="n">r_type</span><span class="p">),</span> <span class="n">symname</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">count_reloc</span><span class="p">(</span><span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ELF32_R_TYPE</span><span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">)</span> <span class="o">==</span> <span class="n">R_386_16</span><span class="p">)</span>
		<span class="n">reloc16_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reloc_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">collect_reloc</span><span class="p">(</span><span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Remember the address that needs to be adjusted. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ELF32_R_TYPE</span><span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">)</span> <span class="o">==</span> <span class="n">R_386_16</span><span class="p">)</span>
		<span class="n">relocs16</span><span class="p">[</span><span class="n">reloc16_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">relocs</span><span class="p">[</span><span class="n">reloc_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel</span><span class="o">-&gt;</span><span class="n">r_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmp_relocs</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">vb</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">a</span> <span class="o">==</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="o">*</span><span class="n">a</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write32</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emit_relocs</span><span class="p">(</span><span class="kt">int</span> <span class="n">as_text</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_real_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* Count how many relocations I have and allocate space for them. */</span>
	<span class="n">reloc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">walk_relocs</span><span class="p">(</span><span class="n">count_reloc</span><span class="p">,</span> <span class="n">use_real_mode</span><span class="p">);</span>
	<span class="n">relocs</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">reloc_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">relocs</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc of %d entries for relocs failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reloc_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">relocs16</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">reloc16_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">relocs</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocs16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;malloc of %d entries for relocs16 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reloc16_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Collect up the relocations */</span>
	<span class="n">reloc_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">walk_relocs</span><span class="p">(</span><span class="n">collect_reloc</span><span class="p">,</span> <span class="n">use_real_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reloc16_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">use_real_mode</span><span class="p">)</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Segment relocations found but --realmode not specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Order the relocations for more efficient processing */</span>
	<span class="n">qsort</span><span class="p">(</span><span class="n">relocs</span><span class="p">,</span> <span class="n">reloc_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">relocs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">cmp_relocs</span><span class="p">);</span>
	<span class="n">qsort</span><span class="p">(</span><span class="n">relocs16</span><span class="p">,</span> <span class="n">reloc16_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">relocs16</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">cmp_relocs</span><span class="p">);</span>

	<span class="cm">/* Print the relocations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">as_text</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Print the relocations in a form suitable that</span>
<span class="cm">		 * gas will like.</span>
<span class="cm">		 */</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;.section </span><span class="se">\&quot;</span><span class="s">.data.reloc</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;.balign 4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_real_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.long %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reloc16_count</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reloc16_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.long 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">relocs16</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.long %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reloc_count</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reloc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.long 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">relocs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Print a stop */</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.long 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reloc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.long 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">relocs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_real_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write32</span><span class="p">(</span><span class="n">reloc16_count</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reloc16_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">write32</span><span class="p">(</span><span class="n">relocs16</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stdout</span><span class="p">);</span>
			<span class="n">write32</span><span class="p">(</span><span class="n">reloc_count</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>

			<span class="cm">/* Now print each relocation */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reloc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">write32</span><span class="p">(</span><span class="n">relocs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stdout</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Print a stop */</span>
			<span class="n">write32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>

			<span class="cm">/* Now print each relocation */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reloc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write32</span><span class="p">(</span><span class="n">relocs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stdout</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;relocs [--abs-syms|--abs-relocs|--text|--realmode] vmlinux</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">show_absolute_syms</span><span class="p">,</span> <span class="n">show_absolute_relocs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">as_text</span><span class="p">,</span> <span class="n">use_real_mode</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">;</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">show_absolute_syms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">show_absolute_relocs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">as_text</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">use_real_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">arg</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--abs-syms&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">show_absolute_syms</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--abs-relocs&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">show_absolute_relocs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--text&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">as_text</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--realmode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">use_real_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fname</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fname</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">usage</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usage</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">regex_init</span><span class="p">(</span><span class="n">use_real_mode</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Cannot open %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">read_ehdr</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">read_shdrs</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">read_strtabs</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">read_symtabs</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">read_relocs</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">show_absolute_syms</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_absolute_symbols</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">show_absolute_relocs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_absolute_relocs</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">emit_relocs</span><span class="p">(</span><span class="n">as_text</span><span class="p">,</span> <span class="n">use_real_mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
