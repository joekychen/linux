<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › mm › dump_pagetables.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dump_pagetables.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Debug helper to dump the current kernel pagetables of the system</span>
<span class="cm"> * so that we can see what the various memory ranges are set to.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 2008 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Arjan van de Ven &lt;arjan@linux.intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; version 2</span>
<span class="cm"> * of the License.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cp">#include &lt;asm/pgtable.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * The dumper groups pagetable entries of the same type into one, and for</span>
<span class="cm"> * that it needs to keep some state when walking, and flush this state</span>
<span class="cm"> * when a &quot;break&quot; in the continuity is found.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pg_state</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">pgprot_t</span> <span class="n">current_prot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">current_address</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">addr_marker</span> <span class="o">*</span><span class="n">marker</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">addr_marker</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* indices for address_markers; keep sync&#39;d w/ address_markers below */</span>
<span class="k">enum</span> <span class="n">address_markers_idx</span> <span class="p">{</span>
	<span class="n">USER_SPACE_NR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">KERNEL_SPACE_NR</span><span class="p">,</span>
	<span class="n">LOW_KERNEL_NR</span><span class="p">,</span>
	<span class="n">VMALLOC_START_NR</span><span class="p">,</span>
	<span class="n">VMEMMAP_START_NR</span><span class="p">,</span>
	<span class="n">HIGH_KERNEL_NR</span><span class="p">,</span>
	<span class="n">MODULES_VADDR_NR</span><span class="p">,</span>
	<span class="n">MODULES_END_NR</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="n">KERNEL_SPACE_NR</span><span class="p">,</span>
	<span class="n">VMALLOC_START_NR</span><span class="p">,</span>
	<span class="n">VMALLOC_END_NR</span><span class="p">,</span>
<span class="cp"># ifdef CONFIG_HIGHMEM</span>
	<span class="n">PKMAP_BASE_NR</span><span class="p">,</span>
<span class="cp"># endif</span>
	<span class="n">FIXADDR_START_NR</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* Address space markers hints */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">addr_marker</span> <span class="n">address_markers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;User Space&quot;</span> <span class="p">},</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="p">{</span> <span class="mh">0x8000000000000000UL</span><span class="p">,</span> <span class="s">&quot;Kernel Space&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PAGE_OFFSET</span><span class="p">,</span>		<span class="s">&quot;Low Kernel Mapping&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VMALLOC_START</span><span class="p">,</span>        <span class="s">&quot;vmalloc() Area&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VMEMMAP_START</span><span class="p">,</span>        <span class="s">&quot;Vmemmap&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">__START_KERNEL_map</span><span class="p">,</span>   <span class="s">&quot;High Kernel Mapping&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MODULES_VADDR</span><span class="p">,</span>        <span class="s">&quot;Modules&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MODULES_END</span><span class="p">,</span>          <span class="s">&quot;End Modules&quot;</span> <span class="p">},</span>
<span class="cp">#else</span>
	<span class="p">{</span> <span class="n">PAGE_OFFSET</span><span class="p">,</span>          <span class="s">&quot;Kernel Mapping&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="cm">/* VMALLOC_START */</span><span class="p">,</span> <span class="s">&quot;vmalloc() Area&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="cm">/*VMALLOC_END*/</span><span class="p">,</span>     <span class="s">&quot;vmalloc() End&quot;</span> <span class="p">},</span>
<span class="cp"># ifdef CONFIG_HIGHMEM</span>
	<span class="p">{</span> <span class="mi">0</span><span class="cm">/*PKMAP_BASE*/</span><span class="p">,</span>      <span class="s">&quot;Persisent kmap() Area&quot;</span> <span class="p">},</span>
<span class="cp"># endif</span>
	<span class="p">{</span> <span class="mi">0</span><span class="cm">/*FIXADDR_START*/</span><span class="p">,</span>   <span class="s">&quot;Fixmap Area&quot;</span> <span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>		<span class="cm">/* End of list */</span>
<span class="p">};</span>

<span class="cm">/* Multipliers for offsets within the PTEs */</span>
<span class="cp">#define PTE_LEVEL_MULT (PAGE_SIZE)</span>
<span class="cp">#define PMD_LEVEL_MULT (PTRS_PER_PTE * PTE_LEVEL_MULT)</span>
<span class="cp">#define PUD_LEVEL_MULT (PTRS_PER_PMD * PMD_LEVEL_MULT)</span>
<span class="cp">#define PGD_LEVEL_MULT (PTRS_PER_PUD * PUD_LEVEL_MULT)</span>

<span class="cm">/*</span>
<span class="cm"> * Print a readable form of a pgprot_t to the seq_file</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">printk_prot</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">pgprot_t</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgprotval_t</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">pgprot_val</span><span class="p">(</span><span class="n">prot</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">level_name</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="s">&quot;cr3&quot;</span><span class="p">,</span> <span class="s">&quot;pgd&quot;</span><span class="p">,</span> <span class="s">&quot;pud&quot;</span><span class="p">,</span> <span class="s">&quot;pmd&quot;</span><span class="p">,</span> <span class="s">&quot;pte&quot;</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pgprot_val</span><span class="p">(</span><span class="n">prot</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not present */</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;                          &quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">_PAGE_USER</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;USR &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">_PAGE_RW</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RW &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ro &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">_PAGE_PWT</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PWT &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">_PAGE_PCD</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PCD &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>

		<span class="cm">/* Bit 9 has a different meaning on level 3 vs 4 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">_PAGE_PSE</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PSE &quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">_PAGE_PAT</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;pat &quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">_PAGE_GLOBAL</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GLB &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">_PAGE_NX</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;NX &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;x  &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level_name</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On 64 bits, sign-extend the 48 bit address to 64 bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">normalize_addr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">long</span><span class="p">)(</span><span class="n">u</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">u</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function gets called on a break in a continuous series</span>
<span class="cm"> * of PTE entries; the next one is different so we need to</span>
<span class="cm"> * print what we collected so far.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">note_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pg_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span>
		      <span class="n">pgprot_t</span> <span class="n">new_prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgprotval_t</span> <span class="n">prot</span><span class="p">,</span> <span class="n">cur</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">units</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;KMGTPE&quot;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have a &quot;break&quot; in the series, we need to flush the state that</span>
<span class="cm">	 * we have now. &quot;break&quot; is either changing perms, levels or</span>
<span class="cm">	 * address space marker.</span>
<span class="cm">	 */</span>
	<span class="n">prot</span> <span class="o">=</span> <span class="n">pgprot_val</span><span class="p">(</span><span class="n">new_prot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PTE_FLAGS_MASK</span><span class="p">;</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="n">pgprot_val</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">current_prot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PTE_FLAGS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First entry */</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">current_prot</span> <span class="o">=</span> <span class="n">new_prot</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">marker</span> <span class="o">=</span> <span class="n">address_markers</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;---[ %s ]---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">marker</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prot</span> <span class="o">!=</span> <span class="n">cur</span> <span class="o">||</span> <span class="n">level</span> <span class="o">!=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">||</span>
		   <span class="n">st</span><span class="o">-&gt;</span><span class="n">current_address</span> <span class="o">&gt;=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">marker</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">unit</span> <span class="o">=</span> <span class="n">units</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now print the actual finished series</span>
<span class="cm">		 */</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;0x%0*lx-0x%0*lx   &quot;</span><span class="p">,</span>
			   <span class="n">width</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">start_address</span><span class="p">,</span>
			   <span class="n">width</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">current_address</span><span class="p">);</span>

		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">current_address</span> <span class="o">-</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">start_address</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="mi">1023</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">unit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">delta</span> <span class="o">&gt;&gt;=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">unit</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%9lu%c &quot;</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="o">*</span><span class="n">unit</span><span class="p">);</span>
		<span class="n">printk_prot</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">current_prot</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We print markers for special areas of address space,</span>
<span class="cm">		 * such as the start of vmalloc space etc.</span>
<span class="cm">		 * This helps in the interpretation.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">current_address</span> <span class="o">&gt;=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">marker</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start_address</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">marker</span><span class="o">++</span><span class="p">;</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;---[ %s ]---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">marker</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">st</span><span class="o">-&gt;</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">current_address</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">current_prot</span> <span class="o">=</span> <span class="n">new_prot</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">walk_pte_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pg_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">pmd_t</span> <span class="n">addr</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">P</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmd_page_vaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTRS_PER_PTE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pgprot_t</span> <span class="n">prot</span> <span class="o">=</span> <span class="n">pte_pgprot</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">);</span>

		<span class="n">st</span><span class="o">-&gt;</span><span class="n">current_address</span> <span class="o">=</span> <span class="n">normalize_addr</span><span class="p">(</span><span class="n">P</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PTE_LEVEL_MULT</span><span class="p">);</span>
		<span class="n">note_page</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">start</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if PTRS_PER_PMD &gt; 1</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">walk_pmd_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pg_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">pud_t</span> <span class="n">addr</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">P</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">pmd_t</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pud_page_vaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTRS_PER_PMD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">current_address</span> <span class="o">=</span> <span class="n">normalize_addr</span><span class="p">(</span><span class="n">P</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PMD_LEVEL_MULT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmd_none</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pgprotval_t</span> <span class="n">prot</span> <span class="o">=</span> <span class="n">pmd_val</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PTE_FLAGS_MASK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pmd_large</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pmd_present</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">))</span>
				<span class="n">note_page</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">__pgprot</span><span class="p">(</span><span class="n">prot</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">walk_pte_level</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
					       <span class="n">P</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PMD_LEVEL_MULT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">note_page</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">__pgprot</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">start</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define walk_pmd_level(m,s,a,p) walk_pte_level(m,s,__pmd(pud_val(a)),p)</span>
<span class="cp">#define pud_large(a) pmd_large(__pmd(pud_val(a)))</span>
<span class="cp">#define pud_none(a)  pmd_none(__pmd(pud_val(a)))</span>
<span class="cp">#endif</span>

<span class="cp">#if PTRS_PER_PUD &gt; 1</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">walk_pud_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pg_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">pgd_t</span> <span class="n">addr</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">P</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">pud_t</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">pud_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pgd_page_vaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTRS_PER_PUD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">current_address</span> <span class="o">=</span> <span class="n">normalize_addr</span><span class="p">(</span><span class="n">P</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PUD_LEVEL_MULT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pud_none</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pgprotval_t</span> <span class="n">prot</span> <span class="o">=</span> <span class="n">pud_val</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PTE_FLAGS_MASK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pud_large</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pud_present</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">))</span>
				<span class="n">note_page</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">__pgprot</span><span class="p">(</span><span class="n">prot</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">walk_pmd_level</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
					       <span class="n">P</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PUD_LEVEL_MULT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">note_page</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">__pgprot</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">start</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define walk_pud_level(m,s,a,p) walk_pmd_level(m,s,__pud(pgd_val(a)),p)</span>
<span class="cp">#define pgd_large(a) pud_large(__pud(pgd_val(a)))</span>
<span class="cp">#define pgd_none(a)  pud_none(__pud(pgd_val(a)))</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">walk_pgd_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86_64</span>
	<span class="n">pgd_t</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">pgd_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">init_level4_pgt</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">pgd_t</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">swapper_pg_dir</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pg_state</span> <span class="n">st</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTRS_PER_PGD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span><span class="p">.</span><span class="n">current_address</span> <span class="o">=</span> <span class="n">normalize_addr</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">PGD_LEVEL_MULT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pgd_none</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pgprotval_t</span> <span class="n">prot</span> <span class="o">=</span> <span class="n">pgd_val</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PTE_FLAGS_MASK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pgd_large</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pgd_present</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">))</span>
				<span class="n">note_page</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">,</span> <span class="n">__pgprot</span><span class="p">(</span><span class="n">prot</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">walk_pud_level</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
					       <span class="n">i</span> <span class="o">*</span> <span class="n">PGD_LEVEL_MULT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">note_page</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">,</span> <span class="n">__pgprot</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">start</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Flush out the last page */</span>
	<span class="n">st</span><span class="p">.</span><span class="n">current_address</span> <span class="o">=</span> <span class="n">normalize_addr</span><span class="p">(</span><span class="n">PTRS_PER_PGD</span><span class="o">*</span><span class="n">PGD_LEVEL_MULT</span><span class="p">);</span>
	<span class="n">note_page</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">,</span> <span class="n">__pgprot</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ptdump_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">walk_pgd_level</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ptdump_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">ptdump_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ptdump_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ptdump_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pt_dump_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
	<span class="cm">/* Not a compile-time constant on x86-32 */</span>
	<span class="n">address_markers</span><span class="p">[</span><span class="n">VMALLOC_START_NR</span><span class="p">].</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">VMALLOC_START</span><span class="p">;</span>
	<span class="n">address_markers</span><span class="p">[</span><span class="n">VMALLOC_END_NR</span><span class="p">].</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">VMALLOC_END</span><span class="p">;</span>
<span class="cp"># ifdef CONFIG_HIGHMEM</span>
	<span class="n">address_markers</span><span class="p">[</span><span class="n">PKMAP_BASE_NR</span><span class="p">].</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">PKMAP_BASE</span><span class="p">;</span>
<span class="cp"># endif</span>
	<span class="n">address_markers</span><span class="p">[</span><span class="n">FIXADDR_START_NR</span><span class="p">].</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">FIXADDR_START</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;kernel_page_tables&quot;</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ptdump_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pe</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">pt_dump_init</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Arjan van de Ven &lt;arjan@linux.intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Kernel debugging helper that dumps pagetables&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
