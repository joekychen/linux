<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › include › asm › iommu_table.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iommu_table.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_X86_IOMMU_TABLE_H</span>
<span class="cp">#define _ASM_X86_IOMMU_TABLE_H</span>

<span class="cp">#include &lt;asm/swiotlb.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * History lesson:</span>
<span class="cm"> * The execution chain of IOMMUs in 2.6.36 looks as so:</span>
<span class="cm"> *</span>
<span class="cm"> *            [xen-swiotlb]</span>
<span class="cm"> *                 |</span>
<span class="cm"> *         +----[swiotlb *]--+</span>
<span class="cm"> *        /         |         \</span>
<span class="cm"> *       /          |          \</span>
<span class="cm"> *    [GART]     [Calgary]  [Intel VT-d]</span>
<span class="cm"> *     /</span>
<span class="cm"> *    /</span>
<span class="cm"> * [AMD-Vi]</span>
<span class="cm"> *</span>
<span class="cm"> * *: if SWIOTLB detected &#39;iommu=soft&#39;/&#39;swiotlb=force&#39; it would skip</span>
<span class="cm"> * over the rest of IOMMUs and unconditionally initialize the SWIOTLB.</span>
<span class="cm"> * Also it would surreptitiously initialize set the swiotlb=1 if there were</span>
<span class="cm"> * more than 4GB and if the user did not pass in &#39;iommu=off&#39;. The swiotlb</span>
<span class="cm"> * flag would be turned off by all IOMMUs except the Calgary one.</span>
<span class="cm"> *</span>
<span class="cm"> * The IOMMU_INIT* macros allow a similar tree (or more complex if desired)</span>
<span class="cm"> * to be built by defining who we depend on.</span>
<span class="cm"> *</span>
<span class="cm"> * And all that needs to be done is to use one of the macros in the IOMMU</span>
<span class="cm"> * and the pci-dma.c will take care of the rest.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">iommu_table_entry</span> <span class="p">{</span>
	<span class="n">initcall_t</span>	<span class="n">detect</span><span class="p">;</span>
	<span class="n">initcall_t</span>	<span class="n">depend</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">early_init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span> <span class="cm">/* No memory allocate available. */</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">late_init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span> <span class="cm">/* Yes, can allocate memory. */</span>
<span class="cp">#define IOMMU_FINISH_IF_DETECTED (1&lt;&lt;0)</span>
<span class="cp">#define IOMMU_DETECTED		 (1&lt;&lt;1)</span>
	<span class="kt">int</span>		<span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * Macro fills out an entry in the .iommu_table that is equivalent</span>
<span class="cm"> * to the fields that &#39;struct iommu_table_entry&#39; has. The entries</span>
<span class="cm"> * that are put in the .iommu_table section are not put in any order</span>
<span class="cm"> * hence during boot-time we will have to resort them based on</span>
<span class="cm"> * dependency. */</span>


<span class="cp">#define __IOMMU_INIT(_detect, _depend, _early_init, _late_init, _finish)\</span>
<span class="cp">	static const struct iommu_table_entry const			\</span>
<span class="cp">		__iommu_entry_##_detect __used				\</span>
<span class="cp">	__attribute__ ((unused, __section__(&quot;.iommu_table&quot;),		\</span>
<span class="cp">			aligned((sizeof(void *)))))	\</span>
<span class="cp">	= {_detect, _depend, _early_init, _late_init,			\</span>
<span class="cp">	   _finish ? IOMMU_FINISH_IF_DETECTED : 0}</span>
<span class="cm">/*</span>
<span class="cm"> * The simplest IOMMU definition. Provide the detection routine</span>
<span class="cm"> * and it will be run after the SWIOTLB and the other IOMMUs</span>
<span class="cm"> * that utilize this macro. If the IOMMU is detected (ie, the</span>
<span class="cm"> * detect routine returns a positive value), the other IOMMUs</span>
<span class="cm"> * are also checked. You can use IOMMU_INIT_POST_FINISH if you prefer</span>
<span class="cm"> * to stop detecting the other IOMMUs after yours has been detected.</span>
<span class="cm"> */</span>
<span class="cp">#define IOMMU_INIT_POST(_detect)					\</span>
<span class="cp">	__IOMMU_INIT(_detect, pci_swiotlb_detect_4gb,  0, 0, 0)</span>

<span class="cp">#define IOMMU_INIT_POST_FINISH(detect)					\</span>
<span class="cp">	__IOMMU_INIT(_detect, pci_swiotlb_detect_4gb,  0, 0, 1)</span>

<span class="cm">/*</span>
<span class="cm"> * A more sophisticated version of IOMMU_INIT. This variant requires:</span>
<span class="cm"> *  a). A detection routine function.</span>
<span class="cm"> *  b). The name of the detection routine we depend on to get called</span>
<span class="cm"> *      before us.</span>
<span class="cm"> *  c). The init routine which gets called if the detection routine</span>
<span class="cm"> *      returns a positive value from the pci_iommu_alloc. This means</span>
<span class="cm"> *      no presence of a memory allocator.</span>
<span class="cm"> *  d). Similar to the &#39;init&#39;, except that this gets called from pci_iommu_init</span>
<span class="cm"> *      where we do have a memory allocator.</span>
<span class="cm"> *</span>
<span class="cm"> * The standard vs the _FINISH differs in that the _FINISH variant will</span>
<span class="cm"> * continue detecting other IOMMUs in the call list after the</span>
<span class="cm"> * the detection routine returns a positive number. The _FINISH will</span>
<span class="cm"> * stop the execution chain. Both will still call the &#39;init&#39; and</span>
<span class="cm"> * &#39;late_init&#39; functions if they are set.</span>
<span class="cm"> */</span>
<span class="cp">#define IOMMU_INIT_FINISH(_detect, _depend, _init, _late_init)		\</span>
<span class="cp">	__IOMMU_INIT(_detect, _depend, _init, _late_init, 1)</span>

<span class="cp">#define IOMMU_INIT(_detect, _depend, _init, _late_init)			\</span>
<span class="cp">	__IOMMU_INIT(_detect, _depend, _init, _late_init, 0)</span>

<span class="kt">void</span> <span class="n">sort_iommu_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table_entry</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">iommu_table_entry</span> <span class="o">*</span><span class="n">finish</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">check_iommu_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_table_entry</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iommu_table_entry</span> <span class="o">*</span><span class="n">finish</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* _ASM_X86_IOMMU_TABLE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
