<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › include › asm › paravirt.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>paravirt.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_X86_PARAVIRT_H</span>
<span class="cp">#define _ASM_X86_PARAVIRT_H</span>
<span class="cm">/* Various instructions on x86 need to be replaced for</span>
<span class="cm"> * para-virtualization: those hooks are defined here. */</span>

<span class="cp">#ifdef CONFIG_PARAVIRT</span>
<span class="cp">#include &lt;asm/pgtable_types.h&gt;</span>
<span class="cp">#include &lt;asm/asm.h&gt;</span>

<span class="cp">#include &lt;asm/paravirt_types.h&gt;</span>

<span class="cp">#ifndef __ASSEMBLY__</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/cpumask.h&gt;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">paravirt_enabled</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pv_info</span><span class="p">.</span><span class="n">paravirt_enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">load_sp0</span><span class="p">(</span><span class="k">struct</span> <span class="n">tss_struct</span> <span class="o">*</span><span class="n">tss</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">thread_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">load_sp0</span><span class="p">,</span> <span class="n">tss</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The paravirtualized CPUID instruction. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__cpuid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eax</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ebx</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ecx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">edx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL4</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">cpuid</span><span class="p">,</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These special macros can be used to get or set a debugging register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">paravirt_get_debugreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">get_debugreg</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#define get_debugreg(var, reg) var = paravirt_get_debugreg(reg)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_debugreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">set_debugreg</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">clts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">read_cr0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">read_cr0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_cr0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_cr0</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">read_cr2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">read_cr2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_cr2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">write_cr2</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">read_cr3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">read_cr3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_cr3</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">write_cr3</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">read_cr4</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">read_cr4</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">read_cr4_safe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">read_cr4_safe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_cr4</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_cr4</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">read_cr8</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">read_cr8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_cr8</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_cr8</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_safe_halt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">safe_halt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">halt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">halt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbinvd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">wbinvd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define get_kernel_rpl()  (pv_info.kernel_rpl)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">paravirt_read_msr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">msr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL2</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">read_msr</span><span class="p">,</span> <span class="n">msr</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">paravirt_rdmsr_regs</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">rdmsr_regs</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">paravirt_write_msr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">msr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">low</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_msr</span><span class="p">,</span> <span class="n">msr</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">paravirt_wrmsr_regs</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">wrmsr_regs</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* These should all do BUG_ON(_err), but our headers are too tangled. */</span>
<span class="cp">#define rdmsr(msr, val1, val2)			\</span>
<span class="cp">do {						\</span>
<span class="cp">	int _err;				\</span>
<span class="cp">	u64 _l = paravirt_read_msr(msr, &amp;_err);	\</span>
<span class="cp">	val1 = (u32)_l;				\</span>
<span class="cp">	val2 = _l &gt;&gt; 32;			\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define wrmsr(msr, val1, val2)			\</span>
<span class="cp">do {						\</span>
<span class="cp">	paravirt_write_msr(msr, val1, val2);	\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define rdmsrl(msr, val)			\</span>
<span class="cp">do {						\</span>
<span class="cp">	int _err;				\</span>
<span class="cp">	val = paravirt_read_msr(msr, &amp;_err);	\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define wrmsrl(msr, val)	wrmsr(msr, (u32)((u64)(val)), ((u64)(val))&gt;&gt;32)</span>
<span class="cp">#define wrmsr_safe(msr, a, b)	paravirt_write_msr(msr, a, b)</span>

<span class="cm">/* rdmsr with exception handling */</span>
<span class="cp">#define rdmsr_safe(msr, a, b)			\</span>
<span class="cp">({						\</span>
<span class="cp">	int _err;				\</span>
<span class="cp">	u64 _l = paravirt_read_msr(msr, &amp;_err);	\</span>
<span class="cp">	(*a) = (u32)_l;				\</span>
<span class="cp">	(*b) = _l &gt;&gt; 32;			\</span>
<span class="cp">	_err;					\</span>
<span class="cp">})</span>

<span class="cp">#define rdmsr_safe_regs(regs)	paravirt_rdmsr_regs(regs)</span>
<span class="cp">#define wrmsr_safe_regs(regs)	paravirt_wrmsr_regs(regs)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rdmsrl_safe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">msr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">paravirt_read_msr</span><span class="p">(</span><span class="n">msr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rdmsrl_amd_safe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">msr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gprs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">gprs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msr</span><span class="p">;</span>
	<span class="n">gprs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9c5a203a</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">paravirt_rdmsr_regs</span><span class="p">(</span><span class="n">gprs</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">gprs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">gprs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wrmsrl_amd_safe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">msr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gprs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">gprs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
	<span class="n">gprs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msr</span><span class="p">;</span>
	<span class="n">gprs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">gprs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9c5a203a</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">paravirt_wrmsr_regs</span><span class="p">(</span><span class="n">gprs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">paravirt_read_tsc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">read_tsc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define rdtscl(low)				\</span>
<span class="cp">do {						\</span>
<span class="cp">	u64 _l = paravirt_read_tsc();		\</span>
<span class="cp">	low = (int)_l;				\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define rdtscll(val) (val = paravirt_read_tsc())</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">paravirt_sched_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_time_ops</span><span class="p">.</span><span class="n">sched_clock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">static_key</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">static_key</span> <span class="n">paravirt_steal_enabled</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">static_key</span> <span class="n">paravirt_steal_rq_enabled</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">paravirt_steal_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">pv_time_ops</span><span class="p">.</span><span class="n">steal_clock</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">paravirt_read_pmc</span><span class="p">(</span><span class="kt">int</span> <span class="n">counter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">read_pmc</span><span class="p">,</span> <span class="n">counter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define rdpmc(counter, low, high)		\</span>
<span class="cp">do {						\</span>
<span class="cp">	u64 _l = paravirt_read_pmc(counter);	\</span>
<span class="cp">	low = (u32)_l;				\</span>
<span class="cp">	high = _l &gt;&gt; 32;			\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">paravirt_rdtscp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">aux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">read_tscp</span><span class="p">,</span> <span class="n">aux</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define rdtscp(low, high, aux)				\</span>
<span class="cp">do {							\</span>
<span class="cp">	int __aux;					\</span>
<span class="cp">	unsigned long __val = paravirt_rdtscp(&amp;__aux);	\</span>
<span class="cp">	(low) = (u32)__val;				\</span>
<span class="cp">	(high) = (u32)(__val &gt;&gt; 32);			\</span>
<span class="cp">	(aux) = __aux;					\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define rdtscpll(val, aux)				\</span>
<span class="cp">do {							\</span>
<span class="cp">	unsigned long __aux; 				\</span>
<span class="cp">	val = paravirt_rdtscp(&amp;__aux);			\</span>
<span class="cp">	(aux) = __aux;					\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_alloc_ldt</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">ldt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">alloc_ldt</span><span class="p">,</span> <span class="n">ldt</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_free_ldt</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">ldt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">free_ldt</span><span class="p">,</span> <span class="n">ldt</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">load_TR_desc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">load_tr_desc</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">load_gdt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">load_gdt</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">load_idt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">load_idt</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_ldt</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">set_ldt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">store_gdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">store_gdt</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">store_idt</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_ptr</span> <span class="o">*</span><span class="n">dtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">store_idt</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">paravirt_store_tr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">store_tr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#define store_tr(tr)	((tr) = paravirt_store_tr())</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">load_TLS</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">load_tls</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">load_gs_index</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">load_gs_index</span><span class="p">,</span> <span class="n">gs</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_ldt_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_ldt_entry</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_gdt_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL4</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_gdt_entry</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_idt_entry</span><span class="p">(</span><span class="n">gate_desc</span> <span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="k">const</span> <span class="n">gate_desc</span> <span class="o">*</span><span class="n">g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">write_idt_entry</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_iopl_mask</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">set_iopl_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The paravirtualized I/O functions */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">slow_down_io</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">io_delay</span><span class="p">();</span>
<span class="cp">#ifdef REALLY_SLOW_IO</span>
	<span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">io_delay</span><span class="p">();</span>
	<span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">io_delay</span><span class="p">();</span>
	<span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">io_delay</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">startup_ipi_hook</span><span class="p">(</span><span class="kt">int</span> <span class="n">phys_apicid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_eip</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_apic_ops</span><span class="p">.</span><span class="n">startup_ipi_hook</span><span class="p">,</span>
		    <span class="n">phys_apicid</span><span class="p">,</span> <span class="n">start_eip</span><span class="p">,</span> <span class="n">start_esp</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_activate_mm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">activate_mm</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_dup_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">oldmm</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">dup_mmap</span><span class="p">,</span> <span class="n">oldmm</span><span class="p">,</span> <span class="n">mm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_exit_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">exit_mmap</span><span class="p">,</span> <span class="n">mm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__flush_tlb</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">flush_tlb_user</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__flush_tlb_global</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">flush_tlb_kernel</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__flush_tlb_single</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">flush_tlb_single</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">flush_tlb_others</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">cpumask</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">flush_tlb_others</span><span class="p">,</span> <span class="n">cpumask</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">paravirt_pgd_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pgd_alloc</span><span class="p">,</span> <span class="n">mm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_pgd_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="n">pgd_t</span> <span class="o">*</span><span class="n">pgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pgd_free</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">pgd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_alloc_pte</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">alloc_pte</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_release_pte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">release_pte</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_alloc_pmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">alloc_pmd</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_release_pmd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">release_pmd</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_alloc_pud</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">alloc_pud</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">paravirt_release_pud</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">release_pud</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pte_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			      <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pte_update</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmd_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			      <span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pmd_update</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pmdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pte_update_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
				    <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pte_update_defer</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmd_update_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
				    <span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pmd_update_defer</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pmdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">__pte</span><span class="p">(</span><span class="n">pteval_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pteval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE2</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">,</span>
				   <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">make_pte</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE1</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">,</span>
				   <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">make_pte</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pte_t</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">pte</span> <span class="o">=</span> <span class="n">ret</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pteval_t</span> <span class="nf">pte_val</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pteval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE2</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pte_val</span><span class="p">,</span>
				   <span class="n">pte</span><span class="p">.</span><span class="n">pte</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pte</span><span class="p">.</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE1</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pte_val</span><span class="p">,</span>
				   <span class="n">pte</span><span class="p">.</span><span class="n">pte</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pgd_t</span> <span class="nf">__pgd</span><span class="p">(</span><span class="n">pgdval_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgdval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pgdval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE2</span><span class="p">(</span><span class="n">pgdval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">make_pgd</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE1</span><span class="p">(</span><span class="n">pgdval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">make_pgd</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pgd_t</span><span class="p">)</span> <span class="p">{</span> <span class="n">ret</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pgdval_t</span> <span class="nf">pgd_val</span><span class="p">(</span><span class="n">pgd_t</span> <span class="n">pgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgdval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pgdval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">PVOP_CALLEE2</span><span class="p">(</span><span class="n">pgdval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pgd_val</span><span class="p">,</span>
				    <span class="n">pgd</span><span class="p">.</span><span class="n">pgd</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pgd</span><span class="p">.</span><span class="n">pgd</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">PVOP_CALLEE1</span><span class="p">(</span><span class="n">pgdval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pgd_val</span><span class="p">,</span>
				    <span class="n">pgd</span><span class="p">.</span><span class="n">pgd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define  __HAVE_ARCH_PTEP_MODIFY_PROT_TRANSACTION</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">ptep_modify_prot_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
					   <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pteval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALL3</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">ptep_modify_prot_start</span><span class="p">,</span>
			 <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pte_t</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">pte</span> <span class="o">=</span> <span class="n">ret</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ptep_modify_prot_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
					   <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">,</span> <span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="cm">/* 5 arg words */</span>
		<span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">ptep_modify_prot_commit</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PVOP_VCALL4</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">ptep_modify_prot_commit</span><span class="p">,</span>
			    <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">,</span> <span class="n">pte</span><span class="p">.</span><span class="n">pte</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pte</span><span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">,</span> <span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pte</span><span class="p">,</span> <span class="n">ptep</span><span class="p">,</span>
			    <span class="n">pte</span><span class="p">.</span><span class="n">pte</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pte</span><span class="p">.</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pte</span><span class="p">,</span> <span class="n">ptep</span><span class="p">,</span>
			    <span class="n">pte</span><span class="p">.</span><span class="n">pte</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pte_at</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			      <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">,</span> <span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pteval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="cm">/* 5 arg words */</span>
		<span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pte_at</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PVOP_VCALL4</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pte_at</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">,</span> <span class="n">pte</span><span class="p">.</span><span class="n">pte</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_TRANSPARENT_HUGEPAGE</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pmd_at</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			      <span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">,</span> <span class="n">pmd_t</span> <span class="n">pmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pmdval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="cm">/* 5 arg words */</span>
		<span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pmd_at</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pmdp</span><span class="p">,</span> <span class="n">pmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PVOP_VCALL4</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pmd_at</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pmdp</span><span class="p">,</span>
			    <span class="n">native_pmd_val</span><span class="p">(</span><span class="n">pmd</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pmd</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">,</span> <span class="n">pmd_t</span> <span class="n">pmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmdval_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">native_pmd_val</span><span class="p">(</span><span class="n">pmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pmdval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pmd</span><span class="p">,</span> <span class="n">pmdp</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pmd</span><span class="p">,</span> <span class="n">pmdp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if PAGETABLE_LEVELS &gt;= 3</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pmd_t</span> <span class="nf">__pmd</span><span class="p">(</span><span class="n">pmdval_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmdval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pmdval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE2</span><span class="p">(</span><span class="n">pmdval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">make_pmd</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE1</span><span class="p">(</span><span class="n">pmdval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">make_pmd</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pmd_t</span><span class="p">)</span> <span class="p">{</span> <span class="n">ret</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pmdval_t</span> <span class="nf">pmd_val</span><span class="p">(</span><span class="n">pmd_t</span> <span class="n">pmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmdval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pmdval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">PVOP_CALLEE2</span><span class="p">(</span><span class="n">pmdval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pmd_val</span><span class="p">,</span>
				    <span class="n">pmd</span><span class="p">.</span><span class="n">pmd</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pmd</span><span class="p">.</span><span class="n">pmd</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">PVOP_CALLEE1</span><span class="p">(</span><span class="n">pmdval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pmd_val</span><span class="p">,</span>
				    <span class="n">pmd</span><span class="p">.</span><span class="n">pmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pud</span><span class="p">(</span><span class="n">pud_t</span> <span class="o">*</span><span class="n">pudp</span><span class="p">,</span> <span class="n">pud_t</span> <span class="n">pud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pudval_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">native_pud_val</span><span class="p">(</span><span class="n">pud</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pudval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pud</span><span class="p">,</span> <span class="n">pudp</span><span class="p">,</span>
			    <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pud</span><span class="p">,</span> <span class="n">pudp</span><span class="p">,</span>
			    <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#if PAGETABLE_LEVELS == 4</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pud_t</span> <span class="nf">__pud</span><span class="p">(</span><span class="n">pudval_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pudval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pudval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE2</span><span class="p">(</span><span class="n">pudval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">make_pud</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PVOP_CALLEE1</span><span class="p">(</span><span class="n">pudval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">make_pud</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pud_t</span><span class="p">)</span> <span class="p">{</span> <span class="n">ret</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pudval_t</span> <span class="nf">pud_val</span><span class="p">(</span><span class="n">pud_t</span> <span class="n">pud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pudval_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pudval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">PVOP_CALLEE2</span><span class="p">(</span><span class="n">pudval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pud_val</span><span class="p">,</span>
				    <span class="n">pud</span><span class="p">.</span><span class="n">pud</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pud</span><span class="p">.</span><span class="n">pud</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">PVOP_CALLEE1</span><span class="p">(</span><span class="n">pudval_t</span><span class="p">,</span> <span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pud_val</span><span class="p">,</span>
				    <span class="n">pud</span><span class="p">.</span><span class="n">pud</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pgd</span><span class="p">(</span><span class="n">pgd_t</span> <span class="o">*</span><span class="n">pgdp</span><span class="p">,</span> <span class="n">pgd_t</span> <span class="n">pgd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgdval_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">native_pgd_val</span><span class="p">(</span><span class="n">pgd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pgdval_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pgd</span><span class="p">,</span> <span class="n">pgdp</span><span class="p">,</span>
			    <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pgd</span><span class="p">,</span> <span class="n">pgdp</span><span class="p">,</span>
			    <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pgd_clear</span><span class="p">(</span><span class="n">pgd_t</span> <span class="o">*</span><span class="n">pgdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_pgd</span><span class="p">(</span><span class="n">pgdp</span><span class="p">,</span> <span class="n">__pgd</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pud_clear</span><span class="p">(</span><span class="n">pud_t</span> <span class="o">*</span><span class="n">pudp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_pud</span><span class="p">(</span><span class="n">pudp</span><span class="p">,</span> <span class="n">__pud</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* PAGETABLE_LEVELS == 4 */</span><span class="cp"></span>

<span class="cp">#endif	</span><span class="cm">/* PAGETABLE_LEVELS &gt;= 3 */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_X86_PAE</span>
<span class="cm">/* Special-case pte-setting operations for PAE, which can&#39;t update a</span>
<span class="cm">   64-bit pte atomically */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pte_atomic</span><span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">,</span> <span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_pte_atomic</span><span class="p">,</span> <span class="n">ptep</span><span class="p">,</span>
		    <span class="n">pte</span><span class="p">.</span><span class="n">pte</span><span class="p">,</span> <span class="n">pte</span><span class="p">.</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pte_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			     <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL3</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pte_clear</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmd_clear</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">pmd_clear</span><span class="p">,</span> <span class="n">pmdp</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else  </span><span class="cm">/* !CONFIG_X86_PAE */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pte_atomic</span><span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">,</span> <span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_pte</span><span class="p">(</span><span class="n">ptep</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pte_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			     <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_pte_at</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptep</span><span class="p">,</span> <span class="n">__pte</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmd_clear</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_pmd</span><span class="p">(</span><span class="n">pmdp</span><span class="p">,</span> <span class="n">__pmd</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_X86_PAE */</span><span class="cp"></span>

<span class="cp">#define  __HAVE_ARCH_START_CONTEXT_SWITCH</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_start_context_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">start_context_switch</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_end_context_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_cpu_ops</span><span class="p">.</span><span class="n">end_context_switch</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define  __HAVE_ARCH_ENTER_LAZY_MMU_MODE</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_enter_lazy_mmu_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">lazy_mode</span><span class="p">.</span><span class="n">enter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_leave_lazy_mmu_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL0</span><span class="p">(</span><span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">lazy_mode</span><span class="p">.</span><span class="n">leave</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">arch_flush_lazy_mmu_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__set_fixmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="cm">/* enum fixed_addresses */</span> <span class="n">idx</span><span class="p">,</span>
				<span class="n">phys_addr_t</span> <span class="n">phys</span><span class="p">,</span> <span class="n">pgprot_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pv_mmu_ops</span><span class="p">.</span><span class="n">set_fixmap</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">phys</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SMP) &amp;&amp; defined(CONFIG_PARAVIRT_SPINLOCKS)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">arch_spin_is_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_spinlock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pv_lock_ops</span><span class="p">.</span><span class="n">spin_is_locked</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">arch_spin_is_contended</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_spinlock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pv_lock_ops</span><span class="p">.</span><span class="n">spin_is_contended</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#define arch_spin_is_contended	arch_spin_is_contended</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">arch_spin_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_spinlock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_lock_ops</span><span class="p">.</span><span class="n">spin_lock</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">arch_spin_lock_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_spinlock</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span>
						  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL2</span><span class="p">(</span><span class="n">pv_lock_ops</span><span class="p">.</span><span class="n">spin_lock_flags</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">int</span> <span class="nf">arch_spin_trylock</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_spinlock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALL1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pv_lock_ops</span><span class="p">.</span><span class="n">spin_trylock</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">arch_spin_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">arch_spinlock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALL1</span><span class="p">(</span><span class="n">pv_lock_ops</span><span class="p">.</span><span class="n">spin_unlock</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cp">#define PV_SAVE_REGS &quot;pushl %ecx; pushl %edx;&quot;</span>
<span class="cp">#define PV_RESTORE_REGS &quot;popl %edx; popl %ecx;&quot;</span>

<span class="cm">/* save and restore all caller-save registers, except return value */</span>
<span class="cp">#define PV_SAVE_ALL_CALLER_REGS		&quot;pushl %ecx;&quot;</span>
<span class="cp">#define PV_RESTORE_ALL_CALLER_REGS	&quot;popl  %ecx;&quot;</span>

<span class="cp">#define PV_FLAGS_ARG &quot;0&quot;</span>
<span class="cp">#define PV_EXTRA_CLOBBERS</span>
<span class="cp">#define PV_VEXTRA_CLOBBERS</span>
<span class="cp">#else</span>
<span class="cm">/* save and restore all caller-save registers, except return value */</span>
<span class="cp">#define PV_SAVE_ALL_CALLER_REGS						\</span>
<span class="cp">	&quot;push %rcx;&quot;							\</span>
<span class="cp">	&quot;push %rdx;&quot;							\</span>
<span class="cp">	&quot;push %rsi;&quot;							\</span>
<span class="cp">	&quot;push %rdi;&quot;							\</span>
<span class="cp">	&quot;push %r8;&quot;							\</span>
<span class="cp">	&quot;push %r9;&quot;							\</span>
<span class="cp">	&quot;push %r10;&quot;							\</span>
<span class="cp">	&quot;push %r11;&quot;</span>
<span class="cp">#define PV_RESTORE_ALL_CALLER_REGS					\</span>
<span class="cp">	&quot;pop %r11;&quot;							\</span>
<span class="cp">	&quot;pop %r10;&quot;							\</span>
<span class="cp">	&quot;pop %r9;&quot;							\</span>
<span class="cp">	&quot;pop %r8;&quot;							\</span>
<span class="cp">	&quot;pop %rdi;&quot;							\</span>
<span class="cp">	&quot;pop %rsi;&quot;							\</span>
<span class="cp">	&quot;pop %rdx;&quot;							\</span>
<span class="cp">	&quot;pop %rcx;&quot;</span>

<span class="cm">/* We save some registers, but all of them, that&#39;s too much. We clobber all</span>
<span class="cm"> * caller saved registers but the argument parameter */</span>
<span class="cp">#define PV_SAVE_REGS &quot;pushq %%rdi;&quot;</span>
<span class="cp">#define PV_RESTORE_REGS &quot;popq %%rdi;&quot;</span>
<span class="cp">#define PV_EXTRA_CLOBBERS EXTRA_CLOBBERS, &quot;rcx&quot; , &quot;rdx&quot;, &quot;rsi&quot;</span>
<span class="cp">#define PV_VEXTRA_CLOBBERS EXTRA_CLOBBERS, &quot;rdi&quot;, &quot;rcx&quot; , &quot;rdx&quot;, &quot;rsi&quot;</span>
<span class="cp">#define PV_FLAGS_ARG &quot;D&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Generate a thunk around a function which saves all caller-save</span>
<span class="cm"> * registers except for the return value.  This allows C functions to</span>
<span class="cm"> * be called from assembler code where fewer than normal registers are</span>
<span class="cm"> * available.  It may also help code generation around calls from C</span>
<span class="cm"> * code if the common case doesn&#39;t use many registers.</span>
<span class="cm"> *</span>
<span class="cm"> * When a callee is wrapped in a thunk, the caller can assume that all</span>
<span class="cm"> * arg regs and all scratch registers are preserved across the</span>
<span class="cm"> * call. The return value in rax/eax will not be saved, even for void</span>
<span class="cm"> * functions.</span>
<span class="cm"> */</span>
<span class="cp">#define PV_CALLEE_SAVE_REGS_THUNK(func)					\</span>
<span class="cp">	extern typeof(func) __raw_callee_save_##func;			\</span>
<span class="cp">	static void *__##func##__ __used = func;			\</span>
<span class="cp">									\</span>
<span class="cp">	asm(&quot;.pushsection .text;&quot;					\</span>
<span class="cp">	    &quot;__raw_callee_save_&quot; #func &quot;: &quot;				\</span>
<span class="cp">	    PV_SAVE_ALL_CALLER_REGS					\</span>
<span class="cp">	    &quot;call &quot; #func &quot;;&quot;						\</span>
<span class="cp">	    PV_RESTORE_ALL_CALLER_REGS					\</span>
<span class="cp">	    &quot;ret;&quot;							\</span>
<span class="cp">	    &quot;.popsection&quot;)</span>

<span class="cm">/* Get a reference to a callee-save function */</span>
<span class="cp">#define PV_CALLEE_SAVE(func)						\</span>
<span class="cp">	((struct paravirt_callee_save) { __raw_callee_save_##func })</span>

<span class="cm">/* Promise that &quot;func&quot; already uses the right calling convention */</span>
<span class="cp">#define __PV_IS_CALLEE_SAVE(func)			\</span>
<span class="cp">	((struct paravirt_callee_save) { func })</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">notrace</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">arch_local_save_flags</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PVOP_CALLEE0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">save_fl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">notrace</span> <span class="kt">void</span> <span class="nf">arch_local_irq_restore</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALLEE1</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">restore_fl</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">notrace</span> <span class="kt">void</span> <span class="nf">arch_local_irq_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALLEE0</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">irq_disable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">notrace</span> <span class="kt">void</span> <span class="nf">arch_local_irq_enable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PVOP_VCALLEE0</span><span class="p">(</span><span class="n">pv_irq_ops</span><span class="p">.</span><span class="n">irq_enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">notrace</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">arch_local_irq_save</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">arch_local_save_flags</span><span class="p">();</span>
	<span class="n">arch_local_irq_disable</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">f</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Make sure as little as possible of this mess escapes. */</span>
<span class="cp">#undef PARAVIRT_CALL</span>
<span class="cp">#undef __PVOP_CALL</span>
<span class="cp">#undef __PVOP_VCALL</span>
<span class="cp">#undef PVOP_VCALL0</span>
<span class="cp">#undef PVOP_CALL0</span>
<span class="cp">#undef PVOP_VCALL1</span>
<span class="cp">#undef PVOP_CALL1</span>
<span class="cp">#undef PVOP_VCALL2</span>
<span class="cp">#undef PVOP_CALL2</span>
<span class="cp">#undef PVOP_VCALL3</span>
<span class="cp">#undef PVOP_CALL3</span>
<span class="cp">#undef PVOP_VCALL4</span>
<span class="cp">#undef PVOP_CALL4</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">default_banner</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#else  </span><span class="cm">/* __ASSEMBLY__ */</span><span class="cp"></span>

<span class="cp">#define _PVSITE(ptype, clobbers, ops, word, algn)	\</span>
<span class="cp">771:;						\</span>
<span class="cp">	ops;					\</span>
<span class="cp">772:;						\</span>
<span class="cp">	.pushsection .parainstructions,&quot;a&quot;;	\</span>
<span class="cp">	 .align	algn;				\</span>
<span class="cp">	 word 771b;				\</span>
<span class="cp">	 .byte ptype;				\</span>
<span class="cp">	 .byte 772b-771b;			\</span>
<span class="cp">	 .short clobbers;			\</span>
<span class="cp">	.popsection</span>


<span class="cp">#define COND_PUSH(set, mask, reg)			\</span>
<span class="cp">	.if ((~(set)) &amp; mask); push %reg; .endif</span>
<span class="cp">#define COND_POP(set, mask, reg)			\</span>
<span class="cp">	.if ((~(set)) &amp; mask); pop %reg; .endif</span>

<span class="cp">#ifdef CONFIG_X86_64</span>

<span class="cp">#define PV_SAVE_REGS(set)			\</span>
<span class="cp">	COND_PUSH(set, CLBR_RAX, rax);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_RCX, rcx);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_RDX, rdx);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_RSI, rsi);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_RDI, rdi);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_R8, r8);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_R9, r9);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_R10, r10);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_R11, r11)</span>
<span class="cp">#define PV_RESTORE_REGS(set)			\</span>
<span class="cp">	COND_POP(set, CLBR_R11, r11);		\</span>
<span class="cp">	COND_POP(set, CLBR_R10, r10);		\</span>
<span class="cp">	COND_POP(set, CLBR_R9, r9);		\</span>
<span class="cp">	COND_POP(set, CLBR_R8, r8);		\</span>
<span class="cp">	COND_POP(set, CLBR_RDI, rdi);		\</span>
<span class="cp">	COND_POP(set, CLBR_RSI, rsi);		\</span>
<span class="cp">	COND_POP(set, CLBR_RDX, rdx);		\</span>
<span class="cp">	COND_POP(set, CLBR_RCX, rcx);		\</span>
<span class="cp">	COND_POP(set, CLBR_RAX, rax)</span>

<span class="cp">#define PARA_PATCH(struct, off)        ((PARAVIRT_PATCH_##struct + (off)) / 8)</span>
<span class="cp">#define PARA_SITE(ptype, clobbers, ops) _PVSITE(ptype, clobbers, ops, .quad, 8)</span>
<span class="cp">#define PARA_INDIRECT(addr)	*addr(%rip)</span>
<span class="cp">#else</span>
<span class="cp">#define PV_SAVE_REGS(set)			\</span>
<span class="cp">	COND_PUSH(set, CLBR_EAX, eax);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_EDI, edi);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_ECX, ecx);		\</span>
<span class="cp">	COND_PUSH(set, CLBR_EDX, edx)</span>
<span class="cp">#define PV_RESTORE_REGS(set)			\</span>
<span class="cp">	COND_POP(set, CLBR_EDX, edx);		\</span>
<span class="cp">	COND_POP(set, CLBR_ECX, ecx);		\</span>
<span class="cp">	COND_POP(set, CLBR_EDI, edi);		\</span>
<span class="cp">	COND_POP(set, CLBR_EAX, eax)</span>

<span class="cp">#define PARA_PATCH(struct, off)        ((PARAVIRT_PATCH_##struct + (off)) / 4)</span>
<span class="cp">#define PARA_SITE(ptype, clobbers, ops) _PVSITE(ptype, clobbers, ops, .long, 4)</span>
<span class="cp">#define PARA_INDIRECT(addr)	*%cs:addr</span>
<span class="cp">#endif</span>

<span class="cp">#define INTERRUPT_RETURN						\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_cpu_ops, PV_CPU_iret), CLBR_NONE,	\</span>
<span class="cp">		  jmp PARA_INDIRECT(pv_cpu_ops+PV_CPU_iret))</span>

<span class="cp">#define DISABLE_INTERRUPTS(clobbers)					\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_irq_ops, PV_IRQ_irq_disable), clobbers, \</span>
<span class="cp">		  PV_SAVE_REGS(clobbers | CLBR_CALLEE_SAVE);		\</span>
<span class="cp">		  call PARA_INDIRECT(pv_irq_ops+PV_IRQ_irq_disable);	\</span>
<span class="cp">		  PV_RESTORE_REGS(clobbers | CLBR_CALLEE_SAVE);)</span>

<span class="cp">#define ENABLE_INTERRUPTS(clobbers)					\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_irq_ops, PV_IRQ_irq_enable), clobbers,	\</span>
<span class="cp">		  PV_SAVE_REGS(clobbers | CLBR_CALLEE_SAVE);		\</span>
<span class="cp">		  call PARA_INDIRECT(pv_irq_ops+PV_IRQ_irq_enable);	\</span>
<span class="cp">		  PV_RESTORE_REGS(clobbers | CLBR_CALLEE_SAVE);)</span>

<span class="cp">#define USERGS_SYSRET32							\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_cpu_ops, PV_CPU_usergs_sysret32),	\</span>
<span class="cp">		  CLBR_NONE,						\</span>
<span class="cp">		  jmp PARA_INDIRECT(pv_cpu_ops+PV_CPU_usergs_sysret32))</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cp">#define GET_CR0_INTO_EAX				\</span>
<span class="cp">	push %ecx; push %edx;				\</span>
<span class="cp">	call PARA_INDIRECT(pv_cpu_ops+PV_CPU_read_cr0);	\</span>
<span class="cp">	pop %edx; pop %ecx</span>

<span class="cp">#define ENABLE_INTERRUPTS_SYSEXIT					\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_cpu_ops, PV_CPU_irq_enable_sysexit),	\</span>
<span class="cp">		  CLBR_NONE,						\</span>
<span class="cp">		  jmp PARA_INDIRECT(pv_cpu_ops+PV_CPU_irq_enable_sysexit))</span>


<span class="cp">#else	</span><span class="cm">/* !CONFIG_X86_32 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * If swapgs is used while the userspace stack is still current,</span>
<span class="cm"> * there&#39;s no way to call a pvop.  The PV replacement *must* be</span>
<span class="cm"> * inlined, or the swapgs instruction must be trapped and emulated.</span>
<span class="cm"> */</span>
<span class="cp">#define SWAPGS_UNSAFE_STACK						\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_cpu_ops, PV_CPU_swapgs), CLBR_NONE,	\</span>
<span class="cp">		  swapgs)</span>

<span class="cm">/*</span>
<span class="cm"> * Note: swapgs is very special, and in practise is either going to be</span>
<span class="cm"> * implemented with a single &quot;swapgs&quot; instruction or something very</span>
<span class="cm"> * special.  Either way, we don&#39;t need to save any registers for</span>
<span class="cm"> * it.</span>
<span class="cm"> */</span>
<span class="cp">#define SWAPGS								\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_cpu_ops, PV_CPU_swapgs), CLBR_NONE,	\</span>
<span class="cp">		  call PARA_INDIRECT(pv_cpu_ops+PV_CPU_swapgs)		\</span>
<span class="cp">		 )</span>

<span class="cp">#define GET_CR2_INTO_RAX				\</span>
<span class="cp">	call PARA_INDIRECT(pv_mmu_ops+PV_MMU_read_cr2)</span>

<span class="cp">#define PARAVIRT_ADJUST_EXCEPTION_FRAME					\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_irq_ops, PV_IRQ_adjust_exception_frame), \</span>
<span class="cp">		  CLBR_NONE,						\</span>
<span class="cp">		  call PARA_INDIRECT(pv_irq_ops+PV_IRQ_adjust_exception_frame))</span>

<span class="cp">#define USERGS_SYSRET64							\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_cpu_ops, PV_CPU_usergs_sysret64),	\</span>
<span class="cp">		  CLBR_NONE,						\</span>
<span class="cp">		  jmp PARA_INDIRECT(pv_cpu_ops+PV_CPU_usergs_sysret64))</span>

<span class="cp">#define ENABLE_INTERRUPTS_SYSEXIT32					\</span>
<span class="cp">	PARA_SITE(PARA_PATCH(pv_cpu_ops, PV_CPU_irq_enable_sysexit),	\</span>
<span class="cp">		  CLBR_NONE,						\</span>
<span class="cp">		  jmp PARA_INDIRECT(pv_cpu_ops+PV_CPU_irq_enable_sysexit))</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_X86_32 */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* __ASSEMBLY__ */</span><span class="cp"></span>
<span class="cp">#else  </span><span class="cm">/* CONFIG_PARAVIRT */</span><span class="cp"></span>
<span class="cp"># define default_banner x86_init_noop</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_PARAVIRT */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* _ASM_X86_PARAVIRT_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
