<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › include › asm › xen › hypercall.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>hypercall.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * hypercall.h</span>
<span class="cm"> *</span>
<span class="cm"> * Linux-specific hypervisor handling.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2002-2004, K A Fraser</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation; or, when distributed</span>
<span class="cm"> * separately from the Linux kernel or incorporated into other</span>
<span class="cm"> * software packages, subject to the following license:</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm"> * of this source file (the &quot;Software&quot;), to deal in the Software without</span>
<span class="cm"> * restriction, including without limitation the rights to use, copy, modify,</span>
<span class="cm"> * merge, publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="cm"> * and to permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> * the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm"> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="cm"> * IN THE SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _ASM_X86_XEN_HYPERCALL_H</span>
<span class="cp">#define _ASM_X86_XEN_HYPERCALL_H</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &lt;trace/events/xen.h&gt;</span>

<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>

<span class="cp">#include &lt;xen/interface/xen.h&gt;</span>
<span class="cp">#include &lt;xen/interface/sched.h&gt;</span>
<span class="cp">#include &lt;xen/interface/physdev.h&gt;</span>
<span class="cp">#include &lt;xen/interface/platform.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * The hypercall asms have to meet several constraints:</span>
<span class="cm"> * - Work on 32- and 64-bit.</span>
<span class="cm"> *    The two architectures put their arguments in different sets of</span>
<span class="cm"> *    registers.</span>
<span class="cm"> *</span>
<span class="cm"> * - Work around asm syntax quirks</span>
<span class="cm"> *    It isn&#39;t possible to specify one of the rNN registers in a</span>
<span class="cm"> *    constraint, so we use explicit register variables to get the</span>
<span class="cm"> *    args into the right place.</span>
<span class="cm"> *</span>
<span class="cm"> * - Mark all registers as potentially clobbered</span>
<span class="cm"> *    Even unused parameters can be clobbered by the hypervisor, so we</span>
<span class="cm"> *    need to make sure gcc knows it.</span>
<span class="cm"> *</span>
<span class="cm"> * - Avoid compiler bugs.</span>
<span class="cm"> *    This is the tricky part.  Because x86_32 has such a constrained</span>
<span class="cm"> *    register set, gcc versions below 4.3 have trouble generating</span>
<span class="cm"> *    code when all the arg registers and memory are trashed by the</span>
<span class="cm"> *    asm.  There are syntactically simpler ways of achieving the</span>
<span class="cm"> *    semantics below, but they cause the compiler to crash.</span>
<span class="cm"> *</span>
<span class="cm"> *    The only combination I found which works is:</span>
<span class="cm"> *     - assign the __argX variables first</span>
<span class="cm"> *     - list all actually used parameters as &quot;+r&quot; (__argX)</span>
<span class="cm"> *     - clobber the rest</span>
<span class="cm"> *</span>
<span class="cm"> * The result certainly isn&#39;t pretty, and it really shows up cpp&#39;s</span>
<span class="cm"> * weakness as as macro language.  Sorry.  (But let&#39;s just give thanks</span>
<span class="cm"> * there aren&#39;t more than 5 arguments...)</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">char</span> <span class="n">_entry</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="p">}</span> <span class="n">hypercall_page</span><span class="p">[];</span>

<span class="cp">#define __HYPERCALL		&quot;call hypercall_page+%c[offset]&quot;</span>
<span class="cp">#define __HYPERCALL_ENTRY(x)						\</span>
<span class="cp">	[offset] &quot;i&quot; (__HYPERVISOR_##x * sizeof(hypercall_page[0]))</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="cp">#define __HYPERCALL_RETREG	&quot;eax&quot;</span>
<span class="cp">#define __HYPERCALL_ARG1REG	&quot;ebx&quot;</span>
<span class="cp">#define __HYPERCALL_ARG2REG	&quot;ecx&quot;</span>
<span class="cp">#define __HYPERCALL_ARG3REG	&quot;edx&quot;</span>
<span class="cp">#define __HYPERCALL_ARG4REG	&quot;esi&quot;</span>
<span class="cp">#define __HYPERCALL_ARG5REG	&quot;edi&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define __HYPERCALL_RETREG	&quot;rax&quot;</span>
<span class="cp">#define __HYPERCALL_ARG1REG	&quot;rdi&quot;</span>
<span class="cp">#define __HYPERCALL_ARG2REG	&quot;rsi&quot;</span>
<span class="cp">#define __HYPERCALL_ARG3REG	&quot;rdx&quot;</span>
<span class="cp">#define __HYPERCALL_ARG4REG	&quot;r10&quot;</span>
<span class="cp">#define __HYPERCALL_ARG5REG	&quot;r8&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#define __HYPERCALL_DECLS						\</span>
<span class="cp">	register unsigned long __res  asm(__HYPERCALL_RETREG);		\</span>
<span class="cp">	register unsigned long __arg1 asm(__HYPERCALL_ARG1REG) = __arg1; \</span>
<span class="cp">	register unsigned long __arg2 asm(__HYPERCALL_ARG2REG) = __arg2; \</span>
<span class="cp">	register unsigned long __arg3 asm(__HYPERCALL_ARG3REG) = __arg3; \</span>
<span class="cp">	register unsigned long __arg4 asm(__HYPERCALL_ARG4REG) = __arg4; \</span>
<span class="cp">	register unsigned long __arg5 asm(__HYPERCALL_ARG5REG) = __arg5;</span>

<span class="cp">#define __HYPERCALL_0PARAM	&quot;=r&quot; (__res)</span>
<span class="cp">#define __HYPERCALL_1PARAM	__HYPERCALL_0PARAM, &quot;+r&quot; (__arg1)</span>
<span class="cp">#define __HYPERCALL_2PARAM	__HYPERCALL_1PARAM, &quot;+r&quot; (__arg2)</span>
<span class="cp">#define __HYPERCALL_3PARAM	__HYPERCALL_2PARAM, &quot;+r&quot; (__arg3)</span>
<span class="cp">#define __HYPERCALL_4PARAM	__HYPERCALL_3PARAM, &quot;+r&quot; (__arg4)</span>
<span class="cp">#define __HYPERCALL_5PARAM	__HYPERCALL_4PARAM, &quot;+r&quot; (__arg5)</span>

<span class="cp">#define __HYPERCALL_0ARG()</span>
<span class="cp">#define __HYPERCALL_1ARG(a1)						\</span>
<span class="cp">	__HYPERCALL_0ARG()		__arg1 = (unsigned long)(a1);</span>
<span class="cp">#define __HYPERCALL_2ARG(a1,a2)						\</span>
<span class="cp">	__HYPERCALL_1ARG(a1)		__arg2 = (unsigned long)(a2);</span>
<span class="cp">#define __HYPERCALL_3ARG(a1,a2,a3)					\</span>
<span class="cp">	__HYPERCALL_2ARG(a1,a2)		__arg3 = (unsigned long)(a3);</span>
<span class="cp">#define __HYPERCALL_4ARG(a1,a2,a3,a4)					\</span>
<span class="cp">	__HYPERCALL_3ARG(a1,a2,a3)	__arg4 = (unsigned long)(a4);</span>
<span class="cp">#define __HYPERCALL_5ARG(a1,a2,a3,a4,a5)				\</span>
<span class="cp">	__HYPERCALL_4ARG(a1,a2,a3,a4)	__arg5 = (unsigned long)(a5);</span>

<span class="cp">#define __HYPERCALL_CLOBBER5	&quot;memory&quot;</span>
<span class="cp">#define __HYPERCALL_CLOBBER4	__HYPERCALL_CLOBBER5, __HYPERCALL_ARG5REG</span>
<span class="cp">#define __HYPERCALL_CLOBBER3	__HYPERCALL_CLOBBER4, __HYPERCALL_ARG4REG</span>
<span class="cp">#define __HYPERCALL_CLOBBER2	__HYPERCALL_CLOBBER3, __HYPERCALL_ARG3REG</span>
<span class="cp">#define __HYPERCALL_CLOBBER1	__HYPERCALL_CLOBBER2, __HYPERCALL_ARG2REG</span>
<span class="cp">#define __HYPERCALL_CLOBBER0	__HYPERCALL_CLOBBER1, __HYPERCALL_ARG1REG</span>

<span class="cp">#define _hypercall0(type, name)						\</span>
<span class="cp">({									\</span>
<span class="cp">	__HYPERCALL_DECLS;						\</span>
<span class="cp">	__HYPERCALL_0ARG();						\</span>
<span class="cp">	asm volatile (__HYPERCALL					\</span>
<span class="cp">		      : __HYPERCALL_0PARAM				\</span>
<span class="cp">		      : __HYPERCALL_ENTRY(name)				\</span>
<span class="cp">		      : __HYPERCALL_CLOBBER0);				\</span>
<span class="cp">	(type)__res;							\</span>
<span class="cp">})</span>

<span class="cp">#define _hypercall1(type, name, a1)					\</span>
<span class="cp">({									\</span>
<span class="cp">	__HYPERCALL_DECLS;						\</span>
<span class="cp">	__HYPERCALL_1ARG(a1);						\</span>
<span class="cp">	asm volatile (__HYPERCALL					\</span>
<span class="cp">		      : __HYPERCALL_1PARAM				\</span>
<span class="cp">		      : __HYPERCALL_ENTRY(name)				\</span>
<span class="cp">		      : __HYPERCALL_CLOBBER1);				\</span>
<span class="cp">	(type)__res;							\</span>
<span class="cp">})</span>

<span class="cp">#define _hypercall2(type, name, a1, a2)					\</span>
<span class="cp">({									\</span>
<span class="cp">	__HYPERCALL_DECLS;						\</span>
<span class="cp">	__HYPERCALL_2ARG(a1, a2);					\</span>
<span class="cp">	asm volatile (__HYPERCALL					\</span>
<span class="cp">		      : __HYPERCALL_2PARAM				\</span>
<span class="cp">		      : __HYPERCALL_ENTRY(name)				\</span>
<span class="cp">		      : __HYPERCALL_CLOBBER2);				\</span>
<span class="cp">	(type)__res;							\</span>
<span class="cp">})</span>

<span class="cp">#define _hypercall3(type, name, a1, a2, a3)				\</span>
<span class="cp">({									\</span>
<span class="cp">	__HYPERCALL_DECLS;						\</span>
<span class="cp">	__HYPERCALL_3ARG(a1, a2, a3);					\</span>
<span class="cp">	asm volatile (__HYPERCALL					\</span>
<span class="cp">		      : __HYPERCALL_3PARAM				\</span>
<span class="cp">		      : __HYPERCALL_ENTRY(name)				\</span>
<span class="cp">		      : __HYPERCALL_CLOBBER3);				\</span>
<span class="cp">	(type)__res;							\</span>
<span class="cp">})</span>

<span class="cp">#define _hypercall4(type, name, a1, a2, a3, a4)				\</span>
<span class="cp">({									\</span>
<span class="cp">	__HYPERCALL_DECLS;						\</span>
<span class="cp">	__HYPERCALL_4ARG(a1, a2, a3, a4);				\</span>
<span class="cp">	asm volatile (__HYPERCALL					\</span>
<span class="cp">		      : __HYPERCALL_4PARAM				\</span>
<span class="cp">		      : __HYPERCALL_ENTRY(name)				\</span>
<span class="cp">		      : __HYPERCALL_CLOBBER4);				\</span>
<span class="cp">	(type)__res;							\</span>
<span class="cp">})</span>

<span class="cp">#define _hypercall5(type, name, a1, a2, a3, a4, a5)			\</span>
<span class="cp">({									\</span>
<span class="cp">	__HYPERCALL_DECLS;						\</span>
<span class="cp">	__HYPERCALL_5ARG(a1, a2, a3, a4, a5);				\</span>
<span class="cp">	asm volatile (__HYPERCALL					\</span>
<span class="cp">		      : __HYPERCALL_5PARAM				\</span>
<span class="cp">		      : __HYPERCALL_ENTRY(name)				\</span>
<span class="cp">		      : __HYPERCALL_CLOBBER5);				\</span>
<span class="cp">	(type)__res;							\</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">privcmd_call</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">call</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a2</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a3</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a4</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a5</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__HYPERCALL_DECLS</span><span class="p">;</span>
	<span class="n">__HYPERCALL_5ARG</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">);</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;call *%[call]&quot;</span>
		     <span class="o">:</span> <span class="n">__HYPERCALL_5PARAM</span>
		     <span class="o">:</span> <span class="p">[</span><span class="n">call</span><span class="p">]</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hypercall_page</span><span class="p">[</span><span class="n">call</span><span class="p">])</span>
		     <span class="o">:</span> <span class="n">__HYPERCALL_CLOBBER5</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">__res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_set_trap_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_info</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">set_trap_table</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_mmu_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmu_update</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="o">*</span><span class="n">success_count</span><span class="p">,</span> <span class="n">domid_t</span> <span class="n">domid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall4</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">mmu_update</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">success_count</span><span class="p">,</span> <span class="n">domid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_mmuext_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmuext_op</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="o">*</span><span class="n">success_count</span><span class="p">,</span> <span class="n">domid_t</span> <span class="n">domid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall4</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">mmuext_op</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">success_count</span><span class="p">,</span> <span class="n">domid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_set_gdt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">frame_list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">set_gdt</span><span class="p">,</span> <span class="n">frame_list</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_stack_switch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ss</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">stack_switch</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">esp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_32</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_set_callbacks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event_selector</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event_address</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">failsafe_selector</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">failsafe_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall4</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">set_callbacks</span><span class="p">,</span>
			   <span class="n">event_selector</span><span class="p">,</span> <span class="n">event_address</span><span class="p">,</span>
			   <span class="n">failsafe_selector</span><span class="p">,</span> <span class="n">failsafe_address</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else  </span><span class="cm">/* CONFIG_X86_64 */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_set_callbacks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event_address</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">failsafe_address</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">syscall_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">set_callbacks</span><span class="p">,</span>
			   <span class="n">event_address</span><span class="p">,</span> <span class="n">failsafe_address</span><span class="p">,</span>
			   <span class="n">syscall_address</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="cm">/* CONFIG_X86_{32,64} */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_callback_op</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">callback_op</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_fpu_taskswitch</span><span class="p">(</span><span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">fpu_taskswitch</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_sched_op</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">sched_op</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">HYPERVISOR_set_timer_op</span><span class="p">(</span><span class="n">u64</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_hi</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">timeout</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_lo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">timeout</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">long</span><span class="p">,</span> <span class="n">set_timer_op</span><span class="p">,</span> <span class="n">timeout_lo</span><span class="p">,</span> <span class="n">timeout_hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_dom0_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">xen_platform_op</span> <span class="o">*</span><span class="n">platform_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_op</span><span class="o">-&gt;</span><span class="n">interface_version</span> <span class="o">=</span> <span class="n">XENPF_INTERFACE_VERSION</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">_hypercall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">dom0_op</span><span class="p">,</span> <span class="n">platform_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_set_debugreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">set_debugreg</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">HYPERVISOR_get_debugreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">get_debugreg</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_update_descriptor</span><span class="p">(</span><span class="n">u64</span> <span class="n">ma</span><span class="p">,</span> <span class="n">u64</span> <span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">update_descriptor</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_hypercall4</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">update_descriptor</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">ma</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">desc</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_memory_op</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">memory_op</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_multicall</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">call_list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_calls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">multicall</span><span class="p">,</span> <span class="n">call_list</span><span class="p">,</span> <span class="n">nr_calls</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_update_va_mapping</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span><span class="p">,</span> <span class="n">pte_t</span> <span class="n">new_val</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">_hypercall3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">update_va_mapping</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span>
				   <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">_hypercall4</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">update_va_mapping</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span>
				   <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span><span class="p">,</span> <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_event_channel_op</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">event_channel_op</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">evtchn_op</span> <span class="n">op</span><span class="p">;</span>
		<span class="n">op</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">_hypercall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">event_channel_op_compat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_xen_version</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">xen_version</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_console_io</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">console_io</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">physdev_op</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">physdev_op</span> <span class="n">op</span><span class="p">;</span>
		<span class="n">op</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">_hypercall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">physdev_op_compat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">u</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_grant_table_op</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">uop</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">grant_table_op</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">uop</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_update_va_mapping_otherdomain</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span><span class="p">,</span> <span class="n">pte_t</span> <span class="n">new_val</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">domid_t</span> <span class="n">domid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">_hypercall4</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">update_va_mapping_otherdomain</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span>
				   <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">domid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">_hypercall5</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">update_va_mapping_otherdomain</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span>
				   <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span><span class="p">,</span> <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
				   <span class="n">flags</span><span class="p">,</span> <span class="n">domid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_vm_assist</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">vm_assist</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_vcpu_op</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vcpuid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">extra_args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">vcpu_op</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">vcpuid</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86_64</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_set_segment_base</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">set_segment_base</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_suspend</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_info_mfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sched_shutdown</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">SHUTDOWN_suspend</span> <span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * For a PV guest the tools require that the start_info mfn be</span>
<span class="cm">	 * present in rdx/edx when the hypercall is made. Per the</span>
<span class="cm">	 * hypercall calling convention this is the third hypercall</span>
<span class="cm">	 * argument, which is start_info_mfn here.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">_hypercall3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">sched_op</span><span class="p">,</span> <span class="n">SCHEDOP_shutdown</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">start_info_mfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_nmi_op</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">nmi_op</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__must_check</span>
<span class="nf">HYPERVISOR_hvm_op</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
       <span class="k">return</span> <span class="n">_hypercall2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">hvm_op</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">HYPERVISOR_tmem_op</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">tmem_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_hypercall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">tmem_op</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_fpu_taskswitch</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_fpu_taskswitch</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_update_va_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span><span class="p">,</span>
			<span class="n">pte_t</span> <span class="n">new_val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_update_va_mapping</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_grant_table_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">uop</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_grant_table_op</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">uop</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_update_va_mapping_otherdomain</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span><span class="p">,</span>
				    <span class="n">pte_t</span> <span class="n">new_val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span>
				    <span class="n">domid_t</span> <span class="n">domid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_update_va_mapping_otherdomain</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">domid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">.</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">domid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_update_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="n">u64</span> <span class="n">maddr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_update_descriptor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">maddr</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">maddr</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">maddr</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">maddr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
		<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">maddr</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_memory_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_memory_op</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_mmu_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmu_update</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">success_count</span><span class="p">,</span> <span class="n">domid_t</span> <span class="n">domid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_mmu_update</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">req</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">success_count</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">domid</span><span class="p">;</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_mmuext_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmuext_op</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">success_count</span><span class="p">,</span> <span class="n">domid_t</span> <span class="n">domid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_mmuext_op</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">op</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">success_count</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">domid</span><span class="p">;</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_set_gdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">frames</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_set_gdt</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">frames</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">MULTI_stack_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">multicall_entry</span> <span class="o">*</span><span class="n">mcl</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ss</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">__HYPERVISOR_stack_switch</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="p">;</span>
	<span class="n">mcl</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">esp</span><span class="p">;</span>

	<span class="n">trace_xen_mc_entry</span><span class="p">(</span><span class="n">mcl</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* _ASM_X86_XEN_HYPERCALL_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
