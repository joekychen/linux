<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › include › asm › switch_to.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>switch_to.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_X86_SWITCH_TO_H</span>
<span class="cp">#define _ASM_X86_SWITCH_TO_H</span>

<span class="k">struct</span> <span class="n">task_struct</span><span class="p">;</span> <span class="cm">/* one of the stranger aspects of C forward declarations */</span>
<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">__switch_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">next</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">tss_struct</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">__switch_to_xtra</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">prev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">next_p</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">tss_struct</span> <span class="o">*</span><span class="n">tss</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_X86_32</span>

<span class="cp">#ifdef CONFIG_CC_STACKPROTECTOR</span>
<span class="cp">#define __switch_canary							\</span>
<span class="cp">	&quot;movl %P[task_canary](%[next]), %%ebx\n\t&quot;			\</span>
<span class="cp">	&quot;movl %%ebx, &quot;__percpu_arg([stack_canary])&quot;\n\t&quot;</span>
<span class="cp">#define __switch_canary_oparam						\</span>
<span class="cp">	, [stack_canary] &quot;=m&quot; (stack_canary.canary)</span>
<span class="cp">#define __switch_canary_iparam						\</span>
<span class="cp">	, [task_canary] &quot;i&quot; (offsetof(struct task_struct, stack_canary))</span>
<span class="cp">#else	</span><span class="cm">/* CC_STACKPROTECTOR */</span><span class="cp"></span>
<span class="cp">#define __switch_canary</span>
<span class="cp">#define __switch_canary_oparam</span>
<span class="cp">#define __switch_canary_iparam</span>
<span class="cp">#endif	</span><span class="cm">/* CC_STACKPROTECTOR */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Saving eflags is important. It switches not only IOPL between tasks,</span>
<span class="cm"> * it also protects other tasks from NT leaking through sysenter etc.</span>
<span class="cm"> */</span>
<span class="cp">#define switch_to(prev, next, last)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	</span><span class="cm">/*								\</span>
<span class="cm">	 * Context-switching clobbers all registers, so we clobber	\</span>
<span class="cm">	 * them explicitly, via unused output variables.		\</span>
<span class="cm">	 * (EAX and EBP is not listed because EBP is saved/restored	\</span>
<span class="cm">	 * explicitly for wchan access and EAX is the return value of	\</span>
<span class="cm">	 * __switch_to())						\</span>
<span class="cm">	 */</span><span class="cp">								\</span>
<span class="cp">	unsigned long ebx, ecx, edx, esi, edi;				\</span>
<span class="cp">									\</span>
<span class="cp">	asm volatile(&quot;pushfl\n\t&quot;		</span><span class="cm">/* save    flags */</span><span class="cp">	\</span>
<span class="cp">		     &quot;pushl %%ebp\n\t&quot;		</span><span class="cm">/* save    EBP   */</span><span class="cp">	\</span>
<span class="cp">		     &quot;movl %%esp,%[prev_sp]\n\t&quot;	</span><span class="cm">/* save    ESP   */</span><span class="cp"> \</span>
<span class="cp">		     &quot;movl %[next_sp],%%esp\n\t&quot;	</span><span class="cm">/* restore ESP   */</span><span class="cp"> \</span>
<span class="cp">		     &quot;movl $1f,%[prev_ip]\n\t&quot;	</span><span class="cm">/* save    EIP   */</span><span class="cp">	\</span>
<span class="cp">		     &quot;pushl %[next_ip]\n\t&quot;	</span><span class="cm">/* restore EIP   */</span><span class="cp">	\</span>
<span class="cp">		     __switch_canary					\</span>
<span class="cp">		     &quot;jmp __switch_to\n&quot;	</span><span class="cm">/* regparm call  */</span><span class="cp">	\</span>
<span class="cp">		     &quot;1:\t&quot;						\</span>
<span class="cp">		     &quot;popl %%ebp\n\t&quot;		</span><span class="cm">/* restore EBP   */</span><span class="cp">	\</span>
<span class="cp">		     &quot;popfl\n&quot;			</span><span class="cm">/* restore flags */</span><span class="cp">	\</span>
<span class="cp">									\</span>
<span class="cp">		     </span><span class="cm">/* output parameters */</span><span class="cp">				\</span>
<span class="cp">		     : [prev_sp] &quot;=m&quot; (prev-&gt;thread.sp),		\</span>
<span class="cp">		       [prev_ip] &quot;=m&quot; (prev-&gt;thread.ip),		\</span>
<span class="cp">		       &quot;=a&quot; (last),					\</span>
<span class="cp">									\</span>
<span class="cp">		       </span><span class="cm">/* clobbered output registers: */</span><span class="cp">		\</span>
<span class="cp">		       &quot;=b&quot; (ebx), &quot;=c&quot; (ecx), &quot;=d&quot; (edx),		\</span>
<span class="cp">		       &quot;=S&quot; (esi), &quot;=D&quot; (edi)				\</span>
<span class="cp">		       							\</span>
<span class="cp">		       __switch_canary_oparam				\</span>
<span class="cp">									\</span>
<span class="cp">		       </span><span class="cm">/* input parameters: */</span><span class="cp">				\</span>
<span class="cp">		     : [next_sp]  &quot;m&quot; (next-&gt;thread.sp),		\</span>
<span class="cp">		       [next_ip]  &quot;m&quot; (next-&gt;thread.ip),		\</span>
<span class="cp">		       							\</span>
<span class="cp">		       </span><span class="cm">/* regparm parameters for __switch_to(): */</span><span class="cp">	\</span>
<span class="cp">		       [prev]     &quot;a&quot; (prev),				\</span>
<span class="cp">		       [next]     &quot;d&quot; (next)				\</span>
<span class="cp">									\</span>
<span class="cp">		       __switch_canary_iparam				\</span>
<span class="cp">									\</span>
<span class="cp">		     : </span><span class="cm">/* reloaded segment registers */</span><span class="cp">			\</span>
<span class="cp">			&quot;memory&quot;);					\</span>
<span class="cp">} while (0)</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_X86_32 */</span><span class="cp"></span>

<span class="cm">/* frame pointer must be last for get_wchan */</span>
<span class="cp">#define SAVE_CONTEXT    &quot;pushf ; pushq %%rbp ; movq %%rsi,%%rbp\n\t&quot;</span>
<span class="cp">#define RESTORE_CONTEXT &quot;movq %%rbp,%%rsi ; popq %%rbp ; popf\t&quot;</span>

<span class="cp">#define __EXTRA_CLOBBER  \</span>
<span class="cp">	, &quot;rcx&quot;, &quot;rbx&quot;, &quot;rdx&quot;, &quot;r8&quot;, &quot;r9&quot;, &quot;r10&quot;, &quot;r11&quot;, \</span>
<span class="cp">	  &quot;r12&quot;, &quot;r13&quot;, &quot;r14&quot;, &quot;r15&quot;</span>

<span class="cp">#ifdef CONFIG_CC_STACKPROTECTOR</span>
<span class="cp">#define __switch_canary							  \</span>
<span class="cp">	&quot;movq %P[task_canary](%%rsi),%%r8\n\t&quot;				  \</span>
<span class="cp">	&quot;movq %%r8,&quot;__percpu_arg([gs_canary])&quot;\n\t&quot;</span>
<span class="cp">#define __switch_canary_oparam						  \</span>
<span class="cp">	, [gs_canary] &quot;=m&quot; (irq_stack_union.stack_canary)</span>
<span class="cp">#define __switch_canary_iparam						  \</span>
<span class="cp">	, [task_canary] &quot;i&quot; (offsetof(struct task_struct, stack_canary))</span>
<span class="cp">#else	</span><span class="cm">/* CC_STACKPROTECTOR */</span><span class="cp"></span>
<span class="cp">#define __switch_canary</span>
<span class="cp">#define __switch_canary_oparam</span>
<span class="cp">#define __switch_canary_iparam</span>
<span class="cp">#endif	</span><span class="cm">/* CC_STACKPROTECTOR */</span><span class="cp"></span>

<span class="cm">/* Save restore flags to clear handle leaking NT */</span>
<span class="cp">#define switch_to(prev, next, last) \</span>
<span class="cp">	asm volatile(SAVE_CONTEXT					  \</span>
<span class="cp">	     &quot;movq %%rsp,%P[threadrsp](%[prev])\n\t&quot; </span><span class="cm">/* save RSP */</span><span class="cp">	  \</span>
<span class="cp">	     &quot;movq %P[threadrsp](%[next]),%%rsp\n\t&quot; </span><span class="cm">/* restore RSP */</span><span class="cp">	  \</span>
<span class="cp">	     &quot;call __switch_to\n\t&quot;					  \</span>
<span class="cp">	     &quot;movq &quot;__percpu_arg([current_task])&quot;,%%rsi\n\t&quot;		  \</span>
<span class="cp">	     __switch_canary						  \</span>
<span class="cp">	     &quot;movq %P[thread_info](%%rsi),%%r8\n\t&quot;			  \</span>
<span class="cp">	     &quot;movq %%rax,%%rdi\n\t&quot; 					  \</span>
<span class="cp">	     &quot;testl  %[_tif_fork],%P[ti_flags](%%r8)\n\t&quot;		  \</span>
<span class="cp">	     &quot;jnz   ret_from_fork\n\t&quot;					  \</span>
<span class="cp">	     RESTORE_CONTEXT						  \</span>
<span class="cp">	     : &quot;=a&quot; (last)					  	  \</span>
<span class="cp">	       __switch_canary_oparam					  \</span>
<span class="cp">	     : [next] &quot;S&quot; (next), [prev] &quot;D&quot; (prev),			  \</span>
<span class="cp">	       [threadrsp] &quot;i&quot; (offsetof(struct task_struct, thread.sp)), \</span>
<span class="cp">	       [ti_flags] &quot;i&quot; (offsetof(struct thread_info, flags)),	  \</span>
<span class="cp">	       [_tif_fork] &quot;i&quot; (_TIF_FORK),			  	  \</span>
<span class="cp">	       [thread_info] &quot;i&quot; (offsetof(struct task_struct, stack)),   \</span>
<span class="cp">	       [current_task] &quot;m&quot; (current_task)			  \</span>
<span class="cp">	       __switch_canary_iparam					  \</span>
<span class="cp">	     : &quot;memory&quot;, &quot;cc&quot; __EXTRA_CLOBBER)</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_32 */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _ASM_X86_SWITCH_TO_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
