<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › platform › olpc › olpc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>olpc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Support for the OLPC DCON and OLPC EC access</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2006  Advanced Micro Devices, Inc.</span>
<span class="cm"> * Copyright © 2007-2008  Andres Salomon &lt;dilinger@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;asm/geode.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/olpc.h&gt;</span>
<span class="cp">#include &lt;asm/olpc_ofw.h&gt;</span>

<span class="k">struct</span> <span class="n">olpc_platform_t</span> <span class="n">olpc_platform_info</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">olpc_platform_info</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ec_lock</span><span class="p">);</span>

<span class="cm">/* debugfs interface to EC commands */</span>
<span class="cp">#define EC_MAX_CMD_ARGS (5 + 1)	</span><span class="cm">/* cmd byte + 5 args */</span><span class="cp"></span>
<span class="cp">#define EC_MAX_CMD_REPLY (8)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ec_debugfs_dir</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ec_debugfs_cmd_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="n">EC_MAX_CMD_REPLY</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ec_debugfs_resp_bytes</span><span class="p">;</span>

<span class="cm">/* EC event mask to be applied during suspend (defining wakeup sources). */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">ec_wakeup_mask</span><span class="p">;</span>

<span class="cm">/* what the timeout *should* be (in ms) */</span>
<span class="cp">#define EC_BASE_TIMEOUT 20</span>

<span class="cm">/* the timeout that bugs in the EC might force us to actually use */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ec_timeout</span> <span class="o">=</span> <span class="n">EC_BASE_TIMEOUT</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">olpc_ec_timeout_set</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec_timeout</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ec_timeout</span> <span class="o">=</span> <span class="n">EC_BASE_TIMEOUT</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;olpc-ec:  invalid argument to &quot;</span>
				<span class="s">&quot;&#39;olpc_ec_timeout=&#39;, ignoring!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;olpc-ec:  using %d ms delay for EC commands.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ec_timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;olpc_ec_timeout=&quot;</span><span class="p">,</span> <span class="n">olpc_ec_timeout_set</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * These {i,o}bf_status functions return whether the buffers are full or not.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ibf_status</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">obf_status</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define wait_on_ibf(p, d) __wait_on_ibf(__LINE__, (p), (d))</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__wait_on_ibf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">desired</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">ibf_status</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">timeo</span> <span class="o">=</span> <span class="n">ec_timeout</span><span class="p">;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">desired</span> <span class="o">&amp;&amp;</span> <span class="n">timeo</span><span class="p">;</span> <span class="n">timeo</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">ibf_status</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">==</span> <span class="n">desired</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ec_timeout</span> <span class="o">&gt;</span> <span class="n">EC_BASE_TIMEOUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">timeo</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ec_timeout</span> <span class="o">-</span> <span class="n">EC_BASE_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;olpc-ec:  %d: waited %u ms for IBF!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">line</span><span class="p">,</span> <span class="n">ec_timeout</span> <span class="o">-</span> <span class="n">timeo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">desired</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define wait_on_obf(p, d) __wait_on_obf(__LINE__, (p), (d))</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__wait_on_obf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">desired</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">obf_status</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">timeo</span> <span class="o">=</span> <span class="n">ec_timeout</span><span class="p">;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">desired</span> <span class="o">&amp;&amp;</span> <span class="n">timeo</span><span class="p">;</span> <span class="n">timeo</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">obf_status</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">==</span> <span class="n">desired</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ec_timeout</span> <span class="o">&gt;</span> <span class="n">EC_BASE_TIMEOUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">timeo</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ec_timeout</span> <span class="o">-</span> <span class="n">EC_BASE_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;olpc-ec:  %d: waited %u ms for OBF!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">line</span><span class="p">,</span> <span class="n">ec_timeout</span> <span class="o">-</span> <span class="n">timeo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">desired</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This allows the kernel to run Embedded Controller commands.  The EC is</span>
<span class="cm"> * documented at &lt;http://wiki.laptop.org/go/Embedded_controller&gt;, and the</span>
<span class="cm"> * available EC commands are here:</span>
<span class="cm"> * &lt;http://wiki.laptop.org/go/Ec_specification&gt;.  Unfortunately, while</span>
<span class="cm"> * OpenFirmware&#39;s source is available, the EC&#39;s is not.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">olpc_ec_cmd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">inlen</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outbuf</span><span class="p">,</span>  <span class="kt">size_t</span> <span class="n">outlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">restarts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Clear OBF */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">obf_status</span><span class="p">(</span><span class="mh">0x6c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">inb</span><span class="p">(</span><span class="mh">0x68</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;olpc-ec:  timeout while attempting to &quot;</span>
				<span class="s">&quot;clear OBF flag!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_on_ibf</span><span class="p">(</span><span class="mh">0x6c</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;olpc-ec:  timeout waiting for EC to &quot;</span>
				<span class="s">&quot;quiesce!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">restart:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note that if we time out during any IBF checks, that&#39;s a failure;</span>
<span class="cm">	 * we have to return.  There&#39;s no way for the kernel to clear that.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we time out during an OBF check, we can restart the command;</span>
<span class="cm">	 * reissuing it will clear the OBF flag, and we should be alright.</span>
<span class="cm">	 * The OBF flag will sometimes misbehave due to what we believe</span>
<span class="cm">	 * is a hardware quirk..</span>
<span class="cm">	 */</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;olpc-ec:  running cmd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_on_ibf</span><span class="p">(</span><span class="mh">0x6c</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;olpc-ec:  timeout waiting for EC to read &quot;</span>
				<span class="s">&quot;command!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inbuf</span> <span class="o">&amp;&amp;</span> <span class="n">inlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write data to EC */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;olpc-ec:  sending cmd arg 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">inbuf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x68</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_on_ibf</span><span class="p">(</span><span class="mh">0x6c</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;olpc-ec:  timeout waiting for&quot;</span>
						<span class="s">&quot; EC accept data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbuf</span> <span class="o">&amp;&amp;</span> <span class="n">outlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read data from EC */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">outlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_on_obf</span><span class="p">(</span><span class="mh">0x6c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;olpc-ec:  timeout waiting for&quot;</span>
						<span class="s">&quot; EC to provide data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">restarts</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x68</span><span class="p">);</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;olpc-ec:  received 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">outbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">olpc_ec_cmd</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">olpc_ec_wakeup_set</span><span class="p">(</span><span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ec_wakeup_mask</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">olpc_ec_wakeup_set</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">olpc_ec_wakeup_clear</span><span class="p">(</span><span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ec_wakeup_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">olpc_ec_wakeup_clear</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Returns true if the compile and runtime configurations allow for EC events</span>
<span class="cm"> * to wake the system.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">olpc_ec_wakeup_available</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is_olpc</span><span class="p">())</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * XO-1 EC wakeups are available when olpc-xo1-sci driver is</span>
<span class="cm">	 * compiled in</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_OLPC_XO1_SCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">boardrev</span> <span class="o">&lt;</span> <span class="n">olpc_board_pre</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">))</span> <span class="cm">/* XO-1 */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * XO-1.5 EC wakeups are available when olpc-xo15-sci driver is</span>
<span class="cm">	 * compiled in</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_OLPC_XO15_SCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">boardrev</span> <span class="o">&gt;=</span> <span class="n">olpc_board_pre</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">))</span> <span class="cm">/* XO-1.5 */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">olpc_ec_wakeup_available</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">olpc_ec_mask_write</span><span class="p">(</span><span class="n">u16</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OLPC_F_EC_WIDE_SCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be16</span> <span class="n">ec_word</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">bits</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">olpc_ec_cmd</span><span class="p">(</span><span class="n">EC_WRITE_EXT_SCI_MASK</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ec_word</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ec_byte</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">olpc_ec_cmd</span><span class="p">(</span><span class="n">EC_WRITE_SCI_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec_byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">olpc_ec_mask_write</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">olpc_ec_sci_query</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">sci_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OLPC_F_EC_WIDE_SCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be16</span> <span class="n">ec_word</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">olpc_ec_cmd</span><span class="p">(</span><span class="n">EC_EXT_SCI_QUERY</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ec_word</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">sci_value</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ec_word</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ec_byte</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">olpc_ec_cmd</span><span class="p">(</span><span class="n">EC_SCI_QUERY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec_byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">sci_value</span> <span class="o">=</span> <span class="n">ec_byte</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">olpc_ec_sci_query</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ec_debugfs_cmd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ec_cmd</span><span class="p">[</span><span class="n">EC_MAX_CMD_ARGS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ec_cmd_int</span><span class="p">[</span><span class="n">EC_MAX_CMD_ARGS</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">cmdbuf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ec_cmd_bytes</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_debugfs_cmd_lock</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">simple_write_to_buffer</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">),</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="s">&quot;%x:%u %x %x %x %x %x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec_cmd_int</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		   <span class="o">&amp;</span><span class="n">ec_debugfs_resp_bytes</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">ec_cmd_int</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ec_cmd_int</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ec_cmd_int</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		   <span class="o">&amp;</span><span class="n">ec_cmd_int</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ec_cmd_int</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">ec_debugfs_resp_bytes</span> <span class="o">&gt;</span> <span class="n">EC_MAX_CMD_REPLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset to prevent overflow on read */</span>
		<span class="n">ec_debugfs_resp_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;olpc-ec: bad ec cmd:  &quot;</span>
		       <span class="s">&quot;cmd:response-count [arg1 [arg2 ...]]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* convert scanf&#39;d ints to char */</span>
	<span class="n">ec_cmd_bytes</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ec_cmd_bytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ec_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ec_cmd_int</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;olpc-ec: debugfs cmd 0x%02x with %d args &quot;</span>
	       <span class="s">&quot;%02x %02x %02x %02x %02x, want %d returns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ec_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ec_cmd_bytes</span><span class="p">,</span> <span class="n">ec_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ec_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ec_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	       <span class="n">ec_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ec_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ec_debugfs_resp_bytes</span><span class="p">);</span>

	<span class="n">olpc_ec_cmd</span><span class="p">(</span><span class="n">ec_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">ec_cmd_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">ec_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">ec_cmd_bytes</span><span class="p">,</span> <span class="n">ec_debugfs_resp</span><span class="p">,</span> <span class="n">ec_debugfs_resp_bytes</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;olpc-ec: response &quot;</span>
	       <span class="s">&quot;%02x %02x %02x %02x %02x %02x %02x %02x (%d bytes expected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	       <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	       <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">ec_debugfs_resp_bytes</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_debugfs_cmd_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ec_debugfs_cmd_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">respbuf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_debugfs_cmd_lock</span><span class="p">);</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">respbuf</span><span class="p">;</span>
	<span class="n">rp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ec_debugfs_resp_bytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="s">&quot;, %02x&quot;</span><span class="p">,</span> <span class="n">ec_debugfs_resp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_debugfs_cmd_lock</span><span class="p">);</span>
	<span class="n">rp</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">rp</span> <span class="o">-</span> <span class="n">respbuf</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">respbuf</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ec_debugfs_genops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span>	 <span class="o">=</span> <span class="n">ec_debugfs_cmd_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">ec_debugfs_cmd_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_debugfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ec_debugfs_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;olpc-ec&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ec_debugfs_dir</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;cmd&quot;</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">ec_debugfs_dir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ec_debugfs_genops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">olpc_ec_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">olpc_ec_mask_write</span><span class="p">(</span><span class="n">ec_wakeup_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">check_ofw_architecture</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">olpc_arch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">propsize</span><span class="p">;</span>

	<span class="n">olpc_arch</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;architecture&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">propsize</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">propsize</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;OLPC&quot;</span><span class="p">,</span> <span class="n">olpc_arch</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">__init</span> <span class="nf">get_board_revision</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">propsize</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">rev</span><span class="p">;</span>

	<span class="n">rev</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;board-revision-int&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">propsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">propsize</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">rev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">platform_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">success</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">success</span> <span class="o">=</span> <span class="n">check_ofw_architecture</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">boardrev</span> <span class="o">=</span> <span class="n">get_board_revision</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OLPC_F_PRESENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">of_node_put</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">add_xo1_platform_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;xo1-rfkill&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;olpc-xo1&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">olpc_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">olpc_ec_suspend</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">olpc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">olpc_ofw_present</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">platform_detect</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_lock</span><span class="p">);</span>

	<span class="cm">/* assume B1 and above models always have a DCON */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_board_at_least</span><span class="p">(</span><span class="n">olpc_board</span><span class="p">(</span><span class="mh">0xb1</span><span class="p">)))</span>
		<span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OLPC_F_DCON</span><span class="p">;</span>

	<span class="cm">/* get the EC revision */</span>
	<span class="n">olpc_ec_cmd</span><span class="p">(</span><span class="n">EC_FIRMWARE_REV</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">ecver</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI_OLPC</span>
	<span class="cm">/* If the VSA exists let it emulate PCI, if not emulate in kernel.</span>
<span class="cm">	 * XO-1 only. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">boardrev</span> <span class="o">&lt;</span> <span class="n">olpc_board_pre</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">cs5535_has_vsa2</span><span class="p">())</span>
		<span class="n">x86_init</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">arch_init</span> <span class="o">=</span> <span class="n">pci_olpc_init</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* EC version 0x5f adds support for wide SCI mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">ecver</span> <span class="o">&gt;=</span> <span class="mh">0x5f</span><span class="p">)</span>
		<span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OLPC_F_EC_WIDE_SCI</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OLPC board revision %s%X (EC=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">boardrev</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;pre&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">boardrev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">ecver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_platform_info</span><span class="p">.</span><span class="n">boardrev</span> <span class="o">&lt;</span> <span class="n">olpc_board_pre</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* XO-1 */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">add_xo1_platform_devices</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">olpc_syscore_ops</span><span class="p">);</span>
	<span class="n">setup_debugfs</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">postcore_initcall</span><span class="p">(</span><span class="n">olpc_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
