<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › x86 › platform › mrst › mrst.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mrst.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * mrst.c: Intel Moorestown platform specific setup code</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 2008 Intel Corporation</span>
<span class="cm"> * Author: Jacob Pan (jacob.jun.pan@intel.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; version 2</span>
<span class="cm"> * of the License.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;mrst: &quot; fmt</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/sfi.h&gt;</span>
<span class="cp">#include &lt;linux/intel_pmic_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/pca953x.h&gt;</span>
<span class="cp">#include &lt;linux/gpio_keys.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/intel_msic.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/tc35876x.h&gt;</span>

<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/mpspec_def.h&gt;</span>
<span class="cp">#include &lt;asm/hw_irq.h&gt;</span>
<span class="cp">#include &lt;asm/apic.h&gt;</span>
<span class="cp">#include &lt;asm/io_apic.h&gt;</span>
<span class="cp">#include &lt;asm/mrst.h&gt;</span>
<span class="cp">#include &lt;asm/mrst-vrtc.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/i8259.h&gt;</span>
<span class="cp">#include &lt;asm/intel_scu_ipc.h&gt;</span>
<span class="cp">#include &lt;asm/apb_timer.h&gt;</span>
<span class="cp">#include &lt;asm/reboot.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * the clockevent devices on Moorestown/Medfield can be APBT or LAPIC clock,</span>
<span class="cm"> * cmdline option x86_mrst_timer can be used to override the configuration</span>
<span class="cm"> * to prefer one or the other.</span>
<span class="cm"> * at runtime, there are basically three timer configurations:</span>
<span class="cm"> * 1. per cpu apbt clock only</span>
<span class="cm"> * 2. per cpu always-on lapic clocks only, this is Penwell/Medfield only</span>
<span class="cm"> * 3. per cpu lapic clock (C3STOP) and one apbt clock, with broadcast.</span>
<span class="cm"> *</span>
<span class="cm"> * by default (without cmdline option), platform code first detects cpu type</span>
<span class="cm"> * to see if we are on lincroft or penwell, then set up both lapic or apbt</span>
<span class="cm"> * clocks accordingly.</span>
<span class="cm"> * i.e. by default, medfield uses configuration #2, moorestown uses #1.</span>
<span class="cm"> * config #3 is supported but not recommended on medfield.</span>
<span class="cm"> *</span>
<span class="cm"> * rating and feature summary:</span>
<span class="cm"> * lapic (with C3STOP) --------- 100</span>
<span class="cm"> * apbt (always-on) ------------ 110</span>
<span class="cm"> * lapic (always-on,ARAT) ------ 150</span>
<span class="cm"> */</span>

<span class="n">__cpuinitdata</span> <span class="k">enum</span> <span class="n">mrst_timer_options</span> <span class="n">mrst_timer_options</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">sfi_mtimer_usage</span><span class="p">[</span><span class="n">SFI_MTMR_MAX_NUM</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sfi_timer_table_entry</span> <span class="n">sfi_mtimer_array</span><span class="p">[</span><span class="n">SFI_MTMR_MAX_NUM</span><span class="p">];</span>
<span class="k">enum</span> <span class="n">mrst_cpu_type</span> <span class="n">__mrst_cpu_chip</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__mrst_cpu_chip</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">sfi_mtimer_num</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sfi_rtc_table_entry</span> <span class="n">sfi_mrtc_array</span><span class="p">[</span><span class="n">SFI_MRTC_MAX</span><span class="p">];</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sfi_mrtc_array</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">sfi_mrtc_num</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mrst_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mrst_reboot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">intel_scu_ipc_simple_command</span><span class="p">(</span><span class="n">IPCMSG_COLD_BOOT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* parse all the mtimer info to a static mtimer array */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sfi_parse_mtmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sfi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sfi_table_simple</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sfi_timer_table_entry</span> <span class="o">*</span><span class="n">pentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="n">mp_irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">totallen</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_table_simple</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfi_mtimer_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sfi_mtimer_num</span> <span class="o">=</span> <span class="n">SFI_GET_NUM_ENTRIES</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sfi_timer_table_entry</span><span class="p">);</span>
		<span class="n">pentry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_timer_table_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">pentry</span><span class="p">;</span>
		<span class="n">totallen</span> <span class="o">=</span> <span class="n">sfi_mtimer_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pentry</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sfi_mtimer_array</span><span class="p">,</span> <span class="n">pentry</span><span class="p">,</span> <span class="n">totallen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SFI MTIMER info (num = %d):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sfi_mtimer_num</span><span class="p">);</span>
	<span class="n">pentry</span> <span class="o">=</span> <span class="n">sfi_mtimer_array</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">totallen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">totallen</span> <span class="o">&lt;</span> <span class="n">sfi_mtimer_num</span><span class="p">;</span> <span class="n">totallen</span><span class="o">++</span><span class="p">,</span> <span class="n">pentry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;timer[%d]: paddr = 0x%08x, freq = %dHz,&quot;</span>
			<span class="s">&quot; irq = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">totallen</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pentry</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">,</span>
			<span class="n">pentry</span><span class="o">-&gt;</span><span class="n">freq_hz</span><span class="p">,</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">mp_irq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_INTSRC</span><span class="p">;</span>
			<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqtype</span> <span class="o">=</span> <span class="n">mp_INT</span><span class="p">;</span>
<span class="cm">/* triggering mode edge bit 2-3, active high polarity bit 0-1 */</span>
			<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbus</span> <span class="o">=</span> <span class="n">MP_BUS_ISA</span><span class="p">;</span>
			<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbusirq</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>	<span class="cm">/* IRQ */</span>
			<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstapic</span> <span class="o">=</span> <span class="n">MP_APIC_ALL</span><span class="p">;</span>
			<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstirq</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
			<span class="n">mp_save_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sfi_timer_table_entry</span> <span class="o">*</span><span class="nf">sfi_get_mtmr</span><span class="p">(</span><span class="kt">int</span> <span class="n">hint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hint</span> <span class="o">&lt;</span> <span class="n">sfi_mtimer_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfi_mtimer_usage</span><span class="p">[</span><span class="n">hint</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hint taken for timer %d irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
				<span class="n">hint</span><span class="p">,</span> <span class="n">sfi_mtimer_array</span><span class="p">[</span><span class="n">hint</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">sfi_mtimer_usage</span><span class="p">[</span><span class="n">hint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">sfi_mtimer_array</span><span class="p">[</span><span class="n">hint</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* take the first timer available */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sfi_mtimer_num</span><span class="p">;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfi_mtimer_usage</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">sfi_mtimer_usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">sfi_mtimer_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sfi_free_mtmr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sfi_timer_table_entry</span> <span class="o">*</span><span class="n">mtmr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sfi_mtimer_num</span><span class="p">;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtmr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">sfi_mtimer_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sfi_mtimer_usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* parse all the mrtc info to a global mrtc array */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">sfi_parse_mrtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sfi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sfi_table_simple</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sfi_rtc_table_entry</span> <span class="o">*</span><span class="n">pentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc_intsrc</span> <span class="n">mp_irq</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">totallen</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_table_simple</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfi_mrtc_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sfi_mrtc_num</span> <span class="o">=</span> <span class="n">SFI_GET_NUM_ENTRIES</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">sfi_rtc_table_entry</span><span class="p">);</span>
		<span class="n">pentry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_rtc_table_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pentry</span><span class="p">;</span>
		<span class="n">totallen</span> <span class="o">=</span> <span class="n">sfi_mrtc_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pentry</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sfi_mrtc_array</span><span class="p">,</span> <span class="n">pentry</span><span class="p">,</span> <span class="n">totallen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SFI RTC info (num = %d):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sfi_mrtc_num</span><span class="p">);</span>
	<span class="n">pentry</span> <span class="o">=</span> <span class="n">sfi_mrtc_array</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">totallen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">totallen</span> <span class="o">&lt;</span> <span class="n">sfi_mrtc_num</span><span class="p">;</span> <span class="n">totallen</span><span class="o">++</span><span class="p">,</span> <span class="n">pentry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RTC[%d]: paddr = 0x%08x, irq = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">totallen</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pentry</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MP_INTSRC</span><span class="p">;</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqtype</span> <span class="o">=</span> <span class="n">mp_INT</span><span class="p">;</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">irqflag</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>	<span class="cm">/* level trigger and active low */</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbus</span> <span class="o">=</span> <span class="n">MP_BUS_ISA</span><span class="p">;</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">srcbusirq</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>	<span class="cm">/* IRQ */</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstapic</span> <span class="o">=</span> <span class="n">MP_APIC_ALL</span><span class="p">;</span>
		<span class="n">mp_irq</span><span class="p">.</span><span class="n">dstirq</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">mp_save_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">mrst_calibrate_tsc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fast_calibrate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">fsb</span><span class="p">;</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IA32_PERF_STATUS</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;IA32 perf status is 0x%x, 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ratio is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ratio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;read a zero ratio, should be incorrect!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;force tsc ratio to 16 ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_FSB_FREQ</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span>
		<span class="n">fsb</span> <span class="o">=</span> <span class="n">PENWELL_FSB_FREQ_83SKU</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fsb</span> <span class="o">=</span> <span class="n">PENWELL_FSB_FREQ_100SKU</span><span class="p">;</span>
	<span class="n">fast_calibrate</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">fsb</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;read penwell tsc %lu khz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fast_calibrate</span><span class="p">);</span>
	<span class="n">lapic_timer_frequency</span> <span class="o">=</span> <span class="n">fsb</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="cm">/* mark tsc clocksource as reliable */</span>
	<span class="n">set_cpu_cap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_cpu_data</span><span class="p">,</span> <span class="n">X86_FEATURE_TSC_RELIABLE</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">fast_calibrate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fast_calibrate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mrst_time_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sfi_table_parse</span><span class="p">(</span><span class="n">SFI_SIG_MTMR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sfi_parse_mtmr</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mrst_timer_options</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MRST_TIMER_APBT_ONLY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MRST_TIMER_LAPIC_APBT</span>:
		<span class="n">x86_init</span><span class="p">.</span><span class="n">timers</span><span class="p">.</span><span class="n">setup_percpu_clockev</span> <span class="o">=</span> <span class="n">setup_boot_APIC_clock</span><span class="p">;</span>
		<span class="n">x86_cpuinit</span><span class="p">.</span><span class="n">setup_percpu_clockev</span> <span class="o">=</span> <span class="n">setup_secondary_APIC_clock</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_ARAT</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">x86_init</span><span class="p">.</span><span class="n">timers</span><span class="p">.</span><span class="n">setup_percpu_clockev</span> <span class="o">=</span> <span class="n">setup_boot_APIC_clock</span><span class="p">;</span>
		<span class="n">x86_cpuinit</span><span class="p">.</span><span class="n">setup_percpu_clockev</span> <span class="o">=</span> <span class="n">setup_secondary_APIC_clock</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we need at least one APB timer */</span>
	<span class="n">pre_init_apic_IRQ0</span><span class="p">();</span>
	<span class="n">apbt_time_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">mrst_arch_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mh">0x27</span><span class="p">)</span>
		<span class="n">__mrst_cpu_chip</span> <span class="o">=</span> <span class="n">MRST_CPU_CHIP_PENWELL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown Intel MID CPU (%d:%d), default to Penwell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span><span class="p">,</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span><span class="p">);</span>
		<span class="n">__mrst_cpu_chip</span> <span class="o">=</span> <span class="n">MRST_CPU_CHIP_PENWELL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* MID systems don&#39;t have i8042 controller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mrst_i8042_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Moorestown does not have external NMI source nor port 0x61 to report</span>
<span class="cm"> * NMI status. The possible NMI sources are from pmu as a result of NMI</span>
<span class="cm"> * watchdog or lock debug. Reading io port 0x61 results in 0xff which</span>
<span class="cm"> * misled NMI handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">mrst_get_nmi_reason</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Moorestown specific x86_init function overrides and early setup</span>
<span class="cm"> * calls.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">x86_mrst_early_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">probe_roms</span> <span class="o">=</span> <span class="n">x86_init_noop</span><span class="p">;</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">reserve_resources</span> <span class="o">=</span> <span class="n">x86_init_noop</span><span class="p">;</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">timers</span><span class="p">.</span><span class="n">timer_init</span> <span class="o">=</span> <span class="n">mrst_time_init</span><span class="p">;</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">timers</span><span class="p">.</span><span class="n">setup_percpu_clockev</span> <span class="o">=</span> <span class="n">x86_init_noop</span><span class="p">;</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">irqs</span><span class="p">.</span><span class="n">pre_vector_init</span> <span class="o">=</span> <span class="n">x86_init_noop</span><span class="p">;</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">oem</span><span class="p">.</span><span class="n">arch_setup</span> <span class="o">=</span> <span class="n">mrst_arch_setup</span><span class="p">;</span>

	<span class="n">x86_cpuinit</span><span class="p">.</span><span class="n">setup_percpu_clockev</span> <span class="o">=</span> <span class="n">apbt_setup_secondary_clock</span><span class="p">;</span>

	<span class="n">x86_platform</span><span class="p">.</span><span class="n">calibrate_tsc</span> <span class="o">=</span> <span class="n">mrst_calibrate_tsc</span><span class="p">;</span>
	<span class="n">x86_platform</span><span class="p">.</span><span class="n">i8042_detect</span> <span class="o">=</span> <span class="n">mrst_i8042_detect</span><span class="p">;</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">timers</span><span class="p">.</span><span class="n">wallclock_init</span> <span class="o">=</span> <span class="n">mrst_rtc_init</span><span class="p">;</span>
	<span class="n">x86_platform</span><span class="p">.</span><span class="n">get_nmi_reason</span> <span class="o">=</span> <span class="n">mrst_get_nmi_reason</span><span class="p">;</span>

	<span class="n">x86_init</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pci_mrst_init</span><span class="p">;</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">fixup_irqs</span> <span class="o">=</span> <span class="n">x86_init_noop</span><span class="p">;</span>

	<span class="n">legacy_pic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">null_legacy_pic</span><span class="p">;</span>

	<span class="cm">/* Moorestown specific power_off/restart method */</span>
	<span class="n">pm_power_off</span> <span class="o">=</span> <span class="n">mrst_power_off</span><span class="p">;</span>
	<span class="n">machine_ops</span><span class="p">.</span><span class="n">emergency_restart</span>  <span class="o">=</span> <span class="n">mrst_reboot</span><span class="p">;</span>

	<span class="cm">/* Avoid searching for BIOS MP tables */</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">find_smp_config</span> <span class="o">=</span> <span class="n">x86_init_noop</span><span class="p">;</span>
	<span class="n">x86_init</span><span class="p">.</span><span class="n">mpparse</span><span class="p">.</span><span class="n">get_smp_config</span> <span class="o">=</span> <span class="n">x86_init_uint_noop</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MP_BUS_ISA</span><span class="p">,</span> <span class="n">mp_bus_not_pci</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if user does not want to use per CPU apb timer, just give it a lower rating</span>
<span class="cm"> * than local apic timer and skip the late per cpu timer init.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_x86_mrst_timer</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;apbt_only&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mrst_timer_options</span> <span class="o">=</span> <span class="n">MRST_TIMER_APBT_ONLY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;lapic_and_apbt&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mrst_timer_options</span> <span class="o">=</span> <span class="n">MRST_TIMER_LAPIC_APBT</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;X86 MRST timer option %s not recognised&quot;</span>
			   <span class="s">&quot; use x86_mrst_timer=apbt_only or lapic_and_apbt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;x86_mrst_timer=&quot;</span><span class="p">,</span> <span class="n">setup_x86_mrst_timer</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Parsing GPIO table first, since the DEVS table will need this table</span>
<span class="cm"> * to map the pin name to the actual pin.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sfi_gpio_table_entry</span> <span class="o">*</span><span class="n">gpio_table</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gpio_num_entry</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sfi_parse_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sfi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sfi_table_simple</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sfi_gpio_table_entry</span> <span class="o">*</span><span class="n">pentry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_table_simple</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">SFI_GET_NUM_ENTRIES</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sfi_gpio_table_entry</span><span class="p">);</span>
	<span class="n">pentry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_gpio_table_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pentry</span><span class="p">;</span>

	<span class="n">gpio_table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_gpio_table_entry</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">kmalloc</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pentry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">gpio_table</span><span class="p">,</span> <span class="n">pentry</span><span class="p">,</span> <span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pentry</span><span class="p">));</span>
	<span class="n">gpio_num_entry</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;GPIO pin info:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pentry</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;info[%2d]: controller = %16.16s, pin_name = %16.16s,&quot;</span>
		<span class="s">&quot; pin = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">pentry</span><span class="o">-&gt;</span><span class="n">controller_name</span><span class="p">,</span>
			<span class="n">pentry</span><span class="o">-&gt;</span><span class="n">pin_name</span><span class="p">,</span>
			<span class="n">pentry</span><span class="o">-&gt;</span><span class="n">pin_no</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_gpio_by_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sfi_gpio_table_entry</span> <span class="o">*</span><span class="n">pentry</span> <span class="o">=</span> <span class="n">gpio_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gpio_num_entry</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pentry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">pin_name</span><span class="p">,</span> <span class="n">SFI_NAME_LEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">pin_no</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Here defines the array of devices platform data that IAFW would export</span>
<span class="cm"> * through SFI &quot;DEVS&quot; table, we use name and type to match the device and</span>
<span class="cm"> * its platform data.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">devs_id</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">SFI_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_platform_data</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* the offset for the mapping of global gpio pin to irq */</span>
<span class="cp">#define MRST_IRQ_OFFSET 0x100</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">pmic_gpio_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_pmic_gpio_platform_data</span> <span class="n">pmic_gpio_pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_base</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;pmic_gpio_base&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_base</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">gpio_base</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">pmic_gpio_pdata</span><span class="p">.</span><span class="n">gpio_base</span> <span class="o">=</span> <span class="n">gpio_base</span><span class="p">;</span>
	<span class="n">pmic_gpio_pdata</span><span class="p">.</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">gpio_base</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
	<span class="n">pmic_gpio_pdata</span><span class="p">.</span><span class="n">gpiointr</span> <span class="o">=</span> <span class="mh">0xffffeff8</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">pmic_gpio_pdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">max3111_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">spi_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;max3111_int&quot;</span><span class="p">);</span>

	<span class="n">spi_info</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SPI_MODE_0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spi_info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* we have multiple max7315 on the board ... */</span>
<span class="cp">#define MAX7315_NUM 2</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">max7315_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">pca953x_platform_data</span> <span class="n">max7315_pdata</span><span class="p">[</span><span class="n">MAX7315_NUM</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pca953x_platform_data</span> <span class="o">*</span><span class="n">max7315</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">max7315_pdata</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">i2c_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_base</span><span class="p">,</span> <span class="n">intr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">base_pin_name</span><span class="p">[</span><span class="n">SFI_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">intr_pin_name</span><span class="p">[</span><span class="n">SFI_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">MAX7315_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;too many max7315s, we only support %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">MAX7315_NUM</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we have several max7315 on the board, we only need load several</span>
<span class="cm">	 * instances of the same pca953x driver to cover them</span>
<span class="cm">	 */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;max7315&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">base_pin_name</span><span class="p">,</span> <span class="s">&quot;max7315_%d_base&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">intr_pin_name</span><span class="p">,</span> <span class="s">&quot;max7315_%d_int&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">base_pin_name</span><span class="p">,</span> <span class="s">&quot;max7315_base&quot;</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">intr_pin_name</span><span class="p">,</span> <span class="s">&quot;max7315_int&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gpio_base</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="n">base_pin_name</span><span class="p">);</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="n">intr_pin_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_base</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">max7315</span><span class="o">-&gt;</span><span class="n">gpio_base</span> <span class="o">=</span> <span class="n">gpio_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
		<span class="n">max7315</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">gpio_base</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">max7315</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max7315</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">tca6416_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">pca953x_platform_data</span> <span class="n">tca6416</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">i2c_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_base</span><span class="p">,</span> <span class="n">intr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">base_pin_name</span><span class="p">[</span><span class="n">SFI_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">intr_pin_name</span><span class="p">[</span><span class="n">SFI_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;tca6416&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">base_pin_name</span><span class="p">,</span> <span class="s">&quot;tca6416_base&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">intr_pin_name</span><span class="p">,</span> <span class="s">&quot;tca6416_int&quot;</span><span class="p">);</span>

	<span class="n">gpio_base</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="n">base_pin_name</span><span class="p">);</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="n">intr_pin_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_base</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tca6416</span><span class="p">.</span><span class="n">gpio_base</span> <span class="o">=</span> <span class="n">gpio_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
		<span class="n">tca6416</span><span class="p">.</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">gpio_base</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">tca6416</span><span class="p">.</span><span class="n">irq_base</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">tca6416</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">mpu3050_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">i2c_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;mpu3050_int&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">emc1403_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">short</span> <span class="n">intr2nd_pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">i2c_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;thermal_int&quot;</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">intr2nd</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;thermal_alert&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">intr2nd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
	<span class="n">intr2nd_pdata</span> <span class="o">=</span> <span class="n">intr2nd</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">intr2nd_pdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">lis331dl_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">short</span> <span class="n">intr2nd_pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">i2c_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;accel_int&quot;</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">intr2nd</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;accel_2&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">intr2nd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>
	<span class="n">intr2nd_pdata</span> <span class="o">=</span> <span class="n">intr2nd</span> <span class="o">+</span> <span class="n">MRST_IRQ_OFFSET</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">intr2nd_pdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">no_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">msic_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">INTEL_MSIC_IRQ_PHYS_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">INTEL_MSIC_IRQ_PHYS_BASE</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_msic_platform_data</span> <span class="n">msic_pdata</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">msic_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;intel_msic&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">msic_pdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msic_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">msic_resources</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">mrst_has_msic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mrst_identify_cpu</span><span class="p">()</span> <span class="o">==</span> <span class="n">MRST_CPU_CHIP_PENWELL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msic_scu_status_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">SCU_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msic_device</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msic_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">msic_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">msic_scu_notifier</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">msic_scu_status_change</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to be sure that the SCU IPC is ready before MSIC device</span>
<span class="cm">	 * can be registered.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mrst_has_msic</span><span class="p">())</span>
		<span class="n">intel_scu_notifier_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msic_scu_notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">msic_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * msic_generic_platform_data - sets generic platform data for the block</span>
<span class="cm"> * @info: pointer to the SFI device table entry for this block</span>
<span class="cm"> * @block: MSIC block</span>
<span class="cm"> *</span>
<span class="cm"> * Function sets IRQ number from the SFI table entry for given device to</span>
<span class="cm"> * the MSIC platform data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">msic_generic_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">enum</span> <span class="n">intel_msic_block</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sfi_device_table_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">block</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">block</span> <span class="o">&gt;=</span> <span class="n">INTEL_MSIC_BLOCK_LAST</span><span class="p">);</span>
	<span class="n">msic_pdata</span><span class="p">.</span><span class="n">irq</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">no_platform_data</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">msic_battery_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msic_generic_platform_data</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">INTEL_MSIC_BLOCK_BATTERY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">msic_gpio_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_msic_gpio_pdata</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;msic_gpio_base&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">gpio_base</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="n">msic_pdata</span><span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">msic_generic_platform_data</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">INTEL_MSIC_BLOCK_GPIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">msic_audio_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;sst-platform&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to create audio platform device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">msic_generic_platform_data</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">INTEL_MSIC_BLOCK_AUDIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">msic_power_btn_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msic_generic_platform_data</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">INTEL_MSIC_BLOCK_POWER_BTN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">msic_ocd_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_msic_ocd_pdata</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;ocd_gpio&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="n">msic_pdata</span><span class="p">.</span><span class="n">ocd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">msic_generic_platform_data</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">INTEL_MSIC_BLOCK_OCD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">msic_thermal_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msic_generic_platform_data</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">INTEL_MSIC_BLOCK_THERMAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tc35876x DSI-LVDS bridge chip and panel platform data */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">tc35876x_platform_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
       <span class="k">static</span> <span class="k">struct</span> <span class="n">tc35876x_platform_data</span> <span class="n">pdata</span><span class="p">;</span>

       <span class="cm">/* gpio pins set to -1 will not be used by the driver */</span>
       <span class="n">pdata</span><span class="p">.</span><span class="n">gpio_bridge_reset</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;LCMB_RXEN&quot;</span><span class="p">);</span>
       <span class="n">pdata</span><span class="p">.</span><span class="n">gpio_panel_bl_en</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;6S6P_BL_EN&quot;</span><span class="p">);</span>
       <span class="n">pdata</span><span class="p">.</span><span class="n">gpio_panel_vadd</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="s">&quot;EN_VREG_LCD_V3P3&quot;</span><span class="p">);</span>

       <span class="k">return</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">devs_id</span> <span class="n">__initconst</span> <span class="n">device_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;bma023&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_I2C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pmic_gpio&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_SPI</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmic_gpio_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pmic_gpio&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_IPC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmic_gpio_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;spi_max3111&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_SPI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max3111_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i2c_max7315&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_I2C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max7315_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i2c_max7315_2&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_I2C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max7315_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tca6416&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_I2C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tca6416_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;emc1403&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_I2C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emc1403_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i2c_accel&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_I2C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis331dl_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pmic_audio&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_IPC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;mpu3050&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_I2C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpu3050_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i2c_disp_brig&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_I2C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc35876x_platform_data</span><span class="p">},</span>

	<span class="cm">/* MSIC subdevices */</span>
	<span class="p">{</span><span class="s">&quot;msic_battery&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_IPC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msic_battery_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;msic_gpio&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_IPC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msic_gpio_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;msic_audio&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_IPC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msic_audio_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;msic_power_btn&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_IPC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msic_power_btn_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;msic_ocd&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_IPC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msic_ocd_platform_data</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;msic_thermal&quot;</span><span class="p">,</span> <span class="n">SFI_DEV_TYPE_IPC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msic_thermal_platform_data</span><span class="p">},</span>

	<span class="p">{},</span>
<span class="p">};</span>

<span class="cp">#define MAX_IPCDEVS	24</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ipc_devs</span><span class="p">[</span><span class="n">MAX_IPCDEVS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipc_next_dev</span><span class="p">;</span>

<span class="cp">#define MAX_SCU_SPI	24</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">spi_devs</span><span class="p">[</span><span class="n">MAX_SCU_SPI</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">spi_next_dev</span><span class="p">;</span>

<span class="cp">#define MAX_SCU_I2C	24</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">i2c_devs</span><span class="p">[</span><span class="n">MAX_SCU_I2C</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">i2c_bus</span><span class="p">[</span><span class="n">MAX_SCU_I2C</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">i2c_next_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">intel_scu_device_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ipc_next_dev</span> <span class="o">==</span> <span class="n">MAX_IPCDEVS</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;too many SCU IPC devices&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ipc_devs</span><span class="p">[</span><span class="n">ipc_next_dev</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">intel_scu_spi_device_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi_next_dev</span> <span class="o">==</span> <span class="n">MAX_SCU_SPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;too many SCU SPI devices&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sdev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to alloc mem for delayed spi dev %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">modalias</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">new_dev</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sdev</span><span class="p">));</span>

	<span class="n">spi_devs</span><span class="p">[</span><span class="n">spi_next_dev</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">intel_scu_i2c_device_register</span><span class="p">(</span><span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_next_dev</span> <span class="o">==</span> <span class="n">MAX_SCU_I2C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;too many SCU I2C devices&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">idev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to alloc mem for delayed i2c dev %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">idev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">new_dev</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">idev</span><span class="p">));</span>

	<span class="n">i2c_bus</span><span class="p">[</span><span class="n">i2c_next_dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">i2c_devs</span><span class="p">[</span><span class="n">i2c_next_dev</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">intel_scu_notifier</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">intel_scu_notifier</span><span class="p">);</span>

<span class="cm">/* Called by IPC driver */</span>
<span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">intel_scu_devices_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ipc_next_dev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">platform_device_add</span><span class="p">(</span><span class="n">ipc_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spi_next_dev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">spi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">i2c_next_dev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

		<span class="n">adapter</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="n">i2c_bus</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">client</span> <span class="o">=</span> <span class="n">i2c_new_device</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i2c_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t create i2c device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">i2c_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="n">i2c_bus</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i2c_devs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">intel_scu_notifier_post</span><span class="p">(</span><span class="n">SCU_AVAILABLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">intel_scu_devices_create</span><span class="p">);</span>

<span class="cm">/* Called by IPC driver */</span>
<span class="kt">void</span> <span class="nf">intel_scu_devices_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">intel_scu_notifier_post</span><span class="p">(</span><span class="n">SCU_DOWN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ipc_next_dev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">platform_device_del</span><span class="p">(</span><span class="n">ipc_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">intel_scu_devices_destroy</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">install_irq_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Single threaded */</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__initdata</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IRQ&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sfi_handle_ipc_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sfi_device_table_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">devs_id</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_ids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SFI_DEV_TYPE_IPC</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SFI_NAME_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">get_platform_data</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * On Medfield the platform device creation is handled by the MSIC</span>
<span class="cm">	 * MFD driver so we don&#39;t need to do it here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mrst_has_msic</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory for SFI platform device &#39;%s&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">install_irq_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">intel_scu_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sfi_handle_spi_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">spi_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">devs_id</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_ids</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SFI_DEV_TYPE_SPI</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">spi_info</span><span class="o">-&gt;</span><span class="n">modalias</span><span class="p">,</span> <span class="n">SFI_NAME_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">get_platform_data</span><span class="p">(</span><span class="n">spi_info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spi_info</span><span class="o">-&gt;</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">)</span>
		<span class="n">intel_scu_spi_device_register</span><span class="p">(</span><span class="n">spi_info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">spi_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sfi_handle_i2c_dev</span><span class="p">(</span><span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">i2c_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">devs_id</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_ids</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SFI_DEV_TYPE_I2C</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">SFI_NAME_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">get_platform_data</span><span class="p">(</span><span class="n">i2c_info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i2c_info</span><span class="o">-&gt;</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">)</span>
		<span class="n">intel_scu_i2c_device_register</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">i2c_info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">i2c_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
 <span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sfi_parse_devs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sfi_table_header</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sfi_table_simple</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sfi_device_table_entry</span> <span class="o">*</span><span class="n">pentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">spi_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">i2c_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioapic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_apic_irq_attr</span> <span class="n">irq_attr</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_table_simple</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">SFI_GET_NUM_ENTRIES</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sfi_device_table_entry</span><span class="p">);</span>
	<span class="n">pentry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sfi_device_table_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pentry</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pentry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* native RTE case */</span>
			<span class="cm">/* these SPI2 devices are not exposed to system as PCI</span>
<span class="cm">			 * devices, but they have separate RTE entry in IOAPIC</span>
<span class="cm">			 * so we have to enable them one by one here</span>
<span class="cm">			 */</span>
			<span class="n">ioapic</span> <span class="o">=</span> <span class="n">mp_find_ioapic</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">irq_attr</span><span class="p">.</span><span class="n">ioapic</span> <span class="o">=</span> <span class="n">ioapic</span><span class="p">;</span>
			<span class="n">irq_attr</span><span class="p">.</span><span class="n">ioapic_pin</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="n">irq_attr</span><span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">irq_attr</span><span class="p">.</span><span class="n">polarity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">io_apic_set_pci_routing</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_attr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No irq */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pentry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SFI_DEV_TYPE_IPC</span>:
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;info[%2d]: IPC bus, name = %16.16s, &quot;</span>
				<span class="s">&quot;irq = 0x%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">sfi_handle_ipc_dev</span><span class="p">(</span><span class="n">pentry</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SFI_DEV_TYPE_SPI</span>:
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spi_info</span><span class="p">));</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">spi_info</span><span class="p">.</span><span class="n">modalias</span><span class="p">,</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SFI_NAME_LEN</span><span class="p">);</span>
			<span class="n">spi_info</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="n">spi_info</span><span class="p">.</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">;</span>
			<span class="n">spi_info</span><span class="p">.</span><span class="n">chip_select</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">spi_info</span><span class="p">.</span><span class="n">max_speed_hz</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;info[%2d]: SPI bus = %d, name = %16.16s, &quot;</span>
				<span class="s">&quot;irq = 0x%2x, max_freq = %d, cs = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">spi_info</span><span class="p">.</span><span class="n">bus_num</span><span class="p">,</span>
				<span class="n">spi_info</span><span class="p">.</span><span class="n">modalias</span><span class="p">,</span>
				<span class="n">spi_info</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span>
				<span class="n">spi_info</span><span class="p">.</span><span class="n">max_speed_hz</span><span class="p">,</span>
				<span class="n">spi_info</span><span class="p">.</span><span class="n">chip_select</span><span class="p">);</span>
			<span class="n">sfi_handle_spi_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi_info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SFI_DEV_TYPE_I2C</span>:
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2c_info</span><span class="p">));</span>
			<span class="n">bus</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">host_num</span><span class="p">;</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">i2c_info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SFI_NAME_LEN</span><span class="p">);</span>
			<span class="n">i2c_info</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="n">i2c_info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pentry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;info[%2d]: I2C bus = %d, name = %16.16s, &quot;</span>
				<span class="s">&quot;irq = 0x%2x, addr = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span>
				<span class="n">i2c_info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
				<span class="n">i2c_info</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span>
				<span class="n">i2c_info</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">sfi_handle_i2c_dev</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SFI_DEV_TYPE_UART</span>:
		<span class="k">case</span> <span class="n">SFI_DEV_TYPE_HSI</span>:
		<span class="nl">default:</span>
			<span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mrst_platform_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sfi_table_parse</span><span class="p">(</span><span class="n">SFI_SIG_GPIO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sfi_parse_gpio</span><span class="p">);</span>
	<span class="n">sfi_table_parse</span><span class="p">(</span><span class="n">SFI_SIG_DEVS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sfi_parse_devs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">mrst_platform_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * we will search these buttons in SFI GPIO table (by name)</span>
<span class="cm"> * and register them dynamically. Please add all possible</span>
<span class="cm"> * buttons here, we will shrink them if no GPIO found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">gpio_button</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">KEY_POWER</span><span class="p">,</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;power_btn&quot;</span><span class="p">,</span>	<span class="n">EV_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">KEY_PROG1</span><span class="p">,</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;prog_btn1&quot;</span><span class="p">,</span>	<span class="n">EV_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">KEY_PROG2</span><span class="p">,</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;prog_btn2&quot;</span><span class="p">,</span>	<span class="n">EV_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SW_LID</span><span class="p">,</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;lid_switch&quot;</span><span class="p">,</span>	<span class="n">EV_SW</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">KEY_VOLUMEUP</span><span class="p">,</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;vol_up&quot;</span><span class="p">,</span>	<span class="n">EV_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;vol_down&quot;</span><span class="p">,</span>	<span class="n">EV_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">KEY_CAMERA</span><span class="p">,</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;camera_full&quot;</span><span class="p">,</span>	<span class="n">EV_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">KEY_CAMERA_FOCUS</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;camera_half&quot;</span><span class="p">,</span>	<span class="n">EV_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SW_KEYPAD_SLIDE</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;MagSw1&quot;</span><span class="p">,</span>	<span class="n">EV_SW</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SW_KEYPAD_SLIDE</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;MagSw2&quot;</span><span class="p">,</span>	<span class="n">EV_SW</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">mrst_gpio_keys</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buttons</span>	<span class="o">=</span> <span class="n">gpio_button</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rep</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nbuttons</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* will fill it after search */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">pb_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gpio-keys&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mrst_gpio_keys</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Shrink the non-existent buttons, register the gpio button</span>
<span class="cm"> * device if there is some</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pb_keys_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="o">*</span><span class="n">gb</span> <span class="o">=</span> <span class="n">gpio_button</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">good</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">num</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio_button</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_keys_button</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">get_gpio_by_name</span><span class="p">(</span><span class="n">gb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;info[%2d]: name = %s, gpio = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">gb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">good</span><span class="p">)</span>
			<span class="n">gb</span><span class="p">[</span><span class="n">good</span><span class="p">]</span> <span class="o">=</span> <span class="n">gb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">good</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">good</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mrst_gpio_keys</span><span class="p">.</span><span class="n">nbuttons</span> <span class="o">=</span> <span class="n">good</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb_device</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">pb_keys_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
