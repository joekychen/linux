<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › blackfin › mach-bf609 › pm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Blackfin bf609 power management</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2011 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;asm/dpmc.h&gt;</span>
<span class="cp">#include &lt;asm/pm.h&gt;</span>
<span class="cp">#include &lt;mach/pm.h&gt;</span>
<span class="cp">#include &lt;asm/blackfin.h&gt;</span>

<span class="cm">/***********************************************************/</span>
<span class="cm">/*                                                         */</span>
<span class="cm">/* Wakeup Actions for DPM_RESTORE                          */</span>
<span class="cm">/*                                                         */</span>
<span class="cm">/***********************************************************/</span>
<span class="cp">#define BITP_ROM_WUA_CHKHDR             24</span>
<span class="cp">#define BITP_ROM_WUA_DDRLOCK            7</span>
<span class="cp">#define BITP_ROM_WUA_DDRDLLEN           6</span>
<span class="cp">#define BITP_ROM_WUA_DDR                5</span>
<span class="cp">#define BITP_ROM_WUA_CGU                4</span>
<span class="cp">#define BITP_ROM_WUA_MEMBOOT            2</span>
<span class="cp">#define BITP_ROM_WUA_EN                 1</span>

<span class="cp">#define BITM_ROM_WUA_CHKHDR             (0xFF000000)</span>
<span class="cp">#define ENUM_ROM_WUA_CHKHDR_AD                  0xAD000000</span>

<span class="cp">#define BITM_ROM_WUA_DDRLOCK            (0x00000080)</span>
<span class="cp">#define BITM_ROM_WUA_DDRDLLEN           (0x00000040)</span>
<span class="cp">#define BITM_ROM_WUA_DDR                (0x00000020)</span>
<span class="cp">#define BITM_ROM_WUA_CGU                (0x00000010)</span>
<span class="cp">#define BITM_ROM_WUA_MEMBOOT            (0x00000002)</span>
<span class="cp">#define BITM_ROM_WUA_EN                 (0x00000001)</span>

<span class="cm">/***********************************************************/</span>
<span class="cm">/*                                                         */</span>
<span class="cm">/* Syscontrol                                              */</span>
<span class="cm">/*                                                         */</span>
<span class="cm">/***********************************************************/</span>
<span class="cp">#define BITP_ROM_SYSCTRL_CGU_LOCKINGEN  28    </span><span class="cm">/* unlocks CGU_CTL register */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_WUA_OVERRIDE   24</span>
<span class="cp">#define BITP_ROM_SYSCTRL_WUA_DDRDLLEN   20    </span><span class="cm">/* Saves the DDR DLL and PADS registers to the DPM registers */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_WUA_DDR        19    </span><span class="cm">/* Saves the DDR registers to the DPM registers */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_WUA_CGU        18    </span><span class="cm">/* Saves the CGU registers into DPM registers */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_WUA_DPMWRITE   17    </span><span class="cm">/* Saves the Syscontrol structure structure contents into DPM registers */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_WUA_EN         16    </span><span class="cm">/* reads current PLL and DDR configuration into structure */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_DDR_WRITE      13    </span><span class="cm">/* writes the DDR registers from Syscontrol structure for wakeup initialization of DDR */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_DDR_READ       12    </span><span class="cm">/* Read the DDR registers into the Syscontrol structure for storing prior to hibernate */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_CGU_AUTODIS    11    </span><span class="cm">/* Disables auto handling of UPDT and ALGN fields */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_CGU_CLKOUTSEL  7    </span><span class="cm">/* access CGU_CLKOUTSEL register */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_CGU_DIV        6    </span><span class="cm">/* access CGU_DIV register */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_CGU_STAT       5    </span><span class="cm">/* access CGU_STAT register */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_CGU_CTL        4    </span><span class="cm">/* access CGU_CTL register */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_CGU_RTNSTAT    2    </span><span class="cm">/* Update structure STAT field upon error */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_WRITE          1    </span><span class="cm">/* write registers */</span><span class="cp"></span>
<span class="cp">#define BITP_ROM_SYSCTRL_READ           0    </span><span class="cm">/* read registers */</span><span class="cp"></span>

<span class="cp">#define BITM_ROM_SYSCTRL_CGU_READ       (0x00000001)    </span><span class="cm">/* Read CGU registers */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_CGU_WRITE      (0x00000002)    </span><span class="cm">/* Write registers */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_CGU_RTNSTAT    (0x00000004)    </span><span class="cm">/* Update structure STAT field upon error or after a write operation */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_CGU_CTL        (0x00000010)    </span><span class="cm">/* Access CGU_CTL register */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_CGU_STAT       (0x00000020)    </span><span class="cm">/* Access CGU_STAT register */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_CGU_DIV        (0x00000040)    </span><span class="cm">/* Access CGU_DIV register */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_CGU_CLKOUTSEL  (0x00000080)    </span><span class="cm">/* Access CGU_CLKOUTSEL register */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_CGU_AUTODIS    (0x00000800)    </span><span class="cm">/* Disables auto handling of UPDT and ALGN fields */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_DDR_READ       (0x00001000)    </span><span class="cm">/* Reads the contents of the DDR registers and stores them into the structure */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_DDR_WRITE      (0x00002000)    </span><span class="cm">/* Writes the DDR registers from the structure, only really intented for wakeup functionality and not for full DDR configuration */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_WUA_EN         (0x00010000)    </span><span class="cm">/* Wakeup entry or exit opertation enable */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_WUA_DPMWRITE   (0x00020000)    </span><span class="cm">/* When set indicates a restore of the PLL and DDR is to be performed otherwise a save is required */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_WUA_CGU        (0x00040000)    </span><span class="cm">/* Only applicable for a PLL and DDR save operation to the DPM, saves the current settings if cleared or the contents of the structure if set */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_WUA_DDR        (0x00080000)    </span><span class="cm">/* Only applicable for a PLL and DDR save operation to the DPM, saves the current settings if cleared or the contents of the structure if set */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_WUA_DDRDLLEN   (0x00100000)    </span><span class="cm">/* Enables saving/restoring of the DDR DLLCTL register */</span><span class="cp"></span>
<span class="cp">#define BITM_ROM_SYSCTRL_WUA_OVERRIDE   (0x01000000)</span>
<span class="cp">#define BITM_ROM_SYSCTRL_CGU_LOCKINGEN  (0x10000000)    </span><span class="cm">/* Unlocks the CGU_CTL register */</span><span class="cp"></span>


<span class="cm">/* Structures for the syscontrol() function */</span>
<span class="k">struct</span> <span class="n">STRUCT_ROM_SYSCTRL</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">ulCGU_CTL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulCGU_STAT</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulCGU_DIV</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulCGU_CLKOUTSEL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulWUA_Flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulWUA_BootAddr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulWUA_User</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_CTL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_CFG</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_TR0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_TR1</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_TR2</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_MR</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_EMR1</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_EMR2</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_PADCTL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulDDR_DLLCTL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ulReserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bfin_pm_data</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">magic</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">resume_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bfin_pm_data</span> <span class="n">bf609_pm_data</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">STRUCT_ROM_SYSCTRL</span> <span class="n">configvalues</span><span class="p">;</span>
<span class="kt">uint32_t</span> <span class="n">dactionflags</span><span class="p">;</span>

<span class="cp">#define FUNC_ROM_SYSCONTROL 0xC8000080</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_data</span><span class="p">))</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="p">(</span><span class="o">*</span> <span class="k">const</span> <span class="n">bfrom_SysControl</span><span class="p">)(</span><span class="kt">uint32_t</span> <span class="n">action_flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">STRUCT_ROM_SYSCTRL</span> <span class="o">*</span><span class="n">settings</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reserved</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">FUNC_ROM_SYSCONTROL</span><span class="p">;</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="kt">void</span> <span class="n">bfin_cpu_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span> \
			<span class="s">&quot;.align 8;&quot;</span> \
			<span class="s">&quot;idle;&quot;</span> \
			<span class="o">:</span> <span class="o">:</span> \
			<span class="p">);</span>
<span class="p">}</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="kt">void</span> <span class="n">bfin_deepsleep</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dpm0_ctl</span><span class="p">;</span>

	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_WAKE_EN</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_WAKE_POL</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">dpm0_ctl</span> <span class="o">=</span> <span class="mh">0x00000008</span><span class="p">;</span>
	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_CTL</span><span class="p">,</span> <span class="n">dpm0_ctl</span><span class="p">);</span>
	<span class="n">SSYNC</span><span class="p">();</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span> \
			<span class="s">&quot;.align 8;&quot;</span> \
			<span class="s">&quot;idle;&quot;</span> \
			<span class="o">:</span> <span class="o">:</span> \
			<span class="p">);</span>
<span class="cp">#ifdef CONFIG_BFIN_PM_WAKEUP_TIME_BENCH</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;R0 = 0;&quot;</span>
		<span class="s">&quot;CYCLES = R0;&quot;</span>
		<span class="s">&quot;CYCLES2 = R0;&quot;</span>
		<span class="s">&quot;R0 = SYSCFG;&quot;</span>
		<span class="s">&quot;BITSET(R0, 1);&quot;</span>
		<span class="s">&quot;SYSCFG = R0;&quot;</span>
		<span class="o">:</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;R0&quot;</span>
	<span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="kt">void</span> <span class="n">bf609_ddr_sr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">bfin_read_DMC0_CTL</span><span class="p">();</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="n">bfin_write_DMC0_CTL</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bfin_read_DMC0_STAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="kt">void</span> <span class="n">bf609_ddr_sr_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bfin_read_DMC0_STAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">bfin_read_DMC0_CTL</span><span class="p">();</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8</span><span class="p">;</span>
	<span class="n">bfin_write_DMC0_CTL</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">bfin_read_DMC0_STAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="kt">void</span> <span class="n">bfin_hibernate_syscontrol</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">configvalues</span><span class="p">.</span><span class="n">ulWUA_Flags</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xAD000000</span> <span class="o">|</span> <span class="n">BITM_ROM_WUA_EN</span>
		<span class="o">|</span> <span class="n">BITM_ROM_WUA_CGU</span> <span class="o">|</span> <span class="n">BITM_ROM_WUA_DDR</span> <span class="o">|</span> <span class="n">BITM_ROM_WUA_DDRDLLEN</span><span class="p">);</span>

	<span class="n">dactionflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">BITM_ROM_SYSCTRL_WUA_EN</span>
		<span class="o">|</span> <span class="n">BITM_ROM_SYSCTRL_WUA_DPMWRITE</span> <span class="o">|</span> <span class="n">BITM_ROM_SYSCTRL_WUA_CGU</span>
		<span class="o">|</span> <span class="n">BITM_ROM_SYSCTRL_WUA_DDR</span> <span class="o">|</span> <span class="n">BITM_ROM_SYSCTRL_WUA_DDRDLLEN</span><span class="p">);</span>

	<span class="n">bfrom_SysControl</span><span class="p">(</span><span class="n">dactionflags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">configvalues</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_RESTORE5</span><span class="p">,</span> <span class="n">bfin_read32</span><span class="p">(</span><span class="n">DPM0_RESTORE5</span><span class="p">)</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="cp"># define SIC_SYSIRQ(irq)	(irq - (IRQ_CORETMR + 1))</span>
<span class="cp">#else</span>
<span class="cp"># define SIC_SYSIRQ(irq)	((irq) - IVG15)</span>
<span class="cp">#endif</span>
<span class="kt">void</span> <span class="n">bfin_hibernate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_WAKE_EN</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_WAKE_POL</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_PGCNTR</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_HIB_DIS</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hibernate: restore %x pgcnt %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bfin_read32</span><span class="p">(</span><span class="n">DPM0_RESTORE0</span><span class="p">),</span> <span class="n">bfin_read32</span><span class="p">(</span><span class="n">DPM0_PGCNTR</span><span class="p">));</span>

	<span class="n">bf609_hibernate</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">bf609_cpu_pm_enter</span><span class="p">(</span><span class="n">suspend_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wakeup_pol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM_BFIN_WAKE_PA15</span>
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">PA15WE</span><span class="p">;</span>
<span class="cp"># if CONFIG_PM_BFIN_WAKE_PA15_POL</span>
	<span class="n">wakeup_pol</span> <span class="o">|=</span> <span class="n">PA15WE</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_BFIN_WAKE_PB15</span>
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">PB15WE</span><span class="p">;</span>
<span class="cp"># if CONFIG_PM_BFIN_WAKE_PA15_POL</span>
	<span class="n">wakeup_pol</span> <span class="o">|=</span> <span class="n">PB15WE</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_BFIN_WAKE_PC15</span>
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">PC15WE</span><span class="p">;</span>
<span class="cp"># if CONFIG_PM_BFIN_WAKE_PC15_POL</span>
	<span class="n">wakeup_pol</span> <span class="o">|=</span> <span class="n">PC15WE</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_BFIN_WAKE_PD06</span>
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">PD06WE</span><span class="p">;</span>
<span class="cp"># if CONFIG_PM_BFIN_WAKE_PD06_POL</span>
	<span class="n">wakeup_pol</span> <span class="o">|=</span> <span class="n">PD06WE</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_BFIN_WAKE_PE12</span>
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">PE12WE</span><span class="p">;</span>
<span class="cp"># if CONFIG_PM_BFIN_WAKE_PE12_POL</span>
	<span class="n">wakeup_pol</span> <span class="o">|=</span> <span class="n">PE12WE</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_BFIN_WAKE_PG04</span>
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">PG04WE</span><span class="p">;</span>
<span class="cp"># if CONFIG_PM_BFIN_WAKE_PG04_POL</span>
	<span class="n">wakeup_pol</span> <span class="o">|=</span> <span class="n">PG04WE</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_BFIN_WAKE_PG13</span>
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">PG13WE</span><span class="p">;</span>
<span class="cp"># if CONFIG_PM_BFIN_WAKE_PG13_POL</span>
	<span class="n">wakeup_pol</span> <span class="o">|=</span> <span class="n">PG13WE</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_BFIN_WAKE_USB</span>
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">USBWE</span><span class="p">;</span>
<span class="cp"># if CONFIG_PM_BFIN_WAKE_USB_POL</span>
	<span class="n">wakeup_pol</span> <span class="o">|=</span> <span class="n">USBWE</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">irq_set_irq_wake</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Unable to get irq wake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">irq_set_irq_wake</span><span class="p">(</span><span class="mi">231</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Unable to get irq wake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">PM_SUSPEND_STANDBY</span><span class="p">)</span>
		<span class="n">bfin_deepsleep</span><span class="p">(</span><span class="n">wakeup</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">bfin_hibernate</span><span class="p">(</span><span class="n">wakeup</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">bf609_cpu_pm_prepare</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">bf609_cpu_pm_finish</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfin_cpu_pm_fns</span> <span class="n">bf609_cpu_pm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enter</span>          <span class="o">=</span> <span class="n">bf609_cpu_pm_enter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>        <span class="o">=</span> <span class="n">bf609_cpu_pm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finish</span>         <span class="o">=</span> <span class="n">bf609_cpu_pm_finish</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">test_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;gpio irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dpm0_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">wake_stat</span><span class="p">;</span>

	<span class="n">wake_stat</span> <span class="o">=</span> <span class="n">bfin_read32</span><span class="p">(</span><span class="n">DPM0_WAKE_STAT</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;enter %s wake stat %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wake_stat</span><span class="p">);</span>

	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">DPM0_WAKE_STAT</span><span class="p">,</span> <span class="n">wake_stat</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bf609_init_pm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

<span class="cp">#if CONFIG_PM_BFIN_WAKE_PE12</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">GPIO_PE12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Unable to get irq number for GPIO %d, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">GPIO_PE12</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">test_isr</span><span class="p">,</span> <span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span> <span class="s">&quot;gpiope12&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Unable to get irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_CGU_EVT</span><span class="p">,</span> <span class="n">dpm0_isr</span><span class="p">,</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span> <span class="s">&quot;cgu0 event&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Unable to get irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_DPM</span><span class="p">,</span> <span class="n">dpm0_isr</span><span class="p">,</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span> <span class="s">&quot;dpm0 event&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Unable to get irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bfin_cpu_pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bf609_cpu_pm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">bf609_init_pm</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
