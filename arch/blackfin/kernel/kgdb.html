<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › blackfin › kernel › kgdb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>kgdb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/blackfin/kernel/kgdb.c - Blackfin kgdb pieces</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005-2008 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ptrace.h&gt;		</span><span class="cm">/* for linux pt_regs struct */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/kgdb.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="kt">void</span> <span class="nf">pt_regs_to_gdb_regs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">gdb_regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R2</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r2</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R3</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r3</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R4</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r4</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R5</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r5</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R6</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r6</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R7</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r7</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P2</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P3</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">p3</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P4</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">p4</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P5</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">p5</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_SP</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_FP</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_I0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">i0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_I1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">i1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_I2</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">i2</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_I3</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">i3</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_M0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">m0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_M1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_M2</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_M3</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">m3</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_B0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_B1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">b1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_B2</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">b2</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_B3</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">b3</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_L0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">l0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_L1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_L2</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_L3</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_A0_DOT_X</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0x</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_A0_DOT_W</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0w</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_A1_DOT_X</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1x</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_A1_DOT_W</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1w</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_ASTAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">astat</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETS</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">rets</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LC0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lc0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LT0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lt0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LB0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lb0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LC1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lc1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LT1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lt1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LB1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lb1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_CYCLES</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_CYCLES2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_USP</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">usp</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_SEQSTAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">seqstat</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_SYSCFG</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">syscfg</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETI</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETX</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">retx</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETN</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">retn</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETE</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">rete</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_PC</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_CC</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">astat</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_EXTRA1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_EXTRA2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_EXTRA3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_IPEND</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ipend</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Extracts ebp, esp and eip values understandable by gdb from the values</span>
<span class="cm"> * saved by switch_to.</span>
<span class="cm"> * thread.esp points to ebp. flags and ebp are pushed in switch_to hence esp</span>
<span class="cm"> * prior to entering switch_to is 8 greater than the value that is saved.</span>
<span class="cm"> * If switch_to changes, change following code appropriately.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sleeping_thread_to_gdb_regs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">gdb_regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_SP</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">ksp</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_PC</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_SEQSTAT</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">seqstat</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gdb_regs_to_pt_regs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">gdb_regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r2</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R2</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r3</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R3</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r4</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R4</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r5</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R5</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r6</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R6</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r7</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_R7</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">p0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P2</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">p3</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P3</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">p4</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P4</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">p5</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_P5</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_FP</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">i0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_I0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">i1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_I1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">i2</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_I2</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">i3</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_I3</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">m0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_M0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_M1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_M2</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">m3</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_M3</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">b0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_B0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">b1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_B1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">b2</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_B2</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">b3</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_B3</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">l0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_L0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">l1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_L1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">l2</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_L2</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">l3</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_L3</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0x</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_A0_DOT_X</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0w</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_A0_DOT_W</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1x</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_A1_DOT_X</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1w</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_A1_DOT_W</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">rets</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETS</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lc0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LC0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lt0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LT0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lb0</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LB0</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lc1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LC1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lt1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LT1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lb1</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_LB1</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">usp</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_USP</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">syscfg</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_SYSCFG</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">retx</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETX</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">retn</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETN</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">rete</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_RETE</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">gdb_regs</span><span class="p">[</span><span class="n">BFIN_PC</span><span class="p">];</span>

<span class="cp">#if 0</span><span class="c">				/* can&#39;t change these */</span>
<span class="c">	regs-&gt;astat = gdb_regs[BFIN_ASTAT];</span>
<span class="c">	regs-&gt;seqstat = gdb_regs[BFIN_SEQSTAT];</span>
<span class="c">	regs-&gt;ipend = gdb_regs[BFIN_IPEND];</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hw_breakpoint</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">occupied</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skip</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataacc</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">breakinfo</span><span class="p">[</span><span class="n">HW_WATCHPOINT_NUM</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_set_hw_break</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">kgdb_bptype</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">breakno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bfin_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dataacc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BP_HARDWARE_BREAKPOINT</span>:
		<span class="n">bfin_type</span> <span class="o">=</span> <span class="n">TYPE_INST_WATCHPOINT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BP_WRITE_WATCHPOINT</span>:
		<span class="n">dataacc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bfin_type</span> <span class="o">=</span> <span class="n">TYPE_DATA_WATCHPOINT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BP_READ_WATCHPOINT</span>:
		<span class="n">dataacc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">bfin_type</span> <span class="o">=</span> <span class="n">TYPE_DATA_WATCHPOINT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BP_ACCESS_WATCHPOINT</span>:
		<span class="n">dataacc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">bfin_type</span> <span class="o">=</span> <span class="n">TYPE_DATA_WATCHPOINT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Because hardware data watchpoint impelemented in current</span>
<span class="cm">	 * Blackfin can not trigger an exception event as the hardware</span>
<span class="cm">	 * instrction watchpoint does, we ignaore all data watch point here.</span>
<span class="cm">	 * They can be turned on easily after future blackfin design</span>
<span class="cm">	 * supports this feature.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">breakno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">breakno</span> <span class="o">&lt;</span> <span class="n">HW_INST_WATCHPOINT_NUM</span><span class="p">;</span> <span class="n">breakno</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfin_type</span> <span class="o">==</span> <span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">type</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">occupied</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">occupied</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">dataacc</span> <span class="o">=</span> <span class="n">dataacc</span><span class="p">;</span>
			<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_remove_hw_break</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">kgdb_bptype</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">breakno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bfin_type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BP_HARDWARE_BREAKPOINT</span>:
		<span class="n">bfin_type</span> <span class="o">=</span> <span class="n">TYPE_INST_WATCHPOINT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BP_WRITE_WATCHPOINT</span>:
	<span class="k">case</span> <span class="n">BP_READ_WATCHPOINT</span>:
	<span class="k">case</span> <span class="n">BP_ACCESS_WATCHPOINT</span>:
		<span class="n">bfin_type</span> <span class="o">=</span> <span class="n">TYPE_DATA_WATCHPOINT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">breakno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">breakno</span> <span class="o">&lt;</span> <span class="n">HW_WATCHPOINT_NUM</span><span class="p">;</span> <span class="n">breakno</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfin_type</span> <span class="o">==</span> <span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">type</span>
			<span class="o">&amp;&amp;</span> <span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">occupied</span>
			<span class="o">&amp;&amp;</span> <span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">occupied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_remove_all_hw_break</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">breakno</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_breakpoint</span><span class="p">)</span><span class="o">*</span><span class="n">HW_WATCHPOINT_NUM</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">breakno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">breakno</span> <span class="o">&lt;</span> <span class="n">HW_INST_WATCHPOINT_NUM</span><span class="p">;</span> <span class="n">breakno</span><span class="o">++</span><span class="p">)</span>
		<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_INST_WATCHPOINT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">breakno</span> <span class="o">&lt;</span> <span class="n">HW_WATCHPOINT_NUM</span><span class="p">;</span> <span class="n">breakno</span><span class="o">++</span><span class="p">)</span>
		<span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_DATA_WATCHPOINT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_correct_hw_break</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">breakno</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wpiactl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wpdactl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_wp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">breakno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">breakno</span> <span class="o">&lt;</span> <span class="n">HW_WATCHPOINT_NUM</span><span class="p">;</span> <span class="n">breakno</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable_wp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">breakno</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">wpiactl</span> <span class="o">|=</span> <span class="n">WPIAEN0</span><span class="o">|</span><span class="n">WPICNTEN0</span><span class="p">;</span>
				<span class="n">bfin_write_WPIA0</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">bfin_write_WPIACNT0</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span>
					<span class="o">+</span> <span class="n">breakinfo</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">wpiactl</span> <span class="o">|=</span> <span class="n">WPIAEN1</span><span class="o">|</span><span class="n">WPICNTEN1</span><span class="p">;</span>
				<span class="n">bfin_write_WPIA1</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">bfin_write_WPIACNT1</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span>
					<span class="o">+</span> <span class="n">breakinfo</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">wpiactl</span> <span class="o">|=</span> <span class="n">WPIAEN2</span><span class="o">|</span><span class="n">WPICNTEN2</span><span class="p">;</span>
				<span class="n">bfin_write_WPIA2</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">bfin_write_WPIACNT2</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span>
					<span class="o">+</span> <span class="n">breakinfo</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">wpiactl</span> <span class="o">|=</span> <span class="n">WPIAEN3</span><span class="o">|</span><span class="n">WPICNTEN3</span><span class="p">;</span>
				<span class="n">bfin_write_WPIA3</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">bfin_write_WPIACNT3</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span>
					<span class="o">+</span> <span class="n">breakinfo</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">wpiactl</span> <span class="o">|=</span> <span class="n">WPIAEN4</span><span class="o">|</span><span class="n">WPICNTEN4</span><span class="p">;</span>
				<span class="n">bfin_write_WPIA4</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">bfin_write_WPIACNT4</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span>
					<span class="o">+</span> <span class="n">breakinfo</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">wpiactl</span> <span class="o">|=</span> <span class="n">WPIAEN5</span><span class="o">|</span><span class="n">WPICNTEN5</span><span class="p">;</span>
				<span class="n">bfin_write_WPIA5</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">bfin_write_WPIACNT5</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span>
					<span class="o">+</span> <span class="n">breakinfo</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">wpdactl</span> <span class="o">|=</span> <span class="n">WPDAEN0</span><span class="o">|</span><span class="n">WPDCNTEN0</span><span class="o">|</span><span class="n">WPDSRC0</span><span class="p">;</span>
				<span class="n">wpdactl</span> <span class="o">|=</span> <span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">dataacc</span>
					<span class="o">&lt;&lt;</span> <span class="n">WPDACC0_OFFSET</span><span class="p">;</span>
				<span class="n">bfin_write_WPDA0</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">bfin_write_WPDACNT0</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span>
					<span class="o">+</span> <span class="n">breakinfo</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">wpdactl</span> <span class="o">|=</span> <span class="n">WPDAEN1</span><span class="o">|</span><span class="n">WPDCNTEN1</span><span class="o">|</span><span class="n">WPDSRC1</span><span class="p">;</span>
				<span class="n">wpdactl</span> <span class="o">|=</span> <span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">dataacc</span>
					<span class="o">&lt;&lt;</span> <span class="n">WPDACC1_OFFSET</span><span class="p">;</span>
				<span class="n">bfin_write_WPDA1</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">bfin_write_WPDACNT1</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">count</span>
					<span class="o">+</span> <span class="n">breakinfo</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="cm">/* Should enable WPPWR bit first before set any other</span>
<span class="cm">	 * WPIACTL and WPDACTL bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_wp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_write_WPIACTL</span><span class="p">(</span><span class="n">WPPWR</span><span class="p">);</span>
		<span class="n">CSYNC</span><span class="p">();</span>
		<span class="n">bfin_write_WPIACTL</span><span class="p">(</span><span class="n">wpiactl</span><span class="o">|</span><span class="n">WPPWR</span><span class="p">);</span>
		<span class="n">bfin_write_WPDACTL</span><span class="p">(</span><span class="n">wpdactl</span><span class="p">);</span>
		<span class="n">CSYNC</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_disable_hw_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable hardware debugging while we are in kgdb */</span>
	<span class="n">bfin_write_WPIACTL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">bfin_write_WPDACTL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">CSYNC</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="kt">void</span> <span class="nf">kgdb_passive_cpu_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kgdb_nmicallback</span><span class="p">(</span><span class="n">raw_smp_processor_id</span><span class="p">(),</span> <span class="n">get_irq_regs</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kgdb_roundup_cpus</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smp_call_function</span><span class="p">(</span><span class="n">kgdb_passive_cpu_callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kgdb_roundup_cpu</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">kgdb_passive_cpu_callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_IPIPE</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kgdb_arch_imask</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">kgdb_post_primary_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">e_vector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kgdb_single_step</span><span class="p">)</span>
		<span class="n">preempt_enable</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_IPIPE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kgdb_arch_imask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpu_pda</span><span class="p">[</span><span class="n">raw_smp_processor_id</span><span class="p">()].</span><span class="n">ex_imask</span> <span class="o">=</span> <span class="n">kgdb_arch_imask</span><span class="p">;</span>
		<span class="n">kgdb_arch_imask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kgdb_arch_handle_exception</span><span class="p">(</span><span class="kt">int</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">signo</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">err_code</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">remcom_in_buffer</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">remcom_out_buffer</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newPC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">remcom_in_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">kgdb_contthread</span> <span class="o">&amp;&amp;</span> <span class="n">kgdb_contthread</span> <span class="o">!=</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">remcom_out_buffer</span><span class="p">,</span> <span class="s">&quot;E00&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kgdb_contthread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* try to read optional parameter, pc unchanged if no parm */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">remcom_in_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kgdb_hex2long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">retx</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">newPC</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">retx</span><span class="p">;</span>

		<span class="cm">/* clear the trace bit */</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">syscfg</span> <span class="o">&amp;=</span> <span class="mh">0xfffffffe</span><span class="p">;</span>

		<span class="cm">/* set the trace bit if we&#39;re stepping */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remcom_in_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;s&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">syscfg</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">kgdb_single_step</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ipend</span><span class="p">;</span>
			<span class="n">kgdb_single_step</span> <span class="o">&gt;&gt;=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">kgdb_single_step</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">kgdb_single_step</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* i indicate event priority of current stopped instruction</span>
<span class="cm">			 * user space instruction is 0, IVG15 is 1, IVTMR is 10.</span>
<span class="cm">			 * kgdb_single_step &gt; 0 means in single step mode</span>
<span class="cm">			 */</span>
			<span class="n">kgdb_single_step</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">preempt_disable</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_IPIPE</span>
			<span class="n">kgdb_arch_imask</span> <span class="o">=</span> <span class="n">cpu_pda</span><span class="p">[</span><span class="n">raw_smp_processor_id</span><span class="p">()].</span><span class="n">ex_imask</span><span class="p">;</span>
			<span class="n">cpu_pda</span><span class="p">[</span><span class="n">raw_smp_processor_id</span><span class="p">()].</span><span class="n">ex_imask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">bfin_correct_hw_break</span><span class="p">();</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/* switch */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* this means that we do not want to exit from the handler */</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kgdb_arch</span> <span class="n">arch_kgdb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gdb_bpt_instr</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xa1</span><span class="p">},</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">KGDB_HW_BREAKPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_hw_breakpoint</span> <span class="o">=</span> <span class="n">bfin_set_hw_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_hw_breakpoint</span> <span class="o">=</span> <span class="n">bfin_remove_hw_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hw_break</span> <span class="o">=</span> <span class="n">bfin_disable_hw_debug</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_all_hw_break</span> <span class="o">=</span> <span class="n">bfin_remove_all_hw_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">correct_hw_break</span> <span class="o">=</span> <span class="n">bfin_correct_hw_break</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IN_MEM(addr, size, l1_addr, l1_size) \</span>
<span class="cp">({ \</span>
<span class="cp">	unsigned long __addr = (unsigned long)(addr); \</span>
<span class="cp">	(l1_size &amp;&amp; __addr &gt;= l1_addr &amp;&amp; __addr + (size) &lt;= l1_addr + l1_size); \</span>
<span class="cp">})</span>
<span class="cp">#define ASYNC_BANK_SIZE \</span>
<span class="cp">	(ASYNC_BANK0_SIZE + ASYNC_BANK1_SIZE + \</span>
<span class="cp">	 ASYNC_BANK2_SIZE + ASYNC_BANK3_SIZE)</span>

<span class="kt">int</span> <span class="nf">kgdb_validate_break_address</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0x1000</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">BREAK_INSTR_SIZE</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">physical_mem_end</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IN_MEM</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">BREAK_INSTR_SIZE</span><span class="p">,</span> <span class="n">ASYNC_BANK0_BASE</span><span class="p">,</span> <span class="n">ASYNC_BANK_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">IN_MEM</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">BREAK_INSTR_SIZE</span><span class="p">,</span> <span class="n">L1_CODE_START</span><span class="p">,</span> <span class="n">L1_CODE_LENGTH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">IN_MEM</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">BREAK_INSTR_SIZE</span><span class="p">,</span> <span class="n">COREB_L1_CODE_START</span><span class="p">,</span> <span class="n">L1_CODE_LENGTH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IN_MEM</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">BREAK_INSTR_SIZE</span><span class="p">,</span> <span class="n">L2_START</span><span class="p">,</span> <span class="n">L2_LENGTH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kgdb_arch_set_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">retx</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kgdb_arch_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kgdb_single_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IPIPE</span>
	<span class="n">kgdb_arch_imask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">bfin_remove_all_hw_break</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kgdb_arch_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
