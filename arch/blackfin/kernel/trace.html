<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › blackfin › kernel › trace.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>trace.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* provide some functions which dump the trace buffer, in a nice way for people</span>
<span class="cm"> * to read it, and understand what is going on</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2004-2010 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/thread_info.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/oom.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/trace.h&gt;</span>
<span class="cp">#include &lt;asm/fixed_code.h&gt;</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>
<span class="cp">#include &lt;asm/irq_handler.h&gt;</span>
<span class="cp">#include &lt;asm/pda.h&gt;</span>

<span class="kt">void</span> <span class="nf">decode_address</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KALLSYMS</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">symsize</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symname</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">modname</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">delim</span> <span class="o">=</span> <span class="s">&quot;:&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">namebuf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;0x%08lx&gt; &quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_KALLSYMS</span>
	<span class="cm">/* look up the address and see if we are in kernel space */</span>
	<span class="n">symname</span> <span class="o">=</span> <span class="n">kallsyms_lookup</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">symsize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">modname</span><span class="p">,</span> <span class="n">namebuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symname</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* yeah! kernel space! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modname</span><span class="p">)</span>
			<span class="n">modname</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;{ %s%s%s%s + 0x%lx }&quot;</span><span class="p">,</span>
			<span class="n">delim</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="n">symname</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">FIXED_CODE_START</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">FIXED_CODE_END</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Problem in fixed code section? */</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* Maybe fixed code section */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="n">CONFIG_BOOT_LOAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Problem somewhere before the kernel start address */</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* Maybe null pointer? */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">COREMMR_BASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* core mmrs */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">SYSMMR_BASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* system mmrs */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">L1_ROM_START</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">L1_ROM_START</span> <span class="o">+</span> <span class="n">L1_ROM_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* on-chip L1 ROM */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">L1_SCRATCH_START</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">L1_SCRATCH_START</span> <span class="o">+</span> <span class="n">L1_SCRATCH_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* on-chip scratchpad */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">physical_mem_end</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">ASYNC_BANK0_BASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* unconnected memory */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">ASYNC_BANK3_BASE</span> <span class="o">+</span> <span class="n">ASYNC_BANK3_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">BOOT_ROM_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* reserved memory */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">L1_DATA_A_START</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">L1_DATA_A_START</span> <span class="o">+</span> <span class="n">L1_DATA_A_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* on-chip Data Bank A */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">L1_DATA_B_START</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">L1_DATA_B_START</span> <span class="o">+</span> <span class="n">L1_DATA_B_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* on-chip Data Bank B */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t walk any of the vmas if we are oopsing, it has been known</span>
<span class="cm">	 * to cause problems - corrupt vmas (kernel crashes) cause double faults</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oops_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* kernel dynamic memory (maybe user-space) */&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* looks like we&#39;re off in user-land, so let&#39;s walk all the</span>
<span class="cm">	 * mappings of all our processes and see if we can&#39;t be a whee</span>
<span class="cm">	 * bit more specific</span>
<span class="cm">	 */</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">);</span>
	<span class="n">for_each_process</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">find_lock_task_mm</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mm</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">down_read_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">__continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mm_rb</span><span class="p">);</span> <span class="n">n</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>

			<span class="n">vma</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span><span class="p">,</span> <span class="n">vm_rb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">_tmpbuf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">d_name</span> <span class="o">=</span> <span class="n">d_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span> <span class="n">_tmpbuf</span><span class="p">,</span>
						      <span class="k">sizeof</span><span class="p">(</span><span class="n">_tmpbuf</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">d_name</span><span class="p">))</span>
						<span class="n">name</span> <span class="o">=</span> <span class="n">d_name</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* FLAT does not have its text aligned to the start of</span>
<span class="cm">				 * the map while FDPIC ELF does ...</span>
<span class="cm">				 */</span>

				<span class="cm">/* before we can check flat/fdpic, we need to</span>
<span class="cm">				 * make sure current is valid</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current</span> <span class="o">&gt;=</span> <span class="n">FIXED_CODE_START</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">address</span> <span class="o">&gt;</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_code</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_code</span><span class="p">))</span>
						<span class="n">offset</span> <span class="o">=</span> <span class="n">address</span> <span class="o">-</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_code</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">+</span>
							 <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

					<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[ %s + 0x%lx ]&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[ %s vma:0x%lx-0x%lx]&quot;</span><span class="p">,</span>
						<span class="n">name</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">);</span>

				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
				<span class="n">task_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[ %s ] dynamic memory&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
<span class="nl">__continue:</span>
		<span class="n">task_unlock</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * we were unable to find this address anywhere,</span>
<span class="cm">	 * or some MMs were skipped because they were in use.</span>
<span class="cm">	 */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/* kernel dynamic memory */&quot;</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define EXPAND_LEN ((1 &lt;&lt; CONFIG_DEBUG_BFIN_HWTRACE_EXPAND_LEN) * 256 - 1)</span>

<span class="cm">/*</span>
<span class="cm"> * Similar to get_user, do some address checking, then dereference</span>
<span class="cm"> * Return true on success, false on bad address</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">get_mem16</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">address</span><span class="p">;</span>

	<span class="cm">/* Check for odd addresses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bfin_mem_access_type</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFIN_MEM_ACCESS_CORE</span>:
	<span class="k">case</span> <span class="n">BFIN_MEM_ACCESS_CORE_ONLY</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">address</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFIN_MEM_ACCESS_DMA</span>:
		<span class="n">dma_memcpy</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFIN_MEM_ACCESS_ITEST</span>:
		<span class="n">isram_memcpy</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* invalid access */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">get_instruction</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">opcode0</span><span class="p">,</span> <span class="n">opcode1</span><span class="p">;</span>

	<span class="cm">/* Check for odd addresses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* MMR region will never have instructions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">SYSMMR_BASE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Scratchpad will never have instructions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">L1_SCRATCH_START</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">L1_SCRATCH_START</span> <span class="o">+</span> <span class="n">L1_SCRATCH_LENGTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Data banks will never have instructions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">BOOT_ROM_START</span> <span class="o">+</span> <span class="n">BOOT_ROM_LENGTH</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">L1_CODE_START</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_mem16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opcode0</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* was this a 32-bit instruction? If so, get the next 16 bits */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">opcode0</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_mem16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opcode1</span><span class="p">,</span> <span class="n">address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">opcode1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">opcode0</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_DEBUG_BFIN_HWTRACE_ON)</span>
<span class="cm">/*</span>
<span class="cm"> * decode the instruction if we are printing out the trace, as it</span>
<span class="cm"> * makes things easier to follow, without running it through objdump</span>
<span class="cm"> * Decode the change of flow, and the common load/store instructions</span>
<span class="cm"> * which are the main cause for faults, and discontinuities in the trace</span>
<span class="cm"> * buffer.</span>
<span class="cm"> */</span>

<span class="cp">#define ProgCtrl_opcode         0x0000</span>
<span class="cp">#define ProgCtrl_poprnd_bits    0</span>
<span class="cp">#define ProgCtrl_poprnd_mask    0xf</span>
<span class="cp">#define ProgCtrl_prgfunc_bits   4</span>
<span class="cp">#define ProgCtrl_prgfunc_mask   0xf</span>
<span class="cp">#define ProgCtrl_code_bits      8</span>
<span class="cp">#define ProgCtrl_code_mask      0xff</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_ProgCtrl_0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">poprnd</span>  <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">ProgCtrl_poprnd_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ProgCtrl_poprnd_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">prgfunc</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">ProgCtrl_prgfunc_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ProgCtrl_prgfunc_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;NOP&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RTS&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RTI&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RTX&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RTN&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RTE&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;IDLE&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CSYNC&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;SSYNC&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">poprnd</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;EMUEXCPT&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CLI R%i&quot;</span><span class="p">,</span> <span class="n">poprnd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;STI R%i&quot;</span><span class="p">,</span> <span class="n">poprnd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;JUMP (P%i)&quot;</span><span class="p">,</span> <span class="n">poprnd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CALL (P%i)&quot;</span><span class="p">,</span> <span class="n">poprnd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CALL (PC + P%i)&quot;</span><span class="p">,</span> <span class="n">poprnd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;JUMP (PC + P%i&quot;</span><span class="p">,</span> <span class="n">poprnd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;RAISE %i&quot;</span><span class="p">,</span> <span class="n">poprnd</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prgfunc</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;EXCPT %i&quot;</span><span class="p">,</span> <span class="n">poprnd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;0x%04x&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#define BRCC_opcode             0x1000</span>
<span class="cp">#define BRCC_offset_bits        0</span>
<span class="cp">#define BRCC_offset_mask        0x3ff</span>
<span class="cp">#define BRCC_B_bits             10</span>
<span class="cp">#define BRCC_B_mask             0x1</span>
<span class="cp">#define BRCC_T_bits             11</span>
<span class="cp">#define BRCC_T_mask             0x1</span>
<span class="cp">#define BRCC_code_bits          12</span>
<span class="cp">#define BRCC_code_mask          0xf</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_BRCC_0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">B</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">BRCC_B_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BRCC_B_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">T</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">BRCC_T_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BRCC_T_mask</span><span class="p">);</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;IF %sCC JUMP pcrel %s&quot;</span><span class="p">,</span> <span class="n">T</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;!&quot;</span><span class="p">,</span> <span class="n">B</span> <span class="o">?</span> <span class="s">&quot;(BP)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CALLa_opcode    0xe2000000</span>
<span class="cp">#define CALLa_addr_bits 0</span>
<span class="cp">#define CALLa_addr_mask 0xffffff</span>
<span class="cp">#define CALLa_S_bits    24</span>
<span class="cp">#define CALLa_S_mask    0x1</span>
<span class="cp">#define CALLa_code_bits 25</span>
<span class="cp">#define CALLa_code_mask 0x7f</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_CALLa_0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">S</span>   <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">CALLa_S_bits</span> <span class="o">-</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CALLa_S_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;CALL pcrel&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;JUMP.L&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define LoopSetup_opcode                0xe0800000</span>
<span class="cp">#define LoopSetup_eoffset_bits          0</span>
<span class="cp">#define LoopSetup_eoffset_mask          0x3ff</span>
<span class="cp">#define LoopSetup_dontcare_bits         10</span>
<span class="cp">#define LoopSetup_dontcare_mask         0x3</span>
<span class="cp">#define LoopSetup_reg_bits              12</span>
<span class="cp">#define LoopSetup_reg_mask              0xf</span>
<span class="cp">#define LoopSetup_soffset_bits          16</span>
<span class="cp">#define LoopSetup_soffset_mask          0xf</span>
<span class="cp">#define LoopSetup_c_bits                20</span>
<span class="cp">#define LoopSetup_c_mask                0x1</span>
<span class="cp">#define LoopSetup_rop_bits              21</span>
<span class="cp">#define LoopSetup_rop_mask              0x3</span>
<span class="cp">#define LoopSetup_code_bits             23</span>
<span class="cp">#define LoopSetup_code_mask             0x1ff</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_LoopSetup_0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span>   <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LoopSetup_c_bits</span><span class="p">)</span>   <span class="o">&amp;</span> <span class="n">LoopSetup_c_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LoopSetup_reg_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LoopSetup_reg_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rop</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LoopSetup_rop_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LoopSetup_rop_mask</span><span class="p">);</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;LSETUP &lt;&gt; LC%i&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rop</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;= P%i&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rop</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; &gt;&gt; 0x1&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DspLDST_opcode          0x9c00</span>
<span class="cp">#define DspLDST_reg_bits        0</span>
<span class="cp">#define DspLDST_reg_mask        0x7</span>
<span class="cp">#define DspLDST_i_bits          3</span>
<span class="cp">#define DspLDST_i_mask          0x3</span>
<span class="cp">#define DspLDST_m_bits          5</span>
<span class="cp">#define DspLDST_m_mask          0x3</span>
<span class="cp">#define DspLDST_aop_bits        7</span>
<span class="cp">#define DspLDST_aop_mask        0x3</span>
<span class="cp">#define DspLDST_W_bits          9</span>
<span class="cp">#define DspLDST_W_mask          0x1</span>
<span class="cp">#define DspLDST_code_bits       10</span>
<span class="cp">#define DspLDST_code_mask       0x3f</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_dspLDST_0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span>   <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">DspLDST_i_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DspLDST_i_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">m</span>   <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">DspLDST_m_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DspLDST_m_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">W</span>   <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">DspLDST_W_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DspLDST_W_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">aop</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">DspLDST_aop_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DspLDST_aop_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">DspLDST_reg_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DspLDST_reg_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;R%i&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; = &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;.L = &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;.W = &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;[ I%i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aop</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;++ ]&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;-- ]&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; = R%i&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;.L = &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;.W = &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define LDST_opcode             0x9000</span>
<span class="cp">#define LDST_reg_bits           0</span>
<span class="cp">#define LDST_reg_mask           0x7</span>
<span class="cp">#define LDST_ptr_bits           3</span>
<span class="cp">#define LDST_ptr_mask           0x7</span>
<span class="cp">#define LDST_Z_bits             6</span>
<span class="cp">#define LDST_Z_mask             0x1</span>
<span class="cp">#define LDST_aop_bits           7</span>
<span class="cp">#define LDST_aop_mask           0x3</span>
<span class="cp">#define LDST_W_bits             9</span>
<span class="cp">#define LDST_W_mask             0x1</span>
<span class="cp">#define LDST_sz_bits            10</span>
<span class="cp">#define LDST_sz_mask            0x3</span>
<span class="cp">#define LDST_code_bits          12</span>
<span class="cp">#define LDST_code_mask          0xf</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_LDST_0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">Z</span>   <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDST_Z_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDST_Z_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">W</span>   <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDST_W_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDST_W_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sz</span>  <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDST_sz_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDST_sz_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">aop</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDST_aop_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDST_aop_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDST_reg_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDST_reg_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDST_ptr_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDST_ptr_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s%i = &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">Z</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;P&quot;</span> <span class="o">:</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;W&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;[P%i&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aop</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;++&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;--&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;]&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; = %s%i &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">Z</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;P&quot;</span> <span class="o">:</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Z</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; (X)&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; (Z)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define LDSTii_opcode           0xa000</span>
<span class="cp">#define LDSTii_reg_bit          0</span>
<span class="cp">#define LDSTii_reg_mask         0x7</span>
<span class="cp">#define LDSTii_ptr_bit          3</span>
<span class="cp">#define LDSTii_ptr_mask         0x7</span>
<span class="cp">#define LDSTii_offset_bit       6</span>
<span class="cp">#define LDSTii_offset_mask      0xf</span>
<span class="cp">#define LDSTii_op_bit           10</span>
<span class="cp">#define LDSTii_op_mask          0x3</span>
<span class="cp">#define LDSTii_W_bit            12</span>
<span class="cp">#define LDSTii_W_mask           0x1</span>
<span class="cp">#define LDSTii_code_bit         13</span>
<span class="cp">#define LDSTii_code_mask        0x7</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_LDSTii_0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTii_reg_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDSTii_reg_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTii_ptr_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDSTii_ptr_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTii_offset_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDSTii_offset_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">op</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTii_op_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDSTii_op_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">W</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTii_W_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDSTii_W_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s%i = %s[P%i + %i]&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="s">&quot;R&quot;</span> <span class="o">:</span> <span class="s">&quot;P&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			<span class="n">op</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;W&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;(Z)&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;(X)&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s[P%i + %i] = %s%i&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;W&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">,</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="s">&quot;P&quot;</span> <span class="o">:</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define LDSTidxI_opcode         0xe4000000</span>
<span class="cp">#define LDSTidxI_offset_bits    0</span>
<span class="cp">#define LDSTidxI_offset_mask    0xffff</span>
<span class="cp">#define LDSTidxI_reg_bits       16</span>
<span class="cp">#define LDSTidxI_reg_mask       0x7</span>
<span class="cp">#define LDSTidxI_ptr_bits       19</span>
<span class="cp">#define LDSTidxI_ptr_mask       0x7</span>
<span class="cp">#define LDSTidxI_sz_bits        22</span>
<span class="cp">#define LDSTidxI_sz_mask        0x3</span>
<span class="cp">#define LDSTidxI_Z_bits         24</span>
<span class="cp">#define LDSTidxI_Z_mask         0x1</span>
<span class="cp">#define LDSTidxI_W_bits         25</span>
<span class="cp">#define LDSTidxI_W_mask         0x1</span>
<span class="cp">#define LDSTidxI_code_bits      26</span>
<span class="cp">#define LDSTidxI_code_mask      0x3f</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_LDSTidxI_0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">Z</span>      <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTidxI_Z_bits</span><span class="p">)</span>      <span class="o">&amp;</span> <span class="n">LDSTidxI_Z_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">W</span>      <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTidxI_W_bits</span><span class="p">)</span>      <span class="o">&amp;</span> <span class="n">LDSTidxI_W_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sz</span>     <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTidxI_sz_bits</span><span class="p">)</span>     <span class="o">&amp;</span> <span class="n">LDSTidxI_sz_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span>    <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTidxI_reg_bits</span><span class="p">)</span>    <span class="o">&amp;</span> <span class="n">LDSTidxI_reg_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ptr</span>    <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTidxI_ptr_bits</span><span class="p">)</span>    <span class="o">&amp;</span> <span class="n">LDSTidxI_ptr_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="n">LDSTidxI_offset_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LDSTidxI_offset_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s%i = &quot;</span><span class="p">,</span> <span class="n">sz</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">Z</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;P&quot;</span> <span class="o">:</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;W&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;[P%i + %s0x%x]&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x20</span> <span class="o">?</span> <span class="s">&quot;-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Z</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;(X)&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;(Z)&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;= %s%i&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">Z</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;P&quot;</span> <span class="o">:</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_opcode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_BUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">BFIN_BUG_OPCODE</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;BUG&quot;</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">==</span> <span class="n">ProgCtrl_opcode</span><span class="p">)</span>
		<span class="n">decode_ProgCtrl_0</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">==</span> <span class="n">BRCC_opcode</span><span class="p">)</span>
		<span class="n">decode_BRCC_0</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x2000</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;JUMP.S&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xfe000000</span><span class="p">)</span> <span class="o">==</span> <span class="n">CALLa_opcode</span><span class="p">)</span>
		<span class="n">decode_CALLa_0</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xff8000C0</span><span class="p">)</span> <span class="o">==</span> <span class="n">LoopSetup_opcode</span><span class="p">)</span>
		<span class="n">decode_LoopSetup_0</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xfffffc00</span><span class="p">)</span> <span class="o">==</span> <span class="n">DspLDST_opcode</span><span class="p">)</span>
		<span class="n">decode_dspLDST_0</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">==</span> <span class="n">LDST_opcode</span><span class="p">)</span>
		<span class="n">decode_LDST_0</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xffffe000</span><span class="p">)</span> <span class="o">==</span> <span class="n">LDSTii_opcode</span><span class="p">)</span>
		<span class="n">decode_LDSTii_0</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xfc000000</span><span class="p">)</span> <span class="o">==</span> <span class="n">LDSTidxI_opcode</span><span class="p">)</span>
		<span class="n">decode_LDSTidxI_0</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;0x%08x&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;0x%04x&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define BIT_MULTI_INS 0x08000000</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_instruction</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">decode_opcode</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>

	<span class="cm">/* If things are a 32-bit instruction, it has the possibility of being</span>
<span class="cm">	 * a multi-issue instruction (a 32-bit, and 2 16 bit instrucitions)</span>
<span class="cm">	 * This test collidates with the unlink instruction, so disallow that</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xc0000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc0000000</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">BIT_MULTI_INS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xe8000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xe8000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; || &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">address</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">decode_opcode</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; || &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">address</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">decode_opcode</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">dump_bfin_trace_buffer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_DEBUG_BFIN_HWTRACE_ON</span>
	<span class="kt">int</span> <span class="n">tflags</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fault</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">150</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_DEBUG_BFIN_HWTRACE_EXPAND</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">trace_buffer_save</span><span class="p">(</span><span class="n">tflags</span><span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Hardware Trace:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_BFIN_HWTRACE_EXPAND</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;WARNING: Expanded trace turned on - can not trace exceptions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">bfin_read_TBUFSTAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">TBUFCNT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">bfin_read_TBUFSTAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">TBUFCNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">bfin_read_TBUF</span><span class="p">();</span>
			<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%4i Target : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="cm">/* Normally, the faulting instruction doesn&#39;t go into</span>
<span class="cm">			 * the trace buffer, (since it doesn&#39;t commit), so</span>
<span class="cm">			 * we print out the fault address here</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fault</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">==</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">evt_ivhw</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">bfin_read_TBUF</span><span class="p">();</span>
				<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;      FAULT : %s &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
				<span class="n">decode_instruction</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fault</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fault</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">trap</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VEC_EXCPT15</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">icplb_fault_addr</span><span class="p">);</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;      FAULT : %s &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
				<span class="n">decode_instruction</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">icplb_fault_addr</span><span class="p">);</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fault</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">bfin_read_TBUF</span><span class="p">();</span>
			<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;     Source : %s &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">decode_instruction</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_BFIN_HWTRACE_EXPAND</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trace_buff_offset</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">trace_buff_offset</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">EXPAND_LEN</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONFIG_DEBUG_BFIN_HWTRACE_EXPAND_LEN</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">software_trace_buff</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%4i Target : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">EXPAND_LEN</span><span class="p">;</span>
		<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">software_trace_buff</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;     Source : %s &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">decode_instruction</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">software_trace_buff</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">EXPAND_LEN</span><span class="p">;</span>
		<span class="n">j</span><span class="o">--</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">trace_buffer_restore</span><span class="p">(</span><span class="n">tflags</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dump_bfin_trace_buffer</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dump_bfin_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We should be able to look at fp-&gt;ipend, but we don&#39;t push it on the</span>
<span class="cm">	 * stack all the time, so do this until we fix that */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">context</span> <span class="o">=</span> <span class="n">bfin_read_IPEND</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="n">pr_emerg</span><span class="p">(</span><span class="s">&quot;Kernel OOPS in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">&amp;</span> <span class="mh">0x0020</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">VEC_HWERR</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;HW Error context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Deferred Exception context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">&amp;</span> <span class="mh">0x3FC0</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Interrupt context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Deferred Interrupt context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Kernel process context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Because we are crashing, and pointers could be bad, we check things</span>
<span class="cm">	 * pretty closely before we use them</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current</span> <span class="o">&gt;=</span> <span class="n">FIXED_CODE_START</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;CURRENT PROCESS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">FIXED_CODE_START</span><span class="p">)</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;COMM=%s PID=%d&quot;</span><span class="p">,</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;COMM= invalid&quot;</span><span class="p">);</span>

		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;  CPU=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">&gt;=</span> <span class="n">FIXED_CODE_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;TEXT = 0x%p-0x%p        DATA = 0x%p-0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_code</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_code</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_data</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_data</span><span class="p">);</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; BSS = 0x%p-0x%p  USER-STACK = 0x%p</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_data</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">brk</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_stack</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;invalid mm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;No Valid process in current context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dump_bfin_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">erraddr</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">erraddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;return address: [0x%p]; contents of:&quot;</span><span class="p">,</span> <span class="n">erraddr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">erraddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xF</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">;</span>
	     <span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">erraddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xF</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">;</span>
	     <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">))</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;0x%p: &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_mem16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;????&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%04x&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">erraddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %s &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="cm">/* Do any previous instructions turn on interrupts? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">erraddr</span> <span class="o">&amp;&amp;</span>				<span class="cm">/* in the past */</span>
		    <span class="p">((</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mh">0x0040</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mh">0x0047</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* STI instruction */</span>
		      <span class="n">val</span> <span class="o">==</span> <span class="mh">0x017b</span><span class="p">))</span>				<span class="cm">/* [SP++] = RETI */</span>
			<span class="n">sti</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Hardware error interrupts can be deferred */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sti</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">VEC_HWERR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">oops_in_progress</span><span class="p">)){</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Looks like this was a deferred error - sorry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_DEBUG_HWERR</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;The remaining message may be meaningless</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;You should enable CONFIG_DEBUG_HWERR to get a better idea where it came from</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="cm">/* If we are handling only one peripheral interrupt</span>
<span class="cm">		 * and current mm and pid are valid, and the last error</span>
<span class="cm">		 * was in that user space process&#39;s text area</span>
<span class="cm">		 * print it out - because that is where the problem exists</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(((</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&amp;&amp;</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* And the last RETI points to the current userspace context */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_code</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">&lt;=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;It might be better to look around here :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;-------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">show_regs</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;-------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">150</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">irqaction</span> <span class="o">*</span><span class="n">action</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in_atomic</span> <span class="o">=</span> <span class="p">(</span><span class="n">bfin_read_IPEND</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">||</span> <span class="n">in_atomic</span><span class="p">();</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CPUID</span> <span class="o">!=</span> <span class="n">bfin_cpuid</span><span class="p">())</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Compiled for cpu family 0x%04x (Rev %d), &quot;</span>
			<span class="s">&quot;but running on:0x%04x (Rev %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">CPUID</span><span class="p">,</span> <span class="n">bfin_compiled_revid</span><span class="p">(),</span> <span class="n">bfin_cpuid</span><span class="p">(),</span> <span class="n">bfin_revid</span><span class="p">());</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;ADSP-%s-0.%d&quot;</span><span class="p">,</span>
		<span class="n">CPU</span><span class="p">,</span> <span class="n">bfin_compiled_revid</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfin_compiled_revid</span><span class="p">()</span> <span class="o">!=</span>  <span class="n">bfin_revid</span><span class="p">())</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;(Detected 0.%d)&quot;</span><span class="p">,</span> <span class="n">bfin_revid</span><span class="p">());</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %lu(MHz CCLK) %lu(MHz SCLK) (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">get_cclk</span><span class="p">()</span><span class="o">/</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">get_sclk</span><span class="p">()</span><span class="o">/</span><span class="mi">1000000</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MPU</span>
		<span class="s">&quot;mpu on&quot;</span>
<span class="cp">#else</span>
		<span class="s">&quot;mpu off&quot;</span>
<span class="cp">#endif</span>
		<span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">linux_banner</span><span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">SEQUENCER STATUS:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">print_tainted</span><span class="p">());</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; SEQSTAT: %08lx  IPEND: %04lx  IMASK: %04lx  SYSCFG: %04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ipend</span><span class="p">,</span> <span class="n">cpu_pda</span><span class="p">[</span><span class="n">raw_smp_processor_id</span><span class="p">()].</span><span class="n">ex_imask</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">syscfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">&amp;</span> <span class="n">EVT_IRPTEN</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  Global Interrupts Disabled (IPEND[4])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpu_pda</span><span class="p">[</span><span class="n">raw_smp_processor_id</span><span class="p">()].</span><span class="n">ex_imask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EVT_IVG13</span> <span class="o">|</span> <span class="n">EVT_IVG12</span> <span class="o">|</span> <span class="n">EVT_IVG11</span> <span class="o">|</span>
			<span class="n">EVT_IVG10</span> <span class="o">|</span> <span class="n">EVT_IVG9</span> <span class="o">|</span> <span class="n">EVT_IVG8</span> <span class="o">|</span> <span class="n">EVT_IVG7</span> <span class="o">|</span> <span class="n">EVT_IVTMR</span><span class="p">)))</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  Peripheral interrupts masked off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpu_pda</span><span class="p">[</span><span class="n">raw_smp_processor_id</span><span class="p">()].</span><span class="n">ex_imask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EVT_IVG15</span> <span class="o">|</span> <span class="n">EVT_IVG14</span><span class="p">)))</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  Kernel interrupts masked off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">VEC_HWERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  HWERRCAUSE: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_HWERRCAUSE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">);</span>
<span class="cp">#ifdef EBIU_ERRMST</span>
		<span class="cm">/* If the error was from the EBIU, print it out */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfin_read_EBIU_ERRMST</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">CORE_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  EBIU Error Reason  : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bfin_read_EBIU_ERRMST</span><span class="p">());</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  EBIU Error Address : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bfin_read_EBIU_ERRADD</span><span class="p">());</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  EXCAUSE   : 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bfin_read32</span><span class="p">(</span><span class="n">EVT0</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  physical IVG%i asserted : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  interrupts disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if no interrupts are going off, don&#39;t print this out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3F</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">NR_IRQS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_to_desc</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_atomic</span><span class="p">)</span>
				<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">action</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">action</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

			<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">);</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  logical irq %3d mapped  : %s&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">action</span><span class="p">;</span> <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">);</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">unlock:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_atomic</span><span class="p">)</span>
				<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rete</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; RETE: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">retn</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; RETN: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">retx</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; RETX: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rets</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; RETS: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; PC  : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span>  <span class="n">SEQSTAT_EXCAUSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VEC_HWERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">dcplb_fault_addr</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;DCPLB_FAULT_ADDR: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">icplb_fault_addr</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;ICPLB_FAULT_ADDR: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;PROCESSOR STATE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; R0 : %08lx    R1 : %08lx    R2 : %08lx    R3 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">r0</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">r2</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; R4 : %08lx    R5 : %08lx    R6 : %08lx    R7 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">r4</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">r5</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">r6</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">r7</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; P0 : %08lx    P1 : %08lx    P2 : %08lx    P3 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">p3</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; P4 : %08lx    P5 : %08lx    FP : %08lx    SP : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">p4</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">p5</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; LB0: %08lx    LT0: %08lx    LC0: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">lb0</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">lt0</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">lc0</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; LB1: %08lx    LT1: %08lx    LC1: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">lb1</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">lt1</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">lc1</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; B0 : %08lx    L0 : %08lx    M0 : %08lx    I0 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">l0</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">m0</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">i0</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; B1 : %08lx    L1 : %08lx    M1 : %08lx    I1 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">b1</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">i1</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; B2 : %08lx    L2 : %08lx    M2 : %08lx    I2 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">b2</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">i2</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot; B3 : %08lx    L3 : %08lx    M3 : %08lx    I3 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">b3</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">m3</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">i3</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;A0.w: %08lx   A0.x: %08lx   A1.w: %08lx   A1.x: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">a0w</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">a0x</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">a1w</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">a1x</span><span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;USP : %08lx  ASTAT: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rdusp</span><span class="p">(),</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">astat</span><span class="p">);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
