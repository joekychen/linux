<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › blackfin › kernel › traps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Main exception handling logic.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2004-2010 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>
<span class="cp">#include &lt;asm/cplb.h&gt;</span>
<span class="cp">#include &lt;asm/blackfin.h&gt;</span>
<span class="cp">#include &lt;asm/irq_handler.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;asm/trace.h&gt;</span>
<span class="cp">#include &lt;asm/fixed_code.h&gt;</span>
<span class="cp">#include &lt;asm/pseudo_instructions.h&gt;</span>
<span class="cp">#include &lt;asm/pda.h&gt;</span>

<span class="cp">#ifdef CONFIG_KGDB</span>
<span class="cp"># include &lt;linux/kgdb.h&gt;</span>

<span class="cp"># define CHK_DEBUGGER_TRAP() \</span>
<span class="cp">	do { \</span>
<span class="cp">		kgdb_handle_exception(trapnr, sig, info.si_code, fp); \</span>
<span class="cp">	} while (0)</span>
<span class="cp"># define CHK_DEBUGGER_TRAP_MAYBE() \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (kgdb_connected) \</span>
<span class="cp">			CHK_DEBUGGER_TRAP(); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#else</span>
<span class="cp"># define CHK_DEBUGGER_TRAP() do { } while (0)</span>
<span class="cp"># define CHK_DEBUGGER_TRAP_MAYBE() do { } while (0)</span>
<span class="cp">#endif</span>


<span class="cp">#ifdef CONFIG_DEBUG_VERBOSE</span>
<span class="cp">#define verbose_printk(fmt, arg...) \</span>
<span class="cp">	printk(fmt, ##arg)</span>
<span class="cp">#else</span>
<span class="cp">#define verbose_printk(fmt, arg...) \</span>
<span class="cp">	({ if (0) printk(fmt, ##arg); 0; })</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_DEBUG_MMRS) || defined(CONFIG_DEBUG_MMRS_MODULE)</span>
<span class="n">u32</span> <span class="n">last_seqstat</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_MMRS_MODULE</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">last_seqstat</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cm">/* Initiate the event table handler */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CSYNC</span><span class="p">();</span>
	<span class="n">bfin_write_EVT3</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
	<span class="n">CSYNC</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kernel_mode_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ipend</span> <span class="o">&amp;</span> <span class="mh">0xffc0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="n">notrace</span> <span class="kt">void</span> <span class="nf">trap_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_DEBUG_BFIN_HWTRACE_ON</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BFIN_PSEUDODBG_INSNS</span>
	<span class="kt">int</span> <span class="n">opcode</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strerror</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">trapnr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">;</span>

	<span class="n">trace_buffer_save</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_DEBUG_MMRS) || defined(CONFIG_DEBUG_MMRS_MODULE)</span>
	<span class="n">last_seqstat</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Important - be very careful dereferncing pointers - will lead to</span>
<span class="cm">	 * double faults if the stack has become corrupt</span>
<span class="cm">	 */</span>

	<span class="cm">/* trap_c() will be called for exceptions. During exceptions</span>
<span class="cm">	 * processing, the pc value should be set with retx value.</span>
<span class="cm">	 * With this change we can cleanup some code in signal.c- TODO</span>
<span class="cm">	 */</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">orig_pc</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">retx</span><span class="p">;</span>
	<span class="cm">/* printk(&quot;exception: 0x%x, ipend=%x, reti=%x, retx=%x\n&quot;,</span>
<span class="cm">		trapnr, fp-&gt;ipend, fp-&gt;pc, fp-&gt;retx); */</span>

	<span class="cm">/* send the appropriate signal to the user program */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">trapnr</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/* This table works in conjunction with the one in ./mach-common/entry.S</span>
<span class="cm">	 * Some exceptions are handled there (in assembly, in exception space)</span>
<span class="cm">	 * Some are handled here, (in C, in interrupt space)</span>
<span class="cm">	 * Some, like CPLB, are handled in both, where the normal path is</span>
<span class="cm">	 * handled in assembly/exception space, and the error path is handled</span>
<span class="cm">	 * here</span>
<span class="cm">	 */</span>

	<span class="cm">/* 0x00 - Linux Syscall, getting here is an error */</span>
	<span class="cm">/* 0x01 - userspace gdb breakpoint, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_EXCPT01</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_ILLTRAP</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="cm">/* Check if this is a breakpoint in kernel space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_mode_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x03 - User Defined, userspace stack overflow */</span>
	<span class="k">case</span> <span class="n">VEC_EXCPT03</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_STACKFLOW</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x03</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x02 - KGDB initial connection and break signal trap */</span>
	<span class="k">case</span> <span class="n">VEC_EXCPT02</span>:
<span class="cp">#ifdef CONFIG_KGDB</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_ILLTRAP</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">CHK_DEBUGGER_TRAP</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* 0x04 - User Defined */</span>
	<span class="cm">/* 0x05 - User Defined */</span>
	<span class="cm">/* 0x06 - User Defined */</span>
	<span class="cm">/* 0x07 - User Defined */</span>
	<span class="cm">/* 0x08 - User Defined */</span>
	<span class="cm">/* 0x09 - User Defined */</span>
	<span class="cm">/* 0x0A - User Defined */</span>
	<span class="cm">/* 0x0B - User Defined */</span>
	<span class="cm">/* 0x0C - User Defined */</span>
	<span class="cm">/* 0x0D - User Defined */</span>
	<span class="cm">/* 0x0E - User Defined */</span>
	<span class="cm">/* 0x0F - User Defined */</span>
	<span class="cm">/* If we got here, it is most likely that someone was trying to use a</span>
<span class="cm">	 * custom exception handler, and it is not actually installed properly</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">VEC_EXCPT04</span> <span class="p">...</span> <span class="n">VEC_EXCPT15</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLPARAOP</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x04</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x10 HW Single step, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_STEP</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_STEP</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="cm">/* Check if this is a single step in kernel space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_mode_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x11 - Trace Buffer Full, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_OVFLOW</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_TRACEFLOW</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x11</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x12 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x13 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x14 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x15 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x16 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x17 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x18 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x19 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x1A - Reserved, Caught by default */</span>
	<span class="cm">/* 0x1B - Reserved, Caught by default */</span>
	<span class="cm">/* 0x1C - Reserved, Caught by default */</span>
	<span class="cm">/* 0x1D - Reserved, Caught by default */</span>
	<span class="cm">/* 0x1E - Reserved, Caught by default */</span>
	<span class="cm">/* 0x1F - Reserved, Caught by default */</span>
	<span class="cm">/* 0x20 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x21 - Undefined Instruction, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_UNDEF_I</span>:
<span class="cp">#ifdef CONFIG_BUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_mode_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">report_bug</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">BUG_TRAP_TYPE_NONE</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BUG_TRAP_TYPE_WARN</span>:
				<span class="n">dump_bfin_trace_buffer</span><span class="p">();</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BUG_TRAP_TYPE_BUG</span>:
				<span class="cm">/* call to panic() will dump trace, and it is</span>
<span class="cm">				 * off at this point, so it won&#39;t be clobbered</span>
<span class="cm">				 */</span>
				<span class="n">panic</span><span class="p">(</span><span class="s">&quot;BUG()&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BFIN_PSEUDODBG_INSNS</span>
		<span class="cm">/*</span>
<span class="cm">		 * Support for the fake instructions, if the instruction fails,</span>
<span class="cm">		 * then just execute a illegal opcode failure (like normal).</span>
<span class="cm">		 * Don&#39;t support these instructions inside the kernel</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kernel_mode_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">get_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">execute_pseudodbg_assert</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">opcode</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">execute_pseudodbg</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">opcode</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x21</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x22 - Illegal Instruction Combination, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_ILGAL_I</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLPARAOP</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x22</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x23 - Data CPLB protection violation, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_CPLB_VL</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_CPLB_VI</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x23</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x24 - Data access misaligned, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_MISALI_D</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x24</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x25 - Unrecoverable Event, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_UNCOV</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLEXCPT</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x25</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x26 - Data CPLB Miss, normal case is handled in _cplb_hdr,</span>
<span class="cm">		error case is handled here */</span>
	<span class="k">case</span> <span class="n">VEC_CPLB_M</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x26</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x27 - Data CPLB Multiple Hits - Linux Trap Zero, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_CPLB_MHIT</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_CPLB_MULHIT</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_HUNT_FOR_ZERO</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">dcplb_fault_addr</span> <span class="o">&lt;</span> <span class="n">FIXED_CODE_START</span><span class="p">)</span>
			<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="s">&quot;NULL pointer access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x27</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x28 - Emulation Watchpoint, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_WATCH</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_WATCHPT</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">EXC_0x28</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">));</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="cm">/* Check if this is a watchpoint in kernel space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_mode_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BF535</span>
	<span class="cm">/* 0x29 - Instruction fetch access error (535 only) */</span>
	<span class="k">case</span> <span class="n">VEC_ISTRU_VL</span>:      <span class="cm">/* ADSP-BF535 only (MH) */</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_OPFETCH</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="s">&quot;BF535: VEC_ISTRU_VL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* 0x29 - Reserved, Caught by default */</span>
<span class="cp">#endif</span>
	<span class="cm">/* 0x2A - Instruction fetch misaligned, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_MISALI_I</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x2A</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x2B - Instruction CPLB protection violation, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_CPLB_I_VL</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_CPLB_VI</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x2B</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x2C - Instruction CPLB miss, handled in _cplb_hdr */</span>
	<span class="k">case</span> <span class="n">VEC_CPLB_I_M</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_CPLB_MISS</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x2C</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x2D - Instruction CPLB Multiple Hits, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_CPLB_I_MHIT</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_CPLB_MULHIT</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_HUNT_FOR_ZERO</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">icplb_fault_addr</span> <span class="o">&lt;</span> <span class="n">FIXED_CODE_START</span><span class="p">)</span>
			<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="s">&quot;Jump to NULL address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x2D</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x2E - Illegal use of Supervisor Resource, handled here */</span>
	<span class="k">case</span> <span class="n">VEC_ILL_RES</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_PRVOPC</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">EXC_0x2E</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* 0x2F - Reserved, Caught by default */</span>
	<span class="cm">/* 0x30 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x31 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x32 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x33 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x34 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x35 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x36 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x37 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x38 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x39 - Reserved, Caught by default */</span>
	<span class="cm">/* 0x3A - Reserved, Caught by default */</span>
	<span class="cm">/* 0x3B - Reserved, Caught by default */</span>
	<span class="cm">/* 0x3C - Reserved, Caught by default */</span>
	<span class="cm">/* 0x3D - Reserved, Caught by default */</span>
	<span class="cm">/* 0x3E - Reserved, Caught by default */</span>
	<span class="cm">/* 0x3F - Reserved, Caught by default */</span>
	<span class="k">case</span> <span class="n">VEC_HWERR</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_HWERRCAUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* System MMR Error */</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">SEQSTAT_HWERRCAUSE_SYSTEM_MMR</span><span class="p">)</span>:
			<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
			<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
			<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">HWC_x2</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* External Memory Addressing Error */</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">SEQSTAT_HWERRCAUSE_EXTERN_ADDR</span><span class="p">)</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ANOMALY_05000310</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">anomaly_rets</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">L1_CODE_START</span> <span class="o">+</span> <span class="n">L1_CODE_LENGTH</span> <span class="o">-</span> <span class="mi">512</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">L1_CODE_START</span> <span class="o">+</span> <span class="n">L1_CODE_LENGTH</span><span class="p">)))</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * A false hardware error will happen while fetching at</span>
<span class="cm">					 * the L1 instruction SRAM boundary.  Ignore it.</span>
<span class="cm">					 */</span>
					<span class="n">anomaly_rets</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rets</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rets</span> <span class="o">==</span> <span class="n">anomaly_rets</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * While boundary code returns to a function, at the ret</span>
<span class="cm">					 * point, a new false hardware error might occur too based</span>
<span class="cm">					 * on tests.  Ignore it too.</span>
<span class="cm">					 */</span>
					<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rets</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">L1_CODE_START</span> <span class="o">+</span> <span class="n">L1_CODE_LENGTH</span> <span class="o">-</span> <span class="mi">512</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				           <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rets</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">L1_CODE_START</span> <span class="o">+</span> <span class="n">L1_CODE_LENGTH</span><span class="p">)))</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * If boundary code calls a function, at the entry point,</span>
<span class="cm">					 * a new false hardware error maybe happen based on tests.</span>
<span class="cm">					 * Ignore it too.</span>
<span class="cm">					 */</span>
					<span class="k">goto</span> <span class="n">traps_done</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">anomaly_rets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRERR</span><span class="p">;</span>
			<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
			<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">HWC_x3</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Performance Monitor Overflow */</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">SEQSTAT_HWERRCAUSE_PERF_FLOW</span><span class="p">)</span>:
			<span class="n">strerror</span> <span class="o">=</span> <span class="n">KERN_NOTICE</span> <span class="n">HWC_x12</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* RAISE 5 instruction */</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">SEQSTAT_HWERRCAUSE_RAISE_5</span><span class="p">)</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="n">HWC_x18</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>        <span class="cm">/* Reserved */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="n">HWC_default</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We should be handling all known exception types above,</span>
<span class="cm">	 * if we get here we hit a reserved one, so panic</span>
<span class="cm">	 */</span>
	<span class="nl">default:</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLPARAOP</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">verbose_printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Caught Unhandled Exception, code = %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">));</span>
		<span class="n">CHK_DEBUGGER_TRAP_MAYBE</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* If the fault was caused by a kernel thread, or interrupt handler</span>
<span class="cm">	 * we will kernel panic, so the system reboots.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_mode_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">current</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">console_verbose</span><span class="p">();</span>
		<span class="n">oops_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">!=</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strerror</span><span class="p">)</span>
			<span class="n">verbose_printk</span><span class="p">(</span><span class="n">strerror</span><span class="p">);</span>

		<span class="n">dump_bfin_process</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">dump_bfin_mem</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">show_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

		<span class="cm">/* Print out the trace buffer if it makes sense */</span>
<span class="cp">#ifndef CONFIG_DEBUG_BFIN_NO_KERN_HWTRACE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trapnr</span> <span class="o">==</span> <span class="n">VEC_CPLB_I_M</span> <span class="o">||</span> <span class="n">trapnr</span> <span class="o">==</span> <span class="n">VEC_CPLB_M</span><span class="p">)</span>
			<span class="n">verbose_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;No trace since you do not have &quot;</span>
			       <span class="s">&quot;CONFIG_DEBUG_BFIN_NO_KERN_HWTRACE enabled</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">dump_bfin_trace_buffer</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oops_in_progress</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Dump the current kernel stack */</span>
			<span class="n">verbose_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Kernel Stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">show_stack</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">print_modules</span><span class="p">();</span>
<span class="cp">#ifndef CONFIG_ACCESS_CHECK</span>
			<span class="n">verbose_printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Please turn on &quot;</span>
			       <span class="s">&quot;CONFIG_ACCESS_CHECK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Kernel exception&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_DEBUG_VERBOSE</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
			<span class="cm">/* Dump the user space stack */</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">rdusp</span><span class="p">();</span>
			<span class="n">verbose_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Userspace Stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">show_stack</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">stack</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPIPE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipipe_trap_notify</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">trapnr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VEC_CPLB_VL</span>:
		<span class="k">case</span> <span class="n">VEC_MISALI_D</span>:
		<span class="k">case</span> <span class="n">VEC_CPLB_M</span>:
		<span class="k">case</span> <span class="n">VEC_CPLB_MHIT</span>:
			<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">dcplb_fault_addr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">force_sig_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ANOMALY_05000461</span> <span class="o">&amp;&amp;</span> <span class="n">trapnr</span> <span class="o">==</span> <span class="n">VEC_HWERR</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ANOMALY_05000281</span> <span class="o">&amp;&amp;</span> <span class="n">trapnr</span> <span class="o">==</span> <span class="n">VEC_HWERR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ANOMALY_05000189</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">trapnr</span> <span class="o">==</span> <span class="n">VEC_CPLB_I_VL</span> <span class="o">||</span> <span class="n">trapnr</span> <span class="o">==</span> <span class="n">VEC_CPLB_VL</span><span class="p">)))</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">SAFE_USER_INSTRUCTION</span><span class="p">;</span>

 <span class="nl">traps_done:</span>
	<span class="n">trace_buffer_restore</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">double_fault_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_DEBUG_BFIN_HWTRACE_ON</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">trace_buffer_save</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">console_verbose</span><span class="p">();</span>
	<span class="n">oops_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_VERBOSE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Double Fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_DEBUG_DOUBLEFAULT_PRINT</span>
	<span class="k">if</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">seqstat</span> <span class="o">&amp;</span>  <span class="n">SEQSTAT_EXCAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="n">VEC_UNCOV</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>
		<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">150</span><span class="p">];</span>
		<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">retx_doublefault</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;While handling exception (EXCAUSE = 0x%x) at %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">seqstat_doublefault</span> <span class="o">&amp;</span> <span class="n">SEQSTAT_EXCAUSE</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">dcplb_doublefault_addr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;   DCPLB_FAULT_ADDR: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cpu_pda</span><span class="p">[</span><span class="n">cpu</span><span class="p">].</span><span class="n">icplb_doublefault_addr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;   ICPLB_FAULT_ADDR: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">decode_address</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">retx</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;The instruction at %s caused a double exception</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">dump_bfin_process</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">dump_bfin_mem</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">show_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">dump_bfin_trace_buffer</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Double Fault - unrecoverable event&quot;</span><span class="p">);</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">panic_cplb_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">cplb_panic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cplb_panic</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPLB_NO_UNLOCKED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;All CPLBs are locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPLB_PROT_VIOL</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPLB_NO_ADDR_MATCH</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPLB_UNKNOWN_ERR</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Unknown CPLB Exception</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">oops_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dump_bfin_process</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">dump_bfin_mem</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">dump_stack</span><span class="p">();</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unrecoverable event&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BUG</span>
<span class="kt">int</span> <span class="nf">is_valid_bugaddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_instruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">opcode</span> <span class="o">==</span> <span class="n">BFIN_BUG_OPCODE</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* stub this out */</span>
<span class="cp">#ifndef CONFIG_DEBUG_VERBOSE</span>
<span class="kt">void</span> <span class="nf">show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
