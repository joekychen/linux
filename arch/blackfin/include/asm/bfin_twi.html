<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › blackfin › include › asm › bfin_twi.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>bfin_twi.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * bfin_twi.h - interface to Blackfin TWIs</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005-2010 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __ASM_BFIN_TWI_H__</span>
<span class="cp">#define __ASM_BFIN_TWI_H__</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * All Blackfin system MMRs are padded to 32bits even if the register</span>
<span class="cm"> * itself is only 16bits.  So use a helper macro to streamline this.</span>
<span class="cm"> */</span>
<span class="cp">#define __BFP(m) u16 m; u16 __pad_##m</span>

<span class="cm">/*</span>
<span class="cm"> * bfin twi registers layout</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bfin_twi_regs</span> <span class="p">{</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">clkdiv</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">slave_ctl</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">slave_stat</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">slave_addr</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">master_ctl</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">master_stat</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">master_addr</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">int_stat</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">int_mask</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">fifo_ctl</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">fifo_stat</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">__pad</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">xmt_data8</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">xmt_data16</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">rcv_data8</span><span class="p">);</span>
	<span class="n">__BFP</span><span class="p">(</span><span class="n">rcv_data16</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#undef __BFP</span>

<span class="k">struct</span> <span class="n">bfin_twi_iface</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">read_write</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">command</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">transPtr</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">readNum</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">writeNum</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cur_mode</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">manual_stop</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span>	<span class="n">adap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span>		<span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">msg_num</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cur_msg</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">saved_clkdiv</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">saved_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfin_twi_regs</span>	<span class="o">*</span><span class="n">regs_base</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DEFINE_TWI_REG(reg_name, reg) \</span>
<span class="cp">static inline u16 read_##reg_name(struct bfin_twi_iface *iface) \</span>
<span class="cp">	{ return iface-&gt;regs_base-&gt;reg; } \</span>
<span class="cp">static inline void write_##reg_name(struct bfin_twi_iface *iface, u16 v) \</span>
<span class="cp">	{ iface-&gt;regs_base-&gt;reg = v; }</span>

<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">CLKDIV</span><span class="p">,</span> <span class="n">clkdiv</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">SLAVE_CTL</span><span class="p">,</span> <span class="n">slave_ctl</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">SLAVE_STAT</span><span class="p">,</span> <span class="n">slave_stat</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">SLAVE_ADDR</span><span class="p">,</span> <span class="n">slave_addr</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">MASTER_CTL</span><span class="p">,</span> <span class="n">master_ctl</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">MASTER_STAT</span><span class="p">,</span> <span class="n">master_stat</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">MASTER_ADDR</span><span class="p">,</span> <span class="n">master_addr</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">INT_STAT</span><span class="p">,</span> <span class="n">int_stat</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">INT_MASK</span><span class="p">,</span> <span class="n">int_mask</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">FIFO_CTL</span><span class="p">,</span> <span class="n">fifo_ctl</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">FIFO_STAT</span><span class="p">,</span> <span class="n">fifo_stat</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">XMT_DATA8</span><span class="p">,</span> <span class="n">xmt_data8</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">XMT_DATA16</span><span class="p">,</span> <span class="n">xmt_data16</span><span class="p">)</span>
<span class="cp">#if !ANOMALY_05001001</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">RCV_DATA8</span><span class="p">,</span> <span class="n">rcv_data8</span><span class="p">)</span>
<span class="n">DEFINE_TWI_REG</span><span class="p">(</span><span class="n">RCV_DATA16</span><span class="p">,</span> <span class="n">rcv_data16</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="n">read_RCV_DATA8</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfin_twi_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">regs_base</span><span class="o">-&gt;</span><span class="n">rcv_data8</span><span class="p">;</span>
	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="n">read_RCV_DATA16</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfin_twi_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">regs_base</span><span class="o">-&gt;</span><span class="n">rcv_data16</span><span class="p">;</span>
	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*  ********************  TWO-WIRE INTERFACE (TWI) MASKS  ***********************/</span>
<span class="cm">/* TWI_CLKDIV Macros (Use: *pTWI_CLKDIV = CLKLOW(x)|CLKHI(y);  )				*/</span>
<span class="cp">#define	CLKLOW(x)	((x) &amp; 0xFF)	</span><span class="cm">/* Periods Clock Is Held Low                    */</span><span class="cp"></span>
<span class="cp">#define CLKHI(y)	(((y)&amp;0xFF)&lt;&lt;0x8)	</span><span class="cm">/* Periods Before New Clock Low                 */</span><span class="cp"></span>

<span class="cm">/* TWI_PRESCALE Masks															*/</span>
<span class="cp">#define	PRESCALE	0x007F	</span><span class="cm">/* SCLKs Per Internal Time Reference (10MHz)    */</span><span class="cp"></span>
<span class="cp">#define	TWI_ENA		0x0080	</span><span class="cm">/* TWI Enable                                                                   */</span><span class="cp"></span>
<span class="cp">#define	SCCB		0x0200	</span><span class="cm">/* SCCB Compatibility Enable                                    */</span><span class="cp"></span>

<span class="cm">/* TWI_SLAVE_CTL Masks															*/</span>
<span class="cp">#define	SEN			0x0001	</span><span class="cm">/* Slave Enable                                                                 */</span><span class="cp"></span>
<span class="cp">#define	SADD_LEN	0x0002	</span><span class="cm">/* Slave Address Length                                                 */</span><span class="cp"></span>
<span class="cp">#define	STDVAL		0x0004	</span><span class="cm">/* Slave Transmit Data Valid                                    */</span><span class="cp"></span>
<span class="cp">#define	NAK			0x0008	</span><span class="cm">/* NAK/ACK* Generated At Conclusion Of Transfer */</span><span class="cp"></span>
<span class="cp">#define	GEN			0x0010	</span><span class="cm">/* General Call Address Matching Enabled                */</span><span class="cp"></span>

<span class="cm">/* TWI_SLAVE_STAT Masks															*/</span>
<span class="cp">#define	SDIR		0x0001	</span><span class="cm">/* Slave Transfer Direction (Transmit/Receive*) */</span><span class="cp"></span>
<span class="cp">#define GCALL		0x0002	</span><span class="cm">/* General Call Indicator                                               */</span><span class="cp"></span>

<span class="cm">/* TWI_MASTER_CTL Masks													*/</span>
<span class="cp">#define	MEN			0x0001	</span><span class="cm">/* Master Mode Enable                                           */</span><span class="cp"></span>
<span class="cp">#define	MADD_LEN	0x0002	</span><span class="cm">/* Master Address Length                                        */</span><span class="cp"></span>
<span class="cp">#define	MDIR		0x0004	</span><span class="cm">/* Master Transmit Direction (RX/TX*)           */</span><span class="cp"></span>
<span class="cp">#define	FAST		0x0008	</span><span class="cm">/* Use Fast Mode Timing Specs                           */</span><span class="cp"></span>
<span class="cp">#define	STOP		0x0010	</span><span class="cm">/* Issue Stop Condition                                         */</span><span class="cp"></span>
<span class="cp">#define	RSTART		0x0020	</span><span class="cm">/* Repeat Start or Stop* At End Of Transfer     */</span><span class="cp"></span>
<span class="cp">#define	DCNT		0x3FC0	</span><span class="cm">/* Data Bytes To Transfer                                       */</span><span class="cp"></span>
<span class="cp">#define	SDAOVR		0x4000	</span><span class="cm">/* Serial Data Override                                         */</span><span class="cp"></span>
<span class="cp">#define	SCLOVR		0x8000	</span><span class="cm">/* Serial Clock Override                                        */</span><span class="cp"></span>

<span class="cm">/* TWI_MASTER_STAT Masks														*/</span>
<span class="cp">#define	MPROG		0x0001	</span><span class="cm">/* Master Transfer In Progress                                  */</span><span class="cp"></span>
<span class="cp">#define	LOSTARB		0x0002	</span><span class="cm">/* Lost Arbitration Indicator (Xfer Aborted)    */</span><span class="cp"></span>
<span class="cp">#define	ANAK		0x0004	</span><span class="cm">/* Address Not Acknowledged                                             */</span><span class="cp"></span>
<span class="cp">#define	DNAK		0x0008	</span><span class="cm">/* Data Not Acknowledged                                                */</span><span class="cp"></span>
<span class="cp">#define	BUFRDERR	0x0010	</span><span class="cm">/* Buffer Read Error                                                    */</span><span class="cp"></span>
<span class="cp">#define	BUFWRERR	0x0020	</span><span class="cm">/* Buffer Write Error                                                   */</span><span class="cp"></span>
<span class="cp">#define	SDASEN		0x0040	</span><span class="cm">/* Serial Data Sense                                                    */</span><span class="cp"></span>
<span class="cp">#define	SCLSEN		0x0080	</span><span class="cm">/* Serial Clock Sense                                                   */</span><span class="cp"></span>
<span class="cp">#define	BUSBUSY		0x0100	</span><span class="cm">/* Bus Busy Indicator                                                   */</span><span class="cp"></span>

<span class="cm">/* TWI_INT_SRC and TWI_INT_ENABLE Masks						*/</span>
<span class="cp">#define	SINIT		0x0001	</span><span class="cm">/* Slave Transfer Initiated     */</span><span class="cp"></span>
<span class="cp">#define	SCOMP		0x0002	</span><span class="cm">/* Slave Transfer Complete      */</span><span class="cp"></span>
<span class="cp">#define	SERR		0x0004	</span><span class="cm">/* Slave Transfer Error         */</span><span class="cp"></span>
<span class="cp">#define	SOVF		0x0008	</span><span class="cm">/* Slave Overflow                       */</span><span class="cp"></span>
<span class="cp">#define	MCOMP		0x0010	</span><span class="cm">/* Master Transfer Complete     */</span><span class="cp"></span>
<span class="cp">#define	MERR		0x0020	</span><span class="cm">/* Master Transfer Error        */</span><span class="cp"></span>
<span class="cp">#define	XMTSERV		0x0040	</span><span class="cm">/* Transmit FIFO Service        */</span><span class="cp"></span>
<span class="cp">#define	RCVSERV		0x0080	</span><span class="cm">/* Receive FIFO Service         */</span><span class="cp"></span>

<span class="cm">/* TWI_FIFO_CTRL Masks												*/</span>
<span class="cp">#define	XMTFLUSH	0x0001	</span><span class="cm">/* Transmit Buffer Flush                        */</span><span class="cp"></span>
<span class="cp">#define	RCVFLUSH	0x0002	</span><span class="cm">/* Receive Buffer Flush                         */</span><span class="cp"></span>
<span class="cp">#define	XMTINTLEN	0x0004	</span><span class="cm">/* Transmit Buffer Interrupt Length     */</span><span class="cp"></span>
<span class="cp">#define	RCVINTLEN	0x0008	</span><span class="cm">/* Receive Buffer Interrupt Length      */</span><span class="cp"></span>

<span class="cm">/* TWI_FIFO_STAT Masks															*/</span>
<span class="cp">#define	XMTSTAT		0x0003	</span><span class="cm">/* Transmit FIFO Status                                                 */</span><span class="cp"></span>
<span class="cp">#define	XMT_EMPTY	0x0000	</span><span class="cm">/*              Transmit FIFO Empty                                             */</span><span class="cp"></span>
<span class="cp">#define	XMT_HALF	0x0001	</span><span class="cm">/*              Transmit FIFO Has 1 Byte To Write               */</span><span class="cp"></span>
<span class="cp">#define	XMT_FULL	0x0003	</span><span class="cm">/*              Transmit FIFO Full (2 Bytes To Write)   */</span><span class="cp"></span>

<span class="cp">#define	RCVSTAT		0x000C	</span><span class="cm">/* Receive FIFO Status                                                  */</span><span class="cp"></span>
<span class="cp">#define	RCV_EMPTY	0x0000	</span><span class="cm">/*              Receive FIFO Empty                                              */</span><span class="cp"></span>
<span class="cp">#define	RCV_HALF	0x0004	</span><span class="cm">/*              Receive FIFO Has 1 Byte To Read                 */</span><span class="cp"></span>
<span class="cp">#define	RCV_FULL	0x000C	</span><span class="cm">/*              Receive FIFO Full (2 Bytes To Read)             */</span><span class="cp"></span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
