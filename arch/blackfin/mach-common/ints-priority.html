<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › blackfin › mach-common › ints-priority.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ints-priority.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Set up the interrupt priorities</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright  2004-2009 Analog Devices Inc.</span>
<span class="cm"> *                 2003 Bas Vermeulen &lt;bas@buyways.nl&gt;</span>
<span class="cm"> *                 2002 Arcturus Networks Inc. MaTed &lt;mated@sympatico.ca&gt;</span>
<span class="cm"> *            2000-2001 Lineo, Inc. D. Jefff Dionne &lt;jeff@lineo.ca&gt;</span>
<span class="cm"> *                 1999 D. Jeff Dionne &lt;jeff@uclinux.org&gt;</span>
<span class="cm"> *                 1996 Roman Zippel</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>
<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#ifdef CONFIG_IPIPE</span>
<span class="cp">#include &lt;linux/ipipe.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>
<span class="cp">#include &lt;asm/blackfin.h&gt;</span>
<span class="cp">#include &lt;asm/gpio.h&gt;</span>
<span class="cp">#include &lt;asm/irq_handler.h&gt;</span>
<span class="cp">#include &lt;asm/dpmc.h&gt;</span>

<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="cp"># define SIC_SYSIRQ(irq)	(irq - (IRQ_CORETMR + 1))</span>
<span class="cp">#else</span>
<span class="cp"># define SIC_SYSIRQ(irq)	((irq) - IVG15)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * NOTES:</span>
<span class="cm"> * - we have separated the physical Hardware interrupt from the</span>
<span class="cm"> * levels that the LINUX kernel sees (see the description in irq.h)</span>
<span class="cm"> * -</span>
<span class="cm"> */</span>

<span class="cp">#ifndef CONFIG_SMP</span>
<span class="cm">/* Initialize this to an actual value to force it into the .data</span>
<span class="cm"> * section so that we know it is properly initialized at entry into</span>
<span class="cm"> * the kernel but before bss is initialized to zero (which is where</span>
<span class="cm"> * it would live otherwise).  The 0x1f magic represents the IRQs we</span>
<span class="cm"> * cannot actually mask out in hardware.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bfin_irq_flags</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bfin_irq_flags</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bfin_sic_iwr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* Up to 3 SIC_IWRx registers */</span>
<span class="kt">unsigned</span> <span class="n">vr_wakeup</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ivgx</span> <span class="p">{</span>
	<span class="cm">/* irq number for request_irq, available in mach-bf5xx/irq.h */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqno</span><span class="p">;</span>
	<span class="cm">/* corresponding bit in the SIC_ISR register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isrflag</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ivg_table</span><span class="p">[</span><span class="n">NR_PERI_INTS</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ivg_slice</span> <span class="p">{</span>
	<span class="cm">/* position of first irq in ivg_table for given ivg */</span>
	<span class="k">struct</span> <span class="n">ivgx</span> <span class="o">*</span><span class="n">ifirst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivgx</span> <span class="o">*</span><span class="n">istop</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ivg7_13</span><span class="p">[</span><span class="n">IVG13</span> <span class="o">-</span> <span class="n">IVG7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>


<span class="cm">/*</span>
<span class="cm"> * Search SIC_IAR and fill tables with the irqvalues</span>
<span class="cm"> * and their positions in the SIC_ISR register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">search_IAR</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">ivg</span><span class="p">,</span> <span class="n">irq_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ivg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ivg</span> <span class="o">&lt;=</span> <span class="n">IVG13</span> <span class="o">-</span> <span class="n">IVG7</span><span class="p">;</span> <span class="n">ivg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">irqN</span><span class="p">;</span>

		<span class="n">ivg7_13</span><span class="p">[</span><span class="n">ivg</span><span class="p">].</span><span class="n">istop</span> <span class="o">=</span> <span class="n">ivg7_13</span><span class="p">[</span><span class="n">ivg</span><span class="p">].</span><span class="n">ifirst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivg_table</span><span class="p">[</span><span class="n">irq_pos</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">irqN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">irqN</span> <span class="o">&lt;</span> <span class="n">NR_PERI_INTS</span><span class="p">;</span> <span class="n">irqN</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">irqn</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">iar</span> <span class="o">=</span>
				<span class="n">bfin_read32</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">SIC_IAR0</span> <span class="o">+</span>
<span class="cp">#if defined(CONFIG_BF51x) || defined(CONFIG_BF52x) || \</span>
<span class="cp">	defined(CONFIG_BF538) || defined(CONFIG_BF539)</span>
				<span class="p">((</span><span class="n">irqN</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">irqN</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">SIC_IAR4</span> <span class="o">-</span> <span class="n">SIC_IAR0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
<span class="cp">#else</span>
				<span class="p">(</span><span class="n">irqN</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>
<span class="cp">#endif</span>
				<span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">irqn</span> <span class="o">=</span> <span class="n">irqN</span><span class="p">;</span> <span class="n">irqn</span> <span class="o">&lt;</span> <span class="n">irqN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">irqn</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">iar_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">irqn</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ivg</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">iar</span> <span class="o">&gt;&gt;</span> <span class="n">iar_shift</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">ivg_table</span><span class="p">[</span><span class="n">irq_pos</span><span class="p">].</span><span class="n">irqno</span> <span class="o">=</span> <span class="n">IVG7</span> <span class="o">+</span> <span class="n">irqn</span><span class="p">;</span>
					<span class="n">ivg_table</span><span class="p">[</span><span class="n">irq_pos</span><span class="p">].</span><span class="n">isrflag</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">irqn</span> <span class="o">%</span> <span class="mi">32</span><span class="p">);</span>
					<span class="n">ivg7_13</span><span class="p">[</span><span class="n">ivg</span><span class="p">].</span><span class="n">istop</span><span class="o">++</span><span class="p">;</span>
					<span class="n">irq_pos</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * This is for core internal IRQs</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bfin_ack_noop</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Dummy function.  */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_core_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_irq_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hard_irqs_disabled</span><span class="p">())</span>
		<span class="n">hard_local_irq_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_core_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_irq_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If interrupts are enabled, IMASK must contain the same value</span>
<span class="cm">	 * as bfin_irq_flags.  Make sure that invariant holds.  If interrupts</span>
<span class="cm">	 * are currently disabled we need not do anything; one of the</span>
<span class="cm">	 * callers will take care of setting IMASK to the proper value</span>
<span class="cm">	 * when reenabling interrupts.</span>
<span class="cm">	 * local_irq_enable just does &quot;STI bfin_irq_flags&quot;, so it&#39;s exactly</span>
<span class="cm">	 * what we need.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hard_irqs_disabled</span><span class="p">())</span>
		<span class="n">hard_local_irq_enable</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bfin_internal_mask_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="cp">#ifdef SIC_IMASK0</span>
	<span class="kt">unsigned</span> <span class="n">mask_bank</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mask_bit</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">bfin_write_SIC_IMASK</span><span class="p">(</span><span class="n">mask_bank</span><span class="p">,</span> <span class="n">bfin_read_SIC_IMASK</span><span class="p">(</span><span class="n">mask_bank</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mask_bit</span><span class="p">));</span>
<span class="cp"># if defined(CONFIG_SMP) || defined(CONFIG_ICC)</span>
	<span class="n">bfin_write_SICB_IMASK</span><span class="p">(</span><span class="n">mask_bank</span><span class="p">,</span> <span class="n">bfin_read_SICB_IMASK</span><span class="p">(</span><span class="n">mask_bank</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mask_bit</span><span class="p">));</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
	<span class="n">bfin_write_SIC_IMASK</span><span class="p">(</span><span class="n">bfin_read_SIC_IMASK</span><span class="p">()</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">)));</span>
<span class="cp">#endif </span><span class="cm">/* end of SIC_IMASK0 */</span><span class="cp"></span>
<span class="cp">#endif</span>
	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_internal_mask_irq_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_internal_mask_irq</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="kt">void</span> <span class="n">bfin_internal_unmask_irq_affinity</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">affinity</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">bfin_internal_unmask_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>

<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="cp">#ifdef SIC_IMASK0</span>
	<span class="kt">unsigned</span> <span class="n">mask_bank</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mask_bit</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">;</span>
<span class="cp"># ifdef CONFIG_SMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">affinity</span><span class="p">))</span>
<span class="cp"># endif</span>
		<span class="n">bfin_write_SIC_IMASK</span><span class="p">(</span><span class="n">mask_bank</span><span class="p">,</span>
				<span class="n">bfin_read_SIC_IMASK</span><span class="p">(</span><span class="n">mask_bank</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mask_bit</span><span class="p">));</span>
<span class="cp"># ifdef CONFIG_SMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">affinity</span><span class="p">))</span>
		<span class="n">bfin_write_SICB_IMASK</span><span class="p">(</span><span class="n">mask_bank</span><span class="p">,</span>
				<span class="n">bfin_read_SICB_IMASK</span><span class="p">(</span><span class="n">mask_bank</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mask_bit</span><span class="p">));</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
	<span class="n">bfin_write_SIC_IMASK</span><span class="p">(</span><span class="n">bfin_read_SIC_IMASK</span><span class="p">()</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">)));</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BF60x</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_preflow_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">bfin_write_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CSID</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_mask_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">bfin_write_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CSID</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">SEC_END</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_enable_ssi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">uint32_t</span> <span class="n">reg_sctl</span> <span class="o">=</span> <span class="n">bfin_read_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>

	<span class="n">reg_sctl</span> <span class="o">|=</span> <span class="n">SEC_SCTL_SRC_EN</span><span class="p">;</span>
	<span class="n">bfin_write_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">reg_sctl</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_disable_ssi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">uint32_t</span> <span class="n">reg_sctl</span> <span class="o">=</span> <span class="n">bfin_read_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>

	<span class="n">reg_sctl</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">~</span><span class="n">SEC_SCTL_SRC_EN</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">reg_sctl</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_set_ssi_coreid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">coreid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">uint32_t</span> <span class="n">reg_sctl</span> <span class="o">=</span> <span class="n">bfin_read_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>

	<span class="n">reg_sctl</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">~</span><span class="n">SEC_SCTL_CTG</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">reg_sctl</span> <span class="o">|</span> <span class="p">((</span><span class="n">coreid</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEC_SCTL_CTG</span><span class="p">));</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_enable_sci</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">uint32_t</span> <span class="n">reg_sctl</span> <span class="o">=</span> <span class="n">bfin_read_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sid</span> <span class="o">==</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">IRQ_WATCH0</span><span class="p">))</span>
		<span class="n">reg_sctl</span> <span class="o">|=</span> <span class="n">SEC_SCTL_FAULT_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg_sctl</span> <span class="o">|=</span> <span class="n">SEC_SCTL_INT_EN</span><span class="p">;</span>
	<span class="n">bfin_write_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">reg_sctl</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_disable_sci</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">uint32_t</span> <span class="n">reg_sctl</span> <span class="o">=</span> <span class="n">bfin_read_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>

	<span class="n">reg_sctl</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">~</span><span class="n">SEC_SCTL_INT_EN</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_SCTL</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">reg_sctl</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">bfin_sec_enable_sci</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>
	<span class="n">bfin_sec_enable_ssi</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">bfin_sec_disable_sci</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>
	<span class="n">bfin_sec_disable_ssi</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bfin_sec_raise_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>

	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">SEC_RAISE</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">init_software_driven_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_sec_set_ssi_coreid</span><span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bfin_sec_set_ssi_coreid</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bfin_sec_set_ssi_coreid</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bfin_sec_set_ssi_coreid</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">bfin_sec_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_write_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CCTL</span><span class="p">,</span> <span class="n">SEC_CCTL_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_GCTL</span><span class="p">(</span><span class="n">SEC_GCTL_EN</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CCTL</span><span class="p">,</span> <span class="n">SEC_CCTL_EN</span> <span class="o">|</span> <span class="n">SEC_CCTL_NMI_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">handle_sec_sfi_fault</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">gstat</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">handle_sec_sci_fault</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">gstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">core_id</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cstat</span><span class="p">;</span>

	<span class="n">core_id</span> <span class="o">=</span> <span class="n">gstat</span> <span class="o">&amp;</span> <span class="n">SEC_GSTAT_SCI</span><span class="p">;</span>
	<span class="n">cstat</span> <span class="o">=</span> <span class="n">bfin_read_SEC_SCI</span><span class="p">(</span><span class="n">core_id</span><span class="p">,</span> <span class="n">SEC_CSTAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="n">SEC_CSTAT_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">&amp;</span> <span class="n">SEC_CSTAT_ERRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SEC_CSTAT_ACKERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sec ack err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sec sci unknow err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">handle_sec_ssi_fault</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">gstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">sid</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sstat</span><span class="p">;</span>

	<span class="n">sid</span> <span class="o">=</span> <span class="n">gstat</span> <span class="o">&amp;</span> <span class="n">SEC_GSTAT_SID</span><span class="p">;</span>
	<span class="n">sstat</span> <span class="o">=</span> <span class="n">bfin_read_SEC_SSTAT</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">handle_sec_fault</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">sec_gstat</span><span class="p">;</span>

	<span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">sec_gstat</span> <span class="o">=</span> <span class="n">bfin_read32</span><span class="p">(</span><span class="n">SEC_GSTAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sec_gstat</span> <span class="o">&amp;</span> <span class="n">SEC_GSTAT_ERR</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sec_gstat</span> <span class="o">&amp;</span> <span class="n">SEC_GSTAT_ERRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">handle_sec_sfi_fault</span><span class="p">(</span><span class="n">sec_gstat</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEC_GSTAT_SCIERR</span>:
			<span class="n">handle_sec_sci_fault</span><span class="p">(</span><span class="n">sec_gstat</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEC_GSTAT_SSIERR</span>:
			<span class="n">handle_sec_ssi_fault</span><span class="p">(</span><span class="n">sec_gstat</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>


	<span class="p">}</span>

	<span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sec_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sec_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_write_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CCTL</span><span class="p">,</span> <span class="n">SEC_CCTL_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_GCTL</span><span class="p">(</span><span class="n">SEC_GCTL_EN</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CCTL</span><span class="p">,</span> <span class="n">SEC_CCTL_EN</span> <span class="o">|</span> <span class="n">SEC_CCTL_NMI_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">sec_pm_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">sec_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">sec_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_internal_unmask_irq_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_internal_unmask_irq_affinity</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">affinity</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_internal_set_affinity</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_internal_mask_irq</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">bfin_internal_unmask_irq_affinity</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_internal_unmask_irq_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfin_internal_unmask_irq</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_PM) &amp;&amp; !defined(CONFIG_BF60x)</span>
<span class="kt">int</span> <span class="nf">bfin_internal_set_wake</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bank</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bank</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef IRQ_RTC</span>
	<span class="k">case</span> <span class="n">IRQ_RTC</span>:
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">WAKE</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IRQ_CAN0_RX</span>
	<span class="k">case</span> <span class="n">IRQ_CAN0_RX</span>:
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">CANWE</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IRQ_CAN1_RX</span>
	<span class="k">case</span> <span class="n">IRQ_CAN1_RX</span>:
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">CANWE</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IRQ_USB_INT0</span>
	<span class="k">case</span> <span class="n">IRQ_USB_INT0</span>:
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">USBWE</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BF54x</span>
	<span class="k">case</span> <span class="n">IRQ_CNT</span>:
	<span class="n">wakeup</span> <span class="o">|=</span> <span class="n">ROTWE</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">hard_local_irq_save</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_sic_iwr</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">vr_wakeup</span>  <span class="o">|=</span> <span class="n">wakeup</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bfin_sic_iwr</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">vr_wakeup</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">wakeup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hard_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_internal_set_wake_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bfin_internal_set_wake</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp"># define bfin_internal_set_wake(irq, state)</span>
<span class="cp"># define bfin_internal_set_wake_chip NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">bfin_core_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CORE&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">bfin_core_mask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">bfin_core_unmask_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">bfin_internal_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;INTN&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">bfin_internal_mask_irq_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">bfin_internal_unmask_irq_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_disable</span> <span class="o">=</span> <span class="n">bfin_internal_mask_irq_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">bfin_internal_unmask_irq_chip</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="p">.</span><span class="n">irq_set_affinity</span> <span class="o">=</span> <span class="n">bfin_internal_set_affinity</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">irq_set_wake</span> <span class="o">=</span> <span class="n">bfin_internal_set_wake_chip</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_BF60x</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">bfin_sec_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SEC&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span> <span class="o">=</span> <span class="n">bfin_sec_mask_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">bfin_sec_mask_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">bfin_sec_unmask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_eoi</span> <span class="o">=</span> <span class="n">bfin_sec_unmask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_disable</span> <span class="o">=</span> <span class="n">bfin_sec_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">bfin_sec_enable</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">bfin_handle_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPIPE</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">;</span>    <span class="cm">/* Contents not used. */</span>
	<span class="n">ipipe_trace_irq_entry</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">__ipipe_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">ipipe_trace_irq_exit</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_IPIPE */</span><span class="cp"></span>
	<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif  </span><span class="cm">/* !CONFIG_IPIPE */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_BFIN_MAC) || defined(CONFIG_BFIN_MAC_MODULE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mac_stat_int_mask</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_status_ack_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IRQ_MAC_MMCINT</span>:
		<span class="n">bfin_write_EMAC_MMC_TIRQS</span><span class="p">(</span>
			<span class="n">bfin_read_EMAC_MMC_TIRQE</span><span class="p">()</span> <span class="o">&amp;</span>
			<span class="n">bfin_read_EMAC_MMC_TIRQS</span><span class="p">());</span>
		<span class="n">bfin_write_EMAC_MMC_RIRQS</span><span class="p">(</span>
			<span class="n">bfin_read_EMAC_MMC_RIRQE</span><span class="p">()</span> <span class="o">&amp;</span>
			<span class="n">bfin_read_EMAC_MMC_RIRQS</span><span class="p">());</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_MAC_RXFSINT</span>:
		<span class="n">bfin_write_EMAC_RX_STKY</span><span class="p">(</span>
			<span class="n">bfin_read_EMAC_RX_IRQE</span><span class="p">()</span> <span class="o">&amp;</span>
			<span class="n">bfin_read_EMAC_RX_STKY</span><span class="p">());</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_MAC_TXFSINT</span>:
		<span class="n">bfin_write_EMAC_TX_STKY</span><span class="p">(</span>
			<span class="n">bfin_read_EMAC_TX_IRQE</span><span class="p">()</span> <span class="o">&amp;</span>
			<span class="n">bfin_read_EMAC_TX_STKY</span><span class="p">());</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_MAC_WAKEDET</span>:
		 <span class="n">bfin_write_EMAC_WKUP_CTL</span><span class="p">(</span>
			<span class="n">bfin_read_EMAC_WKUP_CTL</span><span class="p">()</span> <span class="o">|</span> <span class="n">MPKS</span> <span class="o">|</span> <span class="n">RWKS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* These bits are W1C */</span>
		<span class="n">bfin_write_EMAC_SYSTAT</span><span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">-</span> <span class="n">IRQ_MAC_PHYINT</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_status_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">mac_stat_int_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">-</span> <span class="n">IRQ_MAC_PHYINT</span><span class="p">));</span>
<span class="cp">#ifdef BF537_FAMILY</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IRQ_MAC_PHYINT</span>:
		<span class="n">bfin_write_EMAC_SYSCTL</span><span class="p">(</span><span class="n">bfin_read_EMAC_SYSCTL</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PHYIE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_stat_int_mask</span><span class="p">)</span>
		<span class="n">bfin_internal_mask_irq</span><span class="p">(</span><span class="n">IRQ_MAC_ERROR</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">bfin_mac_status_ack_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_status_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef BF537_FAMILY</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IRQ_MAC_PHYINT</span>:
		<span class="n">bfin_write_EMAC_SYSCTL</span><span class="p">(</span><span class="n">bfin_read_EMAC_SYSCTL</span><span class="p">()</span> <span class="o">|</span> <span class="n">PHYIE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_stat_int_mask</span><span class="p">)</span>
		<span class="n">bfin_internal_unmask_irq</span><span class="p">(</span><span class="n">IRQ_MAC_ERROR</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mac_stat_int_mask</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">-</span> <span class="n">IRQ_MAC_PHYINT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="nf">bfin_mac_status_set_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef BF537_FAMILY</span>
	<span class="k">return</span> <span class="n">bfin_internal_set_wake</span><span class="p">(</span><span class="n">IRQ_GENERIC_ERROR</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">bfin_internal_set_wake</span><span class="p">(</span><span class="n">IRQ_MAC_ERROR</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp"># define bfin_mac_status_set_wake NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">bfin_mac_status_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MACST&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">bfin_mac_status_mask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">bfin_mac_status_unmask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_wake</span> <span class="o">=</span> <span class="n">bfin_mac_status_set_wake</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">bfin_demux_mac_status_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_err_irq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">inta_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_SYSTAT</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">IRQ_MAC_STMDONE</span> <span class="o">-</span> <span class="n">IRQ_MAC_PHYINT</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_MAC_PHYINT</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_stat_int_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">-</span> <span class="n">IRQ_MAC_PHYINT</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bfin_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfin_mac_status_ack_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;IRQ %d:&quot;</span>
					<span class="s">&quot; MASKED MAC ERROR INTERRUPT ASSERTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;%s : %s : LINE %d :</span><span class="se">\n</span><span class="s">IRQ ?: MAC ERROR&quot;</span>
				<span class="s">&quot; INTERRUPT ASSERTED BUT NO SOURCE FOUND&quot;</span>
				<span class="s">&quot;(EMAC_SYSTAT=0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bfin_set_irq_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irq_flow_handler_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IPIPE</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">handle_level_irq</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">__irq_set_handler_locked</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">gpio_enabled</span><span class="p">,</span> <span class="n">MAX_BLACKFIN_GPIOS</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">bfin_gpio_irq_prepare</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">);</span>

<span class="cp">#if !BFIN_GPIO_PINT</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* AFAIK ack_irq in case mask_ack is provided</span>
<span class="cm">	 * get&#39;s only called for edge sense irqs</span>
<span class="cm">	 */</span>
	<span class="n">set_gpio_data</span><span class="p">(</span><span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_mask_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpionr</span> <span class="o">=</span> <span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irqd_is_level_type</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
		<span class="n">set_gpio_data</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">set_gpio_maska</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_gpio_maska</span><span class="p">(</span><span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_gpio_maska</span><span class="p">(</span><span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">bfin_gpio_irq_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpionr</span> <span class="o">=</span> <span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_set_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">))</span>
		<span class="n">bfin_gpio_irq_prepare</span><span class="p">(</span><span class="n">gpionr</span><span class="p">);</span>

	<span class="n">bfin_gpio_unmask_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_irq_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpionr</span> <span class="o">=</span> <span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">bfin_gpio_mask_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">);</span>
	<span class="n">bfin_gpio_irq_free</span><span class="p">(</span><span class="n">gpionr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_gpio_irq_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">gpionr</span> <span class="o">=</span> <span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IRQ_TYPE_PROBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only probe unenabled GPIO interrupt lines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span> <span class="o">|</span>
		    <span class="n">IRQ_TYPE_LEVEL_HIGH</span> <span class="o">|</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;gpio-irq%d&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bfin_gpio_irq_request</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_set_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">))</span>
			<span class="n">bfin_gpio_irq_prepare</span><span class="p">(</span><span class="n">gpionr</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_gpio_inen</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_gpio_dir</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span>
	    <span class="o">==</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span>
		<span class="n">set_gpio_both</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_gpio_both</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_FALLING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">)))</span>
		<span class="n">set_gpio_polar</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* low or falling edge denoted by one */</span>
	<span class="k">else</span>
		<span class="n">set_gpio_polar</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* high or rising edge denoted by zero */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_gpio_edge</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_gpio_inen</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_gpio_data</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_gpio_edge</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_gpio_inen</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span>
		<span class="n">bfin_set_irq_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_edge_irq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfin_set_irq_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_level_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_gpio_set_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gpio_pm_wakeup_ctrl</span><span class="p">(</span><span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">),</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp"># define bfin_gpio_set_wake NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_demux_gpio_block</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">get_gpiop_data</span><span class="p">(</span><span class="n">gpio</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_gpiop_maska</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">bfin_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">irq</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bfin_demux_gpio_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inta_irq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inta_irq</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(BF537_FAMILY)</span>
	<span class="k">case</span> <span class="n">IRQ_PF_INTA_PG_INTA</span>:
		<span class="n">bfin_demux_gpio_block</span><span class="p">(</span><span class="n">IRQ_PF0</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PG0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PH_INTA_MAC_RX</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PH0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#elif defined(BF533_FAMILY)</span>
	<span class="k">case</span> <span class="n">IRQ_PROG_INTA</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PF0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#elif defined(BF538_FAMILY)</span>
	<span class="k">case</span> <span class="n">IRQ_PORTF_INTA</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PF0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_BF52x) || defined(CONFIG_BF51x)</span>
	<span class="k">case</span> <span class="n">IRQ_PORTF_INTA</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PF0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PORTG_INTA</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PG0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PORTH_INTA</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PH0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_BF561)</span>
	<span class="k">case</span> <span class="n">IRQ_PROG0_INTA</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PF0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PROG1_INTA</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PF16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PROG2_INTA</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PF32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfin_demux_gpio_block</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp"># ifndef CONFIG_BF60x</span>
<span class="cp">#define NR_PINT_SYS_IRQS	4</span>
<span class="cp">#define NR_PINTS		160</span>
<span class="cp"># else</span>
<span class="cp">#define NR_PINT_SYS_IRQS	6</span>
<span class="cp">#define NR_PINTS		112</span>
<span class="cp">#endif</span>

<span class="cp">#define NR_PINT_BITS		32</span>
<span class="cp">#define IRQ_NOT_AVAIL		0xFF</span>

<span class="cp">#define PINT_2_BANK(x)		((x) &gt;&gt; 5)</span>
<span class="cp">#define PINT_2_BIT(x)		((x) &amp; 0x1F)</span>
<span class="cp">#define PINT_BIT(x)		(1 &lt;&lt; (PINT_2_BIT(x)))</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">NR_PINTS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pint2irq_lut</span><span class="p">[</span><span class="n">NR_PINT_SYS_IRQS</span> <span class="o">*</span> <span class="n">NR_PINT_BITS</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfin_pint_regs</span> <span class="o">*</span> <span class="k">const</span> <span class="n">pint</span><span class="p">[</span><span class="n">NR_PINT_SYS_IRQS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">bfin_pint_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">PINT0_MASK_SET</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">bfin_pint_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">PINT1_MASK_SET</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">bfin_pint_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">PINT2_MASK_SET</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">bfin_pint_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">PINT3_MASK_SET</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_BF60x</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">bfin_pint_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">PINT4_MASK_SET</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">bfin_pint_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">PINT5_MASK_SET</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_irq_base</span><span class="p">(</span><span class="n">u32</span> <span class="n">bank</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bank</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/*PA-PB */</span>
		<span class="n">irq_base</span> <span class="o">=</span> <span class="n">IRQ_PA0</span> <span class="o">+</span> <span class="n">bmap</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/*PC-PJ */</span>
		<span class="n">irq_base</span> <span class="o">=</span> <span class="n">IRQ_PC0</span> <span class="o">+</span> <span class="n">bmap</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">irq_base</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_irq_base</span><span class="p">(</span><span class="n">u32</span> <span class="n">bank</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_base</span><span class="p">;</span>

	<span class="n">irq_base</span> <span class="o">=</span> <span class="n">IRQ_PA0</span> <span class="o">+</span> <span class="n">bank</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">bmap</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">irq_base</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Whenever PINTx_ASSIGN is altered init_pint_lut() must be executed! */</span>
<span class="kt">void</span> <span class="nf">init_pint_lut</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">bank</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">irq_base</span><span class="p">,</span> <span class="n">bit_pos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pint_assign</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bmap</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">irq2pint_lut</span><span class="p">,</span> <span class="n">IRQ_NOT_AVAIL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">irq2pint_lut</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">NR_PINT_SYS_IRQS</span><span class="p">;</span> <span class="n">bank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pint_assign</span> <span class="o">=</span> <span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assign</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="n">NR_PINT_BITS</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">bmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">pint_assign</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">bit</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="n">irq_base</span> <span class="o">=</span> <span class="n">get_irq_base</span><span class="p">(</span><span class="n">bank</span><span class="p">,</span> <span class="n">bmap</span><span class="p">);</span>

			<span class="n">irq_base</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bit</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">bit</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bit_pos</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">+</span> <span class="n">bank</span> <span class="o">*</span> <span class="n">NR_PINT_BITS</span><span class="p">;</span>

			<span class="n">pint2irq_lut</span><span class="p">[</span><span class="n">bit_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq_base</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">;</span>
			<span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">irq_base</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">]</span> <span class="o">=</span> <span class="n">bit_pos</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pint_val</span> <span class="o">=</span> <span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pintbit</span> <span class="o">=</span> <span class="n">PINT_BIT</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">PINT_2_BANK</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqd_get_trigger_type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_set</span> <span class="o">&amp;</span> <span class="n">pintbit</span><span class="p">)</span>
			<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_clear</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_set</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_mask_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pint_val</span> <span class="o">=</span> <span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pintbit</span> <span class="o">=</span> <span class="n">PINT_BIT</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">PINT_2_BANK</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqd_get_trigger_type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_set</span> <span class="o">&amp;</span> <span class="n">pintbit</span><span class="p">)</span>
			<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_clear</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_set</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
	<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mask_clear</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pint_val</span> <span class="o">=</span> <span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">];</span>

	<span class="n">pint</span><span class="p">[</span><span class="n">PINT_2_BANK</span><span class="p">(</span><span class="n">pint_val</span><span class="p">)]</span><span class="o">-&gt;</span><span class="n">mask_clear</span> <span class="o">=</span> <span class="n">PINT_BIT</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pint_val</span> <span class="o">=</span> <span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pintbit</span> <span class="o">=</span> <span class="n">PINT_BIT</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">PINT_2_BANK</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>

	<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mask_set</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">bfin_gpio_irq_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpionr</span> <span class="o">=</span> <span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pint_val</span> <span class="o">=</span> <span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pint_val</span> <span class="o">==</span> <span class="n">IRQ_NOT_AVAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		<span class="s">&quot;GPIO IRQ %d :Not in PINT Assign table &quot;</span>
		<span class="s">&quot;Reconfigure Interrupt to Port Assignemt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_set_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">))</span>
		<span class="n">bfin_gpio_irq_prepare</span><span class="p">(</span><span class="n">gpionr</span><span class="p">);</span>

	<span class="n">bfin_gpio_unmask_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_gpio_irq_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpionr</span> <span class="o">=</span> <span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">bfin_gpio_mask_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">);</span>
	<span class="n">bfin_gpio_irq_free</span><span class="p">(</span><span class="n">gpionr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_gpio_irq_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">gpionr</span> <span class="o">=</span> <span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pint_val</span> <span class="o">=</span> <span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pintbit</span> <span class="o">=</span> <span class="n">PINT_BIT</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">PINT_2_BANK</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pint_val</span> <span class="o">==</span> <span class="n">IRQ_NOT_AVAIL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IRQ_TYPE_PROBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only probe unenabled GPIO interrupt lines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span> <span class="o">|</span>
		    <span class="n">IRQ_TYPE_LEVEL_HIGH</span> <span class="o">|</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;gpio-irq%d&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bfin_gpio_irq_request</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_set_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">))</span>
			<span class="n">bfin_gpio_irq_prepare</span><span class="p">(</span><span class="n">gpionr</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">gpionr</span><span class="p">,</span> <span class="n">gpio_enabled</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_FALLING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">)))</span>
		<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_set</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>	<span class="cm">/* low or falling edge denoted by one */</span>
	<span class="k">else</span>
		<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_clear</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>	<span class="cm">/* high or rising edge denoted by zero */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span>
	    <span class="o">==</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">gpionr</span><span class="p">))</span>
			<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_set</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">invert_clear</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TYPE_EDGE_RISING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">edge_set</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
		<span class="n">bfin_set_irq_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_edge_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">edge_clear</span> <span class="o">=</span> <span class="n">pintbit</span><span class="p">;</span>
		<span class="n">bfin_set_irq_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_level_irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_gpio_set_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pint_irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pint_val</span> <span class="o">=</span> <span class="n">irq2pint_lut</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SYS_IRQS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">bank</span> <span class="o">=</span> <span class="n">PINT_2_BANK</span><span class="p">(</span><span class="n">pint_val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pint_irq</span> <span class="o">=</span> <span class="n">IRQ_PINT0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">pint_irq</span> <span class="o">=</span> <span class="n">IRQ_PINT2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">pint_irq</span> <span class="o">=</span> <span class="n">IRQ_PINT3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pint_irq</span> <span class="o">=</span> <span class="n">IRQ_PINT1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BF60x</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">pint_irq</span> <span class="o">=</span> <span class="n">IRQ_PINT4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">pint_irq</span> <span class="o">=</span> <span class="n">IRQ_PINT5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfin_internal_set_wake</span><span class="p">(</span><span class="n">pint_irq</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp"># define bfin_gpio_set_wake NULL</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">bfin_demux_gpio_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inta_irq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bank</span><span class="p">,</span> <span class="n">pint_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">request</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">umask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_desc_get_chip</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inta_irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IRQ_PINT0</span>:
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PINT2</span>:
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PINT3</span>:
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PINT1</span>:
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BF60x</span>
	<span class="k">case</span> <span class="n">IRQ_PINT4</span>:
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_PINT5</span>:
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pint_val</span> <span class="o">=</span> <span class="n">bank</span> <span class="o">*</span> <span class="n">NR_PINT_BITS</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>

	<span class="n">level_mask</span> <span class="o">=</span> <span class="n">pint</span><span class="p">[</span><span class="n">bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">edge_set</span> <span class="o">&amp;</span> <span class="n">request</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">pint2irq_lut</span><span class="p">[</span><span class="n">pint_val</span><span class="p">]</span> <span class="o">+</span> <span class="n">SYS_IRQS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">level_mask</span> <span class="o">&amp;</span> <span class="n">PINT_BIT</span><span class="p">(</span><span class="n">pint_val</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">umask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">bfin_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pint_val</span><span class="o">++</span><span class="p">;</span>
		<span class="n">request</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">umask</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">bfin_gpio_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GPIO&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span> <span class="o">=</span> <span class="n">bfin_gpio_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">bfin_gpio_mask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span> <span class="o">=</span> <span class="n">bfin_gpio_mask_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">bfin_gpio_unmask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_disable</span> <span class="o">=</span> <span class="n">bfin_gpio_mask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">bfin_gpio_unmask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span> <span class="o">=</span> <span class="n">bfin_gpio_irq_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_startup</span> <span class="o">=</span> <span class="n">bfin_gpio_irq_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_shutdown</span> <span class="o">=</span> <span class="n">bfin_gpio_irq_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_wake</span> <span class="o">=</span> <span class="n">bfin_gpio_set_wake</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">init_exception_vectors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* cannot program in software:</span>
<span class="cm">	 * evt0 - emulation (jtag)</span>
<span class="cm">	 * evt1 - reset</span>
<span class="cm">	 */</span>
	<span class="n">bfin_write_EVT2</span><span class="p">(</span><span class="n">evt_nmi</span><span class="p">);</span>
	<span class="n">bfin_write_EVT3</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
	<span class="n">bfin_write_EVT5</span><span class="p">(</span><span class="n">evt_ivhw</span><span class="p">);</span>
	<span class="n">bfin_write_EVT6</span><span class="p">(</span><span class="n">evt_timer</span><span class="p">);</span>
	<span class="n">bfin_write_EVT7</span><span class="p">(</span><span class="n">evt_evt7</span><span class="p">);</span>
	<span class="n">bfin_write_EVT8</span><span class="p">(</span><span class="n">evt_evt8</span><span class="p">);</span>
	<span class="n">bfin_write_EVT9</span><span class="p">(</span><span class="n">evt_evt9</span><span class="p">);</span>
	<span class="n">bfin_write_EVT10</span><span class="p">(</span><span class="n">evt_evt10</span><span class="p">);</span>
	<span class="n">bfin_write_EVT11</span><span class="p">(</span><span class="n">evt_evt11</span><span class="p">);</span>
	<span class="n">bfin_write_EVT12</span><span class="p">(</span><span class="n">evt_evt12</span><span class="p">);</span>
	<span class="n">bfin_write_EVT13</span><span class="p">(</span><span class="n">evt_evt13</span><span class="p">);</span>
	<span class="n">bfin_write_EVT14</span><span class="p">(</span><span class="n">evt_evt14</span><span class="p">);</span>
	<span class="n">bfin_write_EVT15</span><span class="p">(</span><span class="n">evt_system_call</span><span class="p">);</span>
	<span class="n">CSYNC</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function should be called during kernel startup to initialize</span>
<span class="cm"> * the BFin IRQ handling routines.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_arch_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ilat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_BF60x</span>
	<span class="cm">/*  Disable all the peripheral intrs  - page 4-29 HW Ref manual */</span>
<span class="cp">#ifdef SIC_IMASK0</span>
	<span class="n">bfin_write_SIC_IMASK0</span><span class="p">(</span><span class="n">SIC_UNMASK_ALL</span><span class="p">);</span>
	<span class="n">bfin_write_SIC_IMASK1</span><span class="p">(</span><span class="n">SIC_UNMASK_ALL</span><span class="p">);</span>
<span class="cp"># ifdef SIC_IMASK2</span>
	<span class="n">bfin_write_SIC_IMASK2</span><span class="p">(</span><span class="n">SIC_UNMASK_ALL</span><span class="p">);</span>
<span class="cp"># endif</span>
<span class="cp"># if defined(CONFIG_SMP) || defined(CONFIG_ICC)</span>
	<span class="n">bfin_write_SICB_IMASK0</span><span class="p">(</span><span class="n">SIC_UNMASK_ALL</span><span class="p">);</span>
	<span class="n">bfin_write_SICB_IMASK1</span><span class="p">(</span><span class="n">SIC_UNMASK_ALL</span><span class="p">);</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
	<span class="n">bfin_write_SIC_IMASK</span><span class="p">(</span><span class="n">SIC_UNMASK_ALL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_BF60x */</span><span class="cp"></span>
	<span class="n">bfin_write_SEC_GCTL</span><span class="p">(</span><span class="n">SEC_GCTL_RESET</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>

<span class="cp">#if BFIN_GPIO_PINT</span>
<span class="cp"># ifdef CONFIG_PINTx_REASSIGN</span>
	<span class="n">pint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assign</span> <span class="o">=</span> <span class="n">CONFIG_PINT0_ASSIGN</span><span class="p">;</span>
	<span class="n">pint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assign</span> <span class="o">=</span> <span class="n">CONFIG_PINT1_ASSIGN</span><span class="p">;</span>
	<span class="n">pint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assign</span> <span class="o">=</span> <span class="n">CONFIG_PINT2_ASSIGN</span><span class="p">;</span>
	<span class="n">pint</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assign</span> <span class="o">=</span> <span class="n">CONFIG_PINT3_ASSIGN</span><span class="p">;</span>
<span class="cp"># ifdef CONFIG_BF60x</span>
	<span class="n">pint</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assign</span> <span class="o">=</span> <span class="n">CONFIG_PINT4_ASSIGN</span><span class="p">;</span>
	<span class="n">pint</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assign</span> <span class="o">=</span> <span class="n">CONFIG_PINT5_ASSIGN</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="cp"># endif</span>
	<span class="cm">/* Whenever PINTx_ASSIGN is altered init_pint_lut() must be executed! */</span>
	<span class="n">init_pint_lut</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">SYS_IRQS</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">IRQ_CORETMR</span><span class="p">)</span>
			<span class="n">irq_set_chip</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_core_irqchip</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">irq_set_chip</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_internal_irqchip</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="cp">#if BFIN_GPIO_PINT</span>
		<span class="k">case</span> <span class="n">IRQ_PINT0</span>:
		<span class="k">case</span> <span class="n">IRQ_PINT1</span>:
		<span class="k">case</span> <span class="n">IRQ_PINT2</span>:
		<span class="k">case</span> <span class="n">IRQ_PINT3</span>:
<span class="cp">#elif defined(BF537_FAMILY)</span>
		<span class="k">case</span> <span class="n">IRQ_PH_INTA_MAC_RX</span>:
		<span class="k">case</span> <span class="n">IRQ_PF_INTA_PG_INTA</span>:
<span class="cp">#elif defined(BF533_FAMILY)</span>
		<span class="k">case</span> <span class="n">IRQ_PROG_INTA</span>:
<span class="cp">#elif defined(CONFIG_BF52x) || defined(CONFIG_BF51x)</span>
		<span class="k">case</span> <span class="n">IRQ_PORTF_INTA</span>:
		<span class="k">case</span> <span class="n">IRQ_PORTG_INTA</span>:
		<span class="k">case</span> <span class="n">IRQ_PORTH_INTA</span>:
<span class="cp">#elif defined(CONFIG_BF561)</span>
		<span class="k">case</span> <span class="n">IRQ_PROG0_INTA</span>:
		<span class="k">case</span> <span class="n">IRQ_PROG1_INTA</span>:
		<span class="k">case</span> <span class="n">IRQ_PROG2_INTA</span>:
<span class="cp">#elif defined(BF538_FAMILY)</span>
		<span class="k">case</span> <span class="n">IRQ_PORTF_INTA</span>:
<span class="cp">#endif</span>
			<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">bfin_demux_gpio_irq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_BFIN_MAC) || defined(CONFIG_BFIN_MAC_MODULE)</span>
		<span class="k">case</span> <span class="n">IRQ_MAC_ERROR</span>:
			<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>
						<span class="n">bfin_demux_mac_status_irq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_SMP) || defined(CONFIG_ICC)</span>
		<span class="k">case</span> <span class="n">IRQ_SUPPLE_0</span>:
		<span class="k">case</span> <span class="n">IRQ_SUPPLE_1</span>:
			<span class="n">irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_percpu_irq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TICKSOURCE_CORETMR</span>
		<span class="k">case</span> <span class="n">IRQ_CORETMR</span>:
<span class="cp"># ifdef CONFIG_SMP</span>
			<span class="n">irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_percpu_irq</span><span class="p">);</span>
<span class="cp"># else</span>
			<span class="n">irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_simple_irq</span><span class="p">);</span>
<span class="cp"># endif</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TICKSOURCE_GPTMR0</span>
		<span class="k">case</span> <span class="n">IRQ_TIMER0</span>:
			<span class="n">irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_simple_irq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_IPIPE</span>
			<span class="n">irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_level_irq</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_simple_irq</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">init_mach_irq</span><span class="p">();</span>

<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="cp">#if (defined(CONFIG_BFIN_MAC) || defined(CONFIG_BFIN_MAC_MODULE)) &amp;&amp; !defined(CONFIG_BF60x)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_MAC_PHYINT</span><span class="p">;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">IRQ_MAC_STMDONE</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_mac_status_irqchip</span><span class="p">,</span>
					 <span class="n">handle_level_irq</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* if configured as edge, then will be changed to do_edge_IRQ */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">GPIO_IRQ_BASE</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">GPIO_IRQ_BASE</span> <span class="o">+</span> <span class="n">MAX_BLACKFIN_GPIOS</span><span class="p">);</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_gpio_irqchip</span><span class="p">,</span>
					 <span class="n">handle_level_irq</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">BFIN_IRQ</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">SYS_IRQS</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="n">CORE_IRQS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">irq_set_chip</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_sec_irqchip</span><span class="p">);</span>
			<span class="n">__irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_sec_fault</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="n">BFIN_IRQ</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">BFIN_IRQ</span><span class="p">(</span><span class="mi">26</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">irq_set_chip</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_sec_irqchip</span><span class="p">);</span>
			<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">bfin_demux_gpio_irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="n">BFIN_IRQ</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">BFIN_IRQ</span><span class="p">(</span><span class="mi">37</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">irq_set_chip</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_sec_irqchip</span><span class="p">);</span>
			<span class="n">irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_percpu_irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_sec_irqchip</span><span class="p">,</span>
					<span class="n">handle_fasteoi_irq</span><span class="p">);</span>
			<span class="n">__irq_set_preflow_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">bfin_sec_preflow_handler</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">GPIO_IRQ_BASE</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">GPIO_IRQ_BASE</span> <span class="o">+</span> <span class="n">MAX_BLACKFIN_GPIOS</span><span class="p">);</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bfin_gpio_irqchip</span><span class="p">,</span>
					<span class="n">handle_level_irq</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">bfin_write_IMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">CSYNC</span><span class="p">();</span>
	<span class="n">ilat</span> <span class="o">=</span> <span class="n">bfin_read_ILAT</span><span class="p">();</span>
	<span class="n">CSYNC</span><span class="p">();</span>
	<span class="n">bfin_write_ILAT</span><span class="p">(</span><span class="n">ilat</span><span class="p">);</span>
	<span class="n">CSYNC</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Configuring Blackfin Priority Driven Interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* IMASK=xxx is equivalent to STI xx or bfin_irq_flags=xx,</span>
<span class="cm">	 * local_irq_enable()</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef CONFIG_BF60x</span>
	<span class="n">program_IAR</span><span class="p">();</span>
	<span class="cm">/* Therefore it&#39;s better to setup IARs before interrupts enabled */</span>
	<span class="n">search_IAR</span><span class="p">();</span>

	<span class="cm">/* Enable interrupts IVG7-15 */</span>
	<span class="n">bfin_irq_flags</span> <span class="o">|=</span> <span class="n">IMASK_IVG15</span> <span class="o">|</span>
		<span class="n">IMASK_IVG14</span> <span class="o">|</span> <span class="n">IMASK_IVG13</span> <span class="o">|</span> <span class="n">IMASK_IVG12</span> <span class="o">|</span> <span class="n">IMASK_IVG11</span> <span class="o">|</span>
		<span class="n">IMASK_IVG10</span> <span class="o">|</span> <span class="n">IMASK_IVG9</span> <span class="o">|</span> <span class="n">IMASK_IVG8</span> <span class="o">|</span> <span class="n">IMASK_IVG7</span> <span class="o">|</span> <span class="n">IMASK_IVGHW</span><span class="p">;</span>

	<span class="n">bfin_sti</span><span class="p">(</span><span class="n">bfin_irq_flags</span><span class="p">);</span>

	<span class="cm">/* This implicitly covers ANOMALY_05000171</span>
<span class="cm">	 * Boot-ROM code modifies SICA_IWRx wakeup registers</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef SIC_IWR0</span>
	<span class="n">bfin_write_SIC_IWR0</span><span class="p">(</span><span class="n">IWR_DISABLE_ALL</span><span class="p">);</span>
<span class="cp"># ifdef SIC_IWR1</span>
	<span class="cm">/* BF52x/BF51x system reset does not properly reset SIC_IWR1 which</span>
<span class="cm">	 * will screw up the bootrom as it relies on MDMA0/1 waking it</span>
<span class="cm">	 * up from IDLE instructions.  See this report for more info:</span>
<span class="cm">	 * http://blackfin.uclinux.org/gf/tracker/4323</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ANOMALY_05000435</span><span class="p">)</span>
		<span class="n">bfin_write_SIC_IWR1</span><span class="p">(</span><span class="n">IWR_ENABLE</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">IWR_ENABLE</span><span class="p">(</span><span class="mi">11</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">bfin_write_SIC_IWR1</span><span class="p">(</span><span class="n">IWR_DISABLE_ALL</span><span class="p">);</span>
<span class="cp"># endif</span>
<span class="cp"># ifdef SIC_IWR2</span>
	<span class="n">bfin_write_SIC_IWR2</span><span class="p">(</span><span class="n">IWR_DISABLE_ALL</span><span class="p">);</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
	<span class="n">bfin_write_SIC_IWR</span><span class="p">(</span><span class="n">IWR_DISABLE_ALL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#else  </span><span class="cm">/* CONFIG_BF60x */</span><span class="cp"></span>
	<span class="cm">/* Enable interrupts IVG7-15 */</span>
	<span class="n">bfin_irq_flags</span> <span class="o">|=</span> <span class="n">IMASK_IVG15</span> <span class="o">|</span>
	    <span class="n">IMASK_IVG14</span> <span class="o">|</span> <span class="n">IMASK_IVG13</span> <span class="o">|</span> <span class="n">IMASK_IVG12</span> <span class="o">|</span> <span class="n">IMASK_IVG11</span> <span class="o">|</span>
	    <span class="n">IMASK_IVG10</span> <span class="o">|</span> <span class="n">IMASK_IVG9</span> <span class="o">|</span> <span class="n">IMASK_IVG8</span> <span class="o">|</span> <span class="n">IMASK_IVG7</span> <span class="o">|</span> <span class="n">IMASK_IVGHW</span><span class="p">;</span>


	<span class="n">bfin_write_SEC_FCTL</span><span class="p">(</span><span class="n">SEC_FCTL_EN</span> <span class="o">|</span> <span class="n">SEC_FCTL_SYSRST_EN</span> <span class="o">|</span> <span class="n">SEC_FCTL_FLTIN_EN</span><span class="p">);</span>
	<span class="n">bfin_sec_enable_sci</span><span class="p">(</span><span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">IRQ_WATCH0</span><span class="p">));</span>
	<span class="n">bfin_sec_enable_ssi</span><span class="p">(</span><span class="n">SIC_SYSIRQ</span><span class="p">(</span><span class="n">IRQ_WATCH0</span><span class="p">));</span>
	<span class="n">bfin_write_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CCTL</span><span class="p">,</span> <span class="n">SEC_CCTL_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_GCTL</span><span class="p">(</span><span class="n">SEC_GCTL_EN</span><span class="p">);</span>
	<span class="n">bfin_write_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CCTL</span><span class="p">,</span> <span class="n">SEC_CCTL_EN</span> <span class="o">|</span> <span class="n">SEC_CCTL_NMI_EN</span><span class="p">);</span>
	<span class="n">init_software_driven_irq</span><span class="p">();</span>
	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec_pm_syscore_ops</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DO_IRQ_L1</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vec_to_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_BF60x</span>
	<span class="k">struct</span> <span class="n">ivgx</span> <span class="o">*</span><span class="n">ivg</span> <span class="o">=</span> <span class="n">ivg7_13</span><span class="p">[</span><span class="n">vec</span> <span class="o">-</span> <span class="n">IVG7</span><span class="p">].</span><span class="n">ifirst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivgx</span> <span class="o">*</span><span class="n">ivg_stop</span> <span class="o">=</span> <span class="n">ivg7_13</span><span class="p">[</span><span class="n">vec</span> <span class="o">-</span> <span class="n">IVG7</span><span class="p">].</span><span class="n">istop</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sic_status</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="n">EVT_IVTMR_P</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_CORETMR</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_BF60x</span>
<span class="cp">#ifdef SIC_ISR</span>
	<span class="n">sic_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfin_read_SIC_IMASK</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">bfin_read_SIC_ISR</span><span class="p">();</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smp_processor_id</span><span class="p">())</span> <span class="p">{</span>
<span class="cp"># ifdef SICB_ISR0</span>
		<span class="cm">/* This will be optimized out in UP mode. */</span>
		<span class="n">sic_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfin_read_SICB_ISR0</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">bfin_read_SICB_IMASK0</span><span class="p">();</span>
		<span class="n">sic_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfin_read_SICB_ISR1</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">bfin_read_SICB_IMASK1</span><span class="p">();</span>
<span class="cp"># endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sic_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfin_read_SIC_ISR0</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">bfin_read_SIC_IMASK0</span><span class="p">();</span>
		<span class="n">sic_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfin_read_SIC_ISR1</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">bfin_read_SIC_IMASK1</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef SIC_ISR2</span>
	<span class="n">sic_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfin_read_SIC_ISR2</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">bfin_read_SIC_IMASK2</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(;;</span> <span class="n">ivg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivg</span> <span class="o">&gt;=</span> <span class="n">ivg_stop</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef SIC_ISR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sic_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ivg</span><span class="o">-&gt;</span><span class="n">isrflag</span><span class="p">)</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sic_status</span><span class="p">[(</span><span class="n">ivg</span><span class="o">-&gt;</span><span class="n">irqno</span> <span class="o">-</span> <span class="n">IVG7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ivg</span><span class="o">-&gt;</span><span class="n">isrflag</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="n">ivg</span><span class="o">-&gt;</span><span class="n">irqno</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="cm">/* for bf60x read */</span>
	<span class="k">return</span> <span class="n">BFIN_IRQ</span><span class="p">(</span><span class="n">bfin_read_SEC_SCI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEC_CSID</span><span class="p">));</span>
<span class="cp">#endif  </span><span class="cm">/* end of CONFIG_BF60x */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DO_IRQ_L1</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="cp">#endif</span>
<span class="kt">void</span> <span class="n">do_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">vec_to_irq</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">asm_do_IRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPIPE</span>

<span class="kt">int</span> <span class="n">__ipipe_get_irq_priority</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ient</span><span class="p">,</span> <span class="n">prio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">IRQ_CORETMR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ient</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ient</span> <span class="o">&lt;</span> <span class="n">NR_PERI_INTS</span><span class="p">;</span> <span class="n">ient</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ivgx</span> <span class="o">*</span><span class="n">ivg</span> <span class="o">=</span> <span class="n">ivg_table</span> <span class="o">+</span> <span class="n">ient</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivg</span><span class="o">-&gt;</span><span class="n">irqno</span> <span class="o">==</span> <span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prio</span> <span class="o">&lt;=</span> <span class="n">IVG13</span><span class="o">-</span><span class="n">IVG7</span><span class="p">;</span> <span class="n">prio</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ivg7_13</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">ifirst</span> <span class="o">&lt;=</span> <span class="n">ivg</span> <span class="o">&amp;&amp;</span>
				    <span class="n">ivg7_13</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">istop</span> <span class="o">&gt;</span> <span class="n">ivg</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">IVG7</span> <span class="o">+</span> <span class="n">prio</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IVG15</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Hw interrupts are disabled on entry (check SAVE_CONTEXT). */</span>
<span class="cp">#ifdef CONFIG_DO_IRQ_L1</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="cp">#endif</span>
<span class="n">asmlinkage</span> <span class="kt">int</span> <span class="n">__ipipe_grab_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipipe_percpu_domain_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ipipe_root_cpudom_ptr</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">ipipe_domain</span> <span class="o">*</span><span class="n">this_domain</span> <span class="o">=</span> <span class="n">__ipipe_current_domain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivgx</span> <span class="o">*</span><span class="n">ivg_stop</span> <span class="o">=</span> <span class="n">ivg7_13</span><span class="p">[</span><span class="n">vec</span><span class="o">-</span><span class="n">IVG7</span><span class="p">].</span><span class="n">istop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivgx</span> <span class="o">*</span><span class="n">ivg</span> <span class="o">=</span> <span class="n">ivg7_13</span><span class="p">[</span><span class="n">vec</span><span class="o">-</span><span class="n">IVG7</span><span class="p">].</span><span class="n">ifirst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">vec_to_irq</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">IRQ_SYSTMR</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if !defined(CONFIG_GENERIC_CLOCKEVENTS) || defined(CONFIG_TICKSOURCE_GPTMR0)</span>
		<span class="n">bfin_write_TIMER_STATUS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Latch TIMIL0 */</span>
<span class="cp">#endif</span>
		<span class="cm">/* This is basically what we need from the register frame. */</span>
		<span class="n">__raw_get_cpu_var</span><span class="p">(</span><span class="n">__ipipe_tick_regs</span><span class="p">).</span><span class="n">ipend</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ipend</span><span class="p">;</span>
		<span class="n">__raw_get_cpu_var</span><span class="p">(</span><span class="n">__ipipe_tick_regs</span><span class="p">).</span><span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_domain</span> <span class="o">!=</span> <span class="n">ipipe_root_domain</span><span class="p">)</span>
			<span class="n">__raw_get_cpu_var</span><span class="p">(</span><span class="n">__ipipe_tick_regs</span><span class="p">).</span><span class="n">ipend</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">__raw_get_cpu_var</span><span class="p">(</span><span class="n">__ipipe_tick_regs</span><span class="p">).</span><span class="n">ipend</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want Linux interrupt handlers to run at the</span>
<span class="cm">	 * current core priority level (i.e. &lt; EVT15), since this</span>
<span class="cm">	 * might delay other interrupts handled by a high priority</span>
<span class="cm">	 * domain. Here is what we do instead:</span>
<span class="cm">	 *</span>
<span class="cm">	 * - we raise the SYNCDEFER bit to prevent</span>
<span class="cm">	 * __ipipe_handle_irq() to sync the pipeline for the root</span>
<span class="cm">	 * stage for the incoming interrupt. Upon return, that IRQ is</span>
<span class="cm">	 * pending in the interrupt log.</span>
<span class="cm">	 *</span>
<span class="cm">	 * - we raise the TIF_IRQ_SYNC bit for the current thread, so</span>
<span class="cm">	 * that _schedule_and_signal_from_int will eventually sync the</span>
<span class="cm">	 * pipeline from EVT15.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_domain</span> <span class="o">==</span> <span class="n">ipipe_root_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">__test_and_set_bit</span><span class="p">(</span><span class="n">IPIPE_SYNCDEFER_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ipipe_trace_irq_entry</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">__ipipe_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="n">ipipe_trace_irq_exit</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ipipe_test_foreign_stack</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ipipe_flags</span> <span class="o">&amp;</span> <span class="n">PF_EVTRET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Testing for user_regs() does NOT fully eliminate</span>
<span class="cm">		 * foreign stack contexts, because of the forged</span>
<span class="cm">		 * interrupt returns we do through</span>
<span class="cm">		 * __ipipe_call_irqtail. In that case, we might have</span>
<span class="cm">		 * preempted a foreign stack context in a high</span>
<span class="cm">		 * priority domain, with a single interrupt level now</span>
<span class="cm">		 * pending after the irqtail unwinding is done. In</span>
<span class="cm">		 * which case user_mode() is now true, and the event</span>
<span class="cm">		 * gets dispatched spuriously.</span>
<span class="cm">		 */</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">ipipe_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PF_EVTRET</span><span class="p">;</span>
		<span class="n">__ipipe_dispatch_event</span><span class="p">(</span><span class="n">IPIPE_EVENT_RETURN</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_domain</span> <span class="o">==</span> <span class="n">ipipe_root_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_thread_flag</span><span class="p">(</span><span class="n">TIF_IRQ_SYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__clear_bit</span><span class="p">(</span><span class="n">IPIPE_SYNCDEFER_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IPIPE_STALL_FLAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_IPIPE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
