<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › blackfin › mach-common › clocks-init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>clocks-init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/blackfin/mach-common/clocks-init.c - reprogram clocks / memory</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2004-2008 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/linkage.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;asm/blackfin.h&gt;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/clocks.h&gt;</span>
<span class="cp">#include &lt;asm/mem_init.h&gt;</span>
<span class="cp">#include &lt;asm/dpmc.h&gt;</span>

<span class="cp">#ifdef CONFIG_BF60x</span>
<span class="cp">#define CSEL_P			0</span>
<span class="cp">#define S0SEL_P			5</span>
<span class="cp">#define SYSSEL_P		8</span>
<span class="cp">#define S1SEL_P			13</span>
<span class="cp">#define DSEL_P			16</span>
<span class="cp">#define OSEL_P			22</span>
<span class="cp">#define ALGN_P			29</span>
<span class="cp">#define UPDT_P			30</span>
<span class="cp">#define LOCK_P			31</span>

<span class="cp">#define CGU_CTL_VAL ((CONFIG_VCO_MULT &lt;&lt; 8) | CLKIN_HALF)</span>
<span class="cp">#define CGU_DIV_VAL \</span>
<span class="cp">	((CONFIG_CCLK_DIV   &lt;&lt; CSEL_P)   | \</span>
<span class="cp">	(CONFIG_SCLK_DIV &lt;&lt; SYSSEL_P)   | \</span>
<span class="cp">	(CONFIG_SCLK0_DIV  &lt;&lt; S0SEL_P)  | \</span>
<span class="cp">	(CONFIG_SCLK1_DIV  &lt;&lt; S1SEL_P)  | \</span>
<span class="cp">	(CONFIG_DCLK_DIV   &lt;&lt; DSEL_P))</span>

<span class="cp">#define CONFIG_BFIN_DCLK (((CONFIG_CLKIN_HZ * CONFIG_VCO_MULT) / CONFIG_DCLK_DIV) / 1000000)</span>
<span class="cp">#if ((CONFIG_BFIN_DCLK != 125) &amp;&amp; \</span>
<span class="cp">	(CONFIG_BFIN_DCLK != 133) &amp;&amp; (CONFIG_BFIN_DCLK != 150) &amp;&amp; \</span>
<span class="cp">	(CONFIG_BFIN_DCLK != 166) &amp;&amp; (CONFIG_BFIN_DCLK != 200) &amp;&amp; \</span>
<span class="cp">	(CONFIG_BFIN_DCLK != 225) &amp;&amp; (CONFIG_BFIN_DCLK != 250))</span>
<span class="cp">#error &quot;DCLK must be in (125, 133, 150, 166, 200, 225, 250)MHz&quot;</span>
<span class="cp">#endif</span>
<span class="k">struct</span> <span class="n">ddr_config</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ddr_clk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmc_ddrctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmc_ddrcfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmc_ddrtr0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmc_ddrtr1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmc_ddrtr2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmc_ddrmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmc_ddrmr1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ddr_config</span> <span class="n">ddr_config_table</span><span class="p">[]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&quot;.data_l1&quot;</span><span class="p">)))</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ddr_clk</span>    <span class="o">=</span> <span class="mi">125</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrctl</span> <span class="o">=</span> <span class="mh">0x00000904</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrcfg</span> <span class="o">=</span> <span class="mh">0x00000422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr0</span> <span class="o">=</span> <span class="mh">0x20705212</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr1</span> <span class="o">=</span> <span class="mh">0x201003CF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr2</span> <span class="o">=</span> <span class="mh">0x00320107</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr</span>  <span class="o">=</span> <span class="mh">0x00000422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr1</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ddr_clk</span>    <span class="o">=</span> <span class="mi">133</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrctl</span> <span class="o">=</span> <span class="mh">0x00000904</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrcfg</span> <span class="o">=</span> <span class="mh">0x00000422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr0</span> <span class="o">=</span> <span class="mh">0x20806313</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr1</span> <span class="o">=</span> <span class="mh">0x2013040D</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr2</span> <span class="o">=</span> <span class="mh">0x00320108</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr</span>  <span class="o">=</span> <span class="mh">0x00000632</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr1</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ddr_clk</span>    <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrctl</span> <span class="o">=</span> <span class="mh">0x00000904</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrcfg</span> <span class="o">=</span> <span class="mh">0x00000422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr0</span> <span class="o">=</span> <span class="mh">0x20A07323</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr1</span> <span class="o">=</span> <span class="mh">0x20160492</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr2</span> <span class="o">=</span> <span class="mh">0x00320209</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr</span>  <span class="o">=</span> <span class="mh">0x00000632</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr1</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ddr_clk</span>    <span class="o">=</span> <span class="mi">166</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrctl</span> <span class="o">=</span> <span class="mh">0x00000904</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrcfg</span> <span class="o">=</span> <span class="mh">0x00000422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr0</span> <span class="o">=</span> <span class="mh">0x20A07323</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr1</span> <span class="o">=</span> <span class="mh">0x2016050E</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr2</span> <span class="o">=</span> <span class="mh">0x00320209</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr</span>  <span class="o">=</span> <span class="mh">0x00000632</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr1</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ddr_clk</span>    <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrctl</span> <span class="o">=</span> <span class="mh">0x00000904</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrcfg</span> <span class="o">=</span> <span class="mh">0x00000422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr0</span> <span class="o">=</span> <span class="mh">0x20a07323</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr1</span> <span class="o">=</span> <span class="mh">0x2016050f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr2</span> <span class="o">=</span> <span class="mh">0x00320509</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr</span>  <span class="o">=</span> <span class="mh">0x00000632</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr1</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ddr_clk</span>    <span class="o">=</span> <span class="mi">225</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrctl</span> <span class="o">=</span> <span class="mh">0x00000904</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrcfg</span> <span class="o">=</span> <span class="mh">0x00000422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr0</span> <span class="o">=</span> <span class="mh">0x20E0A424</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr1</span> <span class="o">=</span> <span class="mh">0x302006DB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr2</span> <span class="o">=</span> <span class="mh">0x0032020D</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr</span>  <span class="o">=</span> <span class="mh">0x00000842</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr1</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ddr_clk</span>    <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrctl</span> <span class="o">=</span> <span class="mh">0x00000904</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrcfg</span> <span class="o">=</span> <span class="mh">0x00000422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr0</span> <span class="o">=</span> <span class="mh">0x20E0A424</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr1</span> <span class="o">=</span> <span class="mh">0x3020079E</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrtr2</span> <span class="o">=</span> <span class="mh">0x0032020D</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr</span>  <span class="o">=</span> <span class="mh">0x00000842</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dmc_ddrmr1</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#define SDGCTL_WIDTH (1 &lt;&lt; 31)	</span><span class="cm">/* SDRAM external data path width */</span><span class="cp"></span>
<span class="cp">#define PLL_CTL_VAL \</span>
<span class="cp">	(((CONFIG_VCO_MULT &amp; 63) &lt;&lt; 9) | CLKIN_HALF | \</span>
<span class="cp">		(PLL_BYPASS &lt;&lt; 8) | (ANOMALY_05000305 ? 0 : 0x8000))</span>
<span class="cp">#endif</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_sync</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__builtin_bfin_ssync</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">l1_text</span><span class="p">))</span>
<span class="kt">void</span> <span class="n">init_clocks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Kill any active DMAs as they may trigger external memory accesses</span>
<span class="cm">	 * in the middle of reprogramming things, and that&#39;ll screw us up.</span>
<span class="cm">	 * For example, any automatic DMAs left by U-Boot for splash screens.</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_BF60x</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dlldatacycle</span><span class="p">,</span> <span class="n">dll_ctl</span><span class="p">;</span>
	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">CGU0_DIV</span><span class="p">,</span> <span class="n">CGU_DIV_VAL</span><span class="p">);</span>
	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">CGU0_CTL</span><span class="p">,</span> <span class="n">CGU_CTL_VAL</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">bfin_read32</span><span class="p">(</span><span class="n">CGU0_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">bfin_read32</span><span class="p">(</span><span class="n">CGU0_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="n">bfin_write32</span><span class="p">(</span><span class="n">CGU0_DIV</span><span class="p">,</span> <span class="n">CGU_DIV_VAL</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">UPDT_P</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bfin_read32</span><span class="p">(</span><span class="n">CGU0_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ddr_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ddr_clk</span> <span class="o">==</span> <span class="n">CONFIG_BFIN_DCLK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfin_write_DDR0_CFG</span><span class="p">(</span><span class="n">ddr_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dmc_ddrcfg</span><span class="p">);</span>
			<span class="n">bfin_write_DDR0_TR0</span><span class="p">(</span><span class="n">ddr_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dmc_ddrtr0</span><span class="p">);</span>
			<span class="n">bfin_write_DDR0_TR1</span><span class="p">(</span><span class="n">ddr_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dmc_ddrtr1</span><span class="p">);</span>
			<span class="n">bfin_write_DDR0_TR2</span><span class="p">(</span><span class="n">ddr_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dmc_ddrtr2</span><span class="p">);</span>
			<span class="n">bfin_write_DDR0_MR</span><span class="p">(</span><span class="n">ddr_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dmc_ddrmr</span><span class="p">);</span>
			<span class="n">bfin_write_DDR0_EMR1</span><span class="p">(</span><span class="n">ddr_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dmc_ddrmr1</span><span class="p">);</span>
			<span class="n">bfin_write_DDR0_CTL</span><span class="p">(</span><span class="n">ddr_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dmc_ddrctl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">do_sync</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bfin_read_DDR0_STAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="n">dlldatacycle</span> <span class="o">=</span> <span class="p">(</span><span class="n">bfin_read_DDR0_STAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x00f00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">dll_ctl</span> <span class="o">=</span> <span class="n">bfin_read_DDR0_DLLCTL</span><span class="p">();</span>
	<span class="n">dll_ctl</span> <span class="o">&amp;=</span> <span class="mh">0x0ff</span><span class="p">;</span>
	<span class="n">bfin_write_DDR0_DLLCTL</span><span class="p">(</span><span class="n">dll_ctl</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlldatacycle</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">do_sync</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bfin_read_DDR0_STAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DMA_CHANNELS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dma_register</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_io_base_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">do_sync</span><span class="p">();</span>

<span class="cp">#ifdef SIC_IWR0</span>
	<span class="n">bfin_write_SIC_IWR0</span><span class="p">(</span><span class="n">IWR_ENABLE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="cp"># ifdef SIC_IWR1</span>
	<span class="cm">/* BF52x system reset does not properly reset SIC_IWR1 which</span>
<span class="cm">	 * will screw up the bootrom as it relies on MDMA0/1 waking it</span>
<span class="cm">	 * up from IDLE instructions.  See this report for more info:</span>
<span class="cm">	 * http://blackfin.uclinux.org/gf/tracker/4323</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ANOMALY_05000435</span><span class="p">)</span>
		<span class="n">bfin_write_SIC_IWR1</span><span class="p">(</span><span class="n">IWR_ENABLE</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">IWR_ENABLE</span><span class="p">(</span><span class="mi">11</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">bfin_write_SIC_IWR1</span><span class="p">(</span><span class="n">IWR_DISABLE_ALL</span><span class="p">);</span>
<span class="cp"># endif</span>
<span class="cp"># ifdef SIC_IWR2</span>
	<span class="n">bfin_write_SIC_IWR2</span><span class="p">(</span><span class="n">IWR_DISABLE_ALL</span><span class="p">);</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
	<span class="n">bfin_write_SIC_IWR</span><span class="p">(</span><span class="n">IWR_ENABLE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">do_sync</span><span class="p">();</span>
<span class="cp">#ifdef EBIU_SDGCTL</span>
	<span class="n">bfin_write_EBIU_SDGCTL</span><span class="p">(</span><span class="n">bfin_read_EBIU_SDGCTL</span><span class="p">()</span> <span class="o">|</span> <span class="n">SRFS</span><span class="p">);</span>
	<span class="n">do_sync</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CLKBUFOE</span>
	<span class="n">bfin_write16</span><span class="p">(</span><span class="n">VR_CTL</span><span class="p">,</span> <span class="n">bfin_read_VR_CTL</span><span class="p">()</span> <span class="o">|</span> <span class="n">CLKBUFOE</span><span class="p">);</span>
	<span class="n">do_sync</span><span class="p">();</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;IDLE;&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">bfin_write_PLL_LOCKCNT</span><span class="p">(</span><span class="mh">0x300</span><span class="p">);</span>
	<span class="n">do_sync</span><span class="p">();</span>
	<span class="cm">/* We always write PLL_CTL thus avoiding Anomaly 05000242 */</span>
	<span class="n">bfin_write16</span><span class="p">(</span><span class="n">PLL_CTL</span><span class="p">,</span> <span class="n">PLL_CTL_VAL</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;IDLE;&quot;</span><span class="p">);</span>
	<span class="n">bfin_write_PLL_DIV</span><span class="p">(</span><span class="n">CONFIG_CCLK_ACT_DIV</span> <span class="o">|</span> <span class="n">CONFIG_SCLK_DIV</span><span class="p">);</span>
<span class="cp">#ifdef EBIU_SDGCTL</span>
	<span class="n">bfin_write_EBIU_SDRRC</span><span class="p">(</span><span class="n">mem_SDRRC</span><span class="p">);</span>
	<span class="n">bfin_write_EBIU_SDGCTL</span><span class="p">((</span><span class="n">bfin_read_EBIU_SDGCTL</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">SDGCTL_WIDTH</span><span class="p">)</span> <span class="o">|</span> <span class="n">mem_SDGCTL</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">bfin_write_EBIU_RSTCTL</span><span class="p">(</span><span class="n">bfin_read_EBIU_RSTCTL</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SRREQ</span><span class="p">));</span>
	<span class="n">do_sync</span><span class="p">();</span>
	<span class="n">bfin_write_EBIU_RSTCTL</span><span class="p">(</span><span class="n">bfin_read_EBIU_RSTCTL</span><span class="p">()</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">bfin_write_EBIU_DDRCTL0</span><span class="p">(</span><span class="n">mem_DDRCTL0</span><span class="p">);</span>
	<span class="n">bfin_write_EBIU_DDRCTL1</span><span class="p">(</span><span class="n">mem_DDRCTL1</span><span class="p">);</span>
	<span class="n">bfin_write_EBIU_DDRCTL2</span><span class="p">(</span><span class="n">mem_DDRCTL2</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MEM_EBIU_DDRQUE</span>
	<span class="n">bfin_write_EBIU_DDRQUE</span><span class="p">(</span><span class="n">CONFIG_MEM_EBIU_DDRQUE</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="n">do_sync</span><span class="p">();</span>
	<span class="n">bfin_read16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
