<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › mm › tsb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tsb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* arch/sparc64/mm/tsb.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006, 2008 David S. Miller &lt;davem@davemloft.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/preempt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/tlb.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/tsb.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">tsb</span> <span class="n">swapper_tsb</span><span class="p">[</span><span class="n">KERNEL_TSB_NENTRIES</span><span class="p">];</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">tsb_hash</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hash_shift</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nentries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vaddr</span> <span class="o">&gt;&gt;=</span> <span class="n">hash_shift</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">vaddr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tag_compare</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* TSB flushes need only occur on the processor initiating the address</span>
<span class="cm"> * space modification, not on each cpu the address space has run on.</span>
<span class="cm"> * Only the TLB flush needs that treatment.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">flush_tsb_kernel_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">v</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">tsb_hash</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
					      <span class="n">KERNEL_TSB_NENTRIES</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">tsb</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">swapper_tsb</span><span class="p">[</span><span class="n">hash</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tag_compare</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">TSB_TAG_INVALID_BIT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__flush_tsb_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlb_batch</span> <span class="o">*</span><span class="n">tb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hash_shift</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tsb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nentries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">tlb_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">vaddrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="n">hash</span><span class="p">;</span>

		<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1UL</span><span class="p">;</span>

		<span class="n">hash</span> <span class="o">=</span> <span class="n">tsb_hash</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">hash_shift</span><span class="p">,</span> <span class="n">nentries</span><span class="p">);</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">tsb</span> <span class="o">+</span> <span class="p">(</span><span class="n">hash</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb</span><span class="p">));</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">22UL</span><span class="p">);</span>

		<span class="n">tsb_flush</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">flush_tsb_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlb_batch</span> <span class="o">*</span><span class="n">tb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nentries</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">MM_TSB_BASE</span><span class="p">].</span><span class="n">tsb</span><span class="p">;</span>
	<span class="n">nentries</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">MM_TSB_BASE</span><span class="p">].</span><span class="n">tsb_nentries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">cheetah_plus</span> <span class="o">||</span> <span class="n">tlb_type</span> <span class="o">==</span> <span class="n">hypervisor</span><span class="p">)</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">__flush_tsb_one</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">nentries</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">MM_TSB_HUGE</span><span class="p">].</span><span class="n">tsb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">MM_TSB_HUGE</span><span class="p">].</span><span class="n">tsb</span><span class="p">;</span>
		<span class="n">nentries</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">MM_TSB_HUGE</span><span class="p">].</span><span class="n">tsb_nentries</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">cheetah_plus</span> <span class="o">||</span> <span class="n">tlb_type</span> <span class="o">==</span> <span class="n">hypervisor</span><span class="p">)</span>
			<span class="n">base</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
		<span class="n">__flush_tsb_one</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">HPAGE_SHIFT</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">nentries</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SPARC64_PAGE_SIZE_8KB)</span>
<span class="cp">#define HV_PGSZ_IDX_BASE	HV_PGSZ_IDX_8K</span>
<span class="cp">#define HV_PGSZ_MASK_BASE	HV_PGSZ_MASK_8K</span>
<span class="cp">#elif defined(CONFIG_SPARC64_PAGE_SIZE_64KB)</span>
<span class="cp">#define HV_PGSZ_IDX_BASE	HV_PGSZ_IDX_64K</span>
<span class="cp">#define HV_PGSZ_MASK_BASE	HV_PGSZ_MASK_64K</span>
<span class="cp">#else</span>
<span class="cp">#error Broken base page size setting...</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
<span class="cp">#if defined(CONFIG_HUGETLB_PAGE_SIZE_64K)</span>
<span class="cp">#define HV_PGSZ_IDX_HUGE	HV_PGSZ_IDX_64K</span>
<span class="cp">#define HV_PGSZ_MASK_HUGE	HV_PGSZ_MASK_64K</span>
<span class="cp">#elif defined(CONFIG_HUGETLB_PAGE_SIZE_512K)</span>
<span class="cp">#define HV_PGSZ_IDX_HUGE	HV_PGSZ_IDX_512K</span>
<span class="cp">#define HV_PGSZ_MASK_HUGE	HV_PGSZ_MASK_512K</span>
<span class="cp">#elif defined(CONFIG_HUGETLB_PAGE_SIZE_4MB)</span>
<span class="cp">#define HV_PGSZ_IDX_HUGE	HV_PGSZ_IDX_4MB</span>
<span class="cp">#define HV_PGSZ_MASK_HUGE	HV_PGSZ_MASK_4MB</span>
<span class="cp">#else</span>
<span class="cp">#error Broken huge page size setting...</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_tsb_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tsb_idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tsb_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tsb_reg</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">tsb_paddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page_sz</span><span class="p">,</span> <span class="n">tte</span><span class="p">;</span>

	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">].</span><span class="n">tsb_nentries</span> <span class="o">=</span>
		<span class="n">tsb_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">TSBMAP_BASE</span><span class="p">;</span>
	<span class="n">tte</span> <span class="o">=</span> <span class="n">pgprot_val</span><span class="p">(</span><span class="n">PAGE_KERNEL_LOCKED</span><span class="p">);</span>
	<span class="n">tsb_paddr</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">].</span><span class="n">tsb</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tsb_paddr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tsb_bytes</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">));</span>

	<span class="cm">/* Use the smallest page size that can map the whole TSB</span>
<span class="cm">	 * in one TLB entry.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tsb_bytes</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>:
		<span class="n">tsb_reg</span> <span class="o">=</span> <span class="mh">0x0UL</span><span class="p">;</span>
<span class="cp">#ifdef DCACHE_ALIASING_POSSIBLE</span>
		<span class="n">base</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tsb_paddr</span> <span class="o">&amp;</span> <span class="mi">8192</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">page_sz</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>:
		<span class="n">tsb_reg</span> <span class="o">=</span> <span class="mh">0x1UL</span><span class="p">;</span>
		<span class="n">page_sz</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>:
		<span class="n">tsb_reg</span> <span class="o">=</span> <span class="mh">0x2UL</span><span class="p">;</span>
		<span class="n">page_sz</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>:
		<span class="n">tsb_reg</span> <span class="o">=</span> <span class="mh">0x3UL</span><span class="p">;</span>
		<span class="n">page_sz</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>:
		<span class="n">tsb_reg</span> <span class="o">=</span> <span class="mh">0x4UL</span><span class="p">;</span>
		<span class="n">page_sz</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>:
		<span class="n">tsb_reg</span> <span class="o">=</span> <span class="mh">0x5UL</span><span class="p">;</span>
		<span class="n">page_sz</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>:
		<span class="n">tsb_reg</span> <span class="o">=</span> <span class="mh">0x6UL</span><span class="p">;</span>
		<span class="n">page_sz</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>:
		<span class="n">tsb_reg</span> <span class="o">=</span> <span class="mh">0x7UL</span><span class="p">;</span>
		<span class="n">page_sz</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;TSB[%s:%d]: Impossible TSB size %lu, killing process.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">tsb_bytes</span><span class="p">);</span>
		<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tte</span> <span class="o">|=</span> <span class="n">pte_sz_bits</span><span class="p">(</span><span class="n">page_sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">cheetah_plus</span> <span class="o">||</span> <span class="n">tlb_type</span> <span class="o">==</span> <span class="n">hypervisor</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Physical mapping, no locked TLB entry for TSB.  */</span>
		<span class="n">tsb_reg</span> <span class="o">|=</span> <span class="n">tsb_paddr</span><span class="p">;</span>

		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">].</span><span class="n">tsb_reg_val</span> <span class="o">=</span> <span class="n">tsb_reg</span><span class="p">;</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">].</span><span class="n">tsb_map_vaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">].</span><span class="n">tsb_map_pte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tsb_reg</span> <span class="o">|=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">tsb_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tsb_paddr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">page_sz</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">));</span>
		<span class="n">tte</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tsb_paddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">page_sz</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">));</span>

		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">].</span><span class="n">tsb_reg_val</span> <span class="o">=</span> <span class="n">tsb_reg</span><span class="p">;</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">].</span><span class="n">tsb_map_vaddr</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">].</span><span class="n">tsb_map_pte</span> <span class="o">=</span> <span class="n">tte</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the Hypervisor TSB descriptor.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">hypervisor</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hv_tsb_descr</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_descr</span><span class="p">[</span><span class="n">tsb_idx</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">tsb_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MM_TSB_BASE</span>:
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">pgsz_idx</span> <span class="o">=</span> <span class="n">HV_PGSZ_IDX_BASE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
		<span class="k">case</span> <span class="n">MM_TSB_HUGE</span>:
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">pgsz_idx</span> <span class="o">=</span> <span class="n">HV_PGSZ_IDX_HUGE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">num_ttes</span> <span class="o">=</span> <span class="n">tsb_bytes</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">ctx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tsb_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MM_TSB_BASE</span>:
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">pgsz_mask</span> <span class="o">=</span> <span class="n">HV_PGSZ_MASK_BASE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
		<span class="k">case</span> <span class="n">MM_TSB_HUGE</span>:
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">pgsz_mask</span> <span class="o">=</span> <span class="n">HV_PGSZ_MASK_HUGE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">tsb_base</span> <span class="o">=</span> <span class="n">tsb_paddr</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">resv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">pgtable_cache</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">tsb_caches</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tsb_cache_names</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;tsb_8KB&quot;</span><span class="p">,</span>
	<span class="s">&quot;tsb_16KB&quot;</span><span class="p">,</span>
	<span class="s">&quot;tsb_32KB&quot;</span><span class="p">,</span>
	<span class="s">&quot;tsb_64KB&quot;</span><span class="p">,</span>
	<span class="s">&quot;tsb_128KB&quot;</span><span class="p">,</span>
	<span class="s">&quot;tsb_256KB&quot;</span><span class="p">,</span>
	<span class="s">&quot;tsb_512KB&quot;</span><span class="p">,</span>
	<span class="s">&quot;tsb_1MB&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">pgtable_cache_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pgtable_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;pgtable_cache&quot;</span><span class="p">,</span>
					  <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					  <span class="mi">0</span><span class="p">,</span>
					  <span class="n">_clear_page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pgtable_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;pgtable_cache_init(): Could not create!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">tsb_cache_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">tsb_caches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
						  <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tsb_caches</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Could not create %s cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">prom_halt</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">sysctl_tsb_ratio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">tsb_size_to_rss_limit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_ents</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sysctl_tsb_ratio</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">num_ents</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_ents</span> <span class="o">&gt;&gt;</span> <span class="o">-</span><span class="n">sysctl_tsb_ratio</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">num_ents</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_ents</span> <span class="o">&gt;&gt;</span> <span class="n">sysctl_tsb_ratio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* When the RSS of an address space exceeds tsb_rss_limit for a TSB,</span>
<span class="cm"> * do_sparc64_fault() invokes this routine to try and grow it.</span>
<span class="cm"> *</span>
<span class="cm"> * When we reach the maximum TSB size supported, we stick ~0UL into</span>
<span class="cm"> * tsb_rss_limit for that TSB so the grow checks in do_sparc64_fault()</span>
<span class="cm"> * will not trigger any longer.</span>
<span class="cm"> *</span>
<span class="cm"> * The TSB can be anywhere from 8K to 1MB in size, in increasing powers</span>
<span class="cm"> * of two.  The TSB must be aligned to it&#39;s size, so f.e. a 512K TSB</span>
<span class="cm"> * must be 512K aligned.  It also must be physically contiguous, so we</span>
<span class="cm"> * cannot use vmalloc().</span>
<span class="cm"> *</span>
<span class="cm"> * The idea here is to grow the TSB when the RSS of the process approaches</span>
<span class="cm"> * the number of entries that the current TSB can hold at once.  Currently,</span>
<span class="cm"> * we trigger when the RSS hits 3/4 of the TSB capacity.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tsb_grow</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tsb_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_tsb_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">old_size</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsb</span> <span class="o">*</span><span class="n">old_tsb</span><span class="p">,</span> <span class="o">*</span><span class="n">new_tsb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_cache_index</span><span class="p">,</span> <span class="n">old_cache_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_rss_limit</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_tsb_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_ORDER</span><span class="p">))</span>
		<span class="n">max_tsb_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_ORDER</span><span class="p">);</span>

	<span class="n">new_cache_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span> <span class="n">new_size</span> <span class="o">&lt;</span> <span class="n">max_tsb_size</span><span class="p">;</span> <span class="n">new_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_rss_limit</span> <span class="o">=</span> <span class="n">tsb_size_to_rss_limit</span><span class="p">(</span><span class="n">new_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_rss_limit</span> <span class="o">&gt;</span> <span class="n">rss</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">new_cache_index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">==</span> <span class="n">max_tsb_size</span><span class="p">)</span>
		<span class="n">new_rss_limit</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>

<span class="nl">retry_tsb_alloc:</span>
	<span class="n">gfp_flags</span> <span class="o">=</span> <span class="n">GFP_KERNEL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">gfp_flags</span> <span class="o">=</span> <span class="n">__GFP_NOWARN</span> <span class="o">|</span> <span class="n">__GFP_NORETRY</span><span class="p">;</span>

	<span class="n">new_tsb</span> <span class="o">=</span> <span class="n">kmem_cache_alloc_node</span><span class="p">(</span><span class="n">tsb_caches</span><span class="p">[</span><span class="n">new_cache_index</span><span class="p">],</span>
					<span class="n">gfp_flags</span><span class="p">,</span> <span class="n">numa_node_id</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">new_tsb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not being able to fork due to a high-order TSB</span>
<span class="cm">		 * allocation failure is very bad behavior.  Just back</span>
<span class="cm">		 * down to a 0-order allocation and force no TSB</span>
<span class="cm">		 * growing for this address space.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">new_cache_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_cache_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">new_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
			<span class="n">new_rss_limit</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry_tsb_alloc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If we failed on a TSB grow, we are under serious</span>
<span class="cm">		 * memory pressure so don&#39;t try to grow any more.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb_rss_limit</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mark all tags as invalid.  */</span>
	<span class="n">tsb_init</span><span class="p">(</span><span class="n">new_tsb</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>

	<span class="cm">/* Ok, we are about to commit the changes.  If we are</span>
<span class="cm">	 * growing an existing TSB the locking is very tricky,</span>
<span class="cm">	 * so WATCH OUT!</span>
<span class="cm">	 *</span>
<span class="cm">	 * We have to hold mm-&gt;context.lock while committing to the</span>
<span class="cm">	 * new TSB, this synchronizes us with processors in</span>
<span class="cm">	 * flush_tsb_user() and switch_mm() for this address space.</span>
<span class="cm">	 *</span>
<span class="cm">	 * But even with that lock held, processors run asynchronously</span>
<span class="cm">	 * accessing the old TSB via TLB miss handling.  This is OK</span>
<span class="cm">	 * because those actions are just propagating state from the</span>
<span class="cm">	 * Linux page tables into the TSB, page table mappings are not</span>
<span class="cm">	 * being changed.  If a real fault occurs, the processor will</span>
<span class="cm">	 * synchronize with us when it hits flush_tsb_user(), this is</span>
<span class="cm">	 * also true for the case where vmscan is modifying the page</span>
<span class="cm">	 * tables.  The only thing we need to be careful with is to</span>
<span class="cm">	 * skip any locked TSB entries during copy_tsb().</span>
<span class="cm">	 *</span>
<span class="cm">	 * When we finish committing to the new TSB, we have to drop</span>
<span class="cm">	 * the lock and ask all other cpus running this address space</span>
<span class="cm">	 * to run tsb_context_switch() to see the new TSB table.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">old_tsb</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb</span><span class="p">;</span>
	<span class="n">old_cache_index</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb_reg_val</span> <span class="o">&amp;</span> <span class="mh">0x7UL</span><span class="p">);</span>
	<span class="n">old_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb_nentries</span> <span class="o">*</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb</span><span class="p">));</span>


	<span class="cm">/* Handle multiple threads trying to grow the TSB at the same time.</span>
<span class="cm">	 * One will get in here first, and bump the size and the RSS limit.</span>
<span class="cm">	 * The others will get in here next and hit this check.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">old_tsb</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">rss</span> <span class="o">&lt;</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb_rss_limit</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">tsb_caches</span><span class="p">[</span><span class="n">new_cache_index</span><span class="p">],</span> <span class="n">new_tsb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb_rss_limit</span> <span class="o">=</span> <span class="n">new_rss_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_tsb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">extern</span> <span class="kt">void</span> <span class="n">copy_tsb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_tsb_base</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_tsb_size</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_tsb_base</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_tsb_size</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_tsb_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">old_tsb</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_tsb_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">new_tsb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">cheetah_plus</span> <span class="o">||</span> <span class="n">tlb_type</span> <span class="o">==</span> <span class="n">hypervisor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">old_tsb_base</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">old_tsb_base</span><span class="p">);</span>
			<span class="n">new_tsb_base</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">new_tsb_base</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">copy_tsb</span><span class="p">(</span><span class="n">old_tsb_base</span><span class="p">,</span> <span class="n">old_size</span><span class="p">,</span> <span class="n">new_tsb_base</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">tsb_index</span><span class="p">].</span><span class="n">tsb</span> <span class="o">=</span> <span class="n">new_tsb</span><span class="p">;</span>
	<span class="n">setup_tsb_params</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">tsb_index</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* If old_tsb is NULL, we&#39;re being invoked for the first time</span>
<span class="cm">	 * from init_new_context().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_tsb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reload it on the local cpu.  */</span>
		<span class="n">tsb_context_switch</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>

		<span class="cm">/* Now force other processors to do the same.  */</span>
		<span class="n">preempt_disable</span><span class="p">();</span>
		<span class="n">smp_tsb_sync</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
		<span class="n">preempt_enable</span><span class="p">();</span>

		<span class="cm">/* Now it is safe to free the old tsb.  */</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">tsb_caches</span><span class="p">[</span><span class="n">old_cache_index</span><span class="p">],</span> <span class="n">old_tsb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">init_new_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">huge_pte_count</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sparc64_ctx_val</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
	<span class="cm">/* We reset it to zero because the fork() page copying</span>
<span class="cm">	 * will re-increment the counters as the parent PTEs are</span>
<span class="cm">	 * copied into the child address space.</span>
<span class="cm">	 */</span>
	<span class="n">huge_pte_count</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">huge_pte_count</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">huge_pte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* copy_mm() copies over the parent&#39;s mm_struct before calling</span>
<span class="cm">	 * us, so we need to zero out the TSB pointer or else tsb_grow()</span>
<span class="cm">	 * will be confused and think there is an older TSB to free up.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MM_NUM_TSBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tsb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If this is fork, inherit the parent&#39;s TSB size.  We would</span>
<span class="cm">	 * grow it to that size on the first page fault anyways.</span>
<span class="cm">	 */</span>
	<span class="n">tsb_grow</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">MM_TSB_BASE</span><span class="p">,</span> <span class="n">get_mm_rss</span><span class="p">(</span><span class="n">mm</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">huge_pte_count</span><span class="p">))</span>
		<span class="n">tsb_grow</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">MM_TSB_HUGE</span><span class="p">,</span> <span class="n">huge_pte_count</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">MM_TSB_BASE</span><span class="p">].</span><span class="n">tsb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsb_destroy_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb_config</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cache_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tsb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cache_index</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tsb_reg_val</span> <span class="o">&amp;</span> <span class="mh">0x7UL</span><span class="p">;</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">tsb_caches</span><span class="p">[</span><span class="n">cache_index</span><span class="p">],</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tsb</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tsb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tsb_reg_val</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">destroy_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MM_NUM_TSBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tsb_destroy_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">tsb_block</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx_alloc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CTX_VALID</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">CTX_NRBITS</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="n">mmu_context_bmap</span><span class="p">[</span><span class="n">nr</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx_alloc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
