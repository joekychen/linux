<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › include › asm › switch_to_32.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>switch_to_32.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __SPARC_SWITCH_TO_H</span>
<span class="cp">#define __SPARC_SWITCH_TO_H</span>

<span class="cp">#include &lt;asm/smp.h&gt;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="n">current_set</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Flush windows so that the VM switch which follows</span>
<span class="cm"> * would not pull the stack from under us.</span>
<span class="cm"> *</span>
<span class="cm"> * SWITCH_ENTER and SWITH_DO_LAZY_FPU do not work yet (e.g. SMP does not work)</span>
<span class="cm"> * XXX WTF is the above comment? Found in late teen 2.4.x.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="cp">#define SWITCH_ENTER(prv) \</span>
<span class="cp">	do {			\</span>
<span class="cp">	if (test_tsk_thread_flag(prv, TIF_USEDFPU)) { \</span>
<span class="cp">		put_psr(get_psr() | PSR_EF); \</span>
<span class="cp">		fpsave(&amp;(prv)-&gt;thread.float_regs[0], &amp;(prv)-&gt;thread.fsr, \</span>
<span class="cp">		       &amp;(prv)-&gt;thread.fpqueue[0], &amp;(prv)-&gt;thread.fpqdepth); \</span>
<span class="cp">		clear_tsk_thread_flag(prv, TIF_USEDFPU); \</span>
<span class="cp">		(prv)-&gt;thread.kregs-&gt;psr &amp;= ~PSR_EF; \</span>
<span class="cp">	} \</span>
<span class="cp">	} while(0)</span>

<span class="cp">#define SWITCH_DO_LAZY_FPU(next)	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define SWITCH_ENTER(prv)		</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define SWITCH_DO_LAZY_FPU(nxt)	\</span>
<span class="cp">	do {			\</span>
<span class="cp">	if (last_task_used_math != (nxt))		\</span>
<span class="cp">		(nxt)-&gt;thread.kregs-&gt;psr&amp;=~PSR_EF;	\</span>
<span class="cp">	} while(0)</span>
<span class="cp">#endif</span>

<span class="cp">#define prepare_arch_switch(next) do { \</span>
<span class="cp">	__asm__ __volatile__( \</span>
<span class="cp">	&quot;.globl\tflush_patch_switch\nflush_patch_switch:\n\t&quot; \</span>
<span class="cp">	&quot;save %sp, -0x40, %sp; save %sp, -0x40, %sp; save %sp, -0x40, %sp\n\t&quot; \</span>
<span class="cp">	&quot;save %sp, -0x40, %sp; save %sp, -0x40, %sp; save %sp, -0x40, %sp\n\t&quot; \</span>
<span class="cp">	&quot;save %sp, -0x40, %sp\n\t&quot; \</span>
<span class="cp">	&quot;restore; restore; restore; restore; restore; restore; restore&quot;); \</span>
<span class="cp">} while(0)</span>

	<span class="cm">/* Much care has gone into this code, do not touch it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We need to loadup regs l0/l1 for the newly forked child</span>
<span class="cm">	 * case because the trap return path relies on those registers</span>
<span class="cm">	 * holding certain values, gcc is told that they are clobbered.</span>
<span class="cm">	 * Gcc needs registers for 3 values in and 1 value out, so we</span>
<span class="cm">	 * clobber every non-fixed-usage register besides l2/l3/o4/o5.  -DaveM</span>
<span class="cm">	 *</span>
<span class="cm">	 * Hey Dave, that do not touch sign is too much of an incentive</span>
<span class="cm">	 * - Anton &amp; Pete</span>
<span class="cm">	 */</span>
<span class="cp">#define switch_to(prev, next, last) do {						\</span>
<span class="cp">	SWITCH_ENTER(prev);								\</span>
<span class="cp">	SWITCH_DO_LAZY_FPU(next);							\</span>
<span class="cp">	cpumask_set_cpu(smp_processor_id(), mm_cpumask(next-&gt;active_mm));		\</span>
<span class="cp">	__asm__ __volatile__(								\</span>
<span class="cp">	&quot;sethi	%%hi(here - 0x8), %%o7\n\t&quot;						\</span>
<span class="cp">	&quot;mov	%%g6, %%g3\n\t&quot;								\</span>
<span class="cp">	&quot;or	%%o7, %%lo(here - 0x8), %%o7\n\t&quot;					\</span>
<span class="cp">	&quot;rd	%%psr, %%g4\n\t&quot;							\</span>
<span class="cp">	&quot;std	%%sp, [%%g6 + %4]\n\t&quot;							\</span>
<span class="cp">	&quot;rd	%%wim, %%g5\n\t&quot;							\</span>
<span class="cp">	&quot;wr	%%g4, 0x20, %%psr\n\t&quot;							\</span>
<span class="cp">	&quot;nop\n\t&quot;									\</span>
<span class="cp">	&quot;std	%%g4, [%%g6 + %3]\n\t&quot;							\</span>
<span class="cp">	&quot;ldd	[%2 + %3], %%g4\n\t&quot;							\</span>
<span class="cp">	&quot;mov	%2, %%g6\n\t&quot;								\</span>
<span class="cp">	&quot;.globl	patchme_store_new_current\n&quot;						\</span>
<span class="cp">&quot;patchme_store_new_current:\n\t&quot;							\</span>
<span class="cp">	&quot;st	%2, [%1]\n\t&quot;								\</span>
<span class="cp">	&quot;wr	%%g4, 0x20, %%psr\n\t&quot;							\</span>
<span class="cp">	&quot;nop\n\t&quot;									\</span>
<span class="cp">	&quot;nop\n\t&quot;									\</span>
<span class="cp">	&quot;nop\n\t&quot;	</span><span class="cm">/* LEON needs all 3 nops: load to %sp depends on CWP. */</span><span class="cp">		\</span>
<span class="cp">	&quot;ldd	[%%g6 + %4], %%sp\n\t&quot;							\</span>
<span class="cp">	&quot;wr	%%g5, 0x0, %%wim\n\t&quot;							\</span>
<span class="cp">	&quot;ldd	[%%sp + 0x00], %%l0\n\t&quot;						\</span>
<span class="cp">	&quot;ldd	[%%sp + 0x38], %%i6\n\t&quot;						\</span>
<span class="cp">	&quot;wr	%%g4, 0x0, %%psr\n\t&quot;							\</span>
<span class="cp">	&quot;nop\n\t&quot;									\</span>
<span class="cp">	&quot;nop\n\t&quot;									\</span>
<span class="cp">	&quot;jmpl	%%o7 + 0x8, %%g0\n\t&quot;							\</span>
<span class="cp">	&quot; ld	[%%g3 + %5], %0\n\t&quot;							\</span>
<span class="cp">	&quot;here:\n&quot;									\</span>
<span class="cp">        : &quot;=&amp;r&quot; (last)									\</span>
<span class="cp">        : &quot;r&quot; (&amp;(current_set[hard_smp_processor_id()])),	\</span>
<span class="cp">	  &quot;r&quot; (task_thread_info(next)),				\</span>
<span class="cp">	  &quot;i&quot; (TI_KPSR),					\</span>
<span class="cp">	  &quot;i&quot; (TI_KSP),						\</span>
<span class="cp">	  &quot;i&quot; (TI_TASK)						\</span>
<span class="cp">	:       &quot;g1&quot;, &quot;g2&quot;, &quot;g3&quot;, &quot;g4&quot;, &quot;g5&quot;,       &quot;g7&quot;,	\</span>
<span class="cp">	  &quot;l0&quot;, &quot;l1&quot;,       &quot;l3&quot;, &quot;l4&quot;, &quot;l5&quot;, &quot;l6&quot;, &quot;l7&quot;,	\</span>
<span class="cp">	  &quot;i0&quot;, &quot;i1&quot;, &quot;i2&quot;, &quot;i3&quot;, &quot;i4&quot;, &quot;i5&quot;,			\</span>
<span class="cp">	  &quot;o0&quot;, &quot;o1&quot;, &quot;o2&quot;, &quot;o3&quot;,                   &quot;o7&quot;);	\</span>
<span class="cp">	} while(0)</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">fpsave</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">fpregs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">fsr</span><span class="p">,</span>
		   <span class="kt">void</span> <span class="o">*</span><span class="n">fpqueue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">fpqdepth</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">synchronize_user_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* __SPARC_SWITCH_TO_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
