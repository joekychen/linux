<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › include › asm › viking.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>viking.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * viking.h:  Defines specific to the GNU/Viking MBUS module.</span>
<span class="cm"> *            This is SRMMU stuff.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _SPARC_VIKING_H</span>
<span class="cp">#define _SPARC_VIKING_H</span>

<span class="cp">#include &lt;asm/asi.h&gt;</span>
<span class="cp">#include &lt;asm/mxcc.h&gt;</span>
<span class="cp">#include &lt;asm/pgtsrmmu.h&gt;</span>

<span class="cm">/* Bits in the SRMMU control register for GNU/Viking modules.</span>
<span class="cm"> *</span>
<span class="cm"> * -----------------------------------------------------------</span>
<span class="cm"> * |impl-vers| RSV |TC|AC|SP|BM|PC|MBM|SB|IC|DC|PSO|RSV|NF|ME|</span>
<span class="cm"> * -----------------------------------------------------------</span>
<span class="cm"> *  31     24 23-17 16 15 14 13 12 11  10  9  8  7  6-2  1  0</span>
<span class="cm"> *</span>
<span class="cm"> * TC: Tablewalk Cacheable -- 0 = Twalks are not cacheable in E-cache</span>
<span class="cm"> *                            1 = Twalks are cacheable in E-cache</span>
<span class="cm"> *</span>
<span class="cm"> * GNU/Viking will only cache tablewalks in the E-cache (mxcc) if present</span>
<span class="cm"> * and never caches them internally (or so states the docs).  Therefore</span>
<span class="cm"> * for machines lacking an E-cache (ie. in MBUS mode) this bit must</span>
<span class="cm"> * remain cleared.</span>
<span class="cm"> *</span>
<span class="cm"> * AC: Alternate Cacheable -- 0 = Passthru physical accesses not cacheable</span>
<span class="cm"> *                            1 = Passthru physical accesses cacheable</span>
<span class="cm"> *</span>
<span class="cm"> * This indicates whether accesses are cacheable when no cachable bit</span>
<span class="cm"> * is present in the pte when the processor is in boot-mode or the</span>
<span class="cm"> * access does not need pte&#39;s for translation (ie. pass-thru ASI&#39;s).</span>
<span class="cm"> * &quot;Cachable&quot; is only referring to E-cache (if present) and not the</span>
<span class="cm"> * on chip split I/D caches of the GNU/Viking.</span>
<span class="cm"> *</span>
<span class="cm"> * SP: SnooP Enable -- 0 = bus snooping off, 1 = bus snooping on</span>
<span class="cm"> *</span>
<span class="cm"> * This enables snooping on the GNU/Viking bus.  This must be on</span>
<span class="cm"> * for the hardware cache consistency mechanisms of the GNU/Viking</span>
<span class="cm"> * to work at all.  On non-mxcc GNU/Viking modules the split I/D</span>
<span class="cm"> * caches will snoop regardless of whether they are enabled, this</span>
<span class="cm"> * takes care of the case where the I or D or both caches are turned</span>
<span class="cm"> * off yet still contain valid data.  Note also that this bit does</span>
<span class="cm"> * not affect GNU/Viking store-buffer snoops, those happen if the</span>
<span class="cm"> * store-buffer is enabled no matter what.</span>
<span class="cm"> *</span>
<span class="cm"> * BM: Boot Mode -- 0 = not in boot mode, 1 = in boot mode</span>
<span class="cm"> *</span>
<span class="cm"> * This indicates whether the GNU/Viking is in boot-mode or not,</span>
<span class="cm"> * if it is then all instruction fetch physical addresses are</span>
<span class="cm"> * computed as 0xff0000000 + low 28 bits of requested address.</span>
<span class="cm"> * GNU/Viking boot-mode does not affect data accesses.  Also,</span>
<span class="cm"> * in boot mode instruction accesses bypass the split on chip I/D</span>
<span class="cm"> * caches, they may be cached by the GNU/MXCC if present and enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * MBM: MBus Mode -- 0 = not in MBus mode, 1 = in MBus mode</span>
<span class="cm"> *</span>
<span class="cm"> * This indicated the GNU/Viking configuration present.  If in</span>
<span class="cm"> * MBUS mode, the GNU/Viking lacks a GNU/MXCC E-cache.  If it is</span>
<span class="cm"> * not then the GNU/Viking is on a module VBUS connected directly</span>
<span class="cm"> * to a GNU/MXCC cache controller.  The GNU/MXCC can be thus connected</span>
<span class="cm"> * to either an GNU/MBUS (sun4m) or the packet-switched GNU/XBus (sun4d).</span>
<span class="cm"> *</span>
<span class="cm"> * SB: StoreBuffer enable -- 0 = store buffer off, 1 = store buffer on</span>
<span class="cm"> *</span>
<span class="cm"> * The GNU/Viking store buffer allows the chip to continue execution</span>
<span class="cm"> * after a store even if the data cannot be placed in one of the</span>
<span class="cm"> * caches during that cycle.  If disabled, all stores operations</span>
<span class="cm"> * occur synchronously.</span>
<span class="cm"> *</span>
<span class="cm"> * IC: Instruction Cache -- 0 = off, 1 = on</span>
<span class="cm"> * DC: Data Cache -- 0 = off, 1 = 0n</span>
<span class="cm"> *</span>
<span class="cm"> * These bits enable the on-cpu GNU/Viking split I/D caches.  Note,</span>
<span class="cm"> * as mentioned above, these caches will snoop the bus in GNU/MBUS</span>
<span class="cm"> * configurations even when disabled to avoid data corruption.</span>
<span class="cm"> *</span>
<span class="cm"> * NF: No Fault -- 0 = faults generate traps, 1 = faults don&#39;t trap</span>
<span class="cm"> * ME: MMU enable -- 0 = mmu not translating, 1 = mmu translating</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define VIKING_MMUENABLE    0x00000001</span>
<span class="cp">#define VIKING_NOFAULT      0x00000002</span>
<span class="cp">#define VIKING_PSO          0x00000080</span>
<span class="cp">#define VIKING_DCENABLE     0x00000100   </span><span class="cm">/* Enable data cache */</span><span class="cp"></span>
<span class="cp">#define VIKING_ICENABLE     0x00000200   </span><span class="cm">/* Enable instruction cache */</span><span class="cp"></span>
<span class="cp">#define VIKING_SBENABLE     0x00000400   </span><span class="cm">/* Enable store buffer */</span><span class="cp"></span>
<span class="cp">#define VIKING_MMODE        0x00000800   </span><span class="cm">/* MBUS mode */</span><span class="cp"></span>
<span class="cp">#define VIKING_PCENABLE     0x00001000   </span><span class="cm">/* Enable parity checking */</span><span class="cp"></span>
<span class="cp">#define VIKING_BMODE        0x00002000   </span>
<span class="cp">#define VIKING_SPENABLE     0x00004000   </span><span class="cm">/* Enable bus cache snooping */</span><span class="cp"></span>
<span class="cp">#define VIKING_ACENABLE     0x00008000   </span><span class="cm">/* Enable alternate caching */</span><span class="cp"></span>
<span class="cp">#define VIKING_TCENABLE     0x00010000   </span><span class="cm">/* Enable table-walks to be cached */</span><span class="cp"></span>
<span class="cp">#define VIKING_DPENABLE     0x00040000   </span><span class="cm">/* Enable the data prefetcher */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * GNU/Viking Breakpoint Action Register fields.</span>
<span class="cm"> */</span>
<span class="cp">#define VIKING_ACTION_MIX   0x00001000   </span><span class="cm">/* Enable multiple instructions */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * GNU/Viking Cache Tags.</span>
<span class="cm"> */</span>
<span class="cp">#define VIKING_PTAG_VALID   0x01000000   </span><span class="cm">/* Cache block is valid */</span><span class="cp"></span>
<span class="cp">#define VIKING_PTAG_DIRTY   0x00010000   </span><span class="cm">/* Block has been modified */</span><span class="cp"></span>
<span class="cp">#define VIKING_PTAG_SHARED  0x00000100   </span><span class="cm">/* Shared with some other cache */</span><span class="cp"></span>

<span class="cp">#ifndef __ASSEMBLY__</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">viking_flush_icache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;sta %%g0, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_IC_FLCLEAR</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">viking_flush_dcache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;sta %%g0, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_DC_FLCLEAR</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">viking_unlock_icache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;sta %%g0, [%0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="mh">0x80000000</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_IC_FLCLEAR</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">viking_unlock_dcache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;sta %%g0, [%0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="mh">0x80000000</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_DC_FLCLEAR</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">viking_set_bpreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;sta %0, [%%g0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regval</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_ACTION</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">viking_get_bpreg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;lda [%%g0] %1, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">regval</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_ACTION</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">regval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">viking_get_dcache_ptag</span><span class="p">(</span><span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptag</span> <span class="o">=</span> <span class="p">((</span><span class="n">set</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span>
			     <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">info</span><span class="p">,</span> <span class="n">page</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;ldda [%2] %3, %%g2</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;or %%g0, %%g2, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;or %%g0, %%g3, %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
			      <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">ptag</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_DATAC_TAG</span><span class="p">)</span>
			      <span class="o">:</span> <span class="s">&quot;g2&quot;</span><span class="p">,</span> <span class="s">&quot;g3&quot;</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">viking_mxcc_turn_off_parity</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mregp</span><span class="p">,</span>
						   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mxcc_cregp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mreg</span> <span class="o">=</span> <span class="o">*</span><span class="n">mregp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mxcc_creg</span> <span class="o">=</span> <span class="o">*</span><span class="n">mxcc_cregp</span><span class="p">;</span>

	<span class="n">mreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VIKING_PCENABLE</span><span class="p">);</span>
	<span class="n">mxcc_creg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MXCC_CTL_PARE</span><span class="p">);</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;set 1f, %%g2</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;andcc %%g2, 4, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;bne 2f</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot; nop</span><span class="se">\n</span><span class="s">&quot;</span>
			      <span class="s">&quot;1:</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;sta %0, [%%g0] %3</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;sta %1, [%2] %4</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;b 1f</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot; nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;nop</span><span class="se">\n</span><span class="s">&quot;</span>
			      <span class="s">&quot;2:</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;sta %0, [%%g0] %3</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;sta %1, [%2] %4</span><span class="se">\n</span><span class="s">&quot;</span>
			      <span class="s">&quot;1:</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="o">:</span> <span class="cm">/* no output */</span>
			      <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">mreg</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">mxcc_creg</span><span class="p">),</span>
			        <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">MXCC_CREG</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_MMUREGS</span><span class="p">),</span>
			        <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_MXCC</span><span class="p">)</span>
			      <span class="o">:</span> <span class="s">&quot;g2&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">mregp</span> <span class="o">=</span> <span class="n">mreg</span><span class="p">;</span>
	<span class="o">*</span><span class="n">mxcc_cregp</span> <span class="o">=</span> <span class="n">mxcc_creg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">viking_hwprobe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">vaddr</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="cm">/* Probe all MMU entries. */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;lda [%1] %2, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">|</span> <span class="mh">0x400</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_FLUSH_PROBE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Probe region. */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;lda [%1] %2, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">|</span> <span class="mh">0x200</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_FLUSH_PROBE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SRMMU_ET_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SRMMU_ET_PTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vaddr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRMMU_PGDIR_MASK</span><span class="p">;</span>
		<span class="n">vaddr</span> <span class="o">&gt;&gt;=</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Probe segment. */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;lda [%1] %2, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_FLUSH_PROBE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SRMMU_ET_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SRMMU_ET_PTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vaddr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRMMU_REAL_PMD_MASK</span><span class="p">;</span>
		<span class="n">vaddr</span> <span class="o">&gt;&gt;=</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Probe page. */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;lda [%1] %2, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">vaddr</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_FLUSH_PROBE</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* !__ASSEMBLY__ */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* !(_SPARC_VIKING_H) */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
