<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › include › asm › trap_block.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>trap_block.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _SPARC_TRAP_BLOCK_H</span>
<span class="cp">#define _SPARC_TRAP_BLOCK_H</span>

<span class="cp">#include &lt;asm/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/asi.h&gt;</span>

<span class="cp">#ifndef __ASSEMBLY__</span>

<span class="cm">/* Trap handling code needs to get at a few critical values upon</span>
<span class="cm"> * trap entry and to process TSB misses.  These cannot be in the</span>
<span class="cm"> * per_cpu() area as we really need to lock them into the TLB and</span>
<span class="cm"> * thus make them part of the main kernel image.  As a result we</span>
<span class="cm"> * try to make this as small as possible.</span>
<span class="cm"> *</span>
<span class="cm"> * This is padded out and aligned to 64-bytes to avoid false sharing</span>
<span class="cm"> * on SMP.</span>
<span class="cm"> */</span>

<span class="cm">/* If you modify the size of this structure, please update</span>
<span class="cm"> * TRAP_BLOCK_SZ_SHIFT below.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">thread_info</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">trap_per_cpu</span> <span class="p">{</span>
<span class="cm">/* D-cache line 1: Basic thread information, cpu and device mondo queues */</span>
	<span class="k">struct</span> <span class="n">thread_info</span>	<span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pgd_paddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">cpu_mondo_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">dev_mondo_pa</span><span class="p">;</span>

<span class="cm">/* D-cache line 2: Error Mondo Queue and kernel buffer pointers */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">resum_mondo_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">resum_kernel_buf_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">nonresum_mondo_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">nonresum_kernel_buf_pa</span><span class="p">;</span>

<span class="cm">/* Dcache lines 3, 4, 5, and 6: Hypervisor Fault Status */</span>
	<span class="k">struct</span> <span class="n">hv_fault_status</span>	<span class="n">fault_info</span><span class="p">;</span>

<span class="cm">/* Dcache line 7: Physical addresses of CPU send mondo block and CPU list.  */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">cpu_mondo_block_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">cpu_list_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">tsb_huge</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">tsb_huge_temp</span><span class="p">;</span>

<span class="cm">/* Dcache line 8: IRQ work list, and keep trap_block a power-of-2 in size.  */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">irq_worklist_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cpu_mondo_qmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">dev_mondo_qmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">resum_qmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">nonresum_qmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">__per_cpu_base</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">64</span><span class="p">)));</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">trap_per_cpu</span> <span class="n">trap_block</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">init_cur_cpu_trap</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">setup_tba</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ncpus_probed</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">real_hard_smp_processor_id</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">cpuid_patch_entry</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cheetah_safari</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cheetah_jbus</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">starfire</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">sun4v</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">cpuid_patch_entry</span> <span class="n">__cpuid_patch</span><span class="p">,</span> <span class="n">__cpuid_patch_end</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sun4v_1insn_patch_entry</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">insn</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">sun4v_1insn_patch_entry</span> <span class="n">__sun4v_1insn_patch</span><span class="p">,</span>
	<span class="n">__sun4v_1insn_patch_end</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sun4v_2insn_patch_entry</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">insns</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">sun4v_2insn_patch_entry</span> <span class="n">__sun4v_2insn_patch</span><span class="p">,</span>
	<span class="n">__sun4v_2insn_patch_end</span><span class="p">;</span>


<span class="cp">#endif </span><span class="cm">/* !(__ASSEMBLY__) */</span><span class="cp"></span>

<span class="cp">#define TRAP_PER_CPU_THREAD		0x00</span>
<span class="cp">#define TRAP_PER_CPU_PGD_PADDR		0x08</span>
<span class="cp">#define TRAP_PER_CPU_CPU_MONDO_PA	0x10</span>
<span class="cp">#define TRAP_PER_CPU_DEV_MONDO_PA	0x18</span>
<span class="cp">#define TRAP_PER_CPU_RESUM_MONDO_PA	0x20</span>
<span class="cp">#define TRAP_PER_CPU_RESUM_KBUF_PA	0x28</span>
<span class="cp">#define TRAP_PER_CPU_NONRESUM_MONDO_PA	0x30</span>
<span class="cp">#define TRAP_PER_CPU_NONRESUM_KBUF_PA	0x38</span>
<span class="cp">#define TRAP_PER_CPU_FAULT_INFO		0x40</span>
<span class="cp">#define TRAP_PER_CPU_CPU_MONDO_BLOCK_PA	0xc0</span>
<span class="cp">#define TRAP_PER_CPU_CPU_LIST_PA	0xc8</span>
<span class="cp">#define TRAP_PER_CPU_TSB_HUGE		0xd0</span>
<span class="cp">#define TRAP_PER_CPU_TSB_HUGE_TEMP	0xd8</span>
<span class="cp">#define TRAP_PER_CPU_IRQ_WORKLIST_PA	0xe0</span>
<span class="cp">#define TRAP_PER_CPU_CPU_MONDO_QMASK	0xe8</span>
<span class="cp">#define TRAP_PER_CPU_DEV_MONDO_QMASK	0xec</span>
<span class="cp">#define TRAP_PER_CPU_RESUM_QMASK	0xf0</span>
<span class="cp">#define TRAP_PER_CPU_NONRESUM_QMASK	0xf4</span>
<span class="cp">#define TRAP_PER_CPU_PER_CPU_BASE	0xf8</span>

<span class="cp">#define TRAP_BLOCK_SZ_SHIFT		8</span>

<span class="cp">#include &lt;asm/scratchpad.h&gt;</span>

<span class="cp">#define __GET_CPUID(REG)				\</span>
<span class="cp">	</span><span class="cm">/* Spitfire implementation (default). */</span><span class="cp">	\</span>
<span class="cp">661:	ldxa		[%g0] ASI_UPA_CONFIG, REG;	\</span>
<span class="cp">	srlx		REG, 17, REG;			\</span>
<span class="cp">	 and		REG, 0x1f, REG;			\</span>
<span class="cp">	nop;						\</span>
<span class="cp">	.section	.cpuid_patch, &quot;ax&quot;;		\</span>
<span class="cp">	</span><span class="cm">/* Instruction location. */</span><span class="cp">			\</span>
<span class="cp">	.word		661b;				\</span>
<span class="cp">	</span><span class="cm">/* Cheetah Safari implementation. */</span><span class="cp">		\</span>
<span class="cp">	ldxa		[%g0] ASI_SAFARI_CONFIG, REG;	\</span>
<span class="cp">	srlx		REG, 17, REG;			\</span>
<span class="cp">	and		REG, 0x3ff, REG;		\</span>
<span class="cp">	nop;						\</span>
<span class="cp">	</span><span class="cm">/* Cheetah JBUS implementation. */</span><span class="cp">		\</span>
<span class="cp">	ldxa		[%g0] ASI_JBUS_CONFIG, REG;	\</span>
<span class="cp">	srlx		REG, 17, REG;			\</span>
<span class="cp">	and		REG, 0x1f, REG;			\</span>
<span class="cp">	nop;						\</span>
<span class="cp">	</span><span class="cm">/* Starfire implementation. */</span><span class="cp">			\</span>
<span class="cp">	sethi		%hi(0x1fff40000d0 &gt;&gt; 9), REG;	\</span>
<span class="cp">	sllx		REG, 9, REG;			\</span>
<span class="cp">	or		REG, 0xd0, REG;			\</span>
<span class="cp">	lduwa		[REG] ASI_PHYS_BYPASS_EC_E, REG;\</span>
<span class="cp">	</span><span class="cm">/* sun4v implementation. */</span><span class="cp">			\</span>
<span class="cp">	mov		SCRATCHPAD_CPUID, REG;		\</span>
<span class="cp">	ldxa		[REG] ASI_SCRATCHPAD, REG;	\</span>
<span class="cp">	nop;						\</span>
<span class="cp">	nop;						\</span>
<span class="cp">	.previous;</span>

<span class="cp">#ifdef CONFIG_SMP</span>

<span class="cp">#define TRAP_LOAD_TRAP_BLOCK(DEST, TMP)		\</span>
<span class="cp">	__GET_CPUID(TMP)			\</span>
<span class="cp">	sethi	%hi(trap_block), DEST;		\</span>
<span class="cp">	sllx	TMP, TRAP_BLOCK_SZ_SHIFT, TMP;	\</span>
<span class="cp">	or	DEST, %lo(trap_block), DEST;	\</span>
<span class="cp">	add	DEST, TMP, DEST;		\</span>

<span class="cm">/* Clobbers TMP, current address space PGD phys address into DEST.  */</span>
<span class="cp">#define TRAP_LOAD_PGD_PHYS(DEST, TMP)		\</span>
<span class="cp">	TRAP_LOAD_TRAP_BLOCK(DEST, TMP)		\</span>
<span class="cp">	ldx	[DEST + TRAP_PER_CPU_PGD_PADDR], DEST;</span>

<span class="cm">/* Clobbers TMP, loads local processor&#39;s IRQ work area into DEST.  */</span>
<span class="cp">#define TRAP_LOAD_IRQ_WORK_PA(DEST, TMP)	\</span>
<span class="cp">	TRAP_LOAD_TRAP_BLOCK(DEST, TMP)		\</span>
<span class="cp">	add	DEST, TRAP_PER_CPU_IRQ_WORKLIST_PA, DEST;</span>

<span class="cm">/* Clobbers TMP, loads DEST with current thread info pointer.  */</span>
<span class="cp">#define TRAP_LOAD_THREAD_REG(DEST, TMP)		\</span>
<span class="cp">	TRAP_LOAD_TRAP_BLOCK(DEST, TMP)		\</span>
<span class="cp">	ldx	[DEST + TRAP_PER_CPU_THREAD], DEST;</span>

<span class="cm">/* Given the current thread info pointer in THR, load the per-cpu</span>
<span class="cm"> * area base of the current processor into DEST.  REG1, REG2, and REG3 are</span>
<span class="cm"> * clobbered.</span>
<span class="cm"> *</span>
<span class="cm"> * You absolutely cannot use DEST as a temporary in this code.  The</span>
<span class="cm"> * reason is that traps can happen during execution, and return from</span>
<span class="cm"> * trap will load the fully resolved DEST per-cpu base.  This can corrupt</span>
<span class="cm"> * the calculations done by the macro mid-stream.</span>
<span class="cm"> */</span>
<span class="cp">#define LOAD_PER_CPU_BASE(DEST, THR, REG1, REG2, REG3)	\</span>
<span class="cp">	lduh	[THR + TI_CPU], REG1;			\</span>
<span class="cp">	sethi	%hi(trap_block), REG2;			\</span>
<span class="cp">	sllx	REG1, TRAP_BLOCK_SZ_SHIFT, REG1;	\</span>
<span class="cp">	or	REG2, %lo(trap_block), REG2;		\</span>
<span class="cp">	add	REG2, REG1, REG2;			\</span>
<span class="cp">	ldx	[REG2 + TRAP_PER_CPU_PER_CPU_BASE], DEST;</span>

<span class="cp">#else</span>

<span class="cp">#define TRAP_LOAD_TRAP_BLOCK(DEST, TMP)		\</span>
<span class="cp">	sethi	%hi(trap_block), DEST;		\</span>
<span class="cp">	or	DEST, %lo(trap_block), DEST;	\</span>

<span class="cm">/* Uniprocessor versions, we know the cpuid is zero.  */</span>
<span class="cp">#define TRAP_LOAD_PGD_PHYS(DEST, TMP)		\</span>
<span class="cp">	TRAP_LOAD_TRAP_BLOCK(DEST, TMP)		\</span>
<span class="cp">	ldx	[DEST + TRAP_PER_CPU_PGD_PADDR], DEST;</span>

<span class="cm">/* Clobbers TMP, loads local processor&#39;s IRQ work area into DEST.  */</span>
<span class="cp">#define TRAP_LOAD_IRQ_WORK_PA(DEST, TMP)	\</span>
<span class="cp">	TRAP_LOAD_TRAP_BLOCK(DEST, TMP)		\</span>
<span class="cp">	add	DEST, TRAP_PER_CPU_IRQ_WORKLIST_PA, DEST;</span>

<span class="cp">#define TRAP_LOAD_THREAD_REG(DEST, TMP)		\</span>
<span class="cp">	TRAP_LOAD_TRAP_BLOCK(DEST, TMP)		\</span>
<span class="cp">	ldx	[DEST + TRAP_PER_CPU_THREAD], DEST;</span>

<span class="cm">/* No per-cpu areas on uniprocessor, so no need to load DEST.  */</span>
<span class="cp">#define LOAD_PER_CPU_BASE(DEST, THR, REG1, REG2, REG3)</span>

<span class="cp">#endif </span><span class="cm">/* !(CONFIG_SMP) */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _SPARC_TRAP_BLOCK_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
