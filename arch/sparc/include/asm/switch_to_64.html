<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › include › asm › switch_to_64.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>switch_to_64.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __SPARC64_SWITCH_TO_64_H</span>
<span class="cp">#define __SPARC64_SWITCH_TO_64_H</span>

<span class="cp">#include &lt;asm/visasm.h&gt;</span>

<span class="cp">#define prepare_arch_switch(next)		\</span>
<span class="cp">do {						\</span>
<span class="cp">	flushw_all();				\</span>
<span class="cp">} while (0)</span>

	<span class="cm">/* See what happens when you design the chip correctly?</span>
<span class="cm">	 *</span>
<span class="cm">	 * We tell gcc we clobber all non-fixed-usage registers except</span>
<span class="cm">	 * for l0/l1.  It will use one for &#39;next&#39; and the other to hold</span>
<span class="cm">	 * the output value of &#39;last&#39;.  &#39;next&#39; is not referenced again</span>
<span class="cm">	 * past the invocation of switch_to in the scheduler, so we need</span>
<span class="cm">	 * not preserve it&#39;s value.  Hairy, but it lets us remove 2 loads</span>
<span class="cm">	 * and 2 stores in this critical code path.  -DaveM</span>
<span class="cm">	 */</span>
<span class="cp">#define switch_to(prev, next, last)					\</span>
<span class="cp">do {	flush_tlb_pending();						\</span>
<span class="cp">	save_and_clear_fpu();						\</span>
<span class="cp">	</span><span class="cm">/* If you are tempted to conditionalize the following */</span><span class="cp">	\</span>
<span class="cp">	</span><span class="cm">/* so that ASI is only written if it changes, think again. */</span><span class="cp">	\</span>
<span class="cp">	__asm__ __volatile__(&quot;wr %%g0, %0, %%asi&quot;			\</span>
<span class="cp">	: : &quot;r&quot; (__thread_flag_byte_ptr(task_thread_info(next))[TI_FLAG_BYTE_CURRENT_DS]));\</span>
<span class="cp">	trap_block[current_thread_info()-&gt;cpu].thread =			\</span>
<span class="cp">		task_thread_info(next);					\</span>
<span class="cp">	__asm__ __volatile__(						\</span>
<span class="cp">	&quot;mov	%%g4, %%g7\n\t&quot;						\</span>
<span class="cp">	&quot;stx	%%i6, [%%sp + 2047 + 0x70]\n\t&quot;				\</span>
<span class="cp">	&quot;stx	%%i7, [%%sp + 2047 + 0x78]\n\t&quot;				\</span>
<span class="cp">	&quot;rdpr	%%wstate, %%o5\n\t&quot;					\</span>
<span class="cp">	&quot;stx	%%o6, [%%g6 + %6]\n\t&quot;					\</span>
<span class="cp">	&quot;stb	%%o5, [%%g6 + %5]\n\t&quot;					\</span>
<span class="cp">	&quot;rdpr	%%cwp, %%o5\n\t&quot;					\</span>
<span class="cp">	&quot;stb	%%o5, [%%g6 + %8]\n\t&quot;					\</span>
<span class="cp">	&quot;wrpr	%%g0, 15, %%pil\n\t&quot;					\</span>
<span class="cp">	&quot;mov	%4, %%g6\n\t&quot;						\</span>
<span class="cp">	&quot;ldub	[%4 + %8], %%g1\n\t&quot;					\</span>
<span class="cp">	&quot;wrpr	%%g1, %%cwp\n\t&quot;					\</span>
<span class="cp">	&quot;ldx	[%%g6 + %6], %%o6\n\t&quot;					\</span>
<span class="cp">	&quot;ldub	[%%g6 + %5], %%o5\n\t&quot;					\</span>
<span class="cp">	&quot;ldub	[%%g6 + %7], %%o7\n\t&quot;					\</span>
<span class="cp">	&quot;wrpr	%%o5, 0x0, %%wstate\n\t&quot;				\</span>
<span class="cp">	&quot;ldx	[%%sp + 2047 + 0x70], %%i6\n\t&quot;				\</span>
<span class="cp">	&quot;ldx	[%%sp + 2047 + 0x78], %%i7\n\t&quot;				\</span>
<span class="cp">	&quot;ldx	[%%g6 + %9], %%g4\n\t&quot;					\</span>
<span class="cp">	&quot;wrpr	%%g0, 14, %%pil\n\t&quot;					\</span>
<span class="cp">	&quot;brz,pt %%o7, switch_to_pc\n\t&quot;					\</span>
<span class="cp">	&quot; mov	%%g7, %0\n\t&quot;						\</span>
<span class="cp">	&quot;sethi	%%hi(ret_from_syscall), %%g1\n\t&quot;			\</span>
<span class="cp">	&quot;jmpl	%%g1 + %%lo(ret_from_syscall), %%g0\n\t&quot;		\</span>
<span class="cp">	&quot; nop\n\t&quot;							\</span>
<span class="cp">	&quot;.globl switch_to_pc\n\t&quot;					\</span>
<span class="cp">	&quot;switch_to_pc:\n\t&quot;						\</span>
<span class="cp">	: &quot;=&amp;r&quot; (last), &quot;=r&quot; (current), &quot;=r&quot; (current_thread_info_reg),	\</span>
<span class="cp">	  &quot;=r&quot; (__local_per_cpu_offset)					\</span>
<span class="cp">	: &quot;0&quot; (task_thread_info(next)),					\</span>
<span class="cp">	  &quot;i&quot; (TI_WSTATE), &quot;i&quot; (TI_KSP), &quot;i&quot; (TI_NEW_CHILD),            \</span>
<span class="cp">	  &quot;i&quot; (TI_CWP), &quot;i&quot; (TI_TASK)					\</span>
<span class="cp">	: &quot;cc&quot;,								\</span>
<span class="cp">	        &quot;g1&quot;, &quot;g2&quot;, &quot;g3&quot;,                   &quot;g7&quot;,		\</span>
<span class="cp">	        &quot;l1&quot;, &quot;l2&quot;, &quot;l3&quot;, &quot;l4&quot;, &quot;l5&quot;, &quot;l6&quot;, &quot;l7&quot;,		\</span>
<span class="cp">	  &quot;i0&quot;, &quot;i1&quot;, &quot;i2&quot;, &quot;i3&quot;, &quot;i4&quot;, &quot;i5&quot;,				\</span>
<span class="cp">	  &quot;o0&quot;, &quot;o1&quot;, &quot;o2&quot;, &quot;o3&quot;, &quot;o4&quot;, &quot;o5&quot;,       &quot;o7&quot;);		\</span>
<span class="cp">} while(0)</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">synchronize_user_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">fault_in_user_windows</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* __SPARC64_SWITCH_TO_64_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
