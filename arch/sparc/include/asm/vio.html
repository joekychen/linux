<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › include › asm › vio.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>vio.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _SPARC64_VIO_H</span>
<span class="cp">#define _SPARC64_VIO_H</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/mod_devicetable.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>

<span class="cp">#include &lt;asm/ldc.h&gt;</span>
<span class="cp">#include &lt;asm/mdesc.h&gt;</span>

<span class="k">struct</span> <span class="n">vio_msg_tag</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">type</span><span class="p">;</span>
<span class="cp">#define VIO_TYPE_CTRL		0x01</span>
<span class="cp">#define VIO_TYPE_DATA		0x02</span>
<span class="cp">#define VIO_TYPE_ERR		0x04</span>

	<span class="n">u8</span>			<span class="n">stype</span><span class="p">;</span>
<span class="cp">#define VIO_SUBTYPE_INFO	0x01</span>
<span class="cp">#define VIO_SUBTYPE_ACK		0x02</span>
<span class="cp">#define VIO_SUBTYPE_NACK	0x04</span>

	<span class="n">u16</span>			<span class="n">stype_env</span><span class="p">;</span>
<span class="cp">#define VIO_VER_INFO		0x0001</span>
<span class="cp">#define VIO_ATTR_INFO		0x0002</span>
<span class="cp">#define VIO_DRING_REG		0x0003</span>
<span class="cp">#define VIO_DRING_UNREG		0x0004</span>
<span class="cp">#define VIO_RDX			0x0005</span>
<span class="cp">#define VIO_PKT_DATA		0x0040</span>
<span class="cp">#define VIO_DESC_DATA		0x0041</span>
<span class="cp">#define VIO_DRING_DATA		0x0042</span>
<span class="cp">#define VNET_MCAST_INFO		0x0101</span>

	<span class="n">u32</span>		<span class="n">sid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_rdx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span>	<span class="n">tag</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">resv</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_ver_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span>	<span class="n">tag</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">major</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">minor</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">dev_class</span><span class="p">;</span>
<span class="cp">#define VDEV_NETWORK		0x01</span>
<span class="cp">#define VDEV_NETWORK_SWITCH	0x02</span>
<span class="cp">#define VDEV_DISK		0x03</span>
<span class="cp">#define VDEV_DISK_SERVER	0x04</span>

	<span class="n">u8</span>			<span class="n">resv1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u64</span>			<span class="n">resv2</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_dring_register</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span>	<span class="n">tag</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">dring_ident</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">num_descr</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">descr_size</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">options</span><span class="p">;</span>
<span class="cp">#define VIO_TX_DRING		0x0001</span>
<span class="cp">#define VIO_RX_DRING		0x0002</span>
	<span class="n">u16</span>			<span class="n">resv</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">num_cookies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ldc_trans_cookie</span>	<span class="n">cookies</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_dring_unregister</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span>	<span class="n">tag</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">dring_ident</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">resv</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Data transfer modes */</span>
<span class="cp">#define VIO_PKT_MODE		0x01 </span><span class="cm">/* Packet based transfer	*/</span><span class="cp"></span>
<span class="cp">#define VIO_DESC_MODE		0x02 </span><span class="cm">/* In-band descriptors	*/</span><span class="cp"></span>
<span class="cp">#define VIO_DRING_MODE		0x03 </span><span class="cm">/* Descriptor rings	*/</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">vio_dring_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span>	<span class="n">tag</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">seq</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">dring_ident</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">start_idx</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">end_idx</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">state</span><span class="p">;</span>
<span class="cp">#define VIO_DRING_ACTIVE	0x01</span>
<span class="cp">#define VIO_DRING_STOPPED	0x02</span>

	<span class="n">u8</span>			<span class="n">__pad1</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">__pad2</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">__pad3</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">__par4</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_dring_hdr</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">state</span><span class="p">;</span>
<span class="cp">#define VIO_DESC_FREE		0x01</span>
<span class="cp">#define VIO_DESC_READY		0x02</span>
<span class="cp">#define VIO_DESC_ACCEPTED	0x03</span>
<span class="cp">#define VIO_DESC_DONE		0x04</span>
	<span class="n">u8</span>			<span class="n">ack</span><span class="p">;</span>
<span class="cp">#define VIO_ACK_ENABLE		0x01</span>
<span class="cp">#define VIO_ACK_DISABLE		0x00</span>

	<span class="n">u16</span>			<span class="n">__pad1</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">__pad2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* VIO disk specific structures and defines */</span>
<span class="k">struct</span> <span class="n">vio_disk_attr_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span>	<span class="n">tag</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">xfer_mode</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">vdisk_type</span><span class="p">;</span>
<span class="cp">#define VD_DISK_TYPE_SLICE	0x01 </span><span class="cm">/* Slice in block device	*/</span><span class="cp"></span>
<span class="cp">#define VD_DISK_TYPE_DISK	0x02 </span><span class="cm">/* Entire block device	*/</span><span class="cp"></span>
	<span class="n">u16</span>			<span class="n">resv1</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">vdisk_block_size</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">operations</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">vdisk_size</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">max_xfer_size</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">resv2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_disk_desc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_dring_hdr</span>	<span class="n">hdr</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">req_id</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">operation</span><span class="p">;</span>
<span class="cp">#define VD_OP_BREAD		0x01 </span><span class="cm">/* Block read			*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_BWRITE		0x02 </span><span class="cm">/* Block write			*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_FLUSH		0x03 </span><span class="cm">/* Flush disk contents		*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_GET_WCE		0x04 </span><span class="cm">/* Get write-cache status		*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_SET_WCE		0x05 </span><span class="cm">/* Enable/disable write-cache	*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_GET_VTOC		0x06 </span><span class="cm">/* Get VTOC			*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_SET_VTOC		0x07 </span><span class="cm">/* Set VTOC			*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_GET_DISKGEOM	0x08 </span><span class="cm">/* Get disk geometry		*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_SET_DISKGEOM	0x09 </span><span class="cm">/* Set disk geometry		*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_SCSICMD		0x0a </span><span class="cm">/* SCSI control command		*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_GET_DEVID		0x0b </span><span class="cm">/* Get device ID			*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_GET_EFI		0x0c </span><span class="cm">/* Get EFI				*/</span><span class="cp"></span>
<span class="cp">#define VD_OP_SET_EFI		0x0d </span><span class="cm">/* Set EFI				*/</span><span class="cp"></span>
	<span class="n">u8</span>			<span class="n">slice</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">resv1</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">status</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">offset</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ncookies</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">resv2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ldc_trans_cookie</span>	<span class="n">cookies</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define VIO_DISK_VNAME_LEN	8</span>
<span class="cp">#define VIO_DISK_ALABEL_LEN	128</span>
<span class="cp">#define VIO_DISK_NUM_PART	8</span>

<span class="k">struct</span> <span class="n">vio_disk_vtoc</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">volume_name</span><span class="p">[</span><span class="n">VIO_DISK_VNAME_LEN</span><span class="p">];</span>
	<span class="n">u16</span>			<span class="n">sector_size</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">num_partitions</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">ascii_label</span><span class="p">[</span><span class="n">VIO_DISK_ALABEL_LEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span>		<span class="n">id</span><span class="p">;</span>
		<span class="n">u16</span>		<span class="n">perm_flags</span><span class="p">;</span>
		<span class="n">u32</span>		<span class="n">resv</span><span class="p">;</span>
		<span class="n">u64</span>		<span class="n">start_block</span><span class="p">;</span>
		<span class="n">u64</span>		<span class="n">num_blocks</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">partitions</span><span class="p">[</span><span class="n">VIO_DISK_NUM_PART</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_disk_geom</span> <span class="p">{</span>
	<span class="n">u16</span>			<span class="n">num_cyl</span><span class="p">;</span> <span class="cm">/* Num data cylinders		*/</span>
	<span class="n">u16</span>			<span class="n">alt_cyl</span><span class="p">;</span> <span class="cm">/* Num alternate cylinders	*/</span>
	<span class="n">u16</span>			<span class="n">beg_cyl</span><span class="p">;</span> <span class="cm">/* Cyl off of fixed head area	*/</span>
	<span class="n">u16</span>			<span class="n">num_hd</span><span class="p">;</span>  <span class="cm">/* Num heads			*/</span>
	<span class="n">u16</span>			<span class="n">num_sec</span><span class="p">;</span> <span class="cm">/* Num sectors			*/</span>
	<span class="n">u16</span>			<span class="n">ifact</span><span class="p">;</span>   <span class="cm">/* Interleave factor		*/</span>
	<span class="n">u16</span>			<span class="n">apc</span><span class="p">;</span>     <span class="cm">/* Alts per cylinder (SCSI)	*/</span>
	<span class="n">u16</span>			<span class="n">rpm</span><span class="p">;</span>	 <span class="cm">/* Revolutions per minute	*/</span>
	<span class="n">u16</span>			<span class="n">phy_cyl</span><span class="p">;</span> <span class="cm">/* Num physical cylinders	*/</span>
	<span class="n">u16</span>			<span class="n">wr_skip</span><span class="p">;</span> <span class="cm">/* Num sects to skip, writes	*/</span>
	<span class="n">u16</span>			<span class="n">rd_skip</span><span class="p">;</span> <span class="cm">/* Num sects to skip, writes	*/</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_disk_devid</span> <span class="p">{</span>
	<span class="n">u16</span>			<span class="n">resv</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_disk_efi</span> <span class="p">{</span>
	<span class="n">u64</span>			<span class="n">lba</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* VIO net specific structures and defines */</span>
<span class="k">struct</span> <span class="n">vio_net_attr_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span>	<span class="n">tag</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">xfer_mode</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">addr_type</span><span class="p">;</span>
<span class="cp">#define VNET_ADDR_ETHERMAC	0x01</span>
	<span class="n">u16</span>			<span class="n">ack_freq</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">resv1</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">addr</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">mtu</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">resv2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define VNET_NUM_MCAST		7</span>

<span class="k">struct</span> <span class="n">vio_net_mcast_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_msg_tag</span>	<span class="n">tag</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">set</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">mcast_addr</span><span class="p">[</span><span class="n">VNET_NUM_MCAST</span> <span class="o">*</span> <span class="mi">6</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">resv</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_net_desc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vio_dring_hdr</span>	<span class="n">hdr</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">ncookies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ldc_trans_cookie</span>	<span class="n">cookies</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define VIO_MAX_RING_COOKIES	24</span>

<span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="p">{</span>
	<span class="n">u64</span>			<span class="n">ident</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">snd_nxt</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">rcv_nxt</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">entry_size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">num_entries</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">prod</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cons</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">pending</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ncookies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ldc_trans_cookie</span>	<span class="n">cookies</span><span class="p">[</span><span class="n">VIO_MAX_RING_COOKIES</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">vio_dring_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">*</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">vio_dring_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">*</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">vio_dring_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_dring_state</span> <span class="o">*</span><span class="n">dr</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ring_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">-</span>
		<span class="p">((</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">-</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">cons</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cp">#define VIO_MAX_TYPE_LEN	32</span>
<span class="cp">#define VIO_MAX_COMPAT_LEN	64</span>

<span class="k">struct</span> <span class="n">vio_dev</span> <span class="p">{</span>
	<span class="n">u64</span>			<span class="n">mp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span>	<span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="kt">char</span>			<span class="n">type</span><span class="p">[</span><span class="n">VIO_MAX_TYPE_LEN</span><span class="p">];</span>
	<span class="kt">char</span>			<span class="n">compat</span><span class="p">[</span><span class="n">VIO_MAX_COMPAT_LEN</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">compat_len</span><span class="p">;</span>

	<span class="n">u64</span>			<span class="n">dev_no</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">channel_id</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">tx_irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rx_irq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">device</span>		<span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_driver</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>			<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">node</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vio_device_id</span>	<span class="o">*</span><span class="n">id_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vio_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vio_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vio_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_driver</span>		<span class="n">driver</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_version</span> <span class="p">{</span>
	<span class="n">u16</span>		<span class="n">major</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">minor</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_driver_state</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">vio_driver_ops</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">send_attr</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">handle_attr</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pkt</span><span class="p">);</span>
	<span class="kt">void</span>	<span class="p">(</span><span class="o">*</span><span class="n">handshake_complete</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_completion</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">com</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">waiting_for</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="p">{</span>
	<span class="cm">/* Protects VIO handshake and, optionally, driver private state.  */</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ldc_channel</span>	<span class="o">*</span><span class="n">lp</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">_peer_sid</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">_local_sid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vio_dring_state</span>	<span class="n">drings</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="cp">#define VIO_DRIVER_TX_RING	0</span>
<span class="cp">#define VIO_DRIVER_RX_RING	1</span>

	<span class="n">u8</span>			<span class="n">hs_state</span><span class="p">;</span>
<span class="cp">#define VIO_HS_INVALID		0x00</span>
<span class="cp">#define VIO_HS_GOTVERS		0x01</span>
<span class="cp">#define VIO_HS_GOT_ATTR		0x04</span>
<span class="cp">#define VIO_HS_SENT_DREG	0x08</span>
<span class="cp">#define VIO_HS_SENT_RDX		0x10</span>
<span class="cp">#define VIO_HS_GOT_RDX_ACK	0x20</span>
<span class="cp">#define VIO_HS_GOT_RDX		0x40</span>
<span class="cp">#define VIO_HS_SENT_RDX_ACK	0x80</span>
<span class="cp">#define VIO_HS_COMPLETE		(VIO_HS_GOT_RDX_ACK | VIO_HS_SENT_RDX_ACK)</span>

	<span class="n">u8</span>			<span class="n">dev_class</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">dr_state</span><span class="p">;</span>
<span class="cp">#define VIO_DR_STATE_TXREG	0x01</span>
<span class="cp">#define VIO_DR_STATE_RXREG	0x02</span>
<span class="cp">#define VIO_DR_STATE_TXREQ	0x10</span>
<span class="cp">#define VIO_DR_STATE_RXREQ	0x20</span>

	<span class="n">u8</span>			<span class="n">debug</span><span class="p">;</span>
<span class="cp">#define VIO_DEBUG_HS		0x01</span>
<span class="cp">#define VIO_DEBUG_DATA		0x02</span>

	<span class="kt">void</span>			<span class="o">*</span><span class="n">desc_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">desc_buf_len</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vio_completion</span>	<span class="o">*</span><span class="n">cmp</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vio_dev</span>		<span class="o">*</span><span class="n">vdev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vio_version</span>	<span class="n">ver</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vio_version</span>	<span class="o">*</span><span class="n">ver_table</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ver_table_entries</span><span class="p">;</span>

	<span class="kt">char</span>			<span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vio_driver_ops</span>	<span class="o">*</span><span class="n">ops</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define viodbg(TYPE, f, a...) \</span>
<span class="cp">do {	if (vio-&gt;debug &amp; VIO_DEBUG_##TYPE) \</span>
<span class="cp">		printk(KERN_INFO &quot;vio: ID[%lu] &quot; f, \</span>
<span class="cp">		       vio-&gt;vdev-&gt;channel_id, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">__vio_register_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mod_name</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * vio_register_driver must be a macro so that KBUILD_MODNAME can be expanded</span>
<span class="cm"> */</span>
<span class="cp">#define vio_register_driver(driver)		\</span>
<span class="cp">	__vio_register_driver(driver, THIS_MODULE, KBUILD_MODNAME)</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">vio_unregister_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">vio_driver</span> <span class="o">*</span><span class="nf">to_vio_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_driver</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">vio_dev</span> <span class="o">*</span><span class="nf">to_vio_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">vio_ldc_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">vio_link_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">vio_conn_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">vio_control_pkt_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pkt</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">vio_validate_sid</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">vio_msg_tag</span> <span class="o">*</span><span class="n">tp</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">u32</span> <span class="n">vio_send_sid</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">vio_ldc_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ldc_channel_config</span> <span class="o">*</span><span class="n">base_cfg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">event_arg</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">vio_ldc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">vio_driver_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_dev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">dev_class</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_version</span> <span class="o">*</span><span class="n">ver_table</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">ver_table_size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vio_driver_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">vio_port_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">vio_driver_state</span> <span class="o">*</span><span class="n">vio</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* _SPARC64_VIO_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
