<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › leon_pci_grpci2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>leon_pci_grpci2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * leon_pci_grpci2.c: GRPCI2 Host PCI driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Aeroflex Gaisler AB, Daniel Hellstrom</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/leon.h&gt;</span>
<span class="cp">#include &lt;asm/vaddrs.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/leon_pci.h&gt;</span>

<span class="cp">#include &quot;irq.h&quot;</span>

<span class="k">struct</span> <span class="n">grpci2_barcfg</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pciadr</span><span class="p">;</span>	<span class="cm">/* PCI Space Address */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ahbadr</span><span class="p">;</span>	<span class="cm">/* PCI Base address mapped to this AHB addr */</span>
<span class="p">};</span>

<span class="cm">/* Device Node Configuration options:</span>
<span class="cm"> *  - barcfgs    : Custom Configuration of Host&#39;s 6 target BARs</span>
<span class="cm"> *  - irq_mask   : Limit which PCI interrupts are enabled</span>
<span class="cm"> *  - do_reset   : Force PCI Reset on startup</span>
<span class="cm"> *</span>
<span class="cm"> * barcfgs</span>
<span class="cm"> * =======</span>
<span class="cm"> *</span>
<span class="cm"> * Optional custom Target BAR configuration (see struct grpci2_barcfg). All</span>
<span class="cm"> * addresses are physical. Array always contains 6 elements (len=2*4*6 bytes)</span>
<span class="cm"> *</span>
<span class="cm"> * -1 means not configured (let host driver do default setup).</span>
<span class="cm"> *</span>
<span class="cm"> * [i*2+0] = PCI Address of BAR[i] on target interface</span>
<span class="cm"> * [i*2+1] = Accessing PCI address of BAR[i] result in this AMBA address</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * irq_mask</span>
<span class="cm"> * ========</span>
<span class="cm"> *</span>
<span class="cm"> * Limit which PCI interrupts are enabled. 0=Disable, 1=Enable. By default</span>
<span class="cm"> * all are enabled. Use this when PCI interrupt pins are floating on PCB.</span>
<span class="cm"> * int, len=4.</span>
<span class="cm"> *  bit0 = PCI INTA#</span>
<span class="cm"> *  bit1 = PCI INTB#</span>
<span class="cm"> *  bit2 = PCI INTC#</span>
<span class="cm"> *  bit3 = PCI INTD#</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * reset</span>
<span class="cm"> * =====</span>
<span class="cm"> *</span>
<span class="cm"> * Force PCI reset on startup. int, len=4</span>
<span class="cm"> */</span>

<span class="cm">/* Enable Debugging Configuration Space Access */</span>
<span class="cp">#undef GRPCI2_DEBUG_CFGACCESS</span>

<span class="cm">/*</span>
<span class="cm"> * GRPCI2 APB Register MAP</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">grpci2_regs</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">;</span>		<span class="cm">/* 0x00 Control */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sts_cap</span><span class="p">;</span>		<span class="cm">/* 0x04 Status / Capabilities */</span>
	<span class="kt">int</span> <span class="n">res1</span><span class="p">;</span>			<span class="cm">/* 0x08 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_map</span><span class="p">;</span>		<span class="cm">/* 0x0C I/O Map address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_ctrl</span><span class="p">;</span>		<span class="cm">/* 0x10 DMA */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_bdbase</span><span class="p">;</span>	<span class="cm">/* 0x14 DMA */</span>
	<span class="kt">int</span> <span class="n">res2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>			<span class="cm">/* 0x18 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bars</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>		<span class="cm">/* 0x20 read-only PCI BARs */</span>
	<span class="kt">int</span> <span class="n">res3</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>			<span class="cm">/* 0x38 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ahbmst_map</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="cm">/* 0x40 AHB-&gt;PCI Map per AHB Master */</span>

	<span class="cm">/* PCI Trace Buffer Registers (OPTIONAL) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_ctrl</span><span class="p">;</span>		<span class="cm">/* 0x80 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_cnt</span><span class="p">;</span>		<span class="cm">/* 0x84 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_adpat</span><span class="p">;</span>		<span class="cm">/* 0x88 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_admask</span><span class="p">;</span>		<span class="cm">/* 0x8C */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_sigpat</span><span class="p">;</span>		<span class="cm">/* 0x90 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_sigmask</span><span class="p">;</span>		<span class="cm">/* 0x94 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_adstate</span><span class="p">;</span>		<span class="cm">/* 0x98 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_sigstate</span><span class="p">;</span>	<span class="cm">/* 0x9C */</span>
<span class="p">};</span>

<span class="cp">#define REGLOAD(a)	(be32_to_cpu(__raw_readl(&amp;(a))))</span>
<span class="cp">#define REGSTORE(a, v)	(__raw_writel(cpu_to_be32(v), &amp;(a)))</span>

<span class="cp">#define CTRL_BUS_BIT 16</span>

<span class="cp">#define CTRL_RESET (1&lt;&lt;31)</span>
<span class="cp">#define CTRL_SI (1&lt;&lt;27)</span>
<span class="cp">#define CTRL_PE (1&lt;&lt;26)</span>
<span class="cp">#define CTRL_EI (1&lt;&lt;25)</span>
<span class="cp">#define CTRL_ER (1&lt;&lt;24)</span>
<span class="cp">#define CTRL_BUS (0xff&lt;&lt;CTRL_BUS_BIT)</span>
<span class="cp">#define CTRL_HOSTINT 0xf</span>

<span class="cp">#define STS_HOST_BIT	31</span>
<span class="cp">#define STS_MST_BIT	30</span>
<span class="cp">#define STS_TAR_BIT	29</span>
<span class="cp">#define STS_DMA_BIT	28</span>
<span class="cp">#define STS_DI_BIT	27</span>
<span class="cp">#define STS_HI_BIT	26</span>
<span class="cp">#define STS_IRQMODE_BIT	24</span>
<span class="cp">#define STS_TRACE_BIT	23</span>
<span class="cp">#define STS_CFGERRVALID_BIT 20</span>
<span class="cp">#define STS_CFGERR_BIT	19</span>
<span class="cp">#define STS_INTTYPE_BIT	12</span>
<span class="cp">#define STS_INTSTS_BIT	8</span>
<span class="cp">#define STS_FDEPTH_BIT	2</span>
<span class="cp">#define STS_FNUM_BIT	0</span>

<span class="cp">#define STS_HOST	(1&lt;&lt;STS_HOST_BIT)</span>
<span class="cp">#define STS_MST		(1&lt;&lt;STS_MST_BIT)</span>
<span class="cp">#define STS_TAR		(1&lt;&lt;STS_TAR_BIT)</span>
<span class="cp">#define STS_DMA		(1&lt;&lt;STS_DMA_BIT)</span>
<span class="cp">#define STS_DI		(1&lt;&lt;STS_DI_BIT)</span>
<span class="cp">#define STS_HI		(1&lt;&lt;STS_HI_BIT)</span>
<span class="cp">#define STS_IRQMODE	(0x3&lt;&lt;STS_IRQMODE_BIT)</span>
<span class="cp">#define STS_TRACE	(1&lt;&lt;STS_TRACE_BIT)</span>
<span class="cp">#define STS_CFGERRVALID	(1&lt;&lt;STS_CFGERRVALID_BIT)</span>
<span class="cp">#define STS_CFGERR	(1&lt;&lt;STS_CFGERR_BIT)</span>
<span class="cp">#define STS_INTTYPE	(0x3f&lt;&lt;STS_INTTYPE_BIT)</span>
<span class="cp">#define STS_INTSTS	(0xf&lt;&lt;STS_INTSTS_BIT)</span>
<span class="cp">#define STS_FDEPTH	(0x7&lt;&lt;STS_FDEPTH_BIT)</span>
<span class="cp">#define STS_FNUM	(0x3&lt;&lt;STS_FNUM_BIT)</span>

<span class="cp">#define STS_ISYSERR	(1&lt;&lt;17)</span>
<span class="cp">#define STS_IDMA	(1&lt;&lt;16)</span>
<span class="cp">#define STS_IDMAERR	(1&lt;&lt;15)</span>
<span class="cp">#define STS_IMSTABRT	(1&lt;&lt;14)</span>
<span class="cp">#define STS_ITGTABRT	(1&lt;&lt;13)</span>
<span class="cp">#define STS_IPARERR	(1&lt;&lt;12)</span>

<span class="cp">#define STS_ERR_IRQ (STS_ISYSERR | STS_IMSTABRT | STS_ITGTABRT | STS_IPARERR)</span>

<span class="k">struct</span> <span class="n">grpci2_bd_chan</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">;</span>	<span class="cm">/* 0x00 DMA Control */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nchan</span><span class="p">;</span>	<span class="cm">/* 0x04 Next DMA Channel Address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbd</span><span class="p">;</span>	<span class="cm">/* 0x08 Next Data Descriptor in chan */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>	<span class="cm">/* 0x0C Reserved */</span>
<span class="p">};</span>

<span class="cp">#define BD_CHAN_EN		0x80000000</span>
<span class="cp">#define BD_CHAN_TYPE		0x00300000</span>
<span class="cp">#define BD_CHAN_BDCNT		0x0000ffff</span>
<span class="cp">#define BD_CHAN_EN_BIT		31</span>
<span class="cp">#define BD_CHAN_TYPE_BIT	20</span>
<span class="cp">#define BD_CHAN_BDCNT_BIT	0</span>

<span class="k">struct</span> <span class="n">grpci2_bd_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">;</span>	<span class="cm">/* 0x00 DMA Data Control */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_adr</span><span class="p">;</span>	<span class="cm">/* 0x04 PCI Start Address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ahb_adr</span><span class="p">;</span>	<span class="cm">/* 0x08 AHB Start address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next</span><span class="p">;</span>	<span class="cm">/* 0x0C Next Data Descriptor in chan */</span>
<span class="p">};</span>

<span class="cp">#define BD_DATA_EN		0x80000000</span>
<span class="cp">#define BD_DATA_IE		0x40000000</span>
<span class="cp">#define BD_DATA_DR		0x20000000</span>
<span class="cp">#define BD_DATA_TYPE		0x00300000</span>
<span class="cp">#define BD_DATA_ER		0x00080000</span>
<span class="cp">#define BD_DATA_LEN		0x0000ffff</span>
<span class="cp">#define BD_DATA_EN_BIT		31</span>
<span class="cp">#define BD_DATA_IE_BIT		30</span>
<span class="cp">#define BD_DATA_DR_BIT		29</span>
<span class="cp">#define BD_DATA_TYPE_BIT	20</span>
<span class="cp">#define BD_DATA_ER_BIT		19</span>
<span class="cp">#define BD_DATA_LEN_BIT		0</span>

<span class="cm">/* GRPCI2 Capability */</span>
<span class="k">struct</span> <span class="n">grpci2_cap_first</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci2ahb_map</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ext2ahb_map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pcibar_size</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>
<span class="cp">#define CAP9_CTRL_OFS 0</span>
<span class="cp">#define CAP9_BAR_OFS 0x4</span>
<span class="cp">#define CAP9_IOMAP_OFS 0x20</span>
<span class="cp">#define CAP9_BARSIZE_OFS 0x24</span>

<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">leon_pci_info</span>	<span class="n">info</span><span class="p">;</span> <span class="cm">/* must be on top of this structure */</span>
	<span class="k">struct</span> <span class="n">grpci2_regs</span>	<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">irq_mode</span><span class="p">;</span> <span class="cm">/* IRQ Mode from CAPSTS REG */</span>
	<span class="kt">char</span>			<span class="n">bt_enabled</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">do_reset</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">irq_mask</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">pciid</span><span class="p">;</span> <span class="cm">/* PCI ID of Host */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">irq_map</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* Virtual IRQ numbers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">virq_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">virq_dma</span><span class="p">;</span>

	<span class="cm">/* AHB PCI Windows */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pci_area</span><span class="p">;</span>	<span class="cm">/* MEMORY */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pci_area_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pci_io</span><span class="p">;</span>		<span class="cm">/* I/O */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pci_conf</span><span class="p">;</span>	<span class="cm">/* CONFIGURATION */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pci_conf_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pci_io_va</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">grpci2_barcfg</span>	<span class="n">tgtbars</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>

<span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">grpci2_dev_lock</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">grpci2priv</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">grpci2_map_irq</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_group</span><span class="p">;</span>

	<span class="cm">/* Use default IRQ decoding on PCI BUS0 according slot numbering */</span>
	<span class="n">irq_group</span> <span class="o">=</span> <span class="n">slot</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">pin</span> <span class="o">=</span> <span class="p">((</span><span class="n">pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">irq_group</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="n">pin</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grpci2_cfg_r32</span><span class="p">(</span><span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pci_conf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">devfn</span> <span class="o">+=</span> <span class="p">(</span><span class="mh">0x8</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* Select bus */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_dev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">bus</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_dev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* clear old status */</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">,</span> <span class="p">(</span><span class="n">STS_CFGERR</span> <span class="o">|</span> <span class="n">STS_CFGERRVALID</span><span class="p">));</span>

	<span class="n">pci_conf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">LEON3_BYPASS_LOAD_PA</span><span class="p">(</span><span class="n">pci_conf</span><span class="p">);</span>

	<span class="cm">/* Wait until GRPCI2 signals that CFG access is done, it should be</span>
<span class="cm">	 * done instantaneously unless a DMA operation is ongoing...</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STS_CFGERRVALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STS_CFGERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Bus always little endian (unaffected by byte-swapping) */</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">flip_dword</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grpci2_cfg_r16</span><span class="p">(</span><span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">grpci2_cfg_r32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grpci2_cfg_r8</span><span class="p">(</span><span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">grpci2_cfg_r32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grpci2_cfg_w32</span><span class="p">(</span><span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pci_conf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">devfn</span> <span class="o">+=</span> <span class="p">(</span><span class="mh">0x8</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* Select bus */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_dev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">bus</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_dev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* clear old status */</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">,</span> <span class="p">(</span><span class="n">STS_CFGERR</span> <span class="o">|</span> <span class="n">STS_CFGERRVALID</span><span class="p">));</span>

	<span class="n">pci_conf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">));</span>
	<span class="n">LEON3_BYPASS_STORE_PA</span><span class="p">(</span><span class="n">pci_conf</span><span class="p">,</span> <span class="n">flip_dword</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>

	<span class="cm">/* Wait until GRPCI2 signals that CFG access is done, it should be</span>
<span class="cm">	 * done instantaneously unless a DMA operation is ongoing...</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STS_CFGERRVALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grpci2_cfg_w16</span><span class="p">(</span><span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">grpci2_cfg_r32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="o">&amp;~</span><span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))))</span> <span class="o">|</span>
	    <span class="p">((</span><span class="mh">0xffff</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)));</span>
	<span class="k">return</span> <span class="n">grpci2_cfg_w32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grpci2_cfg_w8</span><span class="p">(</span><span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">grpci2_cfg_r32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))))</span> <span class="o">|</span>
	    <span class="p">((</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)));</span>
	<span class="k">return</span> <span class="n">grpci2_cfg_w32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read from Configuration Space. When entering here the PCI layer has taken</span>
<span class="cm"> * the pci_lock spinlock and IRQ is off.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">grpci2_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">grpci2priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">busno</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">||</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">busno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">grpci2_cfg_r8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">grpci2_cfg_r16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">grpci2_cfg_r32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef GRPCI2_DEBUG_CFGACCESS</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;grpci2_read_config: [%02x:%02x:%x] ofs=%d val=%x &quot;</span>
		<span class="s">&quot;size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">),</span> <span class="n">where</span><span class="p">,</span>
		<span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write to Configuration Space. When entering here the PCI layer has taken</span>
<span class="cm"> * the pci_lock spinlock and IRQ is off.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">grpci2_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">grpci2priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">busno</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">||</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">busno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef GRPCI2_DEBUG_CFGACCESS</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;grpci2_write_config: [%02x:%02x:%x] ofs=%d size=%d &quot;</span>
		<span class="s">&quot;val=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">),</span>
		<span class="n">where</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">grpci2_cfg_w8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">grpci2_cfg_w16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="n">grpci2_cfg_w32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">grpci2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">grpci2_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">grpci2_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* GENIRQ IRQ chip implementation for GRPCI2 irqmode=0..2. In configuration</span>
<span class="cm"> * 3 where all PCI Interrupts has a separate IRQ on the system IRQ controller</span>
<span class="cm"> * this is not needed and the standard IRQ controller can be used.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">grpci2_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqidx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">grpci2priv</span><span class="p">;</span>

	<span class="n">irqidx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">chip_data</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqidx</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="cm">/* only mask PCI interrupts here */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_dev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irqidx</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_dev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">grpci2_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqidx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">grpci2priv</span><span class="p">;</span>

	<span class="n">irqidx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">chip_data</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqidx</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="cm">/* only unmask PCI interrupts here */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_dev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irqidx</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_dev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">grpci2_startup_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">grpci2_unmask_irq</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">grpci2_shutdown_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">grpci2_mask_irq</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">grpci2_irq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;grpci2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_startup</span>	<span class="o">=</span> <span class="n">grpci2_startup_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_shutdown</span>	<span class="o">=</span> <span class="n">grpci2_shutdown_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">grpci2_mask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">grpci2_unmask_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Handle one or multiple IRQs from the PCI core */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">grpci2_pci_flow_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">grpci2priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">sts_cap</span><span class="p">,</span> <span class="n">pci_ints</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">sts_cap</span> <span class="o">=</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">);</span>

	<span class="cm">/* Error Interrupt? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts_cap</span> <span class="o">&amp;</span> <span class="n">STS_ERR_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_err</span><span class="p">);</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PCI Interrupt? */</span>
	<span class="n">pci_ints</span> <span class="o">=</span> <span class="p">((</span><span class="o">~</span><span class="n">sts_cap</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">STS_INTSTS_BIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">CTRL_HOSTINT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_ints</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Call respective PCI Interrupt handler */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_ints</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Decode DMA Interrupt only when shared with Err and PCI INTX#, when</span>
<span class="cm">	 * the DMA is a unique IRQ the DMA interrupts doesn&#39;t end up here, they</span>
<span class="cm">	 * goes directly to DMA ISR.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sts_cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STS_IDMA</span> <span class="o">|</span> <span class="n">STS_IDMAERR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_dma</span><span class="p">);</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Call &quot;first level&quot; IRQ chip end-of-irq handler. It will ACK LEON IRQ</span>
<span class="cm">	 * Controller, this must be done after IRQ sources have been handled to</span>
<span class="cm">	 * avoid double IRQ generation</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Create a virtual IRQ */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">grpci2_build_device_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pil</span><span class="p">;</span>

	<span class="n">pil</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">virq</span> <span class="o">=</span> <span class="n">irq_alloc</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">pil</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">irq_set_chip_and_handler_name</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grpci2_irq</span><span class="p">,</span> <span class="n">handle_simple_irq</span><span class="p">,</span>
				      <span class="s">&quot;pcilvl&quot;</span><span class="p">);</span>
	<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">irq</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">virq</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">grpci2_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ahbadr</span><span class="p">,</span> <span class="n">pciadr</span><span class="p">,</span> <span class="n">bar_sz</span><span class="p">,</span> <span class="n">capptr</span><span class="p">,</span> <span class="n">io_map</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">grpci2_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">grpci2_barcfg</span> <span class="o">*</span><span class="n">barcfg</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tgtbars</span><span class="p">;</span>

	<span class="cm">/* Reset any earlier setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;GRPCI2: Resetting PCI bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">CTRL_RESET</span><span class="p">);</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Wait for boards to settle */</span>
	<span class="p">}</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* Clear Status */</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_bdbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Translate I/O accesses to 0, I/O Space always @ PCI low 64Kbytes */</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">io_map</span><span class="p">,</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">io_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>

	<span class="cm">/* set 1:1 mapping between AHB -&gt; PCI memory space, for all Masters</span>
<span class="cm">	 * Each AHB master has it&#39;s own mapping registers. Max 16 AHB masters.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ahbmst_map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_area</span><span class="p">);</span>

	<span class="cm">/* Get the GRPCI2 Host PCI ID */</span>
	<span class="n">grpci2_cfg_r32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pciid</span><span class="p">);</span>

	<span class="cm">/* Get address to first (always defined) capability structure */</span>
	<span class="n">grpci2_cfg_r8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_CAPABILITY_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">capptr</span><span class="p">);</span>

	<span class="cm">/* Enable/Disable Byte twisting */</span>
	<span class="n">grpci2_cfg_r32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">capptr</span><span class="o">+</span><span class="n">CAP9_IOMAP_OFS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_map</span><span class="p">);</span>
	<span class="n">io_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_map</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">grpci2_cfg_w32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">capptr</span><span class="o">+</span><span class="n">CAP9_IOMAP_OFS</span><span class="p">,</span> <span class="n">io_map</span><span class="p">);</span>

	<span class="cm">/* Setup the Host&#39;s PCI Target BARs for other peripherals to access,</span>
<span class="cm">	 * and do DMA to the host&#39;s memory. The target BARs can be sized and</span>
<span class="cm">	 * enabled individually.</span>
<span class="cm">	 *</span>
<span class="cm">	 * User may set custom target BARs, but default is:</span>
<span class="cm">	 * The first BARs is used to map kernel low (DMA is part of normal</span>
<span class="cm">	 * region on sparc which is SRMMU_MAXMEM big) main memory 1:1 to the</span>
<span class="cm">	 * PCI bus, the other BARs are disabled. We assume that the first BAR</span>
<span class="cm">	 * is always available.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">barcfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pciadr</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">barcfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ahbadr</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Target BARs must have the proper alignment */</span>
			<span class="n">ahbadr</span> <span class="o">=</span> <span class="n">barcfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ahbadr</span><span class="p">;</span>
			<span class="n">pciadr</span> <span class="o">=</span> <span class="n">barcfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pciadr</span><span class="p">;</span>
			<span class="n">bar_sz</span> <span class="o">=</span> <span class="p">((</span><span class="n">pciadr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">pciadr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Map main memory */</span>
				<span class="n">bar_sz</span> <span class="o">=</span> <span class="mh">0xf0000008</span><span class="p">;</span> <span class="cm">/* 256MB prefetchable */</span>
				<span class="n">ahbadr</span> <span class="o">=</span> <span class="mh">0xf0000000</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">PAGE_ALIGN</span><span class="p">(</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_end</span><span class="p">));</span>
				<span class="n">pciadr</span> <span class="o">=</span> <span class="n">ahbadr</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bar_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahbadr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pciadr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">grpci2_cfg_w32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">capptr</span><span class="o">+</span><span class="n">CAP9_BARSIZE_OFS</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">bar_sz</span><span class="p">);</span>
		<span class="n">grpci2_cfg_w32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">pciadr</span><span class="p">);</span>
		<span class="n">grpci2_cfg_w32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">capptr</span><span class="o">+</span><span class="n">CAP9_BAR_OFS</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">ahbadr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;        TGT BAR[%d]: 0x%08x (PCI)-&gt; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">pciadr</span><span class="p">,</span> <span class="n">ahbadr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set as bus master and enable pci memory responses */</span>
	<span class="n">grpci2_cfg_r32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">);</span>
	<span class="n">grpci2_cfg_w32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Enable Error respone (CPU-TRAP) on illegal memory access. */</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">CTRL_ER</span> <span class="o">|</span> <span class="n">CTRL_PE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">grpci2_jump_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: Jump IRQ happened</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handle GRPCI2 Error Interrupt */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">grpci2_err_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">grpci2_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_ERR_IRQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_IPARERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_ITGTABRT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: Target Abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_IMSTABRT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: Master Abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_ISYSERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: System Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Clear handled INT TYPE IRQs */</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_ERR_IRQ</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">grpci2_of_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">grpci2_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">grpci2_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">capability</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grpci2priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: only one GRPCI2 core supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: not enough APB/AHB resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find Device Address */</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			  <span class="s">&quot;grlib-grpci2 regs&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that we&#39;re in Host Slot and that we can act as a Host Bridge</span>
<span class="cm">	 * and not only as target.</span>
<span class="cm">	 */</span>
	<span class="n">capability</span> <span class="o">=</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">STS_HOST</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">STS_MST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;GRPCI2: not in host system slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">grpci2priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">grpci2_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grpci2priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">grpci2priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">grpci2priv</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* BASE IRQ */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">STS_IRQMODE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">STS_IRQMODE_BIT</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;GRPCI2: host found at %p, irq%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Byte twisting should be made configurable from kernel command line */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Let user do custom Target BAR assignment */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;barcfg&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="mi">6</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tgtbars</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tgtbars</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* Limit IRQ unmasking in irq_mode 2 and 3 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;irq_mask&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_reset</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="cm">/* Optional PCI reset. Force PCI reset on startup */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_reset</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Find PCI Memory, I/O and Configuration Space Windows */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_area</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_area_end</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_io</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_conf_end</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_io_va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_io</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_io_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;GRPCI2: MEMORY SPACE [0x%08lx - 0x%08lx]</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;        I/O    SPACE [0x%08lx - 0x%08lx]</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;        CONFIG SPACE [0x%08lx - 0x%08lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_area</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_area_end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_io</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_conf</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_conf</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_conf_end</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * I/O Space resources in I/O Window mapped into Virtual Adr Space</span>
<span class="cm">	 * We never use low 4KB because some devices seem have problems using</span>
<span class="cm">	 * address 0.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">io_space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">io_space</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GRPCI2 PCI I/O Space&quot;</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">io_space</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_io_va</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">io_space</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_io_va</span> <span class="o">+</span> <span class="mh">0x10000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">io_space</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * GRPCI2 has no prefetchable memory, map everything as</span>
<span class="cm">	 * non-prefetchable memory</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mem_space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mem_space</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GRPCI2 PCI MEM Space&quot;</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mem_space</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_area</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mem_space</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_area_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mem_space</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mem_space</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">io_space</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>

	<span class="n">grpci2_hw_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get PCI Interrupt to System IRQ mapping and setup IRQ handling</span>
<span class="cm">	 * Error IRQ always on PCI INTA.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All PCI interrupts are shared using the same system IRQ */</span>
		<span class="n">leon_update_virq_handling</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">grpci2_pci_flow_irq</span><span class="p">,</span>
					 <span class="s">&quot;pcilvl&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">grpci2_build_device_irq</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">grpci2_build_device_irq</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">grpci2_build_device_irq</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">grpci2_build_device_irq</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_err</span> <span class="o">=</span> <span class="n">grpci2_build_device_irq</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_dma</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_dma</span> <span class="o">=</span> <span class="n">grpci2_build_device_irq</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

		<span class="cm">/* Enable IRQs on LEON IRQ controller */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">grpci2_jump_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;GRPCI2_JUMP&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GRPCI2: ERR IRQ request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* All PCI interrupts have an unique IRQ interrupt */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Make LEON IRQ layer handle level IRQ by acking */</span>
			<span class="n">leon_update_virq_handling</span><span class="p">(</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="n">handle_fasteoi_irq</span><span class="p">,</span> <span class="s">&quot;pcilvl&quot;</span><span class="p">,</span>
						 <span class="mi">1</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_err</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mode</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_dma</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_dma</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="cm">/* Unmask all PCI interrupts, request_irq will not do that */</span>
		<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Setup IRQ handler for non-configuration space access errors */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">virq_err</span><span class="p">,</span> <span class="n">grpci2_err_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				<span class="s">&quot;GRPCI2_ERR&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;GRPCI2: ERR VIRQ request failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable Error Interrupts. PCI interrupts are unmasked once request_irq</span>
<span class="cm">	 * is called by the PCI Device drivers</span>
<span class="cm">	 */</span>
	<span class="n">REGSTORE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">REGLOAD</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">CTRL_EI</span> <span class="o">|</span> <span class="n">CTRL_SI</span><span class="p">);</span>

	<span class="cm">/* Init common layer and scan buses */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">grpci2_ops</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">map_irq</span> <span class="o">=</span> <span class="n">grpci2_map_irq</span><span class="p">;</span>
	<span class="n">leon_pci_init</span><span class="p">(</span><span class="n">ofdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err5:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">io_space</span><span class="p">);</span>
<span class="nl">err4:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mem_space</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pci_io_va</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">regs</span><span class="p">,</span>
		<span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">grpci2_of_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GAISLER_GRPCI2&quot;</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;01_07c&quot;</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">grpci2_of_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;grpci2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">grpci2_of_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">grpci2_of_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">grpci2_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grpci2_of_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">grpci2_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
