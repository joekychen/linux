<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › traps_64.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps_64.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* arch/sparc64/kernel/traps.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995,1997,2008,2009 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> * Copyright (C) 1997,1999,2000 Jakub Jelinek (jakub@redhat.com)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * I like traps on v9, :))))</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/linkage.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kdebug.h&gt;</span>
<span class="cp">#include &lt;linux/ftrace.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/unistd.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/fpumacro.h&gt;</span>
<span class="cp">#include &lt;asm/lsu.h&gt;</span>
<span class="cp">#include &lt;asm/dcu.h&gt;</span>
<span class="cp">#include &lt;asm/estate.h&gt;</span>
<span class="cp">#include &lt;asm/chafsr.h&gt;</span>
<span class="cp">#include &lt;asm/sfafsr.h&gt;</span>
<span class="cp">#include &lt;asm/psrcompat.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/timer.h&gt;</span>
<span class="cp">#include &lt;asm/head.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/memctrl.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>

<span class="cp">#include &quot;entry.h&quot;</span>
<span class="cp">#include &quot;kstack.h&quot;</span>

<span class="cm">/* When an irrecoverable trap occurs at tl &gt; 0, the trap entry</span>
<span class="cm"> * code logs the trap state registers at every level in the trap</span>
<span class="cm"> * stack.  It is found at (pt_regs + sizeof(pt_regs)) and the layout</span>
<span class="cm"> * is as follows:</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tstate</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tpc</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tnpc</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tt</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">trapstack</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_tl1_traplog</span><span class="p">(</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;TRAPLOG: Error at trap level 0x%lx, &quot;</span>
	       <span class="s">&quot;dumping track stack.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tl</span><span class="p">);</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">hypervisor</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span>
		       <span class="s">&quot;TRAPLOG: Trap level %d TSTATE[%016lx] TPC[%016lx] &quot;</span>
		       <span class="s">&quot;TNPC[%016lx] TT[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapstack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tstate</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapstack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tpc</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapstack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tnpc</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapstack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tt</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TRAPLOG: TPC&lt;%pS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapstack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tpc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bad_trap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;bad trap&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lvl</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Bad hw trap %lx at tl0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvl</span><span class="p">);</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lvl</span> <span class="o">-=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Kernel bad sw trap %lx&quot;</span><span class="p">,</span> <span class="n">lvl</span><span class="p">);</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLTRP</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="n">lvl</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bad_trap_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP_TL1</span><span class="p">,</span> <span class="s">&quot;bad trap tl1&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Bad trap %lx at tl&gt;0&quot;</span><span class="p">,</span> <span class="n">lvl</span><span class="p">);</span>
	<span class="n">die_if_kernel</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_BUGVERBOSE</span>
<span class="kt">void</span> <span class="nf">do_BUG</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bust_spinlocks</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;kernel BUG at %s:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">do_BUG</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dimm_handler_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">dimm_printer_t</span> <span class="n">dimm_handler</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sprintf_dimm</span><span class="p">(</span><span class="kt">int</span> <span class="n">synd_code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dimm_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dimm_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dimm_handler</span><span class="p">(</span><span class="n">synd_code</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">spitfire</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prom_getunumber</span><span class="p">(</span><span class="n">synd_code</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dimm_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">register_dimm_printer</span><span class="p">(</span><span class="n">dimm_printer_t</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dimm_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dimm_handler</span><span class="p">)</span>
		<span class="n">dimm_handler</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dimm_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">register_dimm_printer</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">unregister_dimm_printer</span><span class="p">(</span><span class="n">dimm_printer_t</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dimm_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dimm_handler</span> <span class="o">==</span> <span class="n">func</span><span class="p">)</span>
		<span class="n">dimm_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dimm_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">unregister_dimm_printer</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">spitfire_insn_access_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;instruction access exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;spitfire_insn_access_exception: SFSR[%016lx] &quot;</span>
		       <span class="s">&quot;SFAR[%016lx], going.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sfsr</span><span class="p">,</span> <span class="n">sfar</span><span class="p">);</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Iax&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">spitfire_insn_access_exception_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP_TL1</span><span class="p">,</span> <span class="s">&quot;instruction access exception tl1&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">spitfire_insn_access_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">sfsr</span><span class="p">,</span> <span class="n">sfar</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sun4v_insn_access_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">type_ctx</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ctx</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type_ctx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;instruction access exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sun4v_insn_access_exception: ADDR[%016lx] &quot;</span>
		       <span class="s">&quot;CTX[%04x] TYPE[%04x], going.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">addr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Iax&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sun4v_insn_access_exception_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP_TL1</span><span class="p">,</span> <span class="s">&quot;instruction access exception tl1&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">sun4v_insn_access_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">type_ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">spitfire_data_access_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;data access exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test if this comes from uaccess places. */</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">exception_table_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="n">search_exception_tables</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ouch, somebody is trying VM hole tricks on us... */</span>
<span class="cp">#ifdef DEBUG_EXCEPTIONS</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Exception: PC&lt;%016lx&gt; faddr&lt;UNKNOWN&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;EX_TABLE: insn&lt;%016lx&gt; fixup&lt;%016lx&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fixup</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fixup</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Shit... */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;spitfire_data_access_exception: SFSR[%016lx] &quot;</span>
		       <span class="s">&quot;SFAR[%016lx], going.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sfsr</span><span class="p">,</span> <span class="n">sfar</span><span class="p">);</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Dax&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">sfar</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">spitfire_data_access_exception_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP_TL1</span><span class="p">,</span> <span class="s">&quot;data access exception tl1&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">spitfire_data_access_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">sfsr</span><span class="p">,</span> <span class="n">sfar</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sun4v_data_access_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">type_ctx</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ctx</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type_ctx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;data access exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test if this comes from uaccess places. */</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">exception_table_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="n">search_exception_tables</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ouch, somebody is trying VM hole tricks on us... */</span>
<span class="cp">#ifdef DEBUG_EXCEPTIONS</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Exception: PC&lt;%016lx&gt; faddr&lt;UNKNOWN&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;EX_TABLE: insn&lt;%016lx&gt; fixup&lt;%016lx&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fixup</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fixup</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sun4v_data_access_exception: ADDR[%016lx] &quot;</span>
		       <span class="s">&quot;CTX[%04x] TYPE[%04x], going.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">addr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Dax&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sun4v_data_access_exception_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP_TL1</span><span class="p">,</span> <span class="s">&quot;data access exception tl1&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">sun4v_data_access_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">type_ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#include &quot;pci_impl.h&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/* When access exceptions happen, we must do this. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">spitfire_clean_and_reenable_l1_caches</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">!=</span> <span class="n">spitfire</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* Clean &#39;em. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">va</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span> <span class="n">va</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="n">va</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spitfire_put_icache_tag</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">spitfire_put_dcache_tag</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enable in LSU. */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;flush %%g6</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;stxa %0, [%%g0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">LSU_CONTROL_IC</span> <span class="o">|</span> <span class="n">LSU_CONTROL_DC</span> <span class="o">|</span>
				    <span class="n">LSU_CONTROL_IM</span> <span class="o">|</span> <span class="n">LSU_CONTROL_DM</span><span class="p">),</span>
			     <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_LSU_CONTROL</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spitfire_enable_estate_errors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;stxa	%0, [%%g0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar	#Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">ESTATE_ERR_ALL</span><span class="p">),</span>
			       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_ESTATE_ERROR_EN</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">ecc_syndrome_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span>
	<span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span>
	<span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span>
	<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span>
	<span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
	<span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x4a</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">syndrome_unknown</span> <span class="o">=</span> <span class="s">&quot;&lt;Unknown&gt;&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spitfire_log_udb_syndrome</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">udbh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">udbl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">scode</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">memmod_str</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udbl</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scode</span> <span class="o">=</span> <span class="n">ecc_syndrome_table</span><span class="p">[</span><span class="n">udbl</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sprintf_dimm</span><span class="p">(</span><span class="n">scode</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">memmod_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memmod_str</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">syndrome_unknown</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">memmod_str</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CPU[%d]: UDBL Syndrome[%x] &quot;</span>
		       <span class="s">&quot;Memory Module </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">scode</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udbh</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scode</span> <span class="o">=</span> <span class="n">ecc_syndrome_table</span><span class="p">[</span><span class="n">udbh</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sprintf_dimm</span><span class="p">(</span><span class="n">scode</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">memmod_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memmod_str</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">syndrome_unknown</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">memmod_str</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CPU[%d]: UDBH Syndrome[%x] &quot;</span>
		       <span class="s">&quot;Memory Module </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">scode</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spitfire_cee_log</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">udbh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">udbl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tl1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CPU[%d]: Correctable ECC Error &quot;</span>
	       <span class="s">&quot;AFSR[%lx] AFAR[%016lx] UDBL[%lx] UDBH[%lx] TL&gt;1[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">udbl</span><span class="p">,</span> <span class="n">udbh</span><span class="p">,</span> <span class="n">tl1</span><span class="p">);</span>

	<span class="n">spitfire_log_udb_syndrome</span><span class="p">(</span><span class="n">afar</span><span class="p">,</span> <span class="n">udbh</span><span class="p">,</span> <span class="n">udbl</span><span class="p">,</span> <span class="n">UDBE_CE</span><span class="p">);</span>

	<span class="cm">/* We always log it, even if someone is listening for this</span>
<span class="cm">	 * trap.</span>
<span class="cm">	 */</span>
	<span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;Correctable ECC Error&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		   <span class="mi">0</span><span class="p">,</span> <span class="n">TRAP_TYPE_CEE</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">);</span>

	<span class="cm">/* The Correctable ECC Error trap does not disable I/D caches.  So</span>
<span class="cm">	 * we only have to restore the ESTATE Error Enable register.</span>
<span class="cm">	 */</span>
	<span class="n">spitfire_enable_estate_errors</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spitfire_ue_log</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">udbh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">udbl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tl1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CPU[%d]: Uncorrectable Error AFSR[%lx] &quot;</span>
	       <span class="s">&quot;AFAR[%lx] UDBL[%lx] UDBH[%ld] TT[%lx] TL&gt;1[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">udbl</span><span class="p">,</span> <span class="n">udbh</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">tl1</span><span class="p">);</span>

	<span class="cm">/* XXX add more human friendly logging of the error status</span>
<span class="cm">	 * XXX as is implemented for cheetah</span>
<span class="cm">	 */</span>

	<span class="n">spitfire_log_udb_syndrome</span><span class="p">(</span><span class="n">afar</span><span class="p">,</span> <span class="n">udbh</span><span class="p">,</span> <span class="n">udbl</span><span class="p">,</span> <span class="n">UDBE_UE</span><span class="p">);</span>

	<span class="cm">/* We always log it, even if someone is listening for this</span>
<span class="cm">	 * trap.</span>
<span class="cm">	 */</span>
	<span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;Uncorrectable Error&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		   <span class="mi">0</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tl1</span><span class="p">)</span>
			<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;UE&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* XXX need more intelligent processing here, such as is implemented</span>
<span class="cm">	 * XXX for cheetah errors, in fact if the E-cache still holds the</span>
<span class="cm">	 * XXX line with bad parity this will loop</span>
<span class="cm">	 */</span>

	<span class="n">spitfire_clean_and_reenable_l1_caches</span><span class="p">();</span>
	<span class="n">spitfire_enable_estate_errors</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_OBJERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGBUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">spitfire_access_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status_encoded</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">udbh</span><span class="p">,</span> <span class="n">udbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tl1</span><span class="p">;</span>

	<span class="n">afsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_encoded</span> <span class="o">&amp;</span> <span class="n">SFSTAT_AFSR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SFSTAT_AFSR_SHIFT</span><span class="p">;</span>
	<span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_encoded</span> <span class="o">&amp;</span> <span class="n">SFSTAT_TRAP_TYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SFSTAT_TRAP_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">tl1</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_encoded</span> <span class="o">&amp;</span> <span class="n">SFSTAT_TL_GT_ONE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_encoded</span> <span class="o">&amp;</span> <span class="n">SFSTAT_UDBL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SFSTAT_UDBL_SHIFT</span><span class="p">;</span>
	<span class="n">udbh</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_encoded</span> <span class="o">&amp;</span> <span class="n">SFSTAT_UDBH_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SFSTAT_UDBH_SHIFT</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="o">==</span> <span class="n">TRAP_TYPE_DAE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pci_poke_in_progress</span> <span class="o">&amp;&amp;</span> <span class="n">pci_poke_cpu</span> <span class="o">==</span> <span class="n">smp_processor_id</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">spitfire_clean_and_reenable_l1_caches</span><span class="p">();</span>
		<span class="n">spitfire_enable_estate_errors</span><span class="p">();</span>

		<span class="n">pci_poke_faulted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SFAFSR_UE</span><span class="p">)</span>
		<span class="n">spitfire_ue_log</span><span class="p">(</span><span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">udbh</span><span class="p">,</span> <span class="n">udbl</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">tl1</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="o">==</span> <span class="n">TRAP_TYPE_CEE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Handle the case where we took a CEE trap, but ACK&#39;d</span>
<span class="cm">		 * only the UE state in the UDB error registers.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SFAFSR_UE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udbh</span> <span class="o">&amp;</span> <span class="n">UDBE_CE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
					<span class="s">&quot;stxa	%0, [%1] %2</span><span class="se">\n\t</span><span class="s">&quot;</span>
					<span class="s">&quot;membar	#Sync&quot;</span>
					<span class="o">:</span> <span class="cm">/* no outputs */</span>
					<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">udbh</span> <span class="o">&amp;</span> <span class="n">UDBE_CE</span><span class="p">),</span>
					  <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_UDB_ERROR_W</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udbl</span> <span class="o">&amp;</span> <span class="n">UDBE_CE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
					<span class="s">&quot;stxa	%0, [%1] %2</span><span class="se">\n\t</span><span class="s">&quot;</span>
					<span class="s">&quot;membar	#Sync&quot;</span>
					<span class="o">:</span> <span class="cm">/* no outputs */</span>
					<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">udbl</span> <span class="o">&amp;</span> <span class="n">UDBE_CE</span><span class="p">),</span>
					  <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="mh">0x18</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_UDB_ERROR_W</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spitfire_cee_log</span><span class="p">(</span><span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">udbh</span><span class="p">,</span> <span class="n">udbl</span><span class="p">,</span> <span class="n">tl1</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">cheetah_pcache_forced_on</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">cheetah_enable_pcache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dcr</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CHEETAH: Enabling P-Cache on cpu %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %1, %0&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">dcr</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">));</span>
	<span class="n">dcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DCU_PE</span> <span class="o">|</span> <span class="n">DCU_HPE</span> <span class="o">|</span> <span class="n">DCU_SPE</span> <span class="o">|</span> <span class="n">DCU_SL</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;stxa %0, [%%g0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">dcr</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Cheetah error trap handling. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ecache_flush_physbase</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ecache_flush_linesize</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ecache_flush_size</span><span class="p">;</span>

<span class="cm">/* This table is ordered in priority of errors and matches the</span>
<span class="cm"> * AFAR overwrite policy as well.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">afsr_error_table</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_PERR_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;System interface protocol error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_IERR_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Internal processor error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_ISAP_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;System request parity error on incoming address&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_UCU_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable E-cache ECC error for ifetch/data&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_UCC_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;SW Correctable E-cache ECC error for ifetch/data&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_UE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable system bus data ECC error for read&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_EDU_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable E-cache ECC error for stmerge/blkld&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_EMU_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable system bus MTAG error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_WDU_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable E-cache ECC error for writeback&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_CPU_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable ECC error for copyout&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_CE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;HW corrected system bus data ECC error for read&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_EDC_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;HW corrected E-cache ECC error for stmerge/blkld&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_EMC_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;HW corrected system bus MTAG ECC error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_WDC_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;HW corrected E-cache ECC error for writeback&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_CPC_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;HW corrected ECC error for copyout&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_TO_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Unmapped error from system bus&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_BERR_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Bus error response from system bus&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_IVC_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;HW corrected system bus data ECC error for ivec read&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHAFSR_IVU_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable system bus data ECC error for ivec read&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">afsr_error_table</span> <span class="n">__cheetah_error_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="n">CHAFSR_PERR</span><span class="p">,</span>	<span class="n">CHAFSR_PERR_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_IERR</span><span class="p">,</span>	<span class="n">CHAFSR_IERR_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_ISAP</span><span class="p">,</span>	<span class="n">CHAFSR_ISAP_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UCU</span><span class="p">,</span>	<span class="n">CHAFSR_UCU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UCC</span><span class="p">,</span>	<span class="n">CHAFSR_UCC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UE</span><span class="p">,</span>	<span class="n">CHAFSR_UE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EDU</span><span class="p">,</span>	<span class="n">CHAFSR_EDU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EMU</span><span class="p">,</span>	<span class="n">CHAFSR_EMU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_WDU</span><span class="p">,</span>	<span class="n">CHAFSR_WDU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CPU</span><span class="p">,</span>	<span class="n">CHAFSR_CPU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CE</span><span class="p">,</span>	<span class="n">CHAFSR_CE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EDC</span><span class="p">,</span>	<span class="n">CHAFSR_EDC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EMC</span><span class="p">,</span>	<span class="n">CHAFSR_EMC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_WDC</span><span class="p">,</span>	<span class="n">CHAFSR_WDC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CPC</span><span class="p">,</span>	<span class="n">CHAFSR_CPC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_TO</span><span class="p">,</span>	<span class="n">CHAFSR_TO_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_BERR</span><span class="p">,</span>	<span class="n">CHAFSR_BERR_msg</span>		<span class="p">},</span>
	<span class="cm">/* These two do not update the AFAR. */</span>
	<span class="p">{</span>	<span class="n">CHAFSR_IVC</span><span class="p">,</span>	<span class="n">CHAFSR_IVC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_IVU</span><span class="p">,</span>	<span class="n">CHAFSR_IVU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="mi">0</span><span class="p">,</span>		<span class="nb">NULL</span>			<span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHPAFSR_DTO_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;System bus unmapped error for prefetch/storequeue-read&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHPAFSR_DBERR_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;System bus error for prefetch/storequeue-read&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHPAFSR_THCE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Hardware corrected E-cache Tag ECC error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHPAFSR_TSCE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;SW handled correctable E-cache Tag ECC error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHPAFSR_TUE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable E-cache Tag ECC error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">CHPAFSR_DUE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;System bus uncorrectable data ECC error due to prefetch/store-fill&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">afsr_error_table</span> <span class="n">__cheetah_plus_error_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="n">CHAFSR_PERR</span><span class="p">,</span>	<span class="n">CHAFSR_PERR_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_IERR</span><span class="p">,</span>	<span class="n">CHAFSR_IERR_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_ISAP</span><span class="p">,</span>	<span class="n">CHAFSR_ISAP_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UCU</span><span class="p">,</span>	<span class="n">CHAFSR_UCU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UCC</span><span class="p">,</span>	<span class="n">CHAFSR_UCC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UE</span><span class="p">,</span>	<span class="n">CHAFSR_UE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EDU</span><span class="p">,</span>	<span class="n">CHAFSR_EDU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EMU</span><span class="p">,</span>	<span class="n">CHAFSR_EMU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_WDU</span><span class="p">,</span>	<span class="n">CHAFSR_WDU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CPU</span><span class="p">,</span>	<span class="n">CHAFSR_CPU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CE</span><span class="p">,</span>	<span class="n">CHAFSR_CE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EDC</span><span class="p">,</span>	<span class="n">CHAFSR_EDC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EMC</span><span class="p">,</span>	<span class="n">CHAFSR_EMC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_WDC</span><span class="p">,</span>	<span class="n">CHAFSR_WDC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CPC</span><span class="p">,</span>	<span class="n">CHAFSR_CPC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_TO</span><span class="p">,</span>	<span class="n">CHAFSR_TO_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_BERR</span><span class="p">,</span>	<span class="n">CHAFSR_BERR_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHPAFSR_DTO</span><span class="p">,</span>	<span class="n">CHPAFSR_DTO_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHPAFSR_DBERR</span><span class="p">,</span>	<span class="n">CHPAFSR_DBERR_msg</span>	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHPAFSR_THCE</span><span class="p">,</span>	<span class="n">CHPAFSR_THCE_msg</span>	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHPAFSR_TSCE</span><span class="p">,</span>	<span class="n">CHPAFSR_TSCE_msg</span>	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHPAFSR_TUE</span><span class="p">,</span>	<span class="n">CHPAFSR_TUE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHPAFSR_DUE</span><span class="p">,</span>	<span class="n">CHPAFSR_DUE_msg</span>		<span class="p">},</span>
	<span class="cm">/* These two do not update the AFAR. */</span>
	<span class="p">{</span>	<span class="n">CHAFSR_IVC</span><span class="p">,</span>	<span class="n">CHAFSR_IVC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_IVU</span><span class="p">,</span>	<span class="n">CHAFSR_IVU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="mi">0</span><span class="p">,</span>		<span class="nb">NULL</span>			<span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_JETO_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;System interface protocol error, hw timeout caused&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_SCE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Parity error on system snoop results&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_JEIC_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;System interface protocol error, illegal command detected&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_JEIT_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;System interface protocol error, illegal ADTYPE detected&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_OM_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Out of range memory error has occurred&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_ETP_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Parity error on L2 cache tag SRAM&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_UMS_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Error due to unsupported store&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_RUE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Uncorrectable ECC error from remote cache/memory&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_RCE_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Correctable ECC error from remote cache/memory&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_BP_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;JBUS parity error on returned read data&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_WBP_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;JBUS parity error on data for writeback or block store&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_FRC_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Foreign read to DRAM incurring correctable ECC error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">JPAFSR_FRU_msg</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Foreign read to DRAM incurring uncorrectable ECC error&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">afsr_error_table</span> <span class="n">__jalapeno_error_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="n">JPAFSR_JETO</span><span class="p">,</span>	<span class="n">JPAFSR_JETO_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_SCE</span><span class="p">,</span>	<span class="n">JPAFSR_SCE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_JEIC</span><span class="p">,</span>	<span class="n">JPAFSR_JEIC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_JEIT</span><span class="p">,</span>	<span class="n">JPAFSR_JEIT_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_PERR</span><span class="p">,</span>	<span class="n">CHAFSR_PERR_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_IERR</span><span class="p">,</span>	<span class="n">CHAFSR_IERR_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_ISAP</span><span class="p">,</span>	<span class="n">CHAFSR_ISAP_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UCU</span><span class="p">,</span>	<span class="n">CHAFSR_UCU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UCC</span><span class="p">,</span>	<span class="n">CHAFSR_UCC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_UE</span><span class="p">,</span>	<span class="n">CHAFSR_UE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EDU</span><span class="p">,</span>	<span class="n">CHAFSR_EDU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_OM</span><span class="p">,</span>	<span class="n">JPAFSR_OM_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_WDU</span><span class="p">,</span>	<span class="n">CHAFSR_WDU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CPU</span><span class="p">,</span>	<span class="n">CHAFSR_CPU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CE</span><span class="p">,</span>	<span class="n">CHAFSR_CE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_EDC</span><span class="p">,</span>	<span class="n">CHAFSR_EDC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_ETP</span><span class="p">,</span>	<span class="n">JPAFSR_ETP_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_WDC</span><span class="p">,</span>	<span class="n">CHAFSR_WDC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_CPC</span><span class="p">,</span>	<span class="n">CHAFSR_CPC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_TO</span><span class="p">,</span>	<span class="n">CHAFSR_TO_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">CHAFSR_BERR</span><span class="p">,</span>	<span class="n">CHAFSR_BERR_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_UMS</span><span class="p">,</span>	<span class="n">JPAFSR_UMS_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_RUE</span><span class="p">,</span>	<span class="n">JPAFSR_RUE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_RCE</span><span class="p">,</span>	<span class="n">JPAFSR_RCE_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_BP</span><span class="p">,</span>	<span class="n">JPAFSR_BP_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_WBP</span><span class="p">,</span>	<span class="n">JPAFSR_WBP_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_FRC</span><span class="p">,</span>	<span class="n">JPAFSR_FRC_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="n">JPAFSR_FRU</span><span class="p">,</span>	<span class="n">JPAFSR_FRU_msg</span>		<span class="p">},</span>
	<span class="cm">/* These two do not update the AFAR. */</span>
	<span class="p">{</span>	<span class="n">CHAFSR_IVU</span><span class="p">,</span>	<span class="n">CHAFSR_IVU_msg</span>		<span class="p">},</span>
	<span class="p">{</span>	<span class="mi">0</span><span class="p">,</span>		<span class="nb">NULL</span>			<span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">afsr_error_table</span> <span class="o">*</span><span class="n">cheetah_error_table</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cheetah_afsr_errors</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="o">*</span><span class="n">cheetah_error_log</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="o">*</span><span class="nf">cheetah_get_error_log</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cheetah_error_log</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">cheetah_error_log</span> <span class="o">+</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_TL1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tl0_icpe</span><span class="p">[],</span> <span class="n">tl1_icpe</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tl0_dcpe</span><span class="p">[],</span> <span class="n">tl1_dcpe</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tl0_fecc</span><span class="p">[],</span> <span class="n">tl1_fecc</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tl0_cee</span><span class="p">[],</span> <span class="n">tl1_cee</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tl0_iae</span><span class="p">[],</span> <span class="n">tl1_iae</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tl0_dae</span><span class="p">[],</span> <span class="n">tl1_dae</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cheetah_plus_icpe_trap_vector</span><span class="p">[],</span> <span class="n">cheetah_plus_icpe_trap_vector_tl1</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cheetah_plus_dcpe_trap_vector</span><span class="p">[],</span> <span class="n">cheetah_plus_dcpe_trap_vector_tl1</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cheetah_fecc_trap_vector</span><span class="p">[],</span> <span class="n">cheetah_fecc_trap_vector_tl1</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cheetah_cee_trap_vector</span><span class="p">[],</span> <span class="n">cheetah_cee_trap_vector_tl1</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cheetah_deferred_trap_vector</span><span class="p">[],</span> <span class="n">cheetah_deferred_trap_vector_tl1</span><span class="p">[];</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">cheetah_ecache_flush_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">largest_size</span><span class="p">,</span> <span class="n">smallest_linesize</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sz</span><span class="p">;</span>

	<span class="cm">/* Scan all cpu device tree nodes, note two values:</span>
<span class="cm">	 * 1) largest E-cache size</span>
<span class="cm">	 * 2) smallest E-cache line size</span>
<span class="cm">	 */</span>
	<span class="n">largest_size</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
	<span class="n">smallest_linesize</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CPUS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_data</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">ecache_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">largest_size</span><span class="p">)</span>
			<span class="n">largest_size</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_data</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">ecache_line_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">smallest_linesize</span><span class="p">)</span>
			<span class="n">smallest_linesize</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">largest_size</span> <span class="o">==</span> <span class="mi">0UL</span> <span class="o">||</span> <span class="n">smallest_linesize</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;cheetah_ecache_flush_init: Cannot probe cpu E-cache &quot;</span>
			    <span class="s">&quot;parameters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ecache_flush_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">largest_size</span><span class="p">);</span>
	<span class="n">ecache_flush_linesize</span> <span class="o">=</span> <span class="n">smallest_linesize</span><span class="p">;</span>

	<span class="n">ecache_flush_physbase</span> <span class="o">=</span> <span class="n">find_ecache_flush_span</span><span class="p">(</span><span class="n">ecache_flush_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecache_flush_physbase</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;cheetah_ecache_flush_init: Cannot find %d byte &quot;</span>
			    <span class="s">&quot;contiguous physical memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ecache_flush_size</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Now allocate error trap reporting scoreboard. */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">NR_CPUS</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cheetah_err_info</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="n">MAX_ORDER</span><span class="p">;</span> <span class="n">order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">sz</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cheetah_error_log</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cheetah_error_log</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;cheetah_ecache_flush_init: Failed to allocate &quot;</span>
			    <span class="s">&quot;error logging scoreboard (%d bytes).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cheetah_error_log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span>

	<span class="cm">/* Mark all AFSRs as invalid so that the trap handler will</span>
<span class="cm">	 * log new new information there.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">NR_CPUS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cheetah_error_log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">afsr</span> <span class="o">=</span> <span class="n">CHAFSR_INVALID</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="p">(</span><span class="s">&quot;rdpr %%ver, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ver</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ver</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="n">__JALAPENO_ID</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ver</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="n">__SERRANO_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cheetah_error_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__jalapeno_error_table</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cheetah_afsr_errors</span> <span class="o">=</span> <span class="n">JPAFSR_ERRORS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ver</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x003e0015</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cheetah_error_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__cheetah_plus_error_table</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cheetah_afsr_errors</span> <span class="o">=</span> <span class="n">CHPAFSR_ERRORS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cheetah_error_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__cheetah_error_table</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cheetah_afsr_errors</span> <span class="o">=</span> <span class="n">CHAFSR_ERRORS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now patch trap tables. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl0_fecc</span><span class="p">,</span> <span class="n">cheetah_fecc_trap_vector</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl1_fecc</span><span class="p">,</span> <span class="n">cheetah_fecc_trap_vector_tl1</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl0_cee</span><span class="p">,</span> <span class="n">cheetah_cee_trap_vector</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl1_cee</span><span class="p">,</span> <span class="n">cheetah_cee_trap_vector_tl1</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl0_iae</span><span class="p">,</span> <span class="n">cheetah_deferred_trap_vector</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl1_iae</span><span class="p">,</span> <span class="n">cheetah_deferred_trap_vector_tl1</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl0_dae</span><span class="p">,</span> <span class="n">cheetah_deferred_trap_vector</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tl1_dae</span><span class="p">,</span> <span class="n">cheetah_deferred_trap_vector_tl1</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">cheetah_plus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tl0_dcpe</span><span class="p">,</span> <span class="n">cheetah_plus_dcpe_trap_vector</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tl1_dcpe</span><span class="p">,</span> <span class="n">cheetah_plus_dcpe_trap_vector_tl1</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tl0_icpe</span><span class="p">,</span> <span class="n">cheetah_plus_icpe_trap_vector</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tl1_icpe</span><span class="p">,</span> <span class="n">cheetah_plus_icpe_trap_vector_tl1</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">flushi</span><span class="p">(</span><span class="n">PAGE_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cheetah_flush_ecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flush_base</span> <span class="o">=</span> <span class="n">ecache_flush_physbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flush_linesize</span> <span class="o">=</span> <span class="n">ecache_flush_linesize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flush_size</span> <span class="o">=</span> <span class="n">ecache_flush_size</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;1: subcc	%0, %4, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;   bne,pt	%%xcc, 1b</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;    ldxa	[%2 + %0] %3, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">flush_size</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">flush_size</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">flush_base</span><span class="p">),</span>
			       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_PHYS_USE_EC</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">flush_linesize</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cheetah_flush_ecache_line</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alias</span><span class="p">;</span>

	<span class="n">physaddr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">8UL</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">);</span>
	<span class="n">physaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecache_flush_physbase</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">physaddr</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">ecache_flush_size</span><span class="o">&gt;&gt;</span><span class="mi">1UL</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">)));</span>
	<span class="n">alias</span> <span class="o">=</span> <span class="n">physaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ecache_flush_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1UL</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%0] %2, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;ldxa [%1] %2, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">physaddr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">alias</span><span class="p">),</span>
			       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_PHYS_USE_EC</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Unfortunately, the diagnostic access to the I-cache tags we need to</span>
<span class="cm"> * use to clear the thing interferes with I-cache coherency transactions.</span>
<span class="cm"> *</span>
<span class="cm"> * So we must only flush the I-cache when it is disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__cheetah_flush_icache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">icache_size</span><span class="p">,</span> <span class="n">icache_line_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">icache_size</span> <span class="o">=</span> <span class="n">local_cpu_data</span><span class="p">().</span><span class="n">icache_size</span><span class="p">;</span>
	<span class="n">icache_line_size</span> <span class="o">=</span> <span class="n">local_cpu_data</span><span class="p">().</span><span class="n">icache_line_size</span><span class="p">;</span>

	<span class="cm">/* Clear the valid bits in all the tags. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">icache_size</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">icache_line_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;stxa %%g0, [%0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;membar #Sync&quot;</span>
				     <span class="o">:</span> <span class="cm">/* no outputs */</span>
				     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)),</span>
				       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_IC_TAG</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cheetah_flush_icache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dcu_save</span><span class="p">;</span>

	<span class="cm">/* Save current DCU, disable I-cache. */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %1, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;or %0, %2, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;stxa %%g1, [%%g0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">dcu_save</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">DCU_IC</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

	<span class="n">__cheetah_flush_icache</span><span class="p">();</span>

	<span class="cm">/* Restore DCU register */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;stxa %0, [%%g0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">dcu_save</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cheetah_flush_dcache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dcache_size</span><span class="p">,</span> <span class="n">dcache_line_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">dcache_size</span> <span class="o">=</span> <span class="n">local_cpu_data</span><span class="p">().</span><span class="n">dcache_size</span><span class="p">;</span>
	<span class="n">dcache_line_size</span> <span class="o">=</span> <span class="n">local_cpu_data</span><span class="p">().</span><span class="n">dcache_line_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">dcache_size</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">dcache_line_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;stxa %%g0, [%0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;membar #Sync&quot;</span>
				     <span class="o">:</span> <span class="cm">/* no outputs */</span>
				     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCACHE_TAG</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* In order to make the even parity correct we must do two things.</span>
<span class="cm"> * First, we clear DC_data_parity and set DC_utag to an appropriate value.</span>
<span class="cm"> * Next, we clear out all 32-bytes of data for that line.  Data of</span>
<span class="cm"> * all-zero + tag parity value of zero == correct parity.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cheetah_plus_zap_dcache_parity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dcache_size</span><span class="p">,</span> <span class="n">dcache_line_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">dcache_size</span> <span class="o">=</span> <span class="n">local_cpu_data</span><span class="p">().</span><span class="n">dcache_size</span><span class="p">;</span>
	<span class="n">dcache_line_size</span> <span class="o">=</span> <span class="n">local_cpu_data</span><span class="p">().</span><span class="n">dcache_line_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">dcache_size</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">dcache_line_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line</span><span class="p">;</span>

		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;membar	#Sync</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;stxa	%0, [%1] %2</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;membar	#Sync&quot;</span>
				     <span class="o">:</span> <span class="cm">/* no outputs */</span>
				     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span>
				       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCACHE_UTAG</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">dcache_line_size</span><span class="p">;</span> <span class="n">line</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;membar	#Sync</span><span class="se">\n\t</span><span class="s">&quot;</span>
					     <span class="s">&quot;stxa	%%g0, [%0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
					     <span class="s">&quot;membar	#Sync&quot;</span>
					     <span class="o">:</span> <span class="cm">/* no outputs */</span>
					     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">line</span><span class="p">),</span>
					       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCACHE_DATA</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Conversion tables used to frob Cheetah AFSR syndrome values into</span>
<span class="cm"> * something palatable to the memory controller driver get_unumber</span>
<span class="cm"> * routine.</span>
<span class="cm"> */</span>
<span class="cp">#define MT0	137</span>
<span class="cp">#define MT1	138</span>
<span class="cp">#define MT2	139</span>
<span class="cp">#define NONE	254</span>
<span class="cp">#define MTC0	140</span>
<span class="cp">#define MTC1	141</span>
<span class="cp">#define MTC2	142</span>
<span class="cp">#define MTC3	143</span>
<span class="cp">#define C0	128</span>
<span class="cp">#define C1	129</span>
<span class="cp">#define C2	130</span>
<span class="cp">#define C3	131</span>
<span class="cp">#define C4	132</span>
<span class="cp">#define C5	133</span>
<span class="cp">#define C6	134</span>
<span class="cp">#define C7	135</span>
<span class="cp">#define C8	136</span>
<span class="cp">#define M2	144</span>
<span class="cp">#define M3	145</span>
<span class="cp">#define M4	146</span>
<span class="cp">#define M	147</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cheetah_ecc_syntab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*00*/</span><span class="n">NONE</span><span class="p">,</span> <span class="n">C0</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*01*/</span><span class="n">C4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
<span class="cm">/*02*/</span><span class="n">C5</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
<span class="cm">/*03*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*04*/</span><span class="n">C6</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
<span class="cm">/*05*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span>
<span class="cm">/*06*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span>
<span class="cm">/*07*/</span><span class="mi">116</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span>
<span class="cm">/*08*/</span><span class="n">C7</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
<span class="cm">/*09*/</span><span class="n">M</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*0a*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span>
<span class="cm">/*0b*/</span><span class="mi">103</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span>
<span class="cm">/*0c*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*0d*/</span><span class="mi">102</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span>
<span class="cm">/*0e*/</span><span class="mi">98</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*0f*/</span><span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*10*/</span><span class="n">C8</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
<span class="cm">/*11*/</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*12*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span>
<span class="cm">/*13*/</span><span class="mi">94</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*14*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span>
<span class="cm">/*15*/</span><span class="mi">89</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span>
<span class="cm">/*16*/</span><span class="mi">86</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span>
<span class="cm">/*17*/</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span>
<span class="cm">/*18*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span>
<span class="cm">/*19*/</span><span class="mi">77</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*1a*/</span><span class="mi">74</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span>
<span class="cm">/*1b*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*1c*/</span><span class="mi">80</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span>
<span class="cm">/*1d*/</span><span class="n">M2</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*1e*/</span><span class="n">M</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span>
<span class="cm">/*1f*/</span><span class="mi">111</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M4</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M3</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cheetah_mtag_syntab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
       <span class="n">NONE</span><span class="p">,</span> <span class="n">MTC0</span><span class="p">,</span>
       <span class="n">MTC1</span><span class="p">,</span> <span class="n">NONE</span><span class="p">,</span>
       <span class="n">MTC2</span><span class="p">,</span> <span class="n">NONE</span><span class="p">,</span>
       <span class="n">NONE</span><span class="p">,</span> <span class="n">MT0</span><span class="p">,</span>
       <span class="n">MTC3</span><span class="p">,</span> <span class="n">NONE</span><span class="p">,</span>
       <span class="n">NONE</span><span class="p">,</span> <span class="n">MT1</span><span class="p">,</span>
       <span class="n">NONE</span><span class="p">,</span> <span class="n">MT2</span><span class="p">,</span>
       <span class="n">NONE</span><span class="p">,</span> <span class="n">NONE</span>
<span class="p">};</span>

<span class="cm">/* Return the highest priority error conditon mentioned. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">cheetah_get_hipri</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cheetah_error_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">cheetah_error_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">cheetah_get_string</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cheetah_error_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">cheetah_error_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cheetah_error_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;???&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cheetah_log_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recoverable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hipri</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">unum</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): Cheetah error trap taken afsr[%016lx] afar[%016lx] TL1(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_TL1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): TPC[%lx] TNPC[%lx] O7[%lx] TSTATE[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">u_regs</span><span class="p">[</span><span class="n">UREG_I7</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): &quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">());</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TPC&lt;%pS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): M_SYND(%lx),  E_SYND(%lx)%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_M_SYNDROME</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CHAFSR_M_SYNDROME_SHIFT</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_E_SYNDROME</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CHAFSR_E_SYNDROME_SHIFT</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_ME</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;, Multiple Errors&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_PRIV</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;, Privileged&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">hipri</span> <span class="o">=</span> <span class="n">cheetah_get_hipri</span><span class="p">(</span><span class="n">afsr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): Highest priority error (%016lx) </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="n">hipri</span><span class="p">,</span> <span class="n">cheetah_get_string</span><span class="p">(</span><span class="n">hipri</span><span class="p">));</span>

	<span class="cm">/* Try to get unumber if relevant. */</span>
<span class="cp">#define ESYND_ERRORS	(CHAFSR_IVC | CHAFSR_IVU | \</span>
<span class="cp">			 CHAFSR_CPC | CHAFSR_CPU | \</span>
<span class="cp">			 CHAFSR_UE  | CHAFSR_CE  | \</span>
<span class="cp">			 CHAFSR_EDC | CHAFSR_EDU  | \</span>
<span class="cp">			 CHAFSR_UCC | CHAFSR_UCU  | \</span>
<span class="cp">			 CHAFSR_WDU | CHAFSR_WDC)</span>
<span class="cp">#define MSYND_ERRORS	(CHAFSR_EMC | CHAFSR_EMU)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">ESYND_ERRORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">syndrome</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">syndrome</span> <span class="o">=</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_E_SYNDROME</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CHAFSR_E_SYNDROME_SHIFT</span><span class="p">;</span>
		<span class="n">syndrome</span> <span class="o">=</span> <span class="n">cheetah_ecc_syntab</span><span class="p">[</span><span class="n">syndrome</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf_dimm</span><span class="p">(</span><span class="n">syndrome</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">unum</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">unum</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): AFAR E-syndrome [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span>
			       <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">unum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">MSYND_ERRORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">syndrome</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">syndrome</span> <span class="o">=</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_M_SYNDROME</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CHAFSR_M_SYNDROME_SHIFT</span><span class="p">;</span>
		<span class="n">syndrome</span> <span class="o">=</span> <span class="n">cheetah_mtag_syntab</span><span class="p">[</span><span class="n">syndrome</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf_dimm</span><span class="p">(</span><span class="n">syndrome</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">unum</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">unum</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): AFAR M-syndrome [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span>
			       <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">unum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now dump the cache snapshots. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): D-cache idx[%x] tag[%016llx] utag[%016llx] stag[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dcache_index</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dcache_tag</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dcache_utag</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dcache_stag</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): D-cache data0[%016llx] data1[%016llx] data2[%016llx] data3[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dcache_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dcache_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dcache_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dcache_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): I-cache idx[%x] tag[%016llx] utag[%016llx] stag[%016llx] &quot;</span>
	       <span class="s">&quot;u[%016llx] l[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_index</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_tag</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_utag</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_stag</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_upper</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_lower</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): I-cache INSN0[%016llx] INSN1[%016llx] INSN2[%016llx] INSN3[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): I-cache INSN4[%016llx] INSN5[%016llx] INSN6[%016llx] INSN7[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_data</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icache_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): E-cache idx[%x] tag[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ecache_index</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ecache_tag</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR(%d): E-cache data0[%016llx] data1[%016llx] data2[%016llx] data3[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span> <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">ecache_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">ecache_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">ecache_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">ecache_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">afsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">hipri</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cheetah_afsr_errors</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">cheetah_get_hipri</span><span class="p">(</span><span class="n">afsr</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;ERROR: Multiple-error (%016lx) </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">recoverable</span> <span class="o">?</span> <span class="n">KERN_WARNING</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">),</span>
		       <span class="n">bit</span><span class="p">,</span> <span class="n">cheetah_get_string</span><span class="p">(</span><span class="n">bit</span><span class="p">));</span>

		<span class="n">afsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recoverable</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;ERROR: This condition is not recoverable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cheetah_recheck_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="o">*</span><span class="n">logp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %1, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">afsr</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_AFSR</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">cheetah_afsr_errors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">logp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %1, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
					     <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">afar</span><span class="p">)</span>
					     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_AFAR</span><span class="p">));</span>
			<span class="n">logp</span><span class="o">-&gt;</span><span class="n">afsr</span> <span class="o">=</span> <span class="n">afsr</span><span class="p">;</span>
			<span class="n">logp</span><span class="o">-&gt;</span><span class="n">afar</span> <span class="o">=</span> <span class="n">afar</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;stxa %0, [%%g0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">afsr</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_AFSR</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cheetah_fecc_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="n">local_snapshot</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recoverable</span><span class="p">;</span>

	<span class="cm">/* Flush E-cache */</span>
	<span class="n">cheetah_flush_ecache</span><span class="p">();</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">cheetah_get_error_log</span><span class="p">(</span><span class="n">afsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;ERROR: Early Fast-ECC error afsr[%016lx] afar[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;ERROR: CPU(%d) TPC[%016lx] TNPC[%016lx] TSTATE[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Grab snapshot of logged error. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local_snapshot</span><span class="p">));</span>

	<span class="cm">/* If the current trap snapshot does not match what the</span>
<span class="cm">	 * trap handler passed along into our args, big trouble.</span>
<span class="cm">	 * In such a case, mark the local copy as invalid.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Else, it matches and we mark the afsr in the non-local</span>
<span class="cm">	 * copy as invalid so we may log new error traps there.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">afsr</span> <span class="o">!=</span> <span class="n">afsr</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">afar</span> <span class="o">!=</span> <span class="n">afar</span><span class="p">)</span>
		<span class="n">local_snapshot</span><span class="p">.</span><span class="n">afsr</span> <span class="o">=</span> <span class="n">CHAFSR_INVALID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">afsr</span> <span class="o">=</span> <span class="n">CHAFSR_INVALID</span><span class="p">;</span>

	<span class="n">cheetah_flush_icache</span><span class="p">();</span>
	<span class="n">cheetah_flush_dcache</span><span class="p">();</span>

	<span class="cm">/* Re-enable I-cache/D-cache */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">),</span>
			       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">DCU_DC</span> <span class="o">|</span> <span class="n">DCU_IC</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

	<span class="cm">/* Re-enable error reporting */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_ESTATE_ERROR_EN</span><span class="p">),</span>
			       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ESTATE_ERROR_NCEEN</span> <span class="o">|</span> <span class="n">ESTATE_ERROR_CEEN</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

	<span class="cm">/* Decide if we can continue after handling this trap and</span>
<span class="cm">	 * logging the error.</span>
<span class="cm">	 */</span>
	<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHAFSR_PERR</span> <span class="o">|</span> <span class="n">CHAFSR_IERR</span> <span class="o">|</span> <span class="n">CHAFSR_ISAP</span><span class="p">))</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Re-check AFSR/AFAR.  What we are looking for here is whether a new</span>
<span class="cm">	 * error was logged while we had error reporting traps disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cheetah_recheck_errors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_afsr</span> <span class="o">=</span> <span class="n">local_snapshot</span><span class="p">.</span><span class="n">afsr</span><span class="p">;</span>

		<span class="cm">/* If we got a new asynchronous error, die... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_afsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHAFSR_EMU</span> <span class="o">|</span> <span class="n">CHAFSR_EDU</span> <span class="o">|</span>
				<span class="n">CHAFSR_WDU</span> <span class="o">|</span> <span class="n">CHAFSR_CPU</span> <span class="o">|</span>
				<span class="n">CHAFSR_IVU</span> <span class="o">|</span> <span class="n">CHAFSR_UE</span> <span class="o">|</span>
				<span class="n">CHAFSR_BERR</span> <span class="o">|</span> <span class="n">CHAFSR_TO</span><span class="p">))</span>
			<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Log errors. */</span>
	<span class="n">cheetah_log_errors</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">,</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">recoverable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recoverable</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Irrecoverable Fast-ECC error trap.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Flush E-cache to kick the error trap handlers out. */</span>
	<span class="n">cheetah_flush_ecache</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Try to fix a correctable error by pushing the line out from</span>
<span class="cm"> * the E-cache.  Recheck error reporting registers to see if the</span>
<span class="cm"> * problem is intermittent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cheetah_fix_ce</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_estate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alias1</span><span class="p">,</span> <span class="n">alias2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Make sure correctable error traps are disabled. */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa	[%%g0] %2, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;andn	%0, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;stxa	%%g1, [%%g0] %2</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar	#Sync&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">orig_estate</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ESTATE_ERROR_CEEN</span><span class="p">),</span>
			       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_ESTATE_ERROR_EN</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

	<span class="cm">/* We calculate alias addresses that will force the</span>
<span class="cm">	 * cache line in question out of the E-cache.  Then</span>
<span class="cm">	 * we bring it back in with an atomic instruction so</span>
<span class="cm">	 * that we get it in some modified/exclusive state,</span>
<span class="cm">	 * then we displace it again to try and get proper ECC</span>
<span class="cm">	 * pushed back into the system.</span>
<span class="cm">	 */</span>
	<span class="n">physaddr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">8UL</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">);</span>
	<span class="n">alias1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ecache_flush_physbase</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">physaddr</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">ecache_flush_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">alias2</span> <span class="o">=</span> <span class="n">alias1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ecache_flush_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa	[%0] %3, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;ldxa	[%1] %3, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;casxa	[%2] %3, %%g0, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;ldxa	[%0] %3, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;ldxa	[%1] %3, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar	#Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">alias1</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">alias2</span><span class="p">),</span>
			       <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">physaddr</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_PHYS_USE_EC</span><span class="p">));</span>

	<span class="cm">/* Did that trigger another error? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cheetah_recheck_errors</span><span class="p">(</span><span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Try one more time. */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%0] %1, %%g0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;membar #Sync&quot;</span>
				     <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">physaddr</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_PHYS_USE_EC</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cheetah_recheck_errors</span><span class="p">(</span><span class="nb">NULL</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No new error, intermittent problem. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restore error enables. */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;stxa	%0, [%%g0] %1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar	#Sync&quot;</span>
			     <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">orig_estate</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_ESTATE_ERROR_EN</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return non-zero if PADDR is a valid physical memory address. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cheetah_check_main_memory</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span> <span class="o">=</span> <span class="n">PAGE_OFFSET</span> <span class="o">+</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">high_memory</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">kern_addr_valid</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cheetah_cee_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="n">local_snapshot</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recoverable</span><span class="p">,</span> <span class="n">is_memory</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">cheetah_get_error_log</span><span class="p">(</span><span class="n">afsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;ERROR: Early CEE error afsr[%016lx] afar[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;ERROR: CPU(%d) TPC[%016lx] TNPC[%016lx] TSTATE[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Grab snapshot of logged error. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local_snapshot</span><span class="p">));</span>

	<span class="cm">/* If the current trap snapshot does not match what the</span>
<span class="cm">	 * trap handler passed along into our args, big trouble.</span>
<span class="cm">	 * In such a case, mark the local copy as invalid.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Else, it matches and we mark the afsr in the non-local</span>
<span class="cm">	 * copy as invalid so we may log new error traps there.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">afsr</span> <span class="o">!=</span> <span class="n">afsr</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">afar</span> <span class="o">!=</span> <span class="n">afar</span><span class="p">)</span>
		<span class="n">local_snapshot</span><span class="p">.</span><span class="n">afsr</span> <span class="o">=</span> <span class="n">CHAFSR_INVALID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">afsr</span> <span class="o">=</span> <span class="n">CHAFSR_INVALID</span><span class="p">;</span>

	<span class="n">is_memory</span> <span class="o">=</span> <span class="n">cheetah_check_main_memory</span><span class="p">(</span><span class="n">afar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_memory</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_CE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* XXX Might want to log the results of this operation</span>
<span class="cm">		 * XXX somewhere... -DaveM</span>
<span class="cm">		 */</span>
		<span class="n">cheetah_fix_ce</span><span class="p">(</span><span class="n">afar</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">flush_all</span><span class="p">,</span> <span class="n">flush_line</span><span class="p">;</span>

		<span class="n">flush_all</span> <span class="o">=</span> <span class="n">flush_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_EDC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">cheetah_afsr_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHAFSR_EDC</span><span class="p">)</span>
				<span class="n">flush_line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">flush_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_CPC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">cheetah_afsr_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHAFSR_CPC</span><span class="p">)</span>
				<span class="n">flush_line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">flush_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Trap handler only disabled I-cache, flush it. */</span>
		<span class="n">cheetah_flush_icache</span><span class="p">();</span>

		<span class="cm">/* Re-enable I-cache */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;membar #Sync&quot;</span>
				     <span class="o">:</span> <span class="cm">/* no outputs */</span>
				     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">),</span>
				     <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">DCU_IC</span><span class="p">)</span>
				     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flush_all</span><span class="p">)</span>
			<span class="n">cheetah_flush_ecache</span><span class="p">();</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flush_line</span><span class="p">)</span>
			<span class="n">cheetah_flush_ecache_line</span><span class="p">(</span><span class="n">afar</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enable error reporting */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_ESTATE_ERROR_EN</span><span class="p">),</span>
			       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ESTATE_ERROR_CEEN</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

	<span class="cm">/* Decide if we can continue after handling this trap and</span>
<span class="cm">	 * logging the error.</span>
<span class="cm">	 */</span>
	<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHAFSR_PERR</span> <span class="o">|</span> <span class="n">CHAFSR_IERR</span> <span class="o">|</span> <span class="n">CHAFSR_ISAP</span><span class="p">))</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Re-check AFSR/AFAR */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cheetah_recheck_errors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">);</span>

	<span class="cm">/* Log errors. */</span>
	<span class="n">cheetah_log_errors</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">,</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">recoverable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recoverable</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Irrecoverable Correctable-ECC error trap.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cheetah_deferred_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cheetah_err_info</span> <span class="n">local_snapshot</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recoverable</span><span class="p">,</span> <span class="n">is_memory</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="cm">/* Check for the special PCI poke sequence. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_poke_in_progress</span> <span class="o">&amp;&amp;</span> <span class="n">pci_poke_cpu</span> <span class="o">==</span> <span class="n">smp_processor_id</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">cheetah_flush_icache</span><span class="p">();</span>
		<span class="n">cheetah_flush_dcache</span><span class="p">();</span>

		<span class="cm">/* Re-enable I-cache/D-cache */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;membar #Sync&quot;</span>
				     <span class="o">:</span> <span class="cm">/* no outputs */</span>
				     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">),</span>
				       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">DCU_DC</span> <span class="o">|</span> <span class="n">DCU_IC</span><span class="p">)</span>
				     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

		<span class="cm">/* Re-enable error reporting */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;membar #Sync&quot;</span>
				     <span class="o">:</span> <span class="cm">/* no outputs */</span>
				     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_ESTATE_ERROR_EN</span><span class="p">),</span>
				       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ESTATE_ERROR_NCEEN</span> <span class="o">|</span> <span class="n">ESTATE_ERROR_CEEN</span><span class="p">)</span>
				     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cheetah_recheck_errors</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

		<span class="n">pci_poke_faulted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">cheetah_get_error_log</span><span class="p">(</span><span class="n">afsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;ERROR: Early deferred error afsr[%016lx] afar[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;ERROR: CPU(%d) TPC[%016lx] TNPC[%016lx] TSTATE[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Grab snapshot of logged error. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local_snapshot</span><span class="p">));</span>

	<span class="cm">/* If the current trap snapshot does not match what the</span>
<span class="cm">	 * trap handler passed along into our args, big trouble.</span>
<span class="cm">	 * In such a case, mark the local copy as invalid.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Else, it matches and we mark the afsr in the non-local</span>
<span class="cm">	 * copy as invalid so we may log new error traps there.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">afsr</span> <span class="o">!=</span> <span class="n">afsr</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">afar</span> <span class="o">!=</span> <span class="n">afar</span><span class="p">)</span>
		<span class="n">local_snapshot</span><span class="p">.</span><span class="n">afsr</span> <span class="o">=</span> <span class="n">CHAFSR_INVALID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">afsr</span> <span class="o">=</span> <span class="n">CHAFSR_INVALID</span><span class="p">;</span>

	<span class="n">is_memory</span> <span class="o">=</span> <span class="n">cheetah_check_main_memory</span><span class="p">(</span><span class="n">afar</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">flush_all</span><span class="p">,</span> <span class="n">flush_line</span><span class="p">;</span>

		<span class="n">flush_all</span> <span class="o">=</span> <span class="n">flush_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_EDU</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">cheetah_afsr_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHAFSR_EDU</span><span class="p">)</span>
				<span class="n">flush_line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">flush_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">CHAFSR_BERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">cheetah_afsr_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHAFSR_BERR</span><span class="p">)</span>
				<span class="n">flush_line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">flush_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cheetah_flush_icache</span><span class="p">();</span>
		<span class="n">cheetah_flush_dcache</span><span class="p">();</span>

		<span class="cm">/* Re-enable I/D caches */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				     <span class="s">&quot;membar #Sync&quot;</span>
				     <span class="o">:</span> <span class="cm">/* no outputs */</span>
				     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">),</span>
				     <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">DCU_IC</span> <span class="o">|</span> <span class="n">DCU_DC</span><span class="p">)</span>
				     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flush_all</span><span class="p">)</span>
			<span class="n">cheetah_flush_ecache</span><span class="p">();</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flush_line</span><span class="p">)</span>
			<span class="n">cheetah_flush_ecache_line</span><span class="p">(</span><span class="n">afar</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enable error reporting */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_ESTATE_ERROR_EN</span><span class="p">),</span>
			     <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ESTATE_ERROR_NCEEN</span> <span class="o">|</span> <span class="n">ESTATE_ERROR_CEEN</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

	<span class="cm">/* Decide if we can continue after handling this trap and</span>
<span class="cm">	 * logging the error.</span>
<span class="cm">	 */</span>
	<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHAFSR_PERR</span> <span class="o">|</span> <span class="n">CHAFSR_IERR</span> <span class="o">|</span> <span class="n">CHAFSR_ISAP</span><span class="p">))</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Re-check AFSR/AFAR.  What we are looking for here is whether a new</span>
<span class="cm">	 * error was logged while we had error reporting traps disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cheetah_recheck_errors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_afsr</span> <span class="o">=</span> <span class="n">local_snapshot</span><span class="p">.</span><span class="n">afsr</span><span class="p">;</span>

		<span class="cm">/* If we got a new asynchronous error, die... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_afsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHAFSR_EMU</span> <span class="o">|</span> <span class="n">CHAFSR_EDU</span> <span class="o">|</span>
				<span class="n">CHAFSR_WDU</span> <span class="o">|</span> <span class="n">CHAFSR_CPU</span> <span class="o">|</span>
				<span class="n">CHAFSR_IVU</span> <span class="o">|</span> <span class="n">CHAFSR_UE</span> <span class="o">|</span>
				<span class="n">CHAFSR_BERR</span> <span class="o">|</span> <span class="n">CHAFSR_TO</span><span class="p">))</span>
			<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Log errors. */</span>
	<span class="n">cheetah_log_errors</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_snapshot</span><span class="p">,</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">recoverable</span><span class="p">);</span>

	<span class="cm">/* &quot;Recoverable&quot; here means we try to yank the page from ever</span>
<span class="cm">	 * being newly used again.  This depends upon a few things:</span>
<span class="cm">	 * 1) Must be main memory, and AFAR must be valid.</span>
<span class="cm">	 * 2) If we trapped from user, OK.</span>
<span class="cm">	 * 3) Else, if we trapped from kernel we must find exception</span>
<span class="cm">	 *    table entry (ie. we have to have been accessing user</span>
<span class="cm">	 *    space).</span>
<span class="cm">	 *</span>
<span class="cm">	 * If AFAR is not in main memory, or we trapped from kernel</span>
<span class="cm">	 * and cannot find an exception table entry, it is unacceptable</span>
<span class="cm">	 * to try and continue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recoverable</span> <span class="o">&amp;&amp;</span> <span class="n">is_memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* OK, usermode access. */</span>
			<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">exception_table_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

			<span class="n">entry</span> <span class="o">=</span> <span class="n">search_exception_tables</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* OK, kernel access to userspace. */</span>
				<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* BAD, privileged state is corrupted. */</span>
				<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">recoverable</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pfn_valid</span><span class="p">(</span><span class="n">afar</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span>
					<span class="n">get_page</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">afar</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>
				<span class="k">else</span>
					<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* Only perform fixup if we still have a</span>
<span class="cm">				 * recoverable condition.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">recoverable</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fixup</span><span class="p">;</span>
					<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recoverable</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Irrecoverable deferred error trap.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Handle a D/I cache parity error trap.  TYPE is encoded as:</span>
<span class="cm"> *</span>
<span class="cm"> * Bit0:	0=dcache,1=icache</span>
<span class="cm"> * Bit1:	0=recoverable,1=unrecoverable</span>
<span class="cm"> *</span>
<span class="cm"> * The hardware has disabled both the I-cache and D-cache in</span>
<span class="cm"> * the %dcr register.  </span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cheetah_plus_parity_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">__cheetah_flush_icache</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">cheetah_plus_zap_dcache_parity</span><span class="p">();</span>
	<span class="n">cheetah_flush_dcache</span><span class="p">();</span>

	<span class="cm">/* Re-enable I-cache/D-cache */</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;ldxa [%%g0] %0, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;or %%g1, %1, %%g1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;stxa %%g1, [%%g0] %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;membar #Sync&quot;</span>
			     <span class="o">:</span> <span class="cm">/* no outputs */</span>
			     <span class="o">:</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_DCU_CONTROL_REG</span><span class="p">),</span>
			       <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">DCU_DC</span> <span class="o">|</span> <span class="n">DCU_IC</span><span class="p">)</span>
			     <span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;CPU[%d]: Cheetah+ %c-cache parity error at TPC[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">smp_processor_id</span><span class="p">(),</span>
		       <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;I&#39;</span> <span class="o">:</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span>
		       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;TPC&lt;%pS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Irrecoverable Cheetah+ parity error.&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CPU[%d]: Cheetah+ %c-cache parity error at TPC[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">smp_processor_id</span><span class="p">(),</span>
	       <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;I&#39;</span> <span class="o">:</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;TPC&lt;%pS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sun4v_error_entry</span> <span class="p">{</span>
	<span class="n">u64</span>		<span class="n">err_handle</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">err_stick</span><span class="p">;</span>

	<span class="n">u32</span>		<span class="n">err_type</span><span class="p">;</span>
<span class="cp">#define SUN4V_ERR_TYPE_UNDEFINED	0</span>
<span class="cp">#define SUN4V_ERR_TYPE_UNCORRECTED_RES	1</span>
<span class="cp">#define SUN4V_ERR_TYPE_PRECISE_NONRES	2</span>
<span class="cp">#define SUN4V_ERR_TYPE_DEFERRED_NONRES	3</span>
<span class="cp">#define SUN4V_ERR_TYPE_WARNING_RES	4</span>

	<span class="n">u32</span>		<span class="n">err_attrs</span><span class="p">;</span>
<span class="cp">#define SUN4V_ERR_ATTRS_PROCESSOR	0x00000001</span>
<span class="cp">#define SUN4V_ERR_ATTRS_MEMORY		0x00000002</span>
<span class="cp">#define SUN4V_ERR_ATTRS_PIO		0x00000004</span>
<span class="cp">#define SUN4V_ERR_ATTRS_INT_REGISTERS	0x00000008</span>
<span class="cp">#define SUN4V_ERR_ATTRS_FPU_REGISTERS	0x00000010</span>
<span class="cp">#define SUN4V_ERR_ATTRS_USER_MODE	0x01000000</span>
<span class="cp">#define SUN4V_ERR_ATTRS_PRIV_MODE	0x02000000</span>
<span class="cp">#define SUN4V_ERR_ATTRS_RES_QUEUE_FULL	0x80000000</span>

	<span class="n">u64</span>		<span class="n">err_raddr</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">err_size</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">err_cpu</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">err_pad</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">sun4v_resum_oflow_cnt</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">sun4v_nonresum_oflow_cnt</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sun4v_err_type_to_str</span><span class="p">(</span><span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SUN4V_ERR_TYPE_UNDEFINED</span>:
		<span class="k">return</span> <span class="s">&quot;undefined&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SUN4V_ERR_TYPE_UNCORRECTED_RES</span>:
		<span class="k">return</span> <span class="s">&quot;uncorrected resumable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SUN4V_ERR_TYPE_PRECISE_NONRES</span>:
		<span class="k">return</span> <span class="s">&quot;precise nonresumable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SUN4V_ERR_TYPE_DEFERRED_NONRES</span>:
		<span class="k">return</span> <span class="s">&quot;deferred nonresumable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SUN4V_ERR_TYPE_WARNING_RES</span>:
		<span class="k">return</span> <span class="s">&quot;warning resumable&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sun4v_log_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sun4v_error_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pfx</span><span class="p">,</span> <span class="n">atomic_t</span> <span class="o">*</span><span class="n">ocnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Reporting on cpu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: err_handle[%llx] err_stick[%llx] err_type[%08x:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pfx</span><span class="p">,</span>
	       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_handle</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_stick</span><span class="p">,</span>
	       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_type</span><span class="p">,</span>
	       <span class="n">sun4v_err_type_to_str</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_type</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: err_attrs[%08x:%s %s %s %s %s %s %s %s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pfx</span><span class="p">,</span>
	       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span> <span class="o">&amp;</span> <span class="n">SUN4V_ERR_ATTRS_PROCESSOR</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;processor&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span> <span class="o">&amp;</span> <span class="n">SUN4V_ERR_ATTRS_MEMORY</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;memory&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span> <span class="o">&amp;</span> <span class="n">SUN4V_ERR_ATTRS_PIO</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;pio&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span> <span class="o">&amp;</span> <span class="n">SUN4V_ERR_ATTRS_INT_REGISTERS</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;integer-regs&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span> <span class="o">&amp;</span> <span class="n">SUN4V_ERR_ATTRS_FPU_REGISTERS</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;fpu-regs&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span> <span class="o">&amp;</span> <span class="n">SUN4V_ERR_ATTRS_USER_MODE</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;user&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span> <span class="o">&amp;</span> <span class="n">SUN4V_ERR_ATTRS_PRIV_MODE</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;privileged&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_attrs</span> <span class="o">&amp;</span> <span class="n">SUN4V_ERR_ATTRS_RES_QUEUE_FULL</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;queue-full&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: err_raddr[%016llx] err_size[%u] err_cpu[%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pfx</span><span class="p">,</span>
	       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_raddr</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_size</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_cpu</span><span class="p">);</span>

	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="n">ocnt</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="n">ocnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Queue overflowed %d times.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pfx</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* We run with %pil set to PIL_NORMAL_MAX and PSTATE_IE enabled in %pstate.</span>
<span class="cm"> * Log the event and clear the first word of the entry.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sun4v_resum_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sun4v_error_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="n">local_copy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trap_per_cpu</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trap_block</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>
	<span class="n">paddr</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">resum_kernel_buf_pa</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">ent</span> <span class="o">=</span> <span class="n">__va</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_copy</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sun4v_error_entry</span><span class="p">));</span>

	<span class="cm">/* We have a local copy now, so release the entry.  */</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">put_cpu</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_type</span> <span class="o">==</span> <span class="n">SUN4V_ERR_TYPE_WARNING_RES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If err_type is 0x4, it&#39;s a powerdown request.  Do</span>
<span class="cm">		 * not do the usual resumable error log because that</span>
<span class="cm">		 * makes it look like some abnormal error.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Power down request...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kill_cad_pid</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sun4v_log_error</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_copy</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;RESUMABLE ERROR&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sun4v_resum_oflow_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* If we try to printk() we&#39;ll probably make matters worse, by trying</span>
<span class="cm"> * to retake locks this cpu already holds or causing more errors. So</span>
<span class="cm"> * just bump a counter, and we&#39;ll report these counter bumps above.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sun4v_resum_overflow</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sun4v_resum_oflow_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We run with %pil set to PIL_NORMAL_MAX and PSTATE_IE enabled in %pstate.</span>
<span class="cm"> * Log the event, clear the first word of the entry, and die.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sun4v_nonresum_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sun4v_error_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="n">local_copy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trap_per_cpu</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trap_block</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>
	<span class="n">paddr</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">nonresum_kernel_buf_pa</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">ent</span> <span class="o">=</span> <span class="n">__va</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_copy</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sun4v_error_entry</span><span class="p">));</span>

	<span class="cm">/* We have a local copy now, so release the entry.  */</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">put_cpu</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="cm">/* Check for the special PCI poke sequence. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_poke_in_progress</span> <span class="o">&amp;&amp;</span> <span class="n">pci_poke_cpu</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_poke_faulted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">sun4v_log_error</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_copy</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span>
			<span class="n">KERN_EMERG</span> <span class="s">&quot;NON-RESUMABLE ERROR&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sun4v_nonresum_oflow_cnt</span><span class="p">);</span>

	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Non-resumable error.&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* If we try to printk() we&#39;ll probably make matters worse, by trying</span>
<span class="cm"> * to retake locks this cpu already holds or causing more errors. So</span>
<span class="cm"> * just bump a counter, and we&#39;ll report these counter bumps above.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sun4v_nonresum_overflow</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX Actually even this can make not that much sense.  Perhaps</span>
<span class="cm">	 * XXX we should just pull the plug and panic directly from here?</span>
<span class="cm">	 */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sun4v_nonresum_oflow_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun4v_err_itlb_vaddr</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun4v_err_itlb_ctx</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun4v_err_itlb_pte</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun4v_err_itlb_error</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">sun4v_itlb_error_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-ITLB: Error at TPC[%lx], tl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">,</span> <span class="n">tl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-ITLB: TPC&lt;%pS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-ITLB: O7[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">u_regs</span><span class="p">[</span><span class="n">UREG_I7</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-ITLB: O7&lt;%pS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">u_regs</span><span class="p">[</span><span class="n">UREG_I7</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-ITLB: vaddr[%lx] ctx[%lx] &quot;</span>
	       <span class="s">&quot;pte[%lx] error[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sun4v_err_itlb_vaddr</span><span class="p">,</span> <span class="n">sun4v_err_itlb_ctx</span><span class="p">,</span>
	       <span class="n">sun4v_err_itlb_pte</span><span class="p">,</span> <span class="n">sun4v_err_itlb_error</span><span class="p">);</span>

	<span class="n">prom_halt</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun4v_err_dtlb_vaddr</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun4v_err_dtlb_ctx</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun4v_err_dtlb_pte</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun4v_err_dtlb_error</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">sun4v_dtlb_error_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-DTLB: Error at TPC[%lx], tl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">,</span> <span class="n">tl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-DTLB: TPC&lt;%pS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-DTLB: O7[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">u_regs</span><span class="p">[</span><span class="n">UREG_I7</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-DTLB: O7&lt;%pS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">u_regs</span><span class="p">[</span><span class="n">UREG_I7</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;SUN4V-DTLB: vaddr[%lx] ctx[%lx] &quot;</span>
	       <span class="s">&quot;pte[%lx] error[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sun4v_err_dtlb_vaddr</span><span class="p">,</span> <span class="n">sun4v_err_dtlb_ctx</span><span class="p">,</span>
	       <span class="n">sun4v_err_dtlb_pte</span><span class="p">,</span> <span class="n">sun4v_err_dtlb_error</span><span class="p">);</span>

	<span class="n">prom_halt</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hypervisor_tlbop_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;SUN4V: TLB hv call error %lu for op %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">err</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hypervisor_tlbop_error_xcall</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;SUN4V: XCALL TLB hv call error %lu for op %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">err</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_fpe_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fsr</span> <span class="o">=</span> <span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">xfsr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">__SI_FAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="mh">0x1c000</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTOVF</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTDIV</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTRES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_fpieee</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;fpu exception ieee&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">SIGFPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">do_fpe_common</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">do_mathemu</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fpustate</span> <span class="o">*</span><span class="p">,</span> <span class="n">bool</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">do_fpother</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fpustate</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">FPUSTATE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;fpu exception other&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">SIGFPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">xfsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1c000</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span>: <span class="cm">/* unfinished_FPop */</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span>: <span class="cm">/* unimplemented_FPop */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_mathemu</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">do_fpe_common</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_tof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;tagged arithmetic overflow&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="n">SIGEMT</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Penguin overflow trap from kernel mode&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGEMT</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">EMT_TAGOVF</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGEMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_div0</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;integer division by zero&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">SIGFPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL0: Kernel divide by zero.&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_INTDIV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">instruction_dump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction DUMP:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c%08x%c&quot;</span><span class="p">,</span><span class="n">i</span><span class="o">?</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="sc">&#39;&lt;&#39;</span><span class="p">,</span><span class="n">pc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="o">?</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">user_instruction_dump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	
	<span class="k">if</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pc</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction DUMP:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c%08x%c&quot;</span><span class="p">,</span><span class="n">i</span><span class="o">==</span><span class="mi">3</span><span class="o">?</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="sc">&#39;&lt;&#39;</span><span class="p">,</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="o">==</span><span class="mi">3</span><span class="o">?</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">_ksp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ksp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_FUNCTION_GRAPH_TRACER</span>
	<span class="kt">int</span> <span class="n">graph</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ksp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_ksp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tsk</span><span class="p">)</span>
		<span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">task_thread_info</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ksp</span> <span class="o">==</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tsk</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
			<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mov %%fp, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ksp</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">ksp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">ksp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">==</span> <span class="n">current_thread_info</span><span class="p">())</span>
		<span class="n">flushw_all</span><span class="p">();</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">ksp</span> <span class="o">+</span> <span class="n">STACK_BIAS</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Call Trace:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sparc_stackf</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kstack_valid</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sparc_stackf</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">;</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">sf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kstack_is_trap_frame</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">;</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">u_regs</span><span class="p">[</span><span class="n">UREG_I6</span><span class="p">]</span> <span class="o">+</span> <span class="n">STACK_BIAS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pc</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">callers_pc</span><span class="p">;</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">+</span> <span class="n">STACK_BIAS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; [%016lx] %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pc</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_FUNCTION_GRAPH_TRACER</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">8UL</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">return_to_handler</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">ret_stack</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">graph</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pc</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="n">graph</span><span class="p">].</span><span class="n">ret</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; [%016lx] %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pc</span><span class="p">);</span>
				<span class="n">graph</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dump_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_stack</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dump_stack</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">reg_window</span> <span class="o">*</span><span class="nf">kernel_stack_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">reg_window</span> <span class="o">*</span><span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">rw</span><span class="o">-&gt;</span><span class="n">ins</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">reg_window</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">STACK_BIAS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">die_if_kernel</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">die_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="cm">/* Amuse the user. */</span>
	<span class="n">printk</span><span class="p">(</span>
<span class="s">&quot;              </span><span class="se">\\</span><span class="s">|/ ____ </span><span class="se">\\</span><span class="s">|/</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;              </span><span class="se">\&quot;</span><span class="s">@&#39;/ .. </span><span class="se">\\</span><span class="s">`@</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;              /_| </span><span class="se">\\</span><span class="s">__/ |_</span><span class="se">\\\n</span><span class="s">&quot;</span>
<span class="s">&quot;                 </span><span class="se">\\</span><span class="s">__U_/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d): %s [#%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">str</span><span class="p">,</span> <span class="o">++</span><span class="n">die_counter</span><span class="p">);</span>
	<span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_OOPS</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;flushw&quot;</span><span class="p">);</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_DIE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">current_thread_info</span><span class="p">();</span>
		<span class="k">struct</span> <span class="n">reg_window</span> <span class="o">*</span><span class="n">rw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">reg_window</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">u_regs</span><span class="p">[</span><span class="n">UREG_FP</span><span class="p">]</span> <span class="o">+</span> <span class="n">STACK_BIAS</span><span class="p">);</span>

		<span class="cm">/* Stop the back trace when we hit userland or we</span>
<span class="cm">		 * find some badly aligned kernel stack.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;&amp;</span>
		       <span class="n">count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="o">&amp;&amp;</span>
		       <span class="n">kstack_valid</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Caller[%016lx]: %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rw</span><span class="o">-&gt;</span><span class="n">ins</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">rw</span><span class="o">-&gt;</span><span class="n">ins</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

			<span class="n">rw</span> <span class="o">=</span> <span class="n">kernel_stack_up</span><span class="p">(</span><span class="n">rw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">instruction_dump</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">user_instruction_dump</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span>
		<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">);</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">die_if_kernel</span><span class="p">);</span>

<span class="cp">#define VIS_OPCODE_MASK	((0x3 &lt;&lt; 30) | (0x3f &lt;&lt; 19))</span>
<span class="cp">#define VIS_OPCODE_VAL	((0x2 &lt;&lt; 30) | (0x36 &lt;&lt; 19))</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">handle_popc</span><span class="p">(</span><span class="n">u32</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">handle_ldf_stq</span><span class="p">(</span><span class="n">u32</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">do_illegal_instruction</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tstate</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">insn</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;illegal instruction&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Kernel illegal instruction&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span>
		<span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">pc</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xc1ffc000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x81700000</span><span class="p">)</span> <span class="cm">/* POPC */</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handle_popc</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xc1580000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc1100000</span><span class="p">)</span> <span class="cm">/* LDQ/STQ */</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handle_ldf_stq</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">==</span> <span class="n">hypervisor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="n">VIS_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">VIS_OPCODE_VAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vis_emul</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">insn</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">fpustate</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">FPUSTATE</span><span class="p">;</span>

				<span class="cm">/* On UltraSPARC T2 and later, FPU insns which</span>
<span class="cm">				 * are not implemented in HW signal an illegal</span>
<span class="cm">				 * instruction trap and do not set the FP Trap</span>
<span class="cm">				 * Trap in the %fsr to unimplemented_FPop.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">do_mathemu</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">kernel_unaligned_trap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">insn</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">mem_address_unaligned</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfar</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sfsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;memory address unaligned&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kernel_unaligned_trap</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">sfar</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGBUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sun4v_do_mna</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;memory address unaligned&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span> <span class="o">&amp;</span> <span class="n">TSTATE_PRIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kernel_unaligned_trap</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGBUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_privop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_TRAP</span><span class="p">,</span> <span class="s">&quot;privileged operation&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
		       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_PRVOPC</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_privact</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_privop</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Trap level 1 stuff or other traps we should never see... */</span>
<span class="kt">void</span> <span class="nf">do_cee</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL0: Cache Error Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_cee_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: Cache Error Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_dae_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: Data Access Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_iae_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: Instruction Access Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_div0_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: DIV0 Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_fpdis_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: FPU Disabled&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_fpieee_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: FPU IEEE Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_fpother_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: FPU Other Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_ill_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: Illegal Instruction Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_irq_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: IRQ Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_lddfmna_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: LDDF Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_stdfmna_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: STDF Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_paw</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL0: Phys Watchpoint Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_paw_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: Phys Watchpoint Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_vaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL0: Virt Watchpoint Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_vaw_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: Virt Watchpoint Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_tof_tl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_tl1_traplog</span><span class="p">((</span><span class="k">struct</span> <span class="n">tl1_traplog</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;TL1: Tag Overflow Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_getpsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">u_regs</span><span class="p">[</span><span class="n">UREG_I0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tstate_to_psr</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span>   <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">tnpc</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">trap_per_cpu</span> <span class="n">trap_block</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">trap_block</span><span class="p">);</span>

<span class="cm">/* This can get invoked before sched_init() so play it super safe</span>
<span class="cm"> * and use hard_smp_processor_id().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">notrace</span> <span class="nf">init_cur_cpu_trap</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">hard_smp_processor_id</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">trap_per_cpu</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trap_block</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">pgd_paddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">thread_info_offsets_are_bolixed_dave</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">trap_per_cpu_offsets_are_bolixed_dave</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">tsb_config_offsets_are_bolixed_dave</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Only invoked on boot processor. */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Compile time sanity check. */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">TI_TASK</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_FLAGS</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_CPU</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_FPSAVED</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">fpsaved</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_KSP</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">ksp</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_FAULT_ADDR</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
					       <span class="n">fault_address</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_KREGS</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">kregs</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_UTRAPS</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">utraps</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_EXEC_DOMAIN</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
						<span class="n">exec_domain</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_REG_WINDOW</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
					       <span class="n">reg_window</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_RWIN_SPTRS</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
					       <span class="n">rwbuf_stkptrs</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_GSR</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">gsr</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_XFSR</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">xfsr</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_PRE_COUNT</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
					      <span class="n">preempt_count</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_NEW_CHILD</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">new_child</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_SYS_NOERROR</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
						<span class="n">syscall_noerror</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_RESTART_BLOCK</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
						  <span class="n">restart_block</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_KUNA_REGS</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
					      <span class="n">kern_una_regs</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_KUNA_INSN</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span>
					      <span class="n">kern_una_insn</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">TI_FPREGS</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span><span class="p">,</span> <span class="n">fpregs</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TI_FPREGS</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">TRAP_PER_CPU_THREAD</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span>
						     <span class="kr">thread</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_PGD_PADDR</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">pgd_paddr</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_CPU_MONDO_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">cpu_mondo_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_DEV_MONDO_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">dev_mondo_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_RESUM_MONDO_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">resum_mondo_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_RESUM_KBUF_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">resum_kernel_buf_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_NONRESUM_MONDO_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">nonresum_mondo_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_NONRESUM_KBUF_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">nonresum_kernel_buf_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_FAULT_INFO</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">fault_info</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_CPU_MONDO_BLOCK_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">cpu_mondo_block_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_CPU_LIST_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">cpu_list_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_TSB_HUGE</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">tsb_huge</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_TSB_HUGE_TEMP</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">tsb_huge_temp</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_IRQ_WORKLIST_PA</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">irq_worklist_pa</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_CPU_MONDO_QMASK</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">cpu_mondo_qmask</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_DEV_MONDO_QMASK</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">dev_mondo_qmask</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_RESUM_QMASK</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">resum_qmask</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_NONRESUM_QMASK</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">nonresum_qmask</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TRAP_PER_CPU_PER_CPU_BASE</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trap_per_cpu</span><span class="p">,</span> <span class="n">__per_cpu_base</span><span class="p">)));</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">((</span><span class="n">TSB_CONFIG_TSB</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb_config</span><span class="p">,</span> <span class="n">tsb</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TSB_CONFIG_RSS_LIMIT</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb_config</span><span class="p">,</span> <span class="n">tsb_rss_limit</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TSB_CONFIG_NENTRIES</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb_config</span><span class="p">,</span> <span class="n">tsb_nentries</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TSB_CONFIG_REG_VAL</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb_config</span><span class="p">,</span> <span class="n">tsb_reg_val</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TSB_CONFIG_MAP_VADDR</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb_config</span><span class="p">,</span> <span class="n">tsb_map_vaddr</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">TSB_CONFIG_MAP_PTE</span> <span class="o">!=</span>
		      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsb_config</span><span class="p">,</span> <span class="n">tsb_map_pte</span><span class="p">)));</span>

	<span class="cm">/* Attach to the address space of init_task.  On SMP we</span>
<span class="cm">	 * do this in smp.c:smp_callin for other cpus.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_mm</span><span class="p">.</span><span class="n">mm_count</span><span class="p">);</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">active_mm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_mm</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
