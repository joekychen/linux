<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › pci_sun4v.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci_sun4v.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* pci_sun4v.c: SUN4V specific PCI controller support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006, 2007, 2008 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/msi.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>

<span class="cp">#include &quot;pci_impl.h&quot;</span>
<span class="cp">#include &quot;iommu_common.h&quot;</span>

<span class="cp">#include &quot;pci_sun4v.h&quot;</span>

<span class="cp">#define DRIVER_NAME	&quot;pci_sun4v&quot;</span>
<span class="cp">#define PFX		DRIVER_NAME &quot;: &quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vpci_major</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vpci_minor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#define PGLIST_NENTS	(PAGE_SIZE / sizeof(u64))</span>

<span class="k">struct</span> <span class="n">iommu_batch</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>		<span class="cm">/* Device mapping is for.	*/</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">prot</span><span class="p">;</span>		<span class="cm">/* IOMMU page protections	*/</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">entry</span><span class="p">;</span>		<span class="cm">/* Index into IOTSB.		*/</span>
	<span class="n">u64</span>		<span class="o">*</span><span class="n">pglist</span><span class="p">;</span>	<span class="cm">/* List of physical pages	*/</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">npages</span><span class="p">;</span>		<span class="cm">/* Number of pages in list.	*/</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_batch</span><span class="p">,</span> <span class="n">iommu_batch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">iommu_batch_initialized</span><span class="p">;</span>

<span class="cm">/* Interrupts must be disabled.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iommu_batch_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_batch</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">iommu_batch</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span>		<span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span>		<span class="o">=</span> <span class="n">prot</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">entry</span>	<span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">npages</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupts must be disabled.  */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">iommu_batch_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu_batch</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">host_controller</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">devhandle</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">pglist</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pglist</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">npages</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">npages</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">npages</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">num</span><span class="p">;</span>

		<span class="n">num</span> <span class="o">=</span> <span class="n">pci_sun4v_iommu_map</span><span class="p">(</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">HV_PCI_TSBID</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">entry</span><span class="p">),</span>
					  <span class="n">npages</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">__pa</span><span class="p">(</span><span class="n">pglist</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;iommu_batch_flush: IOMMU map of &quot;</span>
				       <span class="s">&quot;[%08lx:%08llx:%lx:%lx:%lx] failed with &quot;</span>
				       <span class="s">&quot;status %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">devhandle</span><span class="p">,</span> <span class="n">HV_PCI_TSBID</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">entry</span><span class="p">),</span>
				       <span class="n">npages</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">__pa</span><span class="p">(</span><span class="n">pglist</span><span class="p">),</span> <span class="n">num</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">entry</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">npages</span> <span class="o">-=</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">pglist</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iommu_batch_new_entry</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_batch</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">iommu_batch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">==</span> <span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">)</span>
		<span class="n">iommu_batch_flush</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupts must be disabled.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">iommu_batch_add</span><span class="p">(</span><span class="n">u64</span> <span class="n">phys_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_batch</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">iommu_batch</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">&gt;=</span> <span class="n">PGLIST_NENTS</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">pglist</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">npages</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">phys_page</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">==</span> <span class="n">PGLIST_NENTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">iommu_batch_flush</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupts must be disabled.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">iommu_batch_end</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_batch</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">iommu_batch</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">&gt;=</span> <span class="n">PGLIST_NENTS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">iommu_batch_flush</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">dma_4v_alloc_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				   <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dma_addrp</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">first_page</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nid</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">IO_PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">order</span> <span class="o">&gt;=</span> <span class="n">MAX_ORDER</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">npages</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">nid</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">numa_node</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages_node</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">first_page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">first_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">iommu_range_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iommu</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">DMA_ERROR_CODE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">range_alloc_fail</span><span class="p">;</span>

	<span class="o">*</span><span class="n">dma_addrp</span> <span class="o">=</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table_map_base</span> <span class="o">+</span>
		      <span class="p">(</span><span class="n">entry</span> <span class="o">&lt;&lt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">first_page</span><span class="p">;</span>
	<span class="n">first_page</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">first_page</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">iommu_batch_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">HV_PCI_MAP_ATTR_READ</span> <span class="o">|</span>
			   <span class="n">HV_PCI_MAP_ATTR_WRITE</span><span class="p">),</span>
			  <span class="n">entry</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="n">iommu_batch_add</span><span class="p">(</span><span class="n">first_page</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">iommu_map_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iommu_batch_end</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">iommu_map_fail</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">iommu_map_fail:</span>
	<span class="cm">/* Interrupts are disabled.  */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">iommu_range_free</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="o">*</span><span class="n">dma_addrp</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">range_alloc_fail:</span>
	<span class="n">free_pages</span><span class="p">(</span><span class="n">first_page</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_4v_free_coherent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cpu</span><span class="p">,</span>
				 <span class="n">dma_addr_t</span> <span class="n">dvma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devhandle</span><span class="p">;</span>

	<span class="n">npages</span> <span class="o">=</span> <span class="n">IO_PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">iommu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="n">pbm</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">host_controller</span><span class="p">;</span>
	<span class="n">devhandle</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">;</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="p">((</span><span class="n">dvma</span> <span class="o">-</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table_map_base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">iommu_range_free</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">dvma</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num</span><span class="p">;</span>

		<span class="n">num</span> <span class="o">=</span> <span class="n">pci_sun4v_iommu_demap</span><span class="p">(</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">HV_PCI_TSBID</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">entry</span><span class="p">),</span>
					    <span class="n">npages</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">npages</span> <span class="o">-=</span> <span class="n">num</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">npages</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cpu</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">dma_4v_map_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sz</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">oaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">base_paddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">oaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">npages</span> <span class="o">=</span> <span class="n">IO_PAGE_ALIGN</span><span class="p">(</span><span class="n">oaddr</span> <span class="o">+</span> <span class="n">sz</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">oaddr</span> <span class="o">&amp;</span> <span class="n">IO_PAGE_MASK</span><span class="p">);</span>
	<span class="n">npages</span> <span class="o">&gt;&gt;=</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">iommu_range_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iommu</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">DMA_ERROR_CODE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">bus_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table_map_base</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">entry</span> <span class="o">&lt;&lt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bus_addr</span> <span class="o">|</span> <span class="p">(</span><span class="n">oaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IO_PAGE_MASK</span><span class="p">);</span>
	<span class="n">base_paddr</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">oaddr</span> <span class="o">&amp;</span> <span class="n">IO_PAGE_MASK</span><span class="p">);</span>
	<span class="n">prot</span> <span class="o">=</span> <span class="n">HV_PCI_MAP_ATTR_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">prot</span> <span class="o">|=</span> <span class="n">HV_PCI_MAP_ATTR_WRITE</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">iommu_batch_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">base_paddr</span> <span class="o">+=</span> <span class="n">IO_PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="n">iommu_batch_add</span><span class="p">(</span><span class="n">base_paddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">iommu_map_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iommu_batch_end</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">iommu_map_fail</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">DMA_ERROR_CODE</span><span class="p">;</span>

<span class="nl">iommu_map_fail:</span>
	<span class="cm">/* Interrupts are disabled.  */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">iommu_range_free</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">DMA_ERROR_CODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_4v_unmap_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">sz</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">npages</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devhandle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="n">pbm</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">host_controller</span><span class="p">;</span>
	<span class="n">devhandle</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">;</span>

	<span class="n">npages</span> <span class="o">=</span> <span class="n">IO_PAGE_ALIGN</span><span class="p">(</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">sz</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">bus_addr</span> <span class="o">&amp;</span> <span class="n">IO_PAGE_MASK</span><span class="p">);</span>
	<span class="n">npages</span> <span class="o">&gt;&gt;=</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">bus_addr</span> <span class="o">&amp;=</span> <span class="n">IO_PAGE_MASK</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">iommu_range_free</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus_addr</span> <span class="o">-</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table_map_base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num</span><span class="p">;</span>

		<span class="n">num</span> <span class="o">=</span> <span class="n">pci_sun4v_iommu_demap</span><span class="p">(</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">HV_PCI_TSBID</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">entry</span><span class="p">),</span>
					    <span class="n">npages</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">npages</span> <span class="o">-=</span> <span class="n">num</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">npages</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_4v_map_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">nelems</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">outs</span><span class="p">,</span> <span class="o">*</span><span class="n">segstart</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">prot</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_seg_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seg_boundary_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">outcount</span><span class="p">,</span> <span class="n">incount</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_shift</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">);</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nelems</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">iommu</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">prot</span> <span class="o">=</span> <span class="n">HV_PCI_MAP_ATTR_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">prot</span> <span class="o">|=</span> <span class="n">HV_PCI_MAP_ATTR_WRITE</span><span class="p">;</span>

	<span class="n">outs</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="n">segstart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sglist</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">outcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">incount</span> <span class="o">=</span> <span class="n">nelems</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Init first segment length for backout at failure */</span>
	<span class="n">outs</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">iommu_batch_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">);</span>

	<span class="n">max_seg_size</span> <span class="o">=</span> <span class="n">dma_get_max_seg_size</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">seg_boundary_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">dma_get_seg_boundary</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				  <span class="n">IO_PAGE_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">base_shift</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table_map_base</span> <span class="o">&gt;&gt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sglist</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">nelems</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">out_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">slen</span><span class="p">;</span>

		<span class="n">slen</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="cm">/* Sanity check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Allocate iommu entries for that segment */</span>
		<span class="n">paddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">SG_ENT_PHYS_ADDRESS</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="n">iommu_num_pages</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">IO_PAGE_SIZE</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">iommu_range_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iommu</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>

		<span class="cm">/* Handle failure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">DMA_ERROR_CODE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;iommu_alloc failed, iommu %p paddr %lx&quot;</span>
				       <span class="s">&quot; npages %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iommu</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">iommu_map_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">iommu_batch_new_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

		<span class="cm">/* Convert entry to a dma_addr_t */</span>
		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table_map_base</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">entry</span> <span class="o">&lt;&lt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">);</span>
		<span class="n">dma_addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IO_PAGE_MASK</span><span class="p">);</span>

		<span class="cm">/* Insert into HW table */</span>
		<span class="n">paddr</span> <span class="o">&amp;=</span> <span class="n">IO_PAGE_MASK</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">npages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">iommu_batch_add</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">iommu_map_failed</span><span class="p">;</span>
			<span class="n">paddr</span> <span class="o">+=</span> <span class="n">IO_PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If we are in an open segment, try merging */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">segstart</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We cannot merge if:</span>
<span class="cm">			 * - allocated dma_addr isn&#39;t contiguous to previous allocation</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dma_addr</span> <span class="o">!=</span> <span class="n">dma_next</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">outs</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">max_seg_size</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">is_span_boundary</span><span class="p">(</span><span class="n">out_entry</span><span class="p">,</span> <span class="n">base_shift</span><span class="p">,</span>
					      <span class="n">seg_boundary_size</span><span class="p">,</span> <span class="n">outs</span><span class="p">,</span> <span class="n">s</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* Can&#39;t merge: create a new segment */</span>
				<span class="n">segstart</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
				<span class="n">outcount</span><span class="o">++</span><span class="p">;</span>
				<span class="n">outs</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">outs</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">outs</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">segstart</span> <span class="o">==</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is a new segment, fill entries */</span>
			<span class="n">outs</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
			<span class="n">outs</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>
			<span class="n">out_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Calculate next page pointer for contiguous check */</span>
		<span class="n">dma_next</span> <span class="o">=</span> <span class="n">dma_addr</span> <span class="o">+</span> <span class="n">slen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iommu_batch_end</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">iommu_map_failed</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">outcount</span> <span class="o">&lt;</span> <span class="n">incount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outs</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">outs</span><span class="p">);</span>
		<span class="n">outs</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">=</span> <span class="n">DMA_ERROR_CODE</span><span class="p">;</span>
		<span class="n">outs</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">outcount</span><span class="p">;</span>

<span class="nl">iommu_map_failed:</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sglist</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">nelems</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">npages</span><span class="p">;</span>

			<span class="n">vaddr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">&amp;</span> <span class="n">IO_PAGE_MASK</span><span class="p">;</span>
			<span class="n">npages</span> <span class="o">=</span> <span class="n">iommu_num_pages</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_length</span><span class="p">,</span>
						 <span class="n">IO_PAGE_SIZE</span><span class="p">);</span>
			<span class="n">iommu_range_free</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
			<span class="cm">/* XXX demap? XXX */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">=</span> <span class="n">DMA_ERROR_CODE</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">outs</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_4v_unmap_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">nelems</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dma_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devhandle</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">);</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="n">pbm</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">host_controller</span><span class="p">;</span>
	<span class="n">devhandle</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nelems</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_handle</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_length</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">npages</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="n">iommu_num_pages</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">IO_PAGE_SIZE</span><span class="p">);</span>
		<span class="n">iommu_range_free</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="p">((</span><span class="n">dma_handle</span> <span class="o">-</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table_map_base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IO_PAGE_SHIFT</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">npages</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num</span><span class="p">;</span>

			<span class="n">num</span> <span class="o">=</span> <span class="n">pci_sun4v_iommu_demap</span><span class="p">(</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">HV_PCI_TSBID</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">entry</span><span class="p">),</span>
						    <span class="n">npages</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
			<span class="n">npages</span> <span class="o">-=</span> <span class="n">num</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_map_ops</span> <span class="n">sun4v_dma_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc</span>				<span class="o">=</span> <span class="n">dma_4v_alloc_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span>				<span class="o">=</span> <span class="n">dma_4v_free_coherent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_page</span>			<span class="o">=</span> <span class="n">dma_4v_map_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_page</span>			<span class="o">=</span> <span class="n">dma_4v_unmap_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_sg</span>				<span class="o">=</span> <span class="n">dma_4v_map_sg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_sg</span>			<span class="o">=</span> <span class="n">dma_4v_unmap_sg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pci_sun4v_scan_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_find_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;66mhz-capable&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">is_66mhz_capable</span> <span class="o">=</span> <span class="p">(</span><span class="n">prop</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">pci_scan_one_pbm</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* XXX register error interrupt handlers XXX */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__devinit</span> <span class="nf">probe_existing_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
						      <span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu_arena</span> <span class="o">*</span><span class="n">arena</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devhandle</span><span class="p">;</span>

	<span class="n">devhandle</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">,</span> <span class="n">io_attrs</span><span class="p">,</span> <span class="n">ra</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_sun4v_iommu_getmap</span><span class="p">(</span><span class="n">devhandle</span><span class="p">,</span>
					     <span class="n">HV_PCI_TSBID</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
					     <span class="o">&amp;</span><span class="n">io_attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ra</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">HV_EOK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page_in_phys_avail</span><span class="p">(</span><span class="n">ra</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pci_sun4v_iommu_demap</span><span class="p">(</span><span class="n">devhandle</span><span class="p">,</span>
						      <span class="n">HV_PCI_TSBID</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">__set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pci_sun4v_iommu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">vdma_default</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="mh">0x80000000</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_tsb_entries</span><span class="p">,</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_mask</span><span class="p">,</span> <span class="n">dma_offset</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vdma</span><span class="p">;</span>

	<span class="n">vdma</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;virtual-dma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdma</span><span class="p">)</span>
		<span class="n">vdma</span> <span class="o">=</span> <span class="n">vdma_default</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vdma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">vdma</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IO_PAGE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Strange virtual-dma[%08x:%08x].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vdma</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vdma</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">dma_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">vdma</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">);</span>
	<span class="n">num_tsb_entries</span> <span class="o">=</span> <span class="n">vdma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">IO_PAGE_SIZE</span><span class="p">;</span>

	<span class="n">dma_offset</span> <span class="o">=</span> <span class="n">vdma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Setup initial software IOMMU state. */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">ctx_lowest_free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table_map_base</span> <span class="o">=</span> <span class="n">dma_offset</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">dma_addr_mask</span> <span class="o">=</span> <span class="n">dma_mask</span><span class="p">;</span>

	<span class="cm">/* Allocate and initialize the free area map.  */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_tsb_entries</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">sz</span> <span class="o">+</span> <span class="mi">7UL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7UL</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">.</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Error, kmalloc(arena.map) failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">num_tsb_entries</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">probe_existing_entries</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">iommu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Imported %lu TSB entries from OBP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="k">struct</span> <span class="n">pci_sun4v_msiq_entry</span> <span class="p">{</span>
	<span class="n">u64</span>		<span class="n">version_type</span><span class="p">;</span>
<span class="cp">#define MSIQ_VERSION_MASK		0xffffffff00000000UL</span>
<span class="cp">#define MSIQ_VERSION_SHIFT		32</span>
<span class="cp">#define MSIQ_TYPE_MASK			0x00000000000000ffUL</span>
<span class="cp">#define MSIQ_TYPE_SHIFT			0</span>
<span class="cp">#define MSIQ_TYPE_NONE			0x00</span>
<span class="cp">#define MSIQ_TYPE_MSG			0x01</span>
<span class="cp">#define MSIQ_TYPE_MSI32			0x02</span>
<span class="cp">#define MSIQ_TYPE_MSI64			0x03</span>
<span class="cp">#define MSIQ_TYPE_INTX			0x08</span>
<span class="cp">#define MSIQ_TYPE_NONE2			0xff</span>

	<span class="n">u64</span>		<span class="n">intx_sysino</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">stick</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">req_id</span><span class="p">;</span>  <span class="cm">/* bus/device/func */</span>
<span class="cp">#define MSIQ_REQID_BUS_MASK		0xff00UL</span>
<span class="cp">#define MSIQ_REQID_BUS_SHIFT		8</span>
<span class="cp">#define MSIQ_REQID_DEVICE_MASK		0x00f8UL</span>
<span class="cp">#define MSIQ_REQID_DEVICE_SHIFT		3</span>
<span class="cp">#define MSIQ_REQID_FUNC_MASK		0x0007UL</span>
<span class="cp">#define MSIQ_REQID_FUNC_SHIFT		0</span>

	<span class="n">u64</span>		<span class="n">msi_address</span><span class="p">;</span>

	<span class="cm">/* The format of this value is message type dependent.</span>
<span class="cm">	 * For MSI bits 15:0 are the data from the MSI packet.</span>
<span class="cm">	 * For MSI-X bits 31:0 are the data from the MSI packet.</span>
<span class="cm">	 * For MSG, the message code and message routing code where:</span>
<span class="cm">	 * 	bits 39:32 is the bus/device/fn of the msg target-id</span>
<span class="cm">	 *	bits 18:16 is the message routing code</span>
<span class="cm">	 *	bits 7:0 is the message code</span>
<span class="cm">	 * For INTx the low order 2-bits are:</span>
<span class="cm">	 *	00 - INTA</span>
<span class="cm">	 *	01 - INTB</span>
<span class="cm">	 *	10 - INTC</span>
<span class="cm">	 *	11 - INTD</span>
<span class="cm">	 */</span>
	<span class="n">u64</span>		<span class="n">msi_data</span><span class="p">;</span>

	<span class="n">u64</span>		<span class="n">reserved2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_sun4v_get_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msiqid</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_sun4v_msiq_gethead</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msiqid</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_ent_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_sun4v_msiq_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_sun4v_dequeue_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msiqid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">msi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_sun4v_msiq_entry</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>

	<span class="cm">/* Note: void pointer arithmetic, &#39;head&#39; is a byte offset  */</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msi_queues</span> <span class="o">+</span> <span class="p">((</span><span class="n">msiqid</span> <span class="o">-</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_first</span><span class="p">)</span> <span class="o">*</span>
				 <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_ent_count</span> <span class="o">*</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_sun4v_msiq_entry</span><span class="p">)))</span> <span class="o">+</span>
	      <span class="o">*</span><span class="n">head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">version_type</span> <span class="o">&amp;</span> <span class="n">MSIQ_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">version_type</span> <span class="o">&amp;</span> <span class="n">MSIQ_TYPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MSIQ_TYPE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MSIQ_TYPE_MSI32</span> <span class="o">&amp;&amp;</span>
		     <span class="n">type</span> <span class="o">!=</span> <span class="n">MSIQ_TYPE_MSI64</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">msi</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">msi_data</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_sun4v_msi_setstate</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span>
				     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">msi_data</span> <span class="cm">/* msi_num */</span><span class="p">,</span>
				     <span class="n">HV_MSISTATE_IDLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Clear the entry.  */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">version_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSIQ_TYPE_MASK</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_sun4v_msiq_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span> <span class="o">&gt;=</span>
	    <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_ent_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_sun4v_msiq_entry</span><span class="p">)))</span>
		<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_sun4v_set_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msiqid</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_sun4v_msiq_sethead</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msiqid</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_sun4v_msi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msiqid</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_msi64</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_sun4v_msi_setmsiq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msi</span><span class="p">,</span> <span class="n">msiqid</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">is_msi64</span> <span class="o">?</span>
				   <span class="n">HV_MSITYPE_MSI64</span> <span class="o">:</span> <span class="n">HV_MSITYPE_MSI32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_sun4v_msi_setstate</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msi</span><span class="p">,</span> <span class="n">HV_MSISTATE_IDLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_sun4v_msi_setvalid</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msi</span><span class="p">,</span> <span class="n">HV_MSIVALID_VALID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_sun4v_msi_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err</span><span class="p">,</span> <span class="n">msiqid</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_sun4v_msi_getmsiq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msiqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">pci_sun4v_msi_setvalid</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msi</span><span class="p">,</span> <span class="n">HV_MSIVALID_INVALID</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_sun4v_msiq_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_size</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">order</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">q_size</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_ent_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_sun4v_msiq_entry</span><span class="p">);</span>
	<span class="n">alloc_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_num</span> <span class="o">*</span> <span class="n">q_size</span><span class="p">);</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">alloc_size</span><span class="p">);</span>
	<span class="n">pages</span> <span class="o">=</span> <span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_COMP</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pages</span> <span class="o">==</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSI: Cannot allocate MSI queues (o=%lu).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">order</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pages</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msi_queues</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pages</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">pages</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">q_size</span><span class="p">));</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_sun4v_msiq_conf</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span>
					  <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_first</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					  <span class="n">base</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_ent_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSI: msiq register fails (err=%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">h_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_sun4v_msiq_info</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span>
					  <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_first</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ret1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSI: Cannot read msiq (err=%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">h_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret1</span> <span class="o">!=</span> <span class="n">base</span> <span class="o">||</span> <span class="n">ret2</span> <span class="o">!=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_ent_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSI: Bogus qconf &quot;</span>
			       <span class="s">&quot;expected[%lx:%x] got[%lx:%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">base</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_ent_count</span><span class="p">,</span>
			       <span class="n">ret1</span><span class="p">,</span> <span class="n">ret2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">h_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">h_error:</span>
	<span class="n">free_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_sun4v_msiq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_size</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">order</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msiqid</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_first</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci_sun4v_msiq_conf</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msiqid</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">q_size</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_ent_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_sun4v_msiq_entry</span><span class="p">);</span>
	<span class="n">alloc_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msiq_num</span> <span class="o">*</span> <span class="n">q_size</span><span class="p">);</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">alloc_size</span><span class="p">);</span>

	<span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msi_queues</span><span class="p">;</span>

	<span class="n">free_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">msi_queues</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_sun4v_msiq_build_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msiqid</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">devino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">sun4v_build_irq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">devino</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_sun4v_msiq_setvalid</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msiqid</span><span class="p">,</span> <span class="n">HV_MSIQ_VALID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_sun4v_msiq_setstate</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span><span class="p">,</span> <span class="n">msiqid</span><span class="p">,</span> <span class="n">HV_MSIQSTATE_IDLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sparc64_msiq_ops</span> <span class="n">pci_sun4v_msiq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_head</span>	<span class="o">=</span>	<span class="n">pci_sun4v_get_head</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue_msi</span>	<span class="o">=</span>	<span class="n">pci_sun4v_dequeue_msi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_head</span>	<span class="o">=</span>	<span class="n">pci_sun4v_set_head</span><span class="p">,</span>
	<span class="p">.</span><span class="n">msi_setup</span>	<span class="o">=</span>	<span class="n">pci_sun4v_msi_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">msi_teardown</span>	<span class="o">=</span>	<span class="n">pci_sun4v_msi_teardown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">msiq_alloc</span>	<span class="o">=</span>	<span class="n">pci_sun4v_msiq_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">msiq_free</span>	<span class="o">=</span>	<span class="n">pci_sun4v_msiq_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">msiq_build_irq</span>	<span class="o">=</span>	<span class="n">pci_sun4v_msiq_build_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_sun4v_msi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sparc64_pbm_msi_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_sun4v_msiq_ops</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_sun4v_msi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !(CONFIG_PCI_MSI) */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pci_sun4v_pbm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">devhandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">numa_node</span> <span class="o">=</span> <span class="n">of_node_to_nid</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sun4v_pci_ops</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">config_space_reg_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">pci_num_pbms</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">devhandle</span> <span class="o">=</span> <span class="n">devhandle</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SUN4V PCI Bus Module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: On NUMA node %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">numa_node</span><span class="p">);</span>

	<span class="n">pci_determine_mem_io_space</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="n">pci_get_pbm_props</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_sun4v_iommu_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_sun4v_msi_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="n">pci_sun4v_scan_bus</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pci_pbm_root</span><span class="p">;</span>
	<span class="n">pci_pbm_root</span> <span class="o">=</span> <span class="n">pbm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pci_sun4v_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_prom64_registers</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">hvapi_negotiated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devhandle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hvapi_negotiated</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sun4v_hvapi_register</span><span class="p">(</span><span class="n">HV_GRP_PCI</span><span class="p">,</span>
					   <span class="n">vpci_major</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">vpci_minor</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Could not register hvapi, &quot;</span>
			       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Registered hvapi major[%lu] minor[%lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vpci_major</span><span class="p">,</span> <span class="n">vpci_minor</span><span class="p">);</span>

		<span class="n">dma_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sun4v_dma_ops</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Could not find config registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devhandle</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fffffff</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu_batch_initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

			<span class="n">per_cpu</span><span class="p">(</span><span class="n">iommu_batch</span><span class="p">,</span> <span class="n">i</span><span class="p">).</span><span class="n">pglist</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iommu_batch_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pbm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Could not allocate pci_pbm_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Could not allocate pbm iommu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_controller</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">iommu</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_sun4v_pbm_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">devhandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_iommu</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_iommu:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">);</span>

<span class="nl">out_free_controller:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">pci_sun4v_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;SUNW,sun4v-pci&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">pci_sun4v_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">pci_sun4v_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pci_sun4v_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_sun4v_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_sun4v_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">pci_sun4v_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
