<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › sbus.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sbus.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sbus.c: UltraSparc SBUS controller support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999 David S. Miller (davem@redhat.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/upa.h&gt;</span>
<span class="cp">#include &lt;asm/cache.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>
<span class="cp">#include &lt;asm/starfire.h&gt;</span>

<span class="cp">#include &quot;iommu_common.h&quot;</span>

<span class="cp">#define MAP_BASE	((u32)0xc0000000)</span>

<span class="cm">/* Offsets from iommu_regs */</span>
<span class="cp">#define SYSIO_IOMMUREG_BASE	0x2400UL</span>
<span class="cp">#define IOMMU_CONTROL	(0x2400UL - 0x2400UL)	</span><span class="cm">/* IOMMU control register */</span><span class="cp"></span>
<span class="cp">#define IOMMU_TSBBASE	(0x2408UL - 0x2400UL)	</span><span class="cm">/* TSB base address register */</span><span class="cp"></span>
<span class="cp">#define IOMMU_FLUSH	(0x2410UL - 0x2400UL)	</span><span class="cm">/* IOMMU flush register */</span><span class="cp"></span>
<span class="cp">#define IOMMU_VADIAG	(0x4400UL - 0x2400UL)	</span><span class="cm">/* SBUS virtual address diagnostic */</span><span class="cp"></span>
<span class="cp">#define IOMMU_TAGCMP	(0x4408UL - 0x2400UL)	</span><span class="cm">/* TLB tag compare diagnostics */</span><span class="cp"></span>
<span class="cp">#define IOMMU_LRUDIAG	(0x4500UL - 0x2400UL)	</span><span class="cm">/* IOMMU LRU queue diagnostics */</span><span class="cp"></span>
<span class="cp">#define IOMMU_TAGDIAG	(0x4580UL - 0x2400UL)	</span><span class="cm">/* TLB tag diagnostics */</span><span class="cp"></span>
<span class="cp">#define IOMMU_DRAMDIAG	(0x4600UL - 0x2400UL)	</span><span class="cm">/* TLB data RAM diagnostics */</span><span class="cp"></span>

<span class="cp">#define IOMMU_DRAM_VALID	(1UL &lt;&lt; 30UL)</span>

<span class="cm">/* Offsets from strbuf_regs */</span>
<span class="cp">#define SYSIO_STRBUFREG_BASE	0x2800UL</span>
<span class="cp">#define STRBUF_CONTROL	(0x2800UL - 0x2800UL)	</span><span class="cm">/* Control */</span><span class="cp"></span>
<span class="cp">#define STRBUF_PFLUSH	(0x2808UL - 0x2800UL)	</span><span class="cm">/* Page flush/invalidate */</span><span class="cp"></span>
<span class="cp">#define STRBUF_FSYNC	(0x2810UL - 0x2800UL)	</span><span class="cm">/* Flush synchronization */</span><span class="cp"></span>
<span class="cp">#define STRBUF_DRAMDIAG	(0x5000UL - 0x2800UL)	</span><span class="cm">/* data RAM diagnostic */</span><span class="cp"></span>
<span class="cp">#define STRBUF_ERRDIAG	(0x5400UL - 0x2800UL)	</span><span class="cm">/* error status diagnostics */</span><span class="cp"></span>
<span class="cp">#define STRBUF_PTAGDIAG	(0x5800UL - 0x2800UL)	</span><span class="cm">/* Page tag diagnostics */</span><span class="cp"></span>
<span class="cp">#define STRBUF_LTAGDIAG	(0x5900UL - 0x2800UL)	</span><span class="cm">/* Line tag diagnostics */</span><span class="cp"></span>

<span class="cp">#define STRBUF_TAG_VALID	0x02UL</span>

<span class="cm">/* Enable 64-bit DVMA mode for the given device. */</span>
<span class="kt">void</span> <span class="nf">sbus_set_sbus64</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bursts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_prom_registers</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfg_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sbus_set_sbus64: Cannot find regs for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">which_io</span><span class="p">;</span>

	<span class="n">cfg_reg</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">cfg_reg</span> <span class="o">+=</span> <span class="mh">0x20UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">cfg_reg</span> <span class="o">+=</span> <span class="mh">0x28UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">cfg_reg</span> <span class="o">+=</span> <span class="mh">0x30UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">cfg_reg</span> <span class="o">+=</span> <span class="mh">0x38UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">cfg_reg</span> <span class="o">+=</span> <span class="mh">0x40UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">cfg_reg</span> <span class="o">+=</span> <span class="mh">0x48UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">cfg_reg</span> <span class="o">+=</span> <span class="mh">0x50UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">cfg_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">14UL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Extended transfer mode already enabled. */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">14UL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST8</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">1UL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST16</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">2UL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST32</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">3UL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST64</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">4UL</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cfg_reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sbus_set_sbus64</span><span class="p">);</span>

<span class="cm">/* INO number to IMAP register offset for SYSIO external IRQ&#39;s.</span>
<span class="cm"> * This should conform to both Sunfire/Wildfire server and Fusion</span>
<span class="cm"> * desktop designs.</span>
<span class="cm"> */</span>
<span class="cp">#define SYSIO_IMAP_SLOT0	0x2c00UL</span>
<span class="cp">#define SYSIO_IMAP_SLOT1	0x2c08UL</span>
<span class="cp">#define SYSIO_IMAP_SLOT2	0x2c10UL</span>
<span class="cp">#define SYSIO_IMAP_SLOT3	0x2c18UL</span>
<span class="cp">#define SYSIO_IMAP_SCSI		0x3000UL</span>
<span class="cp">#define SYSIO_IMAP_ETH		0x3008UL</span>
<span class="cp">#define SYSIO_IMAP_BPP		0x3010UL</span>
<span class="cp">#define SYSIO_IMAP_AUDIO	0x3018UL</span>
<span class="cp">#define SYSIO_IMAP_PFAIL	0x3020UL</span>
<span class="cp">#define SYSIO_IMAP_KMS		0x3028UL</span>
<span class="cp">#define SYSIO_IMAP_FLPY		0x3030UL</span>
<span class="cp">#define SYSIO_IMAP_SHW		0x3038UL</span>
<span class="cp">#define SYSIO_IMAP_KBD		0x3040UL</span>
<span class="cp">#define SYSIO_IMAP_MS		0x3048UL</span>
<span class="cp">#define SYSIO_IMAP_SER		0x3050UL</span>
<span class="cp">#define SYSIO_IMAP_TIM0		0x3060UL</span>
<span class="cp">#define SYSIO_IMAP_TIM1		0x3068UL</span>
<span class="cp">#define SYSIO_IMAP_UE		0x3070UL</span>
<span class="cp">#define SYSIO_IMAP_CE		0x3078UL</span>
<span class="cp">#define SYSIO_IMAP_SBERR	0x3080UL</span>
<span class="cp">#define SYSIO_IMAP_PMGMT	0x3088UL</span>
<span class="cp">#define SYSIO_IMAP_GFX		0x3090UL</span>
<span class="cp">#define SYSIO_IMAP_EUPA		0x3098UL</span>

<span class="cp">#define bogon     ((unsigned long) -1)</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sysio_irq_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* SBUS Slot 0 --&gt; 3, level 1 --&gt; 7 */</span>
	<span class="n">SYSIO_IMAP_SLOT0</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT0</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT0</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT0</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SLOT0</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT0</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT0</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT0</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SLOT1</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT1</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT1</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT1</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SLOT1</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT1</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT1</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT1</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SLOT2</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT2</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT2</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT2</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SLOT2</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT2</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT2</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT2</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SLOT3</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT3</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT3</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT3</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SLOT3</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT3</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT3</span><span class="p">,</span> <span class="n">SYSIO_IMAP_SLOT3</span><span class="p">,</span>

	<span class="cm">/* Onboard devices (not relevant/used on SunFire). */</span>
	<span class="n">SYSIO_IMAP_SCSI</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_ETH</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_BPP</span><span class="p">,</span>
	<span class="n">bogon</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_AUDIO</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_PFAIL</span><span class="p">,</span>
	<span class="n">bogon</span><span class="p">,</span>
	<span class="n">bogon</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_KMS</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_FLPY</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SHW</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_KBD</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_MS</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SER</span><span class="p">,</span>
	<span class="n">bogon</span><span class="p">,</span>
	<span class="n">bogon</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_TIM0</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_TIM1</span><span class="p">,</span>
	<span class="n">bogon</span><span class="p">,</span>
	<span class="n">bogon</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_UE</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_CE</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_SBERR</span><span class="p">,</span>
	<span class="n">SYSIO_IMAP_PMGMT</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef bogon</span>

<span class="cp">#define NUM_SYSIO_OFFSETS ARRAY_SIZE(sysio_irq_offsets)</span>

<span class="cm">/* Convert Interrupt Mapping register pointer to associated</span>
<span class="cm"> * Interrupt Clear register pointer, SYSIO specific version.</span>
<span class="cm"> */</span>
<span class="cp">#define SYSIO_ICLR_UNUSED0	0x3400UL</span>
<span class="cp">#define SYSIO_ICLR_SLOT0	0x3408UL</span>
<span class="cp">#define SYSIO_ICLR_SLOT1	0x3448UL</span>
<span class="cp">#define SYSIO_ICLR_SLOT2	0x3488UL</span>
<span class="cp">#define SYSIO_ICLR_SLOT3	0x34c8UL</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sysio_imap_to_iclr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">imap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">SYSIO_ICLR_UNUSED0</span> <span class="o">-</span> <span class="n">SYSIO_IMAP_SLOT0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">imap</span> <span class="o">+</span> <span class="n">diff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sbus_build_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_base</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span> <span class="o">-</span> <span class="mh">0x2000UL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">imap</span><span class="p">,</span> <span class="n">iclr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sbus_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">imap</span> <span class="o">=</span> <span class="n">sysio_irq_offsets</span><span class="p">[</span><span class="n">ino</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imap</span> <span class="o">==</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;get_irq_translations: Bad SYSIO INO[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ino</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">imap</span> <span class="o">+=</span> <span class="n">reg_base</span><span class="p">;</span>

	<span class="cm">/* SYSIO inconsistency.  For external SLOTS, we have to select</span>
<span class="cm">	 * the right ICLR register based upon the lower SBUS irq level</span>
<span class="cm">	 * bits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iclr</span> <span class="o">=</span> <span class="n">sysio_imap_to_iclr</span><span class="p">(</span><span class="n">imap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sbus_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">ino</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">;</span>
		
		<span class="n">sbus_level</span> <span class="o">=</span> <span class="n">ino</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">sbus_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">iclr</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_ICLR_SLOT0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">iclr</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_ICLR_SLOT1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">iclr</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_ICLR_SLOT2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">iclr</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_ICLR_SLOT3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">iclr</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sbus_level</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">build_irq</span><span class="p">(</span><span class="n">sbus_level</span><span class="p">,</span> <span class="n">iclr</span><span class="p">,</span> <span class="n">imap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Error interrupt handling. */</span>
<span class="cp">#define SYSIO_UE_AFSR	0x0030UL</span>
<span class="cp">#define SYSIO_UE_AFAR	0x0038UL</span>
<span class="cp">#define  SYSIO_UEAFSR_PPIO  0x8000000000000000UL </span><span class="cm">/* Primary PIO cause         */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_PDRD  0x4000000000000000UL </span><span class="cm">/* Primary DVMA read cause   */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_PDWR  0x2000000000000000UL </span><span class="cm">/* Primary DVMA write cause  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_SPIO  0x1000000000000000UL </span><span class="cm">/* Secondary PIO is cause    */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_SDRD  0x0800000000000000UL </span><span class="cm">/* Secondary DVMA read cause */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_SDWR  0x0400000000000000UL </span><span class="cm">/* Secondary DVMA write cause*/</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_RESV1 0x03ff000000000000UL </span><span class="cm">/* Reserved                  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_DOFF  0x0000e00000000000UL </span><span class="cm">/* Doubleword Offset         */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_SIZE  0x00001c0000000000UL </span><span class="cm">/* Bad transfer size 2^SIZE  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_MID   0x000003e000000000UL </span><span class="cm">/* UPA MID causing the fault */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_UEAFSR_RESV2 0x0000001fffffffffUL </span><span class="cm">/* Reserved                  */</span><span class="cp"></span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sysio_ue_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_base</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span> <span class="o">-</span> <span class="mh">0x2000UL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span><span class="p">,</span> <span class="n">afar_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">,</span> <span class="n">portid</span><span class="p">;</span>

	<span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_UE_AFSR</span><span class="p">;</span>
	<span class="n">afar_reg</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_UE_AFAR</span><span class="p">;</span>

	<span class="cm">/* Latch error status. */</span>
	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>

	<span class="cm">/* Clear primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SYSIO_UEAFSR_PPIO</span> <span class="o">|</span> <span class="n">SYSIO_UEAFSR_PDRD</span> <span class="o">|</span> <span class="n">SYSIO_UEAFSR_PDWR</span> <span class="o">|</span>
		 <span class="n">SYSIO_UEAFSR_SPIO</span> <span class="o">|</span> <span class="n">SYSIO_UEAFSR_SDRD</span> <span class="o">|</span> <span class="n">SYSIO_UEAFSR_SDWR</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="n">portid</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;portid&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: Uncorrectable ECC Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">portid</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_PPIO</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;PIO&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_PDRD</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;DVMA Read&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_PDWR</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;DVMA Write&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)))));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: DOFF[%lx] SIZE[%lx] MID[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">portid</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_DOFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">45UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">42UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_MID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">37UL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: AFAR[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portid</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: Secondary UE errors [&quot;</span><span class="p">,</span> <span class="n">portid</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_SPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(PIO)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_SDRD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DVMA Read)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_UEAFSR_SDWR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DVMA Write)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SYSIO_CE_AFSR	0x0040UL</span>
<span class="cp">#define SYSIO_CE_AFAR	0x0048UL</span>
<span class="cp">#define  SYSIO_CEAFSR_PPIO  0x8000000000000000UL </span><span class="cm">/* Primary PIO cause         */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_PDRD  0x4000000000000000UL </span><span class="cm">/* Primary DVMA read cause   */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_PDWR  0x2000000000000000UL </span><span class="cm">/* Primary DVMA write cause  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_SPIO  0x1000000000000000UL </span><span class="cm">/* Secondary PIO cause       */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_SDRD  0x0800000000000000UL </span><span class="cm">/* Secondary DVMA read cause */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_SDWR  0x0400000000000000UL </span><span class="cm">/* Secondary DVMA write cause*/</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_RESV1 0x0300000000000000UL </span><span class="cm">/* Reserved                  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_ESYND 0x00ff000000000000UL </span><span class="cm">/* Syndrome Bits             */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_DOFF  0x0000e00000000000UL </span><span class="cm">/* Double Offset             */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_SIZE  0x00001c0000000000UL </span><span class="cm">/* Bad transfer size 2^SIZE  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_MID   0x000003e000000000UL </span><span class="cm">/* UPA MID causing the fault */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_CEAFSR_RESV2 0x0000001fffffffffUL </span><span class="cm">/* Reserved                  */</span><span class="cp"></span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sysio_ce_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_base</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span> <span class="o">-</span> <span class="mh">0x2000UL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span><span class="p">,</span> <span class="n">afar_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">,</span> <span class="n">portid</span><span class="p">;</span>

	<span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_CE_AFSR</span><span class="p">;</span>
	<span class="n">afar_reg</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_CE_AFAR</span><span class="p">;</span>

	<span class="cm">/* Latch error status. */</span>
	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>

	<span class="cm">/* Clear primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SYSIO_CEAFSR_PPIO</span> <span class="o">|</span> <span class="n">SYSIO_CEAFSR_PDRD</span> <span class="o">|</span> <span class="n">SYSIO_CEAFSR_PDWR</span> <span class="o">|</span>
		 <span class="n">SYSIO_CEAFSR_SPIO</span> <span class="o">|</span> <span class="n">SYSIO_CEAFSR_SDRD</span> <span class="o">|</span> <span class="n">SYSIO_CEAFSR_SDWR</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="n">portid</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;portid&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: Correctable ECC Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">portid</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_PPIO</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;PIO&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_PDRD</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;DVMA Read&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_PDWR</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;DVMA Write&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)))));</span>

	<span class="cm">/* XXX Use syndrome and afar to print out module string just like</span>
<span class="cm">	 * XXX UDB CE trap handler does... -DaveM</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: DOFF[%lx] ECC Syndrome[%lx] Size[%lx] MID[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">portid</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_DOFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">45UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_ESYND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">48UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">42UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_MID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">37UL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: AFAR[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portid</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: Secondary CE errors [&quot;</span><span class="p">,</span> <span class="n">portid</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_SPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(PIO)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_SDRD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DVMA Read)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_CEAFSR_SDWR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DVMA Write)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SYSIO_SBUS_AFSR		0x2010UL</span>
<span class="cp">#define SYSIO_SBUS_AFAR		0x2018UL</span>
<span class="cp">#define  SYSIO_SBAFSR_PLE   0x8000000000000000UL </span><span class="cm">/* Primary Late PIO Error    */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_PTO   0x4000000000000000UL </span><span class="cm">/* Primary SBUS Timeout      */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_PBERR 0x2000000000000000UL </span><span class="cm">/* Primary SBUS Error ACK    */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_SLE   0x1000000000000000UL </span><span class="cm">/* Secondary Late PIO Error  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_STO   0x0800000000000000UL </span><span class="cm">/* Secondary SBUS Timeout    */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_SBERR 0x0400000000000000UL </span><span class="cm">/* Secondary SBUS Error ACK  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_RESV1 0x03ff000000000000UL </span><span class="cm">/* Reserved                  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_RD    0x0000800000000000UL </span><span class="cm">/* Primary was late PIO read */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_RESV2 0x0000600000000000UL </span><span class="cm">/* Reserved                  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_SIZE  0x00001c0000000000UL </span><span class="cm">/* Size of transfer          */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_MID   0x000003e000000000UL </span><span class="cm">/* MID causing the error     */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_SBAFSR_RESV3 0x0000001fffffffffUL </span><span class="cm">/* Reserved                  */</span><span class="cp"></span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sysio_sbus_error_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span><span class="p">,</span> <span class="n">afar_reg</span><span class="p">,</span> <span class="n">reg_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">,</span> <span class="n">portid</span><span class="p">;</span>

	<span class="n">reg_base</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span> <span class="o">-</span> <span class="mh">0x2000UL</span><span class="p">;</span>
	<span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_SBUS_AFSR</span><span class="p">;</span>
	<span class="n">afar_reg</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">SYSIO_SBUS_AFAR</span><span class="p">;</span>

	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>

	<span class="cm">/* Clear primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SYSIO_SBAFSR_PLE</span> <span class="o">|</span> <span class="n">SYSIO_SBAFSR_PTO</span> <span class="o">|</span> <span class="n">SYSIO_SBAFSR_PBERR</span> <span class="o">|</span>
		 <span class="n">SYSIO_SBAFSR_SLE</span> <span class="o">|</span> <span class="n">SYSIO_SBAFSR_STO</span> <span class="o">|</span> <span class="n">SYSIO_SBAFSR_SBERR</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="n">portid</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;portid&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: SBUS Error, primary error type[%s] read(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">portid</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_PLE</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;Late PIO Error&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_PTO</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;Time Out&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_PBERR</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;Error Ack&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)))),</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_RD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: size[%lx] MID[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">portid</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">42UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_MID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">37UL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: AFAR[%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portid</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: Secondary SBUS errors [&quot;</span><span class="p">,</span> <span class="n">portid</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_SLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Late PIO Error)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_STO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Time Out)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SYSIO_SBAFSR_SBERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Error Ack)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* XXX check iommu/strbuf for further error status XXX */</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ECC_CONTROL	0x0020UL</span>
<span class="cp">#define  SYSIO_ECNTRL_ECCEN	0x8000000000000000UL </span><span class="cm">/* Enable ECC Checking   */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_ECNTRL_UEEN	0x4000000000000000UL </span><span class="cm">/* Enable UE Interrupts  */</span><span class="cp"></span>
<span class="cp">#define  SYSIO_ECNTRL_CEEN	0x2000000000000000UL </span><span class="cm">/* Enable CE Interrupts  */</span><span class="cp"></span>

<span class="cp">#define SYSIO_UE_INO		0x34</span>
<span class="cp">#define SYSIO_CE_INO		0x35</span>
<span class="cp">#define SYSIO_SBUSERR_INO	0x36</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sysio_register_error_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_base</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span> <span class="o">-</span> <span class="mh">0x2000UL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">portid</span><span class="p">;</span>

	<span class="n">portid</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;portid&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">sbus_build_irq</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">SYSIO_UE_INO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sysio_ue_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s">&quot;SYSIO_UE&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: Cannot register UE interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">portid</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">sbus_build_irq</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">SYSIO_CE_INO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sysio_ce_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s">&quot;SYSIO_CE&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: Cannot register CE interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">portid</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">sbus_build_irq</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">SYSIO_SBUSERR_INO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sysio_sbus_error_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s">&quot;SYSIO_SBERR&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;SYSIO[%x]: Cannot register SBUS Error interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">portid</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Now turn the error interrupts on and also enable ECC checking. */</span>
	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SYSIO_ECNTRL_ECCEN</span> <span class="o">|</span>
		    <span class="n">SYSIO_ECNTRL_UEEN</span>  <span class="o">|</span>
		    <span class="n">SYSIO_ECNTRL_CEEN</span><span class="p">),</span>
		   <span class="n">reg_base</span> <span class="o">+</span> <span class="n">ECC_CONTROL</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="mh">0x100UL</span><span class="p">;</span> <span class="cm">/* SBUS Error Interrupt Enable */</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Boot time initialization. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sbus_iommu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_prom64_registers</span> <span class="o">*</span><span class="n">pr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">strbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regs</span><span class="p">,</span> <span class="n">reg_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">portid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">pr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;sbus_iommu_init: Cannot map SYSIO &quot;</span>
			    <span class="s">&quot;control registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">;</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iommu</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fatal_memory_error</span><span class="p">;</span>
	<span class="n">strbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">strbuf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strbuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fatal_memory_error</span><span class="p">;</span>

	<span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">iommu</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">stc</span> <span class="o">=</span> <span class="n">strbuf</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">archdata</span><span class="p">.</span><span class="n">numa_node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">reg_base</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SYSIO_IOMMUREG_BASE</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOMMU_CONTROL</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tsbbase</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOMMU_TSBBASE</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_flush</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOMMU_FLUSH</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tags</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">IOMMU_TAGDIAG</span> <span class="o">-</span> <span class="n">IOMMU_CONTROL</span><span class="p">);</span>

	<span class="n">reg_base</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SYSIO_STRBUFREG_BASE</span><span class="p">;</span>
	<span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">STRBUF_CONTROL</span><span class="p">;</span>
	<span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_pflush</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">STRBUF_PFLUSH</span><span class="p">;</span>
	<span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_fsync</span> <span class="o">=</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">STRBUF_FSYNC</span><span class="p">;</span>

	<span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_flushflag</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">__flushflag_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		  <span class="o">+</span> <span class="mi">63UL</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63UL</span><span class="p">);</span>
	<span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_flushflag_pa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
		<span class="n">__pa</span><span class="p">(</span><span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_flushflag</span><span class="p">);</span>

	<span class="cm">/* The SYSIO SBUS control register is used for dummy reads</span>
<span class="cm">	 * in order to ensure write completion.</span>
<span class="cm">	 */</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="mh">0x2000UL</span><span class="p">;</span>

	<span class="n">portid</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;portid&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SYSIO: UPA portID %x, at %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">portid</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="cm">/* Setup for TSB_SIZE=7, TBW_SIZE=0, MMU_DE=1, MMU_EN=1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iommu_table_init</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">IO_TSB_SIZE</span><span class="p">,</span> <span class="n">MAP_BASE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fatal_memory_error</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="p">((</span><span class="mi">7UL</span> <span class="o">&lt;&lt;</span> <span class="mi">16UL</span><span class="p">)</span>	<span class="o">|</span>
		   <span class="p">(</span><span class="mi">0UL</span> <span class="o">&lt;&lt;</span> <span class="mi">2UL</span><span class="p">)</span>		<span class="o">|</span>
		   <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">1UL</span><span class="p">)</span>		<span class="o">|</span>
		   <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">0UL</span><span class="p">));</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

	<span class="cm">/* Clean out any cruft in the IOMMU using</span>
<span class="cm">	 * diagnostic accesses.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dram</span><span class="p">,</span> <span class="n">tag</span><span class="p">;</span>

		<span class="n">dram</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span> <span class="o">+</span> <span class="p">(</span><span class="n">IOMMU_DRAMDIAG</span> <span class="o">-</span> <span class="n">IOMMU_CONTROL</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span> <span class="o">+</span> <span class="p">(</span><span class="n">IOMMU_TAGDIAG</span> <span class="o">-</span> <span class="n">IOMMU_CONTROL</span><span class="p">);</span>

		<span class="n">dram</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">;</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">;</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dram</span><span class="p">);</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span><span class="p">);</span>

	<span class="cm">/* Give the TSB to SYSIO. */</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table</span><span class="p">),</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tsbbase</span><span class="p">);</span>

	<span class="cm">/* Setup streaming buffer, DE=1 SB_EN=1 */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">1UL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">0UL</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span><span class="p">);</span>

	<span class="cm">/* Clear out the tags using diagnostics. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptag</span><span class="p">,</span> <span class="n">ltag</span><span class="p">;</span>

		<span class="n">ptag</span> <span class="o">=</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">STRBUF_PTAGDIAG</span> <span class="o">-</span> <span class="n">STRBUF_CONTROL</span><span class="p">);</span>
		<span class="n">ltag</span> <span class="o">=</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">STRBUF_LTAGDIAG</span> <span class="o">-</span> <span class="n">STRBUF_CONTROL</span><span class="p">);</span>
		<span class="n">ptag</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">;</span>
		<span class="n">ltag</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">;</span>

		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">ptag</span><span class="p">);</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">ltag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable DVMA arbitration for all devices/slots. */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="mh">0x3fUL</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span><span class="p">);</span>

	<span class="cm">/* Now some Xfire specific grot... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_is_starfire</span><span class="p">)</span>
		<span class="n">starfire_hookup</span><span class="p">(</span><span class="n">portid</span><span class="p">);</span>

	<span class="n">sysio_register_error_handlers</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">fatal_memory_error:</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;sbus_iommu_init: Fatal memory allocation error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sbus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">for_each_node_by_name</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;sbus&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>

		<span class="n">sbus_iommu_init</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
		<span class="n">of_propagate_archdata</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">sbus_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
