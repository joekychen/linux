<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › psycho_common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>psycho_common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* psycho_common.c: Code common to PSYCHO and derivative PCI controllers.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 David S. Miller &lt;davem@davemloft.net&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;asm/upa.h&gt;</span>

<span class="cp">#include &quot;pci_impl.h&quot;</span>
<span class="cp">#include &quot;iommu_common.h&quot;</span>
<span class="cp">#include &quot;psycho_common.h&quot;</span>

<span class="cp">#define  PSYCHO_STRBUF_CTRL_DENAB	0x0000000000000002ULL</span>
<span class="cp">#define  PSYCHO_STCERR_WRITE		0x0000000000000002ULL</span>
<span class="cp">#define  PSYCHO_STCERR_READ		0x0000000000000001ULL</span>
<span class="cp">#define  PSYCHO_STCTAG_PPN		0x0fffffff00000000ULL</span>
<span class="cp">#define  PSYCHO_STCTAG_VPN		0x00000000ffffe000ULL</span>
<span class="cp">#define  PSYCHO_STCTAG_VALID		0x0000000000000002ULL</span>
<span class="cp">#define  PSYCHO_STCTAG_WRITE		0x0000000000000001ULL</span>
<span class="cp">#define  PSYCHO_STCLINE_LINDX		0x0000000001e00000ULL</span>
<span class="cp">#define  PSYCHO_STCLINE_SPTR		0x00000000001f8000ULL</span>
<span class="cp">#define  PSYCHO_STCLINE_LADDR		0x0000000000007f00ULL</span>
<span class="cp">#define  PSYCHO_STCLINE_EPTR		0x00000000000000fcULL</span>
<span class="cp">#define  PSYCHO_STCLINE_VALID		0x0000000000000002ULL</span>
<span class="cp">#define  PSYCHO_STCLINE_FOFN		0x0000000000000001ULL</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">stc_buf_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stc_error_buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stc_tag_buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stc_line_buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psycho_check_stc_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err_base</span><span class="p">,</span> <span class="n">tag_base</span><span class="p">,</span> <span class="n">line_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">strbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err_base</span> <span class="o">=</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_err_stat</span><span class="p">;</span>
	<span class="n">tag_base</span> <span class="o">=</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_tag_diag</span><span class="p">;</span>
	<span class="n">line_base</span> <span class="o">=</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_line_diag</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stc_buf_lock</span><span class="p">);</span>

	<span class="cm">/* This is __REALLY__ dangerous.  When we put the streaming</span>
<span class="cm">	 * buffer into diagnostic mode to probe it&#39;s tags and error</span>
<span class="cm">	 * status, we _must_ clear all of the line tag valid bits</span>
<span class="cm">	 * before re-enabling the streaming buffer.  If any dirty data</span>
<span class="cm">	 * lives in the STC when we do this, we will end up</span>
<span class="cm">	 * invalidating it before it has a chance to reach main</span>
<span class="cm">	 * memory.</span>
<span class="cm">	 */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span> <span class="o">|</span> <span class="n">PSYCHO_STRBUF_CTRL_DENAB</span><span class="p">,</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">err_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">err_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">stc_error_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stc_tag_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">tag_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">stc_line_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">line_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">tag_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">line_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* OK, state is logged, exit diagnostic mode. */</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">saw_error</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

		<span class="n">saw_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">errval</span> <span class="o">=</span> <span class="n">stc_error_buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">saw_error</span><span class="o">++</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: STC_ERR(%d)[wr(%d)&quot;</span>
				       <span class="s">&quot;rd(%d)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">j</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">errval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCERR_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">errval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCERR_READ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saw_error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">tagval</span> <span class="o">=</span> <span class="n">stc_tag_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">u64</span> <span class="n">lineval</span> <span class="o">=</span> <span class="n">stc_line_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: STC_TAG(%d)[PA(%016llx)VA(%08llx)&quot;</span>
			       <span class="s">&quot;V(%d)W(%d)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">tagval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCTAG_PPN</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">19UL</span><span class="p">),</span>
			       <span class="p">(</span><span class="n">tagval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCTAG_VPN</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">tagval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCTAG_VALID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">tagval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCTAG_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: STC_LINE(%d)[LIDX(%llx)SP(%llx)&quot;</span>
			       <span class="s">&quot;LADDR(%llx)EP(%llx)V(%d)FOFN(%d)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCLINE_LINDX</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">21UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCLINE_SPTR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCLINE_LADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCLINE_EPTR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCLINE_VALID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">PSYCHO_STCLINE_FOFN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stc_buf_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PSYCHO_IOMMU_TAG		0xa580UL</span>
<span class="cp">#define PSYCHO_IOMMU_DATA		0xa600UL</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psycho_record_iommu_tags_and_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
					      <span class="n">u64</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">;</span>

		<span class="n">tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_TAG</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_DATA</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>

		<span class="cm">/* Now clear out the entry. */</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_TAG</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_DATA</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define  PSYCHO_IOMMU_TAG_ERRSTS (0x3UL &lt;&lt; 23UL)</span>
<span class="cp">#define  PSYCHO_IOMMU_TAG_ERR	 (0x1UL &lt;&lt; 22UL)</span>
<span class="cp">#define  PSYCHO_IOMMU_TAG_WRITE	 (0x1UL &lt;&lt; 21UL)</span>
<span class="cp">#define  PSYCHO_IOMMU_TAG_STREAM (0x1UL &lt;&lt; 20UL)</span>
<span class="cp">#define  PSYCHO_IOMMU_TAG_SIZE	 (0x1UL &lt;&lt; 19UL)</span>
<span class="cp">#define  PSYCHO_IOMMU_TAG_VPAGE	 0x7ffffULL</span>
<span class="cp">#define  PSYCHO_IOMMU_DATA_VALID (1UL &lt;&lt; 30UL)</span>
<span class="cp">#define  PSYCHO_IOMMU_DATA_CACHE (1UL &lt;&lt; 28UL)</span>
<span class="cp">#define  PSYCHO_IOMMU_DATA_PPAGE 0xfffffffULL</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psycho_dump_iommu_tags_and_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
					    <span class="n">u64</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tag_val</span><span class="p">,</span> <span class="n">data_val</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_str</span><span class="p">;</span>
		<span class="n">tag_val</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tag_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_TAG_ERR</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">data_val</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">switch</span><span class="p">((</span><span class="n">tag_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_TAG_ERRSTS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">23UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;Protection Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;Invalid Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;TimeOut Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="nl">default:</span>
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;ECC Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: IOMMU TAG(%d)[error(%s) wr(%d) &quot;</span>
		       <span class="s">&quot;str(%d) sz(%dK) vpg(%08llx)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">type_str</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">tag_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_TAG_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="p">((</span><span class="n">tag_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_TAG_STREAM</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="p">((</span><span class="n">tag_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_TAG_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">8</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">tag_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_TAG_VPAGE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IOMMU_PAGE_SHIFT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: IOMMU DATA(%d)[valid(%d) cache(%d) &quot;</span>
		       <span class="s">&quot;ppg(%016llx)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">data_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_DATA_VALID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="p">((</span><span class="n">data_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_DATA_CACHE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">data_val</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_DATA_PPAGE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IOMMU_PAGE_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define  PSYCHO_IOMMU_CTRL_XLTESTAT	0x0000000006000000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_XLTEERR	0x0000000001000000UL</span>

<span class="kt">void</span> <span class="nf">psycho_check_iommu_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">psycho_error_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">,</span> <span class="n">iommu_tag</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">iommu_data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_CTRL_XLTEERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_str</span><span class="p">;</span>

		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSYCHO_IOMMU_CTRL_XLTEERR</span><span class="p">;</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PSYCHO_IOMMU_CTRL_XLTESTAT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;Protection Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;Invalid Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;TimeOut Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="nl">default:</span>
			<span class="n">type_str</span> <span class="o">=</span> <span class="s">&quot;ECC Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: IOMMU Error, type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type_str</span><span class="p">);</span>

		<span class="cm">/* It is very possible for another DVMA to occur while</span>
<span class="cm">		 * we do this probe, and corrupt the system further.</span>
<span class="cm">		 * But we are so screwed at this point that we are</span>
<span class="cm">		 * likely to crash hard anyways, so get as much</span>
<span class="cm">		 * diagnostic information to the console as we can.</span>
<span class="cm">		 */</span>
		<span class="n">psycho_record_iommu_tags_and_data</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">iommu_tag</span><span class="p">,</span> <span class="n">iommu_data</span><span class="p">);</span>
		<span class="n">psycho_dump_iommu_tags_and_data</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">iommu_tag</span><span class="p">,</span> <span class="n">iommu_data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">psycho_check_stc_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define  PSYCHO_PCICTRL_SBH_ERR	 0x0000000800000000UL</span>
<span class="cp">#define  PSYCHO_PCICTRL_SERR	 0x0000000400000000UL</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">psycho_pcierr_intr_other</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">csr</span><span class="p">,</span> <span class="n">csr_error_bits</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">stat</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_csr</span><span class="p">);</span>
	<span class="n">csr_error_bits</span> <span class="o">=</span> <span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSYCHO_PCICTRL_SBH_ERR</span> <span class="o">|</span> <span class="n">PSYCHO_PCICTRL_SERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear the errors.  */</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_csr</span><span class="p">);</span>

		<span class="cm">/* Log &#39;em.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCICTRL_SBH_ERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: PCI streaming byte hole &quot;</span>
			       <span class="s">&quot;error asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCICTRL_SERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: PCI SERR signal asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">psycho_pci_config_mkaddr</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_first_busno</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">);</span>
	<span class="n">pci_config_read16</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_STATUS_PARITY</span> <span class="o">|</span>
		    <span class="n">PCI_STATUS_SIG_TARGET_ABORT</span> <span class="o">|</span>
		    <span class="n">PCI_STATUS_REC_TARGET_ABORT</span> <span class="o">|</span>
		    <span class="n">PCI_STATUS_REC_MASTER_ABORT</span> <span class="o">|</span>
		    <span class="n">PCI_STATUS_SIG_SYSTEM_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: PCI bus error, PCI_STATUS[%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">pci_config_write16</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define  PSYCHO_PCIAFSR_PMA	0x8000000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_PTA	0x4000000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_PRTRY	0x2000000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_PPERR	0x1000000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_SMA	0x0800000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_STA	0x0400000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_SRTRY	0x0200000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_SPERR	0x0100000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_RESV1	0x00ff000000000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_BMSK	0x0000ffff00000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_BLK	0x0000000080000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_RESV2	0x0000000040000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_MID	0x000000003e000000ULL</span>
<span class="cp">#define  PSYCHO_PCIAFSR_RESV3	0x0000000001ffffffULL</span>

<span class="n">irqreturn_t</span> <span class="nf">psycho_pcierr_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">;</span>

	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afsr</span><span class="p">);</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afar</span><span class="p">);</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">PSYCHO_PCIAFSR_PMA</span> <span class="o">|</span> <span class="n">PSYCHO_PCIAFSR_PTA</span> <span class="o">|</span>
		 <span class="n">PSYCHO_PCIAFSR_PRTRY</span> <span class="o">|</span> <span class="n">PSYCHO_PCIAFSR_PPERR</span> <span class="o">|</span>
		 <span class="n">PSYCHO_PCIAFSR_SMA</span> <span class="o">|</span> <span class="n">PSYCHO_PCIAFSR_STA</span> <span class="o">|</span>
		 <span class="n">PSYCHO_PCIAFSR_SRTRY</span> <span class="o">|</span> <span class="n">PSYCHO_PCIAFSR_SPERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">psycho_pcierr_intr_other</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afsr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: PCI Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_PMA</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;Master Abort&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_PTA</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;Target Abort&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_PRTRY</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;Excessive Retries&quot;</span> <span class="o">:</span>
		   <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_PPERR</span><span class="p">)</span> <span class="o">?</span>
		    <span class="s">&quot;Parity Error&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">))))));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: bytemask[%04llx] UPA_MID[%02llx] was_block(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_BMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_MID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_BLK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: PCI AFAR [%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: PCI Secondary errors [&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_SMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Master Abort)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_STA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Target Abort)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_SRTRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Excessive Retries)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_PCIAFSR_SPERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Parity Error)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSYCHO_PCIAFSR_PTA</span> <span class="o">|</span> <span class="n">PSYCHO_PCIAFSR_STA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psycho_check_iommu_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">PCI_ERR</span><span class="p">);</span>
		<span class="n">pci_scan_for_target_abort</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSYCHO_PCIAFSR_PMA</span> <span class="o">|</span> <span class="n">PSYCHO_PCIAFSR_SMA</span><span class="p">))</span>
		<span class="n">pci_scan_for_master_abort</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSYCHO_PCIAFSR_PPERR</span> <span class="o">|</span> <span class="n">PSYCHO_PCIAFSR_SPERR</span><span class="p">))</span>
		<span class="n">pci_scan_for_parity_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psycho_iommu_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_TAG</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_DATA</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define PSYCHO_IOMMU_CONTROL		0x0200UL</span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_TSBSZ	0x0000000000070000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_1K      	0x0000000000000000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_2K      	0x0000000000010000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_4K      	0x0000000000020000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_8K      	0x0000000000030000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_16K     	0x0000000000040000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_32K     	0x0000000000050000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_64K     	0x0000000000060000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_128K    	0x0000000000070000UL</span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_TBWSZ    	0x0000000000000004UL</span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_DENAB    	0x0000000000000002UL</span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_ENAB     	0x0000000000000001UL</span>
<span class="cp">#define PSYCHO_IOMMU_FLUSH		0x0210UL</span>
<span class="cp">#define PSYCHO_IOMMU_TSBBASE		0x0208UL</span>

<span class="kt">int</span> <span class="nf">psycho_iommu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tsbsize</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">dvma_offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_mask</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">write_complete_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span>  <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_CONTROL</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tsbbase</span>  <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_TSBBASE</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_flush</span>    <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_FLUSH</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tags</span>     <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_IOMMU_TAG</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span>
				     <span class="n">write_complete_offset</span><span class="p">);</span>

	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_ctxflush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">PSYCHO_IOMMU_CTRL_DENAB</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

	<span class="n">psycho_iommu_flush</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="cm">/* Leave diag mode enabled for full-flushing done in pci_iommu.c */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">iommu_table_init</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">tsbsize</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
			       <span class="n">dvma_offset</span><span class="p">,</span> <span class="n">dma_mask</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">numa_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table</span><span class="p">),</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tsbbase</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSYCHO_IOMMU_CTRL_TSBSZ</span> <span class="o">|</span> <span class="n">PSYCHO_IOMMU_CTRL_TBWSZ</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">PSYCHO_IOMMU_CTRL_ENAB</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tsbsize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">control</span> <span class="o">|=</span> <span class="n">PSYCHO_IOMMU_TSBSZ_64K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">control</span> <span class="o">|=</span> <span class="n">PSYCHO_IOMMU_TSBSZ_128K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psycho_pbm_init_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chip_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">numa_node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">chip_type</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_version</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;version#&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;module-revision#&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sun4u_pci_ops</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">config_space_reg_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">pci_num_pbms</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pci_get_pbm_props</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="n">pci_determine_mem_io_space</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s PCI Bus Module ver[%x:%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip_name</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_version</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_revision</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
