<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › pci_schizo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci_schizo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* pci_schizo.c: SCHIZO/TOMATILLO specific PCI controller support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001, 2002, 2003, 2007, 2008 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/pstate.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/upa.h&gt;</span>

<span class="cp">#include &quot;pci_impl.h&quot;</span>
<span class="cp">#include &quot;iommu_common.h&quot;</span>

<span class="cp">#define DRIVER_NAME	&quot;schizo&quot;</span>
<span class="cp">#define PFX		DRIVER_NAME &quot;: &quot;</span>

<span class="cm">/* This is a convention that at least Excalibur and Merlin</span>
<span class="cm"> * follow.  I suppose the SCHIZO used in Starcat and friends</span>
<span class="cm"> * will do similar.</span>
<span class="cm"> *</span>
<span class="cm"> * The only way I could see this changing is if the newlink</span>
<span class="cm"> * block requires more space in Schizo&#39;s address space than</span>
<span class="cm"> * they predicted, thus requiring an address space reorg when</span>
<span class="cm"> * the newer Schizo is taped out.</span>
<span class="cm"> */</span>

<span class="cm">/* Streaming buffer control register. */</span>
<span class="cp">#define SCHIZO_STRBUF_CTRL_LPTR    0x00000000000000f0UL </span><span class="cm">/* LRU Lock Pointer */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_STRBUF_CTRL_LENAB   0x0000000000000008UL </span><span class="cm">/* LRU Lock Enable */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_STRBUF_CTRL_RRDIS   0x0000000000000004UL </span><span class="cm">/* Rerun Disable */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_STRBUF_CTRL_DENAB   0x0000000000000002UL </span><span class="cm">/* Diagnostic Mode Enable */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_STRBUF_CTRL_ENAB    0x0000000000000001UL </span><span class="cm">/* Streaming Buffer Enable */</span><span class="cp"></span>

<span class="cm">/* IOMMU control register. */</span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_RESV     0xfffffffff9000000UL </span><span class="cm">/* Reserved                      */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_XLTESTAT 0x0000000006000000UL </span><span class="cm">/* Translation Error Status      */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_XLTEERR  0x0000000001000000UL </span><span class="cm">/* Translation Error encountered */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_LCKEN    0x0000000000800000UL </span><span class="cm">/* Enable translation locking    */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_LCKPTR   0x0000000000780000UL </span><span class="cm">/* Translation lock pointer      */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_TSBSZ    0x0000000000070000UL </span><span class="cm">/* TSB Size                      */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_TSBSZ_1K      0x0000000000000000UL </span><span class="cm">/* TSB Table 1024 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_TSBSZ_2K      0x0000000000010000UL </span><span class="cm">/* TSB Table 2048 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_TSBSZ_4K      0x0000000000020000UL </span><span class="cm">/* TSB Table 4096 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_TSBSZ_8K      0x0000000000030000UL </span><span class="cm">/* TSB Table 8192 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_TSBSZ_16K     0x0000000000040000UL </span><span class="cm">/* TSB Table 16k 8-byte entries  */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_TSBSZ_32K     0x0000000000050000UL </span><span class="cm">/* TSB Table 32k 8-byte entries  */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_TSBSZ_64K     0x0000000000060000UL </span><span class="cm">/* TSB Table 64k 8-byte entries  */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_TSBSZ_128K    0x0000000000070000UL </span><span class="cm">/* TSB Table 128k 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_RESV2    0x000000000000fff8UL </span><span class="cm">/* Reserved                      */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_TBWSZ    0x0000000000000004UL </span><span class="cm">/* Assumed page size, 0=8k 1=64k */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_DENAB    0x0000000000000002UL </span><span class="cm">/* Diagnostic mode enable        */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_IOMMU_CTRL_ENAB     0x0000000000000001UL </span><span class="cm">/* IOMMU Enable                  */</span><span class="cp"></span>

<span class="cm">/* Schizo config space address format is nearly identical to</span>
<span class="cm"> * that of PSYCHO:</span>
<span class="cm"> *</span>
<span class="cm"> *  32             24 23 16 15    11 10       8 7   2  1 0</span>
<span class="cm"> * ---------------------------------------------------------</span>
<span class="cm"> * |0 0 0 0 0 0 0 0 0| bus | device | function | reg | 0 0 |</span>
<span class="cm"> * ---------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="cp">#define SCHIZO_CONFIG_BASE(PBM)	((PBM)-&gt;config_space)</span>
<span class="cp">#define SCHIZO_CONFIG_ENCODE(BUS, DEVFN, REG)	\</span>
<span class="cp">	(((unsigned long)(BUS)   &lt;&lt; 16) |	\</span>
<span class="cp">	 ((unsigned long)(DEVFN) &lt;&lt; 8)  |	\</span>
<span class="cp">	 ((unsigned long)(REG)))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">schizo_pci_config_mkaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbm</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bus</span> <span class="o">-=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_first_busno</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">SCHIZO_CONFIG_BASE</span><span class="p">(</span><span class="n">pbm</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">SCHIZO_CONFIG_ENCODE</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* SCHIZO error handling support. */</span>
<span class="k">enum</span> <span class="n">schizo_error_type</span> <span class="p">{</span>
	<span class="n">UE_ERR</span><span class="p">,</span> <span class="n">CE_ERR</span><span class="p">,</span> <span class="n">PCI_ERR</span><span class="p">,</span> <span class="n">SAFARI_ERR</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">stc_buf_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stc_error_buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stc_tag_buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stc_line_buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="cp">#define SCHIZO_UE_INO		0x30 </span><span class="cm">/* Uncorrectable ECC error */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_CE_INO		0x31 </span><span class="cm">/* Correctable ECC error */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIERR_A_INO	0x32 </span><span class="cm">/* PBM A PCI bus error */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIERR_B_INO	0x33 </span><span class="cm">/* PBM B PCI bus error */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_SERR_INO		0x34 </span><span class="cm">/* Safari interface error */</span><span class="cp"></span>

<span class="cp">#define SCHIZO_STC_ERR	0xb800UL </span><span class="cm">/* --&gt; 0xba00 */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_STC_TAG	0xba00UL </span><span class="cm">/* --&gt; 0xba80 */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_STC_LINE	0xbb00UL </span><span class="cm">/* --&gt; 0xbb80 */</span><span class="cp"></span>

<span class="cp">#define SCHIZO_STCERR_WRITE	0x2UL</span>
<span class="cp">#define SCHIZO_STCERR_READ	0x1UL</span>

<span class="cp">#define SCHIZO_STCTAG_PPN	0x3fffffff00000000UL</span>
<span class="cp">#define SCHIZO_STCTAG_VPN	0x00000000ffffe000UL</span>
<span class="cp">#define SCHIZO_STCTAG_VALID	0x8000000000000000UL</span>
<span class="cp">#define SCHIZO_STCTAG_READ	0x4000000000000000UL</span>

<span class="cp">#define SCHIZO_STCLINE_LINDX	0x0000000007800000UL</span>
<span class="cp">#define SCHIZO_STCLINE_SPTR	0x000000000007e000UL</span>
<span class="cp">#define SCHIZO_STCLINE_LADDR	0x0000000000001fc0UL</span>
<span class="cp">#define SCHIZO_STCLINE_EPTR	0x000000000000003fUL</span>
<span class="cp">#define SCHIZO_STCLINE_VALID	0x0000000000600000UL</span>
<span class="cp">#define SCHIZO_STCLINE_FOFN	0x0000000000180000UL</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__schizo_check_stc_error_pbm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">schizo_error_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">strbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regbase</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err_base</span><span class="p">,</span> <span class="n">tag_base</span><span class="p">,</span> <span class="n">line_base</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err_base</span> <span class="o">=</span> <span class="n">regbase</span> <span class="o">+</span> <span class="n">SCHIZO_STC_ERR</span><span class="p">;</span>
	<span class="n">tag_base</span> <span class="o">=</span> <span class="n">regbase</span> <span class="o">+</span> <span class="n">SCHIZO_STC_TAG</span><span class="p">;</span>
	<span class="n">line_base</span> <span class="o">=</span> <span class="n">regbase</span> <span class="o">+</span> <span class="n">SCHIZO_STC_LINE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stc_buf_lock</span><span class="p">);</span>

	<span class="cm">/* This is __REALLY__ dangerous.  When we put the</span>
<span class="cm">	 * streaming buffer into diagnostic mode to probe</span>
<span class="cm">	 * it&#39;s tags and error status, we _must_ clear all</span>
<span class="cm">	 * of the line tag valid bits before re-enabling</span>
<span class="cm">	 * the streaming buffer.  If any dirty data lives</span>
<span class="cm">	 * in the STC when we do this, we will end up</span>
<span class="cm">	 * invalidating it before it has a chance to reach</span>
<span class="cm">	 * main memory.</span>
<span class="cm">	 */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">control</span> <span class="o">|</span> <span class="n">SCHIZO_STRBUF_CTRL_DENAB</span><span class="p">),</span>
		   <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">err_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">err_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">stc_error_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stc_tag_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">tag_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">stc_line_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">line_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">tag_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">line_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* OK, state is logged, exit diagnostic mode. */</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">strbuf</span><span class="o">-&gt;</span><span class="n">strbuf_control</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">saw_error</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

		<span class="n">saw_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">errval</span> <span class="o">=</span> <span class="n">stc_error_buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">saw_error</span><span class="o">++</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: STC_ERR(%d)[wr(%d)rd(%d)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">j</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">errval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCERR_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">errval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCERR_READ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saw_error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tagval</span> <span class="o">=</span> <span class="n">stc_tag_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lineval</span> <span class="o">=</span> <span class="n">stc_line_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: STC_TAG(%d)[PA(%016lx)VA(%08lx)V(%d)R(%d)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">tagval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCTAG_PPN</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">19UL</span><span class="p">),</span>
			       <span class="p">(</span><span class="n">tagval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCTAG_VPN</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">tagval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCTAG_VALID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">tagval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCTAG_READ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

			<span class="cm">/* XXX Should spit out per-bank error information... -DaveM */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: STC_LINE(%d)[LIDX(%lx)SP(%lx)LADDR(%lx)EP(%lx)&quot;</span>
			       <span class="s">&quot;V(%d)FOFN(%d)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCLINE_LINDX</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">23UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCLINE_SPTR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCLINE_LADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCLINE_EPTR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCLINE_VALID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">lineval</span> <span class="o">&amp;</span> <span class="n">SCHIZO_STCLINE_FOFN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stc_buf_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* IOMMU is per-PBM in Schizo, so interrogate both for anonymous</span>
<span class="cm"> * controller level errors.</span>
<span class="cm"> */</span>

<span class="cp">#define SCHIZO_IOMMU_TAG	0xa580UL</span>
<span class="cp">#define SCHIZO_IOMMU_DATA	0xa600UL</span>

<span class="cp">#define SCHIZO_IOMMU_TAG_CTXT	0x0000001ffe000000UL</span>
<span class="cp">#define SCHIZO_IOMMU_TAG_ERRSTS	0x0000000001800000UL</span>
<span class="cp">#define SCHIZO_IOMMU_TAG_ERR	0x0000000000400000UL</span>
<span class="cp">#define SCHIZO_IOMMU_TAG_WRITE	0x0000000000200000UL</span>
<span class="cp">#define SCHIZO_IOMMU_TAG_STREAM	0x0000000000100000UL</span>
<span class="cp">#define SCHIZO_IOMMU_TAG_SIZE	0x0000000000080000UL</span>
<span class="cp">#define SCHIZO_IOMMU_TAG_VPAGE	0x000000000007ffffUL</span>

<span class="cp">#define SCHIZO_IOMMU_DATA_VALID	0x0000000100000000UL</span>
<span class="cp">#define SCHIZO_IOMMU_DATA_CACHE	0x0000000040000000UL</span>
<span class="cp">#define SCHIZO_IOMMU_DATA_PPAGE	0x000000003fffffffUL</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schizo_check_iommu_error_pbm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">schizo_error_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iommu_tag</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iommu_data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_CTRL_XLTEERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">type_string</span><span class="p">;</span>

		<span class="cm">/* Clear the error encountered bit. */</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCHIZO_IOMMU_CTRL_XLTEERR</span><span class="p">;</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

		<span class="k">switch</span><span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_CTRL_XLTESTAT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;Protection Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;Invalid Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;TimeOut Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="nl">default:</span>
			<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;ECC Error&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: IOMMU Error, type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type_string</span><span class="p">);</span>

		<span class="cm">/* Put the IOMMU into diagnostic mode and probe</span>
<span class="cm">		 * it&#39;s TLB for entries with error status.</span>
<span class="cm">		 *</span>
<span class="cm">		 * It is very possible for another DVMA to occur</span>
<span class="cm">		 * while we do this probe, and corrupt the system</span>
<span class="cm">		 * further.  But we are so screwed at this point</span>
<span class="cm">		 * that we are likely to crash hard anyways, so</span>
<span class="cm">		 * get as much diagnostic information to the</span>
<span class="cm">		 * console as we can.</span>
<span class="cm">		 */</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span> <span class="o">|</span> <span class="n">SCHIZO_IOMMU_CTRL_DENAB</span><span class="p">,</span>
			   <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

		<span class="n">base</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iommu_tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">upa_readq</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_IOMMU_TAG</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
			<span class="n">iommu_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">upa_readq</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_IOMMU_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>

			<span class="cm">/* Now clear out the entry. */</span>
			<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_IOMMU_TAG</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
			<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_IOMMU_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Leave diagnostic mode. */</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">tag</span> <span class="o">=</span> <span class="n">iommu_tag</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_TAG_ERR</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">iommu_data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">switch</span><span class="p">((</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_TAG_ERRSTS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">23UL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;Protection Error&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;Invalid Error&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;TimeOut Error&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
			<span class="nl">default:</span>
				<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;ECC Error&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: IOMMU TAG(%d)[error(%s) ctx(%x) wr(%d) str(%d) &quot;</span>
			       <span class="s">&quot;sz(%dK) vpg(%08lx)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">type_string</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_TAG_CTXT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25UL</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_TAG_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_TAG_STREAM</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_TAG_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">8</span><span class="p">),</span>
			       <span class="p">(</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_TAG_VPAGE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IOMMU_PAGE_SHIFT</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: IOMMU DATA(%d)[valid(%d) cache(%d) ppg(%016lx)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_DATA_VALID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_DATA_CACHE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SCHIZO_IOMMU_DATA_PPAGE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IOMMU_PAGE_SHIFT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_enabled</span><span class="p">)</span>
		<span class="n">__schizo_check_stc_error_pbm</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schizo_check_iommu_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">schizo_error_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schizo_check_iommu_error_pbm</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
		<span class="n">schizo_check_iommu_error_pbm</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Uncorrectable ECC error status gathering. */</span>
<span class="cp">#define SCHIZO_UE_AFSR	0x10030UL</span>
<span class="cp">#define SCHIZO_UE_AFAR	0x10038UL</span>

<span class="cp">#define SCHIZO_UEAFSR_PPIO	0x8000000000000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_PDRD	0x4000000000000000UL </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_PDWR	0x2000000000000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_SPIO	0x1000000000000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_SDMA	0x0800000000000000UL </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_ERRPNDG	0x0300000000000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_BMSK	0x000003ff00000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_QOFF	0x00000000c0000000UL </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_AID	0x000000001f000000UL </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_PARTIAL	0x0000000000800000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_OWNEDIN	0x0000000000400000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_MTAGSYND	0x00000000000f0000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_MTAG	0x000000000000e000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_UEAFSR_ECCSYND	0x00000000000001ffUL </span><span class="cm">/* Safari */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">schizo_ue_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_UE_AFSR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_UE_AFAR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>

	<span class="cm">/* Latch uncorrectable error status. */</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>

	<span class="cm">/* If either of the error pending bits are set in the</span>
<span class="cm">	 * AFSR, the error status is being actively updated by</span>
<span class="cm">	 * the hardware and we must re-read to get a clean value.</span>
<span class="cm">	 */</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_ERRPNDG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">limit</span><span class="p">);</span>

	<span class="cm">/* Clear the primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SCHIZO_UEAFSR_PPIO</span> <span class="o">|</span> <span class="n">SCHIZO_UEAFSR_PDRD</span> <span class="o">|</span> <span class="n">SCHIZO_UEAFSR_PDWR</span> <span class="o">|</span>
		 <span class="n">SCHIZO_UEAFSR_SPIO</span> <span class="o">|</span> <span class="n">SCHIZO_UEAFSR_SDMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Uncorrectable Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_PPIO</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;PIO&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_PDRD</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;DMA Read&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_PDWR</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;DMA Write&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)))));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bytemask[%04lx] qword_offset[%lx] SAFARI_AID[%02lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_BMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_QOFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">30UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_AID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24UL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: partial[%d] owned_in[%d] mtag[%lx] mtag_synd[%lx] ecc_sync[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_PARTIAL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_OWNEDIN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_MTAG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_MTAGSYND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_ECCSYND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0UL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: UE AFAR [%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: UE Secondary errors [&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_SPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(PIO)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_SDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Interrogate IOMMU for error status. */</span>
	<span class="n">schizo_check_iommu_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">UE_ERR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCHIZO_CE_AFSR	0x10040UL</span>
<span class="cp">#define SCHIZO_CE_AFAR	0x10048UL</span>

<span class="cp">#define SCHIZO_CEAFSR_PPIO	0x8000000000000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_PDRD	0x4000000000000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_PDWR	0x2000000000000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_SPIO	0x1000000000000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_SDMA	0x0800000000000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_ERRPNDG	0x0300000000000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_BMSK	0x000003ff00000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_QOFF	0x00000000c0000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_AID	0x000000001f000000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_PARTIAL	0x0000000000800000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_OWNEDIN	0x0000000000400000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_MTAGSYND	0x00000000000f0000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_MTAG	0x000000000000e000UL</span>
<span class="cp">#define SCHIZO_CEAFSR_ECCSYND	0x00000000000001ffUL</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">schizo_ce_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_CE_AFSR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_CE_AFAR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>

	<span class="cm">/* Latch error status. */</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>

	<span class="cm">/* If either of the error pending bits are set in the</span>
<span class="cm">	 * AFSR, the error status is being actively updated by</span>
<span class="cm">	 * the hardware and we must re-read to get a clean value.</span>
<span class="cm">	 */</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_ERRPNDG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">limit</span><span class="p">);</span>

	<span class="cm">/* Clear primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SCHIZO_CEAFSR_PPIO</span> <span class="o">|</span> <span class="n">SCHIZO_CEAFSR_PDRD</span> <span class="o">|</span> <span class="n">SCHIZO_CEAFSR_PDWR</span> <span class="o">|</span>
		 <span class="n">SCHIZO_CEAFSR_SPIO</span> <span class="o">|</span> <span class="n">SCHIZO_CEAFSR_SDMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Correctable Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_CEAFSR_PPIO</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;PIO&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_CEAFSR_PDRD</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;DMA Read&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_CEAFSR_PDWR</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;DMA Write&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)))));</span>

	<span class="cm">/* XXX Use syndrome and afar to print out module string just like</span>
<span class="cm">	 * XXX UDB CE trap handler does... -DaveM</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bytemask[%04lx] qword_offset[%lx] SAFARI_AID[%02lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_BMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_QOFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">30UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_AID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24UL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: partial[%d] owned_in[%d] mtag[%lx] mtag_synd[%lx] ecc_sync[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_PARTIAL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_OWNEDIN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_MTAG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_MTAGSYND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_UEAFSR_ECCSYND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0UL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: CE AFAR [%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: CE Secondary errors [&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_CEAFSR_SPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(PIO)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_CEAFSR_SDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCHIZO_PCI_AFSR	0x2010UL</span>
<span class="cp">#define SCHIZO_PCI_AFAR	0x2018UL</span>

<span class="cp">#define SCHIZO_PCIAFSR_PMA	0x8000000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_PTA	0x4000000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_PRTRY	0x2000000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_PPERR	0x1000000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_PTTO	0x0800000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_PUNUS	0x0400000000000000UL </span><span class="cm">/* Schizo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_SMA	0x0200000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_STA	0x0100000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_SRTRY	0x0080000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_SPERR	0x0040000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_STTO	0x0020000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_SUNUS	0x0010000000000000UL </span><span class="cm">/* Schizo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_BMSK	0x000003ff00000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_BLK	0x0000000080000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_CFG	0x0000000040000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_MEM	0x0000000020000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCIAFSR_IO	0x0000000010000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>

<span class="cp">#define SCHIZO_PCI_CTRL		(0x2000UL)</span>
<span class="cp">#define SCHIZO_PCICTRL_BUS_UNUS	(1UL &lt;&lt; 63UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_DTO_INT	(1UL &lt;&lt; 61UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_ARB_PRIO (0x1ff &lt;&lt; 52UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_ESLCK	(1UL &lt;&lt; 51UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_ERRSLOT	(7UL &lt;&lt; 48UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_TTO_ERR	(1UL &lt;&lt; 38UL) </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_RTRY_ERR	(1UL &lt;&lt; 37UL) </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_DTO_ERR	(1UL &lt;&lt; 36UL) </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_SBH_ERR	(1UL &lt;&lt; 35UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_SERR	(1UL &lt;&lt; 34UL) </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_PCISPD	(1UL &lt;&lt; 33UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_MRM_PREF	(1UL &lt;&lt; 30UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_RDO_PREF	(1UL &lt;&lt; 29UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_RDL_PREF	(1UL &lt;&lt; 28UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_PTO	(3UL &lt;&lt; 24UL) </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_PTO_SHIFT 24UL</span>
<span class="cp">#define SCHIZO_PCICTRL_TRWSW	(7UL &lt;&lt; 21UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_F_TGT_A	(1UL &lt;&lt; 20UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_S_DTO_INT (1UL &lt;&lt; 19UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_F_TGT_RT	(1UL &lt;&lt; 19UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_SBH_INT	(1UL &lt;&lt; 18UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_T_DTO_INT (1UL &lt;&lt; 18UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_EEN	(1UL &lt;&lt; 17UL) </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_PARK	(1UL &lt;&lt; 16UL) </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_PCIRST	(1UL &lt;&lt;  8UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_ARB_S	(0x3fUL &lt;&lt; 0UL) </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define SCHIZO_PCICTRL_ARB_T	(0xffUL &lt;&lt; 0UL) </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">schizo_pcierr_intr_other</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">csr_reg</span><span class="p">,</span> <span class="n">csr</span><span class="p">,</span> <span class="n">csr_error_bits</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">csr_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_CTRL</span><span class="p">;</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">csr_reg</span><span class="p">);</span>
	<span class="n">csr_error_bits</span> <span class="o">=</span>
		<span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHIZO_PCICTRL_BUS_UNUS</span> <span class="o">|</span>
		       <span class="n">SCHIZO_PCICTRL_TTO_ERR</span> <span class="o">|</span>
		       <span class="n">SCHIZO_PCICTRL_RTRY_ERR</span> <span class="o">|</span>
		       <span class="n">SCHIZO_PCICTRL_DTO_ERR</span> <span class="o">|</span>
		       <span class="n">SCHIZO_PCICTRL_SBH_ERR</span> <span class="o">|</span>
		       <span class="n">SCHIZO_PCICTRL_SERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear the errors.  */</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">csr_reg</span><span class="p">);</span>

		<span class="cm">/* Log &#39;em.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCICTRL_BUS_UNUS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Bus unusable error asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCICTRL_TTO_ERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI TRDY# timeout error asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCICTRL_RTRY_ERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI excessive retry error asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCICTRL_DTO_ERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI discard timeout error asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCICTRL_SBH_ERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI streaming byte hole error asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr_error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCICTRL_SERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI SERR signal asserted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_STATUS_PARITY</span> <span class="o">|</span>
		    <span class="n">PCI_STATUS_SIG_TARGET_ABORT</span> <span class="o">|</span>
		    <span class="n">PCI_STATUS_REC_TARGET_ABORT</span> <span class="o">|</span>
		    <span class="n">PCI_STATUS_REC_MASTER_ABORT</span> <span class="o">|</span>
		    <span class="n">PCI_STATUS_SIG_SYSTEM_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI bus error, PCI_STATUS[%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">schizo_pcierr_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span><span class="p">,</span> <span class="n">afar_reg</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span><span class="p">;</span>

	<span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_AFSR</span><span class="p">;</span>
	<span class="n">afar_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_AFAR</span><span class="p">;</span>

	<span class="cm">/* Latch error status. */</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>
	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Clear primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SCHIZO_PCIAFSR_PMA</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_PTA</span> <span class="o">|</span>
		 <span class="n">SCHIZO_PCIAFSR_PRTRY</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_PPERR</span> <span class="o">|</span>
		 <span class="n">SCHIZO_PCIAFSR_PTTO</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_PUNUS</span> <span class="o">|</span>
		 <span class="n">SCHIZO_PCIAFSR_SMA</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_STA</span> <span class="o">|</span>
		 <span class="n">SCHIZO_PCIAFSR_SRTRY</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_SPERR</span> <span class="o">|</span>
		 <span class="n">SCHIZO_PCIAFSR_STTO</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_SUNUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">schizo_pcierr_intr_other</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_PMA</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;Master Abort&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_PTA</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;Target Abort&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_PRTRY</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;Excessive Retries&quot;</span> <span class="o">:</span>
		   <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_PPERR</span><span class="p">)</span> <span class="o">?</span>
		    <span class="s">&quot;Parity Error&quot;</span> <span class="o">:</span>
		    <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_PTTO</span><span class="p">)</span> <span class="o">?</span>
		     <span class="s">&quot;Timeout&quot;</span> <span class="o">:</span>
		     <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_PUNUS</span><span class="p">)</span> <span class="o">?</span>
		      <span class="s">&quot;Bus Unusable&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">))))))));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bytemask[%04lx] was_block(%d) space(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_BMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_BLK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_CFG</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;Config&quot;</span> <span class="o">:</span>
		<span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_MEM</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;Memory&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_IO</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;I/O&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">))));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI AFAR [%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI Secondary errors [&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_SMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Master Abort)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_STA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Target Abort)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_SRTRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Excessive Retries)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_SPERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Parity Error)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_STTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Timeout)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SCHIZO_PCIAFSR_SUNUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Bus Unusable)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* For the error types shown, scan PBM&#39;s PCI bus for devices</span>
<span class="cm">	 * which have logged that error type.</span>
<span class="cm">	 */</span>

	<span class="cm">/* If we see a Target Abort, this could be the result of an</span>
<span class="cm">	 * IOMMU translation error of some sort.  It is extremely</span>
<span class="cm">	 * useful to log this information as usually it indicates</span>
<span class="cm">	 * a bug in the IOMMU support code or a PCI device driver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHIZO_PCIAFSR_PTA</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_STA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schizo_check_iommu_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">PCI_ERR</span><span class="p">);</span>
		<span class="n">pci_scan_for_target_abort</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHIZO_PCIAFSR_PMA</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_SMA</span><span class="p">))</span>
		<span class="n">pci_scan_for_master_abort</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>

	<span class="cm">/* For excessive retries, PSYCHO/PBM will abort the device</span>
<span class="cm">	 * and there is no way to specifically check for excessive</span>
<span class="cm">	 * retries in the config space status registers.  So what</span>
<span class="cm">	 * we hope is that we&#39;ll catch it via the master/target</span>
<span class="cm">	 * abort events.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCHIZO_PCIAFSR_PPERR</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_SPERR</span><span class="p">))</span>
		<span class="n">pci_scan_for_parity_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCHIZO_SAFARI_ERRLOG	0x10018UL</span>

<span class="cp">#define SAFARI_ERRLOG_ERROUT	0x8000000000000000UL</span>

<span class="cp">#define BUS_ERROR_BADCMD	0x4000000000000000UL </span><span class="cm">/* Schizo/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SSMDIS	0x2000000000000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_BADMA		0x1000000000000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_BADMB		0x0800000000000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_BADMC		0x0400000000000000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SNOOP_GR	0x0000000000200000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SNOOP_PCI	0x0000000000100000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SNOOP_RD	0x0000000000080000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SNOOP_RDS	0x0000000000020000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SNOOP_RDSA	0x0000000000010000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SNOOP_OWN	0x0000000000008000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SNOOP_RDO	0x0000000000004000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_CPU1PS	0x0000000000002000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_WDATA_PERR	0x0000000000002000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_CPU1PB	0x0000000000001000UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_CTRL_PERR	0x0000000000001000UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_CPU0PS	0x0000000000000800UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SNOOP_ERR	0x0000000000000800UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_CPU0PB	0x0000000000000400UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_JBUS_ILL_B	0x0000000000000400UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_CIQTO		0x0000000000000200UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_LPQTO		0x0000000000000100UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_JBUS_ILL_C	0x0000000000000100UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_SFPQTO	0x0000000000000080UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_UFPQTO	0x0000000000000040UL </span><span class="cm">/* Safari */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_RD_PERR	0x0000000000000040UL </span><span class="cm">/* Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_APERR		0x0000000000000020UL </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_UNMAP		0x0000000000000010UL </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_BUSERR	0x0000000000000004UL </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_TIMEOUT	0x0000000000000002UL </span><span class="cm">/* Safari/Tomatillo */</span><span class="cp"></span>
<span class="cp">#define BUS_ERROR_ILL		0x0000000000000001UL </span><span class="cm">/* Safari */</span><span class="cp"></span>

<span class="cm">/* We only expect UNMAP errors here.  The rest of the Safari errors</span>
<span class="cm"> * are marked fatal and thus cause a system reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">schizo_safarierr_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">errlog</span><span class="p">;</span>

	<span class="n">errlog</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_SAFARI_ERRLOG</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">errlog</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SAFARI_ERRLOG_ERROUT</span><span class="p">),</span>
		   <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_SAFARI_ERRLOG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">errlog</span> <span class="o">&amp;</span> <span class="n">BUS_ERROR_UNMAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Unexpected Safari/JBUS error interrupt, errlog[%016llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">errlog</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Safari/JBUS interrupt, UNMAPPED error, interrogating IOMMUs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">schizo_check_iommu_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SAFARI_ERR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Nearly identical to PSYCHO equivalents... */</span>
<span class="cp">#define SCHIZO_ECC_CTRL		0x10020UL</span>
<span class="cp">#define  SCHIZO_ECCCTRL_EE	 0x8000000000000000UL </span><span class="cm">/* Enable ECC Checking */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_ECCCTRL_UE	 0x4000000000000000UL </span><span class="cm">/* Enable UE Interrupts */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_ECCCTRL_CE	 0x2000000000000000UL </span><span class="cm">/* Enable CE INterrupts */</span><span class="cp"></span>

<span class="cp">#define SCHIZO_SAFARI_ERRCTRL	0x10008UL</span>
<span class="cp">#define  SCHIZO_SAFERRCTRL_EN	 0x8000000000000000UL</span>
<span class="cp">#define SCHIZO_SAFARI_IRQCTRL	0x10010UL</span>
<span class="cp">#define  SCHIZO_SAFIRQCTRL_EN	 0x8000000000000000UL</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pbm_routes_this_ino</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ino</span> <span class="o">&amp;=</span> <span class="n">IMAP_INO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">ino_bitmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ino</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* How the Tomatillo IRQs are routed around is pure guesswork here.</span>
<span class="cm"> *</span>
<span class="cm"> * All the Tomatillo devices I see in prtconf dumps seem to have only</span>
<span class="cm"> * a single PCI bus unit attached to it.  It would seem they are separate</span>
<span class="cm"> * devices because their PortID (ie. JBUS ID) values are all different</span>
<span class="cm"> * and thus the registers are mapped to totally different locations.</span>
<span class="cm"> *</span>
<span class="cm"> * However, two Tomatillo&#39;s look &quot;similar&quot; in that the only difference</span>
<span class="cm"> * in their PortID is the lowest bit.</span>
<span class="cm"> *</span>
<span class="cm"> * So if we were to ignore this lower bit, it certainly looks like two</span>
<span class="cm"> * PCI bus units of the same Tomatillo.  I still have not really</span>
<span class="cm"> * figured this out...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tomatillo_register_error_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">,</span> <span class="n">err_no_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Tomatillo IRQ property layout is:</span>
<span class="cm">	 * 0: PCIERR</span>
<span class="cm">	 * 1: UE ERR</span>
<span class="cm">	 * 2: CE ERR</span>
<span class="cm">	 * 3: SERR</span>
<span class="cm">	 * 4: POWER FAIL?</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_UE_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">schizo_ue_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;TOMATILLO_UE&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register UE, &quot;</span>
			       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_CE_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">schizo_ce_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;TOMATILLO_CE&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register CE, &quot;</span>
			       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_PCIERR_A_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">schizo_pcierr_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;TOMATILLO_PCIERR&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_PCIERR_B_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">schizo_pcierr_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;TOMATILLO_PCIERR&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register PCIERR, &quot;</span>
		       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_SERR_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">schizo_safarierr_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;TOMATILLO_SERR&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register SERR, &quot;</span>
			       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable UE and CE interrupts for controller. */</span>
	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SCHIZO_ECCCTRL_EE</span> <span class="o">|</span>
		    <span class="n">SCHIZO_ECCCTRL_UE</span> <span class="o">|</span>
		    <span class="n">SCHIZO_ECCCTRL_CE</span><span class="p">),</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_ECC_CTRL</span><span class="p">);</span>

	<span class="cm">/* Enable PCI Error interrupts and clear error</span>
<span class="cm">	 * bits.</span>
<span class="cm">	 */</span>
	<span class="n">err_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCHIZO_PCICTRL_BUS_UNUS</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_TTO_ERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_RTRY_ERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_SERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_EEN</span><span class="p">);</span>

	<span class="n">err_no_mask</span> <span class="o">=</span> <span class="n">SCHIZO_PCICTRL_DTO_ERR</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">err_no_mask</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_CTRL</span><span class="p">);</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCHIZO_PCIAFSR_PMA</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_PTA</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_PRTRY</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_PPERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_PTTO</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_SMA</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_STA</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_SRTRY</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_SPERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_STTO</span><span class="p">);</span>

	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">err_mask</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_AFSR</span><span class="p">);</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUS_ERROR_BADCMD</span> <span class="o">|</span> <span class="n">BUS_ERROR_SNOOP_GR</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_SNOOP_PCI</span> <span class="o">|</span> <span class="n">BUS_ERROR_SNOOP_RD</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_SNOOP_RDS</span> <span class="o">|</span> <span class="n">BUS_ERROR_SNOOP_RDSA</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_SNOOP_OWN</span> <span class="o">|</span> <span class="n">BUS_ERROR_SNOOP_RDO</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_WDATA_PERR</span> <span class="o">|</span> <span class="n">BUS_ERROR_CTRL_PERR</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_SNOOP_ERR</span> <span class="o">|</span> <span class="n">BUS_ERROR_JBUS_ILL_B</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_JBUS_ILL_C</span> <span class="o">|</span> <span class="n">BUS_ERROR_RD_PERR</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_APERR</span> <span class="o">|</span> <span class="n">BUS_ERROR_UNMAP</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_BUSERR</span> <span class="o">|</span> <span class="n">BUS_ERROR_TIMEOUT</span><span class="p">);</span>

	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SCHIZO_SAFERRCTRL_EN</span> <span class="o">|</span> <span class="n">err_mask</span><span class="p">),</span>
		   <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_SAFARI_ERRCTRL</span><span class="p">);</span>

	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SCHIZO_SAFIRQCTRL_EN</span> <span class="o">|</span> <span class="p">(</span><span class="n">BUS_ERROR_UNMAP</span><span class="p">)),</span>
		   <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_SAFARI_IRQCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schizo_register_error_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">,</span> <span class="n">err_no_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Schizo IRQ property layout is:</span>
<span class="cm">	 * 0: PCIERR</span>
<span class="cm">	 * 1: UE ERR</span>
<span class="cm">	 * 2: CE ERR</span>
<span class="cm">	 * 3: SERR</span>
<span class="cm">	 * 4: POWER FAIL?</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_UE_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">schizo_ue_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;SCHIZO_UE&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register UE, &quot;</span>
			       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_CE_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">schizo_ce_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;SCHIZO_CE&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register CE, &quot;</span>
			       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_PCIERR_A_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">schizo_pcierr_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;SCHIZO_PCIERR&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_PCIERR_B_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">schizo_pcierr_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;SCHIZO_PCIERR&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register PCIERR, &quot;</span>
		       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm_routes_this_ino</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">SCHIZO_SERR_INO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">schizo_safarierr_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;SCHIZO_SERR&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register SERR, &quot;</span>
			       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable UE and CE interrupts for controller. */</span>
	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SCHIZO_ECCCTRL_EE</span> <span class="o">|</span>
		    <span class="n">SCHIZO_ECCCTRL_UE</span> <span class="o">|</span>
		    <span class="n">SCHIZO_ECCCTRL_CE</span><span class="p">),</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_ECC_CTRL</span><span class="p">);</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCHIZO_PCICTRL_BUS_UNUS</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_ESLCK</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_TTO_ERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_RTRY_ERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_SBH_ERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_SERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCICTRL_EEN</span><span class="p">);</span>

	<span class="n">err_no_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCHIZO_PCICTRL_DTO_ERR</span> <span class="o">|</span>
		       <span class="n">SCHIZO_PCICTRL_SBH_INT</span><span class="p">);</span>

	<span class="cm">/* Enable PCI Error interrupts and clear error</span>
<span class="cm">	 * bits for each PBM.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">err_no_mask</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_CTRL</span><span class="p">);</span>

	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SCHIZO_PCIAFSR_PMA</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_PTA</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_PRTRY</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_PPERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_PTTO</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_PUNUS</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_SMA</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_STA</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_SRTRY</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_SPERR</span> <span class="o">|</span>
		    <span class="n">SCHIZO_PCIAFSR_STTO</span> <span class="o">|</span> <span class="n">SCHIZO_PCIAFSR_SUNUS</span><span class="p">),</span>
		   <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_AFSR</span><span class="p">);</span>

	<span class="cm">/* Make all Safari error conditions fatal except unmapped</span>
<span class="cm">	 * errors which we make generate interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">err_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUS_ERROR_BADCMD</span> <span class="o">|</span> <span class="n">BUS_ERROR_SSMDIS</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_BADMA</span> <span class="o">|</span> <span class="n">BUS_ERROR_BADMB</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_BADMC</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_CPU1PS</span> <span class="o">|</span> <span class="n">BUS_ERROR_CPU1PB</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_CPU0PS</span> <span class="o">|</span> <span class="n">BUS_ERROR_CPU0PB</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_CIQTO</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_LPQTO</span> <span class="o">|</span> <span class="n">BUS_ERROR_SFPQTO</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_UFPQTO</span> <span class="o">|</span> <span class="n">BUS_ERROR_APERR</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_BUSERR</span> <span class="o">|</span> <span class="n">BUS_ERROR_TIMEOUT</span> <span class="o">|</span>
		    <span class="n">BUS_ERROR_ILL</span><span class="p">);</span>
<span class="cp">#if 1</span>
	<span class="cm">/* XXX Something wrong with some Excalibur systems</span>
<span class="cm">	 * XXX Sun is shipping.  The behavior on a 2-cpu</span>
<span class="cm">	 * XXX machine is that both CPU1 parity error bits</span>
<span class="cm">	 * XXX are set and are immediately set again when</span>
<span class="cm">	 * XXX their error status bits are cleared.  Just</span>
<span class="cm">	 * XXX ignore them for now.  -DaveM</span>
<span class="cm">	 */</span>
	<span class="n">err_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BUS_ERROR_CPU1PS</span> <span class="o">|</span> <span class="n">BUS_ERROR_CPU1PB</span> <span class="o">|</span>
		      <span class="n">BUS_ERROR_CPU0PS</span> <span class="o">|</span> <span class="n">BUS_ERROR_CPU0PB</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SCHIZO_SAFERRCTRL_EN</span> <span class="o">|</span> <span class="n">err_mask</span><span class="p">),</span>
		   <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SCHIZO_SAFARI_ERRCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pbm_config_busmastering</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* Set cache-line size to 64 bytes, this is actually</span>
<span class="cm">	 * a nop but I do it for completeness.</span>
<span class="cm">	 */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">schizo_pci_config_mkaddr</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_first_busno</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">);</span>
	<span class="n">pci_config_write8</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">64</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="cm">/* Set PBM latency timer to 64 PCI clocks. */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">schizo_pci_config_mkaddr</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_first_busno</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">);</span>
	<span class="n">pci_config_write8</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">schizo_scan_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pbm_config_busmastering</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">is_66mhz_capable</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">of_find_property</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;66mhz-capable&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
		 <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">pci_scan_one_pbm</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span><span class="p">)</span>
		<span class="n">tomatillo_register_error_handlers</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">schizo_register_error_handlers</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SCHIZO_STRBUF_CONTROL		(0x02800UL)</span>
<span class="cp">#define SCHIZO_STRBUF_FLUSH		(0x02808UL)</span>
<span class="cp">#define SCHIZO_STRBUF_FSYNC		(0x02810UL)</span>
<span class="cp">#define SCHIZO_STRBUF_CTXFLUSH		(0x02818UL)</span>
<span class="cp">#define SCHIZO_STRBUF_CTXMATCH		(0x10000UL)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schizo_pbm_strbuf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TOMATILLO lacks streaming cache.  */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SCHIZO has context flushing. */</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_control</span>		<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_STRBUF_CONTROL</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_pflush</span>		<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_STRBUF_FLUSH</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_fsync</span>		<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_STRBUF_FSYNC</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_ctxflush</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_STRBUF_CTXFLUSH</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_ctxmatch_base</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SCHIZO_STRBUF_CTXMATCH</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_flushflag</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">__flushflag_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		  <span class="o">+</span> <span class="mi">63UL</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63UL</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_flushflag_pa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
		<span class="n">__pa</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_flushflag</span><span class="p">);</span>

	<span class="cm">/* Turn off LRU locking and diag mode, enable the</span>
<span class="cm">	 * streaming buffer and leave the rerun-disable</span>
<span class="cm">	 * setting however OBP set it.</span>
<span class="cm">	 */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCHIZO_STRBUF_CTRL_LPTR</span> <span class="o">|</span>
		     <span class="n">SCHIZO_STRBUF_CTRL_LENAB</span> <span class="o">|</span>
		     <span class="n">SCHIZO_STRBUF_CTRL_DENAB</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">SCHIZO_STRBUF_CTRL_ENAB</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_control</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCHIZO_IOMMU_CONTROL		(0x00200UL)</span>
<span class="cp">#define SCHIZO_IOMMU_TSBBASE		(0x00208UL)</span>
<span class="cp">#define SCHIZO_IOMMU_FLUSH		(0x00210UL)</span>
<span class="cp">#define SCHIZO_IOMMU_CTXFLUSH		(0x00218UL)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">schizo_pbm_iommu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">vdma_default</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xc0000000</span><span class="p">,</span> <span class="mh">0x40000000</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">tagbase</span><span class="p">,</span> <span class="n">database</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tsbsize</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vdma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">vdma</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;virtual-dma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdma</span><span class="p">)</span>
		<span class="n">vdma</span> <span class="o">=</span> <span class="n">vdma_default</span><span class="p">;</span>

	<span class="n">dma_mask</span> <span class="o">=</span> <span class="n">vdma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vdma</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x20000000</span>:
			<span class="n">dma_mask</span> <span class="o">|=</span> <span class="mh">0x1fffffff</span><span class="p">;</span>
			<span class="n">tsbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x40000000</span>:
			<span class="n">dma_mask</span> <span class="o">|=</span> <span class="mh">0x3fffffff</span><span class="p">;</span>
			<span class="n">tsbsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x80000000</span>:
			<span class="n">dma_mask</span> <span class="o">|=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
			<span class="n">tsbsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Strange virtual-dma size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register addresses, SCHIZO has iommu ctx flushing. */</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span>  <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_IOMMU_CONTROL</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tsbbase</span>  <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_IOMMU_TSBBASE</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_flush</span>    <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_IOMMU_FLUSH</span><span class="p">;</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tags</span>     <span class="o">=</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_flush</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xa580UL</span> <span class="o">-</span> <span class="mh">0x0210UL</span><span class="p">);</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_ctxflush</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_IOMMU_CTXFLUSH</span><span class="p">;</span>

	<span class="cm">/* We use the main control/status register of SCHIZO as the write</span>
<span class="cm">	 * completion register.</span>
<span class="cm">	 */</span>
	<span class="n">iommu</span><span class="o">-&gt;</span><span class="n">write_complete_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="mh">0x10000UL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Invalidate TLB Entries.</span>
<span class="cm">	 */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">SCHIZO_IOMMU_CTRL_DENAB</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

	<span class="n">tagbase</span> <span class="o">=</span> <span class="n">SCHIZO_IOMMU_TAG</span><span class="p">,</span> <span class="n">database</span> <span class="o">=</span> <span class="n">SCHIZO_IOMMU_DATA</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">tagbase</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">database</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8UL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Leave diag mode enabled for full-flushing done</span>
<span class="cm">	 * in pci_iommu.c</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">iommu_table_init</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span> <span class="n">tsbsize</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">vdma</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dma_mask</span><span class="p">,</span>
			       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">numa_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;iommu_table_init() fails with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">page_table</span><span class="p">),</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_tsbbase</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCHIZO_IOMMU_CTRL_TSBSZ</span> <span class="o">|</span> <span class="n">SCHIZO_IOMMU_CTRL_TBWSZ</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tsbsize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SCHIZO_IOMMU_TSBSZ_64K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SCHIZO_IOMMU_TSBSZ_128K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">SCHIZO_IOMMU_CTRL_ENAB</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">iommu</span><span class="o">-&gt;</span><span class="n">iommu_control</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCHIZO_PCI_IRQ_RETRY	(0x1a00UL)</span>
<span class="cp">#define  SCHIZO_IRQ_RETRY_INF	 0xffUL</span>

<span class="cp">#define SCHIZO_PCI_DIAG			(0x2020UL)</span>
<span class="cp">#define  SCHIZO_PCIDIAG_D_BADECC	(1UL &lt;&lt; 10UL) </span><span class="cm">/* Disable BAD ECC errors (Schizo) */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_PCIDIAG_D_BYPASS	(1UL &lt;&lt;  9UL) </span><span class="cm">/* Disable MMU bypass mode (Schizo/Tomatillo) */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_PCIDIAG_D_TTO		(1UL &lt;&lt;  8UL) </span><span class="cm">/* Disable TTO errors (Schizo/Tomatillo) */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_PCIDIAG_D_RTRYARB	(1UL &lt;&lt;  7UL) </span><span class="cm">/* Disable retry arbitration (Schizo) */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_PCIDIAG_D_RETRY		(1UL &lt;&lt;  6UL) </span><span class="cm">/* Disable retry limit (Schizo/Tomatillo) */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_PCIDIAG_D_INTSYNC	(1UL &lt;&lt;  5UL) </span><span class="cm">/* Disable interrupt/DMA synch (Schizo/Tomatillo) */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_PCIDIAG_I_DMA_PARITY	(1UL &lt;&lt;  3UL) </span><span class="cm">/* Invert DMA parity (Schizo/Tomatillo) */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_PCIDIAG_I_PIOD_PARITY	(1UL &lt;&lt;  2UL) </span><span class="cm">/* Invert PIO data parity (Schizo/Tomatillo) */</span><span class="cp"></span>
<span class="cp">#define  SCHIZO_PCIDIAG_I_PIOA_PARITY	(1UL &lt;&lt;  1UL) </span><span class="cm">/* Invert PIO address parity (Schizo/Tomatillo) */</span><span class="cp"></span>

<span class="cp">#define TOMATILLO_PCI_IOC_CSR		(0x2248UL)</span>
<span class="cp">#define TOMATILLO_IOC_PART_WPENAB	0x0000000000080000UL</span>
<span class="cp">#define TOMATILLO_IOC_RDMULT_PENAB	0x0000000000040000UL</span>
<span class="cp">#define TOMATILLO_IOC_RDONE_PENAB	0x0000000000020000UL</span>
<span class="cp">#define TOMATILLO_IOC_RDLINE_PENAB	0x0000000000010000UL</span>
<span class="cp">#define TOMATILLO_IOC_RDMULT_PLEN	0x000000000000c000UL</span>
<span class="cp">#define TOMATILLO_IOC_RDMULT_PLEN_SHIFT	14UL</span>
<span class="cp">#define TOMATILLO_IOC_RDONE_PLEN	0x0000000000003000UL</span>
<span class="cp">#define TOMATILLO_IOC_RDONE_PLEN_SHIFT	12UL</span>
<span class="cp">#define TOMATILLO_IOC_RDLINE_PLEN	0x0000000000000c00UL</span>
<span class="cp">#define TOMATILLO_IOC_RDLINE_PLEN_SHIFT	10UL</span>
<span class="cp">#define TOMATILLO_IOC_PREF_OFF		0x00000000000003f8UL</span>
<span class="cp">#define TOMATILLO_IOC_PREF_OFF_SHIFT	3UL</span>
<span class="cp">#define TOMATILLO_IOC_RDMULT_CPENAB	0x0000000000000004UL</span>
<span class="cp">#define TOMATILLO_IOC_RDONE_CPENAB	0x0000000000000002UL</span>
<span class="cp">#define TOMATILLO_IOC_RDLINE_CPENAB	0x0000000000000001UL</span>

<span class="cp">#define TOMATILLO_PCI_IOC_TDIAG		(0x2250UL)</span>
<span class="cp">#define TOMATILLO_PCI_IOC_DDIAG		(0x2290UL)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schizo_pbm_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_IRQ_RETRY</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_CTRL</span><span class="p">);</span>

	<span class="cm">/* Enable arbiter for all PCI slots.  */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_version</span> <span class="o">&gt;=</span> <span class="mh">0x2</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x3UL</span> <span class="o">&lt;&lt;</span> <span class="n">SCHIZO_PCICTRL_PTO_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_find_property</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;no-bus-parking&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCHIZO_PCICTRL_PARK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCHIZO_PCICTRL_PARK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_version</span> <span class="o">&lt;=</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SCHIZO_PCICTRL_DTO_INT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCHIZO_PCICTRL_DTO_INT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SCHIZO_PCICTRL_MRM_PREF</span> <span class="o">|</span>
			<span class="n">SCHIZO_PCICTRL_RDO_PREF</span> <span class="o">|</span>
			<span class="n">SCHIZO_PCICTRL_RDL_PREF</span><span class="p">);</span>

	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_CTRL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_DIAG</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SCHIZO_PCIDIAG_D_RTRYARB</span> <span class="o">|</span>
		 <span class="n">SCHIZO_PCIDIAG_D_RETRY</span> <span class="o">|</span>
		 <span class="n">SCHIZO_PCIDIAG_D_INTSYNC</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">SCHIZO_PCI_DIAG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear prefetch lengths to workaround a bug in</span>
<span class="cm">		 * Jalapeno...</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">TOMATILLO_IOC_PART_WPENAB</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TOMATILLO_IOC_PREF_OFF_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">TOMATILLO_IOC_RDMULT_CPENAB</span> <span class="o">|</span>
		       <span class="n">TOMATILLO_IOC_RDONE_CPENAB</span> <span class="o">|</span>
		       <span class="n">TOMATILLO_IOC_RDLINE_CPENAB</span><span class="p">);</span>

		<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">+</span> <span class="n">TOMATILLO_PCI_IOC_CSR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">schizo_pbm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="n">u32</span> <span class="n">portid</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">chip_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_prom64_registers</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chipset_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chip_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span>:
		<span class="n">chipset_name</span> <span class="o">=</span> <span class="s">&quot;TOMATILLO&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PBM_CHIP_TYPE_SCHIZO_PLUS</span>:
		<span class="n">chipset_name</span> <span class="o">=</span> <span class="s">&quot;SCHIZO+&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PBM_CHIP_TYPE_SCHIZO</span>:
	<span class="nl">default:</span>
		<span class="n">chipset_name</span> <span class="o">=</span> <span class="s">&quot;SCHIZO&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For SCHIZO, three OBP regs:</span>
<span class="cm">	 * 1) PBM controller regs</span>
<span class="cm">	 * 2) Schizo front-end controller regs (same for both PBMs)</span>
<span class="cm">	 * 3) PBM PCI config space</span>
<span class="cm">	 *</span>
<span class="cm">	 * For TOMATILLO, four OBP regs:</span>
<span class="cm">	 * 1) PBM controller regs</span>
<span class="cm">	 * 2) Tomatillo front-end controller regs</span>
<span class="cm">	 * 3) PBM PCI config space</span>
<span class="cm">	 * 4) Ichip regs</span>
<span class="cm">	 */</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pci_pbm_root</span><span class="p">;</span>
	<span class="n">pci_pbm_root</span> <span class="o">=</span> <span class="n">pbm</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">numa_node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sun4u_pci_ops</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">config_space_reg_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">pci_num_pbms</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">portid</span> <span class="o">=</span> <span class="n">portid</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">chip_type</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_version</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;version#&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;module-version#&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pbm_regs</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">phys_addr</span> <span class="o">-</span> <span class="mh">0x10000UL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span><span class="p">)</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sync_reg</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">phys_addr</span> <span class="o">+</span> <span class="mh">0x1a18UL</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s PCI Bus Module ver[%x:%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chipset_name</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_version</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_revision</span><span class="p">);</span>

	<span class="n">schizo_pbm_hw_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="n">pci_determine_mem_io_space</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="n">pci_get_pbm_props</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">schizo_pbm_iommu_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">schizo_pbm_strbuf_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

	<span class="n">schizo_scan_bus</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">portid_compare</span><span class="p">(</span><span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="p">(</span><span class="n">y</span> <span class="o">^</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">schizo_find_sibling</span><span class="p">(</span><span class="n">u32</span> <span class="n">portid</span><span class="p">,</span>
							   <span class="kt">int</span> <span class="n">chip_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">pci_pbm_root</span><span class="p">;</span> <span class="n">pbm</span><span class="p">;</span> <span class="n">pbm</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">portid_compare</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">portid</span><span class="p">,</span> <span class="n">portid</span><span class="p">,</span> <span class="n">chip_type</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">pbm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">__schizo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chip_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">portid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">portid</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;portid&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pbm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pbm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Cannot allocate pci_pbm_info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">schizo_find_sibling</span><span class="p">(</span><span class="n">portid</span><span class="p">,</span> <span class="n">chip_type</span><span class="p">);</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Cannot allocate PBM A iommu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_pbm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">iommu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">schizo_pbm_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">portid</span><span class="p">,</span> <span class="n">chip_type</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_iommu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">pbm</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_iommu:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">);</span>

<span class="nl">out_free_pbm:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">schizo_match</span><span class="p">[];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">schizo_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">of_match_device</span><span class="p">(</span><span class="n">schizo_match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__schizo_init</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The ordering of this table is very important.  Some Tomatillo</span>
<span class="cm"> * nodes announce that they are compatible with both pci108e,a801</span>
<span class="cm"> * and pci108e,8001.  So list the chips in reverse chronological</span>
<span class="cm"> * order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">schizo_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;pci108e,a801&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">PBM_CHIP_TYPE_TOMATILLO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;pci108e,8002&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">PBM_CHIP_TYPE_SCHIZO_PLUS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;pci108e,8001&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">PBM_CHIP_TYPE_SCHIZO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">schizo_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">schizo_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">schizo_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">schizo_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schizo_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">schizo_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
