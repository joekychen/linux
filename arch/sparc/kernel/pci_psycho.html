<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › pci_psycho.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci_psycho.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* pci_psycho.c: PSYCHO/U2P specific PCI controller support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1997, 1998, 1999, 2007 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> * Copyright (C) 1998, 1999 Eddie C. Dost   (ecd@skynet.be)</span>
<span class="cm"> * Copyright (C) 1999 Jakub Jelinek   (jakub@redhat.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/starfire.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/upa.h&gt;</span>

<span class="cp">#include &quot;pci_impl.h&quot;</span>
<span class="cp">#include &quot;iommu_common.h&quot;</span>
<span class="cp">#include &quot;psycho_common.h&quot;</span>

<span class="cp">#define DRIVER_NAME	&quot;psycho&quot;</span>
<span class="cp">#define PFX		DRIVER_NAME &quot;: &quot;</span>

<span class="cm">/* Misc. PSYCHO PCI controller register offsets and definitions. */</span>
<span class="cp">#define PSYCHO_CONTROL		0x0010UL</span>
<span class="cp">#define  PSYCHO_CONTROL_IMPL	 0xf000000000000000UL </span><span class="cm">/* Implementation of this PSYCHO*/</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CONTROL_VER	 0x0f00000000000000UL </span><span class="cm">/* Version of this PSYCHO       */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CONTROL_MID	 0x00f8000000000000UL </span><span class="cm">/* UPA Module ID of PSYCHO      */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CONTROL_IGN	 0x0007c00000000000UL </span><span class="cm">/* Interrupt Group Number       */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CONTROL_RESV     0x00003ffffffffff0UL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CONTROL_APCKEN	 0x0000000000000008UL </span><span class="cm">/* Address Parity Check Enable  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CONTROL_APERR	 0x0000000000000004UL </span><span class="cm">/* Incoming System Addr Parerr  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CONTROL_IAP	 0x0000000000000002UL </span><span class="cm">/* Invert UPA Parity            */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CONTROL_MODE	 0x0000000000000001UL </span><span class="cm">/* PSYCHO clock mode            */</span><span class="cp"></span>
<span class="cp">#define PSYCHO_PCIA_CTRL	0x2000UL</span>
<span class="cp">#define PSYCHO_PCIB_CTRL	0x4000UL</span>
<span class="cp">#define  PSYCHO_PCICTRL_RESV1	 0xfffffff000000000UL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_SBH_ERR	 0x0000000800000000UL </span><span class="cm">/* Streaming byte hole error    */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_SERR	 0x0000000400000000UL </span><span class="cm">/* SERR signal asserted         */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_SPEED	 0x0000000200000000UL </span><span class="cm">/* PCI speed (1 is U2P clock)   */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_RESV2	 0x00000001ffc00000UL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_ARB_PARK 0x0000000000200000UL </span><span class="cm">/* PCI arbitration parking      */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_RESV3	 0x00000000001ff800UL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_SBH_INT	 0x0000000000000400UL </span><span class="cm">/* Streaming byte hole int enab */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_WEN	 0x0000000000000200UL </span><span class="cm">/* Power Mgmt Wake Enable       */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_EEN	 0x0000000000000100UL </span><span class="cm">/* PCI Error Interrupt Enable   */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_RESV4	 0x00000000000000c0UL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCICTRL_AEN	 0x000000000000003fUL </span><span class="cm">/* PCI DVMA Arbitration Enable  */</span><span class="cp"></span>

<span class="cm">/* PSYCHO error handling support. */</span>

<span class="cm">/* Helper function of IOMMU error checking, which checks out</span>
<span class="cm"> * the state of the streaming buffers.  The IOMMU lock is</span>
<span class="cm"> * held when this is called.</span>
<span class="cm"> *</span>
<span class="cm"> * For the PCI error case we know which PBM (and thus which</span>
<span class="cm"> * streaming buffer) caused the error, but for the uncorrectable</span>
<span class="cm"> * error case we do not.  So we always check both streaming caches.</span>
<span class="cm"> */</span>
<span class="cp">#define PSYCHO_STRBUF_CONTROL_A 0x2800UL</span>
<span class="cp">#define PSYCHO_STRBUF_CONTROL_B 0x4800UL</span>
<span class="cp">#define  PSYCHO_STRBUF_CTRL_LPTR    0x00000000000000f0UL </span><span class="cm">/* LRU Lock Pointer */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_STRBUF_CTRL_LENAB   0x0000000000000008UL </span><span class="cm">/* LRU Lock Enable */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_STRBUF_CTRL_RRDIS   0x0000000000000004UL </span><span class="cm">/* Rerun Disable */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_STRBUF_CTRL_DENAB   0x0000000000000002UL </span><span class="cm">/* Diagnostic Mode Enable */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_STRBUF_CTRL_ENAB    0x0000000000000001UL </span><span class="cm">/* Streaming Buffer Enable */</span><span class="cp"></span>
<span class="cp">#define PSYCHO_STRBUF_FLUSH_A   0x2808UL</span>
<span class="cp">#define PSYCHO_STRBUF_FLUSH_B   0x4808UL</span>
<span class="cp">#define PSYCHO_STRBUF_FSYNC_A   0x2810UL</span>
<span class="cp">#define PSYCHO_STRBUF_FSYNC_B   0x4810UL</span>
<span class="cp">#define PSYCHO_STC_DATA_A	0xb000UL</span>
<span class="cp">#define PSYCHO_STC_DATA_B	0xc000UL</span>
<span class="cp">#define PSYCHO_STC_ERR_A	0xb400UL</span>
<span class="cp">#define PSYCHO_STC_ERR_B	0xc400UL</span>
<span class="cp">#define PSYCHO_STC_TAG_A	0xb800UL</span>
<span class="cp">#define PSYCHO_STC_TAG_B	0xc800UL</span>
<span class="cp">#define PSYCHO_STC_LINE_A	0xb900UL</span>
<span class="cp">#define PSYCHO_STC_LINE_B	0xc900UL</span>

<span class="cm">/* When an Uncorrectable Error or a PCI Error happens, we</span>
<span class="cm"> * interrogate the IOMMU state to see if it is the cause.</span>
<span class="cm"> */</span>
<span class="cp">#define PSYCHO_IOMMU_CONTROL	0x0200UL</span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_RESV     0xfffffffff9000000UL </span><span class="cm">/* Reserved                      */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_XLTESTAT 0x0000000006000000UL </span><span class="cm">/* Translation Error Status      */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_XLTEERR  0x0000000001000000UL </span><span class="cm">/* Translation Error encountered */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_LCKEN    0x0000000000800000UL </span><span class="cm">/* Enable translation locking    */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_LCKPTR   0x0000000000780000UL </span><span class="cm">/* Translation lock pointer      */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_TSBSZ    0x0000000000070000UL </span><span class="cm">/* TSB Size                      */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_1K      0x0000000000000000UL </span><span class="cm">/* TSB Table 1024 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_2K      0x0000000000010000UL </span><span class="cm">/* TSB Table 2048 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_4K      0x0000000000020000UL </span><span class="cm">/* TSB Table 4096 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_8K      0x0000000000030000UL </span><span class="cm">/* TSB Table 8192 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_16K     0x0000000000040000UL </span><span class="cm">/* TSB Table 16k 8-byte entries  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_32K     0x0000000000050000UL </span><span class="cm">/* TSB Table 32k 8-byte entries  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_64K     0x0000000000060000UL </span><span class="cm">/* TSB Table 64k 8-byte entries  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_TSBSZ_128K    0x0000000000070000UL </span><span class="cm">/* TSB Table 128k 8-byte entries */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_RESV2    0x000000000000fff8UL </span><span class="cm">/* Reserved                      */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_TBWSZ    0x0000000000000004UL </span><span class="cm">/* Assumed page size, 0=8k 1=64k */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_DENAB    0x0000000000000002UL </span><span class="cm">/* Diagnostic mode enable        */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_IOMMU_CTRL_ENAB     0x0000000000000001UL </span><span class="cm">/* IOMMU Enable                  */</span><span class="cp"></span>
<span class="cp">#define PSYCHO_IOMMU_TSBBASE	0x0208UL</span>
<span class="cp">#define PSYCHO_IOMMU_FLUSH	0x0210UL</span>
<span class="cp">#define PSYCHO_IOMMU_TAG	0xa580UL</span>
<span class="cp">#define PSYCHO_IOMMU_DATA	0xa600UL</span>

<span class="cm">/* Uncorrectable Errors.  Cause of the error and the address are</span>
<span class="cm"> * recorded in the UE_AFSR and UE_AFAR of PSYCHO.  They are errors</span>
<span class="cm"> * relating to UPA interface transactions.</span>
<span class="cm"> */</span>
<span class="cp">#define PSYCHO_UE_AFSR	0x0030UL</span>
<span class="cp">#define  PSYCHO_UEAFSR_PPIO	0x8000000000000000UL </span><span class="cm">/* Primary PIO is cause         */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_PDRD	0x4000000000000000UL </span><span class="cm">/* Primary DVMA read is cause   */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_PDWR	0x2000000000000000UL </span><span class="cm">/* Primary DVMA write is cause  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_SPIO	0x1000000000000000UL </span><span class="cm">/* Secondary PIO is cause       */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_SDRD	0x0800000000000000UL </span><span class="cm">/* Secondary DVMA read is cause */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_SDWR	0x0400000000000000UL </span><span class="cm">/* Secondary DVMA write is cause*/</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_RESV1	0x03ff000000000000UL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_BMSK	0x0000ffff00000000UL </span><span class="cm">/* Bytemask of failed transfer  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_DOFF	0x00000000e0000000UL </span><span class="cm">/* Doubleword Offset            */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_MID	0x000000001f000000UL </span><span class="cm">/* UPA MID causing the fault    */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_BLK	0x0000000000800000UL </span><span class="cm">/* Trans was block operation    */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_UEAFSR_RESV2	0x00000000007fffffUL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define PSYCHO_UE_AFAR	0x0038UL</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">psycho_ue_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_UE_AFSR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_UE_AFAR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">;</span>

	<span class="cm">/* Latch uncorrectable error status. */</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>
	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Clear the primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">PSYCHO_UEAFSR_PPIO</span> <span class="o">|</span> <span class="n">PSYCHO_UEAFSR_PDRD</span> <span class="o">|</span> <span class="n">PSYCHO_UEAFSR_PDWR</span> <span class="o">|</span>
		 <span class="n">PSYCHO_UEAFSR_SPIO</span> <span class="o">|</span> <span class="n">PSYCHO_UEAFSR_SDRD</span> <span class="o">|</span> <span class="n">PSYCHO_UEAFSR_SDWR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Uncorrectable Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_PPIO</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;PIO&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_PDRD</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;DMA Read&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_PDWR</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;DMA Write&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)))));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bytemask[%04lx] dword_offset[%lx] UPA_MID[%02lx] was_block(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_BMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_DOFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">29UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_MID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24UL</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_BLK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: UE AFAR [%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: UE Secondary errors [&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_SPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(PIO)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_SDRD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA Read)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_UEAFSR_SDWR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA Write)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Interrogate both IOMMUs for error status. */</span>
	<span class="n">psycho_check_iommu_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">UE_ERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
		<span class="n">psycho_check_iommu_error</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">,</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">UE_ERR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Correctable Errors. */</span>
<span class="cp">#define PSYCHO_CE_AFSR	0x0040UL</span>
<span class="cp">#define  PSYCHO_CEAFSR_PPIO	0x8000000000000000UL </span><span class="cm">/* Primary PIO is cause         */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_PDRD	0x4000000000000000UL </span><span class="cm">/* Primary DVMA read is cause   */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_PDWR	0x2000000000000000UL </span><span class="cm">/* Primary DVMA write is cause  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_SPIO	0x1000000000000000UL </span><span class="cm">/* Secondary PIO is cause       */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_SDRD	0x0800000000000000UL </span><span class="cm">/* Secondary DVMA read is cause */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_SDWR	0x0400000000000000UL </span><span class="cm">/* Secondary DVMA write is cause*/</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_RESV1	0x0300000000000000UL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_ESYND	0x00ff000000000000UL </span><span class="cm">/* Syndrome Bits                */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_BMSK	0x0000ffff00000000UL </span><span class="cm">/* Bytemask of failed transfer  */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_DOFF	0x00000000e0000000UL </span><span class="cm">/* Double Offset                */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_MID	0x000000001f000000UL </span><span class="cm">/* UPA MID causing the fault    */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_BLK	0x0000000000800000UL </span><span class="cm">/* Trans was block operation    */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_CEAFSR_RESV2	0x00000000007fffffUL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define PSYCHO_CE_AFAR	0x0040UL</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">psycho_ce_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_CE_AFSR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_CE_AFAR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">;</span>

	<span class="cm">/* Latch error status. */</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>
	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Clear primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">PSYCHO_CEAFSR_PPIO</span> <span class="o">|</span> <span class="n">PSYCHO_CEAFSR_PDRD</span> <span class="o">|</span> <span class="n">PSYCHO_CEAFSR_PDWR</span> <span class="o">|</span>
		 <span class="n">PSYCHO_CEAFSR_SPIO</span> <span class="o">|</span> <span class="n">PSYCHO_CEAFSR_SDRD</span> <span class="o">|</span> <span class="n">PSYCHO_CEAFSR_SDWR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Correctable Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_PPIO</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;PIO&quot;</span> <span class="o">:</span>
		 <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_PDRD</span><span class="p">)</span> <span class="o">?</span>
		  <span class="s">&quot;DMA Read&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_PDWR</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;DMA Write&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)))));</span>

	<span class="cm">/* XXX Use syndrome and afar to print out module string just like</span>
<span class="cm">	 * XXX UDB CE trap handler does... -DaveM</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: syndrome[%02lx] bytemask[%04lx] dword_offset[%lx] &quot;</span>
	       <span class="s">&quot;UPA_MID[%02lx] was_block(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_ESYND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">48UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_BMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_DOFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">29UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_MID</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24UL</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_BLK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: CE AFAR [%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: CE Secondary errors [&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_SPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(PIO)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_SDRD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA Read)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">PSYCHO_CEAFSR_SDWR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA Write)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PCI Errors.  They are signalled by the PCI bus module since they</span>
<span class="cm"> * are associated with a specific bus segment.</span>
<span class="cm"> */</span>
<span class="cp">#define PSYCHO_PCI_AFSR_A	0x2010UL</span>
<span class="cp">#define PSYCHO_PCI_AFSR_B	0x4010UL</span>
<span class="cp">#define PSYCHO_PCI_AFAR_A	0x2018UL</span>
<span class="cp">#define PSYCHO_PCI_AFAR_B	0x4018UL</span>

<span class="cm">/* XXX What about PowerFail/PowerManagement??? -DaveM */</span>
<span class="cp">#define PSYCHO_ECC_CTRL		0x0020</span>
<span class="cp">#define  PSYCHO_ECCCTRL_EE	 0x8000000000000000UL </span><span class="cm">/* Enable ECC Checking */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_ECCCTRL_UE	 0x4000000000000000UL </span><span class="cm">/* Enable UE Interrupts */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_ECCCTRL_CE	 0x2000000000000000UL </span><span class="cm">/* Enable CE INterrupts */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">psycho_register_error_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Psycho interrupt property order is:</span>
<span class="cm">	 * 0: PCIERR INO for this PBM</span>
<span class="cm">	 * 1: UE ERR</span>
<span class="cm">	 * 2: CE ERR</span>
<span class="cm">	 * 3: POWER FAIL</span>
<span class="cm">	 * 4: SPARE HARDWARE</span>
<span class="cm">	 * 5: POWER MANAGEMENT</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">num_irqs</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We really mean to ignore the return result here.  Two</span>
<span class="cm">	 * PCI controller share the same interrupt numbers and</span>
<span class="cm">	 * drive the same front-end hardware.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">psycho_ue_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="s">&quot;PSYCHO_UE&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">psycho_ce_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="s">&quot;PSYCHO_CE&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>

	<span class="cm">/* This one, however, ought not to fail.  We can just warn</span>
<span class="cm">	 * about it since the system can still operate properly even</span>
<span class="cm">	 * if this fails.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">psycho_pcierr_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="s">&quot;PSYCHO_PCIERR&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not register PCIERR, &quot;</span>
		       <span class="s">&quot;err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="cm">/* Enable UE and CE interrupts for controller. */</span>
	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">PSYCHO_ECCCTRL_EE</span> <span class="o">|</span>
		    <span class="n">PSYCHO_ECCCTRL_UE</span> <span class="o">|</span>
		    <span class="n">PSYCHO_ECCCTRL_CE</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_ECC_CTRL</span><span class="p">);</span>

	<span class="cm">/* Enable PCI Error interrupts and clear error</span>
<span class="cm">	 * bits for each PBM.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_PCIA_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PSYCHO_PCICTRL_SERR</span> <span class="o">|</span>
		<span class="n">PSYCHO_PCICTRL_SBH_ERR</span> <span class="o">|</span>
		<span class="n">PSYCHO_PCICTRL_EEN</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSYCHO_PCICTRL_SBH_INT</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_PCIA_CTRL</span><span class="p">);</span>
		     
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_PCIB_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PSYCHO_PCICTRL_SERR</span> <span class="o">|</span>
		<span class="n">PSYCHO_PCICTRL_SBH_ERR</span> <span class="o">|</span>
		<span class="n">PSYCHO_PCICTRL_EEN</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSYCHO_PCICTRL_SBH_INT</span><span class="p">);</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_PCIB_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* PSYCHO boot time probing and initialization. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pbm_config_busmastering</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* Set cache-line size to 64 bytes, this is actually</span>
<span class="cm">	 * a nop but I do it for completeness.</span>
<span class="cm">	 */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">psycho_pci_config_mkaddr</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_first_busno</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">);</span>
	<span class="n">pci_config_write8</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">64</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="cm">/* Set PBM latency timer to 64 PCI clocks. */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">psycho_pci_config_mkaddr</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_first_busno</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">);</span>
	<span class="n">pci_config_write8</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">psycho_scan_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pbm_config_busmastering</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">is_66mhz_capable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">pci_scan_one_pbm</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* After the PCI bus scan is complete, we can register</span>
<span class="cm">	 * the error interrupt handlers.</span>
<span class="cm">	 */</span>
	<span class="n">psycho_register_error_handlers</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PSYCHO_IRQ_RETRY	0x1a00UL</span>
<span class="cp">#define PSYCHO_PCIA_DIAG	0x2020UL</span>
<span class="cp">#define PSYCHO_PCIB_DIAG	0x4020UL</span>
<span class="cp">#define  PSYCHO_PCIDIAG_RESV	 0xffffffffffffff80UL </span><span class="cm">/* Reserved                     */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCIDIAG_DRETRY	 0x0000000000000040UL </span><span class="cm">/* Disable retry limit          */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCIDIAG_DISYNC	 0x0000000000000020UL </span><span class="cm">/* Disable DMA wr / irq sync    */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCIDIAG_DDWSYNC	 0x0000000000000010UL </span><span class="cm">/* Disable DMA wr / PIO rd sync */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCIDIAG_IDDPAR	 0x0000000000000008UL </span><span class="cm">/* Invert DMA data parity       */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCIDIAG_IPDPAR	 0x0000000000000004UL </span><span class="cm">/* Invert PIO data parity       */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCIDIAG_IPAPAR	 0x0000000000000002UL </span><span class="cm">/* Invert PIO address parity    */</span><span class="cp"></span>
<span class="cp">#define  PSYCHO_PCIDIAG_LPBACK	 0x0000000000000001UL </span><span class="cm">/* Enable loopback mode         */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psycho_controller_hwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">upa_writeq</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_IRQ_RETRY</span><span class="p">);</span>

	<span class="cm">/* Enable arbiter for all PCI slots. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIA_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PSYCHO_PCICTRL_AEN</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIA_CTRL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIB_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PSYCHO_PCICTRL_AEN</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIB_CTRL</span><span class="p">);</span>

	<span class="cm">/* Disable DMA write / PIO read synchronization on</span>
<span class="cm">	 * both PCI bus segments.</span>
<span class="cm">	 * [ U2P Erratum 1243770, STP2223BGA data sheet ]</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIA_DIAG</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PSYCHO_PCIDIAG_DDWSYNC</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIA_DIAG</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIB_DIAG</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PSYCHO_PCIDIAG_DDWSYNC</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIB_DIAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psycho_pbm_strbuf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">is_pbm_a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pbm_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_control</span>  <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STRBUF_CONTROL_A</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_pflush</span>   <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STRBUF_FLUSH_A</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_fsync</span>    <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STRBUF_FSYNC_A</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_err_stat</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STC_ERR_A</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_tag_diag</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STC_TAG_A</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_line_diag</span><span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STC_LINE_A</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_control</span>  <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STRBUF_CONTROL_B</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_pflush</span>   <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STRBUF_FLUSH_B</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_fsync</span>    <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STRBUF_FSYNC_B</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_err_stat</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STC_ERR_B</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_tag_diag</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STC_TAG_B</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_line_diag</span><span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PSYCHO_STC_LINE_B</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* PSYCHO&#39;s streaming buffer lacks ctx flushing. */</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_ctxflush</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_ctxmatch_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_flushflag</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">__flushflag_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		  <span class="o">+</span> <span class="mi">63UL</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="o">~</span><span class="mi">63UL</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_flushflag_pa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
		<span class="n">__pa</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_flushflag</span><span class="p">);</span>

	<span class="cm">/* Enable the streaming buffer.  We have to be careful</span>
<span class="cm">	 * just in case OBP left it with LRU locking enabled.</span>
<span class="cm">	 *</span>
<span class="cm">	 * It is possible to control if PBM will be rerun on</span>
<span class="cm">	 * line misses.  Currently I just retain whatever setting</span>
<span class="cm">	 * OBP left us with.  All checks so far show it having</span>
<span class="cm">	 * a value of zero.</span>
<span class="cm">	 */</span>
<span class="cp">#undef PSYCHO_STRBUF_RERUN_ENABLE</span>
<span class="cp">#undef PSYCHO_STRBUF_RERUN_DISABLE</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">PSYCHO_STRBUF_CTRL_ENAB</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSYCHO_STRBUF_CTRL_LENAB</span> <span class="o">|</span> <span class="n">PSYCHO_STRBUF_CTRL_LPTR</span><span class="p">);</span>
<span class="cp">#ifdef PSYCHO_STRBUF_RERUN_ENABLE</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSYCHO_STRBUF_CTRL_RRDIS</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#ifdef PSYCHO_STRBUF_RERUN_DISABLE</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">PSYCHO_STRBUF_CTRL_RRDIS</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_control</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">stc</span><span class="p">.</span><span class="n">strbuf_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PSYCHO_IOSPACE_A	0x002000000UL</span>
<span class="cp">#define PSYCHO_IOSPACE_B	0x002010000UL</span>
<span class="cp">#define PSYCHO_IOSPACE_SIZE	0x00000ffffUL</span>
<span class="cp">#define PSYCHO_MEMSPACE_A	0x100000000UL</span>
<span class="cp">#define PSYCHO_MEMSPACE_B	0x180000000UL</span>
<span class="cp">#define PSYCHO_MEMSPACE_SIZE	0x07fffffffUL</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">psycho_pbm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pbm_a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">psycho_pbm_init_common</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="s">&quot;PSYCHO&quot;</span><span class="p">,</span> <span class="n">PBM_CHIP_TYPE_PSYCHO</span><span class="p">);</span>
	<span class="n">psycho_pbm_strbuf_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">is_pbm_a</span><span class="p">);</span>
	<span class="n">psycho_scan_bus</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">psycho_find_sibling</span><span class="p">(</span><span class="n">u32</span> <span class="n">upa_portid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">pci_pbm_root</span><span class="p">;</span> <span class="n">pbm</span><span class="p">;</span> <span class="n">pbm</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">portid</span> <span class="o">==</span> <span class="n">upa_portid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pbm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PSYCHO_CONFIGSPACE	0x001000000UL</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">psycho_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_prom64_registers</span> <span class="o">*</span><span class="n">pr_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_pbm_a</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">upa_portid</span><span class="p">;</span>

	<span class="n">upa_portid</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;upa-portid&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pbm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pbm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Cannot allocate pci_pbm_info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">psycho_find_sibling</span><span class="p">(</span><span class="n">upa_portid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iommu</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">iommu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iommu</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Cannot allocate PBM iommu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_controller</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">iommu</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">portid</span> <span class="o">=</span> <span class="n">upa_portid</span><span class="p">;</span>

	<span class="n">pr_regs</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;No reg property.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_iommu</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">is_pbm_a</span> <span class="o">=</span> <span class="p">((</span><span class="n">pr_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phys_addr</span> <span class="o">&amp;</span> <span class="mh">0x6000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x2000</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">=</span> <span class="n">pr_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">config_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">pr_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">phys_addr</span> <span class="o">+</span> <span class="n">PSYCHO_CONFIGSPACE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pbm_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afsr</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCI_AFSR_A</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afar</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCI_AFAR_A</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_csr</span>  <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIA_CTRL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afsr</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCI_AFSR_B</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afar</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCI_AFAR_B</span><span class="p">;</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_csr</span>  <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">PSYCHO_PCIB_CTRL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psycho_controller_hwinit</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">psycho_iommu_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mh">0xc0000000</span><span class="p">,</span>
					<span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">PSYCHO_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_iommu</span><span class="p">;</span>

		<span class="cm">/* If necessary, hook us up for starfire IRQ translations. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_is_starfire</span><span class="p">)</span>
			<span class="n">starfire_hookup</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">portid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">psycho_pbm_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">is_pbm_a</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pci_pbm_root</span><span class="p">;</span>
	<span class="n">pci_pbm_root</span> <span class="o">=</span> <span class="n">pbm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">pbm</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_iommu:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">);</span>

<span class="nl">out_free_controller:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">psycho_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;pci108e,8000&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">psycho_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">psycho_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">psycho_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">psycho_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psycho_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">psycho_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
