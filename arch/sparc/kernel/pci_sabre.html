<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › pci_sabre.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci_sabre.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* pci_sabre.c: Sabre specific PCI controller support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1997, 1998, 1999, 2007 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> * Copyright (C) 1998, 1999 Eddie C. Dost   (ecd@skynet.be)</span>
<span class="cm"> * Copyright (C) 1999 Jakub Jelinek   (jakub@redhat.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;asm/apb.h&gt;</span>
<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/upa.h&gt;</span>

<span class="cp">#include &quot;pci_impl.h&quot;</span>
<span class="cp">#include &quot;iommu_common.h&quot;</span>
<span class="cp">#include &quot;psycho_common.h&quot;</span>

<span class="cp">#define DRIVER_NAME	&quot;sabre&quot;</span>
<span class="cp">#define PFX		DRIVER_NAME &quot;: &quot;</span>

<span class="cm">/* SABRE PCI controller register offsets and definitions. */</span>
<span class="cp">#define SABRE_UE_AFSR		0x0030UL</span>
<span class="cp">#define  SABRE_UEAFSR_PDRD	 0x4000000000000000UL	</span><span class="cm">/* Primary PCI DMA Read */</span><span class="cp"></span>
<span class="cp">#define  SABRE_UEAFSR_PDWR	 0x2000000000000000UL	</span><span class="cm">/* Primary PCI DMA Write */</span><span class="cp"></span>
<span class="cp">#define  SABRE_UEAFSR_SDRD	 0x0800000000000000UL	</span><span class="cm">/* Secondary PCI DMA Read */</span><span class="cp"></span>
<span class="cp">#define  SABRE_UEAFSR_SDWR	 0x0400000000000000UL	</span><span class="cm">/* Secondary PCI DMA Write */</span><span class="cp"></span>
<span class="cp">#define  SABRE_UEAFSR_SDTE	 0x0200000000000000UL	</span><span class="cm">/* Secondary DMA Translation Error */</span><span class="cp"></span>
<span class="cp">#define  SABRE_UEAFSR_PDTE	 0x0100000000000000UL	</span><span class="cm">/* Primary DMA Translation Error */</span><span class="cp"></span>
<span class="cp">#define  SABRE_UEAFSR_BMSK	 0x0000ffff00000000UL	</span><span class="cm">/* Bytemask */</span><span class="cp"></span>
<span class="cp">#define  SABRE_UEAFSR_OFF	 0x00000000e0000000UL	</span><span class="cm">/* Offset (AFAR bits [5:3] */</span><span class="cp"></span>
<span class="cp">#define  SABRE_UEAFSR_BLK	 0x0000000000800000UL	</span><span class="cm">/* Was block operation */</span><span class="cp"></span>
<span class="cp">#define SABRE_UECE_AFAR		0x0038UL</span>
<span class="cp">#define SABRE_CE_AFSR		0x0040UL</span>
<span class="cp">#define  SABRE_CEAFSR_PDRD	 0x4000000000000000UL	</span><span class="cm">/* Primary PCI DMA Read */</span><span class="cp"></span>
<span class="cp">#define  SABRE_CEAFSR_PDWR	 0x2000000000000000UL	</span><span class="cm">/* Primary PCI DMA Write */</span><span class="cp"></span>
<span class="cp">#define  SABRE_CEAFSR_SDRD	 0x0800000000000000UL	</span><span class="cm">/* Secondary PCI DMA Read */</span><span class="cp"></span>
<span class="cp">#define  SABRE_CEAFSR_SDWR	 0x0400000000000000UL	</span><span class="cm">/* Secondary PCI DMA Write */</span><span class="cp"></span>
<span class="cp">#define  SABRE_CEAFSR_ESYND	 0x00ff000000000000UL	</span><span class="cm">/* ECC Syndrome */</span><span class="cp"></span>
<span class="cp">#define  SABRE_CEAFSR_BMSK	 0x0000ffff00000000UL	</span><span class="cm">/* Bytemask */</span><span class="cp"></span>
<span class="cp">#define  SABRE_CEAFSR_OFF	 0x00000000e0000000UL	</span><span class="cm">/* Offset */</span><span class="cp"></span>
<span class="cp">#define  SABRE_CEAFSR_BLK	 0x0000000000800000UL	</span><span class="cm">/* Was block operation */</span><span class="cp"></span>
<span class="cp">#define SABRE_UECE_AFAR_ALIAS	0x0048UL	</span><span class="cm">/* Aliases to 0x0038 */</span><span class="cp"></span>
<span class="cp">#define SABRE_IOMMU_CONTROL	0x0200UL</span>
<span class="cp">#define  SABRE_IOMMUCTRL_ERRSTS	 0x0000000006000000UL	</span><span class="cm">/* Error status bits */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUCTRL_ERR	 0x0000000001000000UL	</span><span class="cm">/* Error present in IOTLB */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUCTRL_LCKEN	 0x0000000000800000UL	</span><span class="cm">/* IOTLB lock enable */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUCTRL_LCKPTR	 0x0000000000780000UL	</span><span class="cm">/* IOTLB lock pointer */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUCTRL_TSBSZ	 0x0000000000070000UL	</span><span class="cm">/* TSB Size */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMU_TSBSZ_1K   0x0000000000000000</span>
<span class="cp">#define  SABRE_IOMMU_TSBSZ_2K   0x0000000000010000</span>
<span class="cp">#define  SABRE_IOMMU_TSBSZ_4K   0x0000000000020000</span>
<span class="cp">#define  SABRE_IOMMU_TSBSZ_8K   0x0000000000030000</span>
<span class="cp">#define  SABRE_IOMMU_TSBSZ_16K  0x0000000000040000</span>
<span class="cp">#define  SABRE_IOMMU_TSBSZ_32K  0x0000000000050000</span>
<span class="cp">#define  SABRE_IOMMU_TSBSZ_64K  0x0000000000060000</span>
<span class="cp">#define  SABRE_IOMMU_TSBSZ_128K 0x0000000000070000</span>
<span class="cp">#define  SABRE_IOMMUCTRL_TBWSZ	 0x0000000000000004UL	</span><span class="cm">/* TSB assumed page size */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUCTRL_DENAB	 0x0000000000000002UL	</span><span class="cm">/* Diagnostic Mode Enable */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUCTRL_ENAB	 0x0000000000000001UL	</span><span class="cm">/* IOMMU Enable */</span><span class="cp"></span>
<span class="cp">#define SABRE_IOMMU_TSBBASE	0x0208UL</span>
<span class="cp">#define SABRE_IOMMU_FLUSH	0x0210UL</span>
<span class="cp">#define SABRE_IMAP_A_SLOT0	0x0c00UL</span>
<span class="cp">#define SABRE_IMAP_B_SLOT0	0x0c20UL</span>
<span class="cp">#define SABRE_IMAP_SCSI		0x1000UL</span>
<span class="cp">#define SABRE_IMAP_ETH		0x1008UL</span>
<span class="cp">#define SABRE_IMAP_BPP		0x1010UL</span>
<span class="cp">#define SABRE_IMAP_AU_REC	0x1018UL</span>
<span class="cp">#define SABRE_IMAP_AU_PLAY	0x1020UL</span>
<span class="cp">#define SABRE_IMAP_PFAIL	0x1028UL</span>
<span class="cp">#define SABRE_IMAP_KMS		0x1030UL</span>
<span class="cp">#define SABRE_IMAP_FLPY		0x1038UL</span>
<span class="cp">#define SABRE_IMAP_SHW		0x1040UL</span>
<span class="cp">#define SABRE_IMAP_KBD		0x1048UL</span>
<span class="cp">#define SABRE_IMAP_MS		0x1050UL</span>
<span class="cp">#define SABRE_IMAP_SER		0x1058UL</span>
<span class="cp">#define SABRE_IMAP_UE		0x1070UL</span>
<span class="cp">#define SABRE_IMAP_CE		0x1078UL</span>
<span class="cp">#define SABRE_IMAP_PCIERR	0x1080UL</span>
<span class="cp">#define SABRE_IMAP_GFX		0x1098UL</span>
<span class="cp">#define SABRE_IMAP_EUPA		0x10a0UL</span>
<span class="cp">#define SABRE_ICLR_A_SLOT0	0x1400UL</span>
<span class="cp">#define SABRE_ICLR_B_SLOT0	0x1480UL</span>
<span class="cp">#define SABRE_ICLR_SCSI		0x1800UL</span>
<span class="cp">#define SABRE_ICLR_ETH		0x1808UL</span>
<span class="cp">#define SABRE_ICLR_BPP		0x1810UL</span>
<span class="cp">#define SABRE_ICLR_AU_REC	0x1818UL</span>
<span class="cp">#define SABRE_ICLR_AU_PLAY	0x1820UL</span>
<span class="cp">#define SABRE_ICLR_PFAIL	0x1828UL</span>
<span class="cp">#define SABRE_ICLR_KMS		0x1830UL</span>
<span class="cp">#define SABRE_ICLR_FLPY		0x1838UL</span>
<span class="cp">#define SABRE_ICLR_SHW		0x1840UL</span>
<span class="cp">#define SABRE_ICLR_KBD		0x1848UL</span>
<span class="cp">#define SABRE_ICLR_MS		0x1850UL</span>
<span class="cp">#define SABRE_ICLR_SER		0x1858UL</span>
<span class="cp">#define SABRE_ICLR_UE		0x1870UL</span>
<span class="cp">#define SABRE_ICLR_CE		0x1878UL</span>
<span class="cp">#define SABRE_ICLR_PCIERR	0x1880UL</span>
<span class="cp">#define SABRE_WRSYNC		0x1c20UL</span>
<span class="cp">#define SABRE_PCICTRL		0x2000UL</span>
<span class="cp">#define  SABRE_PCICTRL_MRLEN	 0x0000001000000000UL	</span><span class="cm">/* Use MemoryReadLine for block loads/stores */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCICTRL_SERR	 0x0000000400000000UL	</span><span class="cm">/* Set when SERR asserted on PCI bus */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCICTRL_ARBPARK	 0x0000000000200000UL	</span><span class="cm">/* Bus Parking 0=Ultra-IIi 1=prev-bus-owner */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCICTRL_CPUPRIO	 0x0000000000100000UL	</span><span class="cm">/* Ultra-IIi granted every other bus cycle */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCICTRL_ARBPRIO	 0x00000000000f0000UL	</span><span class="cm">/* Slot which is granted every other bus cycle */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCICTRL_ERREN	 0x0000000000000100UL	</span><span class="cm">/* PCI Error Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCICTRL_RTRYWE	 0x0000000000000080UL	</span><span class="cm">/* DMA Flow Control 0=wait-if-possible 1=retry */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCICTRL_AEN	 0x000000000000000fUL	</span><span class="cm">/* Slot PCI arbitration enables */</span><span class="cp"></span>
<span class="cp">#define SABRE_PIOAFSR		0x2010UL</span>
<span class="cp">#define  SABRE_PIOAFSR_PMA	 0x8000000000000000UL	</span><span class="cm">/* Primary Master Abort */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_PTA	 0x4000000000000000UL	</span><span class="cm">/* Primary Target Abort */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_PRTRY	 0x2000000000000000UL	</span><span class="cm">/* Primary Excessive Retries */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_PPERR	 0x1000000000000000UL	</span><span class="cm">/* Primary Parity Error */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_SMA	 0x0800000000000000UL	</span><span class="cm">/* Secondary Master Abort */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_STA	 0x0400000000000000UL	</span><span class="cm">/* Secondary Target Abort */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_SRTRY	 0x0200000000000000UL	</span><span class="cm">/* Secondary Excessive Retries */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_SPERR	 0x0100000000000000UL	</span><span class="cm">/* Secondary Parity Error */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_BMSK	 0x0000ffff00000000UL	</span><span class="cm">/* Byte Mask */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PIOAFSR_BLK	 0x0000000080000000UL	</span><span class="cm">/* Was Block Operation */</span><span class="cp"></span>
<span class="cp">#define SABRE_PIOAFAR		0x2018UL</span>
<span class="cp">#define SABRE_PCIDIAG		0x2020UL</span>
<span class="cp">#define  SABRE_PCIDIAG_DRTRY	 0x0000000000000040UL	</span><span class="cm">/* Disable PIO Retry Limit */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCIDIAG_IPAPAR	 0x0000000000000008UL	</span><span class="cm">/* Invert PIO Address Parity */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCIDIAG_IPDPAR	 0x0000000000000004UL	</span><span class="cm">/* Invert PIO Data Parity */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCIDIAG_IDDPAR	 0x0000000000000002UL	</span><span class="cm">/* Invert DMA Data Parity */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCIDIAG_ELPBK	 0x0000000000000001UL	</span><span class="cm">/* Loopback Enable - not supported */</span><span class="cp"></span>
<span class="cp">#define SABRE_PCITASR		0x2028UL</span>
<span class="cp">#define  SABRE_PCITASR_EF	 0x0000000000000080UL	</span><span class="cm">/* Respond to 0xe0000000-0xffffffff */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCITASR_CD	 0x0000000000000040UL	</span><span class="cm">/* Respond to 0xc0000000-0xdfffffff */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCITASR_AB	 0x0000000000000020UL	</span><span class="cm">/* Respond to 0xa0000000-0xbfffffff */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCITASR_89	 0x0000000000000010UL	</span><span class="cm">/* Respond to 0x80000000-0x9fffffff */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCITASR_67	 0x0000000000000008UL	</span><span class="cm">/* Respond to 0x60000000-0x7fffffff */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCITASR_45	 0x0000000000000004UL	</span><span class="cm">/* Respond to 0x40000000-0x5fffffff */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCITASR_23	 0x0000000000000002UL	</span><span class="cm">/* Respond to 0x20000000-0x3fffffff */</span><span class="cp"></span>
<span class="cp">#define  SABRE_PCITASR_01	 0x0000000000000001UL	</span><span class="cm">/* Respond to 0x00000000-0x1fffffff */</span><span class="cp"></span>
<span class="cp">#define SABRE_PIOBUF_DIAG	0x5000UL</span>
<span class="cp">#define SABRE_DMABUF_DIAGLO	0x5100UL</span>
<span class="cp">#define SABRE_DMABUF_DIAGHI	0x51c0UL</span>
<span class="cp">#define SABRE_IMAP_GFX_ALIAS	0x6000UL	</span><span class="cm">/* Aliases to 0x1098 */</span><span class="cp"></span>
<span class="cp">#define SABRE_IMAP_EUPA_ALIAS	0x8000UL	</span><span class="cm">/* Aliases to 0x10a0 */</span><span class="cp"></span>
<span class="cp">#define SABRE_IOMMU_VADIAG	0xa400UL</span>
<span class="cp">#define SABRE_IOMMU_TCDIAG	0xa408UL</span>
<span class="cp">#define SABRE_IOMMU_TAG		0xa580UL</span>
<span class="cp">#define  SABRE_IOMMUTAG_ERRSTS	 0x0000000001800000UL	</span><span class="cm">/* Error status bits */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUTAG_ERR	 0x0000000000400000UL	</span><span class="cm">/* Error present */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUTAG_WRITE	 0x0000000000200000UL	</span><span class="cm">/* Page is writable */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUTAG_STREAM	 0x0000000000100000UL	</span><span class="cm">/* Streamable bit - unused */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUTAG_SIZE	 0x0000000000080000UL	</span><span class="cm">/* 0=8k 1=16k */</span><span class="cp"></span>
<span class="cp">#define  SABRE_IOMMUTAG_VPN	 0x000000000007ffffUL	</span><span class="cm">/* Virtual Page Number [31:13] */</span><span class="cp"></span>
<span class="cp">#define SABRE_IOMMU_DATA	0xa600UL</span>
<span class="cp">#define SABRE_IOMMUDATA_VALID	 0x0000000040000000UL	</span><span class="cm">/* Valid */</span><span class="cp"></span>
<span class="cp">#define SABRE_IOMMUDATA_USED	 0x0000000020000000UL	</span><span class="cm">/* Used (for LRU algorithm) */</span><span class="cp"></span>
<span class="cp">#define SABRE_IOMMUDATA_CACHE	 0x0000000010000000UL	</span><span class="cm">/* Cacheable */</span><span class="cp"></span>
<span class="cp">#define SABRE_IOMMUDATA_PPN	 0x00000000001fffffUL	</span><span class="cm">/* Physical Page Number [33:13] */</span><span class="cp"></span>
<span class="cp">#define SABRE_PCI_IRQSTATE	0xa800UL</span>
<span class="cp">#define SABRE_OBIO_IRQSTATE	0xa808UL</span>
<span class="cp">#define SABRE_FFBCFG		0xf000UL</span>
<span class="cp">#define  SABRE_FFBCFG_SPRQS	 0x000000000f000000	</span><span class="cm">/* Slave P_RQST queue size */</span><span class="cp"></span>
<span class="cp">#define  SABRE_FFBCFG_ONEREAD	 0x0000000000004000	</span><span class="cm">/* Slave supports one outstanding read */</span><span class="cp"></span>
<span class="cp">#define SABRE_MCCTRL0		0xf010UL</span>
<span class="cp">#define  SABRE_MCCTRL0_RENAB	 0x0000000080000000	</span><span class="cm">/* Refresh Enable */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL0_EENAB	 0x0000000010000000	</span><span class="cm">/* Enable all ECC functions */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL0_11BIT	 0x0000000000001000	</span><span class="cm">/* Enable 11-bit column addressing */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL0_DPP	 0x0000000000000f00	</span><span class="cm">/* DIMM Pair Present Bits */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL0_RINTVL	 0x00000000000000ff	</span><span class="cm">/* Refresh Interval */</span><span class="cp"></span>
<span class="cp">#define SABRE_MCCTRL1		0xf018UL</span>
<span class="cp">#define  SABRE_MCCTRL1_AMDC	 0x0000000038000000	</span><span class="cm">/* Advance Memdata Clock */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_ARDC	 0x0000000007000000	</span><span class="cm">/* Advance DRAM Read Data Clock */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_CSR	 0x0000000000e00000	</span><span class="cm">/* CAS to RAS delay for CBR refresh */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_CASRW	 0x00000000001c0000	</span><span class="cm">/* CAS length for read/write */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_RCD	 0x0000000000038000	</span><span class="cm">/* RAS to CAS delay */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_CP	 0x0000000000007000	</span><span class="cm">/* CAS Precharge */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_RP	 0x0000000000000e00	</span><span class="cm">/* RAS Precharge */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_RAS	 0x00000000000001c0	</span><span class="cm">/* Length of RAS for refresh */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_CASRW2	 0x0000000000000038	</span><span class="cm">/* Must be same as CASRW */</span><span class="cp"></span>
<span class="cp">#define  SABRE_MCCTRL1_RSC	 0x0000000000000007	</span><span class="cm">/* RAS after CAS hold time */</span><span class="cp"></span>
<span class="cp">#define SABRE_RESETCTRL		0xf020UL</span>

<span class="cp">#define SABRE_CONFIGSPACE	0x001000000UL</span>
<span class="cp">#define SABRE_IOSPACE		0x002000000UL</span>
<span class="cp">#define SABRE_IOSPACE_SIZE	0x000ffffffUL</span>
<span class="cp">#define SABRE_MEMSPACE		0x100000000UL</span>
<span class="cp">#define SABRE_MEMSPACE_SIZE	0x07fffffffUL</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hummingbird_p</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">sabre_root_bus</span><span class="p">;</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sabre_ue_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_UE_AFSR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_UECE_AFAR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">;</span>

	<span class="cm">/* Latch uncorrectable error status. */</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>
	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Clear the primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SABRE_UEAFSR_PDRD</span> <span class="o">|</span> <span class="n">SABRE_UEAFSR_PDWR</span> <span class="o">|</span>
		 <span class="n">SABRE_UEAFSR_SDRD</span> <span class="o">|</span> <span class="n">SABRE_UEAFSR_SDWR</span> <span class="o">|</span>
		 <span class="n">SABRE_UEAFSR_SDTE</span> <span class="o">|</span> <span class="n">SABRE_UEAFSR_PDTE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Uncorrectable Error, primary error type[%s%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_PDRD</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;DMA Read&quot;</span> <span class="o">:</span>
		<span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_PDWR</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;DMA Write&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)),</span>
	       <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_PDTE</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;:Translation Error&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bytemask[%04lx] dword_offset[%lx] was_block(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_BMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_OFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">29UL</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_BLK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: UE AFAR [%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: UE Secondary errors [&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_SDRD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA Read)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_SDWR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA Write)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_UEAFSR_SDTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Translation Error)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Interrogate IOMMU for error status. */</span>
	<span class="n">psycho_check_iommu_error</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">UE_ERR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sabre_ce_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_CE_AFSR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afar_reg</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_UECE_AFAR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">afsr</span><span class="p">,</span> <span class="n">afar</span><span class="p">,</span> <span class="n">error_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reported</span><span class="p">;</span>

	<span class="cm">/* Latch error status. */</span>
	<span class="n">afar</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afar_reg</span><span class="p">);</span>
	<span class="n">afsr</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Clear primary/secondary error status bits. */</span>
	<span class="n">error_bits</span> <span class="o">=</span> <span class="n">afsr</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SABRE_CEAFSR_PDRD</span> <span class="o">|</span> <span class="n">SABRE_CEAFSR_PDWR</span> <span class="o">|</span>
		 <span class="n">SABRE_CEAFSR_SDRD</span> <span class="o">|</span> <span class="n">SABRE_CEAFSR_SDWR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">error_bits</span><span class="p">,</span> <span class="n">afsr_reg</span><span class="p">);</span>

	<span class="cm">/* Log the error. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Correctable Error, primary error type[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SABRE_CEAFSR_PDRD</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;DMA Read&quot;</span> <span class="o">:</span>
		<span class="p">((</span><span class="n">error_bits</span> <span class="o">&amp;</span> <span class="n">SABRE_CEAFSR_PDWR</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;DMA Write&quot;</span> <span class="o">:</span> <span class="s">&quot;???&quot;</span><span class="p">)));</span>

	<span class="cm">/* XXX Use syndrome and afar to print out module string just like</span>
<span class="cm">	 * XXX UDB CE trap handler does... -DaveM</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: syndrome[%02lx] bytemask[%04lx] dword_offset[%lx] &quot;</span>
	       <span class="s">&quot;was_block(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_CEAFSR_ESYND</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">48UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_CEAFSR_BMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32UL</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_CEAFSR_OFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">29UL</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_CEAFSR_BLK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: CE AFAR [%016lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">afar</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: CE Secondary errors [&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">reported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_CEAFSR_SDRD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA Read)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">afsr</span> <span class="o">&amp;</span> <span class="n">SABRE_CEAFSR_SDWR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reported</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(DMA Write)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reported</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(none)&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sabre_register_error_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">PBM_CHIP_TYPE_SABRE</span><span class="p">)</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">dp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Sabre/Hummingbird IRQ property layout is:</span>
<span class="cm">	 * 0: PCI ERR</span>
<span class="cm">	 * 1: UE ERR</span>
<span class="cm">	 * 2: CE ERR</span>
<span class="cm">	 * 3: POWER FAIL</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">num_irqs</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We clear the error bits in the appropriate AFSR before</span>
<span class="cm">	 * registering the handler so that we don&#39;t get spurious</span>
<span class="cm">	 * interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SABRE_UEAFSR_PDRD</span> <span class="o">|</span> <span class="n">SABRE_UEAFSR_PDWR</span> <span class="o">|</span>
		    <span class="n">SABRE_UEAFSR_SDRD</span> <span class="o">|</span> <span class="n">SABRE_UEAFSR_SDWR</span> <span class="o">|</span>
		    <span class="n">SABRE_UEAFSR_SDTE</span> <span class="o">|</span> <span class="n">SABRE_UEAFSR_PDTE</span><span class="p">),</span>
		   <span class="n">base</span> <span class="o">+</span> <span class="n">SABRE_UE_AFSR</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sabre_ue_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;SABRE_UE&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Couldn&#39;t register UE, err=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SABRE_CEAFSR_PDRD</span> <span class="o">|</span> <span class="n">SABRE_CEAFSR_PDWR</span> <span class="o">|</span>
		    <span class="n">SABRE_CEAFSR_SDRD</span> <span class="o">|</span> <span class="n">SABRE_CEAFSR_SDWR</span><span class="p">),</span>
		   <span class="n">base</span> <span class="o">+</span> <span class="n">SABRE_CE_AFSR</span><span class="p">);</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sabre_ce_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;SABRE_CE&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Couldn&#39;t register CE, err=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">psycho_pcierr_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="s">&quot;SABRE_PCIERR&quot;</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Couldn&#39;t register PCIERR, err=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">upa_readq</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SABRE_PCICTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SABRE_PCICTRL_ERREN</span><span class="p">;</span>
	<span class="n">upa_writeq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SABRE_PCICTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">apb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">sabre_bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sabre_bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SUN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_SUN_SIMBA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">word16</span><span class="p">;</span>

			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word16</span><span class="p">);</span>
			<span class="n">word16</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_SERR</span> <span class="o">|</span> <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span>
				<span class="n">PCI_COMMAND_MASTER</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span>
				<span class="n">PCI_COMMAND_IO</span><span class="p">;</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">word16</span><span class="p">);</span>

			<span class="cm">/* Status register bits are &quot;write 1 to clear&quot;. */</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_SEC_STATUS</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

			<span class="cm">/* Use a primary/seconday latency timer value</span>
<span class="cm">			 * of 64.</span>
<span class="cm">			 */</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_SEC_LATENCY_TIMER</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

			<span class="cm">/* Enable reporting/forwarding of master aborts,</span>
<span class="cm">			 * parity, and SERR.</span>
<span class="cm">			 */</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">PCI_BRIDGE_CTL_PARITY</span> <span class="o">|</span>
					       <span class="n">PCI_BRIDGE_CTL_SERR</span> <span class="o">|</span>
					       <span class="n">PCI_BRIDGE_CTL_MASTER_ABORT</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">sabre_scan_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">once</span><span class="p">;</span>

	<span class="cm">/* The APB bridge speaks to the Sabre host PCI bridge</span>
<span class="cm">	 * at 66Mhz, but the front side of APB runs at 33Mhz</span>
<span class="cm">	 * for both segments.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Hummingbird systems do not use APB, so they run</span>
<span class="cm">	 * at 66MHZ.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hummingbird_p</span><span class="p">)</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">is_66mhz_capable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">is_66mhz_capable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This driver has not been verified to handle</span>
<span class="cm">	 * multiple SABREs yet, so trap this.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also note that the SABRE host bridge is hardwired</span>
<span class="cm">	 * to live at bus 0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">once</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Multiple controllers unsupported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">once</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">pci_scan_one_pbm</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sabre_root_bus</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>

	<span class="n">apb_init</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>

	<span class="n">sabre_register_error_handlers</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">sabre_pbm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">psycho_pbm_init_common</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="s">&quot;SABRE&quot;</span><span class="p">,</span> <span class="n">PBM_CHIP_TYPE_SABRE</span><span class="p">);</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afsr</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_PIOAFSR</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_afar</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_PIOAFAR</span><span class="p">;</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">pci_csr</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_PCICTRL</span><span class="p">;</span>
	<span class="n">sabre_scan_bus</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">sabre_match</span><span class="p">[];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sabre_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_prom64_registers</span> <span class="o">*</span><span class="n">pr_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_pbm_info</span> <span class="o">*</span><span class="n">pbm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">upa_portid</span><span class="p">,</span> <span class="n">dma_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu</span> <span class="o">*</span><span class="n">iommu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tsbsize</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vdma</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">clear_irq</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">of_match_device</span><span class="p">(</span><span class="n">sabre_match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hummingbird_p</span> <span class="o">=</span> <span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hummingbird_p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">cpu_dp</span><span class="p">;</span>

		<span class="cm">/* Of course, Sun has to encode things a thousand</span>
<span class="cm">		 * different ways, inconsistently.</span>
<span class="cm">		 */</span>
		<span class="n">for_each_node_by_type</span><span class="p">(</span><span class="n">cpu_dp</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cpu_dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;SUNW,UltraSPARC-IIe&quot;</span><span class="p">))</span>
				<span class="n">hummingbird_p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pbm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pbm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Cannot allocate pci_pbm_info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iommu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iommu</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iommu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Cannot allocate PBM iommu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_controller</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">iommu</span><span class="p">;</span>

	<span class="n">upa_portid</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;upa-portid&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">portid</span> <span class="o">=</span> <span class="n">upa_portid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Map in SABRE register set and report the presence of this SABRE.</span>
<span class="cm">	 */</span>
	
	<span class="n">pr_regs</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pr_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;No reg property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_iommu</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * First REG in property is base of entire SABRE register space.</span>
<span class="cm">	 */</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">=</span> <span class="n">pr_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phys_addr</span><span class="p">;</span>

	<span class="cm">/* Clear interrupts */</span>

	<span class="cm">/* PCI first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">clear_irq</span> <span class="o">=</span> <span class="n">SABRE_ICLR_A_SLOT0</span><span class="p">;</span> <span class="n">clear_irq</span> <span class="o">&lt;</span> <span class="n">SABRE_ICLR_B_SLOT0</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">clear_irq</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mh">0x0UL</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">clear_irq</span><span class="p">);</span>

	<span class="cm">/* Then OBIO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">clear_irq</span> <span class="o">=</span> <span class="n">SABRE_ICLR_SCSI</span><span class="p">;</span> <span class="n">clear_irq</span> <span class="o">&lt;</span> <span class="n">SABRE_ICLR_SCSI</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">clear_irq</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">upa_writeq</span><span class="p">(</span><span class="mh">0x0UL</span><span class="p">,</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">clear_irq</span><span class="p">);</span>

	<span class="cm">/* Error interrupts are enabled later after the bus scan. */</span>
	<span class="n">upa_writeq</span><span class="p">((</span><span class="n">SABRE_PCICTRL_MRLEN</span>   <span class="o">|</span> <span class="n">SABRE_PCICTRL_SERR</span> <span class="o">|</span>
		    <span class="n">SABRE_PCICTRL_ARBPARK</span> <span class="o">|</span> <span class="n">SABRE_PCICTRL_AEN</span><span class="p">),</span>
		   <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_PCICTRL</span><span class="p">);</span>

	<span class="cm">/* Now map in PCI config space for entire SABRE. */</span>
	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">config_space</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">-&gt;</span><span class="n">controller_regs</span> <span class="o">+</span> <span class="n">SABRE_CONFIGSPACE</span><span class="p">;</span>

	<span class="n">vdma</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;virtual-dma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;No virtual-dma property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_iommu</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_mask</span> <span class="o">=</span> <span class="n">vdma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">vdma</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x20000000</span>:
			<span class="n">dma_mask</span> <span class="o">|=</span> <span class="mh">0x1fffffff</span><span class="p">;</span>
			<span class="n">tsbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x40000000</span>:
			<span class="n">dma_mask</span> <span class="o">|=</span> <span class="mh">0x3fffffff</span><span class="p">;</span>
			<span class="n">tsbsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x80000000</span>:
			<span class="n">dma_mask</span> <span class="o">|=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
			<span class="n">tsbsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Strange virtual-dma size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_iommu</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">psycho_iommu_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">tsbsize</span><span class="p">,</span> <span class="n">vdma</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dma_mask</span><span class="p">,</span> <span class="n">SABRE_WRSYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_iommu</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Look for APB underneath.</span>
<span class="cm">	 */</span>
	<span class="n">sabre_pbm_init</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>

	<span class="n">pbm</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pci_pbm_root</span><span class="p">;</span>
	<span class="n">pci_pbm_root</span> <span class="o">=</span> <span class="n">pbm</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_iommu:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pbm</span><span class="o">-&gt;</span><span class="n">iommu</span><span class="p">);</span>

<span class="nl">out_free_controller:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pbm</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">sabre_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;pci108e,a001&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;pci108e,a000&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sabre_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">sabre_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sabre_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sabre_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sabre_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">sabre_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
