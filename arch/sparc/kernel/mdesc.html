<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sparc › kernel › mdesc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mdesc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* mdesc.c: Sun4V machine description handling.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007, 2008 David S. Miller &lt;davem@davemloft.net&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &lt;asm/cpudata.h&gt;</span>
<span class="cp">#include &lt;asm/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/mdesc.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>

<span class="cm">/* Unlike the OBP device tree, the machine description is a full-on</span>
<span class="cm"> * DAG.  An arbitrary number of ARCs are possible from one</span>
<span class="cm"> * node to other nodes and thus we can&#39;t use the OBP device_node</span>
<span class="cm"> * data structure to represent these nodes inside of the kernel.</span>
<span class="cm"> *</span>
<span class="cm"> * Actually, it isn&#39;t even a DAG, because there are back pointers</span>
<span class="cm"> * which create cycles in the graph.</span>
<span class="cm"> *</span>
<span class="cm"> * mdesc_hdr and mdesc_elem describe the layout of the data structure</span>
<span class="cm"> * we get from the Hypervisor.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mdesc_hdr</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">version</span><span class="p">;</span> <span class="cm">/* Transport version */</span>
	<span class="n">u32</span>	<span class="n">node_sz</span><span class="p">;</span> <span class="cm">/* node block size */</span>
	<span class="n">u32</span>	<span class="n">name_sz</span><span class="p">;</span> <span class="cm">/* name block size */</span>
	<span class="n">u32</span>	<span class="n">data_sz</span><span class="p">;</span> <span class="cm">/* data block size */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">16</span><span class="p">)));</span>

<span class="k">struct</span> <span class="n">mdesc_elem</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">tag</span><span class="p">;</span>
<span class="cp">#define MD_LIST_END	0x00</span>
<span class="cp">#define MD_NODE		0x4e</span>
<span class="cp">#define MD_NODE_END	0x45</span>
<span class="cp">#define MD_NOOP		0x20</span>
<span class="cp">#define MD_PROP_ARC	0x61</span>
<span class="cp">#define MD_PROP_VAL	0x76</span>
<span class="cp">#define MD_PROP_STR	0x73</span>
<span class="cp">#define MD_PROP_DATA	0x64</span>
	<span class="n">u8</span>	<span class="n">name_len</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">resv</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">name_offset</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">data_len</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">data_offset</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">u64</span>	<span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">d</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mdesc_mem_ops</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mdesc_size</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">free</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mdesc_mem_ops</span>	<span class="o">*</span><span class="n">mops</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">self_base</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">refcnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">handle_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mdesc_hdr</span>	<span class="n">mdesc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdesc_handle_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handle_size</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">16UL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">handle_size</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">self_base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">handle_size</span> <span class="o">=</span> <span class="n">handle_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">mdesc_memblock_alloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mdesc_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handle_size</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="n">handle_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span><span class="p">)</span> <span class="o">-</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_hdr</span><span class="p">)</span> <span class="o">+</span>
		       <span class="n">mdesc_size</span><span class="p">);</span>
	<span class="n">alloc_size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">handle_size</span><span class="p">);</span>

	<span class="n">paddr</span> <span class="o">=</span> <span class="n">memblock_alloc</span><span class="p">(</span><span class="n">alloc_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp</span> <span class="o">=</span> <span class="n">__va</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
		<span class="n">mdesc_handle_init</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">handle_size</span><span class="p">,</span> <span class="n">hp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">hp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mdesc_memblock_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alloc_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">));</span>

	<span class="n">alloc_size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">handle_size</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="n">free_bootmem_late</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mdesc_mem_ops</span> <span class="n">memblock_mdesc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">mdesc_memblock_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span>  <span class="o">=</span> <span class="n">mdesc_memblock_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="nf">mdesc_kmalloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mdesc_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handle_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">handle_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span><span class="p">)</span> <span class="o">-</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_hdr</span><span class="p">)</span> <span class="o">+</span>
		       <span class="n">mdesc_size</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">handle_size</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_NOFAIL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">15UL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15UL</span><span class="p">;</span>
		<span class="n">hp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>

		<span class="n">mdesc_handle_init</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">handle_size</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">hp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdesc_kfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">self_base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mdesc_mem_ops</span> <span class="n">kmalloc_mdesc_memops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">mdesc_kmalloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span>  <span class="o">=</span> <span class="n">mdesc_kfree</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="nf">mdesc_alloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mdesc_size</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mdesc_mem_ops</span> <span class="o">*</span><span class="n">mops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">mops</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">mdesc_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="p">)</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">mops</span> <span class="o">=</span> <span class="n">mops</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdesc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">mops</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">cur_mdesc</span><span class="p">;</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">mdesc_zombie_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">mdesc_lock</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="nf">mdesc_grab</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp</span> <span class="o">=</span> <span class="n">cur_mdesc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hp</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mdesc_grab</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">mdesc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">mops</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mdesc_release</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mdesc_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mdesc_notifier_client</span> <span class="o">*</span><span class="n">client_list</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">mdesc_register_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_notifier_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">node</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_mutex</span><span class="p">);</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">client_list</span><span class="p">;</span>
	<span class="n">client_list</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">mdesc_for_each_node_by_name</span><span class="p">(</span><span class="n">cur_mdesc</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">)</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">cur_mdesc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="nf">parent_cfg_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">a</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mdesc_for_each_arc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">MDESC_ARC_TYPE_BACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">target</span><span class="p">;</span>

		<span class="n">target</span> <span class="o">=</span> <span class="n">mdesc_arc_target</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
					<span class="s">&quot;cfg-handle&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Run &#39;func&#39; on nodes which are in A but not in B.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">invoke_on_missing</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="p">,</span> <span class="n">u64</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">node</span><span class="p">;</span>

	<span class="n">mdesc_for_each_node_by_name</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_vdc_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_prop</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">fnode</span><span class="p">;</span>

		<span class="n">name_prop</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name_prop</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name_prop</span><span class="p">,</span> <span class="s">&quot;vdc-port&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">is_vdc_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">parent_cfg_handle</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MD: Cannot find ID for %s node.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">name_prop</span> <span class="o">?</span> <span class="n">name_prop</span> <span class="o">:</span> <span class="n">name</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mdesc_for_each_node_by_name</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">fnode</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">fid</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_vdc_port</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">name_prop</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">fnode</span><span class="p">,</span>
							       <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name_prop</span> <span class="o">||</span>
				    <span class="n">strcmp</span><span class="p">(</span><span class="n">name_prop</span><span class="p">,</span> <span class="s">&quot;vdc-port&quot;</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">fid</span> <span class="o">=</span> <span class="n">parent_cfg_handle</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">fnode</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fid</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MD: Cannot find ID &quot;</span>
					       <span class="s">&quot;for vdc-port node.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">fid</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">fnode</span><span class="p">,</span>
							 <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">==</span> <span class="o">*</span><span class="n">fid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">notify_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_notifier_client</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">old_hp</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">new_hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">invoke_on_missing</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">old_hp</span><span class="p">,</span> <span class="n">new_hp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">);</span>
	<span class="n">invoke_on_missing</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">new_hp</span><span class="p">,</span> <span class="n">old_hp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdesc_notify_clients</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">old_hp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">new_hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_notifier_client</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">client_list</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">notify_one</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">old_hp</span><span class="p">,</span> <span class="n">new_hp</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mdesc_update</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">real_len</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="o">*</span><span class="n">orig_hp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_mutex</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">sun4v_mach_desc</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="n">mdesc_alloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kmalloc_mdesc_memops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MD: mdesc alloc fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sun4v_mach_desc</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">real_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">HV_EOK</span> <span class="o">||</span> <span class="n">real_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MD: mdesc reread fails with %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">status</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
		<span class="n">mdesc_free</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">orig_hp</span> <span class="o">=</span> <span class="n">cur_mdesc</span><span class="p">;</span>
	<span class="n">cur_mdesc</span> <span class="o">=</span> <span class="n">hp</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mdesc_notify_clients</span><span class="p">(</span><span class="n">orig_hp</span><span class="p">,</span> <span class="n">hp</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">orig_hp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">mdesc_free</span><span class="p">(</span><span class="n">orig_hp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">orig_hp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdesc_zombie_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mdesc_elem</span> <span class="o">*</span><span class="nf">node_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_hdr</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_elem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">mdesc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">name_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_hdr</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">node_block</span><span class="p">(</span><span class="n">mdesc</span><span class="p">))</span> <span class="o">+</span> <span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">node_sz</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">data_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_hdr</span> <span class="o">*</span><span class="n">mdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">name_block</span><span class="p">(</span><span class="n">mdesc</span><span class="p">))</span> <span class="o">+</span> <span class="n">mdesc</span><span class="o">-&gt;</span><span class="n">name_sz</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">mdesc_node_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
		       <span class="n">u64</span> <span class="n">from_node</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_elem</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">node_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span> <span class="o">=</span> <span class="n">name_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">last_node</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">.</span><span class="n">node_sz</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">from_node</span> <span class="o">==</span> <span class="n">MDESC_NODE_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">from_node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">from_node</span> <span class="o">&gt;=</span> <span class="n">last_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">MDESC_NODE_NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="n">from_node</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="n">last_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">MD_NODE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">MDESC_NODE_NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">names</span> <span class="o">+</span> <span class="n">ep</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">name_offset</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">last_node</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">MDESC_NODE_NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mdesc_node_by_name</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">mdesc_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">node</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lenp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span> <span class="o">=</span> <span class="n">name_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">last_node</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">.</span><span class="n">node_sz</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mdesc_elem</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">MDESC_NODE_NULL</span> <span class="o">||</span> <span class="n">node</span> <span class="o">&gt;=</span> <span class="n">last_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">node_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">)</span> <span class="o">+</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">MD_NODE_END</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MD_PROP_VAL</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MD_PROP_STR</span>:
		<span class="k">case</span> <span class="n">MD_PROP_DATA</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_offset</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data_len</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">names</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name_offset</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lenp</span><span class="p">)</span>
				<span class="o">*</span><span class="n">lenp</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mdesc_get_property</span><span class="p">);</span>

<span class="n">u64</span> <span class="nf">mdesc_next_arc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">from</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arc_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_elem</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">node_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span> <span class="o">=</span> <span class="n">name_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">last_node</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">.</span><span class="n">node_sz</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">==</span> <span class="n">MDESC_NODE_NULL</span> <span class="o">||</span> <span class="n">from</span> <span class="o">&gt;=</span> <span class="n">last_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MDESC_NODE_NULL</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">from</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">MD_NODE_END</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">MD_PROP_ARC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">names</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name_offset</span><span class="p">,</span> <span class="n">arc_type</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">ep</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">MDESC_NODE_NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mdesc_next_arc</span><span class="p">);</span>

<span class="n">u64</span> <span class="nf">mdesc_arc_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">arc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_elem</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">node_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">arc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mdesc_arc_target</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">mdesc_node_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_elem</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">node_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span> <span class="o">=</span> <span class="n">name_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">last_node</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">.</span><span class="n">node_sz</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">MDESC_NODE_NULL</span> <span class="o">||</span> <span class="n">node</span> <span class="o">&gt;=</span> <span class="n">last_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">node</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">MD_NODE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">names</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name_offset</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mdesc_node_name</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">max_cpus</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">report_platform_properties</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">mdesc_grab</span><span class="p">();</span>
	<span class="n">u64</span> <span class="n">pn</span> <span class="o">=</span> <span class="n">mdesc_node_by_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">MDESC_NODE_NULL</span><span class="p">,</span> <span class="s">&quot;platform&quot;</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pn</span> <span class="o">==</span> <span class="n">MDESC_NODE_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;No platform node in machine-description.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;banner-name&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: banner-name [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: name [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;hostid&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: hostid [%08llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;serial#&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: serial# [%08llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;stick-frequency&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: stick-frequency [%08llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;mac-address&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: mac-address [%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;watchdog-resolution&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: watchdog-resolution [%llu ms]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;watchdog-max-timeout&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: watchdog-max-timeout [%llu ms]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="s">&quot;max-cpus&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_cpus</span> <span class="o">=</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PLATFORM: max-cpus [%llu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_cpus</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_cpu</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_cpu</span> <span class="o">=</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max_cpu</span> <span class="o">&gt;</span> <span class="n">NR_CPUS</span><span class="p">)</span>
				<span class="n">max_cpu</span> <span class="o">=</span> <span class="n">NR_CPUS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">max_cpu</span> <span class="o">=</span> <span class="n">NR_CPUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cpu</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">set_cpu_possible</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">mdesc_release</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">fill_in_one_cache</span><span class="p">(</span><span class="n">cpuinfo_sparc</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span>
					<span class="n">u64</span> <span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">level</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;level&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">line_size</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;line-size&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type_len</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type_len</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">of_find_in_proplist</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;instn&quot;</span><span class="p">,</span> <span class="n">type_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">icache_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">icache_line_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">line_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_find_in_proplist</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="n">type_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">dcache_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">dcache_line_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">line_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">ecache_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">ecache_line_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">line_size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">a</span><span class="p">;</span>

		<span class="n">mdesc_for_each_arc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">MDESC_ARC_TYPE_FWD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">target</span> <span class="o">=</span> <span class="n">mdesc_arc_target</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">mdesc_node_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cache&quot;</span><span class="p">))</span>
				<span class="n">fill_in_one_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">mark_core_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">core_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">a</span><span class="p">;</span>

	<span class="n">mdesc_for_each_arc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">MDESC_ARC_TYPE_BACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">t</span> <span class="o">=</span> <span class="n">mdesc_arc_target</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">mdesc_node_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">NR_CPUS</span><span class="p">)</span>
				<span class="n">cpu_data</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">).</span><span class="n">core_id</span> <span class="o">=</span> <span class="n">core_id</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">mdesc_for_each_arc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">MDESC_ARC_TYPE_BACK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u64</span> <span class="n">n</span> <span class="o">=</span> <span class="n">mdesc_arc_target</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">n_name</span><span class="p">;</span>

				<span class="n">n_name</span> <span class="o">=</span> <span class="n">mdesc_node_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">n_name</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">id</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">NR_CPUS</span><span class="p">)</span>
					<span class="n">cpu_data</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">).</span><span class="n">core_id</span> <span class="o">=</span> <span class="n">core_id</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">set_core_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mp</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mdesc_for_each_node_by_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;cache&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">level</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">level</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;level&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_find_in_proplist</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;instn&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mark_core_ids</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">mark_proc_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proc_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">a</span><span class="p">;</span>

	<span class="n">mdesc_for_each_arc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">MDESC_ARC_TYPE_BACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">t</span> <span class="o">=</span> <span class="n">mdesc_arc_target</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">mdesc_node_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">id</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">NR_CPUS</span><span class="p">)</span>
			<span class="n">cpu_data</span><span class="p">(</span><span class="o">*</span><span class="n">id</span><span class="p">).</span><span class="n">proc_id</span> <span class="o">=</span> <span class="n">proc_id</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">__set_proc_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">exec_unit_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mp</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdesc_for_each_node_by_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">exec_unit_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_find_in_proplist</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">of_find_in_proplist</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;integer&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mark_proc_ids</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">set_proc_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__set_proc_ids</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="s">&quot;exec_unit&quot;</span><span class="p">);</span>
	<span class="n">__set_proc_ids</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="s">&quot;exec-unit&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">get_one_mondo_bits</span><span class="p">(</span><span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">def</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">use_default</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">use_default</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64U</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1U</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">use_default:</span>
	<span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">def</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64U</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1U</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">get_mondo_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">trap_per_cpu</span> <span class="o">*</span><span class="n">tb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;q-cpu-mondo-#bits&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">get_one_mondo_bits</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">cpu_mondo_qmask</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">max_cpus</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;q-dev-mondo-#bits&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">get_one_mondo_bits</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">dev_mondo_qmask</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;q-resumable-#bits&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">get_one_mondo_bits</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">resum_qmask</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;q-nonresumable-#bits&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">get_one_mondo_bits</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">nonresum_qmask</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SUN4V: Mondo queue sizes &quot;</span>
			<span class="s">&quot;[cpu(%u) dev(%u) r(%u) nr(%u)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tb</span><span class="o">-&gt;</span><span class="n">cpu_mondo_qmask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">tb</span><span class="o">-&gt;</span><span class="n">dev_mondo_qmask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">tb</span><span class="o">-&gt;</span><span class="n">resum_qmask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">tb</span><span class="o">-&gt;</span><span class="n">nonresum_qmask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">__cpuinit</span> <span class="nf">mdesc_iterate_over_cpus</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">cpumask_t</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">mdesc_grab</span><span class="p">();</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mp</span><span class="p">;</span>

	<span class="n">mdesc_for_each_node_by_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">cpuid</span> <span class="o">=</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpuid</span> <span class="o">&gt;=</span> <span class="n">NR_CPUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Ignoring CPU %d which is &quot;</span>
			       <span class="s">&quot;&gt;= NR_CPUS (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cpuid</span><span class="p">,</span> <span class="n">NR_CPUS</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">cpuid</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">cpuid</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mdesc_release</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">__cpuinit</span> <span class="nf">record_one_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpuid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ncpus_probed</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">set_cpu_present</span><span class="p">(</span><span class="n">cpuid</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">mdesc_populate_present_mask</span><span class="p">(</span><span class="n">cpumask_t</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_type</span> <span class="o">!=</span> <span class="n">hypervisor</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ncpus_probed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdesc_iterate_over_cpus</span><span class="p">(</span><span class="n">record_one_cpu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">__cpuinit</span> <span class="nf">fill_in_one_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpuid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cfreq</span> <span class="o">=</span> <span class="n">mdesc_get_property</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="s">&quot;clock-frequency&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">trap_per_cpu</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>
	<span class="n">cpuinfo_sparc</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">a</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_SMP</span>
	<span class="cm">/* On uniprocessor we only want the values for the</span>
<span class="cm">	 * real physical cpu the kernel booted onto, however</span>
<span class="cm">	 * cpu_data() only has one entry at index 0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpuid</span> <span class="o">!=</span> <span class="n">real_hard_smp_processor_id</span><span class="p">())</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cpuid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_data</span><span class="p">(</span><span class="n">cpuid</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">clock_tick</span> <span class="o">=</span> <span class="o">*</span><span class="n">cfreq</span><span class="p">;</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trap_block</span><span class="p">[</span><span class="n">cpuid</span><span class="p">];</span>
	<span class="n">get_mondo_data</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tb</span><span class="p">);</span>

	<span class="n">mdesc_for_each_arc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">MDESC_ARC_TYPE_FWD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">mdesc_arc_target</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">t_name</span><span class="p">;</span>

		<span class="n">t_name</span> <span class="o">=</span> <span class="n">mdesc_node_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">t_name</span><span class="p">,</span> <span class="s">&quot;cache&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fill_in_one_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mdesc_for_each_arc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">MDESC_ARC_TYPE_FWD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">n</span> <span class="o">=</span> <span class="n">mdesc_arc_target</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">n_name</span><span class="p">;</span>

			<span class="n">n_name</span> <span class="o">=</span> <span class="n">mdesc_node_name</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">n_name</span><span class="p">,</span> <span class="s">&quot;cache&quot;</span><span class="p">))</span>
				<span class="n">fill_in_one_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">core_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">proc_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">mdesc_fill_in_cpu_data</span><span class="p">(</span><span class="n">cpumask_t</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>

	<span class="n">mdesc_iterate_over_cpus</span><span class="p">(</span><span class="n">fill_in_one_cpu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">sparc64_multi_core</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="n">mdesc_grab</span><span class="p">();</span>

	<span class="n">set_core_ids</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="n">set_proc_ids</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="n">mdesc_release</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="n">smp_fill_in_sib_core_maps</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mdesc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">mdesc_grab</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">handle_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">handle_size</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">handle_size</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">mdesc_release</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mdesc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="n">mdesc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">mdesc_misc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span>	<span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;mdesc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mdesc_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mdesc_misc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdesc_misc</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">mdesc_misc_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">sun4v_mdesc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdesc_handle</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">real_len</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">sun4v_mach_desc</span><span class="p">(</span><span class="mi">0UL</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MDESC: Size is %lu bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="n">mdesc_alloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">memblock_mdesc_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;MDESC: alloc of %lu bytes failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sun4v_mach_desc</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mdesc</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">real_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">HV_EOK</span> <span class="o">||</span> <span class="n">real_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;sun4v_mach_desc fails, err(%lu), &quot;</span>
			    <span class="s">&quot;len(%lu), real_len(%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">real_len</span><span class="p">);</span>
		<span class="n">mdesc_free</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
		<span class="n">prom_halt</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">cur_mdesc</span> <span class="o">=</span> <span class="n">hp</span><span class="p">;</span>

	<span class="n">report_platform_properties</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
