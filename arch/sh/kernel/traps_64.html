<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sh › kernel › traps_64.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps_64.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/sh/kernel/traps_64.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000, 2001  Paolo Alberelli</span>
<span class="cm"> * Copyright (C) 2003, 2004  Paul Mundt</span>
<span class="cm"> * Copyright (C) 2003, 2004  Richard Curnow</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/perf_event.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/fpu.h&gt;</span>

<span class="cp">#undef DEBUG_EXCEPTION</span>
<span class="cp">#ifdef DEBUG_EXCEPTION</span>
<span class="cm">/* implemented in ../lib/dbg.c */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">show_excp_regs</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trapnr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">signr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define show_excp_regs(a, b, c, d)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_unhandled_exception</span><span class="p">(</span><span class="kt">int</span> <span class="n">trapnr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">signr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fn_name</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">);</span>

<span class="cp">#define DO_ERROR(trapnr, signr, str, name, tsk) \</span>
<span class="cp">asmlinkage void do_##name(unsigned long error_code, struct pt_regs *regs) \</span>
<span class="cp">{ \</span>
<span class="cp">	do_unhandled_exception(trapnr, signr, str, __stringify(name), error_code, regs, current); \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">die_lock</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">console_verbose</span><span class="p">();</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die_lock</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">));</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die_lock</span><span class="p">);</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">die_if_kernel</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">die</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">die_if_no_fixup</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">exception_table_entry</span> <span class="o">*</span><span class="n">fixup</span><span class="p">;</span>
		<span class="n">fixup</span> <span class="o">=</span> <span class="n">search_exception_tables</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fixup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">fixup</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">die</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">DO_ERROR</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">,</span>  <span class="s">&quot;illegal slot instruction&quot;</span><span class="p">,</span> <span class="n">illegal_slot_inst</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
<span class="n">DO_ERROR</span><span class="p">(</span><span class="mi">87</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="s">&quot;address error (exec)&quot;</span><span class="p">,</span> <span class="n">address_error_exec</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>


<span class="cm">/* Implement misaligned load/store handling for kernel (and optionally for user</span>
<span class="cm">   mode too).  Limitation : only SHmedia mode code is handled - there is no</span>
<span class="cm">   handling at all for misaligned accesses occurring in SHcompact code yet. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">misaligned_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">do_address_error_load</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misaligned_fixup</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_unhandled_exception</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="s">&quot;address error(load)&quot;</span><span class="p">,</span>
				<span class="s">&quot;do_address_error_load&quot;</span><span class="p">,</span>
				<span class="n">error_code</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">do_address_error_store</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misaligned_fixup</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_unhandled_exception</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="s">&quot;address error(store)&quot;</span><span class="p">,</span>
				<span class="s">&quot;do_address_error_store&quot;</span><span class="p">,</span>
				<span class="n">error_code</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SH64_ID2815_WORKAROUND)</span>

<span class="cp">#define OPCODE_INVALID      0</span>
<span class="cp">#define OPCODE_USER_VALID   1</span>
<span class="cp">#define OPCODE_PRIV_VALID   2</span>

<span class="cm">/* getcon/putcon - requires checking which control register is referenced. */</span>
<span class="cp">#define OPCODE_CTRL_REG     3</span>

<span class="cm">/* Table of valid opcodes for SHmedia mode.</span>
<span class="cm">   Form a 10-bit value by concatenating the major/minor opcodes i.e.</span>
<span class="cm">   opcode[31:26,20:16].  The 6 MSBs of this value index into the following</span>
<span class="cm">   array.  The 4 LSBs select the bit-pair in the entry (bits 1:0 correspond to</span>
<span class="cm">   LSBs==4&#39;b0000 etc). */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">shmedia_opcode_table</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x55554044</span><span class="p">,</span><span class="mh">0x54445055</span><span class="p">,</span><span class="mh">0x15141514</span><span class="p">,</span><span class="mh">0x14541414</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x10001000</span><span class="p">,</span><span class="mh">0x01110055</span><span class="p">,</span><span class="mh">0x04050015</span><span class="p">,</span>
	<span class="mh">0x00000444</span><span class="p">,</span><span class="mh">0xc0000000</span><span class="p">,</span><span class="mh">0x44545515</span><span class="p">,</span><span class="mh">0x40405555</span><span class="p">,</span><span class="mh">0x55550015</span><span class="p">,</span><span class="mh">0x10005555</span><span class="p">,</span><span class="mh">0x55555505</span><span class="p">,</span><span class="mh">0x04050000</span><span class="p">,</span>
	<span class="mh">0x00000555</span><span class="p">,</span><span class="mh">0x00000404</span><span class="p">,</span><span class="mh">0x00040445</span><span class="p">,</span><span class="mh">0x15151414</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span>
	<span class="mh">0x00000055</span><span class="p">,</span><span class="mh">0x40404444</span><span class="p">,</span><span class="mh">0x00000404</span><span class="p">,</span><span class="mh">0xc0009495</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span>
	<span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span>
	<span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span>
	<span class="mh">0x80005050</span><span class="p">,</span><span class="mh">0x04005055</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span>
	<span class="mh">0x81055554</span><span class="p">,</span><span class="mh">0x00000404</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x55555555</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span><span class="mh">0x00000000</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">do_reserved_inst</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Workaround SH5-101 cut2 silicon defect #2815 :</span>
<span class="cm">	   in some situations, inter-mode branches from SHcompact -&gt; SHmedia</span>
<span class="cm">	   which should take ITLBMISS or EXECPROT exceptions at the target</span>
<span class="cm">	   falsely take RESINST at the target instead. */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x6ff4fff0</span><span class="p">;</span> <span class="cm">/* guaranteed reserved opcode */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">,</span> <span class="n">aligned_pc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">get_user_error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">trapnr</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">signr</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">exception_name</span> <span class="o">=</span> <span class="s">&quot;reserved_instruction&quot;</span><span class="p">;</span>

	<span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SHmedia : check for defect.  This requires executable vmas</span>
<span class="cm">		   to be readable too. */</span>
		<span class="n">aligned_pc</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">aligned_pc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">get_user_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">get_user_error</span> <span class="o">=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">aligned_pc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user_error</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">combined</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reserved_field</span><span class="p">;</span>
			<span class="n">reserved_field</span> <span class="o">=</span> <span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span> <span class="cm">/* These bits are currently reserved as zero in all valid opcodes */</span>
			<span class="n">major</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">minor</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">combined</span> <span class="o">=</span> <span class="p">(</span><span class="n">major</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">minor</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">major</span><span class="p">;</span>
			<span class="n">shift</span> <span class="o">=</span> <span class="n">minor</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reserved_field</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">opcode_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">shmedia_opcode_table</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">opcode_state</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">OPCODE_INVALID</span>:
						<span class="cm">/* Trap. */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">OPCODE_USER_VALID</span>:
						<span class="cm">/* Restart the instruction : the branch to the instruction will now be from an RTE</span>
<span class="cm">						   not from SHcompact so the silicon defect won&#39;t be triggered. */</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">OPCODE_PRIV_VALID</span>:
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
							<span class="cm">/* Should only ever get here if a module has</span>
<span class="cm">							   SHcompact code inside it.  If so, the same fix up is needed. */</span>
							<span class="k">return</span><span class="p">;</span> <span class="cm">/* same reason */</span>
						<span class="p">}</span>
						<span class="cm">/* Otherwise, user mode trying to execute a privileged instruction -</span>
<span class="cm">						   fall through to trap. */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">OPCODE_CTRL_REG</span>:
						<span class="cm">/* If in privileged mode, return as above. */</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
						<span class="cm">/* In user mode ... */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">combined</span> <span class="o">==</span> <span class="mh">0x9f</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* GETCON */</span>
							<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regno</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">62</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">return</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="cm">/* Otherwise, reserved or privileged control register, =&gt; trap */</span>
						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">combined</span> <span class="o">==</span> <span class="mh">0x1bf</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* PUTCON */</span>
							<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regno</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">62</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">return</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="cm">/* Otherwise, reserved or privileged control register, =&gt; trap */</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="cm">/* Trap */</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="nl">default:</span>
						<span class="cm">/* Fall through to trap. */</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* fall through to normal resinst processing */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Error trying to read opcode.  This typically means a</span>
<span class="cm">			   real fault, not a RESINST any more.  So change the</span>
<span class="cm">			   codes. */</span>
			<span class="n">trapnr</span> <span class="o">=</span> <span class="mi">87</span><span class="p">;</span>
			<span class="n">exception_name</span> <span class="o">=</span> <span class="s">&quot;address error (exec)&quot;</span><span class="p">;</span>
			<span class="n">signr</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">do_unhandled_exception</span><span class="p">(</span><span class="n">trapnr</span><span class="p">,</span> <span class="n">signr</span><span class="p">,</span> <span class="n">exception_name</span><span class="p">,</span> <span class="s">&quot;do_reserved_inst&quot;</span><span class="p">,</span> <span class="n">error_code</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_SH64_ID2815_WORKAROUND */</span><span class="cp"></span>

<span class="cm">/* If the workaround isn&#39;t needed, this is just a straightforward reserved</span>
<span class="cm">   instruction */</span>
<span class="n">DO_ERROR</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">,</span>  <span class="s">&quot;reserved instruction&quot;</span><span class="p">,</span> <span class="n">reserved_inst</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SH64_ID2815_WORKAROUND */</span><span class="cp"></span>

<span class="cm">/* Called with interrupts disabled */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">do_exception_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ex</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_excp_regs</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">do_unknown_trapa</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scId</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Syscall debug */</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;System call ID error: [0x1#args:8 #syscall:16  0x%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scId</span><span class="p">);</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;unknown trapa&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">scId</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_KALLSYMS</span>
	<span class="k">extern</span> <span class="kt">void</span> <span class="n">sh64_unwind</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">tsk</span> <span class="o">?</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">kregs</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sh64_unwind</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t backtrace on sh64 without CONFIG_KALLSYMS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">show_task</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_stack</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">dump_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_task</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* Needed by any user of WARN_ON in view of the defn in include/asm-sh/bug.h */</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dump_stack</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_unhandled_exception</span><span class="p">(</span><span class="kt">int</span> <span class="n">trapnr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">signr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fn_name</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_excp_regs</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="n">trapnr</span><span class="p">,</span> <span class="n">signr</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">force_sig</span><span class="p">(</span><span class="n">signr</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>

	<span class="n">die_if_no_fixup</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">error_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_opcode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">result_opcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from_user_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">get_user_error</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_pc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SHmedia */</span>
		<span class="n">aligned_pc</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">from_user_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">aligned_pc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">get_user_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">get_user_error</span> <span class="o">=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">aligned_pc</span><span class="p">);</span>
				<span class="o">*</span><span class="n">result_opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">get_user_error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If the fault was in the kernel, we can either read</span>
<span class="cm">			 * this directly, or if not, we fault.</span>
<span class="cm">			*/</span>
			<span class="o">*</span><span class="n">result_opcode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">aligned_pc</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SHcompact */</span>
		<span class="cm">/* TODO : provide handling for this.  We don&#39;t really support</span>
<span class="cm">		   user-mode SHcompact yet, and for a kernel fault, this would</span>
<span class="cm">		   have to come from a module built for SHcompact.  */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* misaligned */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">address_is_sign_extended</span><span class="p">(</span><span class="n">__u64</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">b</span><span class="p">;</span>
<span class="cp">#if (NEFF == 32)</span>
	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)(</span><span class="n">__s64</span><span class="p">)(</span><span class="n">__s32</span><span class="p">)(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xffffffffUL</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">a</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Sign extend check only works for NEFF==32&quot;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">generate_and_check_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
				      <span class="n">__u32</span> <span class="n">opcode</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">displacement_not_indexed</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">width_shift</span><span class="p">,</span>
				      <span class="n">__u64</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* return -1 for fault, 0 for OK */</span>

	<span class="n">__u64</span> <span class="n">base_address</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">basereg</span><span class="p">;</span>

	<span class="n">basereg</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">base_address</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">basereg</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">displacement_not_indexed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__s64</span> <span class="n">displacement</span><span class="p">;</span>
		<span class="n">displacement</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="n">displacement</span> <span class="o">=</span> <span class="p">((</span><span class="n">displacement</span> <span class="o">&lt;&lt;</span> <span class="mi">54</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">54</span><span class="p">);</span> <span class="cm">/* sign extend */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)((</span><span class="n">__s64</span><span class="p">)</span><span class="n">base_address</span> <span class="o">+</span> <span class="p">(</span><span class="n">displacement</span> <span class="o">&lt;&lt;</span> <span class="n">width_shift</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">offset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">offsetreg</span><span class="p">;</span>
		<span class="n">offsetreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">offsetreg</span><span class="p">];</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">base_address</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check sign extended */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">address_is_sign_extended</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check accessible.  For misaligned access in the kernel, assume the</span>
<span class="cm">	   address is always accessible (and if not, just fault when the</span>
<span class="cm">	   load/store gets done.) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">TASK_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Do access_ok check later - it depends on whether it&#39;s a load or a store. */</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">user_mode_unaligned_fixup_count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">user_mode_unaligned_fixup_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">kernel_mode_unaligned_fixup_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">misaligned_kernel_word_load</span><span class="p">(</span><span class="n">__u64</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_sign_extend</span><span class="p">,</span> <span class="n">__u64</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>
	<span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_sign_extend</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)(</span><span class="n">__s64</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">misaligned_kernel_word_store</span><span class="p">(</span><span class="n">__u64</span> <span class="n">address</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">misaligned_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			   <span class="n">__u32</span> <span class="n">opcode</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">displacement_not_indexed</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">width_shift</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">do_sign_extend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Return -1 for a fault, 0 for OK */</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">destreg</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">generate_and_check_address</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
			<span class="n">displacement_not_indexed</span><span class="p">,</span> <span class="n">width_shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">perf_sw_event</span><span class="p">(</span><span class="n">PERF_COUNT_SW_ALIGNMENT_FAULTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

	<span class="n">destreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">address</span><span class="p">,</span> <span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">width_shift</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__copy_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">width_shift</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* fault */</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">width_shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">do_sign_extend</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)(</span><span class="n">__s64</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">__s16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)(</span><span class="n">__s64</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">__s32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unexpected width_shift %d in misaligned_load, PC=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">width_shift</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* kernel mode - we can take short cuts since if we fault, it&#39;s a genuine bug */</span>
		<span class="n">__u64</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">width_shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">misaligned_kernel_word_load</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">do_sign_extend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">asm</span> <span class="p">(</span><span class="s">&quot;ldlo.l %1, 0, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">lo</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="n">asm</span> <span class="p">(</span><span class="s">&quot;ldhi.l %1, 3, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">hi</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">|</span> <span class="n">hi</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">asm</span> <span class="p">(</span><span class="s">&quot;ldlo.q %1, 0, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">lo</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="n">asm</span> <span class="p">(</span><span class="s">&quot;ldhi.q %1, 7, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">hi</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">|</span> <span class="n">hi</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unexpected width_shift %d in misaligned_load, PC=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">width_shift</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">misaligned_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			    <span class="n">__u32</span> <span class="n">opcode</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">displacement_not_indexed</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">width_shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Return -1 for a fault, 0 for OK */</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">srcreg</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">generate_and_check_address</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
			<span class="n">displacement_not_indexed</span><span class="p">,</span> <span class="n">width_shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">perf_sw_event</span><span class="p">(</span><span class="n">PERF_COUNT_SW_ALIGNMENT_FAULTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

	<span class="n">srcreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">address</span><span class="p">,</span> <span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">width_shift</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">width_shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">srcreg</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">srcreg</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">srcreg</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unexpected width_shift %d in misaligned_store, PC=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">width_shift</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__copy_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">width_shift</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* fault */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* kernel mode - we can take short cuts since if we fault, it&#39;s a genuine bug */</span>
		<span class="n">__u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">srcreg</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">width_shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">misaligned_kernel_word_store</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">asm</span> <span class="p">(</span><span class="s">&quot;stlo.l %1, 0, %0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="n">asm</span> <span class="p">(</span><span class="s">&quot;sthi.l %1, 3, %0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">asm</span> <span class="p">(</span><span class="s">&quot;stlo.q %1, 0, %0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="n">asm</span> <span class="p">(</span><span class="s">&quot;sthi.q %1, 7, %0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">address</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unexpected width_shift %d in misaligned_store, PC=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">width_shift</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Never need to fix up misaligned FPU accesses within the kernel since that&#39;s a real</span>
<span class="cm">   error. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">misaligned_fpu_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			   <span class="n">__u32</span> <span class="n">opcode</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">displacement_not_indexed</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">width_shift</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">do_paired_load</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Return -1 for a fault, 0 for OK */</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">destreg</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">generate_and_check_address</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
			<span class="n">displacement_not_indexed</span><span class="p">,</span> <span class="n">width_shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">perf_sw_event</span><span class="p">(</span><span class="n">PERF_COUNT_SW_EMULATION_FAULTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

	<span class="n">destreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">buflo</span><span class="p">,</span> <span class="n">bufhi</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">address</span><span class="p">,</span> <span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">width_shift</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__copy_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">width_shift</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* fault */</span>
		<span class="p">}</span>
		<span class="cm">/* &#39;current&#39; may be the current owner of the FPU state, so</span>
<span class="cm">		   context switch the registers into memory so they can be</span>
<span class="cm">		   indexed by register number. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_task_used_math</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable_fpu</span><span class="p">();</span>
			<span class="n">save_fpu</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="n">disable_fpu</span><span class="p">();</span>
			<span class="n">last_task_used_math</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">|=</span> <span class="n">SR_FD</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buflo</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">bufhi</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">width_shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">buflo</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">do_paired_load</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">buflo</span><span class="p">;</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">destreg</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bufhi</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_CPU_LITTLE_ENDIAN)</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">bufhi</span><span class="p">;</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">destreg</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buflo</span><span class="p">;</span>
<span class="cp">#else</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">destreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">buflo</span><span class="p">;</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">destreg</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bufhi</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unexpected width_shift %d in misaligned_fpu_load, PC=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">width_shift</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">die</span> <span class="p">(</span><span class="s">&quot;Misaligned FPU load inside kernel&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>


<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">misaligned_fpu_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			   <span class="n">__u32</span> <span class="n">opcode</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">displacement_not_indexed</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">width_shift</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">do_paired_load</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Return -1 for a fault, 0 for OK */</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">srcreg</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">generate_and_check_address</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
			<span class="n">displacement_not_indexed</span><span class="p">,</span> <span class="n">width_shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">perf_sw_event</span><span class="p">(</span><span class="n">PERF_COUNT_SW_EMULATION_FAULTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

	<span class="n">srcreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="cm">/* Initialise these to NaNs. */</span>
		<span class="n">__u32</span> <span class="n">buflo</span><span class="o">=</span><span class="mh">0xffffffffUL</span><span class="p">,</span> <span class="n">bufhi</span><span class="o">=</span><span class="mh">0xffffffffUL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">address</span><span class="p">,</span> <span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">width_shift</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* &#39;current&#39; may be the current owner of the FPU state, so</span>
<span class="cm">		   context switch the registers into memory so they can be</span>
<span class="cm">		   indexed by register number. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_task_used_math</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable_fpu</span><span class="p">();</span>
			<span class="n">save_fpu</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="n">disable_fpu</span><span class="p">();</span>
			<span class="n">last_task_used_math</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">|=</span> <span class="n">SR_FD</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">width_shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">buflo</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">srcreg</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">do_paired_load</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buflo</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">srcreg</span><span class="p">];</span>
				<span class="n">bufhi</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">srcreg</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_CPU_LITTLE_ENDIAN)</span>
				<span class="n">bufhi</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">srcreg</span><span class="p">];</span>
				<span class="n">buflo</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">srcreg</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="cp">#else</span>
				<span class="n">buflo</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">srcreg</span><span class="p">];</span>
				<span class="n">bufhi</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">hardfpu</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">srcreg</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unexpected width_shift %d in misaligned_fpu_store, PC=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">width_shift</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">(</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buflo</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">)</span> <span class="o">=</span> <span class="n">bufhi</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__copy_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">width_shift</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* fault */</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">die</span> <span class="p">(</span><span class="s">&quot;Misaligned FPU load inside kernel&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">misaligned_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode_unaligned_fixup_enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">read_opcode</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">major</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">user_mode_unaligned_fixup_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">--</span><span class="n">user_mode_unaligned_fixup_count</span><span class="p">;</span>
		<span class="cm">/* Only do &#39;count&#39; worth of these reports, to remove a potential DoS against syslog */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Fixing up unaligned userspace access in </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> pid=%d pc=0x%08x ins=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">kernel_mode_unaligned_fixup_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">--</span><span class="n">kernel_mode_unaligned_fixup_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Fixing up unaligned kernelspace access in interrupt pc=0x%08x ins=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Fixing up unaligned kernelspace access in </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> pid=%d pc=0x%08x ins=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">major</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0x84</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* LD.W */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0xb0</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* LD.UW */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0x88</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* LD.L */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0x8c</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* LD.Q */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="p">(</span><span class="mh">0xa4</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* ST.W */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0xa8</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* ST.L */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0xac</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* ST.Q */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="p">(</span><span class="mh">0x40</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* indexed loads */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x1</span>: <span class="cm">/* LDX.W */</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x5</span>: <span class="cm">/* LDX.UW */</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x2</span>: <span class="cm">/* LDX.L */</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x3</span>: <span class="cm">/* LDX.Q */</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="p">(</span><span class="mh">0x60</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* indexed stores */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x1</span>: <span class="cm">/* STX.W */</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x2</span>: <span class="cm">/* STX.L */</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x3</span>: <span class="cm">/* STX.Q */</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="p">(</span><span class="mh">0x94</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* FLD.S */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0x98</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* FLD.P */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0x9c</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* FLD.D */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0x1c</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* floating indexed loads */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x8</span>: <span class="cm">/* FLDX.S */</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xd</span>: <span class="cm">/* FLDX.P */</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x9</span>: <span class="cm">/* FLDX.D */</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_load</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0xb4</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* FLD.S */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0xb8</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* FLD.P */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0xbc</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* FLD.D */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0x3c</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* floating indexed stores */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x8</span>: <span class="cm">/* FSTX.S */</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xd</span>: <span class="cm">/* FSTX.P */</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x9</span>: <span class="cm">/* FSTX.D */</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">misaligned_fpu_store</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* Fault */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Skip the instruction that&#39;s just been emulated */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">unaligned_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;kernel_reports&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">kernel_mode_unaligned_fixup_count</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;user_reports&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">user_mode_unaligned_fixup_count</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;user_enable&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">user_mode_unaligned_fixup_enable</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">unaligned_root</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;unaligned_fixup&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">unaligned_table</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">sh64_root</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;sh64&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">unaligned_root</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">sysctl_header</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_sysctl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysctl_header</span> <span class="o">=</span> <span class="n">register_sysctl_table</span><span class="p">(</span><span class="n">sh64_root</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">init_sysctl</span><span class="p">);</span>


<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">do_debug_interrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">peek_real_address_q</span><span class="p">(</span><span class="n">u64</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">poke_real_address_q</span><span class="p">(</span><span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">DM_EXP_CAUSE_PHY</span> <span class="o">=</span> <span class="mh">0x0c100010</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">exp_cause</span><span class="p">;</span>
	<span class="cm">/* It&#39;s not worth ioremapping the debug module registers for the amount</span>
<span class="cm">	   of access we make to them - just go direct to their physical</span>
<span class="cm">	   addresses. */</span>
	<span class="n">exp_cause</span> <span class="o">=</span> <span class="n">peek_real_address_q</span><span class="p">(</span><span class="n">DM_EXP_CAUSE_PHY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp_cause</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DM.EXP_CAUSE had unexpected bits set (=%08lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">exp_cause</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">show_state</span><span class="p">();</span>
	<span class="cm">/* Clear all DEBUGINT causes */</span>
	<span class="n">poke_real_address_q</span><span class="p">(</span><span class="n">DM_EXP_CAUSE_PHY</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">per_cpu_trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do for now, VBR initialization later. */</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
