<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sh › boards › board-magicpanelr2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>board-magicpanelr2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/arch/sh/boards/magicpanel/setup.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007  Markus Brunner, Mark Jonas</span>
<span class="cm"> *</span>
<span class="cm"> *  Magic Panel Release 2 board setup</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/smsc911x.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/physmap.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/map.h&gt;</span>
<span class="cp">#include &lt;linux/sh_intc.h&gt;</span>
<span class="cp">#include &lt;mach/magicpanelr2.h&gt;</span>
<span class="cp">#include &lt;asm/heartbeat.h&gt;</span>
<span class="cp">#include &lt;cpu/sh7720.h&gt;</span>

<span class="cp">#define LAN9115_READY	(__raw_readl(0xA8000084UL) &amp; 0x00000001UL)</span>

<span class="cm">/* Wait until reset finished. Timeout is 100ms. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ethernet_reset_finished</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LAN9115_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LAN9115_READY</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reset_ethernet</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* PMDR: LAN_RESET=on */</span>
	<span class="n">CLRBITS_OUTB</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">PORT_PMDR</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* PMDR: LAN_RESET=off */</span>
	<span class="n">SETBITS_OUTB</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">PORT_PMDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_chip_select</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* CS2: LAN (0x08000000 - 0x0bffffff) */</span>
	<span class="cm">/* no idle cycles, normal space, 8 bit data bus */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x36db0400</span><span class="p">,</span> <span class="n">CS2BCR</span><span class="p">);</span>
	<span class="cm">/* (SW:1.5 WR:3 HW:1.5), ext. wait */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x000003c0</span><span class="p">,</span> <span class="n">CS2WCR</span><span class="p">);</span>

	<span class="cm">/* CS4: CAN1 (0xb0000000 - 0xb3ffffff) */</span>
	<span class="cm">/* no idle cycles, normal space, 8 bit data bus */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000200</span><span class="p">,</span> <span class="n">CS4BCR</span><span class="p">);</span>
	<span class="cm">/* (SW:1.5 WR:3 HW:1.5), ext. wait */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00100981</span><span class="p">,</span> <span class="n">CS4WCR</span><span class="p">);</span>

	<span class="cm">/* CS5a: CAN2 (0xb4000000 - 0xb5ffffff) */</span>
	<span class="cm">/* no idle cycles, normal space, 8 bit data bus */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000200</span><span class="p">,</span> <span class="n">CS5ABCR</span><span class="p">);</span>
	<span class="cm">/* (SW:1.5 WR:3 HW:1.5), ext. wait */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00100981</span><span class="p">,</span> <span class="n">CS5AWCR</span><span class="p">);</span>

	<span class="cm">/* CS5b: CAN3 (0xb6000000 - 0xb7ffffff) */</span>
	<span class="cm">/* no idle cycles, normal space, 8 bit data bus */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000200</span><span class="p">,</span> <span class="n">CS5BBCR</span><span class="p">);</span>
	<span class="cm">/* (SW:1.5 WR:3 HW:1.5), ext. wait */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00100981</span><span class="p">,</span> <span class="n">CS5BWCR</span><span class="p">);</span>

	<span class="cm">/* CS6a: Rotary (0xb8000000 - 0xb9ffffff) */</span>
	<span class="cm">/* no idle cycles, normal space, 8 bit data bus */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000200</span><span class="p">,</span> <span class="n">CS6ABCR</span><span class="p">);</span>
	<span class="cm">/* (SW:1.5 WR:3 HW:1.5), no ext. wait */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x001009C1</span><span class="p">,</span> <span class="n">CS6AWCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_port_multiplexing</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* A7 GPO(LED8);     A6 GPO(LED7);     A5 GPO(LED6);	  A4 GPO(LED5);</span>
<span class="cm">	 * A3 GPO(LED4);     A2 GPO(LED3);     A1 GPO(LED2);	  A0 GPO(LED1);</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x5555</span><span class="p">,</span> <span class="n">PORT_PACR</span><span class="p">);</span>	<span class="cm">/* 01 01 01 01 01 01 01 01 */</span>

	<span class="cm">/* B7 GPO(RST4);   B6 GPO(RST3);  B5 GPO(RST2);    B4 GPO(RST1);</span>
<span class="cm">	 * B3 GPO(PB3);	   B2 GPO(PB2);	  B1 GPO(PB1);	   B0 GPO(PB0);</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x5555</span><span class="p">,</span> <span class="n">PORT_PBCR</span><span class="p">);</span>	<span class="cm">/* 01 01 01 01 01 01 01 01 */</span>

	<span class="cm">/* C7 GPO(PC7);	  C6 GPO(PC6);	  C5 GPO(PC5);	   C4 GPO(PC4);</span>
<span class="cm">	 * C3 LCD_DATA3;  C2 LCD_DATA2;   C1 LCD_DATA1;	   C0 LCD_DATA0;</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x5500</span><span class="p">,</span> <span class="n">PORT_PCCR</span><span class="p">);</span>	<span class="cm">/* 01 01 01 01 00 00 00 00 */</span>

	<span class="cm">/* D7 GPO(PD7);	D6 GPO(PD6);	D5 GPO(PD5);	   D4 GPO(PD4);</span>
<span class="cm">	 * D3 GPO(PD3);	D2 GPO(PD2);	D1 GPO(PD1);	   D0 GPO(PD0);</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x5555</span><span class="p">,</span> <span class="n">PORT_PDCR</span><span class="p">);</span>	<span class="cm">/* 01 01 01 01 01 01 01 01 */</span>

	<span class="cm">/* E7 (x);	  E6 GPI(nu);	 E5 GPI(nu);	  E4 LCD_M_DISP;</span>
<span class="cm">	 * E3 LCD_CL1;	  E2 LCD_CL2;	 E1 LCD_DON;	  E0 LCD_FLM;</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x3C00</span><span class="p">,</span> <span class="n">PORT_PECR</span><span class="p">);</span>	<span class="cm">/* 00 11 11 00 00 00 00 00 */</span>

	<span class="cm">/* F7 (x);	     F6 DA1(VLCD);     F5 DA0(nc);	  F4 AN3;</span>
<span class="cm">	 * F3 AN2(MID_AD);   F2 AN1(EARTH_AD); F1 AN0(TEMP);	  F0 GPI+(nc);</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0002</span><span class="p">,</span> <span class="n">PORT_PFCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 00 00 00 00 10 */</span>

	<span class="cm">/* G7 (x);	  G6 IRQ5(TOUCH_BUSY); G5 IRQ4(TOUCH_IRQ); G4 GPI(KEY2);</span>
<span class="cm">	 * G3 GPI(KEY1);  G2 GPO(LED11);	G1 GPO(LED10);     G0 GPO(LED9);</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x03D5</span><span class="p">,</span> <span class="n">PORT_PGCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 11 11 01 01 01 */</span>

	<span class="cm">/* H7 (x);	      H6 /RAS(BRAS);	  H5 /CAS(BCAS); H4 CKE(BCKE);</span>
<span class="cm">	 * H3 GPO(EARTH_OFF); H2 GPO(EARTH_TEST); H1 USB2_PWR;	 H0 USB1_PWR;</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0050</span><span class="p">,</span> <span class="n">PORT_PHCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 00 01 01 00 00 */</span>

	<span class="cm">/* J7 (x);	  J6 AUDCK;	   J5 ASEBRKAK;	    J4 AUDATA3;</span>
<span class="cm">	 * J3 AUDATA2;	  J2 AUDATA1;	   J1 AUDATA0;	    J0 AUDSYNC;</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">PORT_PJCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 00 00 00 00 00 */</span>

	<span class="cm">/* K7 (x);	    K6 (x);	     K5 (x);	   K4 (x);</span>
<span class="cm">	 * K3 PINT7(/PWR2); K2 PINT6(/PWR1); K1 PINT5(nu); K0 PINT4(FLASH_READY)</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x00FF</span><span class="p">,</span> <span class="n">PORT_PKCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 00 11 11 11 11 */</span>

	<span class="cm">/* L7 TRST;	   L6 TMS;	     L5 TDO;		  L4 TDI;</span>
<span class="cm">	 * L3 TCK;	   L2 (x);	     L1 (x);		  L0 (x);</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">PORT_PLCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 00 00 00 00 00 */</span>

	<span class="cm">/* M7 GPO(CURRENT_SINK);    M6 GPO(PWR_SWITCH);     M5 GPO(LAN_SPEED);</span>
<span class="cm">	 * M4 GPO(LAN_RESET);       M3 GPO(BUZZER);	    M2 GPO(LCD_BL);</span>
<span class="cm">	 * M1 CS5B(CAN3_CS);	    M0 GPI+(nc);</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x5552</span><span class="p">,</span> <span class="n">PORT_PMCR</span><span class="p">);</span>	   <span class="cm">/* 01 01 01 01 01 01 00 10 */</span>

	<span class="cm">/* CURRENT_SINK=off,	PWR_SWITCH=off, LAN_SPEED=100MBit,</span>
<span class="cm">	 * LAN_RESET=off,	BUZZER=off,	LCD_BL=off</span>
<span class="cm">	 */</span>
<span class="cp">#if CONFIG_SH_MAGIC_PANEL_R2_VERSION == 2</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">PORT_PMDR</span><span class="p">);</span>
<span class="cp">#elif CONFIG_SH_MAGIC_PANEL_R2_VERSION == 3</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0xF0</span><span class="p">,</span> <span class="n">PORT_PMDR</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#error Unknown revision of PLATFORM_MP_R2</span>
<span class="cp">#endif</span>

	<span class="cm">/* P7 (x);	       P6 (x);		  P5 (x);</span>
<span class="cm">	 * P4 GPO(nu);	       P3 IRQ3(LAN_IRQ);  P2 IRQ2(CAN3_IRQ);</span>
<span class="cm">	 * P1 IRQ1(CAN2_IRQ);  P0 IRQ0(CAN1_IRQ)</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0100</span><span class="p">,</span> <span class="n">PORT_PPCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 01 00 00 00 00 */</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">PORT_PPDR</span><span class="p">);</span>

	<span class="cm">/* R7 A25;	     R6 A24;	     R5 A23;		  R4 A22;</span>
<span class="cm">	 * R3 A21;	     R2 A20;	     R1 A19;		  R0 A0;</span>
<span class="cm">	 */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_A25</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_A24</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_A23</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_A22</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_A21</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_A20</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_A19</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_A0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* S7 (x);		S6 (x);        S5 (x);	     S4 GPO(EEPROM_CS2);</span>
<span class="cm">	 * S3 GPO(EEPROM_CS1);  S2 SIOF0_TXD;  S1 SIOF0_RXD; S0 SIOF0_SCK;</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0140</span><span class="p">,</span> <span class="n">PORT_PSCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 01 01 00 00 00 */</span>

	<span class="cm">/* T7 (x);	   T6 (x);	  T5 (x);	  T4 COM1_CTS;</span>
<span class="cm">	 * T3 COM1_RTS;	   T2 COM1_TXD;	  T1 COM1_RXD;	  T0 GPO(WDOG)</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">,</span> <span class="n">PORT_PTCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 00 00 00 00 01 */</span>

	<span class="cm">/* U7 (x);	     U6 (x);	   U5 (x);	  U4 GPI+(/AC_FAULT);</span>
<span class="cm">	 * U3 GPO(TOUCH_CS); U2 TOUCH_TXD; U1 TOUCH_RXD;  U0 TOUCH_SCK;</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0240</span><span class="p">,</span> <span class="n">PORT_PUCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 10 01 00 00 00 */</span>

	<span class="cm">/* V7 (x);	  V6 (x);	V5 (x);		  V4 GPO(MID2);</span>
<span class="cm">	 * V3 GPO(MID1);  V2 CARD_TxD;	V1 CARD_RxD;	  V0 GPI+(/BAT_FAULT);</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0142</span><span class="p">,</span> <span class="n">PORT_PVCR</span><span class="p">);</span>	<span class="cm">/* 00 00 00 01 01 00 00 10 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpr2_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">cmdline_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set Pin Select Register A:</span>
<span class="cm">	 * /PCC_CD1, /PCC_CD2,  PCC_BVD1, PCC_BVD2,</span>
<span class="cm">	 * /IOIS16,  IRQ4,	IRQ5,	  USB1d_SUSPEND</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0xAABC</span><span class="p">,</span> <span class="n">PORT_PSELA</span><span class="p">);</span>
	<span class="cm">/* set Pin Select Register B:</span>
<span class="cm">	 * /SCIF0_RTS, /SCIF0_CTS, LCD_VCPWC,</span>
<span class="cm">	 * LCD_VEPWC,  IIC_SDA,    IIC_SCL, Reserved</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x3C00</span><span class="p">,</span> <span class="n">PORT_PSELB</span><span class="p">);</span>
	<span class="cm">/* set Pin Select Register C:</span>
<span class="cm">	 * SIOF1_SCK, SIOF1_RxD, SCIF1_RxD, SCIF1_TxD, Reserved</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">PORT_PSELC</span><span class="p">);</span>
	<span class="cm">/* set Pin Select Register D: Reserved, SIOF1_TxD, Reserved, SIOF1_MCLK,</span>
<span class="cm">	 * Reserved, SIOF1_SYNC, Reserved, SCIF1_SCK, Reserved</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">PORT_PSELD</span><span class="p">);</span>
	<span class="cm">/* set USB TxRx Control: Reserved, DRV, Reserved, USB_TRANS, USB_SEL */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0101</span><span class="p">,</span> <span class="n">PORT_UTRCTL</span><span class="p">);</span>
	<span class="cm">/* set USB Clock Control: USSCS, USSTB, Reserved (HighByte always A5) */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0xA5C0</span><span class="p">,</span> <span class="n">PORT_UCLKCR_W</span><span class="p">);</span>

	<span class="n">setup_chip_select</span><span class="p">();</span>

	<span class="n">setup_port_multiplexing</span><span class="p">();</span>

	<span class="n">reset_ethernet</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Magic Panel Release 2 A.%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CONFIG_SH_MAGIC_PANEL_R2_VERSION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethernet_reset_finished</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Ethernet not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">smsc911x_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="mh">0xa8000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="mh">0xabffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x660</span><span class="p">),</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x660</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">smsc911x_platform_config</span> <span class="n">smsc911x_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">phy_interface</span>	<span class="o">=</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_polarity</span>	<span class="o">=</span> <span class="n">SMSC911X_IRQ_POLARITY_ACTIVE_LOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_type</span>	<span class="o">=</span> <span class="n">SMSC911X_IRQ_TYPE_OPEN_DRAIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SMSC911X_USE_32BIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">smsc911x_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;smsc911x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smsc911x_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">smsc911x_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smsc911x_config</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">heartbeat_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">PA_LED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">PA_LED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">heartbeat_data</span> <span class="n">heartbeat_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">HEARTBEAT_INVERTED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">heartbeat_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;heartbeat&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">heartbeat_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">heartbeat_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">heartbeat_resources</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">mpr2_partitions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Reserved for bootloader, read-only */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Bootloader&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x00000000UL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">MPR2_MTD_BOOTLOADER_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span> <span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Reserved for kernel image */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MTDPART_OFS_NXTBLK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">MPR2_MTD_KERNEL_SIZE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Rest is used for Flash FS */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Flash_FS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MTDPART_OFS_NXTBLK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">physmap_flash_data</span> <span class="n">flash_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parts</span>		<span class="o">=</span> <span class="n">mpr2_partitions</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mpr2_partitions</span><span class="p">),</span>
	<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">flash_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="mh">0x2000000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">flash_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;physmap-flash&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">flash_resource</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">flash_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Add all resources to the platform_device</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">mpr2_devices</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">heartbeat_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">smsc911x_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">flash_device</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mpr2_devices_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_add_devices</span><span class="p">(</span><span class="n">mpr2_devices</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mpr2_devices</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">device_initcall</span><span class="p">(</span><span class="n">mpr2_devices_setup</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize IRQ setting</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_mpr2_IRQ</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">plat_irq_setup_pins</span><span class="p">(</span><span class="n">IRQ_MODE_IRQ</span><span class="p">);</span> <span class="cm">/* install handlers for IRQ0-5 */</span>

	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x600</span><span class="p">),</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">);</span>    <span class="cm">/* IRQ0 CAN1 */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x620</span><span class="p">),</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">);</span>    <span class="cm">/* IRQ1 CAN2 */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x640</span><span class="p">),</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">);</span>    <span class="cm">/* IRQ2 CAN3 */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x660</span><span class="p">),</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">);</span>    <span class="cm">/* IRQ3 SMSC9115 */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x680</span><span class="p">),</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">);</span>  <span class="cm">/* IRQ4 touchscreen */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x6a0</span><span class="p">),</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">);</span> <span class="cm">/* IRQ5 touchscreen */</span>

	<span class="n">intc_set_priority</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x600</span><span class="p">),</span> <span class="mi">13</span><span class="p">);</span>		<span class="cm">/* IRQ0 CAN1 */</span>
	<span class="n">intc_set_priority</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x620</span><span class="p">),</span> <span class="mi">13</span><span class="p">);</span>		<span class="cm">/* IRQ0 CAN2 */</span>
	<span class="n">intc_set_priority</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x640</span><span class="p">),</span> <span class="mi">13</span><span class="p">);</span>		<span class="cm">/* IRQ0 CAN3 */</span>
	<span class="n">intc_set_priority</span><span class="p">(</span><span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x660</span><span class="p">),</span> <span class="mi">6</span><span class="p">);</span>		<span class="cm">/* IRQ3 SMSC9115 */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The Machine Vector</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_machine_vector</span> <span class="n">mv_mpr2</span> <span class="n">__initmv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mv_name</span>		<span class="o">=</span> <span class="s">&quot;mpr2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mv_setup</span>		<span class="o">=</span> <span class="n">mpr2_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mv_init_irq</span>		<span class="o">=</span> <span class="n">init_mpr2_IRQ</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
