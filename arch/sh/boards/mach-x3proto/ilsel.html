<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sh › boards › mach-x3proto › ilsel.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ilsel.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/sh/boards/mach-x3proto/ilsel.c</span>
<span class="cm"> *</span>
<span class="cm"> * Helper routines for SH-X3 proto board ILSEL.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 - 2010  Paul Mundt</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>
<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;mach/ilsel.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * ILSEL is split across:</span>
<span class="cm"> *</span>
<span class="cm"> *	ILSEL0 - 0xb8100004 [ Levels  1 -  4 ]</span>
<span class="cm"> *	ILSEL1 - 0xb8100006 [ Levels  5 -  8 ]</span>
<span class="cm"> *	ILSEL2 - 0xb8100008 [ Levels  9 - 12 ]</span>
<span class="cm"> *	ILSEL3 - 0xb810000a [ Levels 13 - 15 ]</span>
<span class="cm"> *</span>
<span class="cm"> * With each level being relative to an ilsel_source_t.</span>
<span class="cm"> */</span>
<span class="cp">#define ILSEL_BASE	0xb8100004</span>
<span class="cp">#define ILSEL_LEVELS	15</span>

<span class="cm">/*</span>
<span class="cm"> * ILSEL level map, in descending order from the highest level down.</span>
<span class="cm"> *</span>
<span class="cm"> * Supported levels are 1 - 15 spread across ILSEL0 - ILSEL4, mapping</span>
<span class="cm"> * directly to IRLs. As the IRQs are numbered in reverse order relative</span>
<span class="cm"> * to the interrupt level, the level map is carefully managed to ensure a</span>
<span class="cm"> * 1:1 mapping between the bit position and the IRQ number.</span>
<span class="cm"> *</span>
<span class="cm"> * This careful constructions allows ilsel_enable*() to be referenced</span>
<span class="cm"> * directly for hooking up an ILSEL set and getting back an IRQ which can</span>
<span class="cm"> * subsequently be used for internal accounting in the (optional) disable</span>
<span class="cm"> * path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ilsel_level_map</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ilsel_offset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ILSEL_LEVELS</span> <span class="o">-</span> <span class="n">bit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">mk_ilsel_addr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ILSEL_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">ilsel_offset</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mk_ilsel_shift</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ilsel_offset</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ilsel_enable</span><span class="p">(</span><span class="n">ilsel_source_t</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;enabling ILSEL set %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">mk_ilsel_addr</span><span class="p">(</span><span class="n">bit</span><span class="p">);</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">mk_ilsel_shift</span><span class="p">(</span><span class="n">bit</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: bit#%d: addr - 0x%08lx (shift %d, set %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">set</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ilsel_enable - Enable an ILSEL set.</span>
<span class="cm"> * @set: ILSEL source (see ilsel_source_t enum in include/asm-sh/ilsel.h).</span>
<span class="cm"> *</span>
<span class="cm"> * Enables a given non-aliased ILSEL source (&lt;= ILSEL_KEY) at the highest</span>
<span class="cm"> * available interrupt level. Callers should take care to order callsites</span>
<span class="cm"> * noting descending interrupt levels. Aliasing FPGA and external board</span>
<span class="cm"> * IRQs need to use ilsel_enable_fixed().</span>
<span class="cm"> *</span>
<span class="cm"> * The return value is an IRQ number that can later be taken down with</span>
<span class="cm"> * ilsel_disable().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ilsel_enable</span><span class="p">(</span><span class="n">ilsel_source_t</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">set</span> <span class="o">&gt;</span> <span class="n">ILSEL_KEY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Aliased sources must use ilsel_enable_fixed()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilsel_level_map</span><span class="p">,</span> <span class="n">ILSEL_LEVELS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ilsel_level_map</span><span class="p">));</span>

	<span class="n">__ilsel_enable</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bit</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ilsel_enable</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ilsel_enable_fixed - Enable an ILSEL set at a fixed interrupt level</span>
<span class="cm"> * @set: ILSEL source (see ilsel_source_t enum in include/asm-sh/ilsel.h).</span>
<span class="cm"> * @level: Interrupt level (1 - 15)</span>
<span class="cm"> *</span>
<span class="cm"> * Enables a given ILSEL source at a fixed interrupt level. Necessary</span>
<span class="cm"> * both for level reservation as well as for aliased sources that only</span>
<span class="cm"> * exist on special ILSEL#s.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns an IRQ number (as ilsel_enable()).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ilsel_enable_fixed</span><span class="p">(</span><span class="n">ilsel_source_t</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">ilsel_offset</span><span class="p">(</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ilsel_level_map</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">__ilsel_enable</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bit</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ilsel_enable_fixed</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ilsel_disable - Disable an ILSEL set</span>
<span class="cm"> * @irq: Bit position for ILSEL set value (retval from enable routines)</span>
<span class="cm"> *</span>
<span class="cm"> * Disable a previously enabled ILSEL set.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ilsel_disable</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;disabling ILSEL set %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">mk_ilsel_addr</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">mk_ilsel_shift</span><span class="p">(</span><span class="n">irq</span><span class="p">));</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ilsel_level_map</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ilsel_disable</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
