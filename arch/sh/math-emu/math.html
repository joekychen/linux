<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › sh › math-emu › math.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>math.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/sh/math-emu/math.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Takashi YOSHII &lt;takasi-y@ops.dti.ne.jp&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/perf_event.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &quot;sfp-util.h&quot;</span>
<span class="cp">#include &lt;math-emu/soft-fp.h&gt;</span>
<span class="cp">#include &lt;math-emu/single.h&gt;</span>
<span class="cp">#include &lt;math-emu/double.h&gt;</span>

<span class="cp">#define	FPUL		(fregs-&gt;fpul)</span>
<span class="cp">#define FPSCR		(fregs-&gt;fpscr)</span>
<span class="cp">#define FPSCR_RM	(FPSCR&amp;3)</span>
<span class="cp">#define FPSCR_DN	((FPSCR&gt;&gt;18)&amp;1)</span>
<span class="cp">#define FPSCR_PR	((FPSCR&gt;&gt;19)&amp;1)</span>
<span class="cp">#define FPSCR_SZ	((FPSCR&gt;&gt;20)&amp;1)</span>
<span class="cp">#define FPSCR_FR	((FPSCR&gt;&gt;21)&amp;1)</span>
<span class="cp">#define FPSCR_MASK	0x003fffffUL</span>

<span class="cp">#define BANK(n)	(n^(FPSCR_FR?16:0))</span>
<span class="cp">#define FR	((unsigned long*)(fregs-&gt;fp_regs))</span>
<span class="cp">#define FR0	(FR[BANK(0)])</span>
<span class="cp">#define FRn	(FR[BANK(n)])</span>
<span class="cp">#define FRm	(FR[BANK(m)])</span>
<span class="cp">#define DR	((unsigned long long*)(fregs-&gt;fp_regs))</span>
<span class="cp">#define DRn	(DR[BANK(n)/2])</span>
<span class="cp">#define DRm	(DR[BANK(m)/2])</span>

<span class="cp">#define XREG(n)	(n^16)</span>
<span class="cp">#define XFn	(FR[BANK(XREG(n))])</span>
<span class="cp">#define XFm	(FR[BANK(XREG(m))])</span>
<span class="cp">#define XDn	(DR[BANK(XREG(n))/2])</span>
<span class="cp">#define XDm	(DR[BANK(XREG(m))/2])</span>

<span class="cp">#define R0	(regs-&gt;regs[0])</span>
<span class="cp">#define Rn	(regs-&gt;regs[n])</span>
<span class="cp">#define Rm	(regs-&gt;regs[m])</span>

<span class="cp">#define WRITE(d,a)	({if(put_user(d, (typeof (d)*)a)) return -EFAULT;})</span>
<span class="cp">#define READ(d,a)	({if(get_user(d, (typeof (d)*)a)) return -EFAULT;})</span>

<span class="cp">#define PACK_S(r,f)	FP_PACK_SP(&amp;r,f)</span>
<span class="cp">#define UNPACK_S(f,r)	FP_UNPACK_SP(f,&amp;r)</span>
<span class="cp">#define PACK_D(r,f) \</span>
<span class="cp">	{u32 t[2]; FP_PACK_DP(t,f); ((u32*)&amp;r)[0]=t[1]; ((u32*)&amp;r)[1]=t[0];}</span>
<span class="cp">#define UNPACK_D(f,r) \</span>
<span class="cp">	{u32 t[2]; t[0]=((u32*)&amp;r)[1]; t[1]=((u32*)&amp;r)[0]; FP_UNPACK_DP(f,t);}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>2 args instructions.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define BOTH_PRmn(op,x) \</span>
<span class="cp">	FP_DECL_EX; if(FPSCR_PR) op(D,x,DRm,DRn); else op(S,x,FRm,FRn);</span>

<span class="cp">#define CMP_X(SZ,R,M,N) do{ \</span>
<span class="cp">	FP_DECL_##SZ(Fm); FP_DECL_##SZ(Fn); \</span>
<span class="cp">	UNPACK_##SZ(Fm, M); UNPACK_##SZ(Fn, N); \</span>
<span class="cp">	FP_CMP_##SZ(R, Fn, Fm, 2); }while(0)</span>
<span class="cp">#define EQ_X(SZ,R,M,N) do{ \</span>
<span class="cp">	FP_DECL_##SZ(Fm); FP_DECL_##SZ(Fn); \</span>
<span class="cp">	UNPACK_##SZ(Fm, M); UNPACK_##SZ(Fn, N); \</span>
<span class="cp">	FP_CMP_EQ_##SZ(R, Fn, Fm); }while(0)</span>
<span class="cp">#define CMP(OP) ({ int r; BOTH_PRmn(OP##_X,r); r; })</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fcmp_gt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CMP</span><span class="p">(</span><span class="n">CMP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fcmp_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CMP</span><span class="p">(</span><span class="n">CMP</span> <span class="cm">/*EQ*/</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ARITH_X(SZ,OP,M,N) do{ \</span>
<span class="cp">	FP_DECL_##SZ(Fm); FP_DECL_##SZ(Fn); FP_DECL_##SZ(Fr); \</span>
<span class="cp">	UNPACK_##SZ(Fm, M); UNPACK_##SZ(Fn, N); \</span>
<span class="cp">	FP_##OP##_##SZ(Fr, Fn, Fm); \</span>
<span class="cp">	PACK_##SZ(N, Fr); }while(0)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fadd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BOTH_PRmn</span><span class="p">(</span><span class="n">ARITH_X</span><span class="p">,</span> <span class="n">ADD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fsub</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BOTH_PRmn</span><span class="p">(</span><span class="n">ARITH_X</span><span class="p">,</span> <span class="n">SUB</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmul</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BOTH_PRmn</span><span class="p">(</span><span class="n">ARITH_X</span><span class="p">,</span> <span class="n">MUL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fdiv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BOTH_PRmn</span><span class="p">(</span><span class="n">ARITH_X</span><span class="p">,</span> <span class="n">DIV</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">Fr</span><span class="p">);</span>
	<span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">Ft</span><span class="p">);</span>
	<span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">F0</span><span class="p">);</span>
	<span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">Fm</span><span class="p">);</span>
	<span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">Fn</span><span class="p">);</span>
	<span class="n">UNPACK_S</span><span class="p">(</span><span class="n">F0</span><span class="p">,</span> <span class="n">FR0</span><span class="p">);</span>
	<span class="n">UNPACK_S</span><span class="p">(</span><span class="n">Fm</span><span class="p">,</span> <span class="n">FRm</span><span class="p">);</span>
	<span class="n">UNPACK_S</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="n">FRn</span><span class="p">);</span>
	<span class="n">FP_MUL_S</span><span class="p">(</span><span class="n">Ft</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">F0</span><span class="p">);</span>
	<span class="n">FP_ADD_S</span><span class="p">(</span><span class="n">Fr</span><span class="p">,</span> <span class="n">Fn</span><span class="p">,</span> <span class="n">Ft</span><span class="p">);</span>
	<span class="n">PACK_S</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Fr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>to process fmov's extension (odd n for DR access XD).</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define FMOV_EXT(x) if(x&amp;1) x+=16-1</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmov_idx_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FMOV_EXT</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span> <span class="o">+</span> <span class="n">R0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span> <span class="o">+</span> <span class="n">R0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span> <span class="o">+</span> <span class="n">R0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmov_mem_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FMOV_EXT</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmov_inc_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FMOV_EXT</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span><span class="p">);</span>
		<span class="n">Rm</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">READ</span><span class="p">(</span><span class="n">FRn</span><span class="p">,</span> <span class="n">Rm</span><span class="p">);</span>
		<span class="n">Rm</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmov_reg_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FMOV_EXT</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span> <span class="o">+</span> <span class="n">R0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">m</span><span class="o">++</span><span class="p">;</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span> <span class="o">+</span> <span class="n">R0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span> <span class="o">+</span> <span class="n">R0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmov_reg_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FMOV_EXT</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">m</span><span class="o">++</span><span class="p">;</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmov_reg_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FMOV_EXT</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="n">Rn</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">m</span><span class="o">++</span><span class="p">;</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">Rn</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="n">FRm</span><span class="p">,</span> <span class="n">Rn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fmov_reg_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FMOV_EXT</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="n">FMOV_EXT</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="n">DRn</span> <span class="o">=</span> <span class="n">DRm</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FRn</span> <span class="o">=</span> <span class="n">FRm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fnop_mn</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>1 arg instructions.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define NOTYETn(i) static int i(struct sh_fpu_soft_struct *fregs, int n) \</span>
<span class="cp">	{ printk( #i &quot; not yet done.\n&quot;); return 0; }</span>

<span class="n">NOTYETn</span><span class="p">(</span><span class="n">ftrv</span><span class="p">)</span>
<span class="n">NOTYETn</span><span class="p">(</span><span class="n">fsqrt</span><span class="p">)</span>
<span class="n">NOTYETn</span><span class="p">(</span><span class="n">fipr</span><span class="p">)</span>
<span class="n">NOTYETn</span><span class="p">(</span><span class="n">fsca</span><span class="p">)</span>
<span class="n">NOTYETn</span><span class="p">(</span><span class="n">fsrra</span><span class="p">)</span>

<span class="cp">#define EMU_FLOAT_X(SZ,N) do { \</span>
<span class="cp">	FP_DECL_##SZ(Fn); \</span>
<span class="cp">	FP_FROM_INT_##SZ(Fn, FPUL, 32, int); \</span>
<span class="cp">	PACK_##SZ(N, Fn); }while(0)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ffloat</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_PR</span><span class="p">)</span>
		<span class="n">EMU_FLOAT_X</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">DRn</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">EMU_FLOAT_X</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">FRn</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define EMU_FTRC_X(SZ,N) do { \</span>
<span class="cp">	FP_DECL_##SZ(Fn); \</span>
<span class="cp">	UNPACK_##SZ(Fn, N); \</span>
<span class="cp">	FP_TO_INT_##SZ(FPUL, Fn, 32, 1); }while(0)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ftrc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FPSCR_PR</span><span class="p">)</span>
		<span class="n">EMU_FTRC_X</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">DRn</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">EMU_FTRC_X</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">FRn</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fcnvsd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">Fn</span><span class="p">);</span>
	<span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">Fr</span><span class="p">);</span>
	<span class="n">UNPACK_S</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="n">FPUL</span><span class="p">);</span>
	<span class="n">FP_CONV</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Fr</span><span class="p">,</span> <span class="n">Fn</span><span class="p">);</span>
	<span class="n">PACK_D</span><span class="p">(</span><span class="n">DRn</span><span class="p">,</span> <span class="n">Fr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fcnvds</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">Fn</span><span class="p">);</span>
	<span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">Fr</span><span class="p">);</span>
	<span class="n">UNPACK_D</span><span class="p">(</span><span class="n">Fn</span><span class="p">,</span> <span class="n">DRn</span><span class="p">);</span>
	<span class="n">FP_CONV</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Fr</span><span class="p">,</span> <span class="n">Fn</span><span class="p">);</span>
	<span class="n">PACK_S</span><span class="p">(</span><span class="n">FPUL</span><span class="p">,</span> <span class="n">Fr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fxchg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPSCR</span> <span class="o">^=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fsts</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FRn</span> <span class="o">=</span> <span class="n">FPUL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">flds</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FPUL</span> <span class="o">=</span> <span class="n">FRn</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FRn</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">_FP_W_TYPE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fabs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FRn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">_FP_W_TYPE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fld0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FRn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fld1</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FRn</span> <span class="o">=</span> <span class="p">(</span><span class="n">_FP_EXPBIAS_S</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">_FP_FRACBITS_S</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fnop_n</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>/ Instruction decoders.</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="n">id_fxfd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">id_fnxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fnxd</span><span class="p">[])(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">fsts</span><span class="p">,</span> <span class="n">flds</span><span class="p">,</span> <span class="n">ffloat</span><span class="p">,</span> <span class="n">ftrc</span><span class="p">,</span> <span class="n">fneg</span><span class="p">,</span> <span class="n">fabs</span><span class="p">,</span> <span class="n">fsqrt</span><span class="p">,</span> <span class="n">fsrra</span><span class="p">,</span>
	<span class="n">fld0</span><span class="p">,</span> <span class="n">fld1</span><span class="p">,</span> <span class="n">fcnvsd</span><span class="p">,</span> <span class="n">fcnvds</span><span class="p">,</span> <span class="n">fnop_n</span><span class="p">,</span> <span class="n">fnop_n</span><span class="p">,</span> <span class="n">fipr</span><span class="p">,</span> <span class="n">id_fxfd</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fnmx</span><span class="p">[])(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">fadd</span><span class="p">,</span> <span class="n">fsub</span><span class="p">,</span> <span class="n">fmul</span><span class="p">,</span> <span class="n">fdiv</span><span class="p">,</span> <span class="n">fcmp_eq</span><span class="p">,</span> <span class="n">fcmp_gt</span><span class="p">,</span> <span class="n">fmov_idx_reg</span><span class="p">,</span> <span class="n">fmov_reg_idx</span><span class="p">,</span>
	<span class="n">fmov_mem_reg</span><span class="p">,</span> <span class="n">fmov_inc_reg</span><span class="p">,</span> <span class="n">fmov_reg_mem</span><span class="p">,</span> <span class="n">fmov_reg_dec</span><span class="p">,</span>
	<span class="n">fmov_reg_reg</span><span class="p">,</span> <span class="n">id_fnxd</span><span class="p">,</span> <span class="n">fmac</span><span class="p">,</span> <span class="n">fnop_mn</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">id_fxfd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FPSCR_SZ</span><span class="p">,</span> <span class="n">FPSCR_PR</span><span class="p">,</span> <span class="n">FPSCR_FR</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">fxchg</span><span class="p">(</span><span class="n">fregs</span><span class="p">,</span> <span class="n">flag</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ftrv</span><span class="p">(</span><span class="n">fregs</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fsca</span><span class="p">(</span><span class="n">fregs</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">id_fnxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">fnxd</span><span class="p">[</span><span class="n">x</span><span class="p">])(</span><span class="n">fregs</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">id_fnmx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">fnmx</span><span class="p">[</span><span class="n">x</span><span class="p">])(</span><span class="n">fregs</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">id_sys</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="p">((</span><span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">FPUL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">FPSCR</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0xf0ff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x005a</span>:
	<span class="k">case</span> <span class="mh">0x006a</span>:
		<span class="n">Rn</span> <span class="o">=</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x405a</span>:
	<span class="k">case</span> <span class="mh">0x406a</span>:
		<span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">Rn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4052</span>:
	<span class="k">case</span> <span class="mh">0x4062</span>:
		<span class="n">Rn</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">WRITE</span><span class="p">(</span><span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">Rn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4056</span>:
	<span class="k">case</span> <span class="mh">0x4066</span>:
		<span class="n">READ</span><span class="p">(</span><span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">Rn</span><span class="p">);</span>
		<span class="n">Rn</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpu_emulate</span><span class="p">(</span><span class="n">u16</span> <span class="n">code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fregs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id_fnmx</span><span class="p">(</span><span class="n">fregs</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">id_sys</span><span class="p">(</span><span class="n">fregs</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	denormal_to_double - Given denormalized float number,</span>
<span class="cm"> *	                     store double float</span>
<span class="cm"> *</span>
<span class="cm"> *	@fpu: Pointer to sh_fpu_soft structure</span>
<span class="cm"> *	@n: Index to FP register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">denormal_to_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">du</span><span class="p">,</span> <span class="n">dl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fpu</span><span class="o">-&gt;</span><span class="n">fpul</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exp</span> <span class="o">=</span> <span class="mi">1023</span> <span class="o">-</span> <span class="mi">126</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x7f800000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">du</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x00800000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">exp</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">x</span> <span class="o">&amp;=</span> <span class="mh">0x007fffff</span><span class="p">;</span>
		<span class="n">du</span> <span class="o">|=</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">dl</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">;</span>

		<span class="n">fpu</span><span class="o">-&gt;</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">du</span><span class="p">;</span>
		<span class="n">fpu</span><span class="o">-&gt;</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dl</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ieee_fpe_handler - Handle denormalized number exception</span>
<span class="cm"> *</span>
<span class="cm"> *	@regs: Pointer to register structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 1 when it&#39;s handled (should not cause exception).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee_fpe_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">finsn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nextpc</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nib</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">insn</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
		<span class="p">(</span><span class="n">insn</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
		<span class="p">(</span><span class="n">insn</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
		<span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4</span> <span class="o">&amp;&amp;</span> <span class="n">nib</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> <span class="n">nib</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb</span><span class="p">))</span> <span class="cm">/* bsr &amp; jsr */</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xa</span> <span class="o">||</span> <span class="n">nib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* bra &amp; bsr */</span>
		<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">((</span><span class="kt">short</span><span class="p">)</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">finsn</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x8</span> <span class="o">&amp;&amp;</span> <span class="n">nib</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xd</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* bt/s */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">finsn</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x8</span> <span class="o">&amp;&amp;</span> <span class="n">nib</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* bf/s */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">finsn</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4</span> <span class="o">&amp;&amp;</span> <span class="n">nib</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">||</span> <span class="n">nib</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x2</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* jmp &amp; jsr */</span>
		<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">nib</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
		<span class="n">finsn</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> <span class="n">nib</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x3</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">nib</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">||</span> <span class="n">nib</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x2</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* braf &amp; bsrf */</span>
		<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">nib</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
		<span class="n">finsn</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="o">==</span> <span class="mh">0x000b</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* rts */</span>
		<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">;</span>
		<span class="n">finsn</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nextpc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">finsn</span> <span class="o">=</span> <span class="n">insn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">finsn</span> <span class="o">&amp;</span> <span class="mh">0xf1ff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf0ad</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* fcnvsd */</span>
		<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">softfpu</span><span class="p">.</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* FPU error */</span>
			<span class="n">denormal_to_double</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">softfpu</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">finsn</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
			<span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">softfpu</span><span class="p">.</span><span class="n">fpscr</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="n">FPSCR_CAUSE_MASK</span> <span class="o">|</span> <span class="n">FPSCR_FLAG_MASK</span><span class="p">);</span>
			<span class="n">task_thread_info</span><span class="p">(</span><span class="n">tsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TS_USEDFPU</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">nextpc</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">do_fpu_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r4</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r5</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r6</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r7</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee_fpe_handler</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">regs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fpu_init - Initialize FPU registers</span>
<span class="cm"> * @fpu: Pointer to software emulated FPU registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fpu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fpu</span><span class="o">-&gt;</span><span class="n">fpscr</span> <span class="o">=</span> <span class="n">FPSCR_INIT</span><span class="p">;</span>
	<span class="n">fpu</span><span class="o">-&gt;</span><span class="n">fpul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fpu</span><span class="o">-&gt;</span><span class="n">fp_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fpu</span><span class="o">-&gt;</span><span class="n">xfp_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_fpu_inst - Handle reserved instructions for FPU emulation</span>
<span class="cm"> * @inst: instruction code.</span>
<span class="cm"> * @regs: registers on stack.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">do_fpu_inst</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">inst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_fpu_soft_struct</span> <span class="o">*</span><span class="n">fpu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">xstate</span><span class="o">-&gt;</span><span class="n">softfpu</span><span class="p">);</span>

	<span class="n">perf_sw_event</span><span class="p">(</span><span class="n">PERF_COUNT_SW_EMULATION_FAULTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">task_thread_info</span><span class="p">(</span><span class="n">tsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TS_USEDFPU</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* initialize once. */</span>
		<span class="n">fpu_init</span><span class="p">(</span><span class="n">fpu</span><span class="p">);</span>
		<span class="n">task_thread_info</span><span class="p">(</span><span class="n">tsk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TS_USEDFPU</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fpu_emulate</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">fpu</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
